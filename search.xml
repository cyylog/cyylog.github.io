<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>è¿ç»´é¢è¯•é¢˜-01</title>
      <link href="9999/08/16/interview/yun-wei-mian-shi-ti-01/"/>
      <url>9999/08/16/interview/yun-wei-mian-shi-ti-01/</url>
      
        <content type="html"><![CDATA[<p>PSï¼šä»¥ä¸‹å†…å®¹ï¼Œç½‘å‹æä¾›    æ¬¢è¿æŠ•ç¨¿     <a href="mailto:cyylog@aliyun.com">cyylog@aliyun.com</a></p><h3 id="å››å‰‘å®¢"><a href="#å››å‰‘å®¢" class="headerlink" title="å››å‰‘å®¢"></a>å››å‰‘å®¢</h3><h4 id="awk"><a href="#awk" class="headerlink" title="awk"></a>awk</h4><ol><li>ç»Ÿè®¡æ—¥å¿—ä¸­æŸä¸ªæ—¶é—´èŒƒå›´çš„ IP è®¿é—®é‡ï¼Œå¹¶è¿›è¡Œæ’åº</li></ol><pre class=" language-shell"><code class="language-shell">$ start_dt='10/May/2018:23:47:43$ end_dt='10/May/2018:23:49:05'$ awk -v st=${start_dt} -v ent=${end_dt} -F'[][ ]' '$5 == st,$5 == ent  {print $1}' app.log  |sort |uniq -c |sort -nr |head -n 10     66 223.13.142.15      6 110.183.13.212      4 1.69.17.127      1 113.25.94.69      1 110.183.58.144</code></pre><pre class=" language-shell"><code class="language-shell">awk '$4>="[30/May/2020:01:08:25" && $4<="[30/May/2020:01:10:25"{a[$2]++} END {for(v in a) print v,a[v]}' access.logawk '$4>="[29/May/2020:20:39:11" && $4<="[30/May/2020:01:08:27" {a[$1]++} END {for(v in a)print  v,a[v]}' access.log[29/May/2020:18:53:53[29/May/2020:18:54:23</code></pre><ol start="2"><li>æŒ‰URLçš„è¯·æ±‚æ•°æ’åºï¼Œå‡ºè®¿é—®è¿™äº›urlçš„ï½‰ï½</li></ol><pre class=" language-shell"><code class="language-shell">æŒ‰URLçš„è¯·æ±‚æ•°æ’åºawk -F\" '{print $2}' access.log | awk '{print $2}' | sort | uniq -c | sort -ræ‰¾å‡ºè®¿é—®è¿™äº›urlçš„ï½‰ï½awk -F\" '($2 ~ "/phpmyadmin/index.php"){print $1}' access.log | awk '{print $1}' | sort | uniq -c | sort -r</code></pre><h4 id="sed"><a href="#sed" class="headerlink" title="sed"></a>sed</h4><ol><li><p>å…³é—­selinux</p><pre class=" language-shell"><code class="language-shell">sed -ri s/SELINUX=enforcing/SELINUX=disabled/g /etc/selinux/configsetenforce 0</code></pre></li><li><p>å°†nginx.confä¸­çš„æ‰€æœ‰server_nameä¸­baidu.comæ›¿æ¢æˆlinkdood.cn</p></li></ol><pre class=" language-shell"><code class="language-shell">sed -ri s/server\_name/baidu\.com/g nginx.conf</code></pre><h4 id="grep"><a href="#grep" class="headerlink" title="grep"></a>grep</h4><ol><li>ç”¨å‘½ä»¤å¦‚ä½•æŸ¥æ‰¾/opt/ç›®å½•ä¸‹æ–‡ä»¶åqypay.confçš„æ–‡ä»¶ä¸­æ˜¯å¦æœ‰redis=127.0.0.1çš„é…ç½®</li></ol><pre class=" language-shell"><code class="language-shell">grep "redis\=127\.0\.0\.1"/opt/qypay.conf </code></pre><h4 id="find"><a href="#find" class="headerlink" title="find"></a>find</h4><ol><li>æŸ¥æ‰¾/dataç›®å½•ä¸‹5å¤©å‰ï¼Œå¤§äº100Mçš„æ–‡ä»¶å¹¶åˆ é™¤    </li></ol><pre class=" language-shell"><code class="language-shell">find /data -type -size +100M -atime +5 -exec rm -rf {} \;  find /data -type -size +100M -atime +5|xargs -i rm -rf </code></pre><h3 id="shell"><a href="#shell" class="headerlink" title="shell"></a>shell</h3><ol><li>å†™è„šæœ¬æ‰¾åˆ°æœ¬æœºçš„IPåœ°å€</li></ol><pre><code>è·å–å½“å‰ä¸»æœºens33çš„ipifconfig ens33 | grep &quot;inet &quot; | sed &#39;s/^.*inet //g&#39; | sed &#39;s/ *netmask.*$//g&#39;ip addr | awk &#39;/^[0-9]+: / {}; /inet.*global/ {print gensub(/(.*)\/(.*)/, &quot;\\1&quot;, &quot;g&quot;, $2)}&#39;ip addr | awk &#39;/^[0-9]+: / {}; /inet.*global/ {print gensub(/(.*)\/(.*)/, &quot;\\1&quot;, &quot;g&quot;, $2)}&#39;å‘½ä»¤è§£é‡Š ifconfig -a  ã€€ã€€ã€€ã€€ å’Œwindowä¸‹æ‰§è¡Œæ­¤å‘½ä»¤ä¸€æ ·é“ç†ï¼Œè¿”å›æœ¬æœºæ‰€æœ‰ipä¿¡æ¯ grep inet               ã€€   æˆªå–åŒ…å«ipçš„è¡Œ grep -v 127.0.0.1      å»æ‰æœ¬åœ°æŒ‡å‘çš„é‚£è¡Œ grep -v inet6             å»æ‰åŒ…å«inet6çš„è¡Œ awk { print $2}         $2 è¡¨ç¤ºé»˜è®¤ä»¥ç©ºæ ¼åˆ†å‰²çš„ç¬¬äºŒç»„ åŒç† $1è¡¨ç¤ºç¬¬ä¸€ç»„â€‹ tr -d &quot;addr:               åˆ é™¤&quot;addr:&quot;è¿™ä¸ªå­—ç¬¦ä¸²</code></pre><ol start="2"><li>å¦‚ä½•æŸ¥çœ‹ç³»ç»Ÿæ¯ä¸ªipçš„è¿æ¥æ•°</li></ol><pre class=" language-shell"><code class="language-shell">netstat -tan| awk '/tcp & gt; /{ split ($5,ip,":"); count[ip[1]]++} END {for(i in count) { print i, count[i]} }'</code></pre><h3 id="è´Ÿè½½å‡è¡¡"><a href="#è´Ÿè½½å‡è¡¡" class="headerlink" title="è´Ÿè½½å‡è¡¡"></a>è´Ÿè½½å‡è¡¡</h3><ol><li>HAproxyï¼Œ  LVSï¼Œ Nginx   æœ‰ä½•åŒºåˆ«ï¼Œå·¥ä½œä¸­ä¼šæ€ä¹ˆé€‰æ‹©</li></ol><pre class=" language-shell"><code class="language-shell">LVSï¼š æ˜¯åŸºäºå››å±‚çš„è½¬å‘HAproxyï¼š æ˜¯åŸºäºå››å±‚å’Œä¸ƒå±‚çš„è½¬å‘ï¼Œæ˜¯ä¸“ä¸šçš„ä»£ç†æœåŠ¡å™¨Nginxï¼š æ˜¯WEBæœåŠ¡å™¨ï¼Œç¼“å­˜æœåŠ¡å™¨ï¼Œåˆæ˜¯åå‘ä»£ç†æœåŠ¡å™¨ï¼Œå¯ä»¥åšä¸ƒå±‚çš„è½¬å‘åŒºåˆ«ï¼š LVSç”±äºæ˜¯åŸºäºå››å±‚çš„è½¬å‘æ‰€ä»¥åªèƒ½åšç«¯å£çš„è½¬å‘è€ŒåŸºäºURLçš„ã€åŸºäºç›®å½•çš„è¿™ç§è½¬å‘LVSå°±åšä¸äº†å·¥ä½œé€‰æ‹©ï¼šHAproxyå’ŒNginxç”±äºå¯ä»¥åšä¸ƒå±‚çš„è½¬å‘ï¼Œæ‰€ä»¥URLå’Œç›®å½•çš„è½¬å‘éƒ½å¯ä»¥åšåœ¨å¾ˆå¤§å¹¶å‘é‡çš„æ—¶å€™æˆ‘ä»¬å°±è¦é€‰æ‹©LVSï¼Œåƒä¸­å°å‹å…¬å¸çš„è¯å¹¶å‘é‡æ²¡é‚£ä¹ˆå¤§é€‰æ‹©HAproxyæˆ–è€…Nginxè¶³å·²ï¼Œç”±äºHAproxyç”±æ˜¯ä¸“ä¸šçš„ä»£ç†æœåŠ¡å™¨é…ç½®ç®€å•ï¼Œæ‰€ä»¥ä¸­å°å‹ä¼ä¸šæ¨èä½¿ç”¨HAproxy</code></pre><h3 id="ç°åº¦å‘å¸ƒ"><a href="#ç°åº¦å‘å¸ƒ" class="headerlink" title="ç°åº¦å‘å¸ƒ"></a>ç°åº¦å‘å¸ƒ</h3><ol><li>ç°åº¦å‘å¸ƒè¿‡ç¨‹ä¸­å‡ºç°é—®é¢˜ï¼Œæ•°æ®åº“ä¸­æœ‰è„æ•°æ®æ€ä¹ˆè§£å†³</li></ol><pre class=" language-txt"><code class="language-txt">ç°åº¦å‘å¸ƒå¤§éƒ¨åˆ†ç”¨æˆ·éƒ½æ˜¯å…¬å¸ä¸­çš„äººï¼Œå°‘éƒ¨åˆ†æ˜¯å¤–é¢çš„ç”¨æˆ·ï¼Œå¦‚æœå‡ºç°é”™è¯¯ï¼Œå«DBAè¿›è¡Œæ•°æ®åº“å›æ»šå°±å¯ä»¥çš„ï¼Œåœ¨ç°åº¦å‘å¸ƒçš„æ•°æ®ä¸­éƒ½æœ‰æ ‡è®°ï¼Œå¤–é¢çš„ç”¨æˆ·åªèƒ½å«DBAè¿›è¡Œä¿®æ”¹</code></pre><h3 id="Iptables"><a href="#Iptables" class="headerlink" title="Iptables"></a>Iptables</h3><ol><li>æœ¬åœ°80ç«¯å£çš„è¯·æ±‚è½¬å‘åˆ°8080ç«¯å£ï¼Œå½“å‰ä¸»æœºIPä¸º192.168.2.1</li></ol><pre class=" language-shell"><code class="language-shell">iptables -t nat -A PREROUTING -d 192.168.2.1 -p tcp -dport 80 -j DNAT -to 192.168.2.1:8080 </code></pre><ol start="2"><li>å…è®¸æœ¬æœºå¯¹å¤–è¿æ¥80ç«¯å£ï¼ˆæœ¬æœºèƒ½è¿å¤–ç•ŒæœåŠ¡å™¨ä¸º80ï¼‰</li></ol><pre class=" language-shell"><code class="language-shell">iptables -A OUTPUT -p tcp â€“dport 80 -j ACCEPT  </code></pre><ol start="3"><li>ç¦æ­¢å¤–ç•Œpingæœ¬æœåŠ¡å™¨</li></ol><pre class=" language-shell"><code class="language-shell">iptables -A INPUT -p icmp -j DROP</code></pre><h3 id="MySQL"><a href="#MySQL" class="headerlink" title="MySQL"></a>MySQL</h3><ol><li>æŸ¥çœ‹æœ€è¿‘ä¸€æ¬¡innodbè¡¨é”è®°å½•</li></ol><pre class=" language-mysql"><code class="language-mysql">show ENGINE INNODB STATUS ;</code></pre><ol start="2"><li>åˆ—å‡ºæ•°æ®åº“æ‰€æœ‰çº¿ç¨‹</li></ol><pre class=" language-mysql"><code class="language-mysql">show full processlist</code></pre><ol start="3"><li>MySQL çš„æ¯å¤©çš„æ•°æ®é‡ï¼Œä¸»ä»ï¼Œmysqlä¸»åº“æ•°æ®é‡å¤§é€ æˆä»åº“åŒæ­¥å»¶è¿Ÿæ€ä¹ˆåŠ</li></ol><pre class=" language-shell"><code class="language-shell">å¸¦å®½ï¼Œé…ç½®ä¸å½“ï¼Œæ€§èƒ½ä¸ä¸€è‡´,å¾…è¡¥å……</code></pre><ol start="4"><li>ç”¨SQLè¯­åæŸ¥è¯¢å¹´é¾„å°äºå¹³å‡å¹´é¾„çš„ä½œè€…å§“åã€å›¾ä¹¦åã€å‡ºç‰ˆç¤¾å¹¶æŒ‰å§“åé™åºæ’åºã€‚ å›¾ä¹¦(å›¾ä¹¦å·ï¼Œå›¾ä¹¦åï¼Œä½œè€…ç¼–å·ï¼Œå‡ºç‰ˆç¤¾ï¼Œå‡ºç‰ˆæ—¥æœŸ)  ä½œè€…(ä½œè€…å§“åï¼Œä½œè€…ç¼–å·ï¼Œå¹´é¾„ï¼Œæ€§åˆ«)</li></ol><pre class=" language-MYSQL"><code class="language-MYSQL">select aname,bname,pub from anthor a join book b on (a.ano = b.ano) where age < (select avg(age) from author)</code></pre><ol start="5"><li><pre><code></code></pre></li></ol><pre><code>### ç½‘ç»œåŸºç¡€1. ä»æŠ€æœ¯è§’åº¦æè¿°ä¸€ä¸‹ç”¨æˆ·æ‰“å¼€https://cyylog.netlify.appæ‰€ç»è¿‡çš„æ‰€æœ‰è¿‡ç¨‹ï¼Œè¶Šè¯¦ç»†è¶Šå¥½ã€‚   ï¼ˆDNS+HTTPåè®®ï¼‰~~~txt1. åŸŸåè§£æ2. å‘èµ·TCPçš„3æ¬¡æ¡æ‰‹3. å»ºç«‹TCPè¿æ¥åå‘èµ·HTTPè¯·æ±‚4. æœåŠ¡å™¨ç«¯å“åº”httpè¯·æ±‚ï¼Œæµè§ˆå™¨å¾—åˆ°htmlä»£ç 5. æµè§ˆå™¨è§£æhtmlä»£ç ï¼Œå¹¶è¯·æ±‚htmlä»£ç ä¸­çš„èµ„æº6. æµè§ˆå™¨å¯¹é¡µé¢è¿›è¡Œæ¸²æŸ“å‘ˆç°ç»™ç”¨æˆ·</code></pre><ol start="2"><li>tcpdump æŠ“æœ¬æœº 192.168.23.1 çš„80ç«¯å£</li></ol><pre class=" language-shell"><code class="language-shell">tcpdump -i ens33 host 192.168.23.1 port 80</code></pre><h3 id="CICD"><a href="#CICD" class="headerlink" title="CICD"></a>CICD</h3><h3 id="Zabbix"><a href="#Zabbix" class="headerlink" title="Zabbix"></a>Zabbix</h3><h3 id="ELK"><a href="#ELK" class="headerlink" title="ELK"></a>ELK</h3><h3 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h3><h3 id="å¸¸ç”¨webæœåŠ¡å™¨"><a href="#å¸¸ç”¨webæœåŠ¡å™¨" class="headerlink" title="å¸¸ç”¨webæœåŠ¡å™¨"></a>å¸¸ç”¨webæœåŠ¡å™¨</h3><blockquote><p>Apacheã€Nginxã€Tomcat</p></blockquote><h3 id="Ansible"><a href="#Ansible" class="headerlink" title="Ansible"></a>Ansible</h3><h3 id="docker"><a href="#docker" class="headerlink" title="docker"></a>docker</h3><h3 id="K8S"><a href="#K8S" class="headerlink" title="K8S"></a>K8S</h3>]]></content>
      
      
      <categories>
          
          <category> Interview </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kubernetes-äºŒè¿›åˆ¶éƒ¨ç½²</title>
      <link href="2020/11/05/rong-qi/kubernetes-er-jin-zhi-bu-shu/"/>
      <url>2020/11/05/rong-qi/kubernetes-er-jin-zhi-bu-shu/</url>
      
        <content type="html"><![CDATA[<h1 id="âš™ï¸-Deploy-the-Kubernetes-cluster"><a href="#âš™ï¸-Deploy-the-Kubernetes-cluster" class="headerlink" title="âš™ï¸ Deploy the Kubernetes cluster"></a>âš™ï¸ Deploy the Kubernetes cluster</h1><hr><h2 id="ğŸª‚-äºŒè¿›åˆ¶éƒ¨ç½²Kubernetesé›†ç¾¤"><a href="#ğŸª‚-äºŒè¿›åˆ¶éƒ¨ç½²Kubernetesé›†ç¾¤" class="headerlink" title="ğŸª‚ äºŒè¿›åˆ¶éƒ¨ç½²Kubernetesé›†ç¾¤"></a>ğŸª‚ äºŒè¿›åˆ¶éƒ¨ç½²Kubernetesé›†ç¾¤</h2><h2 id="1ã€æœåŠ¡å™¨è§„åˆ’"><a href="#1ã€æœåŠ¡å™¨è§„åˆ’" class="headerlink" title="1ã€æœåŠ¡å™¨è§„åˆ’"></a>1ã€æœåŠ¡å™¨è§„åˆ’</h2><table><thead><tr><th align="center">è§’è‰²</th><th align="center">IP</th><th align="center">ç»„ä»¶</th></tr></thead><tbody><tr><td align="center">k8s-master</td><td align="center">192.168.0.181</td><td align="center">kube-apiserverã€kube-controller-managerã€kube-schedullerã€etcd01</td></tr><tr><td align="center">k8s-node01</td><td align="center">192.168.0.172</td><td align="center">kubeletã€kube-proxyã€dockerã€etcd02</td></tr><tr><td align="center">k8s-node01</td><td align="center">192.168.0.147</td><td align="center">kubeletã€kube-proxyã€dockerã€etcd03</td></tr></tbody></table><h2 id="2ã€ç³»ç»Ÿåˆå§‹åŒ–è®¾ç½®"><a href="#2ã€ç³»ç»Ÿåˆå§‹åŒ–è®¾ç½®" class="headerlink" title="2ã€ç³»ç»Ÿåˆå§‹åŒ–è®¾ç½®"></a>2ã€ç³»ç»Ÿåˆå§‹åŒ–è®¾ç½®</h2><ul><li>1ã€è®¾ç½®ä¸»æœºå</li></ul><pre><code># masterhostnamectl set-hostname --static k8s-master &amp;&amp; bash# node01hostnamectl set-hostname --static k8s-node01 &amp;&amp; bash# node02hostnamectl set-hostname --static k8s-node02 &amp;&amp; bash# æ˜¾ç¤ºå½“å‰ä¸»æœºåè®¾ç½®hostnamectl status# è®¾ç½® hostname è§£æecho &quot;127.0.0.1   $(hostname)&quot; &gt;&gt; /etc/hosts# è®¾ç½®é›†ç¾¤ä¸»æœºåè§£æï¼ˆALLï¼‰cat &gt;&gt; /etc/hosts &lt;&lt;EOF192.168.0.181   k8s-master192.168.0.172   k8s-node01192.168.0.147   k8s-node02# cfssl104.16.234.19   pkg.cfssl.org104.16.235.19   pkg.cfssl.orgEOF </code></pre><ul><li>2ã€å…³é—­é˜²ç«å¢™</li></ul><pre><code>setenforce 0sed -i &#39;s/^SELINUX=enforcing$/SELINUX=permissive/&#39; /etc/selinux/configsed -i &#39;s/^SELINUX=permissive$/SELINUX=disabled/&#39; /etc/selinux/config# å…³é—­firewalldæœåŠ¡systemctl stop firewalld.servicesystemctl disable firewalld.service# å…³é—­NetworkManagersystemctl stop NetworkManagersystemctl disable NetworkManager</code></pre><ul><li>3ã€é…ç½®å…å¯†ç™»é™†</li></ul><pre><code># masterç”Ÿæˆå¯†é’¥ssh-keygen -t rsassh-copy-id -i ~/.ssh/id_rsa.pub  root@k8s-node01ssh-copy-id -i ~/.ssh/id_rsa.pub  root@k8s-node02</code></pre><blockquote><p>ssh-keygen -t rsa -P â€˜â€™</p><p>-På°±è¡¨ç¤ºç©ºå¯†ç ï¼Œå°±åªéœ€è¾“å…¥ä¸€æ¬¡å›æ’¤ã€‚ä¸ç”¨-På‚æ•°ï¼Œå°±éœ€è¦è¾“å…¥ä¸‰æ¬¡å›è½¦ã€‚</p></blockquote><ul><li>4ã€å®‰è£…å¸¸ç”¨å·¥å…·</li></ul><pre><code>yum -y install vim wget iotop htop pciutils tcpdump sysstat epel-releaseyum -y install chrony net-tools bash-completion bind-utils iptables-services# ä¿®æ”¹chronyé…ç½®æ–‡ä»¶cat &gt; /etc/chrony.conf &lt;&lt;EOFserver ntp.aliyun.com iburststratumweight 0driftfile /var/lib/chrony/driftrtcsyncmakestep 10 3bindcmdaddress 127.0.0.1bindcmdaddress ::1keyfile /etc/chrony.keyscommandkey 1generatecommandkeylogchange 0.5logdir /var/log/chronyEOF# å¯åŠ¨chronydæœåŠ¡systemctl enable chronydsystemctl start chronyd</code></pre><pre><code>sed -i &#39;s/^#ClientAliveInterval 0/ClientAliveInterval 30/&#39; /etc/ssh/sshd_configsed -i &#39;s/^#ClientAliveCountMax 3/ClientAliveCountMax 86400/&#39; /etc/ssh/sshd_configsystemctl restart sshd &amp;&amp; reboot</code></pre><h2 id="3ã€è‡ªç­¾CAé¢å‘è¯ä¹¦"><a href="#3ã€è‡ªç­¾CAé¢å‘è¯ä¹¦" class="headerlink" title="3ã€è‡ªç­¾CAé¢å‘è¯ä¹¦"></a>3ã€è‡ªç­¾CAé¢å‘è¯ä¹¦</h2><h3 id="3-1ã€å®‰è£…cfsslå·¥å…·"><a href="#3-1ã€å®‰è£…cfsslå·¥å…·" class="headerlink" title="3.1ã€å®‰è£…cfsslå·¥å…·"></a>3.1ã€å®‰è£…cfsslå·¥å…·</h3><pre><code>mkdir -pv /opt/kubernetes/pkicd /opt/kubernetes/pkicurl -L https://pkg.cfssl.org/R1.2/cfssl_linux-amd64 -o /usr/bin/cfsslcurl -L https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64 -o /usr/bin/cfssljsoncurl -L https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64 -o /usr/bin/cfssl-certinfo# æ·»åŠ æ‰§è¡Œæƒé™chmod +x /usr/bin/cfssl*</code></pre><h3 id="3-2ã€ç”ŸæˆCAè¯ä¹¦"><a href="#3-2ã€ç”ŸæˆCAè¯ä¹¦" class="headerlink" title="3.2ã€ç”ŸæˆCAè¯ä¹¦"></a>3.2ã€ç”ŸæˆCAè¯ä¹¦</h3><h4 id="3-2-1-åˆ›å»ºCAè¯ä¹¦è¯·æ±‚æ–‡ä»¶ï¼ˆcsrï¼‰"><a href="#3-2-1-åˆ›å»ºCAè¯ä¹¦è¯·æ±‚æ–‡ä»¶ï¼ˆcsrï¼‰" class="headerlink" title="3.2.1 åˆ›å»ºCAè¯ä¹¦è¯·æ±‚æ–‡ä»¶ï¼ˆcsrï¼‰"></a>3.2.1 åˆ›å»ºCAè¯ä¹¦è¯·æ±‚æ–‡ä»¶ï¼ˆcsrï¼‰</h4><pre><code>cat &gt; /opt/kubernetes/pki/ca-csr.json &lt;&lt;EOF{    &quot;CN&quot;: &quot;kubernetes-ca&quot;,    &quot;hosts&quot;: [    ],    &quot;key&quot;: {        &quot;algo&quot;: &quot;rsa&quot;,        &quot;size&quot;: 2048    },    &quot;names&quot;: [        {            &quot;C&quot;: &quot;CN&quot;,            &quot;ST&quot;: &quot;Beijing&quot;,            &quot;L&quot;: &quot;Beijing&quot;,            &quot;O&quot;: &quot;kubernetes&quot;,            &quot;OU&quot;: &quot;System&quot;        }    ],    &quot;ca&quot;: {        &quot;expiry&quot;: &quot;87600h&quot;    }}EOF# ç”ŸæˆCAè¯ä¹¦å’Œç§é’¥cd /opt/kubernetes/pki/cfssl gencert -initca ca-csr.json | cfssljson -bare ca</code></pre><h4 id="3-2-2-åˆ›å»ºæ ¹è¯ä¹¦çš„configé…ç½®æ–‡ä»¶"><a href="#3-2-2-åˆ›å»ºæ ¹è¯ä¹¦çš„configé…ç½®æ–‡ä»¶" class="headerlink" title="3.2.2 åˆ›å»ºæ ¹è¯ä¹¦çš„configé…ç½®æ–‡ä»¶"></a>3.2.2 åˆ›å»ºæ ¹è¯ä¹¦çš„configé…ç½®æ–‡ä»¶</h4><pre><code>cat &gt; /opt/kubernetes/pki/ca-config.json &lt;&lt;EOF{    &quot;signing&quot;: {        &quot;default&quot;: {            &quot;expiry&quot;: &quot;87600h&quot;        },        &quot;profiles&quot;: {            &quot;server&quot;: {                &quot;expiry&quot;: &quot;87600h&quot;,                &quot;usages&quot;: [                    &quot;signing&quot;,                    &quot;key encipherment&quot;,                    &quot;server auth&quot;                ]            },            &quot;client&quot;: {                &quot;expiry&quot;: &quot;87600h&quot;,                &quot;usages&quot;: [                    &quot;signing&quot;,                    &quot;key encipherment&quot;,                    &quot;client auth&quot;                ]            },            &quot;peer&quot;: {                &quot;expiry&quot;: &quot;87600h&quot;,                &quot;usages&quot;: [                    &quot;signing&quot;,                    &quot;key encipherment&quot;,                    &quot;server auth&quot;,                    &quot;client auth&quot;                ]            }        }    }}EOF</code></pre><h2 id="4ã€éƒ¨ç½²etcdé›†ç¾¤"><a href="#4ã€éƒ¨ç½²etcdé›†ç¾¤" class="headerlink" title="4ã€éƒ¨ç½²etcdé›†ç¾¤"></a>4ã€éƒ¨ç½²etcdé›†ç¾¤</h2><h3 id="4-1-åˆ›å»ºetcdè¯ä¹¦è¯·æ±‚æ–‡ä»¶"><a href="#4-1-åˆ›å»ºetcdè¯ä¹¦è¯·æ±‚æ–‡ä»¶" class="headerlink" title="4.1 åˆ›å»ºetcdè¯ä¹¦è¯·æ±‚æ–‡ä»¶"></a>4.1 åˆ›å»ºetcdè¯ä¹¦è¯·æ±‚æ–‡ä»¶</h3><blockquote><p>ğŸ˜¡ æ³¨æ„ï¼šä¿®æ”¹<code>hosts</code>å‚æ•°åˆ—è¡¨ä¸­etcdçš„ipåœ°å€</p></blockquote><pre><code>cat &gt; /opt/kubernetes/pki/etcd-peer-csr.json &lt;&lt;EOF{    &quot;CN&quot;: &quot;k8s-etcd&quot;,    &quot;hosts&quot;: [        &quot;192.168.0.181&quot;,        &quot;192.168.0.172&quot;,        &quot;10.10.10.1&quot;,        &quot;192.168.0.147&quot;    ],    &quot;key&quot;: {        &quot;algo&quot;: &quot;rsa&quot;,        &quot;size&quot;: 2048    },    &quot;names&quot;: [        {          &quot;C&quot;: &quot;CN&quot;,          &quot;ST&quot;: &quot;Beijing&quot;,          &quot;L&quot;: &quot;Beijing&quot;,          &quot;O&quot;: &quot;kubernetes&quot;,          &quot;OU&quot;: &quot;System&quot;        }    ]}EOF# ç­¾å‘etcdè¯ä¹¦cd /opt/kubernetes/pki/cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=peer etcd-peer-csr.json | cfssljson -bare etcd</code></pre><h3 id="4-2-ä¸‹è½½etcdå®‰è£…åŒ…"><a href="#4-2-ä¸‹è½½etcdå®‰è£…åŒ…" class="headerlink" title="4.2 ä¸‹è½½etcdå®‰è£…åŒ…"></a>4.2 ä¸‹è½½etcdå®‰è£…åŒ…</h3><blockquote><p>etcdé‡‡ç”¨é›†ç¾¤æ¨¡å¼(3å°),åˆ†åˆ«åœ¨<code>master(etcd-01)</code> <code>node01(etcd-02)</code> <code>node02(etcd-03)</code>å®‰è£…éƒ¨ç½²</p></blockquote><pre><code>mkdir -pv /opt/src/curl -L https://github.com/etcd-io/etcd/releases/download/v3.3.25/etcd-v3.3.25-linux-amd64.tar.gz -o /opt/src/etcd-v3.3.25-linux-amd64.tar.gztar zxf /opt/src/etcd-v3.3.25-linux-amd64.tar.gz -C /opt/src/mv /opt/src/etcd-v3.3.25-linux-amd64 /opt/src/etcd-v3.3.25# ä¸ºetcdåšè½¯é“¾æ¥,æ–¹ä¾¿æ›´æ–°å‡çº§ln -s /opt/src/etcd-v3.3.25 /opt/src/etcd# åˆ›å»ºå­˜æ”¾etcdè¯ä¹¦ç›®å½•mkdir -pv /etc/kubernetes/pki</code></pre><pre><code># åä¸ºæºetcdcurl -L https://mirrors.huaweicloud.com/etcd/v3.3.25/etcd-v3.3.25-linux-amd64.tar.gz -o /opt/src/etcd-v3.3.25-linux-amd64.tar.gzcurl -L https://mirrors.huaweicloud.com/etcd/v3.2.31/etcd-v3.2.31-linux-amd64.tar.gz -o /opt/src/etcd-v3.2.31-linux-amd64.tar.gz</code></pre><h3 id="4-3-é…ç½®etcd"><a href="#4-3-é…ç½®etcd" class="headerlink" title="4.3 é…ç½®etcd"></a>4.3 é…ç½®etcd</h3><h4 id="4-3-1-æ‹·è´è¯ä¹¦åˆ°nodeèŠ‚ç‚¹"><a href="#4-3-1-æ‹·è´è¯ä¹¦åˆ°nodeèŠ‚ç‚¹" class="headerlink" title="4.3.1 æ‹·è´è¯ä¹¦åˆ°nodeèŠ‚ç‚¹"></a>4.3.1 æ‹·è´è¯ä¹¦åˆ°nodeèŠ‚ç‚¹</h4><pre><code># 3ã€æ‹·è´è¯ä¹¦# masteryes|cp /opt/kubernetes/pki/{ca,etcd,etcd-key}.pem /etc/kubernetes/pki# node01scp /opt/kubernetes/pki/{ca,etcd,etcd-key}.pem node1:/etc/kubernetes/pki# node02scp /opt/kubernetes/pki/{ca,etcd,etcd-key}.pem node2:/etc/kubernetes/pki</code></pre><h4 id="4-3-2-æ·»åŠ etcdé…ç½®æ–‡ä»¶"><a href="#4-3-2-æ·»åŠ etcdé…ç½®æ–‡ä»¶" class="headerlink" title="4.3.2 æ·»åŠ etcdé…ç½®æ–‡ä»¶"></a>4.3.2 æ·»åŠ etcdé…ç½®æ–‡ä»¶</h4><blockquote><p>ğŸ˜¡ æ³¨æ„ï¼šä¿®æ”¹<code>ETCD_NAME</code>å‚æ•°å’Œ<code>å¸¦ip</code>çš„å‚æ•°</p></blockquote><pre><code>mkdir -pv /etc/kubernetes/etcd/mkdir -pv /data/kubernetes/etcd/data/cat &gt; /etc/kubernetes/etcd/etcd.conf &lt;&lt;EOF#[Member]ETCD_NAME=&quot;etcd-01&quot;ETCD_DATA_DIR=&quot;/data/kubernetes/etcd/data/&quot;ETCD_LISTEN_PEER_URLS=&quot;https://192.168.0.181:2380&quot;ETCD_LISTEN_CLIENT_URLS=&quot;https://192.168.0.181:2379&quot;#[Clustering]ETCD_INITIAL_ADVERTISE_PEER_URLS=&quot;https://192.168.0.181:2380&quot;ETCD_ADVERTISE_CLIENT_URLS=&quot;https://192.168.0.181:2379&quot;ETCD_INITIAL_CLUSTER=&quot;etcd-01=https://192.168.0.181:2380,etcd-02=https://192.168.0.172:2380,etcd-03=https://192.168.0.147:2380&quot;ETCD_INITIAL_CLUSTER_TOKEN=&quot;etcd-cluster&quot;ETCD_INITIAL_CLUSTER_STATE=&quot;new&quot;#[Certs]CA_FILE=&quot;/etc/kubernetes/pki/ca.pem&quot;ETCD_CERT_FILE=&quot;/etc/kubernetes/pki/etcd.pem&quot;ETCD_KEY_FILE=&quot;/etc/kubernetes/pki/etcd-key.pem&quot;EOF</code></pre><blockquote><p>ğŸ˜¡ æ³¨æ„ï¼šç³»ç»Ÿå¯åŠ¨æœåŠ¡æ–‡ä»¶ä¸­çš„ipåœ°å€éœ€è¦æ‰‹åŠ¨å»æ›´æ”¹,å› ä¸ºæ¯å°æœºå™¨çš„ç›‘å¬ipåœ°å€ä¸åŒ,éœ€è¦æ›´æ”¹çš„å‚æ•°å¦‚ä¸‹ï¼š</p><ul><li>â€“listen-peer-urls</li><li>â€“listen-client-urls</li><li>â€“advertise-client-urls</li><li>â€“initial-advertise-peer-urls</li></ul><p>ğŸ¤” [å¯é€‰é¡¹] å¦‚æœæƒ³ä½¿ç”¨supervisoræ–¹å¼å¯åŠ¨etcdå’Œkubernetesç»„ä»¶æœåŠ¡,è¯·ç‚¹å‡»è·³è½¬â€œä½¿ç”¨spuervisorå¯åŠ¨etcdâ€å¹¶å¿½ç•¥â€œ4.3.3 åˆ›å»ºetcdç³»ç»ŸæœåŠ¡â€</p><ul><li>1ã€<a href="./supervisor.md">ä½¿ç”¨spuervisorå¯åŠ¨etcd</a></li></ul></blockquote><h4 id="4-3-3-åˆ›å»ºetcdç³»ç»ŸæœåŠ¡"><a href="#4-3-3-åˆ›å»ºetcdç³»ç»ŸæœåŠ¡" class="headerlink" title="4.3.3 åˆ›å»ºetcdç³»ç»ŸæœåŠ¡"></a>4.3.3 åˆ›å»ºetcdç³»ç»ŸæœåŠ¡</h4><pre><code># EnvironmentFileå‚æ•°å¼•ç”¨etcdé…ç½®æ–‡ä»¶cat &gt; /lib/systemd/system/etcd.service &lt;&lt;\EOF[Unit]Description=Etcd ServerDocumentation=https://github.com/coreosAfter=network.targetWants=network-online.target[Service]Type=notifyEnvironmentFile=/etc/kubernetes/etcd/etcd.confExecStart=/opt/src/etcd/etcd --name=${ETCD_NAME} \  --data-dir=${ETCD_DATA_DIR} \  --quota-backend-bytes=8000000000 \  --listen-peer-urls=${ETCD_LISTEN_PEER_URLS} \  --listen-client-urls=${ETCD_LISTEN_CLIENT_URLS},http://127.0.0.1:2379 \  --advertise-client-urls=${ETCD_LISTEN_CLIENT_URLS},http://127.0.0.1:2379 \  --initial-cluster=${ETCD_INITIAL_CLUSTER} \  --initial-advertise-peer-urls=${ETCD_INITIAL_ADVERTISE_PEER_URLS} \  --ca-file=/etc/kubernetes/pki/ca.pem \  --cert-file=/etc/kubernetes/pki/etcd.pem \  --key-file=/etc/kubernetes/pki/etcd-key.pem \  --client-cert-auth   --trusted-ca-file=/etc/kubernetes/pki/ca.pem \  --peer-ca-file=/etc/kubernetes/pki/ca.pem \  --peer-cert-file=/etc/kubernetes/pki/etcd.pem \  --peer-key-file=${ETCD_KEY_FILE} \  --peer-client-cert-auth \  --peer-trusted-ca-file=${CA_FILE} \  --log-output stdoutTimeoutSec=0RestartSec=2Restart=on-failureLimitNOFILE=65536[Install]WantedBy=multi-user.targetEOF# å¯åŠ¨etcdæœåŠ¡systemctl daemon-reloadsystemctl restart etcdsystemctl enable etcdsystemctl status etcd# æŸ¥çœ‹æ—¥å¿—è¾“å‡ºï¼ˆæ²¡æœ‰æŠ¥é”™å°±è¯´æ˜å¯åŠ¨æˆåŠŸï¼‰journalctl -f -u etcdæ™®é€šç”¨æˆ·å¯åŠ¨å¤±è´¥ï¼šï¼ˆéœ€è¦ç»™æƒé™ï¼‰[cyy@master src]$ sudo chmod a+x  /etc/kubernetes/etcd/etcd.conf</code></pre><h4 id="4-3-4-æŸ¥çœ‹etcdé›†ç¾¤çŠ¶æ€"><a href="#4-3-4-æŸ¥çœ‹etcdé›†ç¾¤çŠ¶æ€" class="headerlink" title="4.3.4 æŸ¥çœ‹etcdé›†ç¾¤çŠ¶æ€"></a>4.3.4 æŸ¥çœ‹etcdé›†ç¾¤çŠ¶æ€</h4><pre><code># åˆ›å»ºè½¯é“¾æ¥etcdå‘½ä»¤ln -s /opt/src/etcd/etcdctl /usr/local/sbin/# æŸ¥çœ‹etcdé›†ç¾¤å¥åº·æ£€æŸ¥etcdctl cluster-healthmember 407d22d9856f0b40 is healthy: got healthy result from http://127.0.0.1:2379member 6d918c48ad5995f0 is healthy: got healthy result from http://127.0.0.1:2379member c078f2e092d18dab is healthy: got healthy result from http://127.0.0.1:2379cluster is healthy# æŸ¥çœ‹etcdé›†ç¾¤åœ¨çº¿çŠ¶æ€etcdctl member list407d22d9856f0b40: name=etcd-01 peerURLs=https://192.168.0.181:2380 clientURLs=http://127.0.0.1:2379,https://192.168.0.181:2379 isLeader=true6d918c48ad5995f0: name=etcd-02 peerURLs=https://192.168.0.172:2380 clientURLs=http://127.0.0.1:2379,https://192.168.0.172:2379 isLeader=falsec078f2e092d18dab: name=etcd-03 peerURLs=https://192.168.0.147:2380 clientURLs=http://127.0.0.1:2379,https://192.168.0.147:2379 isLeader=false</code></pre><h2 id="5ã€å®‰è£…MasterèŠ‚ç‚¹ç»„ä»¶"><a href="#5ã€å®‰è£…MasterèŠ‚ç‚¹ç»„ä»¶" class="headerlink" title="5ã€å®‰è£…MasterèŠ‚ç‚¹ç»„ä»¶"></a>5ã€å®‰è£…MasterèŠ‚ç‚¹ç»„ä»¶</h2><blockquote><p>MaterèŠ‚ç‚¹åŒ…æ‹¬ï¼škube-apiserverã€kube-controller-managerã€kube-schedulerå’Œetcd01</p></blockquote><h3 id="5-1-éƒ¨ç½²kube-apiserver"><a href="#5-1-éƒ¨ç½²kube-apiserver" class="headerlink" title="5.1 éƒ¨ç½²kube-apiserver"></a>5.1 éƒ¨ç½²kube-apiserver</h3><h4 id="5-1-1-ä¸‹è½½kuberneteså®‰è£…åŒ…"><a href="#5-1-1-ä¸‹è½½kuberneteså®‰è£…åŒ…" class="headerlink" title="5.1.1 ä¸‹è½½kuberneteså®‰è£…åŒ…"></a>5.1.1 ä¸‹è½½kuberneteså®‰è£…åŒ…</h4><pre><code># ä¸‹è½½kubernetesäºŒè¿›åˆ¶åŒ…curl -L https://dl.k8s.io/v1.18.8/kubernetes-server-linux-amd64.tar.gz -o /opt/src/kubernetes-server-linux-amd64.tar.gztar zxf /opt/src/kubernetes-server-linux-amd64.tar.gz -C /opt/src/mv /opt/src/kubernetes /opt/src/kubernetes-v1.18.8ln -s /opt/src/kubernetes-v1.18.8 /opt/src/kubernetes# åˆ é™¤æ— ç”¨çš„é•œåƒæ–‡ä»¶rm -rf /opt/src/kubernetes/server/bin/*.tarrm -rf /opt/src/kubernetes/server/bin/*_tag</code></pre><h4 id="5-1-2-ç­¾å‘clientï¼ˆapiserverï¼‰è¯ä¹¦"><a href="#5-1-2-ç­¾å‘clientï¼ˆapiserverï¼‰è¯ä¹¦" class="headerlink" title="5.1.2 ç­¾å‘clientï¼ˆapiserverï¼‰è¯ä¹¦"></a>5.1.2 ç­¾å‘clientï¼ˆapiserverï¼‰è¯ä¹¦</h4><blockquote><p>æ³¨æ„ï¼šapiserveråœ¨ä¸etcdè¿›è¡Œé€šä¿¡æ—¶ï¼Œæ­¤æ—¶apiserverä¸ºå®¢æˆ·ç«¯etcdä¸ºæœåŠ¡ç«¯ï¼Œå› æ­¤éœ€è¦clientè¯ä¹¦åŠ å¯†é€šä¿¡ã€‚</p><p>ğŸ˜¡ æ³¨æ„ï¼šä¿®æ”¹<code>hosts</code>å‚æ•°å†…ipåœ°å€</p></blockquote><pre><code>cat &gt; /opt/kubernetes/pki/client-csr.json &lt;&lt;EOF{    &quot;CN&quot;: &quot;k8s-node&quot;,    &quot;hosts&quot;: [        &quot;192.168.0.181&quot;,        &quot;192.168.0.172&quot;,        &quot;10.10.10.1&quot;,        &quot;192.168.0.147&quot;    ],    &quot;key&quot;: {        &quot;algo&quot;: &quot;rsa&quot;,        &quot;size&quot;: 2048    },    &quot;names&quot;: [        {          &quot;C&quot;: &quot;CN&quot;,          &quot;ST&quot;: &quot;Beijing&quot;,          &quot;L&quot;: &quot;Beijing&quot;,          &quot;O&quot;: &quot;kubernetes&quot;,          &quot;OU&quot;: &quot;System&quot;        }    ]}EOF# ç­¾å‘clientï¼ˆapiserverï¼‰è¯ä¹¦cd /opt/kubernetes/pki/cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=client client-csr.json | cfssljson -bare client</code></pre><h4 id="5-1-3-ç­¾å‘apiserverï¼ˆserverï¼‰è¯ä¹¦"><a href="#5-1-3-ç­¾å‘apiserverï¼ˆserverï¼‰è¯ä¹¦" class="headerlink" title="5.1.3 ç­¾å‘apiserverï¼ˆserverï¼‰è¯ä¹¦"></a>5.1.3 ç­¾å‘apiserverï¼ˆserverï¼‰è¯ä¹¦</h4><blockquote><p>å½“å…¶ä»–å®¢æˆ·ç«¯ä¸apiserverè¿›è¡Œé€šä¿¡æ—¶,ä¹Ÿéœ€è¦TLSè®¤è¯ï¼Œæ­¤æ—¶apiserverä¸ºæœåŠ¡ç«¯</p><p>ğŸ˜¡ æ³¨æ„ï¼šä¿®æ”¹<code>hosts</code>å‚æ•°å†…ipåœ°å€</p></blockquote><pre><code>cat &gt; /opt/kubernetes/pki/apiserver-csr.json &lt;&lt;EOF{    &quot;CN&quot;: &quot;apiserver&quot;,    &quot;hosts&quot;: [        &quot;127.0.0.1&quot;,        &quot;10.10.10.1&quot;,        &quot;kubernetes.default&quot;,        &quot;kubernetes.default.svc&quot;,        &quot;kubernetes.default.svc.cluster&quot;,        &quot;kubernetes.default.svc.cluster.local&quot;,        &quot;192.168.0.181&quot;,        &quot;192.168.0.172&quot;,        &quot;192.168.0.147&quot;    ],    &quot;key&quot;: {        &quot;algo&quot;: &quot;rsa&quot;,        &quot;size&quot;: 2048    },    &quot;names&quot;: [        {            &quot;C&quot;: &quot;CN&quot;,            &quot;ST&quot;: &quot;Beijing&quot;,            &quot;L&quot;: &quot;Beijing&quot;,            &quot;O&quot;: &quot;kubernetes&quot;,            &quot;OU&quot;: &quot;System&quot;        }    ]}EOF# ç­¾å‘apiserverï¼ˆserverï¼‰è¯ä¹¦cd /opt/kubernetes/pki/cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=server apiserver-csr.json | cfssljson -bare apiserver</code></pre><h4 id="5-1-4-é…ç½®apiserveræ—¥å¿—å®¡è®¡"><a href="#5-1-4-é…ç½®apiserveræ—¥å¿—å®¡è®¡" class="headerlink" title="5.1.4 é…ç½®apiserveræ—¥å¿—å®¡è®¡"></a>5.1.4 é…ç½®apiserveræ—¥å¿—å®¡è®¡</h4><pre><code># åˆ›å»ºå­˜æ”¾è¯ä¹¦ç›®å½•mkdir -p /opt/src/kubernetes/server/bin/{pki,conf}# é…ç½®apiserveræ—¥å¿—å®¡è®¡cat &gt; /opt/src/kubernetes/server/bin/conf/audit.yaml &lt;&lt;EOFapiVersion: audit.k8s.io/v1 # This is required.kind: Policy# Don&#39;t generate audit events for all requests in RequestReceived stage.omitStages:  - &quot;RequestReceived&quot;rules:  # Log pod changes at RequestResponse level  - level: RequestResponse    resources:    - group: &quot;&quot;      # Resource &quot;pods&quot; doesn&#39;t match requests to any subresource of pods,      # which is consistent with the RBAC policy.      resources: [&quot;pods&quot;]  # Log &quot;pods/log&quot;, &quot;pods/status&quot; at Metadata level  - level: Metadata    resources:    - group: &quot;&quot;      resources: [&quot;pods/log&quot;, &quot;pods/status&quot;]  # Don&#39;t log requests to a configmap called &quot;controller-leader&quot;  - level: None    resources:    - group: &quot;&quot;      resources: [&quot;configmaps&quot;]      resourceNames: [&quot;controller-leader&quot;]  # Don&#39;t log watch requests by the &quot;system:kube-proxy&quot; on endpoints or services  - level: None    users: [&quot;system:kube-proxy&quot;]    verbs: [&quot;watch&quot;]    resources:    - group: &quot;&quot; # core API group      resources: [&quot;endpoints&quot;, &quot;services&quot;]  # Don&#39;t log authenticated requests to certain non-resource URL paths.  - level: None    userGroups: [&quot;system:authenticated&quot;]    nonResourceURLs:    - &quot;/api*&quot; # Wildcard matching.    - &quot;/version&quot;  # Log the request body of configmap changes in kube-system.  - level: Request    resources:    - group: &quot;&quot; # core API group      resources: [&quot;configmaps&quot;]    # This rule only applies to resources in the &quot;kube-system&quot; namespace.    # The empty string &quot;&quot; can be used to select non-namespaced resources.    namespaces: [&quot;kube-system&quot;]  # Log configmap and secret changes in all other namespaces at the Metadata level.  - level: Metadata    resources:    - group: &quot;&quot; # core API group      resources: [&quot;secrets&quot;, &quot;configmaps&quot;]  # Log all other resources in core and extensions at the Request level.  - level: Request    resources:    - group: &quot;&quot; # core API group    - group: &quot;extensions&quot; # Version of group should NOT be included.  # A catch-all rule to log all other requests at the Metadata level.  - level: Metadata    # Long-running requests like watches that fall under this rule will not    # generate an audit event in RequestReceived.    omitStages:      - &quot;RequestReceived&quot;EOF</code></pre><h4 id="5-1-5-æ‹·è´apiserverç›¸å…³è¯ä¹¦"><a href="#5-1-5-æ‹·è´apiserverç›¸å…³è¯ä¹¦" class="headerlink" title="5.1.5 æ‹·è´apiserverç›¸å…³è¯ä¹¦"></a>5.1.5 æ‹·è´apiserverç›¸å…³è¯ä¹¦</h4><pre><code># æ‹·è´è¯ä¹¦mkdir -pv /opt/src/kubernetes/server/bin/{pki,conf}cp /opt/kubernetes/pki/{ca,ca-key,client,client-key}.pem /opt/src/kubernetes/server/bin/pki/cp /opt/kubernetes/pki/{apiserver,apiserver-key}.pem /opt/src/kubernetes/server/bin/pki/</code></pre><h4 id="5-1-6-åˆ›å»ºTLSBootstrapping-Token"><a href="#5-1-6-åˆ›å»ºTLSBootstrapping-Token" class="headerlink" title="5.1.6 åˆ›å»ºTLSBootstrapping Token"></a>5.1.6 åˆ›å»ºTLSBootstrapping Token</h4><blockquote><p>ğŸ˜¡ æ³¨æ„ï¼šä¿®æ”¹<code>token.csvæ–‡ä»¶</code>å†…éšæœºç”Ÿæˆçš„token</p></blockquote><pre><code>mkdir -pv /etc/kubernetes/kube-apiserver/head -c 16 /dev/urandom | od -An -t x | tr -d &#39; &#39;cat &gt; /etc/kubernetes/kube-apiserver/token.csv &lt;&lt;EOFb9d82b016a62d8d3607ec578509ebc30,kubelet-bootstrap,10001,&quot;system:node-bootstrapper&quot;EOF</code></pre><h4 id="5-1-7-æ·»åŠ apiserveré…ç½®æ–‡ä»¶"><a href="#5-1-7-æ·»åŠ apiserveré…ç½®æ–‡ä»¶" class="headerlink" title="5.1.7 æ·»åŠ apiserveré…ç½®æ–‡ä»¶"></a>5.1.7 æ·»åŠ apiserveré…ç½®æ–‡ä»¶</h4><pre><code>mkdir -pv /etc/kubernetes/kube-apiserver/cat &gt; /etc/kubernetes/kube-apiserver/kube-apiserver.conf &lt;&lt;EOFKUBE_APISERVER_OPTS=&quot;--apiserver-count 1 \  --v=2 \  --enable-admission-plugins NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,MutatingAdmissionWebhook,ValidatingAdmissionWebhook,ResourceQuota \  --bind-address 192.168.0.181 \  --authorization-mode RBAC,Node \  --enable-bootstrap-token-auth true \  --token-auth-file /etc/kubernetes/kube-apiserver/token.csv \  --tls-cert-file /opt/src/kubernetes/server/bin/pki/apiserver.pem \  --tls-private-key-file /opt/src/kubernetes/server/bin/pki/apiserver-key.pem \  --requestheader-client-ca-file /opt/src/kubernetes/server/bin/pki/ca.pem \  --client-ca-file /opt/src/kubernetes/server/bin/pki/ca.pem \  --etcd-cafile /opt/src/kubernetes/server/bin/pki/ca.pem \  --etcd-certfile /opt/src/kubernetes/server/bin/pki/client.pem \  --etcd-keyfile /opt/src/kubernetes/server/bin/pki/client-key.pem \  --etcd-servers https://192.168.0.181:2379,https://192.168.0.172:2379,https://192.168.0.147:2379 \  --service-cluster-ip-range 10.10.10.0/24 \  --service-node-port-range 3000-32999 \  --service-account-key-file /opt/src/kubernetes/server/bin/pki/ca-key.pem \  --target-ram-mb=1024 \  --audit-log-maxage=30 \  --audit-log-maxbackup=3 \  --audit-log-maxsize=100 \  --audit-log-path /data/kubernetes/logs/kube-apiserver/kube-apiserver.log \  --audit-policy-file /opt/src/kubernetes/server/bin/conf/audit.yaml \  --log-dir  /data/kubernetes/logs/kube-apiserver/ \  --kubelet-client-certificate /opt/src/kubernetes/server/bin/pki/client.pem \  --kubelet-client-key /opt/src/kubernetes/server/bin/pki/client-key.pem&quot;EOF</code></pre><blockquote><p>ğŸ˜¡ æ³¨æ„ï¼šä¿®æ”¹<code>--service-cluster-ip-range</code>å‚æ•°ipèŒƒå›´ï¼Œæ­¤ä¸ºé›†ç¾¤ä¸­serviceçš„IpèŒƒå›´</p><p>ğŸ˜¡ æ³¨æ„ï¼šä¿®æ”¹<code>--bind-address</code>ç»‘å®šapiserveråœ°å€</p><p>ğŸ˜¡ æ³¨æ„ï¼šä¿®æ”¹<code>--etcd-servers</code>å‚æ•°etcdé›†ç¾¤åœ°å€</p><p>ğŸ¤” [å¯é€‰é¡¹] å¦‚ä½¿ç”¨supervisorå¯åŠ¨apiserveræœåŠ¡,è¯·ç‚¹å‡»è·³è½¬â€œä½¿ç”¨supervisorå¯åŠ¨apiserverâ€å¹¶å¿½ç•¥ â€œ5.1.8 åˆ›å»ºapiserverç³»ç»ŸæœåŠ¡â€</p><ul><li>2ã€<a href="./supervisor.md">ä½¿ç”¨supervisorå¯åŠ¨apiserver</a></li></ul></blockquote><h4 id="5-1-8-åˆ›å»ºapiserverç³»ç»ŸæœåŠ¡"><a href="#5-1-8-åˆ›å»ºapiserverç³»ç»ŸæœåŠ¡" class="headerlink" title="5.1.8 åˆ›å»ºapiserverç³»ç»ŸæœåŠ¡"></a>5.1.8 åˆ›å»ºapiserverç³»ç»ŸæœåŠ¡</h4><pre><code># vim /lib/systemd/system/kube-apiserver.servicecat &gt; /lib/systemd/system/kube-apiserver.service &lt;&lt;\EOF[Unit]Description=Kubernetes API ServerDocumentation=https://github.com/GoogleCloudPlatform/kubernetesAfter=network.target[Service]EnvironmentFile=/etc/kubernetes/kube-apiserver/kube-apiserver.confExecStart=/opt/src/kubernetes/server/bin/kube-apiserver $KUBE_APISERVER_OPTSRestart=on-failureRestartSec=5Type=notifyLimitNOFILE=65536[Install]WantedBy=multi-user.targetEOF</code></pre><h4 id="5-1-9-å¯åŠ¨apiserveræœåŠ¡"><a href="#5-1-9-å¯åŠ¨apiserveræœåŠ¡" class="headerlink" title="5.1.9 å¯åŠ¨apiserveræœåŠ¡"></a>5.1.9 å¯åŠ¨apiserveræœåŠ¡</h4><pre><code>systemctl daemon-reloadsystemctl restart kube-apiserversystemctl enable kube-apiserversystemctl status kube-apiserver# æŸ¥çœ‹æ—¥å¿—è¾“å‡ºï¼ˆæ²¡æœ‰æŠ¥é”™å°±è¯´æ˜å¯åŠ¨æˆåŠŸï¼‰journalctl -f -u kube-apiserver.service</code></pre><h3 id="5-2-éƒ¨ç½²kube-controller-manager"><a href="#5-2-éƒ¨ç½²kube-controller-manager" class="headerlink" title="5.2 éƒ¨ç½²kube-controller-manager"></a>5.2 éƒ¨ç½²kube-controller-manager</h3><h4 id="5-2-1-æ·»åŠ é…ç½®æ–‡ä»¶"><a href="#5-2-1-æ·»åŠ é…ç½®æ–‡ä»¶" class="headerlink" title="5.2.1 æ·»åŠ é…ç½®æ–‡ä»¶"></a>5.2.1 æ·»åŠ é…ç½®æ–‡ä»¶</h4><pre><code>mkdir -pv /etc/kubernetes/kube-controller/cat &gt; /etc/kubernetes/kube-controller/kube-controller.conf &lt;&lt;EOFKUBE_CONTROLLER_MANAGER_OPTS=&quot;--leader-elect true \\  --address=127.0.0.1 \\  --allocate-node-cidrs=true \\  --cluster-cidr 172.17.0.0/16 \\  --master http://127.0.0.1:8080 \\  --log-dir /data/kubernetes/logs/kube-controller-manager \\  --service-cluster-ip-range 10.10.10.0/24 \\  --service-account-private-key-file /opt/src/kubernetes/server/bin/pki/ca-key.pem \\  --root-ca-file /opt/src/kubernetes/server/bin/pki/ca.pem \\  --v 2&quot;EOF</code></pre><blockquote><p>ğŸ˜¡ æ³¨æ„ï¼šä¿®æ”¹<code>--cluster-cidr</code>å‚æ•°ä¸ºkubernetesé›†ç¾¤å†…podåœ°å€ç½‘æ®µã€‚</p><p>ğŸ˜¡ æ³¨æ„ï¼šä¿®æ”¹<code>--service-cluster-ip-range</code>å‚æ•°,åŒapiserveré…ç½®ä¸€æ ·</p><p>ğŸ¤” [å¯é€‰é¡¹] ä½¿ç”¨supervisorå¯åŠ¨kube-controllerræœåŠ¡ï¼Œå¹¶å¿½ç•¥â€œ5.2.2 åˆ›å»ºcontrollerç³»ç»ŸæœåŠ¡â€</p><ul><li>3ã€<a href="./supervisor.md">ä½¿ç”¨spuervisorå¯åŠ¨kube-controller</a></li></ul></blockquote><h4 id="5-2-2-åˆ›å»ºcontrollerç³»ç»ŸæœåŠ¡"><a href="#5-2-2-åˆ›å»ºcontrollerç³»ç»ŸæœåŠ¡" class="headerlink" title="5.2.2 åˆ›å»ºcontrollerç³»ç»ŸæœåŠ¡"></a>5.2.2 åˆ›å»ºcontrollerç³»ç»ŸæœåŠ¡</h4><pre><code># vim /lib/systemd/system/kube-controller.servicecat &gt; /lib/systemd/system/kube-controller.service &lt;&lt;\EOF[Unit]Description=Kubernetes Controller ManagerDocumentation=https://github.com/kubernetes/kubernetes[Service]EnvironmentFile=/etc/kubernetes/kube-controller/kube-controller.confExecStart=/opt/src/kubernetes/server/bin/kube-controller-manager $KUBE_CONTROLLER_MANAGER_OPTSRestart=on-failureRestartSec=5[Install]WantedBy=multi-user.targetEOF</code></pre><h4 id="5-2-3-å¯åŠ¨controllerç³»ç»ŸæœåŠ¡"><a href="#5-2-3-å¯åŠ¨controllerç³»ç»ŸæœåŠ¡" class="headerlink" title="5.2.3 å¯åŠ¨controllerç³»ç»ŸæœåŠ¡"></a>5.2.3 å¯åŠ¨controllerç³»ç»ŸæœåŠ¡</h4><pre><code>systemctl daemon-reloadsystemctl restart kube-controllersystemctl enable kube-controllersystemctl status kube-controller# æŸ¥çœ‹æ—¥å¿—è¾“å‡ºï¼ˆæ²¡æœ‰æŠ¥é”™å°±è¯´æ˜å¯åŠ¨æˆåŠŸï¼‰journalctl -f -u kube-controller.service</code></pre><h3 id="5-3-éƒ¨ç½²kube-scheduler"><a href="#5-3-éƒ¨ç½²kube-scheduler" class="headerlink" title="5.3 éƒ¨ç½²kube-scheduler"></a>5.3 éƒ¨ç½²kube-scheduler</h3><h4 id="5-3-1-æ·»åŠ kube-scheduleré…ç½®æ–‡ä»¶"><a href="#5-3-1-æ·»åŠ kube-scheduleré…ç½®æ–‡ä»¶" class="headerlink" title="5.3.1 æ·»åŠ kube-scheduleré…ç½®æ–‡ä»¶"></a>5.3.1 æ·»åŠ kube-scheduleré…ç½®æ–‡ä»¶</h4><pre><code>mkdir -pv /etc/kubernetes/kube-scheduler/cat &gt; /etc/kubernetes/kube-scheduler/kube-scheduler.conf &lt;&lt;EOFKUBE_SCHEDULER_OPTS=&quot;--logtostderr=false \\--v=2 \\--leader-elect \\--master=127.0.0.1:8080 \\--address=127.0.0.1 \\--log-dir=/data/logs/kubernetes/kube-scheduler&quot;EOF</code></pre><blockquote><p>ğŸ¤” [å¯é€‰é¡¹] ä½¿ç”¨supervisorå¯åŠ¨kube-scheduleræœåŠ¡ï¼Œå¹¶å¿½ç•¥â€œ5.3.2 åˆ›å»ºkube-schedulerç³»ç»ŸæœåŠ¡â€</p><ul><li>4ã€<a href="./supervisor.md">ä½¿ç”¨spuervisorå¯åŠ¨kube-scheduler</a></li></ul></blockquote><h4 id="5-3-2-åˆ›å»ºkube-schedulerç³»ç»ŸæœåŠ¡"><a href="#5-3-2-åˆ›å»ºkube-schedulerç³»ç»ŸæœåŠ¡" class="headerlink" title="5.3.2 åˆ›å»ºkube-schedulerç³»ç»ŸæœåŠ¡"></a>5.3.2 åˆ›å»ºkube-schedulerç³»ç»ŸæœåŠ¡</h4><pre><code># vim /lib/systemd/system/kube-scheduler.servicecat &gt; /lib/systemd/system/kube-scheduler.service &lt;&lt;\EOF[Unit]Description=Kubernetes SchedulerDocumentation=https://github.com/kubernetes/kubernetes[Service]EnvironmentFile=/etc/kubernetes/kube-scheduler/kube-scheduler.confExecStart=/opt/src/kubernetes/server/bin/kube-scheduler $KUBE_SCHEDULER_OPTSRestart=on-failureRestartSec=5[Install]WantedBy=multi-user.targetEOF</code></pre><h4 id="5-3-3-å¯åŠ¨kube-scheduleræœåŠ¡"><a href="#5-3-3-å¯åŠ¨kube-scheduleræœåŠ¡" class="headerlink" title="5.3.3 å¯åŠ¨kube-scheduleræœåŠ¡"></a>5.3.3 å¯åŠ¨kube-scheduleræœåŠ¡</h4><pre><code>systemctl daemon-reloadsystemctl restart kube-schedulersystemctl enable kube-schedulersystemctl status kube-scheduler# æŸ¥çœ‹æ—¥å¿—è¾“å‡ºï¼ˆæ²¡æœ‰æŠ¥é”™å°±è¯´æ˜å¯åŠ¨æˆåŠŸï¼‰journalctl -f -u kube-scheduler.service</code></pre><h4 id="5-3-4-åˆ›å»ºkubectlè½¯é“¾æ¥å’Œæ£€æŸ¥é›†ç¾¤çŠ¶æ€"><a href="#5-3-4-åˆ›å»ºkubectlè½¯é“¾æ¥å’Œæ£€æŸ¥é›†ç¾¤çŠ¶æ€" class="headerlink" title="5.3.4 åˆ›å»ºkubectlè½¯é“¾æ¥å’Œæ£€æŸ¥é›†ç¾¤çŠ¶æ€"></a>5.3.4 åˆ›å»ºkubectlè½¯é“¾æ¥å’Œæ£€æŸ¥é›†ç¾¤çŠ¶æ€</h4><pre><code>ln -s /opt/src/kubernetes/server/bin/kubectl /usr/local/sbin/# æ£€æŸ¥é›†ç¾¤çŠ¶æ€kubectl get cskubectl get cs -o yaml</code></pre><h2 id="6ã€å®‰è£…NodeèŠ‚ç‚¹ç»„ä»¶"><a href="#6ã€å®‰è£…NodeèŠ‚ç‚¹ç»„ä»¶" class="headerlink" title="6ã€å®‰è£…NodeèŠ‚ç‚¹ç»„ä»¶"></a>6ã€å®‰è£…NodeèŠ‚ç‚¹ç»„ä»¶</h2><h3 id="6-1-éƒ¨ç½²kubelet"><a href="#6-1-éƒ¨ç½²kubelet" class="headerlink" title="6.1 éƒ¨ç½²kubelet"></a>6.1 éƒ¨ç½²kubelet</h3><blockquote><p>ğŸ¤” æ³¨æ„ï¼šnodeèŠ‚ç‚¹ä¸Šéœ€è¦å®‰è£…çš„ç»„ä»¶ä¸ºï¼škubeletã€kubeproxyå’Œdocker</p><p>ğŸ”¥ æ³¨æ„ï¼šä¸‹é¢æ“ä½œéœ€è¦åœ¨æ‰€æœ‰nodeèŠ‚ç‚¹ä¸Šæ‰§è¡Œï¼Œå®‰è£…å‰éœ€è¦å…ˆåœ¨CAèŠ‚ç‚¹ç»™kubeletç­¾å‘è¯ä¹¦</p><p>ğŸ”¥ æ³¨æ„ï¼škubeletæœåŠ¡åœ¨å¯åŠ¨æ—¶éœ€è¦dockerç¯å¢ƒå¦åˆ™æ— æ³•å¯åŠ¨</p></blockquote><ul><li><a href="../docs/docker.md">å®‰è£…dockerç¯å¢ƒ</a></li><li><a href="#71-éƒ¨ç½²kubelet">æ‹‰å–kubeletå¯åŠ¨æ˜¯æ‰€éœ€é•œåƒpause</a></li></ul><pre><code>docker pull registry.cn-beijing.aliyuncs.com/zhoujun/pause:3.1docker tag registry.cn-beijing.aliyuncs.com/zhoujun/pause:3.1 k8s.gcr.io/pause:3.1docker rmi registry.cn-beijing.aliyuncs.com/zhoujun/pause:3.1</code></pre><h4 id="6-1-1-ä¸‹è½½kubernetes-nodeå®‰è£…åŒ…"><a href="#6-1-1-ä¸‹è½½kubernetes-nodeå®‰è£…åŒ…" class="headerlink" title="6.1.1 ä¸‹è½½kubernetes-nodeå®‰è£…åŒ…"></a>6.1.1 ä¸‹è½½kubernetes-nodeå®‰è£…åŒ…</h4><pre><code># ä¸‹è½½kubernetes-node v18.9curl -L https://dl.k8s.io/v1.18.8/kubernetes-node-linux-amd64.tar.gz -o /opt/src/kubernetes-node-linux-amd64.tar.gz mkdir -pv /opt/src/kubernetes-node-v1.18.8tar zxf /opt/src/kubernetes-node-linux-amd64.tar.gz -C /opt/src/kubernetes-node-v1.18.8mv /opt/src/kubernetes-node-v1.18.8/kubernetes/* /opt/src/kubernetes-node-v1.18.8/ln -s /opt/src/kubernetes-node-v1.18.8/ /opt/src/kubernetes-node# åˆ›å»ºç›®å½•mkdir -p /opt/src/kubernetes-node/node/bin/{pki,conf}</code></pre><h4 id="6-1-2-ç­¾å‘kubeletè¯ä¹¦"><a href="#6-1-2-ç­¾å‘kubeletè¯ä¹¦" class="headerlink" title="6.1.2 ç­¾å‘kubeletè¯ä¹¦"></a>6.1.2 ç­¾å‘kubeletè¯ä¹¦</h4><blockquote><p>ğŸ˜¡ æ³¨æ„ï¼šåœ¨CAæœåŠ¡å™¨ç»™kubeletç­¾å‘è¯ä¹¦</p><ul><li><a href="#612-ç­¾å‘kubeletè¯ä¹¦">åœ¨CAæœåŠ¡å™¨ä¸Šç­¾å‘è¯ä¹¦</a></li></ul><p>ğŸ˜¡ æ³¨æ„ï¼šä¿®æ”¹<code>hosts</code>å‚æ•°å†…ipåœ°å€</p></blockquote><pre><code>cat &gt; /opt/kubernetes/pki/kubelet-csr.json &lt;&lt;EOF{    &quot;CN&quot;: &quot;k8s-kubelet&quot;,    &quot;hosts&quot;: [        &quot;192.168.0.181&quot;,        &quot;192.168.0.172&quot;,        &quot;10.10.10.1&quot;        &quot;192.168.0.147&quot;    ],    &quot;key&quot;: {        &quot;algo&quot;: &quot;rsa&quot;,        &quot;size&quot;: 2048    },    &quot;names&quot;: [        {            &quot;C&quot;: &quot;CN&quot;,            &quot;ST&quot;: &quot;Beijing&quot;,            &quot;L&quot;: &quot;Beijing&quot;,            &quot;O&quot;: &quot;kubernetes&quot;,            &quot;OU&quot;: &quot;System&quot;        }    ]}EOF# ç­¾å‘kubeletè¯ä¹¦cd /opt/kubernetes/pki/cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=server kubelet-csr.json | cfssljson -bare kubelet</code></pre><h4 id="6-1-3-æ‹·è´kubeletè¯ä¹¦åˆ°nodeèŠ‚ç‚¹"><a href="#6-1-3-æ‹·è´kubeletè¯ä¹¦åˆ°nodeèŠ‚ç‚¹" class="headerlink" title="6.1.3 æ‹·è´kubeletè¯ä¹¦åˆ°nodeèŠ‚ç‚¹"></a>6.1.3 æ‹·è´kubeletè¯ä¹¦åˆ°nodeèŠ‚ç‚¹</h4><ul><li>ä»CAæ‹·è´è¯ä¹¦åˆ°å„ä¸ªnodeèŠ‚ç‚¹ä¸Šè¯ä¹¦ç›®å½•ä¸‹</li></ul><pre><code># mastercp /opt/kubernetes/pki/{ca,client,client-key}.pem /opt/src/kubernetes-node/node/bin/pki/cp /opt/kubernetes/pki/{kubelet,kubelet-key}.pem /opt/src/kubernetes-node/node/bin/pki/# node01scp /opt/kubernetes/pki/{ca,client,client-key}.pem node1:/opt/src/kubernetes-node/node/bin/pki/scp /opt/kubernetes/pki/{kubelet,kubelet-key}.pem node1:/opt/src/kubernetes-node/node/bin/pki/# node02scp /opt/kubernetes/pki/{ca,client,client-key}.pem node2:/opt/src/kubernetes-node/node/bin/pki/scp /opt/kubernetes/pki/{kubelet,kubelet-key}.pem node2:/opt/src/kubernetes-node/node/bin/pki/</code></pre><pre><code># åˆ›å»ºkubeletå‘½ä»¤è½¯é“¾æ¥ln -s /opt/src/kubernetes-node/node/bin/kubectl /usr/local/sbin/</code></pre><h4 id="6-1-4-åˆ›å»ºk8s-node-yamlé…ç½®"><a href="#6-1-4-åˆ›å»ºk8s-node-yamlé…ç½®" class="headerlink" title="6.1.4 åˆ›å»ºk8s-node.yamlé…ç½®"></a>6.1.4 åˆ›å»ºk8s-node.yamlé…ç½®</h4><blockquote><p>ğŸ˜¡ æ³¨æ„ï¼š<a href="#714-åˆ›å»ºkubeleté…ç½®">æ­¤æ­¥åœ¨masterèŠ‚ç‚¹æ‰§è¡Œ</a></p></blockquote><pre><code>cat &gt; /opt/src/kubernetes/server/bin/conf/k8s-node.yaml &lt;&lt;EOFapiVersion: rbac.authorization.k8s.io/v1kind: ClusterRoleBindingmetadata:  name: k8s-noderoleRef:  apiGroup: rbac.authorization.k8s.io  kind: ClusterRole  name: system:nodesubjects:- apiGroup: rbac.authorization.k8s.io  kind: User  name: k8s-nodeEOF# åˆ›å»ºé…ç½®cd /opt/src/kubernetes/server/bin/conf/kubectl create -f k8s-node.yaml</code></pre><h4 id="6-1-5-åˆ›å»ºkubelet-kubeconfigæ–‡ä»¶"><a href="#6-1-5-åˆ›å»ºkubelet-kubeconfigæ–‡ä»¶" class="headerlink" title="6.1.5 åˆ›å»ºkubelet.kubeconfigæ–‡ä»¶"></a>6.1.5 åˆ›å»ºkubelet.kubeconfigæ–‡ä»¶</h4><blockquote><p>ğŸ˜¡ è­¦å‘Šï¼šä¿®æ”¹<code>server</code>å‚æ•°,API-Serveråœ°å€</p></blockquote><pre><code>cat &gt; /opt/src/kubernetes-node/node/bin/conf/kubelet.kubeconfig &lt;&lt;EOFapiVersion: v1clusters:- cluster:    certificate-authority-data:     certificate-authority: /opt/src/kubernetes-node/node/bin/pki/ca.pem    server: https://192.168.0.181:6443  name: default-clustercontexts:- context:    cluster: default-cluster    namespace: default    user: k8s-node  name: default-contextcurrent-context: default-contextkind: ConfigcgroupDriver: cgroupfspreferences: {}users:- name: k8s-node  user:    client-certificate: /opt/src/kubernetes-node/node/bin/pki/client.pem    client-key: /opt/src/kubernetes-node/node/bin/pki/client-key.pemEOF</code></pre><h4 id="6-1-6-æ·»åŠ kubeleté…ç½®æ–‡ä»¶"><a href="#6-1-6-æ·»åŠ kubeleté…ç½®æ–‡ä»¶" class="headerlink" title="6.1.6 æ·»åŠ kubeleté…ç½®æ–‡ä»¶"></a>6.1.6 æ·»åŠ kubeleté…ç½®æ–‡ä»¶</h4><pre><code>mkdir -pv /etc/kubernetes/kubelet/mkdir -pv /data/kubernetes/logs/kubelet# æ·»åŠ kubeleté…ç½®æ–‡ä»¶cat &gt; /etc/kubernetes/kubelet/kubelet.conf &lt;&lt;EOFKUBELET_OPTS=&quot;--v=2 \  --anonymous-auth=false \  --cgroup-driver cgroupfs \  --cluster-dns 10.10.10.1 \  --cluster-domain cluster.local \  --runtime-cgroups=/systemd/system.slice \  --kubelet-cgroups=/systemd/system.slice \  --fail-swap-on=false \  --client-ca-file /opt/src/kubernetes-node/node/bin/pki/ca.pem \  --tls-cert-file /opt/src/kubernetes-node/node/bin/pki/kubelet.pem \  --tls-private-key-file /opt/src/kubernetes-node/node/bin/pki/kubelet-key.pem \  --hostname-override k8s-node01 \  --image-gc-high-threshold 20 \  --image-gc-low-threshold 10 \  --kubeconfig /opt/src/kubernetes-node/node/bin/conf/kubelet.kubeconfig \  --log-dir /data/kubernetes/logs/kubelet \  --pod-infra-container-image k8s.gcr.io/pause:3.1 \  --root-dir /data/kubernetes/logs/kubelet&quot;EOF</code></pre><blockquote><p>ğŸ˜¡ æ³¨æ„ï¼šä¿®æ”¹æ¯ä¸ªnodeèŠ‚ç‚¹ä¸Š<code>--hostname-override</code>å‚æ•°ipåœ°å€</p><p>ğŸ˜¡ æ³¨æ„ï¼šä¿®æ”¹<code>--cluster-dns</code>ä¸ºä¸€ä¸ªå…·ä½“Ip,ä¸€å®šè¦å¯¹åº”apiserver<code>service-cluster-ip-range</code>å’Œcontroller-manager<code>service-cluster-ip-range</code>ç­‰é…ç½®å‚æ•°ç½‘æ®µ</p><p>ğŸ¤” [å¯é€‰é¡¹] å¦‚ä½¿ç”¨supervisorå¯åŠ¨kubeletæœåŠ¡,è¯·ç‚¹å‡»è·³è½¬â€œä½¿ç”¨supervisorå¯åŠ¨kubeletâ€å¹¶å¿½ç•¥ â€œ6.1.7 åˆ›å»ºKubeletç³»ç»ŸæœåŠ¡â€</p><ul><li>5ã€<a href="./supervisor.md">ä½¿ç”¨supervisorå¯åŠ¨kubelet</a></li></ul></blockquote><h4 id="6-1-7-åˆ›å»ºKubeletç³»ç»ŸæœåŠ¡"><a href="#6-1-7-åˆ›å»ºKubeletç³»ç»ŸæœåŠ¡" class="headerlink" title="6.1.7 åˆ›å»ºKubeletç³»ç»ŸæœåŠ¡"></a>6.1.7 åˆ›å»ºKubeletç³»ç»ŸæœåŠ¡</h4><pre><code># vim /lib/systemd/system/kubelet.servicecat &gt; /lib/systemd/system/kubelet.service &lt;&lt;\EOF[Unit]Description=Kubernetes KubeletAfter=docker.serviceBefore=docker.service[Service]EnvironmentFile=/etc/kubernetes/kubelet/kubelet.confExecStart=/opt/src/kubernetes-node/node/bin/kubelet $KUBELET_OPTSRestart=on-failureLimitNOFILE=65536[Install]WantedBy=multi-user.targetEOF</code></pre><h4 id="6-1-8-å¯åŠ¨Kubeletç³»ç»ŸæœåŠ¡"><a href="#6-1-8-å¯åŠ¨Kubeletç³»ç»ŸæœåŠ¡" class="headerlink" title="6.1.8 å¯åŠ¨Kubeletç³»ç»ŸæœåŠ¡"></a>6.1.8 å¯åŠ¨Kubeletç³»ç»ŸæœåŠ¡</h4><pre><code>systemctl daemon-reloadsystemctl restart kubeletsystemctl enable kubeletsystemctl status kubelet# æŸ¥çœ‹æ—¥å¿—è¾“å‡ºï¼ˆæ²¡æœ‰æŠ¥é”™å°±è¯´æ˜å¯åŠ¨æˆåŠŸï¼‰journalctl -f -u kubelet</code></pre><h4 id="6-1-7-æŸ¥çœ‹nodeèŠ‚ç‚¹ä¿¡æ¯"><a href="#6-1-7-æŸ¥çœ‹nodeèŠ‚ç‚¹ä¿¡æ¯" class="headerlink" title="6.1.7 æŸ¥çœ‹nodeèŠ‚ç‚¹ä¿¡æ¯"></a>6.1.7 æŸ¥çœ‹nodeèŠ‚ç‚¹ä¿¡æ¯</h4><pre><code># æ£€æŸ¥æ‰€æœ‰èŠ‚ç‚¹å¹¶ç»™èŠ‚ç‚¹æ‰“ä¸Šæ ‡ç­¾kubectl get nodeNAME         STATUS   ROLES    AGE   VERSIONk8s-node01   Ready    &lt;none&gt;   53s   v1.18.8k8s-node02   Ready    &lt;none&gt;   34s   v1.18.8</code></pre><pre><code># ç»™èŠ‚ç‚¹æ‰“æ ‡ç­¾kubectl label node k8s-node01 node-role.kubernetes.io/master=kubectl label node k8s-node01 node-role.kubernetes.io/node=</code></pre><h3 id="6-2-éƒ¨ç½²kube-proxy"><a href="#6-2-éƒ¨ç½²kube-proxy" class="headerlink" title="6.2 éƒ¨ç½²kube-proxy"></a>6.2 éƒ¨ç½²kube-proxy</h3><blockquote><p>ğŸ”¥æ³¨æ„ï¼šåœ¨CAæœåŠ¡å™¨ç»™kube-proxyç­¾å‘è¯ä¹¦</p></blockquote><h4 id="6-2-1-ç­¾å‘kube-proxyè¯ä¹¦"><a href="#6-2-1-ç­¾å‘kube-proxyè¯ä¹¦" class="headerlink" title="6.2.1 ç­¾å‘kube-proxyè¯ä¹¦"></a>6.2.1 ç­¾å‘kube-proxyè¯ä¹¦</h4><pre><code>cat &gt; /opt/kubernetes/pki/kube-proxy-csr.json &lt;&lt;EOF{    &quot;CN&quot;: &quot;system:kube-proxy&quot;,    &quot;hosts&quot;: [],    &quot;key&quot;: {        &quot;algo&quot;: &quot;rsa&quot;,        &quot;size&quot;: 2048    },    &quot;names&quot;: [        {            &quot;C&quot;: &quot;CN&quot;,            &quot;ST&quot;: &quot;Beijing&quot;,            &quot;L&quot;: &quot;Beijing&quot;,            &quot;O&quot;: &quot;kubernetes&quot;,            &quot;OU&quot;: &quot;System&quot;        }    ]}EOF# ç­¾å‘è¯ä¹¦cd /opt/kubernetes/pki/cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=client kube-proxy-csr.json | cfssljson -bare kube-proxy</code></pre><h4 id="6-2-2-æ‹·è´kube-proxyè¯ä¹¦åˆ°nodeèŠ‚ç‚¹"><a href="#6-2-2-æ‹·è´kube-proxyè¯ä¹¦åˆ°nodeèŠ‚ç‚¹" class="headerlink" title="6.2.2 æ‹·è´kube-proxyè¯ä¹¦åˆ°nodeèŠ‚ç‚¹"></a>6.2.2 æ‹·è´kube-proxyè¯ä¹¦åˆ°nodeèŠ‚ç‚¹</h4><blockquote><p>æ‹·è´kube-proxyè¯ä¹¦åˆ°nodeèŠ‚ç‚¹</p></blockquote><pre><code># mastercp /opt/kubernetes/pki/{kube-proxy,kube-proxy-key}.pem /opt/src/kubernetes-node/node/bin/pki# node01scp /opt/kubernetes/pki/{kube-proxy,kube-proxy-key}.pem node1:/opt/src/kubernetes-node/node/bin/pki# node02scp /opt/kubernetes/pki/{kube-proxy,kube-proxy-key}.pem node2:/opt/src/kubernetes-node/node/bin/pki</code></pre><h4 id="6-2-3-é…ç½®ipvs"><a href="#6-2-3-é…ç½®ipvs" class="headerlink" title="6.2.3 é…ç½®ipvs"></a>6.2.3 é…ç½®ipvs</h4><pre><code># vim /root/ipvs.shcat &gt; /root/ipvs.sh &lt;&lt;\EOF#!/bin/bash ipvs_mods_dir=&quot;/usr/lib/modules/$(uname -r)/kernel/net/netfilter/ipvs&quot;for i in $(ls $ipvs_mods_dir|grep -o &quot;^[^.]*&quot;)do  /sbin/modinfo -F filename $i &amp;&gt;/dev/null  if [ $? -eq 0 ];then    /sbin/modprobe $i  fidoneEOF# chmod +x /root/ipvs.shsh /root/ipvs.shlsmod |grep ip_vsyum -y install ipset ipvsadm###æˆ–è€…ï¼ˆä¸Šä¸‹éƒ½å¯ä»¥å¼€å¯ipvsï¼‰cat &gt; /etc/sysconfig/modules/ipvs.modules &lt;&lt;EOF#!/bin/bashmodprobe -- ip_vsmodprobe -- ip_vs_rrmodprobe -- ip_vs_wrrmodprobe -- ip_vs_shmodprobe -- nf_conntrack_ipv4EOF# æ·»åŠ æ–‡ä»¶æƒé™chmod 755 /etc/sysconfig/modules/ipvs.modules &amp;&amp; bash /etc/sysconfig/modules/ipvs.modules# æŸ¥çœ‹åŠ è½½lsmod | grep -e ip_vs -e nf_conntrack_ipv4</code></pre><h4 id="6-2-4-åˆ›å»ºkube-proxy-kubeconfigæ–‡ä»¶"><a href="#6-2-4-åˆ›å»ºkube-proxy-kubeconfigæ–‡ä»¶" class="headerlink" title="6.2.4 åˆ›å»ºkube-proxy.kubeconfigæ–‡ä»¶"></a>6.2.4 åˆ›å»ºkube-proxy.kubeconfigæ–‡ä»¶</h4><blockquote><p>ğŸš¨è­¦å‘Šï¼šä¿®æ”¹<code>server</code>å‚æ•°,API-Serveråœ°å€</p></blockquote><pre><code>mkdir -pv /opt/src/kubernetes-node/node/bin/confcat &gt; /opt/src/kubernetes-node/node/bin/conf/kube-proxy.kubeconfig &lt;&lt;EOFapiVersion: v1clusters:- cluster:    certificate-authority: /opt/src/kubernetes-node/node/bin/pki/ca.pem    server: https://192.168.0.181:6443  name: default-clustercontexts:- context:    cluster: default-cluster    user: kube-proxy  name: defaultcurrent-context: defaultkind: Configpreferences: {}users:- name: kube-proxy  user:    client-certificate: /opt/src/kubernetes-node/node/bin/pki/kube-proxy.pem    client-key: /opt/src/kubernetes-node/node/bin/pki/kube-proxy-key.pemEOF</code></pre><h4 id="6-2-5-åˆ›å»ºkube-proxyé…ç½®æ–‡ä»¶"><a href="#6-2-5-åˆ›å»ºkube-proxyé…ç½®æ–‡ä»¶" class="headerlink" title="6.2.5 åˆ›å»ºkube-proxyé…ç½®æ–‡ä»¶"></a>6.2.5 åˆ›å»ºkube-proxyé…ç½®æ–‡ä»¶</h4><pre><code>mkdir -pv /etc/kubernetes/kube-proxymkdir -pv /data/kubernetes/logs/kubeproxy/cat &gt; /etc/kubernetes/kube-proxy/kube-proxy.conf &lt;&lt;EOFKUBE_PROXY_OPTS=&quot;--v=2 \  --cluster-cidr 172.17.0.0/16 \  --hostname-override master \  --proxy-mode=ipvs \  --ipvs-scheduler=nq \  --log-dir=/data/kubernetes/logs/kubeproxy \  --kubeconfig /opt/src/kubernetes-node/node/bin/conf/kube-proxy.kubeconfig&quot;EOF</code></pre><blockquote><p>ğŸ˜¡ æ³¨æ„ï¼šä¿®æ”¹<code>--cluster-cidr</code>å‚æ•°,æ­¤ipæ®µä¸ºpodçš„ipåœ°å€ç½‘æ®µ.å’Œcontroller<code>cluster-cidr</code>å‚æ•°ä¸€è‡´</p><p>ğŸ˜¡ æ³¨æ„ï¼šä¿®æ”¹<code>--hostname-override</code>å‚æ•°ä¸»æœºå</p></blockquote><h4 id="6-2-6-åˆ›å»ºkube-proxyç³»ç»ŸæœåŠ¡"><a href="#6-2-6-åˆ›å»ºkube-proxyç³»ç»ŸæœåŠ¡" class="headerlink" title="6.2.6 åˆ›å»ºkube-proxyç³»ç»ŸæœåŠ¡"></a>6.2.6 åˆ›å»ºkube-proxyç³»ç»ŸæœåŠ¡</h4><pre><code>cat &gt; /lib/systemd/system/kube-proxy.service &lt;&lt;\EOF[Unit]Description=Kubernetes ProxyAfter=network.target[Service]EnvironmentFile=/etc/kubernetes/kube-proxy/kube-proxy.confExecStart=/opt/src/kubernetes-node/node/bin/kube-proxy $KUBE_PROXY_OPTSRestart=on-failureLimitNOFILE=65536[Install]WantedBy=multi-user.targetEOF</code></pre><h4 id="6-2-7-å¯åŠ¨kube-proxyç³»ç»ŸæœåŠ¡"><a href="#6-2-7-å¯åŠ¨kube-proxyç³»ç»ŸæœåŠ¡" class="headerlink" title="6.2.7 å¯åŠ¨kube-proxyç³»ç»ŸæœåŠ¡"></a>6.2.7 å¯åŠ¨kube-proxyç³»ç»ŸæœåŠ¡</h4><pre><code>systemctl daemon-reloadsystemctl restart kube-proxysystemctl enable kube-proxysystemctl status kube-proxy# æŸ¥çœ‹æ—¥å¿—è¾“å‡ºï¼ˆæ²¡æœ‰æŠ¥é”™å°±è¯´æ˜å¯åŠ¨æˆåŠŸï¼‰journalctl -f -u kube-proxy.service</code></pre>]]></content>
      
      
      <categories>
          
          <category> å®¹å™¨ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Prometheusï¼ˆ1ï¼‰</title>
      <link href="2020/10/29/jian-kong/prometheus/prometheus-1/"/>
      <url>2020/10/29/jian-kong/prometheus/prometheus-1/</url>
      
        <content type="html"><![CDATA[<h5 id="ä»€ä¹ˆæ˜¯-Prometheus"><a href="#ä»€ä¹ˆæ˜¯-Prometheus" class="headerlink" title="ä»€ä¹ˆæ˜¯ Prometheus"></a><strong>ä»€ä¹ˆæ˜¯</strong> <strong>Prometheus</strong></h5><p><strong>Prometheusæ˜¯ç”±SoundCloudå¼€å‘çš„å¼€æºç›‘æ§æŠ¥è­¦ç³»ç»Ÿå’Œæ—¶åºåˆ—æ•°æ®åº“(TSDB)ã€‚Prometheusä½¿ç”¨Goè¯­è¨€å¼€å‘ï¼Œæ˜¯</strong> </p><p><strong>Google BorgMonç›‘æ§ç³»ç»Ÿçš„å¼€æºç‰ˆæœ¬</strong> </p><blockquote><p>å®˜ç½‘ï¼š<a href="https://prometheus.io/docs" target="_blank" rel="noopener">https://prometheus.io/docs</a></p></blockquote><h5 id="Prometheus-çš„ç‰¹ç‚¹"><a href="#Prometheus-çš„ç‰¹ç‚¹" class="headerlink" title="Prometheus çš„ç‰¹ç‚¹"></a><strong>Prometheus</strong> <strong>çš„ç‰¹ç‚¹</strong></h5><blockquote><p>å¤šç»´åº¦æ•°æ®æ¨¡å‹ã€‚ </p><p>çµæ´»çš„æŸ¥è¯¢è¯­è¨€ã€‚ </p><p>ä¸ä¾èµ–åˆ†å¸ƒå¼å­˜å‚¨ï¼Œå•ä¸ªæœåŠ¡å™¨èŠ‚ç‚¹æ˜¯è‡ªä¸»çš„ã€‚ </p><p>é€šè¿‡åŸºäºHTTPçš„pullæ–¹å¼é‡‡é›†æ—¶åºæ•°æ®ã€‚ </p><p>å¯ä»¥é€šè¿‡ä¸­é—´ç½‘å…³è¿›è¡Œæ—¶åºåˆ—æ•°æ®æ¨é€ã€‚ </p><p>é€šè¿‡æœåŠ¡å‘ç°æˆ–è€…é™æ€é…ç½®æ¥å‘ç°ç›®æ ‡æœåŠ¡å¯¹è±¡ã€‚ </p><p>æ”¯æŒå¤šç§å¤šæ ·çš„å›¾è¡¨å’Œç•Œé¢å±•ç¤ºï¼Œæ¯”å¦‚Grafanaç­‰ã€‚</p></blockquote><h5 id="åŸºæœ¬åŸç†"><a href="#åŸºæœ¬åŸç†" class="headerlink" title="åŸºæœ¬åŸç†"></a><strong>åŸºæœ¬åŸç†</strong></h5><p>Prometheusçš„åŸºæœ¬åŸç†æ˜¯é€šè¿‡HTTPåè®®å‘¨æœŸæ€§æŠ“å–è¢«ç›‘æ§ç»„ä»¶çš„çŠ¶æ€ï¼Œä»»æ„ç»„ä»¶åªè¦æä¾›å¯¹åº”çš„HTTPæ¥å£å°±å¯ä»¥ </p><p>æ¥å…¥ç›‘æ§ã€‚ä¸éœ€è¦ä»»ä½•SDKæˆ–è€…å…¶ä»–çš„é›†æˆè¿‡ç¨‹ã€‚è¾“å‡ºè¢«ç›‘æ§ç»„ä»¶ä¿¡æ¯çš„HTTPæ¥å£è¢«å«åšexporter ã€‚ç›®å‰äº’è”ç½‘å…¬ </p><p>å¸å¸¸ç”¨çš„ç»„ä»¶å¤§éƒ¨åˆ†éƒ½æœ‰exporterå¯ä»¥ç›´æ¥ä½¿ç”¨ï¼Œæ¯”å¦‚Varnishã€Haproxyã€Nginxã€MySQLã€Linuxç³»ç»Ÿä¿¡æ¯ </p><p><a href="https://imgchr.com/i/BY4VtP" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2020/10/30/BY4VtP.png" alt="BY4VtP.png"></a></p><h5 id="æœåŠ¡è¿‡ç¨‹"><a href="#æœåŠ¡è¿‡ç¨‹" class="headerlink" title="æœåŠ¡è¿‡ç¨‹"></a><strong>æœåŠ¡è¿‡ç¨‹</strong></h5><ul><li>Prometheus Daemonè´Ÿè´£å®šæ—¶å»ç›®æ ‡ä¸ŠæŠ“å–metrics(æŒ‡æ ‡)æ•°æ®ï¼Œæ¯ä¸ªæŠ“å–ç›®æ ‡éœ€è¦æš´éœ²ä¸€ä¸ªhttpæœåŠ¡çš„æ¥å£ </li></ul><p>ç»™å®ƒå®šæ—¶æŠ“å–ã€‚Prometheusæ”¯æŒé€šè¿‡é…ç½®æ–‡ä»¶ã€æ–‡æœ¬æ–‡ä»¶ã€Zookeeperã€Consulã€DNS SRV Lookupç­‰æ–¹å¼æŒ‡ </p><p>å®šæŠ“å–ç›®æ ‡ã€‚Prometheusé‡‡ç”¨PULLçš„æ–¹å¼è¿›è¡Œç›‘æ§ï¼Œå³æœåŠ¡å™¨å¯ä»¥ç›´æ¥é€šè¿‡ç›®æ ‡PULLæ•°æ®æˆ–è€…é—´æ¥åœ°é€šè¿‡ä¸­ </p><p>é—´ç½‘å…³æ¥Pushæ•°æ®ã€‚ </p><ul><li>Prometheusåœ¨æœ¬åœ°å­˜å‚¨æŠ“å–çš„æ‰€æœ‰æ•°æ®ï¼Œå¹¶é€šè¿‡ä¸€å®šè§„åˆ™è¿›è¡Œæ¸…ç†å’Œæ•´ç†æ•°æ®ï¼Œå¹¶æŠŠå¾—åˆ°çš„ç»“æœå­˜å‚¨åˆ°æ–°çš„æ—¶ </li></ul><p>é—´åºåˆ—ä¸­ã€‚ </p><ul><li>Prometheusé€šè¿‡PromQLå’Œå…¶ä»–APIå¯è§†åŒ–åœ°å±•ç¤ºæ”¶é›†çš„æ•°æ®ã€‚Prometheusæ”¯æŒå¾ˆå¤šæ–¹å¼çš„å›¾è¡¨å¯è§†åŒ–ï¼Œä¾‹å¦‚ </li></ul><p>Grafanaã€è‡ªå¸¦çš„Promdashä»¥åŠè‡ªèº«æä¾›çš„æ¨¡ç‰ˆå¼•æ“ç­‰ç­‰ã€‚Prometheusè¿˜æä¾›HTTP APIçš„æŸ¥è¯¢æ–¹å¼ï¼Œè‡ªå®šä¹‰ </p><p>æ‰€éœ€è¦çš„è¾“å‡ºã€‚ </p><ul><li>PushGatewayæ”¯æŒClientä¸»åŠ¨æ¨é€metricsåˆ°PushGatewayï¼Œè€ŒPrometheusåªæ˜¯å®šæ—¶å»Gatewayä¸ŠæŠ“å–æ•°æ®ã€‚ </li><li>Alertmanageræ˜¯ç‹¬ç«‹äºPrometheusçš„ä¸€ä¸ªç»„ä»¶ï¼Œå¯ä»¥æ”¯æŒPrometheusçš„æŸ¥è¯¢è¯­å¥ï¼Œæä¾›ååˆ†çµæ´»çš„æŠ¥è­¦æ–¹ </li></ul><p>å¼ã€‚</p><h5 id="æ•°æ®æ¨¡å‹"><a href="#æ•°æ®æ¨¡å‹" class="headerlink" title="æ•°æ®æ¨¡å‹"></a><strong>æ•°æ®æ¨¡å‹</strong></h5><p>Prometheusä»æ ¹æœ¬ä¸Šå­˜å‚¨çš„æ‰€æœ‰æ•°æ®éƒ½æ˜¯æ—¶é—´åºåˆ—ï¼Œå…·æœ‰æ—¶é—´æˆ³çš„æ•°æ®æµåªå±äºå•ä¸ªåº¦é‡æŒ‡æ ‡å’Œè¯¥åº¦é‡æŒ‡æ ‡ä¸‹çš„å¤š </p><p>ä¸ªæ ‡ç­¾ç»´åº¦ã€‚ </p><p>æ—¶é—´åºåˆ—æ•°æ®ç”±metricåç§°å’Œå®ƒçš„æ ‡ç­¾labelsé”®å€¼å¯¹é›†åˆå”¯ä¸€ç¡®å®šã€‚ </p><p>labbelså¼€å¯äº†Prometheusçš„å¤šç»´æ•°æ®æ¨¡å‹ï¼šå¯¹äºç›¸åŒçš„åº¦é‡åç§°ï¼Œé€šè¿‡ä¸åŒæ ‡ç­¾åˆ—è¡¨çš„ç»“åˆ, ä¼šå½¢æˆç‰¹å®šçš„åº¦é‡ç»´ </p><p>åº¦å®ä¾‹ã€‚</p><pre><code>&lt;metric name&gt;{&lt;label name&gt;=&lt;label value&gt;, ...}</code></pre><p>ä¾‹å¦‚ï¼š</p><pre><code>api_http_requests_total{method=&quot;POST&quot;, handler=&quot;/messages&quot;}</code></pre><p>ç±»å‹ï¼š </p><p>Counterè®¡æ•°å™¨ è¡¨ç¤ºå•ä¸ªå•è°ƒé€’å¢è®¡æ•°å™¨çš„ç´¯ç§¯åº¦é‡ï¼Œå…¶å€¼åªèƒ½åœ¨é‡å¯æ—¶å¢åŠ æˆ–é‡ç½®ä¸ºé›¶ã€‚ </p><p>Gaugesæµ‹é‡å™¨ è¡¨ç¤ºä¸€ä¸ªæ—¢å¯ä»¥é€’å¢, åˆå¯ä»¥é€’å‡çš„å€¼ã€‚ </p><p>HistogramæŸ±çŠ¶å›¾ å¯¹è§‚å¯Ÿç»“æœè¿›è¡Œé‡‡æ ·æˆ–æ±‚å’Œï¼Œå¹¶å°†å…¶è®¡å…¥å¯é…ç½®å­˜å‚¨æ¡¶ä¸­ã€‚ </p><p>Summaryæ¦‚è¦ æ˜¯é‡‡æ ·ç‚¹åˆ†ä½å›¾ç»Ÿè®¡ï¼Œè®¡ç®—åœ¨ä¸€å®šæ—¶é—´çª—å£èŒƒå›´å†…metricså¯¹è±¡çš„æ€»æ•°ä»¥åŠæ‰€æœ‰metricsçš„æ€»å’Œ </p><h5 id="ä¸‰å¤§å¥—ä»¶"><a href="#ä¸‰å¤§å¥—ä»¶" class="headerlink" title="ä¸‰å¤§å¥—ä»¶"></a><strong>ä¸‰å¤§å¥—ä»¶</strong></h5><p>Server ä¸»è¦è´Ÿè´£æ•°æ®é‡‡é›†å’Œå­˜å‚¨ï¼Œæä¾›PromQLæŸ¥è¯¢è¯­è¨€çš„æ”¯æŒã€‚ </p><p>Alertmanager è­¦å‘Šç®¡ç†å™¨ï¼Œç”¨æ¥è¿›è¡ŒæŠ¥è­¦ã€‚ </p><p>Push Gateway æ”¯æŒä¸´æ—¶æ€§Jobä¸»åŠ¨æ¨é€æŒ‡æ ‡çš„ä¸­é—´ç½‘å…³ã€‚ </p><h6 id="å®‰è£…-Server"><a href="#å®‰è£…-Server" class="headerlink" title="å®‰è£…**Server**"></a><strong>å®‰è£…**</strong>Server**</h6><pre class=" language-shell"><code class="language-shell">[root@master ~]# mkdir -p /data/promethues/{client,server}[root@master ~]# touch /data/promethues/server/rules.yml[root@master ~]# chmod 777 /data/promethues/server/rules.yml[root@master ~]# vi /data/promethues/server/promethues.yml[root@master ~]# cat  /data/promethues/server/promethues.ymlglobal:   scrape_interval: 15s #é»˜è®¤æŠ“å–é—´éš”,15ç§’å‘ç›®æ ‡æŠ“å–ä¸€æ¬¡æ•°æ®   evaluation_interval: 15s   external_labels:     monitor: 'codelab-monitor'     # å®šä¹‰æŠ“å–å¯¹è±¡ scrape_configs:   - job_name: 'prometheus' #é‡å†™æ—¶é—´åºä¾‹ï¼Œæ¯ä¸€æ¡éƒ½ä¼šè‡ªåŠ¨æ·»åŠ ä¸Š{job_name:"prometheus"}çš„æ ‡ç­¾ - job_name: 'prometheus'     scrape_interval: 5s # é‡å†™å…¨å±€æŠ“å–é—´éš”æ—¶é—´ï¼Œç”±15ç§’é‡å†™æˆ5ç§’     static_configs:       - targets: ['localhost:9090'][root@master ~]# [root@master ~]# docker run --name=prometheus -d -p 9090:9090 -v /data/promethues/server/promethues.yml:/etc/prometheus/prometheus.yml -v /data/promethues/server/rules.yml:/etc/prometheus/rules.yml prom/prometheus -- config.file=/etc/prometheus/prometheus.yml --web.enable-lifecycle667f9b60c7f0eedecd7685e6ae59dd034ac1e66e766f5b552986cd634eadfe32</code></pre><blockquote><p>å¯åŠ¨æ—¶åŠ ä¸Šâ€“web.enable-lifecycleå¯ç”¨è¿œç¨‹çƒ­åŠ è½½é…ç½®æ–‡ä»¶ </p><p>è°ƒç”¨æŒ‡ä»¤æ˜¯curl -X POST <a href="http://localhost:9090/-/reload" target="_blank" rel="noopener">http://localhost:9090/-/reload</a> </p><p>åœ¨æµè§ˆå™¨ä¸­è®¿é—® è®¿é—®<a href="http://192.168.42.150:9090/" target="_blank" rel="noopener">http://192.168.42.150:9090/</a></p><p><a href="http://192.168.42.150:9090/metrics" target="_blank" rel="noopener">http://192.168.42.150:9090/metrics</a></p></blockquote><p>*<em>é€šè¿‡ <code>node exporter</code> æä¾› <code>metrics</code> *</em></p><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># docker run -d --name=node-exporter -p 9100:9100 prom/node-exporter</span>f18b6aa81b086319808a383c070ac1fc0cf93db0b4818b727afa05371045280d<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># vim /data/promethues/server/promethues.yml</span><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># tail -5  /data/promethues/server/promethues.yml</span>  <span class="token punctuation">-</span> <span class="token key atrule">job_name</span><span class="token punctuation">:</span> <span class="token string">'nodes'</span>    <span class="token key atrule">static_configs</span><span class="token punctuation">:</span>       <span class="token punctuation">-</span> <span class="token key atrule">targets</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'192.168.42.150:9100'</span><span class="token punctuation">,</span><span class="token string">'192.168.42.151:9100'</span><span class="token punctuation">,</span><span class="token string">'192.168.42.152:9100'</span><span class="token punctuation">]</span>        <span class="token key atrule">labels</span><span class="token punctuation">:</span>           <span class="token key atrule">group</span><span class="token punctuation">:</span> <span class="token string">'client-node-exporter'</span><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># curl -X POST http://localhost:9090/-/reload </span></code></pre><p>åœ¨GUIä¸­æŸ¥çœ‹ Targetså¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><a href="https://imgchr.com/i/BNMRcd" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2020/10/30/BNMRcd.png" alt="BNMRcd.png"></a></p><h6 id="å®‰è£…-pushgateway"><a href="#å®‰è£…-pushgateway" class="headerlink" title="å®‰è£…**pushgateway**"></a><strong>å®‰è£…**</strong>pushgateway**</h6><blockquote><p>pushgatewayæ˜¯ä¸ºäº†å…è®¸ä¸´æ—¶ä½œä¸šå’Œæ‰¹å¤„ç†ä½œä¸šå‘prometheuså…¬å¼€ä»–ä»¬çš„æŒ‡æ ‡ã€‚ ç”±äºè¿™ç±»ä½œä¸šçš„å­˜åœ¨æ—¶é—´å¯èƒ½ä¸å¤Ÿé•¿, æ— æ³•æŠ“å–åˆ°, å› æ­¤å®ƒä»¬å¯ä»¥å°†æŒ‡æ ‡æ¨é€åˆ°æ¨ç½‘å…³ä¸­ã€‚ Prometheusé‡‡é›†æ•°æ®æ˜¯ç”¨çš„pullä¹Ÿå°±æ˜¯æ‹‰æ¨¡å‹ï¼Œè¿™ä»ä¸Šé¢è®¾ç½®çš„5ç§’å‚æ•°å°±èƒ½çœ‹å‡ºæ¥ã€‚ä½†æ˜¯æœ‰äº›æ•°æ®å¹¶ä¸é€‚åˆé‡‡ç”¨è¿™æ ·çš„æ–¹å¼ï¼Œå¯¹è¿™æ ·çš„æ•°æ®å¯ä»¥ä½¿ç”¨Push GatewayæœåŠ¡ã€‚ å®ƒ å°±ç›¸å½“äºä¸€ä¸ªç¼“å­˜ï¼Œå½“æ•°æ®é‡‡é›†å®Œæˆä¹‹åï¼Œå°±ä¸Šä¼ åˆ°è¿™é‡Œï¼Œç”±Prometheusç¨åå†pullè¿‡æ¥ã€‚</p></blockquote><p>é¦–å…ˆå¯åŠ¨ <code>Push Gateway</code> </p><pre class=" language-shell"><code class="language-shell">[root@master ~]# docker run -d -p 9091:9091 --name pushgateway prom/pushgatewayUnable to find image 'prom/pushgateway:latest' locallylatest: Pulling from prom/pushgateway76df9210b28c: Already exists 559be8e06c14: Already exists 8491d2b1da91: Pull complete 67e6436e486c: Pull complete Digest: sha256:c0d39b8d4cfebec5c86ed19e0af68bdfed493d0d8098f99b1e9acf91d10e781eStatus: Downloaded newer image for prom/pushgateway:latest712f422674083dd855c50b3205b8f5d9914daa22ffacae71da3506b4d5604b97</code></pre><p>Pushgateway GUI å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><a href="https://imgchr.com/i/BNl8WF" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2020/10/30/BNl8WF.png" alt="BNl8WF.png"></a></p><blockquote><p>æ¥ä¸‹æ¥å°±å¯ä»¥å¾€pushgatewayæ¨é€æ•°æ®äº†ï¼Œprometheusæä¾›äº†å¤šç§è¯­è¨€çš„sdkï¼Œæœ€ç®€å•çš„æ–¹å¼å°±æ˜¯é€šè¿‡shell </p></blockquote><p>æ¨é€ä¸€ä¸ªæŒ‡æ ‡å¦‚ä¸‹æ“ä½œï¼š </p><pre class=" language-shell"><code class="language-shell">[root@node2 ~]# echo "metric01 100" | curl --data-binary @- http://192.168.42.150:9091/metrics/job/cyylog</code></pre><p>æ•ˆæœå¦‚ä¸‹ï¼š</p><p><a href="https://imgchr.com/i/BN1U1g" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2020/10/30/BN1U1g.png" alt="BN1U1g.png"></a></p><p>æ¨é€å¤šä¸ªæŒ‡æ ‡å¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre class=" language-shell"><code class="language-shell">[root@node2 ~]# cat << END  | curl --data-binary @- http://192.168.42.150:9091/metrics/job/cyy/instance/test> muscle_metric{label="TEST"} 8800> bench_press 100> dead_lift 160> deep_squal 160> END</code></pre><p>æ•ˆæœå¦‚ä¸‹ï¼š</p><p><a href="https://imgchr.com/i/BN8YQg" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2020/10/30/BN8YQg.png" alt="BN8YQg.png"></a></p><p>å†å°† <code>pushgateway</code> é…ç½®åˆ° <code>prometheus.yml</code> é‡Œè¾¹,é‡è½½é…ç½®</p><pre><code>[root@master ~]# tail -5 /data/promethues/server/promethues.yml   - job_name: pushgateway    static_configs:       - targets: [&#39;192.168.42.150:9090&#39;]        labels:           group: pushgateway</code></pre><h5 id="Grafana-å±•ç¤º"><a href="#Grafana-å±•ç¤º" class="headerlink" title="Grafana**å±•ç¤º"></a>Grafana<strong>**å±•ç¤º</strong></h5><blockquote><p><code>Grafana</code>æ˜¯ç”¨äºå¯è§†åŒ–å¤§å‹æµ‹é‡æ•°æ®çš„å¼€æºç¨‹åºï¼Œå®ƒæä¾›äº†å¼ºå¤§å’Œä¼˜é›…çš„æ–¹å¼å»åˆ›å»ºã€å…±äº«ã€æµè§ˆæ•°æ®ã€‚</p><p><code>Dashboard</code>  ä¸­æ˜¾ç¤ºäº†ä¸åŒ<code>metric</code>æ•°æ®æºä¸­çš„æ•°æ®ã€‚ <code>Grafana</code>æœ€å¸¸ç”¨äºå› ç‰¹ç½‘åŸºç¡€è®¾æ–½å’Œåº”ç”¨åˆ†æï¼Œä½†åœ¨å…¶ä»–é¢†åŸŸä¹Ÿæœ‰ç”¨åˆ°ï¼Œæ¯” å¦‚ï¼šå·¥ä¸šä¼ æ„Ÿå™¨ã€å®¶åº­è‡ªåŠ¨åŒ–ã€è¿‡ç¨‹æ§åˆ¶ç­‰ç­‰ã€‚Grafanaæ”¯æŒçƒ­æ’æ‹”æ§åˆ¶é¢æ¿å’Œå¯æ‰©å±•çš„æ•°æ®æºï¼Œç›®å‰å·²ç»æ”¯æŒ <code>Graphite</code>ã€<code>InflfluxDB</code>ã€<code>OpenTSDB</code>ã€<code>Elasticsearch</code>ã€<code>Prometheus</code>ç­‰ã€‚ </p></blockquote><p>ä»¥<code>docker</code>å½¢å¼è¿è¡Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code>[root@master ~]# docker run -d -p 3000:3000 --name grafana grafana/grafanaUnable to find image &#39;grafana/grafana:latest&#39; locallylatest: Pulling from grafana/grafana188c0c94c7c5: Pull complete 94db9aec2a58: Pull complete 618563756337: Pull complete f413b64712e1: Pull complete 18534279664f: Pull complete 4f4fb700ef54: Pull complete 3abba839cfd4: Pull complete aac362f49dd4: Pull complete Digest: sha256:9f43d0ac1fdecdd08a47bce4038fa5c9c67cc84fc025df78b87ae7b7b076aee9Status: Downloaded newer image for grafana/grafana:latest08cca0c2c86ce3be9e4006a20b66457464668646f6700fad2e5cbc0791d06999</code></pre><p>ç™»å½•<code>grafana</code>ï¼Œé»˜è®¤ç”¨æˆ·åå¯†ç éƒ½æ˜¯ä¸º<code>admin</code>ï¼Œç™»å½•åè®¾ç½®æ–°å¯†ç ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><a href="https://imgchr.com/i/BNt91K" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2020/10/30/BNt91K.png" alt="BNt91K.png"></a></p><p>ä¸º<code>grafana</code>æ·»åŠ æ•°æ®æºï¼š</p><p><a href="https://imgchr.com/i/BNt37j" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2020/10/30/BNt37j.png" alt="BNt37j.png"></a></p><p>æŒ‡å®šæ•°æ®æºä¸ºprometheusçš„åœ°å€ï¼š</p><p><a href="https://imgchr.com/i/BNtacT" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2020/10/30/BNtacT.png" alt="BNtacT.png"></a></p><p>å¯¼å…¥dashboardæ¨¡æ¿ï¼š </p><p><a href="https://imgchr.com/i/BNtq8P" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2020/10/30/BNtq8P.png" alt="BNtq8P.png"></a></p><p>Dashboardæ˜¾ç¤ºå¦‚ä¸‹ï¼š</p><p><a href="https://imgchr.com/i/BNtTUA" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2020/10/30/BNtTUA.png" alt="BNtTUA.png"></a></p><h5 id="å®‰è£…-AlterManager"><a href="#å®‰è£…-AlterManager" class="headerlink" title="å®‰è£…**AlterManager**"></a><strong>å®‰è£…**</strong>AlterManager**</h5><blockquote><p><code>Pormetheus</code>çš„è­¦å‘Šç”±ç‹¬ç«‹çš„ä¸¤éƒ¨åˆ†ç»„æˆã€‚PrometheusæœåŠ¡ä¸­çš„è­¦å‘Šè§„åˆ™å‘é€è­¦å‘Šåˆ°<code>Alertmanager</code>ã€‚ç„¶å <code>Alertmanager</code>ç®¡ç†è¿™äº›è­¦å‘Šã€‚åŒ…æ‹¬<code>silencing</code>, <code>inhibition</code>, <code>aggregation</code>ï¼Œä»¥åŠé€šè¿‡ä¸€äº›æ–¹æ³•å‘é€é€šçŸ¥ï¼Œä¾‹å¦‚ï¼š<code>email</code>ï¼Œ <code>PagerDuty</code>å’Œ<code>HipChat</code>ã€‚</p></blockquote><p><a href="https://imgchr.com/i/BNNPCq" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2020/10/30/BNNPCq.png" alt="BNNPCq.png"></a></p><p>å»ºç«‹è­¦å‘Šå’Œé€šçŸ¥çš„ä¸»è¦æ­¥éª¤ï¼š</p><blockquote><ul><li><p>åˆ›å»ºå’Œé…ç½®<code>Alertmanager</code> </p></li><li><p>å¯åŠ¨<code>Prometheus</code>æœåŠ¡æ—¶ï¼Œé€šè¿‡<code>-alertmanager.url</code>æ ‡å¿—é…ç½®<code>Alermanager</code>åœ°å€ï¼Œä»¥ä¾¿<code>Prometheus</code>æœåŠ¡èƒ½å’Œ<code>Alertmanager</code>å»ºç«‹è¿æ¥ã€‚ </p></li></ul></blockquote><p>åˆ›å»ºå’Œé…ç½®Alertmanager</p><pre class=" language-shell"><code class="language-shell">[root@master ~]# mkdir /data/promethues/server/alertmanager[root@master ~]# cd /data/promethues/server/alertmanager[root@master alertmanager]# vim alertmanager.yml[root@master alertmanager]# cat alertmanager.ymlglobal:  resolve_timeout: 5m   smtp_smarthost: 'smtp.qq.com:465'   smtp_from: 'your_qq@qq.com'   smtp_auth_username: 'your_qq@qq.com'   smtp_auth_password: 'psw'   smtp_require_tls: false templates:  - '/data/alertmanager/templates/*.tmpl'route:  receiver: test1  group_wait: 30s  group_interval: 5m  repeat_interval: 4h  group_by: [alertname]  routes:# ads webhook  - receiver: test1    group_wait: 10s    match:      team: ads# ops webhook  - receiver: test2    group_wait: 10s    match:      team: operationsreceivers:- name: test1  email_configs:  - to: 'your_qq@qq.com'    headers: { Subject: "[ads] æŠ¥è­¦é‚®ä»¶"} # æ¥æ”¶é‚®ä»¶çš„æ ‡é¢˜- name: test2  email_configs:  - to: 'your_qq@qq.com,your_163@163.com'    send_resolved: true    headers: { Subject: "[ops] æŠ¥è­¦é‚®ä»¶"} # æ¥æ”¶é‚®ä»¶çš„æ ‡é¢˜[root@master alertmanager]# </code></pre><p><strong>ä»¥<code>Docker</code>å½¢å¼è¿è¡Œ<code>alertmanager</code>å¦‚ä¸‹ï¼š</strong></p><pre class=" language-shell"><code class="language-shell">[root@master alertmanager]# docker run -d -p 9093:9093 --name alertmanager -v /data/promethues/server/alertmanager/alertmanager.yml:/etc/alertmanager/alertmanager.yml prom/alertmanager</code></pre><p><strong>æµè§ˆå™¨ä¸­è®¿é—®æœåŠ¡å™¨çš„<code>9093</code>ç«¯å£å¦‚ä¸‹æ‰€ç¤º</strong></p><p><a href="https://imgchr.com/i/BNDPw8" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2020/10/30/BNDPw8.png" alt="BNDPw8.png"></a></p><p><strong><code>alertmanager status</code>èœå•æ˜¾ç¤ºé»˜è®¤çš„é‚®ä»¶æ¨¡æ¿å¦‚ä¸‹æ‰€ç¤ºï¼š</strong></p><p><a href="https://imgchr.com/i/BNDeln" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2020/10/30/BNDeln.png" alt="BNDeln.png"></a></p><p><strong>æ·»åŠ æŠ¥è­¦è§„åˆ™ï¼Œå¹¶åœ¨<code>prometheus</code>ä¸­æŒ‡å®šalertmanagerçš„åœ°å€ ï¼Œå¦‚ä¸‹æ‰€ç¤º</strong></p><pre class=" language-shell"><code class="language-shell">[root@master alertmanager]# cd ..[root@master server]# lsalertmanager  promethues.yml  rules.yml[root@master server]# vim rules.yml [root@master server]# vim promethues.yml [root@master server]# tail -6 promethues.yml rule_files:  - /etc/prometheus/rules.ymlalerting:  alertmanagers:    - static_configs:         - targets: ['192.168.42.150:9093'][root@master server]# cat rules.yml groups:   - name: test    rules:       - alert: æµ‹è¯•         expr: dead_lift > 150         for: 1m         labels:           status: warning         annotations:           summary: "{{$labels.instance}}:ç¡¬æ‹‰è¶…æ ‡ï¼lightweight baby!!!"           description: "{{$labels.instance}}:ç¡¬æ‹‰è¶…æ ‡ï¼lightweight baby!!!"[root@master server]# </code></pre><p><strong><code>Prometheus</code> æ˜¾ç¤ºå¦‚ä¸‹æ‰€ç¤ºï¼š</strong></p><p><a href="https://imgchr.com/i/BNrWvR" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2020/10/30/BNrWvR.png" alt="BNrWvR.png"></a></p><p><a href="https://imgchr.com/i/BNrvrt" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2020/10/30/BNrvrt.png" alt="BNrvrt.png"></a></p><p><strong><code>Alertmanager</code>å±•ç¤ºå¦‚ä¸‹ï¼š</strong></p><p><a href="https://imgchr.com/i/BNsSVf" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2020/10/30/BNsSVf.png" alt="BNsSVf.png"></a></p><p><strong>é‚®ä»¶æ”¶åˆ°æŠ¥è­¦å†…å®¹å¦‚ä¸‹ï¼š</strong></p><p><a href="https://imgchr.com/i/BNsF2j" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2020/10/30/BNsF2j.png" alt="BNsF2j.png"></a></p><p>PS: </p><p>å‘Šè­¦è®¾ç½®è¯·æŸ¥çœ‹DLçš„å…¬ä¼—å·æ–‡ç« </p><p><a href="https://mp.weixin.qq.com/s/30hht_j18-LfzPDBxxnLvQ" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/30hht_j18-LfzPDBxxnLvQ</a></p>]]></content>
      
      
      <categories>
          
          <category> ç›‘æ§ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Prometheus </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>influxdb+grafanaç›‘æ§ç½‘ç»œæƒ…å†µ</title>
      <link href="2020/10/26/jian-kong/influxdb-grafana-jian-kong-wang-luo-qing-kuang/"/>
      <url>2020/10/26/jian-kong/influxdb-grafana-jian-kong-wang-luo-qing-kuang/</url>
      
        <content type="html"><![CDATA[<h3 id="influxdb-grafanaç›‘æ§ç½‘ç»œæƒ…å†µ"><a href="#influxdb-grafanaç›‘æ§ç½‘ç»œæƒ…å†µ" class="headerlink" title="influxdb+grafanaç›‘æ§ç½‘ç»œæƒ…å†µ"></a>influxdb+grafanaç›‘æ§ç½‘ç»œæƒ…å†µ</h3><h5 id="ä¸€ã€-éƒ¨ç½²InfluxDB"><a href="#ä¸€ã€-éƒ¨ç½²InfluxDB" class="headerlink" title="ä¸€ã€ éƒ¨ç½²InfluxDB"></a>ä¸€ã€ éƒ¨ç½²InfluxDB</h5><pre class=" language-shell"><code class="language-shell">docker run -d -p 8086:8086 --name=influxdb influxdb</code></pre><p>ä»¥ä¸Šå‘½ä»¤dcokerä¼šè‡ªåŠ¨ä»ä»“åº“ä¸‹è½½æœ€æ–°ç‰ˆæœ¬çš„influxdbé•œåƒï¼Œåå°è¿è¡Œä¸€ä¸ªåä¸ºinfluxdbçš„å®¹å™¨å¹¶æ˜ å°„ä¸»æœº8086ç«¯å£åˆ°å®¹å™¨8086ç«¯å£ã€‚</p><p>è‹¥æƒ³å°†æ•°æ®å­˜å‚¨åˆ°å®¿ä¸»æœºè€Œéå®¹å™¨å†…ï¼Œå¯ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å¯åŠ¨æŒ‚è½½æœ¬åœ°ç›®å½•åˆ°å®¹å™¨å†…ã€‚</p><pre class=" language-shell"><code class="language-shell"># $pwdä¸ºå½“å‰å·¥ä½œç›®å½•ï¼Œå¯æ›¿æ¢ä¸ºå…¶å®ƒå®¿ä¸»æœºç›®å½•[root@localhost influxdb]# pwd/opt/influxdb[root@localhost influxdb]# docker run -d -p 8086:8086 -v $PWD:/var/lib/influxdb --name=influxdb influxdb</code></pre><p>å¯åŠ¨InfluxDBå®¹å™¨åï¼Œé€šè¿‡httpæ¥å£è®¿é—®è¿›è¡Œæµ‹è¯•ã€‚</p><pre><code>curl -G http://localhost:8086/query --data-urlencode &quot;q=show databases&quot;</code></pre><p>è‹¥influxdbè¿è¡Œæ­£å¸¸ï¼Œåˆ™ä¼šè¿”å›å¦‚ä¸‹ç»“æœï¼š</p><pre><code># é“¾æ¥æŸ¥è¯¢å‚æ•°ä¸ºshow databases æ•°æ®åº“ä¼šè¿”å›æ‰€æœ‰çš„æ•°æ®åº“åï¼Œæ–°å®‰è£…çš„influxdbé»˜è®¤åªæœ‰ä¸€ä¸ª&quot;_internal&quot;# æ•°æ®åº“ã€‚{&quot;results&quot;:[{&quot;statement_id&quot;:0,&quot;series&quot;:[{&quot;name&quot;:&quot;databases&quot;,&quot;columns&quot;:[&quot;name&quot;],&quot;values&quot;:[[&quot;telegraf&quot;],[&quot;_internal&quot;],[&quot;network&quot;]]}]}]}</code></pre><h5 id="äºŒã€-å¯åŠ¨influxdbï¼Œä½¿ç”¨"><a href="#äºŒã€-å¯åŠ¨influxdbï¼Œä½¿ç”¨" class="headerlink" title="äºŒã€ å¯åŠ¨influxdbï¼Œä½¿ç”¨"></a>äºŒã€ å¯åŠ¨influxdbï¼Œä½¿ç”¨</h5><blockquote><p>PSï¼š<a href="https://jasper-zhang1.gitbooks.io/influxdb/content/Introduction/getting_start.html" target="_blank" rel="noopener">InfluxDBä¸­æ–‡æ–‡æ¡£</a>    </p><p>â€‹        <a href="https://docs.influxdata.com/" target="_blank" rel="noopener">å®˜ç½‘åœ°å€</a></p><p>å…¶ä»–å‘½ä»¤è¯·è‡ªè¡ŒæŸ¥çœ‹æ–‡æ¡£</p></blockquote><h6 id="1-è¿›å…¥å®¹å™¨"><a href="#1-è¿›å…¥å®¹å™¨" class="headerlink" title="1. è¿›å…¥å®¹å™¨"></a>1. è¿›å…¥å®¹å™¨</h6><pre class=" language-shell"><code class="language-shell">[root@localhost influxdb]# docker exec -it influxdb /bin/bash</code></pre><p>PSï¼š å› ä¸ºå®éªŒï¼Œæ‰€ä»¥ æˆ‘ä½¿ç”¨çš„æ˜¯é»˜è®¤ <code>influxdb</code> çš„é…ç½®æ–‡ä»¶ï¼Œå¯ä»¥è‡ªè¡ŒæŸ¥çœ‹å®˜ç½‘ä¿®æ”¹</p><h6 id="2-å¯åŠ¨influxdbï¼Œå¹¶ä¸”ä½¿ç”¨"><a href="#2-å¯åŠ¨influxdbï¼Œå¹¶ä¸”ä½¿ç”¨" class="headerlink" title="2. å¯åŠ¨influxdbï¼Œå¹¶ä¸”ä½¿ç”¨"></a>2. å¯åŠ¨influxdbï¼Œå¹¶ä¸”ä½¿ç”¨</h6><ol><li>åˆ›å»ºä¸€ä¸ª<code>mydb</code>æ•°æ®åº“ï¼š</li></ol><pre class=" language-sql"><code class="language-sql"><span class="token operator">></span> <span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> network</code></pre><ol start="2"><li>ç°åœ¨æ•°æ®åº“<code>mydb</code>å·²ç»åˆ›å»ºå¥½äº†ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨<code>SHOW DATABASES</code>è¯­å¥æ¥çœ‹çœ‹å·²å­˜åœ¨çš„æ•°æ®åº“ï¼š</li></ol><pre><code>&gt; SHOW DATABASESname: databases---------------name_internalmydb</code></pre><blockquote><p>è¯´æ˜ï¼š<code>_internal</code>æ•°æ®åº“æ˜¯ç”¨æ¥å­˜å‚¨InfluxDBå†…éƒ¨çš„å®æ—¶ç›‘æ§æ•°æ®çš„ã€‚</p></blockquote><p>ä¸åƒ<code>SHOW DATABASES</code>ï¼Œå¤§éƒ¨åˆ†InfluxQLéœ€è¦ä½œç”¨åœ¨ä¸€ä¸ªç‰¹å®šçš„æ•°æ®åº“ä¸Šã€‚ä½ å½“ç„¶å¯ä»¥åœ¨æ¯ä¸€ä¸ªæŸ¥è¯¢è¯­å¥ä¸Šå¸¦ä¸Šä½ æƒ³æŸ¥çš„æ•°æ®åº“çš„åå­—ï¼Œä½†æ˜¯CLIæä¾›äº†ä¸€ä¸ªæ›´ä¸ºæ–¹ä¾¿çš„æ–¹å¼<code>USE &lt;db-name&gt;</code>ï¼Œè¿™ä¼šä¸ºä½ åé¢çš„æ‰€ä»¥çš„è¯·æ±‚è®¾ç½®åˆ°è¿™ä¸ªæ•°æ®åº“ä¸Šã€‚ä¾‹å¦‚ï¼š</p><pre><code>&gt; USE mydbUsing database mydb&gt;</code></pre><h6 id="3-ä½¿ç”¨HTTPæ¥å£åˆ›å»ºæ•°æ®åº“"><a href="#3-ä½¿ç”¨HTTPæ¥å£åˆ›å»ºæ•°æ®åº“" class="headerlink" title="3. ä½¿ç”¨HTTPæ¥å£åˆ›å»ºæ•°æ®åº“"></a>3. ä½¿ç”¨HTTPæ¥å£åˆ›å»ºæ•°æ®åº“</h6><p>ä½¿ç”¨<code>POST</code>æ–¹å¼å‘é€åˆ°URLçš„<code>/query</code>è·¯å¾„ï¼Œå‚æ•°<code>q</code>ä¸º<code>CREATE DATABASE &lt;new_database_name&gt;</code>ï¼Œä¸‹é¢çš„ä¾‹å­å‘é€ä¸€ä¸ªè¯·æ±‚åˆ°æœ¬åœ°è¿è¡Œçš„InfluxDBåˆ›å»ºæ•°æ®åº“<code>mydb</code>:</p><pre><code>curl -i -XPOST http://localhost:8086/query --data-urlencode &quot;q=CREATE DATABASE mydb&quot;</code></pre><h6 id="4-ä½¿ç”¨HTTPæ¥å£æŸ¥è¯¢æ•°æ®"><a href="#4-ä½¿ç”¨HTTPæ¥å£æŸ¥è¯¢æ•°æ®" class="headerlink" title="4. ä½¿ç”¨HTTPæ¥å£æŸ¥è¯¢æ•°æ®"></a>4. ä½¿ç”¨HTTPæ¥å£æŸ¥è¯¢æ•°æ®</h6><p>HTTPæ¥å£æ˜¯InfluxDBæŸ¥è¯¢æ•°æ®çš„ä¸»è¦æ–¹å¼ã€‚é€šè¿‡å‘é€ä¸€ä¸ª<code>GET</code>è¯·æ±‚åˆ°<code>/query</code>è·¯å¾„ï¼Œå¹¶è®¾ç½®URLçš„<code>db</code>å‚æ•°ä¸ºç›®æ ‡æ•°æ®åº“ï¼Œè®¾ç½®URLå‚æ•°<code>q</code>ä¸ºæŸ¥è¯¢è¯­å¥ã€‚ä¸‹é¢çš„ä¾‹å­æ˜¯æŸ¥è¯¢åœ¨<a href="https://jasper-zhang1.gitbooks.io/influxdb/content/Guide/writing_data.html" target="_blank" rel="noopener">å†™æ•°æ®</a>é‡Œå†™å…¥çš„æ•°æ®ç‚¹ã€‚</p><pre><code>curl -G &#39;http://localhost:8086/query?pretty=true&#39; --data-urlencode &quot;db=mydb&quot; --data-urlencode &quot;q=SELECT \&quot;value\&quot; FROM \&quot;cpu_load_short\&quot; WHERE \&quot;region\&quot;=&#39;us-west&#39;&quot;</code></pre><blockquote><p>InfluxDBè¿”å›ä¸€ä¸ªjsonå€¼ï¼Œä½ æŸ¥è¯¢çš„ç»“æœåœ¨<code>result</code>åˆ—è¡¨ä¸­ï¼Œå¦‚æœæœ‰é”™è¯¯å‘é€ï¼ŒInfluxDBä¼šåœ¨<code>error</code>è¿™ä¸ªkeyé‡Œè§£é‡Šé”™è¯¯å‘ç”Ÿçš„åŸå› ã€‚</p></blockquote><h6 id="5-ç”¨æˆ·ç®¡ç†"><a href="#5-ç”¨æˆ·ç®¡ç†" class="headerlink" title="5. ç”¨æˆ·ç®¡ç†"></a>5. ç”¨æˆ·ç®¡ç†</h6><pre><code>&gt;shouw users (æŸ¥çœ‹ç”¨æˆ·)&gt;create user &quot;username&quot; with password &#39;password&#39; (åˆ›å»ºæ™®é€šç”¨æˆ·)&gt;create user &quot;username&quot; with password &#39;password&#39; with all privileges (åˆ›å»ºç®¡ç†å‘˜ç”¨æˆ·)&gt;drop user &quot;username&quot; (åˆ é™¤ç”¨æˆ·)&gt;auth (ç”¨æˆ·è®¤è¯ï¼Œè®¾ç½®å¯†ç åçš„ç™»å½•è®¤è¯)</code></pre><h6 id="6-shellè„šæœ¬æ’å…¥æ•°æ®"><a href="#6-shellè„šæœ¬æ’å…¥æ•°æ®" class="headerlink" title="6. shellè„šæœ¬æ’å…¥æ•°æ®"></a>6. shellè„šæœ¬æ’å…¥æ•°æ®</h6><blockquote><p>PS: é¦–å…ˆåˆ›å»ºä¸€ä¸ª æ•°æ®åº“+ç”¨æˆ·+å¯†ç éƒ½ä¸º<code>network</code> <strong>ï¼ˆå®éªŒç¯å¢ƒï¼‰</strong>    è¯·è‡ªè¡Œæå®š</p></blockquote><p>è„šæœ¬åœ°å€ï¼š</p><p><a href="https://github.com/cyylog/Script/blob/master/Grafana/Ping/network_insert%20_InfluxDB.sh" target="_blank" rel="noopener">My Github</a></p><p>ä¸ºæ–¹ä¾¿ <code>grafana</code> çš„å¯è§‚æ€§ï¼Œè¯·è‡ªè¡Œä¿®æ”¹<code>dic</code> </p><p>æ”¾åˆ°è®¡åˆ’ä»»åŠ¡ä¸­ï¼Œå¯ä»¥çœ‹åˆ°è¡¨ä¸­å·²ç»æœ‰æ•°æ®å†™å…¥</p><pre class=" language-shell"><code class="language-shell">> use networkUsing database network> show MEASUREMENTSname: measurementsname----SG_BRlatenSG_BRlossSG_VNlatenSG_VNloss> </code></pre><h5 id="ä¸‰ã€-éƒ¨ç½²Grafana"><a href="#ä¸‰ã€-éƒ¨ç½²Grafana" class="headerlink" title="ä¸‰ã€ éƒ¨ç½²Grafana"></a>ä¸‰ã€ éƒ¨ç½²Grafana</h5><p>GrafanaåŒæ ·é‡‡ç”¨å®˜æ–¹dockeré•œåƒè¿›è¡Œå¿«é€Ÿéƒ¨ç½²ã€‚</p><pre class=" language-bash"><code class="language-bash">docker run -d -p 3000:3000 --name<span class="token operator">=</span>grafana grafana/grafana</code></pre><p>ä»¥ä¸Šå‘½ä»¤dockerä¼šæ‹‰å–æœ€æ–°ç‰ˆgrafanaé•œåƒï¼Œè¿è¡Œåä¸ºgrafanaçš„å®¹å™¨ï¼Œå¹¶æ˜ å°„å®¿ä¸»æœº3000ç«¯å£ã€‚</p><p>åˆæ¬¡å¯åŠ¨ï¼Œgrafanaä¼šåˆ›å»ºæ•°æ®åº“ï¼Œæ—¶é—´ç¨é•¿ï¼Œç¨åå³å¯è®¿é—®<code>http://localhost:3000</code>æ‰“å¼€grafanaç™»å½•é¡µé¢ã€‚<br>è¾“å…¥é»˜è®¤ç”¨æˆ·åå¯†ç ç™»å½•ï¼ˆadminï¼‰ã€‚</p><p><a href="https://imgchr.com/i/BneM2n" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2020/10/26/BneM2n.png" alt="BneM2n.png"></a></p><p>æŒ‰ç…§ä¸»é¡µå‘å¯¼å®Œæˆåˆæ¬¡é…ç½®ã€‚</p><h6 id="1-æ·»åŠ æ•°æ®æº"><a href="#1-æ·»åŠ æ•°æ®æº" class="headerlink" title="1 æ·»åŠ æ•°æ®æº"></a>1 æ·»åŠ æ•°æ®æº</h6><p>ç‚¹å‡»æ·»åŠ æ•°æ®æºï¼ŒæŒ‰ç…§ä¸‹å›¾é…ç½®é€‰æ‹©influxdbæ·»åŠ ä¸€ä¸ªinfluxdbæ•°æ®æºã€‚</p><p>urléœ€é…ç½®æˆæ­£ç¡®çš„å®¿ä¸»æœºipå’Œç«¯å£ï¼ˆé˜²ç«å¢™éœ€æ”¾è¡Œ8086ï¼‰ï¼Œè‹¥ä¸æƒ³æš´éœ²æ•°æ®åº“ç«¯å£ï¼Œå¯æ¢æˆinfluxdbå®¹å™¨çš„ipåœ°å€ï¼ˆéœ€è‡ªè¡Œè¿›å…¥å®¹å™¨æŸ¥çœ‹ï¼Œå®¹å™¨é‡å¯åå¯èƒ½ä¼šå‘ç”Ÿå˜åŒ–ï¼‰é¿å…æ•°æ®åº“æš´éœ²è‡³å…¬ç½‘ã€‚</p><p>InfluxDB Detailséœ€å¡«å†™æ•°æ®åï¼ˆé»˜è®¤telegrafï¼‰ã€ç”¨æˆ·åå’Œå¯†ç ï¼ˆé»˜è®¤å‡ä¸ºrootï¼‰ã€‚</p><p>å¡«å†™å®Œæˆåï¼Œç‚¹å‡»<code>Save&amp;Test</code>æŒ‰é’®ï¼Œè‹¥è®¿é—®æ­£å¸¸ï¼Œä¼šå‡ºç°<code>Data source is working</code>æç¤ºï¼Œå¦åˆ™è¯·æ£€æŸ¥é…ç½®å†…å®¹ä»¥åŠç½‘ç»œï¼ˆé˜²ç«å¢™ï¼‰ã€‚</p><p><a href="https://imgchr.com/i/Bne1K0" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2020/10/26/Bne1K0.png" alt="Bne1K0.png"></a></p><p><a href="https://imgchr.com/i/Bne3rV" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2020/10/26/Bne3rV.png" alt="Bne3rV.png"></a></p><h6 id="2-æ·»åŠ ä»ªè¡¨æ¿"><a href="#2-æ·»åŠ ä»ªè¡¨æ¿" class="headerlink" title="2 æ·»åŠ ä»ªè¡¨æ¿"></a>2 æ·»åŠ ä»ªè¡¨æ¿</h6><p> <strong>è¿”å›ä¸»é¡µï¼Œç‚¹å‡»æ·»åŠ ä»ªè¡¨æ¿æŒ‰é’®æ·»åŠ æ–°ä»ªè¡¨æ¿ï¼Œç‚¹å‡»<code>Graph</code>åˆ›å»ºä¸€ä¸ªGraph Panelã€‚</strong></p><p><a href="https://imgchr.com/i/BneJVU" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2020/10/26/BneJVU.png" alt="BneJVU.png"></a></p><p><strong>é…ç½®å¥½æ•°æ®æºï¼Œç„¶åæ·»åŠ é¢æ¿å±•ç¤ºæ•°æ®</strong></p><p><a href="https://imgchr.com/i/BneTZ8" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2020/10/26/BneTZ8.png" alt="BneTZ8.png"></a></p><p><strong>æœ€åçš„ç»“æœå¦‚ä¸‹</strong></p><p><a href="https://imgchr.com/i/Bne7dS" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2020/10/26/Bne7dS.png" alt="Bne7dS.png"></a></p><h5 id="PS-æ–‡ç« ä¸­ä½¿ç”¨çš„è„šæœ¬"><a href="#PS-æ–‡ç« ä¸­ä½¿ç”¨çš„è„šæœ¬" class="headerlink" title="PS:  æ–‡ç« ä¸­ä½¿ç”¨çš„è„šæœ¬"></a>PS:  æ–‡ç« ä¸­ä½¿ç”¨çš„è„šæœ¬</h5><p>åœ°å€ï¼š <a href="https://github.com/cyylog/Script/tree/master/Grafana/Ping" target="_blank" rel="noopener">https://github.com/cyylog/Script/tree/master/Grafana/Ping</a></p>]]></content>
      
      
      <categories>
          
          <category> ç›‘æ§ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> influxdb </tag>
            
            <tag> grafana </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Zabbix-åŸç†</title>
      <link href="2020/10/24/jian-kong/zabbix/zabbix-yuan-li/"/>
      <url>2020/10/24/jian-kong/zabbix/zabbix-yuan-li/</url>
      
        <content type="html"><![CDATA[<p>â€‹               </p><blockquote><p>æƒ³è¦ç”¨å¥½zabbixè¿›è¡Œç›‘æ§ï¼Œé‚£ä¹ˆæˆ‘ä»¬é¦–è¦éœ€è¦äº†è§£ä¸‹zabbixè¿™ä¸ªè½¯ä»¶çš„å®ç°åŸç†åŠå®ƒçš„æ¶æ„ã€‚å»ºè®®å¤šé˜…è¯»å®˜æ–¹æ–‡æ¡£ã€‚</p><p>å®˜ç½‘åœ°å€ï¼š<a href="https://www.zabbix.com/documentation/4.0/zh/manual" target="_blank" rel="noopener">https://www.zabbix.com/documentation/4.0/zh/manual</a></p></blockquote><h4 id="ä¸€ã€zabbixæ¶æ„å›¾"><a href="#ä¸€ã€zabbixæ¶æ„å›¾" class="headerlink" title="ä¸€ã€zabbixæ¶æ„å›¾"></a>ä¸€ã€zabbixæ¶æ„å›¾</h4><p><a href="https://imgchr.com/i/B8SPUg" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2020/10/28/B8SPUg.png" alt="B8SPUg.png"></a></p><h4 id="äºŒã€zabbixç»„ä»¶"><a href="#äºŒã€zabbixç»„ä»¶" class="headerlink" title="äºŒã€zabbixç»„ä»¶"></a>äºŒã€zabbixç»„ä»¶</h4><h5 id="ç»„ä»¶éƒ¨åˆ†"><a href="#ç»„ä»¶éƒ¨åˆ†" class="headerlink" title="ç»„ä»¶éƒ¨åˆ†"></a>ç»„ä»¶éƒ¨åˆ†</h5><h6 id="1ã€Zabbix-Server"><a href="#1ã€Zabbix-Server" class="headerlink" title="1ã€Zabbix Server"></a>1ã€Zabbix Server</h6><blockquote><p>è´Ÿè´£æ¥æ”¶agentå‘é€çš„æŠ¥å‘Šä¿¡æ¯çš„æ ¸å¿ƒç»„ä»¶ï¼Œæ‰€æœ‰é…ç½®ï¼Œç»Ÿè®¡æ•°æ®åŠæ“ä½œæ•°æ®å‡ç”±å…¶ç»„ç»‡è¿›è¡Œï¼›</p></blockquote><h6 id="2ã€Database-Storage"><a href="#2ã€Database-Storage" class="headerlink" title="2ã€Database Storage"></a>2ã€Database Storage</h6><blockquote><p>ä¸“ç”¨äºå­˜å‚¨æ‰€æœ‰é…ç½®ä¿¡æ¯ï¼Œä»¥åŠç”±zabbixæ”¶é›†çš„æ•°æ®ï¼›</p></blockquote><h6 id="3ã€Web-interface"><a href="#3ã€Web-interface" class="headerlink" title="3ã€Web interface"></a>3ã€Web interface</h6><blockquote><p>zabbixçš„GUIæ¥å£ï¼Œé€šå¸¸ä¸Serverè¿è¡Œåœ¨åŒä¸€å°ä¸»æœºä¸Šï¼›</p></blockquote><h6 id="4ã€Proxy"><a href="#4ã€Proxy" class="headerlink" title="4ã€Proxy"></a>4ã€Proxy</h6><blockquote><p>å¯é€‰ç»„ä»¶ï¼Œå¸¸ç”¨äºç›‘æ§èŠ‚ç‚¹å¾ˆå¤šçš„åˆ†å¸ƒå¼ç¯å¢ƒä¸­ï¼Œä»£ç†serveræ”¶é›†éƒ¨åˆ†æ•°æ®è½¬å‘åˆ°serverï¼Œå¯ä»¥å‡è½»serverçš„å‹åŠ›ï¼›</p></blockquote><h6 id="5ã€Agent"><a href="#5ã€Agent" class="headerlink" title="5ã€Agent"></a>5ã€Agent</h6><blockquote><p>éƒ¨ç½²åœ¨è¢«ç›‘ä¸»æœºä¸Šï¼Œè´Ÿè´£æ”¶é›†æœ¬åœ°æ•°æ®å¹¶å‘å¾€Serverç«¯æˆ–Proxyç«¯ï¼›</p></blockquote><h4 id="ä¸‰ã€ç›¸å…³æœ¯è¯­"><a href="#ä¸‰ã€ç›¸å…³æœ¯è¯­" class="headerlink" title="ä¸‰ã€ç›¸å…³æœ¯è¯­"></a>ä¸‰ã€ç›¸å…³æœ¯è¯­</h4><h6 id="1ã€ä¸»æœºï¼ˆhostï¼‰"><a href="#1ã€ä¸»æœºï¼ˆhostï¼‰" class="headerlink" title="1ã€ä¸»æœºï¼ˆhostï¼‰"></a>1ã€ä¸»æœºï¼ˆhostï¼‰</h6><blockquote><p>è¦ç›‘æ§çš„ç½‘ç»œè®¾å¤‡ï¼Œå¯ç”±IPæˆ–DNSåç§°æŒ‡å®šï¼›</p></blockquote><h6 id="2ã€ä¸»æœºç»„ï¼ˆhost-groupï¼‰"><a href="#2ã€ä¸»æœºç»„ï¼ˆhost-groupï¼‰" class="headerlink" title="2ã€ä¸»æœºç»„ï¼ˆhost groupï¼‰"></a>2ã€ä¸»æœºç»„ï¼ˆhost groupï¼‰</h6><blockquote><p>ä¸»æœºçš„é€»è¾‘å®¹å™¨ï¼Œå¯ä»¥åŒ…å«ä¸»æœºå’Œæ¨¡æ¿ï¼Œä½†åŒä¸€ä¸ªç»„ç»‡å†…çš„ä¸»æœºå’Œæ¨¡æ¿ä¸èƒ½äº’ç›¸é“¾æ¥ï¼›ä¸»æœºç»„é€šå¸¸åœ¨ç»™ç”¨æˆ·æˆ–ç”¨æˆ·ç»„æŒ‡æ´¾ç›‘æ§æƒé™æ—¶ä½¿ç”¨ï¼›</p></blockquote><h6 id="3ã€ç›‘æ§é¡¹ï¼ˆitemï¼‰"><a href="#3ã€ç›‘æ§é¡¹ï¼ˆitemï¼‰" class="headerlink" title="3ã€ç›‘æ§é¡¹ï¼ˆitemï¼‰"></a>3ã€ç›‘æ§é¡¹ï¼ˆitemï¼‰</h6><blockquote><p>ä¸€ä¸ªç‰¹å®šç›‘æ§æŒ‡æ ‡çš„ç›¸å…³çš„æ•°æ®ï¼›è¿™äº›æ•°æ®æ¥è‡ªäºè¢«ç›‘æ§å¯¹è±¡ï¼›itemæ˜¯zabbixè¿›è¡Œæ•°æ®æ”¶é›†çš„æ ¸å¿ƒï¼Œç›¸å¯¹æŸä¸ªç›‘æ§å¯¹è±¡ï¼Œæ¯ä¸ªiteméƒ½ç”±â€keyâ€æ ‡è¯†ï¼›</p></blockquote><h6 id="4ã€è§¦å‘å™¨ï¼ˆtriggerï¼‰"><a href="#4ã€è§¦å‘å™¨ï¼ˆtriggerï¼‰" class="headerlink" title="4ã€è§¦å‘å™¨ï¼ˆtriggerï¼‰"></a>4ã€è§¦å‘å™¨ï¼ˆtriggerï¼‰</h6><blockquote><p>ä¸€ä¸ªè¡¨è¾¾å¼ï¼Œç”¨äºè¯„ä¼°æŸç›‘æ§å¯¹è±¡çš„ç‰¹å®šitemå†…æ¥æ”¶åˆ°çš„æ•°æ®æ˜¯å¦åœ¨åˆç†èŒƒå›´å†…ï¼Œä¹Ÿå°±æ˜¯é˜ˆå€¼ï¼›æ¥æ”¶çš„æ•°æ®é‡å¤§äºé˜ˆå€¼æ—¶ï¼Œè§¦å‘å™¨çŠ¶æ€å°†ä»â€OKâ€è½¬å˜ä¸ºâ€Problemâ€ï¼Œå½“æ•°æ®å†æ¬¡æ¢å¤åˆ°åˆç†èŒƒå›´ï¼Œåˆè½¬å˜ä¸ºâ€OKâ€ï¼›</p></blockquote><h6 id="5ã€äº‹ä»¶ï¼ˆeventï¼‰"><a href="#5ã€äº‹ä»¶ï¼ˆeventï¼‰" class="headerlink" title="5ã€äº‹ä»¶ï¼ˆeventï¼‰"></a>5ã€äº‹ä»¶ï¼ˆeventï¼‰</h6><blockquote><p>è§¦å‘ä¸€ä¸ªå€¼å¾—å…³æ³¨çš„äº‹æƒ…ï¼Œæ¯”å¦‚è§¦å‘å™¨çŠ¶æ€è½¬å˜ï¼Œæ–°çš„agentæˆ–é‡æ–°ä¸Šçº¿çš„agentçš„è‡ªåŠ¨æ³¨å†Œç­‰ï¼›</p></blockquote><h6 id="6ã€åŠ¨ä½œï¼ˆactionï¼‰"><a href="#6ã€åŠ¨ä½œï¼ˆactionï¼‰" class="headerlink" title="6ã€åŠ¨ä½œï¼ˆactionï¼‰"></a>6ã€åŠ¨ä½œï¼ˆactionï¼‰</h6><blockquote><p>æŒ‡å¯¹äºç‰¹å®šäº‹ä»¶äº‹å…ˆå®šä¹‰çš„å¤„ç†æ–¹æ³•ï¼Œå¦‚å‘é€é€šçŸ¥ï¼Œä½•æ—¶æ‰§è¡Œæ“ä½œï¼›</p></blockquote><h6 id="7ã€æŠ¥è­¦åª’ä»‹ç±»å‹ï¼ˆmediaï¼‰"><a href="#7ã€æŠ¥è­¦åª’ä»‹ç±»å‹ï¼ˆmediaï¼‰" class="headerlink" title="7ã€æŠ¥è­¦åª’ä»‹ç±»å‹ï¼ˆmediaï¼‰"></a>7ã€æŠ¥è­¦åª’ä»‹ç±»å‹ï¼ˆmediaï¼‰</h6><blockquote><p>å‘é€é€šçŸ¥çš„æ‰‹æ®µæˆ–è€…é€šé“ï¼Œå¦‚Emailã€Jabberæˆ–è€…SMSç­‰ï¼›</p></blockquote><h6 id="8ã€æ¨¡æ¿ï¼ˆtemplateï¼‰"><a href="#8ã€æ¨¡æ¿ï¼ˆtemplateï¼‰" class="headerlink" title="8ã€æ¨¡æ¿ï¼ˆtemplateï¼‰"></a>8ã€æ¨¡æ¿ï¼ˆtemplateï¼‰</h6><blockquote><p>ç”¨äºå¿«é€Ÿå®šä¹‰è¢«ç›‘æ§ä¸»æœºçš„é¢„è®¾æ¡ç›®é›†åˆï¼Œé€šå¸¸åŒ…å«äº†itemã€triggerã€graphã€screenã€applicationä»¥åŠlow-level discovery ruleï¼›æ¨¡æ¿å¯ä»¥ç›´æ¥é“¾æ¥è‡³æŸä¸ªä¸»æœºï¼›</p></blockquote><h6 id="9ã€å‰ç«¯ï¼ˆfrontendï¼‰"><a href="#9ã€å‰ç«¯ï¼ˆfrontendï¼‰" class="headerlink" title="9ã€å‰ç«¯ï¼ˆfrontendï¼‰"></a>9ã€å‰ç«¯ï¼ˆfrontendï¼‰</h6><blockquote><p>Zabbixçš„webæ¥å£</p></blockquote><h4 id="å››ã€ç›‘æ§æµç¨‹"><a href="#å››ã€ç›‘æ§æµç¨‹" class="headerlink" title="å››ã€ç›‘æ§æµç¨‹"></a>å››ã€ç›‘æ§æµç¨‹</h4><h5 id="ç›‘æ§ç³»ç»Ÿè¿è¡Œæµç¨‹"><a href="#ç›‘æ§ç³»ç»Ÿè¿è¡Œæµç¨‹" class="headerlink" title="ç›‘æ§ç³»ç»Ÿè¿è¡Œæµç¨‹"></a>ç›‘æ§ç³»ç»Ÿè¿è¡Œæµç¨‹</h5><blockquote><p>agentdéœ€è¦å®‰è£…åˆ°è¢«ç›‘æ§çš„ä¸»æœºä¸Šï¼Œå®ƒè´Ÿè´£å®šæœŸæ”¶é›†å„é¡¹æ•°æ®ï¼Œå¹¶å‘é€åˆ°zabbix serverç«¯ï¼Œzabbix serverå°†æ•°æ®å­˜å‚¨åˆ°æ•°æ®åº“ä¸­ï¼Œzabbix webæ ¹æ®æ•°æ®åœ¨å‰ç«¯è¿›è¡Œå±•ç°å’Œç»˜å›¾ã€‚<br>è¿™é‡Œagentdæ”¶é›†æ•°æ®åˆ†ä¸ºä¸»åŠ¨å’Œè¢«åŠ¨ä¸¤ç§æ¨¡å¼ï¼š</p></blockquote><h5 id="ä¸»åŠ¨"><a href="#ä¸»åŠ¨" class="headerlink" title="ä¸»åŠ¨"></a>ä¸»åŠ¨</h5><blockquote><p>agentè¯·æ±‚serverè·å–ä¸»åŠ¨çš„ç›‘æ§é¡¹åˆ—è¡¨ï¼Œå¹¶ä¸»åŠ¨å°†ç›‘æ§é¡¹å†…éœ€è¦æ£€æµ‹çš„æ•°æ®æäº¤ç»™server/proxy</p></blockquote><p>ã€ä¸»åŠ¨ç›‘æµ‹ã€‘é€šä¿¡è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><blockquote><p>zabbixé¦–å…ˆå‘ServerActiveé…ç½®çš„IPè¯·æ±‚è·å–active itemsï¼Œè·å–å¹¶æäº¤active itemsæ•°æ®å€¼serveræˆ–è€…proxyã€‚å¾ˆå¤šäººä¼šæå‡ºç–‘é—®ï¼šzabbixå¤šä¹…è·å–ä¸€æ¬¡active itemsï¼Ÿå®ƒä¼šæ ¹æ®é…ç½®æ–‡ä»¶ä¸­çš„RefreshActiveChecksçš„é¢‘ç‡è¿›è¡Œï¼Œå¦‚æœè·å–å¤±è´¥ï¼Œé‚£ä¹ˆå°†ä¼šåœ¨60ç§’ä¹‹åé‡è¯•ã€‚åˆ†ä¸¤ä¸ªéƒ¨åˆ†</p></blockquote><h6 id="è·å–ACTIVE-ITEMSåˆ—è¡¨"><a href="#è·å–ACTIVE-ITEMSåˆ—è¡¨" class="headerlink" title="è·å–ACTIVE ITEMSåˆ—è¡¨"></a>è·å–ACTIVE ITEMSåˆ—è¡¨</h6><blockquote><p>â€¢ Agentæ‰“å¼€TCPè¿æ¥<br>â€¢ Agentè¯·æ±‚itemsæ£€æµ‹åˆ—è¡¨<br>â€¢ Serverè¿”å›itemsåˆ—è¡¨<br>â€¢ Agent å¤„ç†å“åº”<br>â€¢ å…³é—­TCPè¿æ¥<br>â€¢ Agentå¼€å§‹æ”¶é›†æ•°æ®</p></blockquote><h6 id="ä¸»åŠ¨æ£€æµ‹æäº¤æ•°æ®è¿‡ç¨‹å¦‚ä¸‹"><a href="#ä¸»åŠ¨æ£€æµ‹æäº¤æ•°æ®è¿‡ç¨‹å¦‚ä¸‹" class="headerlink" title="ä¸»åŠ¨æ£€æµ‹æäº¤æ•°æ®è¿‡ç¨‹å¦‚ä¸‹"></a>ä¸»åŠ¨æ£€æµ‹æäº¤æ•°æ®è¿‡ç¨‹å¦‚ä¸‹</h6><blockquote><p>â€¢ Agentå»ºç«‹TCPè¿æ¥<br>â€¢ Agentæäº¤itemsåˆ—è¡¨æ”¶é›†çš„æ•°æ®<br>â€¢ Serverå¤„ç†æ•°æ®ï¼Œå¹¶è¿”å›å“åº”çŠ¶æ€<br>â€¢ å…³é—­TCPè¿æ¥</p></blockquote><h5 id="è¢«åŠ¨"><a href="#è¢«åŠ¨" class="headerlink" title="è¢«åŠ¨"></a>è¢«åŠ¨</h5><blockquote><p>serverå‘agentè¯·æ±‚è·å–ç›‘æ§é¡¹çš„æ•°æ®ï¼Œagentè¿”å›æ•°æ®ã€‚</p></blockquote><h6 id="ã€è¢«åŠ¨ç›‘æµ‹ã€‘é€šä¿¡è¿‡ç¨‹å¦‚ä¸‹ï¼š"><a href="#ã€è¢«åŠ¨ç›‘æµ‹ã€‘é€šä¿¡è¿‡ç¨‹å¦‚ä¸‹ï¼š" class="headerlink" title="ã€è¢«åŠ¨ç›‘æµ‹ã€‘é€šä¿¡è¿‡ç¨‹å¦‚ä¸‹ï¼š"></a>ã€è¢«åŠ¨ç›‘æµ‹ã€‘é€šä¿¡è¿‡ç¨‹å¦‚ä¸‹ï¼š</h6><blockquote><p>â€¢ Serveræ‰“å¼€ä¸€ä¸ªTCPè¿æ¥<br>â€¢ Serverå‘é€è¯·æ±‚agent.ping\n<br>â€¢ Agentæ¥æ”¶åˆ°è¯·æ±‚å¹¶ä¸”å“åº”<br>â€¢ Serverå¤„ç†æ¥æ”¶åˆ°çš„æ•°æ®1<br>â€¢ å…³é—­TCPè¿æ¥</p></blockquote><p><strong>ä»ä»¥ä¸Šè¿‡ç¨‹æˆ‘ä»¬å¯ä»¥çœ‹å‡ºæ¥ï¼Œè¢«åŠ¨æ¨¡å¼æ¯æ¬¡éƒ½éœ€è¦æ‰“å¼€ä¸€ä¸ªtcpè¿æ¥ï¼Œè¿™æ ·å½“ç›‘æ§é¡¹è¶Šæ¥è¶Šå¤šæ—¶ï¼Œå°±ä¼šå‡ºç°serverç«¯æ€§èƒ½é—®é¢˜äº†ã€‚</strong><br><strong>è¿˜æœ‰äººä¼šé—®ï¼Œé‚£å®é™…ç›‘æ§ä¸­æ˜¯ç”¨ä¸»åŠ¨çš„è¿˜æ˜¯è¢«åŠ¨çš„å‘¢ï¼Ÿè¿™é‡Œä¸»è¦æ¶‰åŠä¸¤ä¸ªåœ°æ–¹ï¼š</strong><br>1ã€æ–°å»ºç›‘æ§é¡¹ç›®æ—¶ï¼Œé€‰æ‹©çš„æ˜¯zabbixä»£ç†è¿˜æ˜¯zabbixç«¯ç‚¹ä»£ç†ç¨‹å¼ï¼ˆä¸»åŠ¨å¼ï¼‰ï¼Œå‰è€…æ˜¯è¢«åŠ¨æ¨¡å¼ï¼Œåè€…æ˜¯ä¸»åŠ¨æ¨¡å¼ã€‚<br>2ã€agentdé…ç½®æ–‡ä»¶ä¸­StartAgentså‚æ•°çš„è®¾ç½®ï¼Œå¦‚æœä¸º0ï¼Œè¡¨ç¤ºç¦æ­¢è¢«åŠ¨æ¨¡å¼ï¼Œå¦åˆ™å¼€å¯ã€‚ä¸€èˆ¬å»ºè®®ä¸è¦è®¾ç½®ä¸º0ï¼Œå› ä¸ºç›‘æ§é¡¹ç›®å¾ˆå¤šæ—¶ï¼Œå¯ä»¥éƒ¨åˆ†ä½¿ç”¨ä¸»åŠ¨ï¼Œéƒ¨åˆ†ä½¿ç”¨è¢«åŠ¨æ¨¡å¼ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> ç›‘æ§ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> zabbix </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Go-Redis</title>
      <link href="2020/10/23/devops/golang/go-redis/"/>
      <url>2020/10/23/devops/golang/go-redis/</url>
      
        <content type="html"><![CDATA[<h4 id="Redis-å®¹å™¨"><a href="#Redis-å®¹å™¨" class="headerlink" title="Redis å®¹å™¨"></a>Redis å®¹å™¨</h4><pre class=" language-shell"><code class="language-shell">docker run --name redis-d -v /usr/share/zoneinfo/Asia/Shanghai:/etc/localtime -p 6379:6379 redis:5-alpine redis-servver</code></pre><h4 id="ä½¿ç”¨çš„åº“"><a href="#ä½¿ç”¨çš„åº“" class="headerlink" title="ä½¿ç”¨çš„åº“"></a>ä½¿ç”¨çš„åº“</h4><p><a href="https://github.com/go-redis/redis" target="_blank" rel="noopener">https://github.com/go-redis/redis</a></p><pre class=" language-shell"><code class="language-shell">go get github.com/go-redis/redis/v8</code></pre><h5 id="Quickstart"><a href="#Quickstart" class="headerlink" title="Quickstart"></a>Quickstart</h5><pre class=" language-go"><code class="language-go"><span class="token keyword">import</span> <span class="token punctuation">(</span>    <span class="token string">"context"</span>    <span class="token string">"github.com/go-redis/redis/v8"</span><span class="token punctuation">)</span><span class="token keyword">var</span> ctx <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">ExampleClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    rdb <span class="token operator">:=</span> redis<span class="token punctuation">.</span><span class="token function">NewClient</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>redis<span class="token punctuation">.</span>Options<span class="token punctuation">{</span>        Addr<span class="token punctuation">:</span>     <span class="token string">"localhost:6379"</span><span class="token punctuation">,</span>        Password<span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// no password set</span>        DB<span class="token punctuation">:</span>       <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">// use default DB</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>    err <span class="token operator">:=</span> rdb<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"key"</span><span class="token punctuation">,</span> <span class="token string">"value"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    val<span class="token punctuation">,</span> err <span class="token operator">:=</span> rdb<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"key"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Result</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"key"</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span>    val2<span class="token punctuation">,</span> err <span class="token operator">:=</span> rdb<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"key2"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Result</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">==</span> redis<span class="token punctuation">.</span>Nil <span class="token punctuation">{</span>        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"key2 does not exist"</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"key2"</span><span class="token punctuation">,</span> val2<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// Output: key value</span>    <span class="token comment" spellcheck="true">// key2 does not exist</span><span class="token punctuation">}</span></code></pre><h5 id="Look-and-feel"><a href="#Look-and-feel" class="headerlink" title="Look and feel"></a>Look and feel</h5><p>Some corner cases:</p><pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// SET key value EX 10 NX</span>set<span class="token punctuation">,</span> err <span class="token operator">:=</span> rdb<span class="token punctuation">.</span><span class="token function">SetNX</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"key"</span><span class="token punctuation">,</span> <span class="token string">"value"</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token operator">*</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Result</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">// SET key value keepttl NX</span>set<span class="token punctuation">,</span> err <span class="token operator">:=</span> rdb<span class="token punctuation">.</span><span class="token function">SetNX</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"key"</span><span class="token punctuation">,</span> <span class="token string">"value"</span><span class="token punctuation">,</span> redis<span class="token punctuation">.</span>KeepTTL<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Result</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">// SORT list LIMIT 0 2 ASC</span>vals<span class="token punctuation">,</span> err <span class="token operator">:=</span> rdb<span class="token punctuation">.</span><span class="token function">Sort</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>redis<span class="token punctuation">.</span>Sort<span class="token punctuation">{</span>Offset<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> Count<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> Order<span class="token punctuation">:</span> <span class="token string">"ASC"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Result</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">// ZRANGEBYSCORE zset -inf +inf WITHSCORES LIMIT 0 2</span>vals<span class="token punctuation">,</span> err <span class="token operator">:=</span> rdb<span class="token punctuation">.</span><span class="token function">ZRangeByScoreWithScores</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"zset"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>redis<span class="token punctuation">.</span>ZRangeBy<span class="token punctuation">{</span>    Min<span class="token punctuation">:</span> <span class="token string">"-inf"</span><span class="token punctuation">,</span>    Max<span class="token punctuation">:</span> <span class="token string">"+inf"</span><span class="token punctuation">,</span>    Offset<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>    Count<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Result</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">// ZINTERSTORE out 2 zset1 zset2 WEIGHTS 2 3 AGGREGATE SUM</span>vals<span class="token punctuation">,</span> err <span class="token operator">:=</span> rdb<span class="token punctuation">.</span><span class="token function">ZInterStore</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"out"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>redis<span class="token punctuation">.</span>ZStore<span class="token punctuation">{</span>    Keys<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">"zset1"</span><span class="token punctuation">,</span> <span class="token string">"zset2"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>    Weights<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int64</span><span class="token punctuation">{</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Result</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">// EVAL "return {KEYS[1],ARGV[1]}" 1 "key" "hello"</span>vals<span class="token punctuation">,</span> err <span class="token operator">:=</span> rdb<span class="token punctuation">.</span><span class="token function">Eval</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"return {KEYS[1],ARGV[1]}"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">"key"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">"hello"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Result</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">// custom command</span>res<span class="token punctuation">,</span> err <span class="token operator">:=</span> rdb<span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"set"</span><span class="token punctuation">,</span> <span class="token string">"key"</span><span class="token punctuation">,</span> <span class="token string">"value"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Result</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><h6 id="å¸¸ç”¨ç±»å‹"><a href="#å¸¸ç”¨ç±»å‹" class="headerlink" title="å¸¸ç”¨ç±»å‹"></a>å¸¸ç”¨ç±»å‹</h6><table><thead><tr><th><strong>ç±»å‹</strong></th><th><strong>å°è£…ç±»å</strong></th></tr></thead><tbody><tr><td>String ï¼ˆå­—ç¬¦ä¸²ï¼‰</td><td>StringOperation</td></tr><tr><td>Hashï¼ˆå“ˆå¸Œï¼‰</td><td>HashOperation</td></tr><tr><td>List ï¼ˆåˆ—è¡¨ï¼‰</td><td>ListOperation</td></tr><tr><td>Set ï¼ˆé›†åˆï¼‰</td><td>SetOperation</td></tr><tr><td>Zsetï¼ˆæœ‰åºé›†åˆ)</td><td>ZSetOperation</td></tr></tbody></table>]]></content>
      
      
      <categories>
          
          <category> Go </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Go </tag>
            
            <tag> Redis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Go-å•ä¾‹æ¨¡å¼</title>
      <link href="2020/10/22/devops/golang/go-dan-li-mo-shi/"/>
      <url>2020/10/22/devops/golang/go-dan-li-mo-shi/</url>
      
        <content type="html"><![CDATA[<h3 id="å•ä¾‹æ¨¡å¼"><a href="#å•ä¾‹æ¨¡å¼" class="headerlink" title="å•ä¾‹æ¨¡å¼"></a>å•ä¾‹æ¨¡å¼</h3><pre class=" language-go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span>    <span class="token string">"fmt"</span>    <span class="token string">"sync"</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">//å•ä¾‹æ¨¡å¼</span><span class="token keyword">type</span> WebConfig <span class="token keyword">struct</span> <span class="token punctuation">{</span>    Port <span class="token builtin">int</span><span class="token punctuation">}</span><span class="token keyword">var</span> cc <span class="token operator">*</span>WebConfig<span class="token keyword">var</span> once sync<span class="token punctuation">.</span>Once<span class="token keyword">func</span> <span class="token function">GetConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>WebConfig <span class="token punctuation">{</span>    once<span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        cc <span class="token operator">=</span> <span class="token operator">&amp;</span>WebConfig<span class="token punctuation">{</span>Port<span class="token punctuation">:</span> <span class="token number">8080</span><span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> cc<span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    c <span class="token operator">:=</span> <span class="token function">GetConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    c2 <span class="token operator">:=</span> <span class="token function">GetConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    c<span class="token punctuation">.</span>Port <span class="token operator">=</span> <span class="token number">9090</span>    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>c2<span class="token punctuation">,</span> c <span class="token operator">==</span> c2<span class="token punctuation">)</span><span class="token punctuation">}</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Go </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Go </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kubernetes-Pod-ç”Ÿå‘½å‘¨æœŸ</title>
      <link href="2020/10/06/rong-qi/kubernetes-gong-zuo-fu-zai-pod-de-sheng-ming-zhou-qi/"/>
      <url>2020/10/06/rong-qi/kubernetes-gong-zuo-fu-zai-pod-de-sheng-ming-zhou-qi/</url>
      
        <content type="html"><![CDATA[<h1 id="Pod-çš„ç”Ÿå‘½å‘¨æœŸ"><a href="#Pod-çš„ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="Pod çš„ç”Ÿå‘½å‘¨æœŸ"></a>Pod çš„ç”Ÿå‘½å‘¨æœŸ</h1><p>æœ¬é¡µé¢è®²è¿° Pod çš„ç”Ÿå‘½å‘¨æœŸã€‚ Pod éµå¾ªä¸€ä¸ªé¢„å®šä¹‰çš„ç”Ÿå‘½å‘¨æœŸï¼Œèµ·å§‹äº <code>Pending</code> <a href="https://kubernetes.io/zh/docs/concepts/workloads/pods/pod-lifecycle/#pod-phase" target="_blank" rel="noopener">é˜¶æ®µ</a>ï¼Œå¦‚æœè‡³å°‘ å…¶ä¸­æœ‰ä¸€ä¸ªä¸»è¦å®¹å™¨æ­£å¸¸å¯åŠ¨ï¼Œåˆ™è¿›å…¥ <code>Running</code>ï¼Œä¹‹åå–å†³äº Pod ä¸­æ˜¯å¦æœ‰å®¹å™¨ä»¥ å¤±è´¥çŠ¶æ€ç»“æŸè€Œè¿›å…¥ <code>Succeeded</code> æˆ–è€… <code>Failed</code> é˜¶æ®µã€‚</p><p>åœ¨ Pod è¿è¡ŒæœŸé—´ï¼Œ<code>kubelet</code> èƒ½å¤Ÿé‡å¯å®¹å™¨ä»¥å¤„ç†ä¸€äº›å¤±æ•ˆåœºæ™¯ã€‚ åœ¨ Pod å†…éƒ¨ï¼ŒKubernetes è·Ÿè¸ªä¸åŒå®¹å™¨çš„<a href="https://kubernetes.io/zh/docs/concepts/workloads/pods/pod-lifecycle/#container-states" target="_blank" rel="noopener">çŠ¶æ€</a> å¹¶å¤„ç†å¯èƒ½å‡ºç°çš„çŠ¶å†µã€‚</p><p>åœ¨ Kubernetes API ä¸­ï¼ŒPod åŒ…å«è§„çº¦éƒ¨åˆ†å’Œå®é™…çŠ¶æ€éƒ¨åˆ†ã€‚ Pod å¯¹è±¡çš„çŠ¶æ€åŒ…å«äº†ä¸€ç»„ <a href="https://kubernetes.io/zh/docs/concepts/workloads/pods/pod-lifecycle/#pod-conditions" target="_blank" rel="noopener">Pod çŠ¶å†µï¼ˆConditionsï¼‰</a>ã€‚ å¦‚æœåº”ç”¨éœ€è¦çš„è¯ï¼Œä½ ä¹Ÿå¯ä»¥å‘å…¶ä¸­æ³¨å…¥<a href="https://kubernetes.io/zh/docs/concepts/workloads/pods/pod-lifecycle/#pod-readiness-gate" target="_blank" rel="noopener">è‡ªå®šä¹‰çš„å°±ç»ªæ€§ä¿¡æ¯</a>ã€‚</p><p>Pod åœ¨å…¶ç”Ÿå‘½å‘¨æœŸä¸­åªä¼šè¢«<a href="https://kubernetes.io/zh/docs/concepts/scheduling-eviction/" target="_blank" rel="noopener">è°ƒåº¦</a>ä¸€æ¬¡ã€‚ ä¸€æ—¦ Pod è¢«è°ƒåº¦ï¼ˆåˆ†æ´¾ï¼‰åˆ°æŸä¸ªèŠ‚ç‚¹ï¼ŒPod ä¼šä¸€ç›´åœ¨è¯¥èŠ‚ç‚¹è¿è¡Œï¼Œç›´åˆ° Pod åœæ­¢æˆ–è€… è¢«<a href="https://kubernetes.io/zh/docs/concepts/workloads/pods/pod-lifecycle/#pod-termination" target="_blank" rel="noopener">ç»ˆæ­¢</a>ã€‚</p><h2 id="Pod-ç”Ÿå‘½æœŸ"><a href="#Pod-ç”Ÿå‘½æœŸ" class="headerlink" title="Pod ç”Ÿå‘½æœŸ"></a>Pod ç”Ÿå‘½æœŸ</h2><p>å’Œä¸€ä¸ªä¸ªç‹¬ç«‹çš„åº”ç”¨å®¹å™¨ä¸€æ ·ï¼ŒPod ä¹Ÿè¢«è®¤ä¸ºæ˜¯ç›¸å¯¹ä¸´æ—¶æ€§ï¼ˆè€Œä¸æ˜¯é•¿æœŸå­˜åœ¨ï¼‰çš„å®ä½“ã€‚ Pod ä¼šè¢«åˆ›å»ºã€èµ‹äºˆä¸€ä¸ªå”¯ä¸€çš„ IDï¼ˆ<a href="https://kubernetes.io/zh/docs/concepts/overview/working-with-objects/names/#uids" target="_blank" rel="noopener">UID</a>ï¼‰ï¼Œ å¹¶è¢«è°ƒåº¦åˆ°èŠ‚ç‚¹ï¼Œå¹¶åœ¨ç»ˆæ­¢ï¼ˆæ ¹æ®é‡å¯ç­–ç•¥ï¼‰æˆ–åˆ é™¤ä¹‹å‰ä¸€ç›´è¿è¡Œåœ¨è¯¥èŠ‚ç‚¹ã€‚</p><p>å¦‚æœä¸€ä¸ª<a href="https://kubernetes.io/zh/docs/concepts/architecture/nodes/" target="_blank" rel="noopener">èŠ‚ç‚¹</a>æ­»æ‰äº†ï¼Œè°ƒåº¦åˆ°è¯¥èŠ‚ç‚¹ çš„ Pod ä¹Ÿè¢«è®¡åˆ’åœ¨ç»™å®šè¶…æ—¶æœŸé™ç»“æŸå<a href="https://kubernetes.io/zh/docs/concepts/workloads/pods/pod-lifecycle/#pod-garbage-collection" target="_blank" rel="noopener">åˆ é™¤</a>ã€‚</p><p>Pod è‡ªèº«ä¸å…·æœ‰è‡ªæ„ˆèƒ½åŠ›ã€‚å¦‚æœ Pod è¢«è°ƒåº¦åˆ°æŸ<a href="https://kubernetes.io/zh/docs/concepts/architecture/nodes/" target="_blank" rel="noopener">èŠ‚ç‚¹</a> è€Œè¯¥èŠ‚ç‚¹ä¹‹åå¤±æ•ˆï¼Œæˆ–è€…è°ƒåº¦æ“ä½œæœ¬èº«å¤±æ•ˆï¼ŒPod ä¼šè¢«åˆ é™¤ï¼›ä¸æ­¤ç±»ä¼¼ï¼ŒPod æ— æ³•åœ¨èŠ‚ç‚¹èµ„æº è€—å°½æˆ–è€…èŠ‚ç‚¹ç»´æŠ¤æœŸé—´ç»§ç»­å­˜æ´»ã€‚Kubernetes ä½¿ç”¨ä¸€ç§é«˜çº§æŠ½è±¡ï¼Œç§°ä½œ <a href="https://kubernetes.io/docs/admin/kube-controller-manager/" target="_blank" rel="noopener">æ§åˆ¶å™¨</a>ï¼Œæ¥ç®¡ç†è¿™äº›ç›¸å¯¹è€Œè¨€ å¯éšæ—¶ä¸¢å¼ƒçš„ Pod å®ä¾‹ã€‚</p><p>ä»»ä½•ç»™å®šçš„ Pod ï¼ˆç”± UID å®šä¹‰ï¼‰ä»ä¸ä¼šè¢«â€œé‡æ–°è°ƒåº¦ï¼ˆrescheduledï¼‰â€åˆ°ä¸åŒçš„èŠ‚ç‚¹ï¼› ç›¸åï¼Œè¿™ä¸€ Pod å¯ä»¥è¢«ä¸€ä¸ªæ–°çš„ã€å‡ ä¹å®Œå…¨ç›¸åŒçš„ Pod æ›¿æ¢æ‰ã€‚ å¦‚æœéœ€è¦ï¼Œæ–° Pod çš„åå­—å¯ä»¥ä¸å˜ï¼Œä½†æ˜¯å…¶ UID ä¼šä¸åŒã€‚</p><p>å¦‚æœæŸç‰©å£°ç§°å…¶ç”Ÿå‘½æœŸä¸æŸ Pod ç›¸åŒï¼Œä¾‹å¦‚å­˜å‚¨<a href="https://kubernetes.io/zh/docs/concepts/storage/volumes/" target="_blank" rel="noopener">å·</a>ï¼Œ è¿™å°±æ„å‘³ç€è¯¥å¯¹è±¡åœ¨æ­¤ Pod ï¼ˆUID äº¦ç›¸åŒï¼‰å­˜åœ¨æœŸé—´ä¹Ÿä¸€ç›´å­˜åœ¨ã€‚ å¦‚æœ Pod å› ä¸ºä»»ä½•åŸå› è¢«åˆ é™¤ï¼Œç”šè‡³æŸå®Œå…¨ç›¸åŒçš„æ›¿ä»£ Pod è¢«åˆ›å»ºæ—¶ï¼Œ è¿™ä¸ªç›¸å…³çš„å¯¹è±¡ï¼ˆä¾‹å¦‚è¿™é‡Œçš„å·ï¼‰ä¹Ÿä¼šè¢«åˆ é™¤å¹¶é‡å»ºã€‚</p><p><img src="https://d33wubrfki0l68.cloudfront.net/aecab1f649bc640ebef1f05581bfcc91a48038c4/728d6/images/docs/pod.svg" alt="img">Pod ç»“æ„å›¾ä¾‹</p><p><em>ä¸€ä¸ªåŒ…å«å¤šä¸ªå®¹å™¨çš„ Pod ä¸­åŒ…å«ä¸€ä¸ªç”¨æ¥æ‹‰å–æ–‡ä»¶çš„ç¨‹åºå’Œä¸€ä¸ª Web æœåŠ¡å™¨ï¼Œ å‡ä½¿ç”¨æŒä¹…å·ä½œä¸ºå®¹å™¨é—´å…±äº«çš„å­˜å‚¨ã€‚</em></p><h2 id="Pod-é˜¶æ®µ"><a href="#Pod-é˜¶æ®µ" class="headerlink" title="Pod é˜¶æ®µ"></a>Pod é˜¶æ®µ</h2><p>Pod çš„ <code>status</code> å­—æ®µæ˜¯ä¸€ä¸ª <a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#podstatus-v1-core" target="_blank" rel="noopener">PodStatus</a> å¯¹è±¡ï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ª <code>phase</code> å­—æ®µã€‚</p><p>Pod çš„é˜¶æ®µï¼ˆPhaseï¼‰æ˜¯ Pod åœ¨å…¶ç”Ÿå‘½å‘¨æœŸä¸­æ‰€å¤„ä½ç½®çš„ç®€å•å®è§‚æ¦‚è¿°ã€‚ è¯¥é˜¶æ®µå¹¶ä¸æ˜¯å¯¹å®¹å™¨æˆ– Pod çŠ¶æ€çš„ç»¼åˆæ±‡æ€»ï¼Œä¹Ÿä¸æ˜¯ä¸ºäº†æˆä¸ºå®Œæ•´çš„çŠ¶æ€æœºã€‚</p><p>Pod é˜¶æ®µçš„æ•°é‡å’Œå«ä¹‰æ˜¯ä¸¥æ ¼å®šä¹‰çš„ã€‚ é™¤äº†æœ¬æ–‡æ¡£ä¸­åˆ—ä¸¾çš„å†…å®¹å¤–ï¼Œä¸åº”è¯¥å†å‡å®š Pod æœ‰å…¶ä»–çš„ <code>phase</code> å€¼ã€‚</p><p>ä¸‹é¢æ˜¯ <code>phase</code> å¯èƒ½çš„å€¼ï¼š</p><table><thead><tr><th>å–å€¼</th><th>æè¿°</th></tr></thead><tbody><tr><td><code>Pending</code>ï¼ˆæ‚¬å†³ï¼‰</td><td>Pod å·²è¢« Kubernetes ç³»ç»Ÿæ¥å—ï¼Œä½†æœ‰ä¸€ä¸ªæˆ–è€…å¤šä¸ªå®¹å™¨å°šæœªåˆ›å»ºäº¦æœªè¿è¡Œã€‚æ­¤é˜¶æ®µåŒ…æ‹¬ç­‰å¾… Pod è¢«è°ƒåº¦çš„æ—¶é—´å’Œé€šè¿‡ç½‘ç»œä¸‹è½½é•œåƒçš„æ—¶é—´ï¼Œ</td></tr><tr><td><code>Running</code>ï¼ˆè¿è¡Œä¸­ï¼‰</td><td>Pod å·²ç»ç»‘å®šåˆ°äº†æŸä¸ªèŠ‚ç‚¹ï¼ŒPod ä¸­æ‰€æœ‰çš„å®¹å™¨éƒ½å·²è¢«åˆ›å»ºã€‚è‡³å°‘æœ‰ä¸€ä¸ªå®¹å™¨ä»åœ¨è¿è¡Œï¼Œæˆ–è€…æ­£å¤„äºå¯åŠ¨æˆ–é‡å¯çŠ¶æ€ã€‚</td></tr><tr><td><code>Succeeded</code>ï¼ˆæˆåŠŸï¼‰</td><td>Pod ä¸­çš„æ‰€æœ‰å®¹å™¨éƒ½å·²æˆåŠŸç»ˆæ­¢ï¼Œå¹¶ä¸”ä¸ä¼šå†é‡å¯ã€‚</td></tr><tr><td><code>Failed</code>ï¼ˆå¤±è´¥ï¼‰</td><td>Pod ä¸­çš„æ‰€æœ‰å®¹å™¨éƒ½å·²ç»ˆæ­¢ï¼Œå¹¶ä¸”è‡³å°‘æœ‰ä¸€ä¸ªå®¹å™¨æ˜¯å› ä¸ºå¤±è´¥ç»ˆæ­¢ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå®¹å™¨ä»¥é 0 çŠ¶æ€é€€å‡ºæˆ–è€…è¢«ç³»ç»Ÿç»ˆæ­¢ã€‚</td></tr><tr><td><code>Unknown</code>ï¼ˆæœªçŸ¥ï¼‰</td><td>å› ä¸ºæŸäº›åŸå› æ— æ³•å–å¾— Pod çš„çŠ¶æ€ã€‚è¿™ç§æƒ…å†µé€šå¸¸æ˜¯å› ä¸ºä¸ Pod æ‰€åœ¨ä¸»æœºé€šä¿¡å¤±è´¥ã€‚</td></tr></tbody></table><p>å¦‚æœæŸèŠ‚ç‚¹æ­»æ‰æˆ–è€…ä¸é›†ç¾¤ä¸­å…¶ä»–èŠ‚ç‚¹å¤±è”ï¼ŒKubernetes ä¼šå®æ–½ä¸€ç§ç­–ç•¥ï¼Œå°†å¤±å»çš„èŠ‚ç‚¹ä¸Šè¿è¡Œçš„æ‰€æœ‰ Pod çš„ <code>phase</code> è®¾ç½®ä¸º <code>Failed</code>ã€‚</p><h2 id="å®¹å™¨çŠ¶æ€"><a href="#å®¹å™¨çŠ¶æ€" class="headerlink" title="å®¹å™¨çŠ¶æ€"></a>å®¹å™¨çŠ¶æ€</h2><p>Kubernetes ä¼šè·Ÿè¸ª Pod ä¸­æ¯ä¸ªå®¹å™¨çš„çŠ¶æ€ï¼Œå°±åƒå®ƒè·Ÿè¸ª Pod æ€»ä½“ä¸Šçš„<a href="https://kubernetes.io/zh/docs/concepts/workloads/pods/pod-lifecycle/#pod-phase" target="_blank" rel="noopener">é˜¶æ®µ</a>ä¸€æ ·ã€‚ ä½ å¯ä»¥ä½¿ç”¨<a href="https://kubernetes.io/zh/docs/concepts/containers/container-lifecycle-hooks/" target="_blank" rel="noopener">å®¹å™¨ç”Ÿå‘½å‘¨æœŸå›è°ƒ</a> æ¥åœ¨å®¹å™¨ç”Ÿå‘½å‘¨æœŸä¸­çš„ç‰¹å®šæ—¶é—´ç‚¹è§¦å‘äº‹ä»¶ã€‚</p><p>ä¸€æ—¦<a href="https://kubernetes.io/docs/reference/generated/kube-scheduler/" target="_blank" rel="noopener">è°ƒåº¦å™¨</a>å°† Pod åˆ†æ´¾ç»™æŸä¸ªèŠ‚ç‚¹ï¼Œ<code>kubelet</code> å°±é€šè¿‡ <a href="https://kubernetes.io/docs/reference/generated/container-runtime" target="_blank" rel="noopener">å®¹å™¨è¿è¡Œæ—¶</a> å¼€å§‹ä¸º Pod åˆ›å»ºå®¹å™¨ã€‚ å®¹å™¨çš„çŠ¶æ€æœ‰ä¸‰ç§ï¼š<code>Waiting</code>ï¼ˆç­‰å¾…ï¼‰ã€<code>Running</code>ï¼ˆè¿è¡Œä¸­ï¼‰å’Œ <code>Terminated</code>ï¼ˆå·²ç»ˆæ­¢ï¼‰ã€‚</p><p>è¦æ£€æŸ¥ Pod ä¸­å®¹å™¨çš„çŠ¶æ€ï¼Œä½ å¯ä»¥ä½¿ç”¨ <code>kubectl describe pod &lt;pod åç§°&gt;</code>ã€‚ å…¶è¾“å‡ºä¸­åŒ…å« Pod ä¸­æ¯ä¸ªå®¹å™¨çš„çŠ¶æ€ã€‚</p><p>æ¯ç§çŠ¶æ€éƒ½æœ‰ç‰¹å®šçš„å«ä¹‰ï¼š</p><h3 id="Waiting-ï¼ˆç­‰å¾…ï¼‰"><a href="#Waiting-ï¼ˆç­‰å¾…ï¼‰" class="headerlink" title="Waiting ï¼ˆç­‰å¾…ï¼‰"></a><code>Waiting</code> ï¼ˆç­‰å¾…ï¼‰</h3><p>å¦‚æœå®¹å™¨å¹¶ä¸å¤„åœ¨ <code>Running</code> æˆ– <code>Terminated</code> çŠ¶æ€ä¹‹ä¸€ï¼Œå®ƒå°±å¤„åœ¨ <code>Waiting</code> çŠ¶æ€ã€‚ å¤„äº <code>Waiting</code> çŠ¶æ€çš„å®¹å™¨ä»åœ¨è¿è¡Œå®ƒå®Œæˆå¯åŠ¨æ‰€éœ€è¦çš„æ“ä½œï¼šä¾‹å¦‚ï¼Œä»æŸä¸ªå®¹å™¨é•œåƒ ä»“åº“æ‹‰å–å®¹å™¨é•œåƒï¼Œæˆ–è€…å‘å®¹å™¨åº”ç”¨ <a href="https://kubernetes.io/zh/docs/concepts/configuration/secret/" target="_blank" rel="noopener">Secret</a> æ•°æ®ç­‰ç­‰ã€‚ å½“ä½ ä½¿ç”¨ <code>kubectl</code> æ¥æŸ¥è¯¢åŒ…å« <code>Waiting</code> çŠ¶æ€çš„å®¹å™¨çš„ Pod æ—¶ï¼Œä½ ä¹Ÿä¼šçœ‹åˆ°ä¸€ä¸ª Reason å­—æ®µï¼Œå…¶ä¸­ç»™å‡ºäº†å®¹å™¨å¤„äºç­‰å¾…çŠ¶æ€çš„åŸå› ã€‚</p><h3 id="Runningï¼ˆè¿è¡Œä¸­ï¼‰"><a href="#Runningï¼ˆè¿è¡Œä¸­ï¼‰" class="headerlink" title="Runningï¼ˆè¿è¡Œä¸­ï¼‰"></a><code>Running</code>ï¼ˆè¿è¡Œä¸­ï¼‰</h3><p><code>Running</code> çŠ¶æ€è¡¨æ˜å®¹å™¨æ­£åœ¨æ‰§è¡ŒçŠ¶æ€å¹¶ä¸”æ²¡æœ‰é—®é¢˜å‘ç”Ÿã€‚ å¦‚æœé…ç½®äº† <code>postStart</code> å›è°ƒï¼Œé‚£ä¹ˆè¯¥å›è°ƒå·²ç»æ‰§è¡Œå®Œæˆã€‚ å¦‚æœä½ ä½¿ç”¨ <code>kubectl</code> æ¥æŸ¥è¯¢åŒ…å« <code>Running</code> çŠ¶æ€çš„å®¹å™¨çš„ Pod æ—¶ï¼Œä½ ä¹Ÿä¼šçœ‹åˆ° å…³äºå®¹å™¨è¿›å…¥ <code>Running</code> çŠ¶æ€çš„ä¿¡æ¯ã€‚</p><h3 id="Terminatedï¼ˆå·²ç»ˆæ­¢ï¼‰"><a href="#Terminatedï¼ˆå·²ç»ˆæ­¢ï¼‰" class="headerlink" title="Terminatedï¼ˆå·²ç»ˆæ­¢ï¼‰"></a><code>Terminated</code>ï¼ˆå·²ç»ˆæ­¢ï¼‰</h3><p>å¤„äº <code>Terminated</code> çŠ¶æ€çš„å®¹å™¨å·²ç»å¼€å§‹æ‰§è¡Œå¹¶ä¸”æˆ–è€…æ­£å¸¸ç»“æŸæˆ–è€…å› ä¸ºæŸäº›åŸå› å¤±è´¥ã€‚ å¦‚æœä½ ä½¿ç”¨ <code>kubectl</code> æ¥æŸ¥è¯¢åŒ…å« <code>Terminated</code> çŠ¶æ€çš„å®¹å™¨çš„ Pod æ—¶ï¼Œä½ ä¼šçœ‹åˆ° å®¹å™¨è¿›å…¥æ­¤çŠ¶æ€çš„åŸå› ã€é€€å‡ºä»£ç ä»¥åŠå®¹å™¨æ‰§è¡ŒæœŸé—´çš„èµ·æ­¢æ—¶é—´ã€‚</p><p>å¦‚æœå®¹å™¨é…ç½®äº† <code>preStop</code> å›è°ƒï¼Œåˆ™è¯¥å›è°ƒä¼šåœ¨å®¹å™¨è¿›å…¥ <code>Terminated</code> çŠ¶æ€ä¹‹å‰æ‰§è¡Œã€‚</p><h2 id="å®¹å™¨é‡å¯ç­–ç•¥"><a href="#å®¹å™¨é‡å¯ç­–ç•¥" class="headerlink" title="å®¹å™¨é‡å¯ç­–ç•¥"></a>å®¹å™¨é‡å¯ç­–ç•¥</h2><p>Pod çš„ <code>spec</code> ä¸­åŒ…å«ä¸€ä¸ª <code>restartPolicy</code> å­—æ®µï¼Œå…¶å¯èƒ½å–å€¼åŒ…æ‹¬ Alwaysã€OnFailure å’Œ Neverã€‚é»˜è®¤å€¼æ˜¯ Alwaysã€‚</p><p><code>restartPolicy</code> é€‚ç”¨äº Pod ä¸­çš„æ‰€æœ‰å®¹å™¨ã€‚<code>restartPolicy</code> ä»…é’ˆå¯¹åŒä¸€èŠ‚ç‚¹ä¸Š <code>kubelet</code> çš„å®¹å™¨é‡å¯åŠ¨ä½œã€‚å½“ Pod ä¸­çš„å®¹å™¨é€€å‡ºæ—¶ï¼Œ<code>kubelet</code> ä¼šæŒ‰æŒ‡æ•°å›é€€ æ–¹å¼è®¡ç®—é‡å¯çš„å»¶è¿Ÿï¼ˆ10sã€20sã€40sã€â€¦ï¼‰ï¼Œå…¶æœ€é•¿å»¶è¿Ÿä¸º 5 åˆ†é’Ÿã€‚ ä¸€æ—¦æŸå®¹å™¨æ‰§è¡Œäº† 10 åˆ†é’Ÿå¹¶ä¸”æ²¡æœ‰å‡ºç°é—®é¢˜ï¼Œ<code>kubelet</code> å¯¹è¯¥å®¹å™¨çš„é‡å¯å›é€€è®¡æ—¶å™¨æ‰§è¡Œ é‡ç½®æ“ä½œã€‚</p><h2 id="Pod-çŠ¶å†µ"><a href="#Pod-çŠ¶å†µ" class="headerlink" title="Pod çŠ¶å†µ"></a>Pod çŠ¶å†µ</h2><p>Pod æœ‰ä¸€ä¸ª PodStatus å¯¹è±¡ï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ª <a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#podcondition-v1-core" target="_blank" rel="noopener">PodConditions</a> æ•°ç»„ã€‚Pod å¯èƒ½é€šè¿‡ä¹Ÿå¯èƒ½æœªé€šè¿‡å…¶ä¸­çš„ä¸€äº›çŠ¶å†µæµ‹è¯•ã€‚</p><ul><li><code>PodScheduled</code>ï¼šPod å·²ç»è¢«è°ƒåº¦åˆ°æŸèŠ‚ç‚¹ï¼›</li><li><code>ContainersReady</code>ï¼šPod ä¸­æ‰€æœ‰å®¹å™¨éƒ½å·²å°±ç»ªï¼›</li><li><code>Initialized</code>ï¼šæ‰€æœ‰çš„ <a href="https://kubernetes.io/zh/docs/concepts/workloads/pods/init-containers/" target="_blank" rel="noopener">Init å®¹å™¨</a> éƒ½å·²æˆåŠŸå¯åŠ¨ï¼›</li><li><code>Ready</code>ï¼šPod å¯ä»¥ä¸ºè¯·æ±‚æä¾›æœåŠ¡ï¼Œå¹¶ä¸”åº”è¯¥è¢«æ·»åŠ åˆ°å¯¹åº”æœåŠ¡çš„è´Ÿè½½å‡è¡¡æ± ä¸­ã€‚</li></ul><table><thead><tr><th>å­—æ®µåç§°</th><th>æè¿°</th></tr></thead><tbody><tr><td><code>type</code></td><td>Pod çŠ¶å†µçš„åç§°</td></tr><tr><td><code>status</code></td><td>è¡¨æ˜è¯¥çŠ¶å†µæ˜¯å¦é€‚ç”¨ï¼Œå¯èƒ½çš„å–å€¼æœ‰ â€œ<code>True</code>â€œ, â€œ<code>False</code>â€œ æˆ– â€œ<code>Unknown</code>â€œ</td></tr><tr><td><code>lastProbeTime</code></td><td>ä¸Šæ¬¡æ¢æµ‹ Pod çŠ¶å†µæ—¶çš„æ—¶é—´æˆ³</td></tr><tr><td><code>lastTransitionTime</code></td><td>Pod ä¸Šæ¬¡ä»ä¸€ç§çŠ¶æ€è½¬æ¢åˆ°å¦ä¸€ç§çŠ¶æ€æ—¶çš„æ—¶é—´æˆ³</td></tr><tr><td><code>reason</code></td><td>æœºå™¨å¯è¯»çš„ã€é©¼å³°ç¼–ç ï¼ˆUpperCamelCaseï¼‰çš„æ–‡å­—ï¼Œè¡¨è¿°ä¸Šæ¬¡çŠ¶å†µå˜åŒ–çš„åŸå› </td></tr><tr><td><code>message</code></td><td>äººç±»å¯è¯»çš„æ¶ˆæ¯ï¼Œç»™å‡ºä¸Šæ¬¡çŠ¶æ€è½¬æ¢çš„è¯¦ç»†ä¿¡æ¯</td></tr></tbody></table><h3 id="Pod-å°±ç»ªæ€"><a href="#Pod-å°±ç»ªæ€" class="headerlink" title="Pod å°±ç»ªæ€"></a>Pod å°±ç»ªæ€</h3><p><strong>FEATURE STATE:</strong> <code>Kubernetes v1.14 [stable]</code></p><p>ä½ çš„åº”ç”¨å¯ä»¥å‘ PodStatus ä¸­æ³¨å…¥é¢å¤–çš„åé¦ˆæˆ–è€…ä¿¡å·ï¼š<em>Pod Readinessï¼ˆPod å°±ç»ªæ€ï¼‰</em>ã€‚ è¦ä½¿ç”¨è¿™ä¸€ç‰¹æ€§ï¼Œå¯ä»¥è®¾ç½® Pod è§„çº¦ä¸­çš„ <code>readinessGates</code> åˆ—è¡¨ï¼Œä¸º kubelet æä¾›ä¸€ç»„é¢å¤–çš„çŠ¶å†µä¾›å…¶è¯„ä¼° Pod å°±ç»ªæ€æ—¶ä½¿ç”¨ã€‚</p><p>å°±ç»ªæ€é—¨æ§åŸºäº Pod çš„ <code>status.conditions</code> å­—æ®µçš„å½“å‰å€¼æ¥åšå†³å®šã€‚ å¦‚æœ Kubernetes æ— æ³•åœ¨ <code>status.conditions</code> å­—æ®µä¸­æ‰¾åˆ°æŸçŠ¶å†µï¼Œåˆ™è¯¥çŠ¶å†µçš„ çŠ¶æ€å€¼é»˜è®¤ä¸º â€œ<code>False</code>â€œã€‚</p><p>è¿™é‡Œæ˜¯ä¸€ä¸ªä¾‹å­ï¼š</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod<span class="token punctuation">...</span><span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">readinessGates</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">conditionType</span><span class="token punctuation">:</span> <span class="token string">"www.example.com/feature-1"</span><span class="token key atrule">status</span><span class="token punctuation">:</span>  <span class="token key atrule">conditions</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> Ready                              <span class="token comment" spellcheck="true"># å†…ç½®çš„ Pod çŠ¶å†µ</span>      <span class="token key atrule">status</span><span class="token punctuation">:</span> <span class="token string">"False"</span>      <span class="token key atrule">lastProbeTime</span><span class="token punctuation">:</span> <span class="token null important">null</span>      <span class="token key atrule">lastTransitionTime</span><span class="token punctuation">:</span> <span class="token datetime number">2018-01-01T00:00:00Z</span>    <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> <span class="token string">"www.example.com/feature-1"</span>        <span class="token comment" spellcheck="true"># é¢å¤–çš„ Pod çŠ¶å†µ</span>      <span class="token key atrule">status</span><span class="token punctuation">:</span> <span class="token string">"False"</span>      <span class="token key atrule">lastProbeTime</span><span class="token punctuation">:</span> <span class="token null important">null</span>      <span class="token key atrule">lastTransitionTime</span><span class="token punctuation">:</span> <span class="token datetime number">2018-01-01T00:00:00Z</span>  <span class="token key atrule">containerStatuses</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">containerID</span><span class="token punctuation">:</span> docker<span class="token punctuation">:</span>//abcd<span class="token punctuation">...</span>      <span class="token key atrule">ready</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span class="token punctuation">...</span></code></pre><p>ä½ æ‰€æ·»åŠ çš„ Pod çŠ¶å†µåç§°å¿…é¡»æ»¡è¶³ Kubernetes <a href="https://kubernetes.io/zh/docs/concepts/overview/working-with-objects/labels/#syntax-and-character-set" target="_blank" rel="noopener">æ ‡ç­¾é”®åæ ¼å¼</a>ã€‚</p><h3 id="Pod-å°±ç»ªæ€çš„çŠ¶æ€"><a href="#Pod-å°±ç»ªæ€çš„çŠ¶æ€" class="headerlink" title="Pod å°±ç»ªæ€çš„çŠ¶æ€"></a>Pod å°±ç»ªæ€çš„çŠ¶æ€</h3><p>å‘½ä»¤ <code>kubectl patch</code> ä¸æ”¯æŒä¿®æ”¹å¯¹è±¡çš„çŠ¶æ€ã€‚ å¦‚æœéœ€è¦è®¾ç½® Pod çš„ <code>status.conditions</code>ï¼Œåº”ç”¨æˆ–è€… <a href="https://kubernetes.io/zh/docs/concepts/extend-kubernetes/operator/" target="_blank" rel="noopener">Operators</a> éœ€è¦ä½¿ç”¨ <code>PATCH</code> æ“ä½œã€‚ ä½ å¯ä»¥ä½¿ç”¨ <a href="https://kubernetes.io/zh/docs/reference/using-api/client-libraries/" target="_blank" rel="noopener">Kubernetes å®¢æˆ·ç«¯åº“</a> ä¹‹ä¸€æ¥ç¼–å†™ä»£ç ï¼Œé’ˆå¯¹ Pod å°±ç»ªæ€è®¾ç½®å®šåˆ¶çš„ Pod çŠ¶å†µã€‚</p><p>å¯¹äºä½¿ç”¨å®šåˆ¶çŠ¶å†µçš„ Pod è€Œè¨€ï¼Œåªæœ‰å½“ä¸‹é¢çš„é™ˆè¿°éƒ½é€‚ç”¨æ—¶ï¼Œè¯¥ Pod æ‰ä¼šè¢«è¯„ä¼°ä¸ºå°±ç»ªï¼š</p><ul><li>Pod ä¸­æ‰€æœ‰å®¹å™¨éƒ½å·²å°±ç»ªï¼›</li><li><code>readinessGates</code> ä¸­çš„æ‰€æœ‰çŠ¶å†µéƒ½ä¸º <code>True</code> å€¼ã€‚</li></ul><p>å½“ Pod çš„å®¹å™¨éƒ½å·²å°±ç»ªï¼Œä½†è‡³å°‘ä¸€ä¸ªå®šåˆ¶çŠ¶å†µæ²¡æœ‰å–å€¼æˆ–è€…å–å€¼ä¸º <code>False</code>ï¼Œ <code>kubelet</code> å°† Pod çš„<a href="https://kubernetes.io/zh/docs/concepts/workloads/pods/pod-lifecycle/#pod-conditions" target="_blank" rel="noopener">çŠ¶å†µ</a>è®¾ç½®ä¸º <code>ContainersReady</code>ã€‚</p><h2 id="å®¹å™¨æ¢é’ˆ"><a href="#å®¹å™¨æ¢é’ˆ" class="headerlink" title="å®¹å™¨æ¢é’ˆ"></a>å®¹å™¨æ¢é’ˆ</h2><p><a href="https://kubernetes.io/zh/docs/reference/generated/kubernetes-api/v1.19/#probe-v1-core" target="_blank" rel="noopener">æ¢é’ˆ</a> æ˜¯ç”± <a href="https://kubernetes.io/zh/docs/reference/command-line-tools-reference/kubelet/" target="_blank" rel="noopener">kubelet</a> å¯¹å®¹å™¨æ‰§è¡Œçš„å®šæœŸè¯Šæ–­ã€‚ è¦æ‰§è¡Œè¯Šæ–­ï¼Œkubelet è°ƒç”¨ç”±å®¹å™¨å®ç°çš„ <a href="https://kubernetes.io/zh/docs/reference/generated/kubernetes-api/v1.19/#handler-v1-core" target="_blank" rel="noopener">Handler</a> ï¼ˆå¤„ç†ç¨‹åºï¼‰ã€‚æœ‰ä¸‰ç§ç±»å‹çš„å¤„ç†ç¨‹åºï¼š</p><ul><li><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#execaction-v1-core" target="_blank" rel="noopener">ExecAction</a>ï¼š åœ¨å®¹å™¨å†…æ‰§è¡ŒæŒ‡å®šå‘½ä»¤ã€‚å¦‚æœå‘½ä»¤é€€å‡ºæ—¶è¿”å›ç ä¸º 0 åˆ™è®¤ä¸ºè¯Šæ–­æˆåŠŸã€‚</li><li><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#tcpsocketaction-v1-core" target="_blank" rel="noopener">TCPSocketAction</a>ï¼š å¯¹å®¹å™¨çš„ IP åœ°å€ä¸Šçš„æŒ‡å®šç«¯å£æ‰§è¡Œ TCP æ£€æŸ¥ã€‚å¦‚æœç«¯å£æ‰“å¼€ï¼Œåˆ™è¯Šæ–­è¢«è®¤ä¸ºæ˜¯æˆåŠŸçš„ã€‚</li><li><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#httpgetaction-v1-core" target="_blank" rel="noopener">HTTPGetAction</a>ï¼š å¯¹å®¹å™¨çš„ IP åœ°å€ä¸ŠæŒ‡å®šç«¯å£å’Œè·¯å¾„æ‰§è¡Œ HTTP Get è¯·æ±‚ã€‚å¦‚æœå“åº”çš„çŠ¶æ€ç å¤§äºç­‰äº 200 ä¸”å°äº 400ï¼Œåˆ™è¯Šæ–­è¢«è®¤ä¸ºæ˜¯æˆåŠŸçš„ã€‚</li></ul><p>æ¯æ¬¡æ¢æµ‹éƒ½å°†è·å¾—ä»¥ä¸‹ä¸‰ç§ç»“æœä¹‹ä¸€ï¼š</p><ul><li><code>Success</code>ï¼ˆæˆåŠŸï¼‰ï¼šå®¹å™¨é€šè¿‡äº†è¯Šæ–­ã€‚</li><li><code>Failure</code>ï¼ˆå¤±è´¥ï¼‰ï¼šå®¹å™¨æœªé€šè¿‡è¯Šæ–­ã€‚</li><li><code>Unknown</code>ï¼ˆæœªçŸ¥ï¼‰ï¼šè¯Šæ–­å¤±è´¥ï¼Œå› æ­¤ä¸ä¼šé‡‡å–ä»»ä½•è¡ŒåŠ¨ã€‚</li></ul><p>é’ˆå¯¹è¿è¡Œä¸­çš„å®¹å™¨ï¼Œ<code>kubelet</code> å¯ä»¥é€‰æ‹©æ˜¯å¦æ‰§è¡Œä»¥ä¸‹ä¸‰ç§æ¢é’ˆï¼Œä»¥åŠå¦‚ä½•é’ˆå¯¹æ¢æµ‹ç»“æœä½œå‡ºååº”ï¼š</p><ul><li><code>livenessProbe</code>ï¼šæŒ‡ç¤ºå®¹å™¨æ˜¯å¦æ­£åœ¨è¿è¡Œã€‚å¦‚æœå­˜æ´»æ€æ¢æµ‹å¤±è´¥ï¼Œåˆ™ kubelet ä¼šæ€æ­»å®¹å™¨ï¼Œ å¹¶ä¸”å®¹å™¨å°†æ ¹æ®å…¶<a href="https://kubernetes.io/zh/docs/concepts/workloads/pods/pod-lifecycle/#restart-policy" target="_blank" rel="noopener">é‡å¯ç­–ç•¥</a>å†³å®šæœªæ¥ã€‚å¦‚æœå®¹å™¨ä¸æä¾›å­˜æ´»æ¢é’ˆï¼Œ åˆ™é»˜è®¤çŠ¶æ€ä¸º <code>Success</code>ã€‚</li><li><code>readinessProbe</code>ï¼šæŒ‡ç¤ºå®¹å™¨æ˜¯å¦å‡†å¤‡å¥½ä¸ºè¯·æ±‚æä¾›æœåŠ¡ã€‚å¦‚æœå°±ç»ªæ€æ¢æµ‹å¤±è´¥ï¼Œ ç«¯ç‚¹æ§åˆ¶å™¨å°†ä»ä¸ Pod åŒ¹é…çš„æ‰€æœ‰æœåŠ¡çš„ç«¯ç‚¹åˆ—è¡¨ä¸­åˆ é™¤è¯¥ Pod çš„ IP åœ°å€ã€‚ åˆå§‹å»¶è¿Ÿä¹‹å‰çš„å°±ç»ªæ€çš„çŠ¶æ€å€¼é»˜è®¤ä¸º <code>Failure</code>ã€‚ å¦‚æœå®¹å™¨ä¸æä¾›å°±ç»ªæ€æ¢é’ˆï¼Œåˆ™é»˜è®¤çŠ¶æ€ä¸º <code>Success</code>ã€‚</li><li><code>startupProbe</code>: æŒ‡ç¤ºå®¹å™¨ä¸­çš„åº”ç”¨æ˜¯å¦å·²ç»å¯åŠ¨ã€‚å¦‚æœæä¾›äº†å¯åŠ¨æ¢é’ˆï¼Œåˆ™æ‰€æœ‰å…¶ä»–æ¢é’ˆéƒ½ä¼šè¢« ç¦ç”¨ï¼Œç›´åˆ°æ­¤æ¢é’ˆæˆåŠŸä¸ºæ­¢ã€‚å¦‚æœå¯åŠ¨æ¢æµ‹å¤±è´¥ï¼Œ<code>kubelet</code> å°†æ€æ­»å®¹å™¨ï¼Œè€Œå®¹å™¨ä¾å…¶ <a href="https://kubernetes.io/zh/docs/concepts/workloads/pods/pod-lifecycle/#restart-policy" target="_blank" rel="noopener">é‡å¯ç­–ç•¥</a>è¿›è¡Œé‡å¯ã€‚ å¦‚æœå®¹å™¨æ²¡æœ‰æä¾›å¯åŠ¨æ¢æµ‹ï¼Œåˆ™é»˜è®¤çŠ¶æ€ä¸º <code>Success</code>ã€‚</li></ul><p>å¦‚æ¬²äº†è§£å¦‚ä½•è®¾ç½®å­˜æ´»æ€ã€å°±ç»ªæ€å’Œå¯åŠ¨æ¢é’ˆçš„è¿›ä¸€æ­¥ç»†èŠ‚ï¼Œå¯ä»¥å‚é˜… <a href="https://kubernetes.io/zh/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/" target="_blank" rel="noopener">é…ç½®å­˜æ´»æ€ã€å°±ç»ªæ€å’Œå¯åŠ¨æ¢é’ˆ</a>ã€‚</p><h3 id="ä½•æ—¶è¯¥ä½¿ç”¨å­˜æ´»æ€æ¢é’ˆ"><a href="#ä½•æ—¶è¯¥ä½¿ç”¨å­˜æ´»æ€æ¢é’ˆ" class="headerlink" title="ä½•æ—¶è¯¥ä½¿ç”¨å­˜æ´»æ€æ¢é’ˆ?"></a>ä½•æ—¶è¯¥ä½¿ç”¨å­˜æ´»æ€æ¢é’ˆ?</h3><p><strong>FEATURE STATE:</strong> <code>Kubernetes v1.0 [stable]</code></p><p>å¦‚æœå®¹å™¨ä¸­çš„è¿›ç¨‹èƒ½å¤Ÿåœ¨é‡åˆ°é—®é¢˜æˆ–ä¸å¥åº·çš„æƒ…å†µä¸‹è‡ªè¡Œå´©æºƒï¼Œåˆ™ä¸ä¸€å®šéœ€è¦å­˜æ´»æ€æ¢é’ˆ; <code>kubelet</code> å°†æ ¹æ® Pod çš„<code>restartPolicy</code> è‡ªåŠ¨æ‰§è¡Œä¿®å¤æ“ä½œã€‚</p><p>å¦‚æœä½ å¸Œæœ›å®¹å™¨åœ¨æ¢æµ‹å¤±è´¥æ—¶è¢«æ€æ­»å¹¶é‡æ–°å¯åŠ¨ï¼Œé‚£ä¹ˆè¯·æŒ‡å®šä¸€ä¸ªå­˜æ´»æ€æ¢é’ˆï¼Œ å¹¶æŒ‡å®š<code>restartPolicy</code> ä¸º â€œ<code>Always</code>â€œ æˆ– â€œ<code>OnFailure</code>â€œã€‚</p><h3 id="ä½•æ—¶è¯¥ä½¿ç”¨å°±ç»ªæ€æ¢é’ˆ"><a href="#ä½•æ—¶è¯¥ä½¿ç”¨å°±ç»ªæ€æ¢é’ˆ" class="headerlink" title="ä½•æ—¶è¯¥ä½¿ç”¨å°±ç»ªæ€æ¢é’ˆ?"></a>ä½•æ—¶è¯¥ä½¿ç”¨å°±ç»ªæ€æ¢é’ˆ?</h3><p><strong>FEATURE STATE:</strong> <code>Kubernetes v1.0 [stable]</code></p><p>å¦‚æœè¦ä»…åœ¨æ¢æµ‹æˆåŠŸæ—¶æ‰å¼€å§‹å‘ Pod å‘é€è¯·æ±‚æµé‡ï¼Œè¯·æŒ‡å®šå°±ç»ªæ€æ¢é’ˆã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå°±ç»ªæ€æ¢é’ˆå¯èƒ½ä¸å­˜æ´»æ€æ¢é’ˆç›¸åŒï¼Œä½†æ˜¯è§„çº¦ä¸­çš„å°±ç»ªæ€æ¢é’ˆçš„å­˜åœ¨æ„å‘³ç€ Pod å°†åœ¨å¯åŠ¨é˜¶æ®µä¸æ¥æ”¶ä»»ä½•æ•°æ®ï¼Œå¹¶ä¸”åªæœ‰åœ¨æ¢é’ˆæ¢æµ‹æˆåŠŸåæ‰å¼€å§‹æ¥æ”¶æ•°æ®ã€‚</p><p>å¦‚æœä½ çš„å®¹å™¨éœ€è¦åŠ è½½å¤§è§„æ¨¡çš„æ•°æ®ã€é…ç½®æ–‡ä»¶æˆ–è€…åœ¨å¯åŠ¨æœŸé—´æ‰§è¡Œè¿ç§»æ“ä½œï¼Œå¯ä»¥æ·»åŠ ä¸€ä¸ª å°±ç»ªæ€æ¢é’ˆã€‚</p><p>å¦‚æœä½ å¸Œæœ›å®¹å™¨èƒ½å¤Ÿè‡ªè¡Œè¿›å…¥ç»´æŠ¤çŠ¶æ€ï¼Œä¹Ÿå¯ä»¥æŒ‡å®šä¸€ä¸ªå°±ç»ªæ€æ¢é’ˆï¼Œæ£€æŸ¥æŸä¸ªç‰¹å®šäº å°±ç»ªæ€çš„å› æ­¤ä¸åŒäºå­˜æ´»æ€æ¢æµ‹çš„ç«¯ç‚¹ã€‚</p><blockquote><p><strong>è¯´æ˜ï¼š</strong> è¯·æ³¨æ„ï¼Œå¦‚æœä½ åªæ˜¯æƒ³åœ¨ Pod è¢«åˆ é™¤æ—¶èƒ½å¤Ÿæ’ç©ºè¯·æ±‚ï¼Œåˆ™ä¸ä¸€å®šéœ€è¦ä½¿ç”¨å°±ç»ªæ€æ¢é’ˆï¼› åœ¨åˆ é™¤ Pod æ—¶ï¼ŒPod ä¼šè‡ªåŠ¨å°†è‡ªèº«ç½®äºæœªå°±ç»ªçŠ¶æ€ï¼Œæ— è®ºå°±ç»ªæ€æ¢é’ˆæ˜¯å¦å­˜åœ¨ã€‚ ç­‰å¾… Pod ä¸­çš„å®¹å™¨åœæ­¢æœŸé—´ï¼ŒPod ä¼šä¸€ç›´å¤„äºæœªå°±ç»ªçŠ¶æ€ã€‚</p></blockquote><h3 id="ä½•æ—¶è¯¥ä½¿ç”¨å¯åŠ¨æ¢é’ˆï¼Ÿ"><a href="#ä½•æ—¶è¯¥ä½¿ç”¨å¯åŠ¨æ¢é’ˆï¼Ÿ" class="headerlink" title="ä½•æ—¶è¯¥ä½¿ç”¨å¯åŠ¨æ¢é’ˆï¼Ÿ"></a>ä½•æ—¶è¯¥ä½¿ç”¨å¯åŠ¨æ¢é’ˆï¼Ÿ</h3><p><strong>FEATURE STATE:</strong> <code>Kubernetes v1.16 [alpha]</code></p><p>å¯¹äºæ‰€åŒ…å«çš„å®¹å™¨éœ€è¦è¾ƒé•¿æ—¶é—´æ‰èƒ½å¯åŠ¨å°±ç»ªçš„ Pod è€Œè¨€ï¼Œå¯åŠ¨æ¢é’ˆæ˜¯æœ‰ç”¨çš„ã€‚ ä½ ä¸å†éœ€è¦é…ç½®ä¸€ä¸ªè¾ƒé•¿çš„å­˜æ´»æ€æ¢æµ‹æ—¶é—´é—´éš”ï¼Œåªéœ€è¦è®¾ç½®å¦ä¸€ä¸ªç‹¬ç«‹çš„é…ç½®é€‰å®šï¼Œ å¯¹å¯åŠ¨æœŸé—´çš„å®¹å™¨æ‰§è¡Œæ¢æµ‹ï¼Œä»è€Œå…è®¸ä½¿ç”¨è¿œè¿œè¶…å‡ºå­˜æ´»æ€æ—¶é—´é—´éš”æ‰€å…è®¸çš„æ—¶é•¿ã€‚</p><p>å¦‚æœä½ çš„å®¹å™¨å¯åŠ¨æ—¶é—´é€šå¸¸è¶…å‡º <code>initialDelaySeconds + failureThreshold Ã— periodSeconds</code> æ€»å€¼ï¼Œä½ åº”è¯¥è®¾ç½®ä¸€ä¸ªå¯åŠ¨æ¢æµ‹ï¼Œå¯¹å­˜æ´»æ€æ¢é’ˆæ‰€ä½¿ç”¨çš„åŒä¸€ç«¯ç‚¹æ‰§è¡Œæ£€æŸ¥ã€‚ <code>periodSeconds</code> çš„é»˜è®¤å€¼æ˜¯ 30 ç§’ã€‚ä½ åº”è¯¥å°†å…¶ <code>failureThreshold</code> è®¾ç½®å¾—è¶³å¤Ÿé«˜ï¼Œ ä»¥ä¾¿å®¹å™¨æœ‰å……è¶³çš„æ—¶é—´å®Œæˆå¯åŠ¨ï¼Œå¹¶ä¸”é¿å…æ›´æ”¹å­˜æ´»æ€æ¢é’ˆæ‰€ä½¿ç”¨çš„é»˜è®¤å€¼ã€‚ è¿™ä¸€è®¾ç½®æœ‰åŠ©äºå‡å°‘æ­»é”çŠ¶å†µçš„å‘ç”Ÿã€‚</p><h2 id="Pod-çš„ç»ˆæ­¢"><a href="#Pod-çš„ç»ˆæ­¢" class="headerlink" title="Pod çš„ç»ˆæ­¢"></a>Pod çš„ç»ˆæ­¢</h2><p>ç”±äº Pod æ‰€ä»£è¡¨çš„æ˜¯åœ¨é›†ç¾¤ä¸­èŠ‚ç‚¹ä¸Šè¿è¡Œçš„è¿›ç¨‹ï¼Œå½“ä¸å†éœ€è¦è¿™äº›è¿›ç¨‹æ—¶å…è®¸å…¶ä½“é¢åœ° ç»ˆæ­¢æ˜¯å¾ˆé‡è¦çš„ã€‚ä¸€èˆ¬ä¸åº”æ­¦æ–­åœ°ä½¿ç”¨ <code>KILL</code> ä¿¡å·ç»ˆæ­¢å®ƒä»¬ï¼Œå¯¼è‡´è¿™äº›è¿›ç¨‹æ²¡æœ‰æœºä¼š å®Œæˆæ¸…ç†æ“ä½œã€‚</p><p>è®¾è®¡çš„ç›®æ ‡æ˜¯ä»¤ä½ èƒ½å¤Ÿè¯·æ±‚åˆ é™¤è¿›ç¨‹ï¼Œå¹¶ä¸”çŸ¥é“è¿›ç¨‹ä½•æ—¶è¢«ç»ˆæ­¢ï¼ŒåŒæ—¶ä¹Ÿèƒ½å¤Ÿç¡®ä¿åˆ é™¤ æ“ä½œç»ˆå°†å®Œæˆã€‚å½“ä½ è¯·æ±‚åˆ é™¤æŸä¸ª Pod æ—¶ï¼Œé›†ç¾¤ä¼šè®°å½•å¹¶è·Ÿè¸ª Pod çš„ä½“é¢ç»ˆæ­¢å‘¨æœŸï¼Œ è€Œä¸æ˜¯ç›´æ¥å¼ºåˆ¶åœ°æ€æ­» Podã€‚åœ¨å­˜åœ¨å¼ºåˆ¶å…³é—­è®¾æ–½çš„å‰æä¸‹ï¼Œ <a href="https://kubernetes.io/docs/reference/generated/kubelet" target="_blank" rel="noopener">kubelet</a> ä¼šå°è¯•ä½“é¢åœ°ç»ˆæ­¢ Podã€‚</p><p>é€šå¸¸æƒ…å†µä¸‹ï¼Œå®¹å™¨è¿è¡Œæ—¶ä¼šå‘é€ä¸€ä¸ª TERM ä¿¡å·åˆ°æ¯ä¸ªå®¹å™¨ä¸­çš„ä¸»è¿›ç¨‹ã€‚ ä¸€æ—¦è¶…å‡ºäº†ä½“é¢ç»ˆæ­¢é™æœŸï¼Œå®¹å™¨è¿è¡Œæ—¶ä¼šå‘æ‰€æœ‰å‰©ä½™è¿›ç¨‹å‘é€ KILL ä¿¡å·ï¼Œä¹‹å Pod å°±ä¼šè¢«ä» <a href="https://kubernetes.io/docs/reference/generated/kube-apiserver/" target="_blank" rel="noopener">API æœåŠ¡å™¨</a> ä¸Šç§»é™¤ã€‚å¦‚æœ <code>kubelet</code> æˆ–è€…å®¹å™¨è¿è¡Œæ—¶çš„ç®¡ç†æœåŠ¡åœ¨ç­‰å¾…è¿›ç¨‹ç»ˆæ­¢æœŸé—´è¢«é‡å¯ï¼Œ é›†ç¾¤ä¼šä»å¤´å¼€å§‹é‡è¯•ï¼Œèµ‹äºˆ Pod å®Œæ•´çš„ä½“é¢ç»ˆæ­¢é™æœŸã€‚</p><p>ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ï¼š</p><ol><li><p>ä½ ä½¿ç”¨ <code>kubectl</code> å·¥å…·æ‰‹åŠ¨åˆ é™¤æŸä¸ªç‰¹å®šçš„ Podï¼Œè€Œè¯¥ Pod çš„ä½“é¢ç»ˆæ­¢é™æœŸæ˜¯é»˜è®¤å€¼ï¼ˆ30 ç§’ï¼‰ã€‚</p></li><li><p>API æœåŠ¡å™¨ä¸­çš„ Pod å¯¹è±¡è¢«æ›´æ–°ï¼Œè®°å½•æ¶µç›–ä½“é¢ç»ˆæ­¢é™æœŸåœ¨å†… Pod çš„æœ€ç»ˆæ­»æœŸï¼Œè¶…å‡ºæ‰€è®¡ç®—æ—¶é—´ç‚¹åˆ™è®¤ä¸º Pod å·²æ­»ï¼ˆdeadï¼‰ã€‚ å¦‚æœä½ ä½¿ç”¨ <code>kubectl describe</code> æ¥æŸ¥éªŒä½ æ­£åœ¨åˆ é™¤çš„ Podï¼Œè¯¥ Pod ä¼šæ˜¾ç¤ºä¸º â€œTerminatingâ€ ï¼ˆæ­£åœ¨ç»ˆæ­¢ï¼‰ã€‚ åœ¨ Pod è¿è¡Œæ‰€åœ¨çš„èŠ‚ç‚¹ä¸Šï¼š<code>kubelet</code> ä¸€æ—¦çœ‹åˆ° Pod è¢«æ ‡è®°ä¸ºæ­£åœ¨ç»ˆæ­¢ï¼ˆå·²ç»è®¾ç½®äº†ä½“é¢ç»ˆæ­¢é™æœŸï¼‰ï¼Œ<code>kubelet</code> å³å¼€å§‹æœ¬åœ°çš„ Pod å…³é—­è¿‡ç¨‹ã€‚</p><ol><li><p>å¦‚æœ Pod ä¸­çš„å®¹å™¨ä¹‹ä¸€å®šä¹‰äº† <code>preStop</code> <a href="https://kubernetes.io/zh/docs/concepts/containers/container-lifecycle-hooks/#hook-details" target="_blank" rel="noopener">å›è°ƒ</a>ï¼Œ <code>kubelet</code> å¼€å§‹åœ¨å®¹å™¨å†…è¿è¡Œè¯¥å›è°ƒé€»è¾‘ã€‚å¦‚æœè¶…å‡ºä½“é¢ç»ˆæ­¢é™æœŸæ—¶ï¼Œ<code>preStop</code> å›è°ƒé€»è¾‘ ä»åœ¨è¿è¡Œï¼Œ<code>kubelet</code> ä¼šè¯·æ±‚ç»™äºˆè¯¥ Pod çš„å®½é™æœŸä¸€æ¬¡æ€§å¢åŠ  2 ç§’é’Ÿã€‚</p><blockquote><p><strong>è¯´æ˜ï¼š</strong> å¦‚æœ <code>preStop</code> å›è°ƒæ‰€éœ€è¦çš„æ—¶é—´é•¿äºé»˜è®¤çš„ä½“é¢ç»ˆæ­¢é™æœŸï¼Œä½ å¿…é¡»ä¿®æ”¹ <code>terminationGracePeriodSeconds</code> å±æ€§å€¼æ¥ä½¿å…¶æ­£å¸¸å·¥ä½œã€‚</p></blockquote></li><li><p><code>kubelet</code> æ¥ä¸‹æ¥è§¦å‘å®¹å™¨è¿è¡Œæ—¶å‘é€ TERM ä¿¡å·ç»™æ¯ä¸ªå®¹å™¨ä¸­çš„è¿›ç¨‹ 1ã€‚</p><blockquote><p><strong>è¯´æ˜ï¼š</strong> Pod ä¸­çš„å®¹å™¨ä¼šåœ¨ä¸åŒæ—¶åˆ»æ”¶åˆ° TERM ä¿¡å·ï¼Œæ¥æ”¶é¡ºåºä¹Ÿæ˜¯ä¸ç¡®å®šçš„ã€‚ å¦‚æœå…³é—­çš„é¡ºåºå¾ˆé‡è¦ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨ <code>preStop</code> å›è°ƒé€»è¾‘æ¥åè°ƒã€‚</p></blockquote></li></ol></li><li><p>ä¸æ­¤åŒæ—¶ï¼Œ<code>kubelet</code> å¯åŠ¨ä½“é¢å…³é—­é€»è¾‘ï¼Œæ§åˆ¶é¢ä¼šå°† Pod ä»å¯¹åº”çš„ç«¯ç‚¹åˆ—è¡¨ï¼ˆä»¥åŠç«¯ç‚¹åˆ‡ç‰‡åˆ—è¡¨ï¼Œ å¦‚æœå¯ç”¨äº†çš„è¯ï¼‰ä¸­ç§»é™¤ï¼Œè¿‡æ»¤æ¡ä»¶æ˜¯ Pod è¢«å¯¹åº”çš„ <a href="https://kubernetes.io/zh/docs/concepts/services-networking/service/" target="_blank" rel="noopener">æœåŠ¡</a>ä»¥æŸ <a href="https://kubernetes.io/zh/docs/concepts/overview/working-with-objects/labels/" target="_blank" rel="noopener">é€‰æ‹©ç®—ç¬¦</a>é€‰å®šã€‚ <a href="https://kubernetes.io/zh/docs/concepts/workloads/controllers/replicaset/" target="_blank" rel="noopener">ReplicaSets</a>å’Œå…¶ä»–å·¥ä½œè´Ÿè½½èµ„æº ä¸å†å°†å…³é—­è¿›ç¨‹ä¸­çš„ Pod è§†ä¸ºåˆæ³•çš„ã€èƒ½å¤Ÿæä¾›æœåŠ¡çš„å‰¯æœ¬ã€‚å…³é—­åŠ¨ä½œå¾ˆæ…¢çš„ Pod ä¹Ÿæ— æ³•ç»§ç»­å¤„ç†è¯·æ±‚æ•°æ®ï¼Œå› ä¸ºè´Ÿè½½å‡è¡¡å™¨ï¼ˆä¾‹å¦‚æœåŠ¡ä»£ç†ï¼‰å·²ç»åœ¨ç»ˆæ­¢å®½é™æœŸå¼€å§‹çš„æ—¶å€™ å°†å…¶ä»ç«¯ç‚¹åˆ—è¡¨ä¸­ç§»é™¤ã€‚</p></li><li><p>è¶…å‡ºç»ˆæ­¢å®½é™æœŸçº¿æ—¶ï¼Œ<code>kubelet</code> ä¼šè§¦å‘å¼ºåˆ¶å…³é—­è¿‡ç¨‹ã€‚å®¹å™¨è¿è¡Œæ—¶ä¼šå‘ Pod ä¸­æ‰€æœ‰å®¹å™¨å†… ä»åœ¨è¿è¡Œçš„è¿›ç¨‹å‘é€ <code>SIGKILL</code> ä¿¡å·ã€‚ <code>kubelet</code> ä¹Ÿä¼šæ¸…ç†éšè—çš„ <code>pause</code> å®¹å™¨ï¼Œå¦‚æœå®¹å™¨è¿è¡Œæ—¶ä½¿ç”¨äº†è¿™ç§å®¹å™¨çš„è¯ã€‚</p></li><li><p><code>kubelet</code> è§¦å‘å¼ºåˆ¶ä» API æœåŠ¡å™¨ä¸Šåˆ é™¤ Pod å¯¹è±¡çš„é€»è¾‘ï¼Œå¹¶å°†ä½“é¢ç»ˆæ­¢é™æœŸè®¾ç½®ä¸º 0 ï¼ˆè¿™æ„å‘³ç€é©¬ä¸Šåˆ é™¤ï¼‰ã€‚</p></li><li><p>API æœåŠ¡å™¨åˆ é™¤ Pod çš„ API å¯¹è±¡ï¼Œä»ä»»ä½•å®¢æˆ·ç«¯éƒ½æ— æ³•å†çœ‹åˆ°è¯¥å¯¹è±¡ã€‚</p></li></ol><h3 id="å¼ºåˆ¶ç»ˆæ­¢-Pod"><a href="#å¼ºåˆ¶ç»ˆæ­¢-Pod" class="headerlink" title="å¼ºåˆ¶ç»ˆæ­¢ Pod"></a>å¼ºåˆ¶ç»ˆæ­¢ Pod</h3><blockquote><p><strong>æ³¨æ„ï¼š</strong> å¯¹äºæŸäº›å·¥ä½œè´Ÿè½½åŠå…¶ Pod è€Œè¨€ï¼Œå¼ºåˆ¶åˆ é™¤å¾ˆå¯èƒ½ä¼šå¸¦æ¥æŸç§ç ´åã€‚</p></blockquote><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œæ‰€æœ‰çš„åˆ é™¤æ“ä½œéƒ½ä¼šé™„æœ‰ 30 ç§’é’Ÿçš„å®½é™æœŸé™ã€‚ <code>kubectl delete</code> å‘½ä»¤æ”¯æŒ <code>--grace-period=&lt;seconds&gt;</code> é€‰é¡¹ï¼Œå…è®¸ä½ é‡è½½é»˜è®¤å€¼ï¼Œ è®¾å®šè‡ªå·±å¸Œæœ›çš„æœŸé™å€¼ã€‚</p><p>å°†å®½é™æœŸé™å¼ºåˆ¶è®¾ç½®ä¸º <code>0</code> æ„å‘³ç€ç«‹å³ä» API æœåŠ¡å™¨åˆ é™¤ Podã€‚ å¦‚æœ Pod ä»ç„¶è¿è¡ŒäºæŸèŠ‚ç‚¹ä¸Šï¼Œå¼ºåˆ¶åˆ é™¤æ“ä½œä¼šè§¦å‘ <code>kubelet</code> ç«‹å³æ‰§è¡Œæ¸…ç†æ“ä½œã€‚</p><blockquote><p><strong>è¯´æ˜ï¼š</strong> ä½ å¿…é¡»åœ¨è®¾ç½® <code>--grace-period=0</code> çš„åŒæ—¶é¢å¤–è®¾ç½® <code>--force</code> å‚æ•°æ‰èƒ½å‘èµ·å¼ºåˆ¶åˆ é™¤è¯·æ±‚ã€‚</p></blockquote><p>æ‰§è¡Œå¼ºåˆ¶åˆ é™¤æ“ä½œæ—¶ï¼ŒAPI æœåŠ¡å™¨ä¸å†ç­‰å¾…æ¥è‡ª <code>kubelet</code> çš„ã€å…³äº Pod å·²ç»åœ¨åŸæ¥è¿è¡Œçš„èŠ‚ç‚¹ä¸Šç»ˆæ­¢æ‰§è¡Œçš„ç¡®è®¤æ¶ˆæ¯ã€‚ API æœåŠ¡å™¨ç›´æ¥åˆ é™¤ Pod å¯¹è±¡ï¼Œè¿™æ ·æ–°çš„ä¸ä¹‹åŒåçš„ Pod å³å¯ä»¥è¢«åˆ›å»ºã€‚ åœ¨èŠ‚ç‚¹ä¾§ï¼Œè¢«è®¾ç½®ä¸ºç«‹å³ç»ˆæ­¢çš„ Pod ä»ç„¶ä¼šåœ¨è¢«å¼ºè¡Œæ€æ­»ä¹‹å‰è·å¾—ä¸€ç‚¹ç‚¹çš„å®½é™æ—¶é—´ã€‚</p><p>å¦‚æœä½ éœ€è¦å¼ºåˆ¶åˆ é™¤ StatefulSet çš„ Podï¼Œè¯·å‚é˜… <a href="https://kubernetes.io/zh/docs/tasks/run-application/force-delete-stateful-set-pod/" target="_blank" rel="noopener">ä» StatefulSet ä¸­åˆ é™¤ Pod</a> çš„ä»»åŠ¡æ–‡æ¡£ã€‚</p><h3 id="å¤±æ•ˆ-Pod-çš„åƒåœ¾æ”¶é›†"><a href="#å¤±æ•ˆ-Pod-çš„åƒåœ¾æ”¶é›†" class="headerlink" title="å¤±æ•ˆ Pod çš„åƒåœ¾æ”¶é›†"></a>å¤±æ•ˆ Pod çš„åƒåœ¾æ”¶é›†</h3><p>å¯¹äºå·²å¤±è´¥çš„ Pod è€Œè¨€ï¼Œå¯¹åº”çš„ API å¯¹è±¡ä»ç„¶ä¼šä¿ç•™åœ¨é›†ç¾¤çš„ API æœåŠ¡å™¨ä¸Šï¼Œç›´åˆ° ç”¨æˆ·æˆ–è€…<a href="https://kubernetes.io/docs/admin/kube-controller-manager/" target="_blank" rel="noopener">æ§åˆ¶å™¨</a>è¿›ç¨‹æ˜¾å¼åœ° å°†å…¶åˆ é™¤ã€‚</p><p>æ§åˆ¶é¢ç»„ä»¶ä¼šåœ¨ Pod ä¸ªæ•°è¶…å‡ºæ‰€é…ç½®çš„é˜ˆå€¼ ï¼ˆæ ¹æ® <code>kube-controller-manager</code> çš„ <code>terminated-pod-gc-threshold</code> è®¾ç½®ï¼‰æ—¶ åˆ é™¤å·²ç»ˆæ­¢çš„ Podï¼ˆé˜¶æ®µå€¼ä¸º <code>Succeeded</code> æˆ– <code>Failed</code>ï¼‰ã€‚ è¿™ä¸€è¡Œä¸ºä¼šé¿å…éšç€æ—¶é—´æ¼”è¿›ä¸æ–­åˆ›å»ºå’Œç»ˆæ­¢ Pod è€Œå¼•èµ·çš„èµ„æºæ³„éœ²é—®é¢˜ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> å®¹å™¨ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kubernetes-Pod-Pods</title>
      <link href="2020/10/06/rong-qi/kubernetes-gong-zuo-fu-zai-pods/"/>
      <url>2020/10/06/rong-qi/kubernetes-gong-zuo-fu-zai-pods/</url>
      
        <content type="html"><![CDATA[<h1 id="Pods"><a href="#Pods" class="headerlink" title="Pods"></a>Pods</h1><p><em>Pod</em> æ˜¯å¯ä»¥åœ¨ Kubernetes ä¸­åˆ›å»ºå’Œç®¡ç†çš„ã€æœ€å°çš„å¯éƒ¨ç½²çš„è®¡ç®—å•å…ƒã€‚</p><p><em>Pod</em> ï¼ˆå°±åƒåœ¨é²¸é±¼èšæˆ–è€…è±Œè±†èšä¸­ï¼‰æ˜¯ä¸€ç»„ï¼ˆä¸€ä¸ªæˆ–å¤šä¸ªï¼‰ <a href="https://kubernetes.io/zh/docs/concepts/overview/what-is-kubernetes/#why-containers" target="_blank" rel="noopener">å®¹å™¨</a>ï¼› è¿™äº›å®¹å™¨å…±äº«å­˜å‚¨ã€ç½‘ç»œã€ä»¥åŠæ€æ ·è¿è¡Œè¿™äº›å®¹å™¨çš„å£°æ˜ã€‚ Pod ä¸­çš„å†…å®¹æ€»æ˜¯å¹¶ç½®ï¼ˆcolocatedï¼‰çš„å¹¶ä¸”ä¸€åŒè°ƒåº¦ï¼Œåœ¨å…±äº«çš„ä¸Šä¸‹æ–‡ä¸­è¿è¡Œã€‚ Pod æ‰€å»ºæ¨¡çš„æ˜¯ç‰¹å®šäºåº”ç”¨çš„â€œé€»è¾‘ä¸»æœºâ€ï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªåº”ç”¨å®¹å™¨ï¼Œ è¿™äº›å®¹å™¨æ˜¯ç›¸å¯¹ç´§å¯†çš„è€¦åˆåœ¨ä¸€èµ·çš„ã€‚ åœ¨éäº‘ç¯å¢ƒä¸­ï¼Œåœ¨ç›¸åŒçš„ç‰©ç†æœºæˆ–è™šæ‹Ÿæœºä¸Šè¿è¡Œçš„åº”ç”¨ç±»ä¼¼äº åœ¨åŒä¸€é€»è¾‘ä¸»æœºä¸Šè¿è¡Œçš„äº‘åº”ç”¨ã€‚</p><p>é™¤äº†åº”ç”¨å®¹å™¨ï¼ŒPod è¿˜å¯ä»¥åŒ…å«åœ¨ Pod å¯åŠ¨æœŸé—´è¿è¡Œçš„ <a href="https://kubernetes.io/zh/docs/concepts/workloads/pods/init-containers/" target="_blank" rel="noopener">Init å®¹å™¨</a>ã€‚ ä½ ä¹Ÿå¯ä»¥åœ¨é›†ç¾¤ä¸­æ”¯æŒ<a href="https://kubernetes.io/zh/docs/concepts/workloads/pods/ephemeral-containers/" target="_blank" rel="noopener">ä¸´æ—¶æ€§å®¹å™¨</a> çš„æƒ…å†µå¤–ï¼Œä¸ºè°ƒè¯•çš„ç›®çš„æ³¨å…¥ä¸´æ—¶æ€§å®¹å™¨ã€‚</p><h2 id="ä»€ä¹ˆæ˜¯-Podï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯-Podï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯ Podï¼Ÿ"></a>ä»€ä¹ˆæ˜¯ Podï¼Ÿ</h2><blockquote><p><strong>è¯´æ˜ï¼š</strong> é™¤äº† Docker ä¹‹å¤–ï¼ŒKubernetes æ”¯æŒ å¾ˆå¤šå…¶ä»–<a href="https://kubernetes.io/docs/reference/generated/container-runtime" target="_blank" rel="noopener">å®¹å™¨è¿è¡Œæ—¶</a>ï¼Œ <a href="https://www.docker.com/" target="_blank" rel="noopener">Docker</a> æ˜¯æœ€æœ‰åçš„è¿è¡Œæ—¶ï¼Œ ä½¿ç”¨ Docker çš„æœ¯è¯­æ¥æè¿° Pod ä¼šå¾ˆæœ‰å¸®åŠ©ã€‚</p></blockquote><p>Pod çš„å…±äº«ä¸Šä¸‹æ–‡åŒ…æ‹¬ä¸€ç»„ Linux åå­—ç©ºé—´ã€æ§åˆ¶ç»„ï¼ˆcgroupï¼‰å’Œå¯èƒ½ä¸€äº›å…¶ä»–çš„éš”ç¦» æ–¹é¢ï¼Œå³ç”¨æ¥éš”ç¦» Docker å®¹å™¨çš„æŠ€æœ¯ã€‚ åœ¨ Pod çš„ä¸Šä¸‹æ–‡ä¸­ï¼Œæ¯ä¸ªç‹¬ç«‹çš„åº”ç”¨å¯èƒ½ä¼šè¿›ä¸€æ­¥å®æ–½éš”ç¦»ã€‚</p><p>å°± Docker æ¦‚å¿µçš„æœ¯è¯­è€Œè¨€ï¼ŒPod ç±»ä¼¼äºå…±äº«åå­—ç©ºé—´å’Œæ–‡ä»¶ç³»ç»Ÿå·çš„ä¸€ç»„ Docker å®¹å™¨ã€‚</p><h2 id="ä½¿ç”¨-Pod"><a href="#ä½¿ç”¨-Pod" class="headerlink" title="ä½¿ç”¨ Pod"></a>ä½¿ç”¨ Pod</h2><p>é€šå¸¸ä½ ä¸éœ€è¦ç›´æ¥åˆ›å»º Podï¼Œç”šè‡³å•å®ä¾‹ Podã€‚ ç›¸åï¼Œä½ ä¼šä½¿ç”¨è¯¸å¦‚ <a href="https://kubernetes.io/zh/docs/concepts/workloads/controllers/deployment/" target="_blank" rel="noopener">Deployment</a> æˆ– <a href="https://kubernetes.io/docs/concepts/workloads/controllers/jobs-run-to-completion" target="_blank" rel="noopener">Job</a> è¿™ç±»å·¥ä½œè´Ÿè½½èµ„æº æ¥åˆ›å»º Podã€‚å¦‚æœ Pod éœ€è¦è·Ÿè¸ªçŠ¶æ€ï¼Œ å¯ä»¥è€ƒè™‘ <a href="https://kubernetes.io/zh/docs/concepts/workloads/controllers/statefulset/" target="_blank" rel="noopener">StatefulSet</a> èµ„æºã€‚</p><p>Kubernetes é›†ç¾¤ä¸­çš„ Pod ä¸»è¦æœ‰ä¸¤ç§ç”¨æ³•ï¼š</p><ul><li><p><strong>è¿è¡Œå•ä¸ªå®¹å™¨çš„ Pod</strong>ã€‚â€æ¯ä¸ª Pod ä¸€ä¸ªå®¹å™¨â€æ¨¡å‹æ˜¯æœ€å¸¸è§çš„ Kubernetes ç”¨ä¾‹ï¼› åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¯ä»¥å°† Pod çœ‹ä½œå•ä¸ªå®¹å™¨çš„åŒ…è£…å™¨ï¼Œå¹¶ä¸” Kubernetes ç›´æ¥ç®¡ç† Podï¼Œè€Œä¸æ˜¯å®¹å™¨ã€‚</p></li><li><p><strong>è¿è¡Œå¤šä¸ªååŒå·¥ä½œçš„å®¹å™¨çš„ Pod</strong>ã€‚ Pod å¯èƒ½å°è£…ç”±å¤šä¸ªç´§å¯†è€¦åˆä¸”éœ€è¦å…±äº«èµ„æºçš„å…±å¤„å®¹å™¨ç»„æˆçš„åº”ç”¨ç¨‹åºã€‚ è¿™äº›ä½äºåŒä¸€ä½ç½®çš„å®¹å™¨å¯èƒ½å½¢æˆå•ä¸ªå†…èšçš„æœåŠ¡å•å…ƒ â€”â€” ä¸€ä¸ªå®¹å™¨å°†æ–‡ä»¶ä»å…±äº«å·æä¾›ç»™å…¬ä¼—ï¼Œ è€Œå¦ä¸€ä¸ªå•ç‹¬çš„â€œæŒ‚æ–—â€ï¼ˆsidecarï¼‰å®¹å™¨åˆ™åˆ·æ–°æˆ–æ›´æ–°è¿™äº›æ–‡ä»¶ã€‚ Pod å°†è¿™äº›å®¹å™¨å’Œå­˜å‚¨èµ„æºæ‰“åŒ…ä¸ºä¸€ä¸ªå¯ç®¡ç†çš„å®ä½“ã€‚</p><blockquote><p><strong>è¯´æ˜ï¼š</strong> å°†å¤šä¸ªå¹¶ç½®ã€åŒç®¡çš„å®¹å™¨ç»„ç»‡åˆ°ä¸€ä¸ª Pod ä¸­æ˜¯ä¸€ç§ç›¸å¯¹é«˜çº§çš„ä½¿ç”¨åœºæ™¯ã€‚ åªæœ‰åœ¨ä¸€äº›åœºæ™¯ä¸­ï¼Œå®¹å™¨ä¹‹é—´ç´§å¯†å…³è”æ—¶ä½ æ‰åº”è¯¥ä½¿ç”¨è¿™ç§æ¨¡å¼ã€‚</p></blockquote></li></ul><p>æ¯ä¸ª Pod éƒ½æ—¨åœ¨è¿è¡Œç»™å®šåº”ç”¨ç¨‹åºçš„å•ä¸ªå®ä¾‹ã€‚å¦‚æœå¸Œæœ›æ¨ªå‘æ‰©å±•åº”ç”¨ç¨‹åºï¼ˆä¾‹å¦‚ï¼Œè¿è¡Œå¤šä¸ªå®ä¾‹ ä»¥æä¾›æ›´å¤šçš„èµ„æºï¼‰ï¼Œåˆ™åº”è¯¥ä½¿ç”¨å¤šä¸ª Podï¼Œæ¯ä¸ªå®ä¾‹ä½¿ç”¨ä¸€ä¸ª Podã€‚ åœ¨ Kubernetes ä¸­ï¼Œè¿™é€šå¸¸è¢«ç§°ä¸º <em>å‰¯æœ¬ï¼ˆReplicationï¼‰</em>ã€‚ é€šå¸¸ä½¿ç”¨ä¸€ç§å·¥ä½œè´Ÿè½½èµ„æºåŠå…¶<a href="https://kubernetes.io/docs/admin/kube-controller-manager/" target="_blank" rel="noopener">æ§åˆ¶å™¨</a> æ¥åˆ›å»ºå’Œç®¡ç†ä¸€ç»„ Pod å‰¯æœ¬ã€‚</p><p>å‚è§ <a href="https://kubernetes.io/zh/docs/concepts/workloads/pods/#pods-and-controllers" target="_blank" rel="noopener">Pod å’Œæ§åˆ¶å™¨</a>ä»¥äº†è§£ Kubernetes å¦‚ä½•ä½¿ç”¨å·¥ä½œè´Ÿè½½èµ„æºåŠå…¶æ§åˆ¶å™¨ä»¥å®ç°åº”ç”¨çš„æ‰©ç¼©å’Œè‡ªåŠ¨ä¿®å¤ã€‚</p><h3 id="Pod-æ€æ ·ç®¡ç†å¤šä¸ªå®¹å™¨"><a href="#Pod-æ€æ ·ç®¡ç†å¤šä¸ªå®¹å™¨" class="headerlink" title="Pod æ€æ ·ç®¡ç†å¤šä¸ªå®¹å™¨"></a>Pod æ€æ ·ç®¡ç†å¤šä¸ªå®¹å™¨</h3><p>Pod è¢«è®¾è®¡æˆæ”¯æŒå½¢æˆå†…èšæœåŠ¡å•å…ƒçš„å¤šä¸ªåä½œè¿‡ç¨‹ï¼ˆå½¢å¼ä¸ºå®¹å™¨ï¼‰ã€‚ Pod ä¸­çš„å®¹å™¨è¢«è‡ªåŠ¨å®‰æ’åˆ°é›†ç¾¤ä¸­çš„åŒä¸€ç‰©ç†æœºæˆ–è™šæ‹Ÿæœºä¸Šï¼Œå¹¶å¯ä»¥ä¸€èµ·è¿›è¡Œè°ƒåº¦ã€‚ å®¹å™¨ä¹‹é—´å¯ä»¥å…±äº«èµ„æºå’Œä¾èµ–ã€å½¼æ­¤é€šä¿¡ã€åè°ƒä½•æ—¶ä»¥åŠä½•ç§æ–¹å¼ç»ˆæ­¢è‡ªèº«ã€‚</p><p>ä¾‹å¦‚ï¼Œä½ å¯èƒ½æœ‰ä¸€ä¸ªå®¹å™¨ï¼Œä¸ºå…±äº«å·ä¸­çš„æ–‡ä»¶æä¾› Web æœåŠ¡å™¨æ”¯æŒï¼Œä»¥åŠä¸€ä¸ªå•ç‹¬çš„ â€œsidecarï¼ˆæŒ‚æ–—ï¼‰â€å®¹å™¨è´Ÿè´£ä»è¿œç«¯æ›´æ–°è¿™äº›æ–‡ä»¶ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://d33wubrfki0l68.cloudfront.net/aecab1f649bc640ebef1f05581bfcc91a48038c4/728d6/images/docs/pod.svg" alt="example pod diagram"></p><p>æœ‰äº› Pod å…·æœ‰ <a href="https://kubernetes.io/zh/docs/reference/glossary/?all=true#term-init-container" target="_blank" rel="noopener">Init å®¹å™¨</a> å’Œ <a href="https://kubernetes.io/zh/docs/reference/glossary/?all=true#term-app-container" target="_blank" rel="noopener">åº”ç”¨å®¹å™¨</a>ã€‚ Init å®¹å™¨ä¼šåœ¨å¯åŠ¨åº”ç”¨å®¹å™¨ä¹‹å‰è¿è¡Œå¹¶å®Œæˆã€‚</p><p>Pod å¤©ç”Ÿåœ°ä¸ºå…¶æˆå‘˜å®¹å™¨æä¾›äº†ä¸¤ç§å…±äº«èµ„æºï¼š<a href="https://kubernetes.io/zh/docs/concepts/workloads/pods/#pod-networking" target="_blank" rel="noopener">ç½‘ç»œ</a>å’Œ <a href="https://kubernetes.io/zh/docs/concepts/workloads/pods/#pod-storage" target="_blank" rel="noopener">å­˜å‚¨</a>ã€‚</p><h2 id="ä½¿ç”¨-Pod-1"><a href="#ä½¿ç”¨-Pod-1" class="headerlink" title="ä½¿ç”¨ Pod"></a>ä½¿ç”¨ Pod</h2><p>ä½ å¾ˆå°‘åœ¨ Kubernetes ä¸­ç›´æ¥åˆ›å»ºä¸€ä¸ªä¸ªçš„ Podï¼Œç”šè‡³æ˜¯å•å®ä¾‹ï¼ˆSingletonï¼‰çš„ Podã€‚ è¿™æ˜¯å› ä¸º Pod è¢«è®¾è®¡æˆäº†ç›¸å¯¹ä¸´æ—¶æ€§çš„ã€ç”¨åå³æŠ›çš„ä¸€æ¬¡æ€§å®ä½“ã€‚ å½“ Pod ç”±ä½ æˆ–è€…é—´æ¥åœ°ç”± <a href="https://kubernetes.io/docs/admin/kube-controller-manager/" target="_blank" rel="noopener">æ§åˆ¶å™¨</a> åˆ›å»ºæ—¶ï¼Œå®ƒè¢«è°ƒåº¦åœ¨é›†ç¾¤ä¸­çš„<a href="https://kubernetes.io/zh/docs/concepts/architecture/nodes/" target="_blank" rel="noopener">èŠ‚ç‚¹</a>ä¸Šè¿è¡Œã€‚ Pod ä¼šä¿æŒåœ¨è¯¥èŠ‚ç‚¹ä¸Šè¿è¡Œï¼Œç›´åˆ° Pod ç»“æŸæ‰§è¡Œã€Pod å¯¹è±¡è¢«åˆ é™¤ã€Pod å› èµ„æºä¸è¶³è€Œè¢« <em>é©±é€</em> æˆ–è€…èŠ‚ç‚¹å¤±æ•ˆä¸ºæ­¢ã€‚</p><blockquote><p><strong>è¯´æ˜ï¼š</strong> é‡å¯ Pod ä¸­çš„å®¹å™¨ä¸åº”ä¸é‡å¯ Pod æ··æ·†ã€‚ Pod ä¸æ˜¯è¿›ç¨‹ï¼Œè€Œæ˜¯å®¹å™¨è¿è¡Œçš„ç¯å¢ƒã€‚ åœ¨è¢«åˆ é™¤ä¹‹å‰ï¼ŒPod ä¼šä¸€ç›´å­˜åœ¨ã€‚</p></blockquote><p>å½“ä½ ä¸º Pod å¯¹è±¡åˆ›å»ºæ¸…å•æ—¶ï¼Œè¦ç¡®ä¿æ‰€æŒ‡å®šçš„ Pod åç§°æ˜¯åˆæ³•çš„ <a href="https://kubernetes.io/zh/docs/concepts/overview/working-with-objects/names#dns-subdomain-names" target="_blank" rel="noopener">DNS å­åŸŸå</a>ã€‚</p><h3 id="Pod-å’Œæ§åˆ¶å™¨"><a href="#Pod-å’Œæ§åˆ¶å™¨" class="headerlink" title="Pod å’Œæ§åˆ¶å™¨"></a>Pod å’Œæ§åˆ¶å™¨</h3><p>ä½ å¯ä»¥ä½¿ç”¨å·¥ä½œè´Ÿè½½èµ„æºæ¥åˆ›å»ºå’Œç®¡ç†å¤šä¸ª Podã€‚ èµ„æºçš„æ§åˆ¶å™¨èƒ½å¤Ÿå¤„ç†å‰¯æœ¬çš„ç®¡ç†ã€ä¸Šçº¿ï¼Œå¹¶åœ¨ Pod å¤±æ•ˆæ—¶æä¾›è‡ªæ„ˆèƒ½åŠ›ã€‚ ä¾‹å¦‚ï¼Œå¦‚æœä¸€ä¸ªèŠ‚ç‚¹å¤±è´¥ï¼Œæ§åˆ¶å™¨æ³¨æ„åˆ°è¯¥èŠ‚ç‚¹ä¸Šçš„ Pod å·²ç»åœæ­¢å·¥ä½œï¼Œ å°±å¯ä»¥åˆ›å»ºæ›¿æ¢æ€§çš„ Podã€‚è°ƒåº¦å™¨ä¼šå°†æ›¿èº« Pod è°ƒåº¦åˆ°ä¸€ä¸ªå¥åº·çš„èŠ‚ç‚¹æ‰§è¡Œã€‚</p><p>ä¸‹é¢æ˜¯ä¸€äº›ç®¡ç†ä¸€ä¸ªæˆ–è€…å¤šä¸ª Pod çš„å·¥ä½œè´Ÿè½½èµ„æºçš„ç¤ºä¾‹ï¼š</p><ul><li><a href="https://kubernetes.io/zh/docs/concepts/workloads/controllers/deployment/" target="_blank" rel="noopener">Deployment</a></li><li><a href="https://kubernetes.io/zh/docs/concepts/workloads/controllers/statefulset/" target="_blank" rel="noopener">StatefulSet</a></li><li><a href="https://kubernetes.io/zh/docs/concepts/workloads/controllers/daemonset/" target="_blank" rel="noopener">DaemonSet</a></li></ul><h3 id="Pod-æ¨¡ç‰ˆ"><a href="#Pod-æ¨¡ç‰ˆ" class="headerlink" title="Pod æ¨¡ç‰ˆ"></a>Pod æ¨¡ç‰ˆ</h3><p><a href="https://kubernetes.io/zh/docs/concepts/workloads/" target="_blank" rel="noopener">è´Ÿè½½</a>èµ„æºçš„æ§åˆ¶å™¨é€šå¸¸ä½¿ç”¨ <em>Pod æ¨¡æ¿ï¼ˆPod Templateï¼‰</em> æ¥æ›¿ä½ åˆ›å»º Pod å¹¶ç®¡ç†å®ƒä»¬ã€‚</p><p>Pod æ¨¡æ¿æ˜¯åŒ…å«åœ¨å·¥ä½œè´Ÿè½½å¯¹è±¡ä¸­çš„è§„èŒƒï¼Œç”¨æ¥åˆ›å»º Podã€‚è¿™ç±»è´Ÿè½½èµ„æºåŒ…æ‹¬ <a href="https://kubernetes.io/zh/docs/concepts/workloads/controllers/deployment/" target="_blank" rel="noopener">Deployment</a>ã€ <a href="https://kubernetes.io/zh/docs/concepts/workloads/controllers/job/" target="_blank" rel="noopener">Job</a> å’Œ <a href="https://kubernetes.io/zh/docs/concepts/workloads/controllers/daemonset/" target="_blank" rel="noopener">DaemonSets</a>ç­‰ã€‚</p><p>å·¥ä½œè´Ÿè½½çš„æ§åˆ¶å™¨ä¼šä½¿ç”¨è´Ÿè½½å¯¹è±¡ä¸­çš„ <code>PodTemplate</code> æ¥ç”Ÿæˆå®é™…çš„ Podã€‚ <code>PodTemplate</code> æ˜¯ä½ ç”¨æ¥è¿è¡Œåº”ç”¨æ—¶æŒ‡å®šçš„è´Ÿè½½èµ„æºçš„ç›®æ ‡çŠ¶æ€çš„ä¸€éƒ¨åˆ†ã€‚</p><p>ä¸‹é¢çš„ç¤ºä¾‹æ˜¯ä¸€ä¸ªç®€å•çš„ Job çš„æ¸…å•ï¼Œå…¶ä¸­çš„ <code>template</code> æŒ‡ç¤ºå¯åŠ¨ä¸€ä¸ªå®¹å™¨ã€‚ è¯¥ Pod ä¸­çš„å®¹å™¨ä¼šæ‰“å°ä¸€æ¡æ¶ˆæ¯ä¹‹åæš‚åœã€‚</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> batch/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Job<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> hello<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token comment" spellcheck="true"># è¿™é‡Œæ˜¯ Pod æ¨¡ç‰ˆ</span>    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> hello        <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox        <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'sh'</span><span class="token punctuation">,</span> <span class="token string">'-c'</span><span class="token punctuation">,</span> <span class="token string">'echo "Hello, Kubernetes!" &amp;&amp; sleep 3600'</span><span class="token punctuation">]</span>      <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> OnFailure    <span class="token comment" spellcheck="true"># ä»¥ä¸Šä¸º Pod æ¨¡ç‰ˆ</span></code></pre><p>ä¿®æ”¹ Pod æ¨¡ç‰ˆæˆ–è€…åˆ‡æ¢åˆ°æ–°çš„ Pod æ¨¡ç‰ˆéƒ½ä¸ä¼šå¯¹å·²ç»å­˜åœ¨çš„ Pod èµ·ä½œç”¨ã€‚ Pod ä¸ä¼šç›´æ¥æ”¶åˆ°æ¨¡ç‰ˆçš„æ›´æ–°ã€‚ç›¸åï¼Œ æ–°çš„ Pod ä¼šè¢«åˆ›å»ºå‡ºæ¥ï¼Œä¸æ›´æ”¹åçš„ Pod æ¨¡ç‰ˆåŒ¹é…ã€‚</p><p>ä¾‹å¦‚ï¼ŒDeployment æ§åˆ¶å™¨é’ˆå¯¹æ¯ä¸ª Deployment å¯¹è±¡ç¡®ä¿è¿è¡Œä¸­çš„ Pod ä¸å½“å‰çš„ Pod æ¨¡ç‰ˆåŒ¹é…ã€‚å¦‚æœæ¨¡ç‰ˆè¢«æ›´æ–°ï¼Œåˆ™ Deployment å¿…é¡»åˆ é™¤ç°æœ‰çš„ Podï¼ŒåŸºäºæ›´æ–°åçš„æ¨¡ç‰ˆ åˆ›å»ºæ–°çš„ Podã€‚æ¯ä¸ªå·¥ä½œè´Ÿè½½èµ„æºéƒ½å®ç°äº†è‡ªå·±çš„è§„åˆ™ï¼Œç”¨æ¥å¤„ç†å¯¹ Pod æ¨¡ç‰ˆçš„æ›´æ–°ã€‚</p><p>åœ¨èŠ‚ç‚¹ä¸Šï¼Œ<a href="https://kubernetes.io/docs/reference/generated/kubelet" target="_blank" rel="noopener">kubelet</a>å¹¶ä¸ç›´æ¥ç›‘æµ‹ æˆ–ç®¡ç†ä¸ Pod æ¨¡ç‰ˆç›¸å…³çš„ç»†èŠ‚æˆ–æ¨¡ç‰ˆçš„æ›´æ–°ï¼Œè¿™äº›ç»†èŠ‚éƒ½è¢«æŠ½è±¡å‡ºæ¥ã€‚ è¿™ç§æŠ½è±¡å’Œå…³æ³¨ç‚¹åˆ†ç¦»ç®€åŒ–äº†æ•´ä¸ªç³»ç»Ÿçš„è¯­ä¹‰ï¼Œå¹¶ä¸”ä½¿å¾—ç”¨æˆ·å¯ä»¥åœ¨ä¸æ”¹å˜ç°æœ‰ä»£ç çš„ å‰æä¸‹å°±èƒ½æ‰©å±•é›†ç¾¤çš„è¡Œä¸ºã€‚</p><h3 id="èµ„æºå…±äº«å’Œé€šä¿¡"><a href="#èµ„æºå…±äº«å’Œé€šä¿¡" class="headerlink" title="èµ„æºå…±äº«å’Œé€šä¿¡"></a>èµ„æºå…±äº«å’Œé€šä¿¡</h3><p>Pod ä½¿å®ƒçš„æˆå‘˜å®¹å™¨é—´èƒ½å¤Ÿè¿›è¡Œæ•°æ®å…±äº«å’Œé€šä¿¡ã€‚</p><h3 id="Pod-ä¸­çš„å­˜å‚¨"><a href="#Pod-ä¸­çš„å­˜å‚¨" class="headerlink" title="Pod ä¸­çš„å­˜å‚¨"></a>Pod ä¸­çš„å­˜å‚¨</h3><p>ä¸€ä¸ª Pod å¯ä»¥è®¾ç½®ä¸€ç»„å…±äº«çš„å­˜å‚¨<a href="https://kubernetes.io/zh/docs/concepts/storage/volumes/" target="_blank" rel="noopener">å·</a>ã€‚ Pod ä¸­çš„æ‰€æœ‰å®¹å™¨éƒ½å¯ä»¥è®¿é—®è¯¥å…±äº«å·ï¼Œä»è€Œå…è®¸è¿™äº›å®¹å™¨å…±äº«æ•°æ®ã€‚ å·è¿˜å…è®¸ Pod ä¸­çš„æŒä¹…æ•°æ®ä¿ç•™ä¸‹æ¥ï¼Œå³ä½¿å…¶ä¸­çš„å®¹å™¨éœ€è¦é‡æ–°å¯åŠ¨ã€‚ æœ‰å…³ Kubernetes å¦‚ä½•åœ¨ Pod ä¸­å®ç°å…±äº«å­˜å‚¨å¹¶å°†å…¶æä¾›ç»™ Pod çš„æ›´å¤šä¿¡æ¯ï¼Œ è¯·å‚è€ƒ<a href="https://kubernetes.io/zh/docs/concepts/storage/" target="_blank" rel="noopener">å·</a>ã€‚</p><h3 id="Pod-è”ç½‘"><a href="#Pod-è”ç½‘" class="headerlink" title="Pod è”ç½‘"></a>Pod è”ç½‘</h3><p>æ¯ä¸ª Pod éƒ½åœ¨æ¯ä¸ªåœ°å€æ—ä¸­è·å¾—ä¸€ä¸ªå”¯ä¸€çš„ IP åœ°å€ã€‚ Pod ä¸­çš„æ¯ä¸ªå®¹å™¨å…±äº«ç½‘ç»œåå­—ç©ºé—´ï¼ŒåŒ…æ‹¬ IP åœ°å€å’Œç½‘ç»œç«¯å£ã€‚ <em>Pod å†…</em> çš„å®¹å™¨å¯ä»¥ä½¿ç”¨ <code>localhost</code> äº’ç›¸é€šä¿¡ã€‚ å½“ Pod ä¸­çš„å®¹å™¨ä¸ <em>Pod ä¹‹å¤–</em> çš„å®ä½“é€šä¿¡æ—¶ï¼Œå®ƒä»¬å¿…é¡»åè°ƒå¦‚ä½•ä½¿ç”¨å…±äº«çš„ç½‘ç»œèµ„æº ï¼ˆä¾‹å¦‚ç«¯å£ï¼‰ã€‚</p><p>åœ¨åŒä¸€ä¸ª Pod å†…ï¼Œæ‰€æœ‰å®¹å™¨å…±äº«ä¸€ä¸ª IP åœ°å€å’Œç«¯å£ç©ºé—´ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡ <code>localhost</code> å‘ç°å¯¹æ–¹ã€‚ ä»–ä»¬ä¹Ÿèƒ½é€šè¿‡å¦‚ SystemV ä¿¡å·é‡æˆ– POSIX å…±äº«å†…å­˜è¿™ç±»æ ‡å‡†çš„è¿›ç¨‹é—´é€šä¿¡æ–¹å¼äº’ç›¸é€šä¿¡ã€‚ ä¸åŒ Pod ä¸­çš„å®¹å™¨çš„ IP åœ°å€äº’ä¸ç›¸åŒï¼Œæ²¡æœ‰ <a href="https://kubernetes.io/zh/docs/concepts/policy/pod-security-policy/" target="_blank" rel="noopener">ç‰¹æ®Šé…ç½®</a> å°±ä¸èƒ½ä½¿ç”¨ IPC è¿›è¡Œé€šä¿¡ã€‚ å¦‚æœæŸå®¹å™¨å¸Œæœ›ä¸è¿è¡Œäºå…¶ä»– Pod ä¸­çš„å®¹å™¨é€šä¿¡ï¼Œå¯ä»¥é€šè¿‡ IP è”ç½‘çš„æ–¹å¼å®ç°ã€‚</p><p>Pod ä¸­çš„å®¹å™¨æ‰€çœ‹åˆ°çš„ç³»ç»Ÿä¸»æœºåä¸ä¸º Pod é…ç½®çš„ <code>name</code> å±æ€§å€¼ç›¸åŒã€‚ <a href="https://kubernetes.io/zh/docs/concepts/cluster-administration/networking/" target="_blank" rel="noopener">ç½‘ç»œ</a>éƒ¨åˆ†æä¾›äº†æ›´å¤šæœ‰å…³æ­¤å†…å®¹çš„ä¿¡æ¯ã€‚</p><h2 id="å®¹å™¨çš„ç‰¹æƒæ¨¡å¼"><a href="#å®¹å™¨çš„ç‰¹æƒæ¨¡å¼" class="headerlink" title="å®¹å™¨çš„ç‰¹æƒæ¨¡å¼"></a>å®¹å™¨çš„ç‰¹æƒæ¨¡å¼</h2><p>Pod ä¸­çš„ä»»ä½•å®¹å™¨éƒ½å¯ä»¥ä½¿ç”¨å®¹å™¨è§„çº¦ä¸­çš„ <a href="https://kubernetes.io/docs/tasks/configure-pod-container/security-context/" target="_blank" rel="noopener">å®‰å…¨æ€§ä¸Šä¸‹æ–‡</a>ä¸­çš„ <code>privileged</code> å‚æ•°å¯ç”¨ç‰¹æƒæ¨¡å¼ã€‚ è¿™å¯¹äºæƒ³è¦ä½¿ç”¨ä½¿ç”¨æ“ä½œç³»ç»Ÿç®¡ç†æƒèƒ½ï¼ˆCapabilitiesï¼Œå¦‚æ“çºµç½‘ç»œå †æ ˆå’Œè®¿é—®è®¾å¤‡ï¼‰ çš„å®¹å™¨å¾ˆæœ‰ç”¨ã€‚ å®¹å™¨å†…çš„è¿›ç¨‹å‡ ä¹å¯ä»¥è·å¾—ä¸å®¹å™¨å¤–çš„è¿›ç¨‹ç›¸åŒçš„ç‰¹æƒã€‚</p><blockquote><p><strong>è¯´æ˜ï¼š</strong> ä½ çš„<a href="https://kubernetes.io/docs/reference/generated/container-runtime" target="_blank" rel="noopener">å®¹å™¨è¿è¡Œæ—¶</a>å¿…é¡»æ”¯æŒ ç‰¹æƒå®¹å™¨çš„æ¦‚å¿µæ‰èƒ½ä½¿ç”¨è¿™ä¸€é…ç½®ã€‚</p></blockquote><h2 id="é™æ€-Pod"><a href="#é™æ€-Pod" class="headerlink" title="é™æ€ Pod"></a>é™æ€ Pod</h2><p><em>é™æ€ Podï¼ˆStatic Podï¼‰</em> ç›´æ¥ç”±ç‰¹å®šèŠ‚ç‚¹ä¸Šçš„ <code>kubelet</code> å®ˆæŠ¤è¿›ç¨‹ç®¡ç†ï¼Œ ä¸éœ€è¦<a href="https://kubernetes.io/docs/reference/generated/kube-apiserver/" target="_blank" rel="noopener">API æœåŠ¡å™¨</a>çœ‹åˆ°å®ƒä»¬ã€‚ å°½ç®¡å¤§å¤šæ•° Pod éƒ½æ˜¯é€šè¿‡æ§åˆ¶é¢ï¼ˆä¾‹å¦‚ï¼Œ<a href="https://kubernetes.io/zh/docs/concepts/workloads/controllers/deployment/" target="_blank" rel="noopener">Deployment</a>ï¼‰ æ¥ç®¡ç†çš„ï¼Œå¯¹äºé™æ€ Pod è€Œè¨€ï¼Œ<code>kubelet</code> ç›´æ¥ç›‘æ§æ¯ä¸ª Podï¼Œå¹¶åœ¨å…¶å¤±æ•ˆæ—¶é‡å¯ä¹‹ã€‚</p><p>é™æ€ Pod é€šå¸¸ç»‘å®šåˆ°æŸä¸ªèŠ‚ç‚¹ä¸Šçš„ <a href="https://kubernetes.io/docs/reference/generated/kubelet" target="_blank" rel="noopener">kubelet</a>ã€‚ å…¶ä¸»è¦ç”¨é€”æ˜¯è¿è¡Œè‡ªæ‰˜ç®¡çš„æ§åˆ¶é¢ã€‚ åœ¨è‡ªæ‰˜ç®¡åœºæ™¯ä¸­ï¼Œä½¿ç”¨ <code>kubelet</code> æ¥ç®¡ç†å„ä¸ªç‹¬ç«‹çš„ <a href="https://kubernetes.io/zh/docs/concepts/overview/components/#control-plane-components" target="_blank" rel="noopener">æ§åˆ¶é¢ç»„ä»¶</a>ã€‚</p><p><code>kubelet</code> è‡ªåŠ¨å°è¯•ä¸ºæ¯ä¸ªé™æ€ Pod åœ¨ Kubernetes API æœåŠ¡å™¨ä¸Šåˆ›å»ºä¸€ä¸ª <a href="https://kubernetes.io/zh/docs/reference/glossary/?all=true#term-mirror-pod" target="_blank" rel="noopener">é•œåƒ Pod</a>ã€‚ è¿™æ„å‘³ç€åœ¨èŠ‚ç‚¹ä¸Šè¿è¡Œçš„ Pod åœ¨ API æœåŠ¡å™¨ä¸Šæ˜¯å¯è§çš„ï¼Œä½†ä¸å¯ä»¥é€šè¿‡ API æœåŠ¡å™¨æ¥æ§åˆ¶ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> å®¹å™¨ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Redis-å“¨å…µ</title>
      <link href="2020/10/05/sql/redis-shao-bing/"/>
      <url>2020/10/05/sql/redis-shao-bing/</url>
      
        <content type="html"><![CDATA[<h2 id="Rediså®•æœºåå¦‚ä½•å®ç°å¿«é€Ÿæ¢å¤"><a href="#Rediså®•æœºåå¦‚ä½•å®ç°å¿«é€Ÿæ¢å¤" class="headerlink" title="Rediså®•æœºåå¦‚ä½•å®ç°å¿«é€Ÿæ¢å¤"></a>Rediså®•æœºåå¦‚ä½•å®ç°å¿«é€Ÿæ¢å¤</h2><h3 id="ä¸€ã€éƒ¨ç½²æ¨¡å¼"><a href="#ä¸€ã€éƒ¨ç½²æ¨¡å¼" class="headerlink" title="ä¸€ã€éƒ¨ç½²æ¨¡å¼"></a>ä¸€ã€éƒ¨ç½²æ¨¡å¼</h3><p>Redisåœ¨éƒ¨ç½²æ—¶ï¼Œå¯ä»¥é‡‡ç”¨å¤šç§æ–¹å¼éƒ¨ç½²ï¼Œæ¯ç§éƒ¨ç½²æ–¹å¼å¯¹åº”ä¸åŒçš„å¯ç”¨çº§åˆ«ã€‚</p><ol><li><strong>å•èŠ‚ç‚¹éƒ¨ç½²</strong> ï¼šåªæœ‰ä¸€ä¸ªèŠ‚ç‚¹æä¾›æœåŠ¡ï¼Œè¯»å†™å‡åœ¨æ­¤èŠ‚ç‚¹ï¼Œæ­¤èŠ‚ç‚¹å®•æœºåˆ™æ•°æ®å…¨éƒ¨ä¸¢å¤±ï¼Œç›´æ¥å½±å“ä¸šåŠ¡ã€‚</li><li><strong>master-slaveæ–¹å¼éƒ¨ç½²</strong> ï¼šä¸¤ä¸ªèŠ‚ç‚¹ç»„æˆmaster-slaveæ¨¡å¼ï¼Œåœ¨masterä¸Šå†™å…¥ï¼Œslaveä¸Šè¯»å–ï¼Œè¯»å†™åˆ†ç¦»æé«˜è®¿é—®æ€§èƒ½ï¼Œmasterå®•æœºåï¼Œéœ€è¦æ‰‹åŠ¨æŠŠslaveæå‡ä¸ºmasterï¼Œä¸šåŠ¡å½±å“ç¨‹åº¦å–å†³äºæ‰‹åŠ¨æå‡masterçš„å»¶è¿Ÿã€‚</li><li><strong>master-slave+å“¨å…µæ–¹å¼éƒ¨ç½²</strong> ï¼šmaster-slaveä¸ä¸Šè¿°ç›¸åŒï¼Œä¸åŒçš„æ˜¯å¢åŠ ä¸€ç»„å“¨å…µèŠ‚ç‚¹ï¼Œç”¨äºå®æ—¶æ£€æŸ¥masterçš„å¥åº·çŠ¶æ€ï¼Œåœ¨masterå®•æœºåè‡ªåŠ¨æå‡slaveä¸ºæ–°çš„masterï¼Œæœ€å¤§ç¨‹åº¦é™ä½ä¸å¯ç”¨çš„æ—¶é—´ï¼Œå¯¹ä¸šåŠ¡å½±å“æ—¶é—´è¾ƒçŸ­ã€‚</li></ol><p>ä»ä¸Šé¢å‡ ç§éƒ¨ç½²æ¨¡å¼å¯ä»¥çœ‹å‡ºï¼Œæé«˜Rediså¯ç”¨æ€§çš„å…³é”®æ˜¯ï¼šå¤šå‰¯æœ¬éƒ¨ç½² + è‡ªåŠ¨æ•…éšœæ¢å¤ï¼Œè€Œå¤šå‰¯æœ¬æ­£æ˜¯ä¾èµ–ä¸»ä»å¤åˆ¶ã€‚</p><h3 id="äºŒã€å“¨å…µä»‹ç»"><a href="#äºŒã€å“¨å…µä»‹ç»" class="headerlink" title="äºŒã€å“¨å…µä»‹ç»"></a>äºŒã€å“¨å…µä»‹ç»</h3><p>å“¨å…µæ˜¯Redisé«˜å¯ç”¨çš„è§£å†³æ–¹æ¡ˆï¼Œå®ƒæ˜¯ä¸€ä¸ªç®¡ç†å¤šä¸ªRediså®ä¾‹çš„æœåŠ¡å·¥å…·ï¼Œå¯ä»¥å®ç°å¯¹Rediså®ä¾‹çš„ç›‘æ§ã€é€šçŸ¥ã€è‡ªåŠ¨æ•…éšœè½¬ç§»ã€‚</p><p>åœ¨éƒ¨ç½²å“¨å…µæ—¶ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨é…ç½®æ–‡ä»¶ä¸­é…ç½®éœ€è¦ç®¡ç†çš„masterèŠ‚ç‚¹ï¼Œå“¨å…µèŠ‚ç‚¹å°±å¯ä»¥æ ¹æ®é…ç½®ï¼Œå¯¹RedisèŠ‚ç‚¹è¿›è¡Œç®¡ç†ï¼Œå®ç°é«˜å¯ç”¨ã€‚</p><p><a href="https://imgchr.com/i/0ODWQS" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2020/10/18/0ODWQS.png" alt="0ODWQS.png"></a></p><p>ä¸€èˆ¬æˆ‘ä»¬éœ€è¦éƒ¨ç½²å¤šä¸ªå“¨å…µèŠ‚ç‚¹ï¼Œè¿™æ˜¯å› ä¸ºåœ¨åˆ†å¸ƒå¼åœºæ™¯ä¸‹ï¼Œè¦æƒ³ç¡®å®šæŸä¸ªæœºå™¨çš„æŸä¸ªèŠ‚ç‚¹ä¸Šå¦å‘ç”Ÿæ•…éšœï¼Œåªç”¨ä¸€å°æœºå™¨å»æ£€æµ‹å¯èƒ½æ˜¯ä¸å‡†ç¡®çš„ï¼Œå¾ˆæœ‰å¯èƒ½è¿™ä¸¤å°æœºå™¨çš„ç½‘ç»œå‘ç”Ÿäº†æ•…éšœï¼Œè€ŒèŠ‚ç‚¹æœ¬èº«å¹¶æ²¡æœ‰é—®é¢˜ã€‚</p><p>æ‰€ä»¥å¯¹äºèŠ‚ç‚¹å¥åº·æ£€æµ‹çš„åœºæ™¯ï¼Œä¸€èˆ¬éƒ½ä¼šé‡‡ç”¨å¤šä¸ªèŠ‚ç‚¹åŒæ—¶å»æ£€æµ‹ï¼Œä¸”å¤šä¸ªèŠ‚ç‚¹åˆ†å¸ƒåœ¨ä¸åŒæœºå™¨ä¸Šï¼ŒèŠ‚ç‚¹æ•°é‡ä¸ºå¥‡æ•°ä¸ªï¼Œé¿å…å› ä¸ºç½‘ç»œåˆ†åŒºå¯¼è‡´å“¨å…µå†³ç­–é”™è¯¯ã€‚è¿™æ ·å¤šä¸ªå“¨å…µèŠ‚ç‚¹äº’ç›¸äº¤æ¢æ£€æµ‹ä¿¡æ¯ï¼Œæœ€ç»ˆå†³ç­–æ‰èƒ½ç¡®è®¤æŸä¸ªèŠ‚ç‚¹ä¸Šå¦çœŸæ­£å‘ç”Ÿäº†é—®é¢˜ã€‚</p><p>å“¨å…µèŠ‚ç‚¹éƒ¨ç½²å¹¶é…ç½®å®Œæˆåï¼Œå“¨å…µå°±ä¼šè‡ªåŠ¨åœ°å¯¹é…ç½®çš„master-slaveè¿›è¡Œç®¡ç†ï¼Œåœ¨masterå‘ç”Ÿæ•…éšœæ—¶ï¼ŒåŠæ—¶åœ°æå‡slaveä¸ºæ–°çš„masterï¼Œä¿è¯å¯ç”¨æ€§ã€‚</p><h4 id="ä¸‰ã€å“¨å…µåŸç†"><a href="#ä¸‰ã€å“¨å…µåŸç†" class="headerlink" title="ä¸‰ã€å“¨å…µåŸç†"></a>ä¸‰ã€å“¨å…µåŸç†</h4><p>å“¨å…µçš„å·¥ä½œæµç¨‹ä¸»è¦åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªé˜¶æ®µï¼š</p><ul><li>çŠ¶æ€æ„ŸçŸ¥</li><li>å¿ƒè·³æ£€æµ‹</li><li>é€‰ä¸¾å“¨å…µé¢†å¯¼è€…</li><li>é€‰æ‹©æ–°çš„master</li><li>æ•…éšœæ¢å¤</li><li>å®¢æˆ·ç«¯æ„ŸçŸ¥æ–°master</li></ul><h4 id="1-çŠ¶æ€æ„ŸçŸ¥"><a href="#1-çŠ¶æ€æ„ŸçŸ¥" class="headerlink" title="1. çŠ¶æ€æ„ŸçŸ¥"></a>1. çŠ¶æ€æ„ŸçŸ¥</h4><p>å“¨å…µå¯åŠ¨ååªæŒ‡å®šäº†masterçš„åœ°å€ï¼Œå“¨å…µè¦æƒ³åœ¨masteræ•…éšœæ—¶è¿›è¡Œæ•…éšœæ¢å¤ï¼Œå°±éœ€è¦çŸ¥é“æ¯ä¸ªmasterå¯¹åº”çš„slaveä¿¡æ¯ã€‚æ¯ä¸ªmasterå¯èƒ½ä¸æ­¢ä¸€ä¸ªslaveï¼Œå› æ­¤å“¨å…µéœ€è¦çŸ¥é“æ•´ä¸ªé›†ç¾¤ä¸­å®Œæ•´çš„çš„æ‹“æ‰‘å…³ç³»ï¼Œå¦‚ä½•æ‹¿åˆ°è¿™äº›ä¿¡æ¯ï¼Ÿ</p><p>å“¨å…µæ¯éš”10ç§’ä¼šå‘æ¯ä¸ªmasterèŠ‚ç‚¹å‘é€infoå‘½ä»¤ï¼Œinfoå‘½ä»¤è¿”å›çš„ä¿¡æ¯ä¸­ï¼ŒåŒ…å«äº†ä¸»ä»æ‹“æ‰‘å…³ç³»ï¼Œå…¶ä¸­åŒ…æ‹¬æ¯ä¸ªslaveçš„åœ°å€å’Œç«¯å£å·ã€‚æœ‰äº†è¿™äº›ä¿¡æ¯åï¼Œå“¨å…µå°±ä¼šè®°ä½è¿™äº›èŠ‚ç‚¹çš„æ‹“æ‰‘ä¿¡æ¯ï¼Œåœ¨åç»­å‘ç”Ÿæ•…éšœæ—¶ï¼Œé€‰æ‹©åˆé€‚çš„slaveèŠ‚ç‚¹è¿›è¡Œæ•…éšœæ¢å¤ã€‚</p><p>å“¨å…µé™¤äº†å‘masterå‘é€infoä¹‹å¤–ï¼Œè¿˜ä¼šå‘æ¯ä¸ªmasterèŠ‚ç‚¹ç‰¹æ®Šçš„pubsubä¸­å‘é€masterå½“å‰çš„çŠ¶æ€ä¿¡æ¯å’Œå“¨å…µè‡ªèº«çš„ä¿¡æ¯ï¼Œå…¶ä»–å“¨å…µèŠ‚ç‚¹é€šè¿‡è®¢é˜…è¿™ä¸ªpubsubï¼Œå°±å¯ä»¥æ‹¿åˆ°æ¯ä¸ªå“¨å…µå‘æ¥çš„ä¿¡æ¯ã€‚</p><p>è¿™ä¹ˆåšçš„ç›®çš„ä¸»è¦æœ‰2ä¸ªï¼š</p><ul><li>å“¨å…µèŠ‚ç‚¹å¯ä»¥å‘ç°å…¶ä»–å“¨å…µçš„åŠ å…¥ï¼Œè¿›è€Œæ–¹ä¾¿å¤šä¸ªå“¨å…µèŠ‚ç‚¹é€šä¿¡ï¼Œä¸ºåç»­å…±åŒåå•†æä¾›åŸºç¡€</li><li>ä¸å…¶ä»–å“¨å…µèŠ‚ç‚¹äº¤æ¢masterçš„çŠ¶æ€ä¿¡æ¯ï¼Œä¸ºåç»­åˆ¤æ–­masteræ˜¯å¦æ•…éšœæä¾›ä¾æ®</li></ul><h4 id="2-å¿ƒè·³æ£€æµ‹"><a href="#2-å¿ƒè·³æ£€æµ‹" class="headerlink" title="2. å¿ƒè·³æ£€æµ‹"></a>2. å¿ƒè·³æ£€æµ‹</h4><p>åœ¨æ•…éšœå‘ç”Ÿæ—¶ï¼Œéœ€è¦ç«‹å³å¯åŠ¨æ•…éšœæ¢å¤æœºåˆ¶ï¼Œé‚£ä¹ˆå¦‚ä½•ä¿è¯åŠæ—¶æ€§å‘¢ï¼Ÿ</p><p>æ¯ä¸ªå“¨å…µèŠ‚ç‚¹æ¯éš”1ç§’å‘masterã€slaveã€å…¶ä»–å“¨å…µèŠ‚ç‚¹å‘é€pingå‘½ä»¤ï¼Œå¦‚æœå¯¹æ–¹èƒ½åœ¨æŒ‡å®šæ—¶é—´å†…å“åº”ï¼Œè¯´æ˜èŠ‚ç‚¹å¥åº·å­˜æ´»ã€‚å¦‚æœæœªåœ¨è§„å®šæ—¶é—´å†…ï¼ˆå¯é…ç½®ï¼‰å“åº”ï¼Œé‚£ä¹ˆè¯¥å“¨å…µèŠ‚ç‚¹è®¤ä¸ºæ­¤èŠ‚ç‚¹ä¸»è§‚ä¸‹çº¿ã€‚</p><h4 id="3-ä¸ºä»€ä¹ˆå«åšä¸»è§‚ä¸‹çº¿ï¼Ÿ"><a href="#3-ä¸ºä»€ä¹ˆå«åšä¸»è§‚ä¸‹çº¿ï¼Ÿ" class="headerlink" title="3. ä¸ºä»€ä¹ˆå«åšä¸»è§‚ä¸‹çº¿ï¼Ÿ"></a>3. ä¸ºä»€ä¹ˆå«åšä¸»è§‚ä¸‹çº¿ï¼Ÿ</h4><p>å› ä¸ºå½“å‰å“¨å…µèŠ‚ç‚¹æ¢æµ‹å¯¹æ–¹æ²¡æœ‰å¾—åˆ°å“åº”ï¼Œå¾ˆæœ‰å¯èƒ½è¿™ä¸¤ä¸ªæœºå™¨ä¹‹é—´çš„ç½‘ç»œå‘ç”Ÿäº†æ•…éšœï¼Œè€ŒmasterèŠ‚ç‚¹æœ¬èº«æ²¡æœ‰ä»»ä½•é—®é¢˜ï¼Œæ­¤æ—¶å°±è®¤ä¸ºmasteræ•…éšœæ˜¯ä¸æ­£ç¡®çš„ã€‚</p><p>è¦æƒ³ç¡®è®¤masterèŠ‚ç‚¹æ˜¯å¦çœŸæ­£å‘ç”Ÿæ•…éšœï¼Œå°±éœ€è¦å¤šä¸ªå“¨å…µèŠ‚ç‚¹å…±åŒç¡®è®¤æ‰è¡Œã€‚</p><p>æ¯ä¸ªå“¨å…µèŠ‚ç‚¹é€šè¿‡å‘å…¶ä»–å“¨å…µèŠ‚ç‚¹è¯¢é—®æ­¤masterçš„çŠ¶æ€ï¼Œæ¥å…±åŒç¡®è®¤æ­¤èŠ‚ç‚¹ä¸Šå¦çœŸæ­£æ•…éšœã€‚</p><p>å¦‚æœè¶…è¿‡æŒ‡å®šæ•°é‡ï¼ˆå¯é…ç½®ï¼‰çš„å“¨å…µèŠ‚ç‚¹éƒ½è®¤ä¸ºæ­¤èŠ‚ç‚¹ä¸»è§‚ä¸‹çº¿ï¼Œé‚£ä¹ˆæ‰ä¼šæŠŠè¿™ä¸ªèŠ‚ç‚¹æ ‡è®°ä¸ºå®¢è§‚ä¸‹çº¿ã€‚</p><h4 id="4-é€‰ä¸¾å“¨å…µé¢†å¯¼è€…"><a href="#4-é€‰ä¸¾å“¨å…µé¢†å¯¼è€…" class="headerlink" title="4. é€‰ä¸¾å“¨å…µé¢†å¯¼è€…"></a>4. é€‰ä¸¾å“¨å…µé¢†å¯¼è€…</h4><p>ç¡®è®¤è¿™ä¸ªèŠ‚ç‚¹çœŸæ­£æ•…éšœåï¼Œå°±éœ€è¦è¿›å…¥åˆ°æ•…éšœæ¢å¤é˜¶æ®µã€‚å¦‚ä½•è¿›è¡Œæ•…éšœæ¢å¤ï¼Œä¹Ÿéœ€è¦ç»å†ä¸€ç³»åˆ—æµç¨‹ã€‚</p><p>é¦–å…ˆéœ€è¦é€‰ä¸¾å‡ºä¸€ä¸ªå“¨å…µé¢†å¯¼è€…ï¼Œç”±è¿™ä¸ªä¸“é—¨çš„å“¨å…µé¢†å¯¼è€…æ¥è¿›è¡Œæ•…éšœæ¢å¤æ“ä½œï¼Œä¸ç”¨å¤šä¸ªå“¨å…µéƒ½å‚ä¸æ•…éšœæ¢å¤ã€‚é€‰ä¸¾å“¨å…µé¢†å¯¼è€…çš„è¿‡ç¨‹ï¼Œéœ€è¦å¤šä¸ªå“¨å…µèŠ‚ç‚¹å…±åŒåå•†æ¥é€‰å‡ºã€‚</p><p>è¿™ä¸ªé€‰ä¸¾åå•†çš„è¿‡ç¨‹ï¼Œåœ¨åˆ†å¸ƒå¼é¢†åŸŸä¸­å«åšè¾¾æˆå…±è¯†ï¼Œåå•†çš„ç®—æ³•å«åšå…±è¯†ç®—æ³•ã€‚</p><p>å…±è¯†ç®—æ³•ä¸»è¦ä¸ºäº†è§£å†³åœ¨åˆ†å¸ƒå¼åœºæ™¯ä¸‹ï¼Œå¤šä¸ªèŠ‚ç‚¹å¦‚ä½•é’ˆå¯¹æŸä¸€ä¸ªåœºæ™¯è¾¾æˆä¸€è‡´çš„ç»“æœã€‚</p><p>å…±è¯†ç®—æ³•åŒ…æ‹¬å¾ˆå¤šç§ï¼Œä¾‹å¦‚Paxosã€Raftã€Gossipç®—æ³•ç­‰ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥è‡ªè¡Œæœç´¢ç›¸å…³èµ„æ–™ï¼Œè¿™é‡Œä¸å†å±•å¼€æ¥è®²ã€‚</p><p>å“¨å…µé€‰ä¸¾é¢†å¯¼è€…çš„è¿‡ç¨‹ç±»ä¼¼äºRaftç®—æ³•ï¼Œå®ƒçš„ç®—æ³•è¶³å¤Ÿç®€å•æ˜“ç†è§£ã€‚</p><p>ç®€å•æ¥è®²æµç¨‹å¦‚ä¸‹ï¼š</p><ul><li>æ¯ä¸ªå“¨å…µéƒ½è®¾ç½®ä¸€ä¸ªéšæœºè¶…æ—¶æ—¶é—´ï¼Œè¶…æ—¶åå‘å…¶ä»–å“¨å…µå‘é€ç”³è¯·æˆä¸ºé¢†å¯¼è€…çš„è¯·æ±‚</li><li>å…¶ä»–å“¨å…µåªèƒ½å¯¹æ”¶åˆ°çš„ç¬¬ä¸€ä¸ªè¯·æ±‚è¿›è¡Œå›å¤ç¡®è®¤</li><li>é¦–å…ˆè¾¾åˆ°å¤šæ•°ç¡®è®¤é€‰ç¥¨çš„å“¨å…µèŠ‚ç‚¹ï¼Œæˆä¸ºé¢†å¯¼è€…</li><li>å¦‚æœåœ¨ç¡®è®¤å›å¤åï¼Œæ‰€æœ‰å“¨å…µéƒ½æ— æ³•è¾¾åˆ°å¤šæ•°é€‰ç¥¨çš„ç»“æœï¼Œé‚£ä¹ˆè¿›è¡Œé‡æ–°é€‰ä¸¾ï¼Œç›´åˆ°é€‰å‡ºé¢†å¯¼è€…ä¸ºæ­¢<br>é€‰æ‹©å‡ºå“¨å…µé¢†å¯¼è€…åï¼Œä¹‹åçš„æ•…éšœæ¢å¤æ“ä½œéƒ½ç”±è¿™ä¸ªå“¨å…µé¢†å¯¼è€…è¿›è¡Œæ“ä½œã€‚</li></ul><h4 id="5-é€‰æ‹©æ–°çš„master"><a href="#5-é€‰æ‹©æ–°çš„master" class="headerlink" title="5. é€‰æ‹©æ–°çš„master"></a>5. é€‰æ‹©æ–°çš„master</h4><p>å“¨å…µé¢†å¯¼è€…é’ˆå¯¹å‘ç”Ÿæ•…éšœçš„masterèŠ‚ç‚¹ï¼Œéœ€è¦åœ¨å®ƒçš„slaveèŠ‚ç‚¹ä¸­ï¼Œé€‰æ‹©ä¸€ä¸ªèŠ‚ç‚¹æ¥ä»£æ›¿å…¶å·¥ä½œã€‚</p><p>è¿™ä¸ªé€‰æ‹©æ–°masterè¿‡ç¨‹ä¹Ÿæ˜¯æœ‰ä¼˜å…ˆçº§çš„ï¼Œåœ¨å¤šä¸ªslaveçš„åœºæ™¯ä¸‹ï¼Œä¼˜å…ˆçº§æŒ‰ç…§ï¼šslave-priorityé…ç½® &gt; æ•°æ®å®Œæ•´æ€§ &gt; runidè¾ƒå°è€…è¿›è¡Œé€‰æ‹©ã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´ä¼˜å…ˆé€‰æ‹©slave-priorityæœ€å°å€¼çš„slaveèŠ‚ç‚¹ï¼Œå¦‚æœæ‰€æœ‰slaveæ­¤é…ç½®ç›¸åŒï¼Œé‚£ä¹ˆé€‰æ‹©æ•°æ®æœ€å®Œæ•´çš„slaveèŠ‚ç‚¹ï¼Œå¦‚æœæ•°æ®ä¹Ÿä¸€æ ·ï¼Œæœ€åé€‰æ‹©runidè¾ƒå°çš„slaveèŠ‚ç‚¹ã€‚</p><h4 id="6-æå‡æ–°çš„master"><a href="#6-æå‡æ–°çš„master" class="headerlink" title="6.æå‡æ–°çš„master"></a>6.æå‡æ–°çš„master</h4><p>ç»è¿‡ä¼˜å…ˆçº§é€‰æ‹©ï¼Œé€‰å‡ºäº†å¤‡é€‰çš„masterèŠ‚ç‚¹åï¼Œä¸‹ä¸€æ­¥å°±æ˜¯è¦è¿›è¡ŒçœŸæ­£çš„ä¸»ä»åˆ‡æ¢äº†ã€‚</p><p>å“¨å…µé¢†å¯¼è€…ç»™å¤‡é€‰çš„masterèŠ‚ç‚¹å‘é€slaveof no oneå‘½ä»¤ï¼Œè®©è¯¥èŠ‚ç‚¹æˆä¸ºmasterã€‚</p><p>ä¹‹åï¼Œå“¨å…µé¢†å¯¼è€…ä¼šç»™æ•…éšœèŠ‚ç‚¹çš„æ‰€æœ‰slaveå‘é€slaveof $newmasterå‘½ä»¤ï¼Œè®©è¿™äº›slaveæˆä¸ºæ–°masterçš„ä»èŠ‚ç‚¹ï¼Œå¼€å§‹ä»æ–°çš„masterä¸ŠåŒæ­¥æ•°æ®ã€‚</p><p>æœ€åå“¨å…µé¢†å¯¼è€…æŠŠæ•…éšœèŠ‚ç‚¹é™çº§ä¸ºslaveï¼Œå¹¶å†™å…¥åˆ°è‡ªå·±çš„é…ç½®æ–‡ä»¶ä¸­ï¼Œå¾…è¿™ä¸ªæ•…éšœèŠ‚ç‚¹æ¢å¤åï¼Œåˆ™è‡ªåŠ¨æˆä¸ºæ–°masterèŠ‚ç‚¹çš„slaveã€‚</p><p>è‡³æ­¤ï¼Œæ•´ä¸ªæ•…éšœåˆ‡æ¢å®Œæˆã€‚</p><h4 id="7-å®¢æˆ·ç«¯æ„ŸçŸ¥æ–°master"><a href="#7-å®¢æˆ·ç«¯æ„ŸçŸ¥æ–°master" class="headerlink" title="7. å®¢æˆ·ç«¯æ„ŸçŸ¥æ–°master"></a>7. å®¢æˆ·ç«¯æ„ŸçŸ¥æ–°master</h4><p>æœ€åï¼Œå®¢æˆ·ç«¯å¦‚ä½•æ‹¿åˆ°æœ€æ–°çš„masteråœ°å€å‘¢ï¼Ÿ</p><p>å“¨å…µåœ¨æ•…éšœåˆ‡æ¢å®Œæˆä¹‹åï¼Œä¼šå‘è‡ªèº«èŠ‚ç‚¹çš„æŒ‡å®špubsubä¸­å†™å…¥ä¸€æ¡ä¿¡æ¯ï¼Œå®¢æˆ·ç«¯å¯ä»¥è®¢é˜…è¿™ä¸ªpubsubæ¥æ„ŸçŸ¥masterçš„å˜åŒ–é€šçŸ¥ã€‚æˆ‘ä»¬çš„å®¢æˆ·ç«¯ä¹Ÿå¯ä»¥é€šè¿‡åœ¨å“¨å…µèŠ‚ç‚¹ä¸»åŠ¨æŸ¥è¯¢å½“å‰æœ€æ–°çš„masterï¼Œæ¥æ‹¿åˆ°æœ€æ–°çš„masteråœ°å€ã€‚</p><p>å¦å¤–ï¼Œå“¨å…µè¿˜æä¾›äº†â€œé’©å­â€æœºåˆ¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨å“¨å…µé…ç½®æ–‡ä»¶ä¸­é…ç½®ä¸€äº›è„šæœ¬é€»è¾‘ï¼Œåœ¨æ•…éšœåˆ‡æ¢å®Œæˆæ—¶ï¼Œè§¦å‘â€œé’©å­â€é€»è¾‘ï¼Œé€šçŸ¥å®¢æˆ·ç«¯å‘ç”Ÿäº†åˆ‡æ¢ï¼Œè®©å®¢æˆ·ç«¯é‡æ–°åœ¨å“¨å…µä¸Šè·å–æœ€æ–°çš„masteråœ°å€ã€‚</p><p>ä¸€èˆ¬æ¥è¯´ï¼Œæ¨èé‡‡ç”¨ç¬¬ä¸€ç§æ–¹å¼è¿›è¡Œå¤„ç†ï¼Œå¾ˆå¤šå®¢æˆ·ç«¯SDKä¸­å·²ç»é›†æˆå¥½äº†ä»å“¨å…µèŠ‚ç‚¹è·å–æœ€æ–°masterçš„æ–¹æ³•ï¼Œæˆ‘ä»¬ç›´æ¥ä½¿ç”¨å³å¯ã€‚</p><h3 id="å››ã€PS"><a href="#å››ã€PS" class="headerlink" title="å››ã€PS"></a>å››ã€PS</h3><p>å¯è§ï¼Œä¸ºäº†ä¿è¯Redisçš„é«˜å¯ç”¨ï¼Œå“¨å…µèŠ‚ç‚¹è¦å‡†ç¡®æ— è¯¯åœ°åˆ¤æ–­æ•…éšœçš„å‘ç”Ÿï¼Œå¹¶ä¸”å¿«é€Ÿçš„é€‰å‡ºæ–°çš„èŠ‚ç‚¹æ¥ä»£æ›¿å…¶æä¾›æœåŠ¡ï¼Œè¿™ä¸­é—´çš„æµç¨‹è¿˜æ˜¯æ¯”è¾ƒå¤æ‚çš„ã€‚</p><p>ä¸­é—´æ¶‰åŠåˆ°äº†åˆ†å¸ƒå¼å…±è¯†ã€åˆ†å¸ƒå¼åå•†ç­‰çŸ¥è¯†ï¼Œç›®çš„éƒ½æ˜¯ä¸ºäº†ä¿è¯æ•…éšœåˆ‡æ¢çš„å‡†ç¡®æ€§ã€‚</p><p>æˆ‘ä»¬æœ‰å¿…è¦äº†è§£Redisé«˜å¯ç”¨çš„å·¥ä½œåŸç†ï¼Œè¿™æ ·æˆ‘ä»¬åœ¨ä½¿ç”¨Redisæ—¶èƒ½æ›´å‡†ç¡®åœ°ä½¿ç”¨å®ƒã€‚</p>]]></content>
      
      
      <categories>
          
          <category> SQL </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Redis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kubernetesæ¶æ„-æ§åˆ¶å™¨</title>
      <link href="2020/10/03/rong-qi/kubernetes-jia-gou-kong-zhi-qi/"/>
      <url>2020/10/03/rong-qi/kubernetes-jia-gou-kong-zhi-qi/</url>
      
        <content type="html"><![CDATA[<h1 id="æ§åˆ¶å™¨"><a href="#æ§åˆ¶å™¨" class="headerlink" title="æ§åˆ¶å™¨"></a>æ§åˆ¶å™¨</h1><p>åœ¨æœºå™¨äººæŠ€æœ¯å’Œè‡ªåŠ¨åŒ–é¢†åŸŸï¼Œæ§åˆ¶å›è·¯ï¼ˆControl Loopï¼‰æ˜¯ä¸€ä¸ªéç»ˆæ­¢å›è·¯ï¼Œç”¨äºè°ƒèŠ‚ç³»ç»ŸçŠ¶æ€ã€‚</p><p>è¿™æ˜¯ä¸€ä¸ªæ§åˆ¶ç¯çš„ä¾‹å­ï¼šæˆ¿é—´é‡Œçš„æ¸©åº¦è‡ªåŠ¨è°ƒèŠ‚å™¨ã€‚</p><p>å½“ä½ è®¾ç½®äº†æ¸©åº¦ï¼Œå‘Šè¯‰äº†æ¸©åº¦è‡ªåŠ¨è°ƒèŠ‚å™¨ä½ çš„<em>æœŸæœ›çŠ¶æ€ï¼ˆDesired Stateï¼‰</em>ã€‚ æˆ¿é—´çš„å®é™…æ¸©åº¦æ˜¯<em>å½“å‰çŠ¶æ€ï¼ˆCurrent Stateï¼‰</em>ã€‚ é€šè¿‡å¯¹è®¾å¤‡çš„å¼€å…³æ§åˆ¶ï¼Œæ¸©åº¦è‡ªåŠ¨è°ƒèŠ‚å™¨è®©å…¶å½“å‰çŠ¶æ€æ¥è¿‘æœŸæœ›çŠ¶æ€ã€‚</p><p>æ§åˆ¶å™¨é€šè¿‡ </p><p>apiserver</p><p> ç›‘æ§é›†ç¾¤çš„å…¬å…±çŠ¶æ€ï¼Œå¹¶è‡´åŠ›äºå°†å½“å‰çŠ¶æ€è½¬å˜ä¸ºæœŸæœ›çš„çŠ¶æ€ã€‚</p><h2 id="æ§åˆ¶å™¨æ¨¡å¼"><a href="#æ§åˆ¶å™¨æ¨¡å¼" class="headerlink" title="æ§åˆ¶å™¨æ¨¡å¼"></a>æ§åˆ¶å™¨æ¨¡å¼</h2><p>ä¸€ä¸ªæ§åˆ¶å™¨è‡³å°‘è¿½è¸ªä¸€ç§ç±»å‹çš„ Kubernetes èµ„æºã€‚è¿™äº› <a href="https://kubernetes.io/zh/docs/concepts/overview/working-with-objects/kubernetes-objects/" target="_blank" rel="noopener">å¯¹è±¡</a> æœ‰ä¸€ä¸ªä»£è¡¨æœŸæœ›çŠ¶æ€çš„ <code>spec</code> å­—æ®µã€‚ è¯¥èµ„æºçš„æ§åˆ¶å™¨è´Ÿè´£ç¡®ä¿å…¶å½“å‰çŠ¶æ€æ¥è¿‘æœŸæœ›çŠ¶æ€ã€‚</p><p>æ§åˆ¶å™¨å¯èƒ½ä¼šè‡ªè¡Œæ‰§è¡Œæ“ä½œï¼›åœ¨ Kubernetes ä¸­æ›´å¸¸è§çš„æ˜¯ä¸€ä¸ªæ§åˆ¶å™¨ä¼šå‘é€ä¿¡æ¯ç»™ <a href="https://kubernetes.io/docs/reference/generated/kube-apiserver/" target="_blank" rel="noopener">API æœåŠ¡å™¨</a>ï¼Œè¿™ä¼šæœ‰å‰¯ä½œç”¨ã€‚ å…·ä½“å¯å‚çœ‹åæ–‡çš„ä¾‹å­ã€‚</p><h3 id="é€šè¿‡-API-æœåŠ¡å™¨æ¥æ§åˆ¶"><a href="#é€šè¿‡-API-æœåŠ¡å™¨æ¥æ§åˆ¶" class="headerlink" title="é€šè¿‡ API æœåŠ¡å™¨æ¥æ§åˆ¶"></a>é€šè¿‡ API æœåŠ¡å™¨æ¥æ§åˆ¶</h3><p><a href="https://kubernetes.io/docs/concepts/workloads/controllers/jobs-run-to-completion" target="_blank" rel="noopener">Job</a> æ§åˆ¶å™¨æ˜¯ä¸€ä¸ª Kubernetes å†…ç½®æ§åˆ¶å™¨çš„ä¾‹å­ã€‚ å†…ç½®æ§åˆ¶å™¨é€šè¿‡å’Œé›†ç¾¤ API æœåŠ¡å™¨äº¤äº’æ¥ç®¡ç†çŠ¶æ€ã€‚</p><p>Job æ˜¯ä¸€ç§ Kubernetes èµ„æºï¼Œå®ƒè¿è¡Œä¸€ä¸ªæˆ–è€…å¤šä¸ª <a href="https://kubernetes.io/docs/concepts/workloads/pods/pod-overview/" target="_blank" rel="noopener">Pod</a>ï¼Œ æ¥æ‰§è¡Œä¸€ä¸ªä»»åŠ¡ç„¶ååœæ­¢ã€‚ ï¼ˆä¸€æ—¦<a href="https://kubernetes.io/zh/docs/concepts/scheduling-eviction/" target="_blank" rel="noopener">è¢«è°ƒåº¦äº†</a>ï¼Œå¯¹ <code>kubelet</code> æ¥è¯´ Pod å¯¹è±¡å°±ä¼šå˜æˆäº†æœŸæœ›çŠ¶æ€çš„ä¸€éƒ¨åˆ†ï¼‰ã€‚</p><p>åœ¨é›†ç¾¤ä¸­ï¼Œå½“ Job æ§åˆ¶å™¨æ‹¿åˆ°æ–°ä»»åŠ¡æ—¶ï¼Œå®ƒä¼šä¿è¯ä¸€ç»„ Node èŠ‚ç‚¹ä¸Šçš„ <code>kubelet</code> å¯ä»¥è¿è¡Œæ­£ç¡®æ•°é‡çš„ Pod æ¥å®Œæˆå·¥ä½œã€‚ Job æ§åˆ¶å™¨ä¸ä¼šè‡ªå·±è¿è¡Œä»»ä½•çš„ Pod æˆ–è€…å®¹å™¨ã€‚Job æ§åˆ¶å™¨æ˜¯é€šçŸ¥ API æœåŠ¡å™¨æ¥åˆ›å»ºæˆ–è€…ç§»é™¤ Podã€‚ <a href="https://kubernetes.io/zh/docs/reference/glossary/?all=true#term-control-plane" target="_blank" rel="noopener">æ§åˆ¶é¢</a>ä¸­çš„å…¶å®ƒç»„ä»¶ æ ¹æ®æ–°çš„æ¶ˆæ¯ä½œå‡ºååº”ï¼ˆè°ƒåº¦å¹¶è¿è¡Œæ–° Podï¼‰å¹¶ä¸”æœ€ç»ˆå®Œæˆå·¥ä½œã€‚</p><p>åˆ›å»ºæ–° Job åï¼Œæ‰€æœŸæœ›çš„çŠ¶æ€å°±æ˜¯å®Œæˆè¿™ä¸ª Jobã€‚Job æ§åˆ¶å™¨ä¼šè®© Job çš„å½“å‰çŠ¶æ€ä¸æ–­æ¥è¿‘æœŸæœ›çŠ¶æ€ï¼šåˆ›å»ºä¸º Job è¦å®Œæˆå·¥ä½œæ‰€éœ€è¦çš„ Podï¼Œä½¿ Job çš„çŠ¶æ€æ¥è¿‘å®Œæˆã€‚</p><p>æ§åˆ¶å™¨ä¹Ÿä¼šæ›´æ–°é…ç½®å¯¹è±¡ã€‚ä¾‹å¦‚ï¼šä¸€æ—¦ Job çš„å·¥ä½œå®Œæˆäº†ï¼ŒJob æ§åˆ¶å™¨ä¼šæ›´æ–° Job å¯¹è±¡çš„çŠ¶æ€ä¸º <code>Finished</code>ã€‚</p><p>ï¼ˆè¿™æœ‰ç‚¹åƒæ¸©åº¦è‡ªåŠ¨è°ƒèŠ‚å™¨å…³é—­äº†ä¸€ä¸ªç¯ï¼Œä»¥æ­¤æ¥å‘Šè¯‰ä½ æˆ¿é—´çš„æ¸©åº¦ç°åœ¨åˆ°ä½ è®¾å®šçš„å€¼äº†ï¼‰ã€‚</p><h3 id="ç›´æ¥æ§åˆ¶"><a href="#ç›´æ¥æ§åˆ¶" class="headerlink" title="ç›´æ¥æ§åˆ¶"></a>ç›´æ¥æ§åˆ¶</h3><p>ç›¸æ¯” Job æ§åˆ¶å™¨ï¼Œæœ‰äº›æ§åˆ¶å™¨éœ€è¦å¯¹é›†ç¾¤å¤–çš„ä¸€äº›ä¸œè¥¿è¿›è¡Œä¿®æ”¹ã€‚</p><p>ä¾‹å¦‚ï¼Œå¦‚æœä½ ä½¿ç”¨ä¸€ä¸ªæ§åˆ¶ç¯æ¥ä¿è¯é›†ç¾¤ä¸­æœ‰è¶³å¤Ÿçš„<a href="https://kubernetes.io/zh/docs/concepts/architecture/nodes/" target="_blank" rel="noopener">èŠ‚ç‚¹</a>ï¼Œé‚£ä¹ˆæ§åˆ¶å°±éœ€è¦å½“å‰é›†ç¾¤å¤–çš„ä¸€äº›æœåŠ¡åœ¨éœ€è¦æ—¶åˆ›å»ºæ–°èŠ‚ç‚¹ã€‚</p><p>å’Œå¤–éƒ¨çŠ¶æ€äº¤äº’çš„æ§åˆ¶å™¨ä» API æœåŠ¡å™¨è·å–åˆ°å®ƒæƒ³è¦çš„çŠ¶æ€ï¼Œç„¶åç›´æ¥å’Œå¤–éƒ¨ç³»ç»Ÿè¿›è¡Œé€šä¿¡å¹¶ä½¿å½“å‰çŠ¶æ€æ›´æ¥è¿‘æœŸæœ›çŠ¶æ€ã€‚</p><p>ï¼ˆå®é™…ä¸Šæœ‰ä¸€ä¸ªæ§åˆ¶å™¨å¯ä»¥æ°´å¹³åœ°æ‰©å±•é›†ç¾¤ä¸­çš„èŠ‚ç‚¹ã€‚è¯·å‚é˜… <a href="https://kubernetes.io/zh/docs/tasks/administer-cluster/cluster-management/#cluster-autoscaling" target="_blank" rel="noopener">é›†ç¾¤è‡ªåŠ¨æ‰©ç¼©å®¹</a>ï¼‰ã€‚</p><h2 id="æœŸæœ›çŠ¶æ€ä¸å½“å‰çŠ¶æ€"><a href="#æœŸæœ›çŠ¶æ€ä¸å½“å‰çŠ¶æ€" class="headerlink" title="æœŸæœ›çŠ¶æ€ä¸å½“å‰çŠ¶æ€"></a>æœŸæœ›çŠ¶æ€ä¸å½“å‰çŠ¶æ€</h2><p>Kubernetes é‡‡ç”¨äº†ç³»ç»Ÿçš„äº‘åŸç”Ÿè§†å›¾ï¼Œå¹¶ä¸”å¯ä»¥å¤„ç†æŒç»­çš„å˜åŒ–ã€‚</p><p>åœ¨ä»»åŠ¡æ‰§è¡Œæ—¶ï¼Œé›†ç¾¤éšæ—¶éƒ½å¯èƒ½è¢«ä¿®æ”¹ï¼Œå¹¶ä¸”æ§åˆ¶å›è·¯ä¼šè‡ªåŠ¨ä¿®å¤æ•…éšœã€‚è¿™æ„å‘³ç€å¾ˆå¯èƒ½é›†ç¾¤æ°¸è¿œä¸ä¼šè¾¾åˆ°ç¨³å®šçŠ¶æ€ã€‚</p><p>åªè¦é›†ç¾¤ä¸­æ§åˆ¶å™¨çš„åœ¨è¿è¡Œå¹¶ä¸”è¿›è¡Œæœ‰æ•ˆçš„ä¿®æ”¹ï¼Œæ•´ä½“çŠ¶æ€çš„ç¨³å®šä¸å¦æ˜¯æ— å…³ç´§è¦çš„ã€‚</p><h2 id="è®¾è®¡"><a href="#è®¾è®¡" class="headerlink" title="è®¾è®¡"></a>è®¾è®¡</h2><p>ä½œä¸ºè®¾è®¡åŸåˆ™ä¹‹ä¸€ï¼ŒKubernetes ä½¿ç”¨äº†å¾ˆå¤šæ§åˆ¶å™¨ï¼Œæ¯ä¸ªæ§åˆ¶å™¨ç®¡ç†é›†ç¾¤çŠ¶æ€çš„ä¸€ä¸ªç‰¹å®šæ–¹é¢ã€‚ æœ€å¸¸è§çš„ä¸€ä¸ªç‰¹å®šçš„æ§åˆ¶å™¨ä½¿ç”¨ä¸€ç§ç±»å‹çš„èµ„æºä½œä¸ºå®ƒçš„æœŸæœ›çŠ¶æ€ï¼Œ æ§åˆ¶å™¨ç®¡ç†æ§åˆ¶å¦å¤–ä¸€ç§ç±»å‹çš„èµ„æºå‘å®ƒçš„æœŸæœ›çŠ¶æ€æ¼”åŒ–ã€‚</p><p>ä½¿ç”¨ç®€å•çš„æ§åˆ¶å™¨è€Œä¸æ˜¯ä¸€ç»„ç›¸äº’è¿æ¥çš„å•ä½“æ§åˆ¶å›è·¯æ˜¯å¾ˆæœ‰ç”¨çš„ã€‚ æ§åˆ¶å™¨ä¼šå¤±è´¥ï¼Œæ‰€ä»¥ Kubernetes çš„è®¾è®¡æ­£æ˜¯è€ƒè™‘åˆ°äº†è¿™ä¸€ç‚¹ã€‚</p><blockquote><p>è¯´æ˜ï¼š</p><p>å¯ä»¥æœ‰å¤šä¸ªæ§åˆ¶å™¨æ¥åˆ›å»ºæˆ–è€…æ›´æ–°ç›¸åŒç±»å‹çš„å¯¹è±¡ã€‚ åœ¨åå°ï¼ŒKubernetes æ§åˆ¶å™¨ç¡®ä¿å®ƒä»¬åªå…³å¿ƒä¸å…¶æ§åˆ¶èµ„æºç›¸å…³è”çš„èµ„æºã€‚</p><p>ä¾‹å¦‚ï¼Œä½ å¯ä»¥åˆ›å»º Deployment å’Œ Jobï¼›å®ƒä»¬éƒ½å¯ä»¥åˆ›å»º Podã€‚ Job æ§åˆ¶å™¨ä¸ä¼šåˆ é™¤ Deployment æ‰€åˆ›å»ºçš„ Podï¼Œå› ä¸ºæœ‰ä¿¡æ¯ ï¼ˆ<a href="https://kubernetes.io/zh/docs/concepts/overview/working-with-objects/labels/" target="_blank" rel="noopener">æ ‡ç­¾</a>ï¼‰è®©æ§åˆ¶å™¨å¯ä»¥åŒºåˆ†è¿™äº› Podã€‚</p></blockquote><h2 id="è¿è¡Œæ§åˆ¶å™¨çš„æ–¹å¼"><a href="#è¿è¡Œæ§åˆ¶å™¨çš„æ–¹å¼" class="headerlink" title="è¿è¡Œæ§åˆ¶å™¨çš„æ–¹å¼"></a>è¿è¡Œæ§åˆ¶å™¨çš„æ–¹å¼</h2><p>Kubernetes å†…ç½®ä¸€ç»„æ§åˆ¶å™¨ï¼Œè¿è¡Œåœ¨ <a href="https://kubernetes.io/docs/reference/generated/kube-controller-manager/" target="_blank" rel="noopener">kube-controller-manager</a> å†…ã€‚ è¿™äº›å†…ç½®çš„æ§åˆ¶å™¨æä¾›äº†é‡è¦çš„æ ¸å¿ƒåŠŸèƒ½ã€‚</p><p>Deployment æ§åˆ¶å™¨å’Œ Job æ§åˆ¶å™¨æ˜¯ Kubernetes å†…ç½®æ§åˆ¶å™¨çš„å…¸å‹ä¾‹å­ã€‚ Kubernetes å…è®¸ä½ è¿è¡Œä¸€ä¸ªç¨³å®šçš„æ§åˆ¶å¹³é¢ï¼Œè¿™æ ·å³ä½¿æŸäº›å†…ç½®æ§åˆ¶å™¨å¤±è´¥äº†ï¼Œ æ§åˆ¶å¹³é¢çš„å…¶ä»–éƒ¨åˆ†ä¼šæ¥æ›¿å®ƒä»¬çš„å·¥ä½œã€‚</p><p>ä½ ä¼šé‡åˆ°æŸäº›æ§åˆ¶å™¨è¿è¡Œåœ¨æ§åˆ¶é¢ä¹‹å¤–ï¼Œç”¨ä»¥æ‰©å±• Kubernetesã€‚ æˆ–è€…ï¼Œå¦‚æœä½ æ„¿æ„ï¼Œä½ ä¹Ÿå¯ä»¥è‡ªå·±ç¼–å†™æ–°æ§åˆ¶å™¨ã€‚ ä½ å¯ä»¥ä»¥ä¸€ç»„ Pod æ¥è¿è¡Œä½ çš„æ§åˆ¶å™¨ï¼Œæˆ–è€…è¿è¡Œåœ¨ Kubernetes ä¹‹å¤–ã€‚ æœ€åˆé€‚çš„æ–¹æ¡ˆå–å†³äºæ§åˆ¶å™¨æ‰€è¦æ‰§è¡Œçš„åŠŸèƒ½æ˜¯ä»€ä¹ˆã€‚</p>]]></content>
      
      
      <categories>
          
          <category> å®¹å™¨ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kubernetesæ¶æ„-èŠ‚ç‚¹</title>
      <link href="2020/10/03/rong-qi/kubernetes-jia-gou-jie-dian/"/>
      <url>2020/10/03/rong-qi/kubernetes-jia-gou-jie-dian/</url>
      
        <content type="html"><![CDATA[<h1 id="èŠ‚ç‚¹"><a href="#èŠ‚ç‚¹" class="headerlink" title="èŠ‚ç‚¹"></a>èŠ‚ç‚¹</h1><p>Kubernetes é€šè¿‡å°†å®¹å™¨æ”¾å…¥åœ¨èŠ‚ç‚¹ï¼ˆNodeï¼‰ä¸Šè¿è¡Œçš„ Pod ä¸­æ¥æ‰§è¡Œä½ çš„å·¥ä½œè´Ÿè½½ã€‚ èŠ‚ç‚¹å¯ä»¥æ˜¯ä¸€ä¸ªè™šæ‹Ÿæœºæˆ–è€…ç‰©ç†æœºå™¨ï¼Œå–å†³äºæ‰€åœ¨çš„é›†ç¾¤é…ç½®ã€‚æ¯ä¸ªèŠ‚ç‚¹éƒ½åŒ…å«ç”¨äºè¿è¡Œ <a href="https://kubernetes.io/docs/concepts/workloads/pods/pod-overview/" target="_blank" rel="noopener">Pod</a> æ‰€éœ€è¦çš„æœåŠ¡ï¼Œè¿™äº›æœåŠ¡ç”± <a href="https://kubernetes.io/zh/docs/reference/glossary/?all=true#term-control-plane" target="_blank" rel="noopener">æ§åˆ¶é¢</a>è´Ÿè´£ç®¡ç†ã€‚</p><p>é€šå¸¸é›†ç¾¤ä¸­ä¼šæœ‰è‹¥å¹²ä¸ªèŠ‚ç‚¹ï¼›è€Œåœ¨ä¸€ä¸ªå­¦ä¹ ç”¨æˆ–è€…èµ„æºå—é™çš„ç¯å¢ƒä¸­ï¼Œä½ çš„é›†ç¾¤ä¸­ä¹Ÿå¯èƒ½ åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹ã€‚</p><p>èŠ‚ç‚¹ä¸Šçš„<a href="https://kubernetes.io/zh/docs/concepts/overview/components/#node-components" target="_blank" rel="noopener">ç»„ä»¶</a>åŒ…æ‹¬ <a href="https://kubernetes.io/docs/reference/generated/kubelet" target="_blank" rel="noopener">kubelet</a>ã€ <a href="https://kubernetes.io/docs/reference/generated/container-runtime" target="_blank" rel="noopener">å®¹å™¨è¿è¡Œæ—¶</a>ä»¥åŠ <a href="https://kubernetes.io/zh/docs/reference/command-line-tools-reference/kube-proxy/" target="_blank" rel="noopener">kube-proxy</a>ã€‚</p><h2 id="ç®¡ç†"><a href="#ç®¡ç†" class="headerlink" title="ç®¡ç†"></a>ç®¡ç†</h2><p>å‘ <a href="https://kubernetes.io/docs/reference/generated/kube-apiserver/" target="_blank" rel="noopener">API æœåŠ¡å™¨</a>æ·»åŠ èŠ‚ç‚¹çš„æ–¹å¼ä¸»è¦æœ‰ä¸¤ç§ï¼š</p><ol><li>èŠ‚ç‚¹ä¸Šçš„ <code>kubelet</code> å‘æ§åˆ¶é¢æ‰§è¡Œè‡ªæ³¨å†Œï¼›</li><li>ä½ ï¼Œæˆ–è€…åˆ«çš„ä»€ä¹ˆäººï¼Œæ‰‹åŠ¨æ·»åŠ ä¸€ä¸ª Node å¯¹è±¡ã€‚</li></ol><p>åœ¨ä½ åˆ›å»ºäº† Node å¯¹è±¡æˆ–è€…èŠ‚ç‚¹ä¸Šçš„ <code>kubelet</code> æ‰§è¡Œäº†è‡ªæ³¨å†Œæ“ä½œä¹‹åï¼Œ æ§åˆ¶é¢ä¼šæ£€æŸ¥æ–°çš„ Node å¯¹è±¡æ˜¯å¦åˆæ³•ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ ä½¿ç”¨ä¸‹é¢çš„ JSON å¯¹è±¡æ¥åˆ›å»º Node å¯¹è±¡ï¼š</p><pre class=" language-json"><code class="language-json"><span class="token punctuation">{</span>  <span class="token property">"kind"</span><span class="token operator">:</span> <span class="token string">"Node"</span><span class="token punctuation">,</span>  <span class="token property">"apiVersion"</span><span class="token operator">:</span> <span class="token string">"v1"</span><span class="token punctuation">,</span>  <span class="token property">"metadata"</span><span class="token operator">:</span> <span class="token punctuation">{</span>    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"10.240.79.157"</span><span class="token punctuation">,</span>    <span class="token property">"labels"</span><span class="token operator">:</span> <span class="token punctuation">{</span>      <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"my-first-k8s-node"</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>Kubernetes ä¼šåœ¨å†…éƒ¨åˆ›å»ºä¸€ä¸ª Node å¯¹è±¡ä½œä¸ºèŠ‚ç‚¹çš„è¡¨ç¤ºã€‚Kubernetes æ£€æŸ¥ <code>kubelet</code> å‘ API æœåŠ¡å™¨æ³¨å†ŒèŠ‚ç‚¹æ—¶ä½¿ç”¨çš„ <code>metadata.name</code> å­—æ®µæ˜¯å¦åŒ¹é…ã€‚ å¦‚æœèŠ‚ç‚¹æ˜¯å¥åº·çš„ï¼ˆå³æ‰€æœ‰å¿…è¦çš„æœåŠ¡éƒ½åœ¨è¿è¡Œä¸­ï¼‰ï¼Œåˆ™è¯¥èŠ‚ç‚¹å¯ä»¥ç”¨æ¥è¿è¡Œ Podã€‚ å¦åˆ™ï¼Œç›´åˆ°è¯¥èŠ‚ç‚¹å˜ä¸ºå¥åº·ä¹‹å‰ï¼Œæ‰€æœ‰çš„é›†ç¾¤æ´»åŠ¨éƒ½ä¼šå¿½ç•¥è¯¥èŠ‚ç‚¹ã€‚</p><blockquote><p><strong>è¯´æ˜ï¼š</strong> Kubernetes ä¼šä¸€ç›´ä¿å­˜ç€éæ³•èŠ‚ç‚¹å¯¹åº”çš„å¯¹è±¡ï¼Œå¹¶æŒç»­æ£€æŸ¥è¯¥èŠ‚ç‚¹æ˜¯å¦å·²ç» å˜å¾—å¥åº·ã€‚ ä½ ï¼Œæˆ–è€…æŸä¸ª<a href="https://kubernetes.io/docs/admin/kube-controller-manager/" target="_blank" rel="noopener">æ§åˆ¶å™¨</a>å¿…éœ€æ˜¾å¼åœ° åˆ é™¤è¯¥ Node å¯¹è±¡ä»¥åœæ­¢å¥åº·æ£€æŸ¥æ“ä½œã€‚</p></blockquote><p>Node å¯¹è±¡çš„åç§°å¿…é¡»æ˜¯åˆæ³•çš„ <a href="https://kubernetes.io/zh/docs/concepts/overview/working-with-objects/names#dns-subdomain-names" target="_blank" rel="noopener">DNS å­åŸŸå</a>ã€‚</p><h3 id="èŠ‚ç‚¹è‡ªæ³¨å†Œ"><a href="#èŠ‚ç‚¹è‡ªæ³¨å†Œ" class="headerlink" title="èŠ‚ç‚¹è‡ªæ³¨å†Œ"></a>èŠ‚ç‚¹è‡ªæ³¨å†Œ</h3><p>å½“ kubelet æ ‡å¿— <code>--register-node</code> ä¸º trueï¼ˆé»˜è®¤ï¼‰æ—¶ï¼Œå®ƒä¼šå°è¯•å‘ API æœåŠ¡æ³¨å†Œè‡ªå·±ã€‚ è¿™æ˜¯é¦–é€‰æ¨¡å¼ï¼Œè¢«ç»å¤§å¤šæ•°å‘è¡Œç‰ˆé€‰ç”¨ã€‚</p><p>å¯¹äºè‡ªæ³¨å†Œæ¨¡å¼ï¼Œkubelet ä½¿ç”¨ä¸‹åˆ—å‚æ•°å¯åŠ¨ï¼š</p><ul><li><code>--kubeconfig</code> - ç”¨äºå‘ API æœåŠ¡å™¨è¡¨æ˜èº«ä»½çš„å‡­æ®è·¯å¾„ã€‚</li><li><code>--cloud-provider</code> - ä¸æŸ<a href="https://kubernetes.io/zh/docs/reference/glossary/?all=true#term-cloud-provider" target="_blank" rel="noopener">äº‘é©±åŠ¨</a> è¿›è¡Œé€šä¿¡ä»¥è¯»å–ä¸è‡ªèº«ç›¸å…³çš„å…ƒæ•°æ®çš„æ–¹å¼ã€‚</li><li><code>--register-node</code> - è‡ªåŠ¨å‘ API æœåŠ¡æ³¨å†Œã€‚</li><li><code>--register-with-taints</code> - ä½¿ç”¨æ‰€ç»™çš„æ±¡ç‚¹åˆ—è¡¨ï¼ˆé€—å·åˆ†éš”çš„ <code>&lt;key&gt;=&lt;value&gt;:&lt;effect&gt;</code>ï¼‰æ³¨å†ŒèŠ‚ç‚¹ã€‚ å½“ <code>register-node</code> ä¸º false æ—¶æ— æ•ˆã€‚</li><li><code>--node-ip</code> - èŠ‚ç‚¹ IP åœ°å€ã€‚</li><li><code>--node-labels</code> - åœ¨é›†ç¾¤ä¸­æ³¨å†ŒèŠ‚ç‚¹æ—¶è¦æ·»åŠ çš„ <a href="https://kubernetes.io/zh/docs/concepts/overview/working-with-objects/labels/" target="_blank" rel="noopener">æ ‡ç­¾</a>ã€‚ ï¼ˆå‚è§ <a href="https://kubernetes.io/zh/docs/reference/access-authn-authz/admission-controllers/#noderestriction" target="_blank" rel="noopener">NodeRestriction å‡†å…¥æ§åˆ¶æ’ä»¶</a>æ‰€å®æ–½çš„æ ‡ç­¾é™åˆ¶ï¼‰ã€‚</li><li><code>--node-status-update-frequency</code> - æŒ‡å®š kubelet å‘æ§åˆ¶é¢å‘é€çŠ¶æ€çš„é¢‘ç‡ã€‚</li></ul><p>å¯ç”¨<a href="https://kubernetes.io/zh/docs/reference/access-authn-authz/node/" target="_blank" rel="noopener">èŠ‚ç‚¹æˆæƒæ¨¡å¼</a>å’Œ <a href="https://kubernetes.io/zh/docs/reference/access-authn-authz/admission-controllers/#noderestriction" target="_blank" rel="noopener">NodeRestriction å‡†å…¥æ’ä»¶</a> æ—¶ï¼Œä»…æˆæƒ <code>kubelet</code> åˆ›å»ºæˆ–ä¿®æ”¹å…¶è‡ªå·±çš„èŠ‚ç‚¹èµ„æºã€‚</p><h4 id="æ‰‹åŠ¨èŠ‚ç‚¹ç®¡ç†"><a href="#æ‰‹åŠ¨èŠ‚ç‚¹ç®¡ç†" class="headerlink" title="æ‰‹åŠ¨èŠ‚ç‚¹ç®¡ç†"></a>æ‰‹åŠ¨èŠ‚ç‚¹ç®¡ç†</h4><p>ä½ å¯ä»¥ä½¿ç”¨ <a href="https://kubernetes.io/docs/user-guide/kubectl-overview/" target="_blank" rel="noopener">kubectl</a> æ¥åˆ›å»ºå’Œä¿®æ”¹ Node å¯¹è±¡ã€‚</p><p>å¦‚æœä½ å¸Œæœ›æ‰‹åŠ¨åˆ›å»ºèŠ‚ç‚¹å¯¹è±¡æ—¶ï¼Œè¯·è®¾ç½® kubelet æ ‡å¿— <code>--register-node=false</code>ã€‚</p><p>ä½ å¯ä»¥ä¿®æ”¹ Node å¯¹è±¡ï¼ˆå¿½ç•¥ <code>--register-node</code> è®¾ç½®ï¼‰ã€‚ ä¾‹å¦‚ï¼Œä¿®æ”¹èŠ‚ç‚¹ä¸Šçš„æ ‡ç­¾æˆ–æ ‡è®°å…¶ä¸ºä¸å¯è°ƒåº¦ã€‚</p><p>ä½ å¯ä»¥ç»“åˆä½¿ç”¨èŠ‚ç‚¹ä¸Šçš„æ ‡ç­¾å’Œ Pod ä¸Šçš„é€‰æ‹©ç®—ç¬¦æ¥æ§åˆ¶è°ƒåº¦ã€‚ ä¾‹å¦‚ï¼Œä½ å¯ä»¥é™åˆ¶æŸ Pod åªèƒ½åœ¨ç¬¦åˆè¦æ±‚çš„èŠ‚ç‚¹å­é›†ä¸Šè¿è¡Œã€‚</p><p>å¦‚æœæ ‡è®°èŠ‚ç‚¹ä¸ºä¸å¯è°ƒåº¦ï¼ˆunschedulableï¼‰ï¼Œå°†é˜»æ­¢æ–° Pod è°ƒåº¦åˆ°è¯¥èŠ‚ç‚¹ä¹‹ä¸Šï¼Œä½†ä¸ä¼š å½±å“ä»»ä½•å·²ç»åœ¨å…¶ä¸Šçš„ Podã€‚ è¿™æ˜¯é‡å¯èŠ‚ç‚¹æˆ–è€…æ‰§è¡Œå…¶ä»–ç»´æŠ¤æ“ä½œä¹‹å‰çš„ä¸€ä¸ªæœ‰ç”¨çš„å‡†å¤‡æ­¥éª¤ã€‚</p><p>è¦æ ‡è®°ä¸€ä¸ªèŠ‚ç‚¹ä¸ºä¸å¯è°ƒåº¦ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p><pre class=" language-shell"><code class="language-shell">kubectl cordon $NODENAME</code></pre><blockquote><p><strong>è¯´æ˜ï¼š</strong> è¢« <a href="https://kubernetes.io/zh/docs/concepts/workloads/controllers/daemonset/" target="_blank" rel="noopener">DaemonSet</a> æ§åˆ¶å™¨åˆ›å»ºçš„ Pod èƒ½å¤Ÿå®¹å¿èŠ‚ç‚¹çš„ä¸å¯è°ƒåº¦å±æ€§ã€‚ DaemonSet é€šå¸¸æä¾›èŠ‚ç‚¹æœ¬åœ°çš„æœåŠ¡ï¼Œå³ä½¿èŠ‚ç‚¹ä¸Šçš„è´Ÿè½½åº”ç”¨å·²ç»è¢«è…¾ç©ºï¼Œè¿™äº›æœåŠ¡ä¹Ÿä»éœ€ è¿è¡Œåœ¨èŠ‚ç‚¹ä¹‹ä¸Šã€‚</p></blockquote><h2 id="èŠ‚ç‚¹çŠ¶æ€"><a href="#èŠ‚ç‚¹çŠ¶æ€" class="headerlink" title="èŠ‚ç‚¹çŠ¶æ€"></a>èŠ‚ç‚¹çŠ¶æ€</h2><p>ä¸€ä¸ªèŠ‚ç‚¹çš„çŠ¶æ€åŒ…å«ä»¥ä¸‹ä¿¡æ¯:</p><ul><li><a href="https://kubernetes.io/zh/docs/concepts/architecture/nodes/#addresses" target="_blank" rel="noopener">åœ°å€</a></li><li><a href="https://kubernetes.io/zh/docs/concepts/architecture/nodes/#condition" target="_blank" rel="noopener">çŠ¶å†µ</a></li><li><a href="https://kubernetes.io/zh/docs/concepts/architecture/nodes/#capacity" target="_blank" rel="noopener">å®¹é‡ä¸å¯åˆ†é…</a></li><li><a href="https://kubernetes.io/zh/docs/concepts/architecture/nodes/#info" target="_blank" rel="noopener">ä¿¡æ¯</a></li></ul><p>ä½ å¯ä»¥ä½¿ç”¨ <code>kubectl</code> æ¥æŸ¥çœ‹èŠ‚ç‚¹çŠ¶æ€å’Œå…¶ä»–ç»†èŠ‚ä¿¡æ¯ï¼š</p><pre class=" language-shell"><code class="language-shell">kubectl describe node <èŠ‚ç‚¹åç§°></code></pre><p>ä¸‹é¢å¯¹æ¯ä¸ªéƒ¨åˆ†è¿›è¡Œè¯¦ç»†æè¿°ã€‚</p><h3 id="åœ°å€"><a href="#åœ°å€" class="headerlink" title="åœ°å€"></a>åœ°å€</h3><p>è¿™äº›å­—æ®µçš„ç”¨æ³•å–å†³äºä½ çš„äº‘æœåŠ¡å•†æˆ–è€…ç‰©ç†æœºé…ç½®ã€‚</p><ul><li>HostNameï¼šç”±èŠ‚ç‚¹çš„å†…æ ¸è®¾ç½®ã€‚å¯ä»¥é€šè¿‡ kubelet çš„ <code>--hostname-override</code> å‚æ•°è¦†ç›–ã€‚</li><li>ExternalIPï¼šé€šå¸¸æ˜¯èŠ‚ç‚¹çš„å¯å¤–éƒ¨è·¯ç”±ï¼ˆä»é›†ç¾¤å¤–å¯è®¿é—®ï¼‰çš„ IP åœ°å€ã€‚</li><li>InternalIPï¼šé€šå¸¸æ˜¯èŠ‚ç‚¹çš„ä»…å¯åœ¨é›†ç¾¤å†…éƒ¨è·¯ç”±çš„ IP åœ°å€ã€‚</li></ul><h3 id="çŠ¶å†µ"><a href="#çŠ¶å†µ" class="headerlink" title="çŠ¶å†µ"></a>çŠ¶å†µ</h3><p><code>conditions</code> å­—æ®µæè¿°äº†æ‰€æœ‰ <code>Running</code> èŠ‚ç‚¹çš„çŠ¶æ€ã€‚çŠ¶å†µçš„ç¤ºä¾‹åŒ…æ‹¬ï¼š</p><blockquote><p><strong>è¯´æ˜ï¼š</strong> å¦‚æœä½¿ç”¨å‘½ä»¤è¡Œå·¥å…·æ¥æ‰“å°å·²ä¿æŠ¤ï¼ˆCordonedï¼‰èŠ‚ç‚¹çš„ç»†èŠ‚ï¼Œå…¶ä¸­çš„ Condition å­—æ®µå¯èƒ½ åŒ…æ‹¬ <code>SchedulingDisabled</code>ã€‚<code>SchedulingDisabled</code> ä¸æ˜¯ Kubernetes API ä¸­å®šä¹‰çš„ Conditionï¼Œè¢«ä¿æŠ¤èµ·æ¥çš„èŠ‚ç‚¹åœ¨å…¶è§„çº¦ä¸­è¢«æ ‡è®°ä¸ºä¸å¯è°ƒåº¦ï¼ˆUnschedulableï¼‰ã€‚</p></blockquote><p>èŠ‚ç‚¹æ¡ä»¶ä½¿ç”¨ JSON å¯¹è±¡è¡¨ç¤ºã€‚ä¾‹å¦‚ï¼Œä¸‹é¢çš„å“åº”æè¿°äº†ä¸€ä¸ªå¥åº·çš„èŠ‚ç‚¹ã€‚</p><pre class=" language-json"><code class="language-json"><span class="token property">"conditions"</span><span class="token operator">:</span> <span class="token punctuation">[</span>  <span class="token punctuation">{</span>    <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"Ready"</span><span class="token punctuation">,</span>    <span class="token property">"status"</span><span class="token operator">:</span> <span class="token string">"True"</span><span class="token punctuation">,</span>    <span class="token property">"reason"</span><span class="token operator">:</span> <span class="token string">"KubeletReady"</span><span class="token punctuation">,</span>    <span class="token property">"message"</span><span class="token operator">:</span> <span class="token string">"kubelet is posting ready status"</span><span class="token punctuation">,</span>    <span class="token property">"lastHeartbeatTime"</span><span class="token operator">:</span> <span class="token string">"2019-06-05T18:38:35Z"</span><span class="token punctuation">,</span>    <span class="token property">"lastTransitionTime"</span><span class="token operator">:</span> <span class="token string">"2019-06-05T11:41:27Z"</span>  <span class="token punctuation">}</span><span class="token punctuation">]</span></code></pre><p>å¦‚æœ Ready æ¡ä»¶å¤„äº <code>Unknown</code> æˆ–è€… <code>False</code> çŠ¶æ€çš„æ—¶é—´è¶…è¿‡äº† <code>pod-eviction-timeout</code> å€¼ï¼Œ ï¼ˆä¸€ä¸ªä¼ é€’ç»™ <a href="https://kubernetes.io/docs/reference/generated/kube-controller-manager/" target="_blank" rel="noopener">kube-controller-manager</a> çš„å‚æ•°ï¼‰ï¼Œ èŠ‚ç‚¹ä¸Šçš„æ‰€æœ‰ Pod éƒ½ä¼šè¢«èŠ‚ç‚¹æ§åˆ¶å™¨è®¡åˆ’åˆ é™¤ã€‚é»˜è®¤çš„é€å‡ºè¶…æ—¶æ—¶é•¿ä¸º <strong>5 åˆ†é’Ÿ</strong>ã€‚ æŸäº›æƒ…å†µä¸‹ï¼Œå½“èŠ‚ç‚¹ä¸å¯è¾¾æ—¶ï¼ŒAPI æœåŠ¡å™¨ä¸èƒ½å’Œå…¶ä¸Šçš„ kubelet é€šä¿¡ã€‚ åˆ é™¤ Pod çš„å†³å®šä¸èƒ½ä¼ è¾¾ç»™ kubeletï¼Œç›´åˆ°å®ƒé‡æ–°å»ºç«‹å’Œ API æœåŠ¡å™¨çš„è¿æ¥ä¸ºæ­¢ã€‚ ä¸æ­¤åŒæ—¶ï¼Œè¢«è®¡åˆ’åˆ é™¤çš„ Pod å¯èƒ½ä¼šç»§ç»­åœ¨æ¸¸ç¦»çš„èŠ‚ç‚¹ä¸Šè¿è¡Œã€‚</p><p>èŠ‚ç‚¹æ§åˆ¶å™¨åœ¨ç¡®è®¤ Pod åœ¨é›†ç¾¤ä¸­å·²ç»åœæ­¢è¿è¡Œå‰ï¼Œä¸ä¼šå¼ºåˆ¶åˆ é™¤å®ƒä»¬ã€‚ ä½ å¯ä»¥çœ‹åˆ°è¿™äº›å¯èƒ½åœ¨æ— æ³•è®¿é—®çš„èŠ‚ç‚¹ä¸Šè¿è¡Œçš„ Pod å¤„äº <code>Terminating</code> æˆ–è€… <code>Unknown</code> çŠ¶æ€ã€‚ å¦‚æœ kubernetes ä¸èƒ½åŸºäºä¸‹å±‚åŸºç¡€è®¾æ–½æ¨æ–­å‡ºæŸèŠ‚ç‚¹æ˜¯å¦å·²ç»æ°¸ä¹…ç¦»å¼€äº†é›†ç¾¤ï¼Œ é›†ç¾¤ç®¡ç†å‘˜å¯èƒ½éœ€è¦æ‰‹åŠ¨åˆ é™¤è¯¥èŠ‚ç‚¹å¯¹è±¡ã€‚ ä» Kubernetes åˆ é™¤èŠ‚ç‚¹å¯¹è±¡å°†å¯¼è‡´ API æœåŠ¡å™¨åˆ é™¤èŠ‚ç‚¹ä¸Šæ‰€æœ‰è¿è¡Œçš„ Pod å¯¹è±¡å¹¶é‡Šæ”¾å®ƒä»¬çš„åå­—ã€‚</p><p>èŠ‚ç‚¹ç”Ÿå‘½å‘¨æœŸæ§åˆ¶å™¨ä¼šè‡ªåŠ¨åˆ›å»ºä»£è¡¨çŠ¶å†µçš„ <a href="https://kubernetes.io/zh/docs/concepts/scheduling-eviction/taint-and-toleration/" target="_blank" rel="noopener">æ±¡ç‚¹</a>ã€‚ å½“è°ƒåº¦å™¨å°† Pod æŒ‡æ´¾ç»™æŸèŠ‚ç‚¹æ—¶ï¼Œä¼šè€ƒè™‘èŠ‚ç‚¹ä¸Šçš„æ±¡ç‚¹ã€‚ Pod åˆ™å¯ä»¥é€šè¿‡å®¹å¿åº¦ï¼ˆTolerationï¼‰è¡¨è¾¾æ‰€èƒ½å®¹å¿çš„æ±¡ç‚¹ã€‚</p><p><code>capacity</code> å—ä¸­çš„å­—æ®µæ ‡ç¤ºèŠ‚ç‚¹æ‹¥æœ‰çš„èµ„æºæ€»é‡ã€‚ <code>allocatable</code> å—æŒ‡ç¤ºèŠ‚ç‚¹ä¸Šå¯ä¾›æ™®é€š Pod æ¶ˆè€—çš„èµ„æºé‡ã€‚</p><p>å¯ä»¥åœ¨å­¦ä¹ å¦‚ä½•åœ¨èŠ‚ç‚¹ä¸Š<a href="https://kubernetes.io/zh/docs/tasks/administer-cluster/reserve-compute-resources/#node-allocatable" target="_blank" rel="noopener">é¢„ç•™è®¡ç®—èµ„æº</a> çš„æ—¶å€™äº†è§£æœ‰å…³å®¹é‡å’Œå¯åˆ†é…èµ„æºçš„æ›´å¤šä¿¡æ¯ã€‚</p><p>ç¬¬äºŒä¸ªæ˜¯ä¿æŒèŠ‚ç‚¹æ§åˆ¶å™¨å†…çš„èŠ‚ç‚¹åˆ—è¡¨ä¸äº‘æœåŠ¡å•†æ‰€æä¾›çš„å¯ç”¨æœºå™¨åˆ—è¡¨åŒæ­¥ã€‚ å¦‚æœåœ¨äº‘ç¯å¢ƒä¸‹è¿è¡Œï¼Œåªè¦æŸèŠ‚ç‚¹ä¸å¥åº·ï¼ŒèŠ‚ç‚¹æ§åˆ¶å™¨å°±ä¼šè¯¢é—®äº‘æœåŠ¡æ˜¯å¦èŠ‚ç‚¹çš„è™šæ‹Ÿæœºä»å¯ç”¨ã€‚ å¦‚æœä¸å¯ç”¨ï¼ŒèŠ‚ç‚¹æ§åˆ¶å™¨ä¼šå°†è¯¥èŠ‚ç‚¹ä»å®ƒçš„èŠ‚ç‚¹åˆ—è¡¨åˆ é™¤ã€‚</p><p>ç¬¬ä¸‰ä¸ªæ˜¯ç›‘æ§èŠ‚ç‚¹çš„å¥åº·æƒ…å†µã€‚èŠ‚ç‚¹æ§åˆ¶å™¨è´Ÿè´£åœ¨èŠ‚ç‚¹ä¸å¯è¾¾ ï¼ˆå³ï¼ŒèŠ‚ç‚¹æ§åˆ¶å™¨å› ä¸ºæŸäº›åŸå› æ²¡æœ‰æ”¶åˆ°å¿ƒè·³ï¼Œä¾‹å¦‚èŠ‚ç‚¹å®•æœºï¼‰æ—¶ï¼Œ å°†èŠ‚ç‚¹çŠ¶æ€çš„ <code>NodeReady</code> çŠ¶å†µæ›´æ–°ä¸º â€œ<code>Unknown</code>â€œã€‚ å¦‚æœèŠ‚ç‚¹æ¥ä¸‹æ¥æŒç»­å¤„äºä¸å¯è¾¾çŠ¶æ€ï¼ŒèŠ‚ç‚¹æ§åˆ¶å™¨å°†é€å‡ºèŠ‚ç‚¹ä¸Šçš„æ‰€æœ‰ Podï¼ˆä½¿ç”¨ä½“é¢ç»ˆæ­¢ï¼‰ã€‚ é»˜è®¤æƒ…å†µä¸‹ 40 ç§’åå¼€å§‹æŠ¥å‘Š â€œ<code>Unknown</code>â€œï¼Œåœ¨é‚£ä¹‹å 5 åˆ†é’Ÿå¼€å§‹é€å‡º Podã€‚ èŠ‚ç‚¹æ§åˆ¶å™¨æ¯éš” <code>--node-monitor-period</code> ç§’æ£€æŸ¥æ¯ä¸ªèŠ‚ç‚¹çš„çŠ¶æ€ã€‚</p><p><code>kubelet</code> è´Ÿè´£åˆ›å»ºå’Œæ›´æ–° <code>NodeStatus</code> å’Œ <code>Lease</code> å¯¹è±¡ã€‚</p><p>å½“ä¸€ä¸ªå¯ç”¨åŒºåŸŸï¼ˆAvailability Zoneï¼‰ä¸­çš„èŠ‚ç‚¹å˜ä¸ºä¸å¥åº·æ—¶ï¼ŒèŠ‚ç‚¹çš„é©±é€è¡Œä¸ºå°†å‘ç”Ÿæ”¹å˜ã€‚ èŠ‚ç‚¹æ§åˆ¶å™¨ä¼šåŒæ—¶æ£€æŸ¥å¯ç”¨åŒºåŸŸä¸­ä¸å¥åº·ï¼ˆNodeReady çŠ¶å†µä¸º Unknown æˆ– Falseï¼‰ çš„èŠ‚ç‚¹çš„ç™¾åˆ†æ¯”ã€‚å¦‚æœä¸å¥åº·èŠ‚ç‚¹çš„æ¯”ä¾‹è¶…è¿‡ <code>--unhealthy-zone-threshold</code> ï¼ˆé»˜è®¤ä¸º 0.55ï¼‰ï¼Œ é©±é€é€Ÿç‡å°†ä¼šé™ä½ï¼šå¦‚æœé›†ç¾¤è¾ƒå°ï¼ˆæ„å³å°äºç­‰äº <code>--large-cluster-size-threshold</code> ä¸ªèŠ‚ç‚¹ - é»˜è®¤ä¸º 50ï¼‰ï¼Œé©±é€æ“ä½œå°†ä¼šåœæ­¢ï¼Œå¦åˆ™é©±é€é€Ÿç‡å°†é™ä¸ºæ¯ç§’ <code>--secondary-node-eviction-rate</code> ä¸ªï¼ˆé»˜è®¤ä¸º 0.01ï¼‰ã€‚ åœ¨å•ä¸ªå¯ç”¨åŒºåŸŸå®æ–½è¿™äº›ç­–ç•¥çš„åŸå› æ˜¯å½“ä¸€ä¸ªå¯ç”¨åŒºåŸŸå¯èƒ½ä»æ§åˆ¶é¢è„±ç¦»æ—¶å…¶å®ƒå¯ç”¨åŒºåŸŸ å¯èƒ½ä»ç„¶ä¿æŒè¿æ¥ã€‚ å¦‚æœä½ çš„é›†ç¾¤æ²¡æœ‰è·¨è¶Šäº‘æœåŠ¡å•†çš„å¤šä¸ªå¯ç”¨åŒºåŸŸï¼Œé‚£ï¼ˆæ•´ä¸ªé›†ç¾¤ï¼‰å°±åªæœ‰ä¸€ä¸ªå¯ç”¨åŒºåŸŸã€‚</p><p>è·¨å¤šä¸ªå¯ç”¨åŒºåŸŸéƒ¨ç½²ä½ çš„èŠ‚ç‚¹çš„ä¸€ä¸ªå…³é”®åŸå› æ˜¯å½“æŸä¸ªå¯ç”¨åŒºåŸŸæ•´ä½“å‡ºç°æ•…éšœæ—¶ï¼Œ å·¥ä½œè´Ÿè½½å¯ä»¥è½¬ç§»åˆ°å¥åº·çš„å¯ç”¨åŒºåŸŸã€‚ å› æ­¤ï¼Œå¦‚æœä¸€ä¸ªå¯ç”¨åŒºåŸŸä¸­çš„æ‰€æœ‰èŠ‚ç‚¹éƒ½ä¸å¥åº·æ—¶ï¼ŒèŠ‚ç‚¹æ§åˆ¶å™¨ä¼šä»¥æ­£å¸¸çš„é€Ÿç‡ <code>--node-eviction-rate</code> è¿›è¡Œé©±é€æ“ä½œã€‚ åœ¨æ‰€æœ‰çš„å¯ç”¨åŒºåŸŸéƒ½ä¸å¥åº·ï¼ˆä¹Ÿå³é›†ç¾¤ä¸­æ²¡æœ‰å¥åº·èŠ‚ç‚¹ï¼‰çš„æç«¯æƒ…å†µä¸‹ï¼Œ èŠ‚ç‚¹æ§åˆ¶å™¨å°†å‡è®¾æ§åˆ¶é¢èŠ‚ç‚¹çš„è¿æ¥å‡ºäº†æŸäº›é—®é¢˜ï¼Œ å®ƒå°†åœæ­¢æ‰€æœ‰é©±é€åŠ¨ä½œç›´åˆ°ä¸€äº›è¿æ¥æ¢å¤ã€‚</p><p>èŠ‚ç‚¹æ§åˆ¶å™¨è¿˜è´Ÿè´£é©±é€è¿è¡Œåœ¨æ‹¥æœ‰ <code>NoExecute</code> æ±¡ç‚¹çš„èŠ‚ç‚¹ä¸Šçš„ Podï¼Œ é™¤éè¿™äº› Pod èƒ½å¤Ÿå®¹å¿æ­¤æ±¡ç‚¹ã€‚ èŠ‚ç‚¹æ§åˆ¶å™¨è¿˜è´Ÿè´£æ ¹æ®èŠ‚ç‚¹æ•…éšœï¼ˆä¾‹å¦‚èŠ‚ç‚¹ä¸å¯è®¿é—®æˆ–æ²¡æœ‰å°±ç»ªï¼‰ä¸ºå…¶æ·»åŠ  <a href="https://kubernetes.io/docs/concepts/configuration/taint-and-toleration/" target="_blank" rel="noopener">æ±¡ç‚¹</a>ã€‚ è¿™æ„å‘³ç€è°ƒåº¦å™¨ä¸ä¼šå°† Pod è°ƒåº¦åˆ°ä¸å¥åº·çš„èŠ‚ç‚¹ä¸Šã€‚</p><blockquote><p><strong>æ³¨æ„ï¼š</strong> <code>kubectl cordon</code> ä¼šå°†èŠ‚ç‚¹æ ‡è®°ä¸ºâ€œä¸å¯è°ƒåº¦ï¼ˆUnschedulableï¼‰â€ã€‚ æ­¤æ“ä½œçš„å‰¯ä½œç”¨æ˜¯ï¼ŒæœåŠ¡æ§åˆ¶å™¨ä¼šå°†è¯¥èŠ‚ç‚¹ä»è´Ÿè½½å‡è¡¡å™¨ä¸­ä¹‹å‰çš„ç›®æ ‡èŠ‚ç‚¹åˆ—è¡¨ä¸­ç§»é™¤ï¼Œ ä»è€Œä½¿å¾—æ¥è‡ªè´Ÿè½½å‡è¡¡å™¨çš„ç½‘ç»œè¯·æ±‚ä¸ä¼šåˆ°è¾¾è¢«ä¿æŠ¤èµ·æ¥çš„èŠ‚ç‚¹ã€‚</p></blockquote><p>Kubernetes <a href="https://kubernetes.io/docs/reference/generated/kube-scheduler/" target="_blank" rel="noopener">è°ƒåº¦å™¨</a>ä¿è¯èŠ‚ç‚¹ä¸Š æœ‰è¶³å¤Ÿçš„èµ„æºä¾›å…¶ä¸Šçš„æ‰€æœ‰ Pod ä½¿ç”¨ã€‚å®ƒä¼šæ£€æŸ¥èŠ‚ç‚¹ä¸Šæ‰€æœ‰å®¹å™¨çš„è¯·æ±‚çš„æ€»å’Œä¸ä¼šè¶…è¿‡èŠ‚ç‚¹çš„å®¹é‡ã€‚ æ€»çš„è¯·æ±‚åŒ…æ‹¬ç”± kubelet å¯åŠ¨çš„æ‰€æœ‰å®¹å™¨ï¼Œä½†ä¸åŒ…æ‹¬ç”±å®¹å™¨è¿è¡Œæ—¶ç›´æ¥å¯åŠ¨çš„å®¹å™¨ï¼Œ ä¹Ÿä¸åŒ…æ‹¬ä¸å— <code>kubelet</code> æ§åˆ¶çš„å…¶ä»–è¿›ç¨‹ã€‚</p><blockquote><p><strong>è¯´æ˜ï¼š</strong> å¦‚æœè¦ä¸ºé Pod è¿›ç¨‹æ˜¾å¼ä¿ç•™èµ„æºã€‚è¯·å‚è€ƒ <a href="https://kubernetes.io/zh/docs/tasks/administer-cluster/reserve-compute-resources/#system-reserved" target="_blank" rel="noopener">ä¸ºç³»ç»Ÿå®ˆæŠ¤è¿›ç¨‹é¢„ç•™èµ„æº</a>ã€‚</p></blockquote><h2 id="èŠ‚ç‚¹æ‹“æ‰‘"><a href="#èŠ‚ç‚¹æ‹“æ‰‘" class="headerlink" title="èŠ‚ç‚¹æ‹“æ‰‘"></a>èŠ‚ç‚¹æ‹“æ‰‘</h2><p><strong>FEATURE STATE:</strong> <code>Kubernetes v1.16 [alpha]</code></p><p>å¦‚æœå¯ç”¨äº† <code>TopologyManager</code> <a href="https://kubernetes.io/zh/docs/reference/command-line-tools-reference/feature-gates/" target="_blank" rel="noopener">ç‰¹æ€§é—¨æ§</a>ï¼Œ <code>kubelet</code> å¯ä»¥åœ¨ä½œå‡ºèµ„æºåˆ†é…å†³ç­–æ—¶ä½¿ç”¨æ‹“æ‰‘æç¤ºã€‚ å‚è€ƒ<a href="https://kubernetes.io/zh/docs/tasks/administer-cluster/topology-manager/" target="_blank" rel="noopener">æ§åˆ¶èŠ‚ç‚¹ä¸Šæ‹“æ‰‘ç®¡ç†ç­–ç•¥</a> äº†è§£è¯¦ç»†ä¿¡æ¯ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> å®¹å™¨ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kubernetesæ¶æ„â€”ç»„ä»¶</title>
      <link href="2020/10/03/rong-qi/kubernetes-jia-gou-zu-jian/"/>
      <url>2020/10/03/rong-qi/kubernetes-jia-gou-zu-jian/</url>
      
        <content type="html"><![CDATA[<h1 id="Kubernetes-ç»„ä»¶"><a href="#Kubernetes-ç»„ä»¶" class="headerlink" title="Kubernetes ç»„ä»¶"></a>Kubernetes ç»„ä»¶</h1><p>å½“ä½ éƒ¨ç½²å®Œ Kubernetes, å³æ‹¥æœ‰äº†ä¸€ä¸ªå®Œæ•´çš„é›†ç¾¤ã€‚</p><p>ä¸€ä¸ª Kubernetes é›†ç¾¤åŒ…å« é›†ç¾¤ç”±ä¸€ç»„è¢«ç§°ä½œèŠ‚ç‚¹çš„æœºå™¨ç»„æˆã€‚è¿™äº›èŠ‚ç‚¹ä¸Šè¿è¡Œ Kubernetes æ‰€ç®¡ç†çš„å®¹å™¨åŒ–åº”ç”¨ã€‚é›†ç¾¤å…·æœ‰è‡³å°‘ä¸€ä¸ªå·¥ä½œèŠ‚ç‚¹å’Œè‡³å°‘ä¸€ä¸ªä¸»èŠ‚ç‚¹ã€‚</p><p>å·¥ä½œèŠ‚ç‚¹æ‰˜ç®¡ä½œä¸ºåº”ç”¨ç¨‹åºç»„ä»¶çš„ Pod ã€‚ä¸»èŠ‚ç‚¹ç®¡ç†é›†ç¾¤ä¸­çš„å·¥ä½œèŠ‚ç‚¹å’Œ Pod ã€‚å¤šä¸ªä¸»èŠ‚ç‚¹ç”¨äºä¸ºé›†ç¾¤æä¾›æ•…éšœè½¬ç§»å’Œé«˜å¯ç”¨æ€§ã€‚</p><p>æœ¬æ–‡æ¡£æ¦‚è¿°äº†äº¤ä»˜æ­£å¸¸è¿è¡Œçš„ Kubernetes é›†ç¾¤æ‰€éœ€çš„å„ç§ç»„ä»¶ã€‚</p><p>è¿™å¼ å›¾è¡¨å±•ç¤ºäº†åŒ…å«æ‰€æœ‰ç›¸äº’å…³è”ç»„ä»¶çš„ Kubernetes é›†ç¾¤ã€‚</p><p><img src="https://d33wubrfki0l68.cloudfront.net/7016517375d10c702489167e704dcb99e570df85/7bb53/images/docs/components-of-kubernetes.png" alt="Kubernetes ç»„ä»¶"></p><h2 id="æ§åˆ¶å¹³é¢ç»„ä»¶ï¼ˆControl-Plane-Componentsï¼‰"><a href="#æ§åˆ¶å¹³é¢ç»„ä»¶ï¼ˆControl-Plane-Componentsï¼‰" class="headerlink" title="æ§åˆ¶å¹³é¢ç»„ä»¶ï¼ˆControl Plane Componentsï¼‰"></a>æ§åˆ¶å¹³é¢ç»„ä»¶ï¼ˆControl Plane Componentsï¼‰</h2><p>æ§åˆ¶å¹³é¢çš„ç»„ä»¶å¯¹é›†ç¾¤åšå‡ºå…¨å±€å†³ç­–(æ¯”å¦‚è°ƒåº¦)ï¼Œä»¥åŠæ£€æµ‹å’Œå“åº”é›†ç¾¤äº‹ä»¶ï¼ˆä¾‹å¦‚ï¼Œå½“ä¸æ»¡è¶³éƒ¨ç½²çš„ <code>replicas</code> å­—æ®µæ—¶ï¼Œå¯åŠ¨æ–°çš„ <a href="https://kubernetes.io/docs/concepts/workloads/pods/pod-overview/" target="_blank" rel="noopener">pod</a>ï¼‰ã€‚</p><p>æ§åˆ¶å¹³é¢ç»„ä»¶å¯ä»¥åœ¨é›†ç¾¤ä¸­çš„ä»»ä½•èŠ‚ç‚¹ä¸Šè¿è¡Œã€‚ ç„¶è€Œï¼Œä¸ºäº†ç®€å•èµ·è§ï¼Œè®¾ç½®è„šæœ¬é€šå¸¸ä¼šåœ¨åŒä¸€ä¸ªè®¡ç®—æœºä¸Šå¯åŠ¨æ‰€æœ‰æ§åˆ¶å¹³é¢ç»„ä»¶ï¼Œå¹¶ä¸”ä¸ä¼šåœ¨æ­¤è®¡ç®—æœºä¸Šè¿è¡Œç”¨æˆ·å®¹å™¨ã€‚ è¯·å‚é˜…<a href="https://kubernetes.io/zh/docs/setup/production-environment/tools/kubeadm/high-availability/" target="_blank" rel="noopener">æ„å»ºé«˜å¯ç”¨æ€§é›†ç¾¤</a> ä¸­å¯¹äºå¤šä¸»æœº VM çš„è®¾ç½®ç¤ºä¾‹ã€‚</p><h3 id="kube-apiserver"><a href="#kube-apiserver" class="headerlink" title="kube-apiserver"></a>kube-apiserver</h3><p>ä¸»èŠ‚ç‚¹ä¸Šè´Ÿè´£æä¾› Kubernetes API æœåŠ¡çš„ç»„ä»¶ï¼›å®ƒæ˜¯ Kubernetes æ§åˆ¶é¢çš„å‰ç«¯ã€‚</p><p>kube-apiserver åœ¨è®¾è®¡ä¸Šè€ƒè™‘äº†æ°´å¹³æ‰©ç¼©çš„éœ€è¦ã€‚ æ¢è¨€ä¹‹ï¼Œé€šè¿‡éƒ¨ç½²å¤šä¸ªå®ä¾‹å¯ä»¥å®ç°æ‰©ç¼©ã€‚ å‚è§<a href="https://kubernetes.io/docs/admin/high-availability/" target="_blank" rel="noopener">æ„é€ é«˜å¯ç”¨é›†ç¾¤</a>ã€‚</p><h3 id="etcd"><a href="#etcd" class="headerlink" title="etcd"></a>etcd</h3><p>etcd æ˜¯å…¼å…·ä¸€è‡´æ€§å’Œé«˜å¯ç”¨æ€§çš„é”®å€¼æ•°æ®åº“ï¼Œå¯ä»¥ä½œä¸ºä¿å­˜ Kubernetes æ‰€æœ‰é›†ç¾¤æ•°æ®çš„åå°æ•°æ®åº“ã€‚</p><p>æ‚¨çš„ Kubernetes é›†ç¾¤çš„ etcd æ•°æ®åº“é€šå¸¸éœ€è¦æœ‰ä¸ªå¤‡ä»½è®¡åˆ’ã€‚è¦äº†è§£ etcd æ›´æ·±å±‚æ¬¡çš„ä¿¡æ¯ï¼Œè¯·å‚è€ƒ <a href="https://etcd.io/docs" target="_blank" rel="noopener">etcd æ–‡æ¡£</a>ã€‚</p><h3 id="kube-scheduler"><a href="#kube-scheduler" class="headerlink" title="kube-scheduler"></a>kube-scheduler</h3><p>ä¸»èŠ‚ç‚¹ä¸Šçš„ç»„ä»¶ï¼Œè¯¥ç»„ä»¶ç›‘è§†é‚£äº›æ–°åˆ›å»ºçš„æœªæŒ‡å®šè¿è¡ŒèŠ‚ç‚¹çš„ Podï¼Œå¹¶é€‰æ‹©èŠ‚ç‚¹è®© Pod åœ¨ä¸Šé¢è¿è¡Œã€‚</p><p>è°ƒåº¦å†³ç­–è€ƒè™‘çš„å› ç´ åŒ…æ‹¬å•ä¸ª Pod å’Œ Pod é›†åˆçš„èµ„æºéœ€æ±‚ã€ç¡¬ä»¶/è½¯ä»¶/ç­–ç•¥çº¦æŸã€äº²å’Œæ€§å’Œåäº²å’Œæ€§è§„èŒƒã€æ•°æ®ä½ç½®ã€å·¥ä½œè´Ÿè½½é—´çš„å¹²æ‰°å’Œæœ€åæ—¶é™ã€‚</p><h3 id="kube-controller-manager"><a href="#kube-controller-manager" class="headerlink" title="kube-controller-manager"></a>kube-controller-manager</h3><p>åœ¨ä¸»èŠ‚ç‚¹ä¸Šè¿è¡Œ<a href="https://kubernetes.io/docs/admin/kube-controller-manager/" target="_blank" rel="noopener">æ§åˆ¶å™¨</a>çš„ç»„ä»¶ã€‚</p><p>ä»é€»è¾‘ä¸Šè®²ï¼Œæ¯ä¸ª<a href="https://kubernetes.io/docs/admin/kube-controller-manager/" target="_blank" rel="noopener">æ§åˆ¶å™¨</a>éƒ½æ˜¯ä¸€ä¸ªå•ç‹¬çš„è¿›ç¨‹ï¼Œä½†æ˜¯ä¸ºäº†é™ä½å¤æ‚æ€§ï¼Œå®ƒä»¬éƒ½è¢«ç¼–è¯‘åˆ°åŒä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ï¼Œå¹¶åœ¨ä¸€ä¸ªè¿›ç¨‹ä¸­è¿è¡Œã€‚</p><p>è¿™äº›æ§åˆ¶å™¨åŒ…æ‹¬:</p><ul><li>èŠ‚ç‚¹æ§åˆ¶å™¨ï¼ˆNode Controllerï¼‰: è´Ÿè´£åœ¨èŠ‚ç‚¹å‡ºç°æ•…éšœæ—¶è¿›è¡Œé€šçŸ¥å’Œå“åº”ã€‚</li><li>å‰¯æœ¬æ§åˆ¶å™¨ï¼ˆReplication Controllerï¼‰: è´Ÿè´£ä¸ºç³»ç»Ÿä¸­çš„æ¯ä¸ªå‰¯æœ¬æ§åˆ¶å™¨å¯¹è±¡ç»´æŠ¤æ­£ç¡®æ•°é‡çš„ Podã€‚</li><li>ç«¯ç‚¹æ§åˆ¶å™¨ï¼ˆEndpoints Controllerï¼‰: å¡«å……ç«¯ç‚¹(Endpoints)å¯¹è±¡(å³åŠ å…¥ Service ä¸ Pod)ã€‚</li><li>æœåŠ¡å¸æˆ·å’Œä»¤ç‰Œæ§åˆ¶å™¨ï¼ˆService Account &amp; Token Controllersï¼‰: ä¸ºæ–°çš„å‘½åç©ºé—´åˆ›å»ºé»˜è®¤å¸æˆ·å’Œ API è®¿é—®ä»¤ç‰Œ.</li></ul><h3 id="cloud-controller-manager"><a href="#cloud-controller-manager" class="headerlink" title="cloud-controller-manager"></a>cloud-controller-manager</h3><p>äº‘æ§åˆ¶å™¨ç®¡ç†å™¨æ˜¯ 1.8 çš„ alpha ç‰¹æ€§ã€‚åœ¨æœªæ¥å‘å¸ƒçš„ç‰ˆæœ¬ä¸­ï¼Œè¿™æ˜¯å°† Kubernetes ä¸ä»»ä½•å…¶ä»–äº‘é›†æˆçš„æœ€ä½³æ–¹å¼ã€‚</p><p><code>cloud-controller-manager</code> è¿›è¿è¡Œç‰¹å®šäºäº‘å¹³å°çš„æ§åˆ¶å›è·¯ã€‚ å¦‚æœä½ åœ¨è‡ªå·±çš„ç¯å¢ƒä¸­è¿è¡Œ Kubernetesï¼Œæˆ–è€…åœ¨æœ¬åœ°è®¡ç®—æœºä¸­è¿è¡Œå­¦ä¹ ç¯å¢ƒï¼Œ æ‰€éƒ¨å±çš„ç¯å¢ƒä¸­ä¸éœ€è¦äº‘æ§åˆ¶å™¨ç®¡ç†å™¨ã€‚</p><p>ä¸ <code>kube-controller-manager</code> ç±»ä¼¼ï¼Œ<code>cloud-controller-manager</code> å°†è‹¥å¹²é€»è¾‘ä¸Šç‹¬ç«‹çš„ æ§åˆ¶å›è·¯ç»„åˆåˆ°åŒä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ä¸­ï¼Œä¾›ä½ ä»¥åŒä¸€è¿›ç¨‹çš„æ–¹å¼è¿è¡Œã€‚ ä½ å¯ä»¥å¯¹å…¶æ‰§è¡Œæ°´å¹³æ‰©å®¹ï¼ˆè¿è¡Œä¸æ­¢ä¸€ä¸ªå‰¯æœ¬ï¼‰ä»¥æå‡æ€§èƒ½æˆ–è€…å¢å¼ºå®¹é”™èƒ½åŠ›ã€‚</p><p>ä¸‹é¢çš„æ§åˆ¶å™¨éƒ½åŒ…å«å¯¹äº‘å¹³å°é©±åŠ¨çš„ä¾èµ–ï¼š</p><ul><li>èŠ‚ç‚¹æ§åˆ¶å™¨ï¼ˆNode Controllerï¼‰: ç”¨äºåœ¨èŠ‚ç‚¹ç»ˆæ­¢å“åº”åæ£€æŸ¥äº‘æä¾›å•†ä»¥ç¡®å®šèŠ‚ç‚¹æ˜¯å¦å·²è¢«åˆ é™¤</li><li>è·¯ç”±æ§åˆ¶å™¨ï¼ˆRoute Controllerï¼‰: ç”¨äºåœ¨åº•å±‚äº‘åŸºç¡€æ¶æ„ä¸­è®¾ç½®è·¯ç”±</li><li>æœåŠ¡æ§åˆ¶å™¨ï¼ˆService Controllerï¼‰: ç”¨äºåˆ›å»ºã€æ›´æ–°å’Œåˆ é™¤äº‘æä¾›å•†è´Ÿè½½å‡è¡¡å™¨</li></ul><h2 id="Node-ç»„ä»¶"><a href="#Node-ç»„ä»¶" class="headerlink" title="Node ç»„ä»¶"></a>Node ç»„ä»¶</h2><p>èŠ‚ç‚¹ç»„ä»¶åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œï¼Œç»´æŠ¤è¿è¡Œçš„ Pod å¹¶æä¾› Kubernetes è¿è¡Œç¯å¢ƒã€‚</p><h3 id="kubelet"><a href="#kubelet" class="headerlink" title="kubelet"></a>kubelet</h3><p>ä¸€ä¸ªåœ¨é›†ç¾¤ä¸­æ¯ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œçš„ä»£ç†ã€‚å®ƒä¿è¯å®¹å™¨éƒ½è¿è¡Œåœ¨ Pod ä¸­ã€‚</p><p>kubelet æ¥æ”¶ä¸€ç»„é€šè¿‡å„ç±»æœºåˆ¶æä¾›ç»™å®ƒçš„ PodSpecsï¼Œç¡®ä¿è¿™äº› PodSpecs ä¸­æè¿°çš„å®¹å™¨å¤„äºè¿è¡ŒçŠ¶æ€ä¸”å¥åº·ã€‚kubelet ä¸ä¼šç®¡ç†ä¸æ˜¯ç”± Kubernetes åˆ›å»ºçš„å®¹å™¨ã€‚</p><h3 id="kube-proxy"><a href="#kube-proxy" class="headerlink" title="kube-proxy"></a>kube-proxy</h3><p><a href="https://kubernetes.io/docs/reference/command-line-tools-reference/kube-proxy/" target="_blank" rel="noopener">kube-proxy</a> æ˜¯é›†ç¾¤ä¸­æ¯ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œçš„ç½‘ç»œä»£ç†,å®ç° Kubernetes <a href="https://kubernetes.io/zh/docs/concepts/services-networking/service/" target="_blank" rel="noopener">Service</a> æ¦‚å¿µçš„ä¸€éƒ¨åˆ†ã€‚</p><p>kube-proxy ç»´æŠ¤èŠ‚ç‚¹ä¸Šçš„ç½‘ç»œè§„åˆ™ã€‚è¿™äº›ç½‘ç»œè§„åˆ™å…è®¸ä»é›†ç¾¤å†…éƒ¨æˆ–å¤–éƒ¨çš„ç½‘ç»œä¼šè¯ä¸ Pod è¿›è¡Œç½‘ç»œé€šä¿¡ã€‚</p><p>å¦‚æœæ“ä½œç³»ç»Ÿæä¾›äº†æ•°æ®åŒ…è¿‡æ»¤å±‚å¹¶å¯ç”¨çš„è¯ï¼Œkube-proxyä¼šé€šè¿‡å®ƒæ¥å®ç°ç½‘ç»œè§„åˆ™ã€‚å¦åˆ™ï¼Œkube-proxy ä»…è½¬å‘æµé‡æœ¬èº«ã€‚</p><h3 id="å®¹å™¨è¿è¡Œæ—¶ï¼ˆContainer-Runtimeï¼‰"><a href="#å®¹å™¨è¿è¡Œæ—¶ï¼ˆContainer-Runtimeï¼‰" class="headerlink" title="å®¹å™¨è¿è¡Œæ—¶ï¼ˆContainer Runtimeï¼‰"></a>å®¹å™¨è¿è¡Œæ—¶ï¼ˆContainer Runtimeï¼‰</h3><p>å®¹å™¨è¿è¡Œç¯å¢ƒæ˜¯è´Ÿè´£è¿è¡Œå®¹å™¨çš„è½¯ä»¶ã€‚</p><p>Kubernetes æ”¯æŒå¤šä¸ªå®¹å™¨è¿è¡Œç¯å¢ƒ: <a href="http://www.docker.com/" target="_blank" rel="noopener">Docker</a>ã€ <a href="https://containerd.io/" target="_blank" rel="noopener">containerd</a>ã€<a href="https://cri-o.io/" target="_blank" rel="noopener">cri-o</a>ã€ <a href="https://github.com/kubernetes-incubator/rktlet" target="_blank" rel="noopener">rktlet</a> ä»¥åŠä»»ä½•å®ç° <a href="https://github.com/kubernetes/community/blob/master/contributors/devel/sig-node/container-runtime-interface.md" target="_blank" rel="noopener">Kubernetes CRI (å®¹å™¨è¿è¡Œç¯å¢ƒæ¥å£)</a>ã€‚</p><h2 id="æ’ä»¶ï¼ˆAddonsï¼‰"><a href="#æ’ä»¶ï¼ˆAddonsï¼‰" class="headerlink" title="æ’ä»¶ï¼ˆAddonsï¼‰"></a>æ’ä»¶ï¼ˆAddonsï¼‰</h2><p>æ’ä»¶ä½¿ç”¨ Kubernetes èµ„æºï¼ˆ<a href="https://kubernetes.io/zh/docs/concepts/workloads/controllers/daemonset/" target="_blank" rel="noopener">DaemonSet</a>ã€ <a href="https://kubernetes.io/zh/docs/concepts/workloads/controllers/deployment/" target="_blank" rel="noopener">Deployment</a>ç­‰ï¼‰å®ç°é›†ç¾¤åŠŸèƒ½ã€‚ å› ä¸ºè¿™äº›æ’ä»¶æä¾›é›†ç¾¤çº§åˆ«çš„åŠŸèƒ½ï¼Œæ’ä»¶ä¸­å‘½åç©ºé—´åŸŸçš„èµ„æºå±äº <code>kube-system</code> å‘½åç©ºé—´ã€‚</p><p>ä¸‹é¢æè¿°ä¼—å¤šæ’ä»¶ä¸­çš„å‡ ç§ã€‚æœ‰å…³å¯ç”¨æ’ä»¶çš„å®Œæ•´åˆ—è¡¨ï¼Œè¯·å‚è§ <a href="https://kubernetes.io/zh/docs/concepts/cluster-administration/addons/" target="_blank" rel="noopener">æ’ä»¶ï¼ˆAddonsï¼‰</a>ã€‚</p><h3 id="DNS"><a href="#DNS" class="headerlink" title="DNS"></a>DNS</h3><p>å°½ç®¡å…¶ä»–æ’ä»¶éƒ½å¹¶éä¸¥æ ¼æ„ä¹‰ä¸Šçš„å¿…éœ€ç»„ä»¶ï¼Œä½†å‡ ä¹æ‰€æœ‰ Kubernetes é›†ç¾¤éƒ½åº”è¯¥ æœ‰<a href="https://kubernetes.io/zh/docs/concepts/services-networking/dns-pod-service/" target="_blank" rel="noopener">é›†ç¾¤ DNS</a>ï¼Œ å› ä¸ºå¾ˆå¤šç¤ºä¾‹éƒ½éœ€è¦ DNS æœåŠ¡ã€‚</p><p>é›†ç¾¤ DNS æ˜¯ä¸€ä¸ª DNS æœåŠ¡å™¨ï¼Œå’Œç¯å¢ƒä¸­çš„å…¶ä»– DNS æœåŠ¡å™¨ä¸€èµ·å·¥ä½œï¼Œå®ƒä¸º Kubernetes æœåŠ¡æä¾› DNS è®°å½•ã€‚</p><p>Kubernetes å¯åŠ¨çš„å®¹å™¨è‡ªåŠ¨å°†æ­¤ DNS æœåŠ¡å™¨åŒ…å«åœ¨å…¶ DNS æœç´¢åˆ—è¡¨ä¸­ã€‚</p><h3 id="Web-ç•Œé¢ï¼ˆä»ªè¡¨ç›˜ï¼‰"><a href="#Web-ç•Œé¢ï¼ˆä»ªè¡¨ç›˜ï¼‰" class="headerlink" title="Web ç•Œé¢ï¼ˆä»ªè¡¨ç›˜ï¼‰"></a>Web ç•Œé¢ï¼ˆä»ªè¡¨ç›˜ï¼‰</h3><p><a href="https://kubernetes.io/zh/docs/tasks/access-application-cluster/web-ui-dashboard/" target="_blank" rel="noopener">Dashboard</a> æ˜¯K ubernetes é›†ç¾¤çš„é€šç”¨çš„ã€åŸºäº Web çš„ç”¨æˆ·ç•Œé¢ã€‚ å®ƒä½¿ç”¨æˆ·å¯ä»¥ç®¡ç†é›†ç¾¤ä¸­è¿è¡Œçš„åº”ç”¨ç¨‹åºä»¥åŠé›†ç¾¤æœ¬èº«å¹¶è¿›è¡Œæ•…éšœæ’é™¤ã€‚</p><h3 id="å®¹å™¨èµ„æºç›‘æ§"><a href="#å®¹å™¨èµ„æºç›‘æ§" class="headerlink" title="å®¹å™¨èµ„æºç›‘æ§"></a>å®¹å™¨èµ„æºç›‘æ§</h3><p><a href="https://kubernetes.io/zh/docs/tasks/debug-application-cluster/resource-usage-monitoring/" target="_blank" rel="noopener">å®¹å™¨èµ„æºç›‘æ§</a> å°†å…³äºå®¹å™¨çš„ä¸€äº›å¸¸è§çš„æ—¶é—´åºåˆ—åº¦é‡å€¼ä¿å­˜åˆ°ä¸€ä¸ªé›†ä¸­çš„æ•°æ®åº“ä¸­ï¼Œå¹¶æä¾›ç”¨äºæµè§ˆè¿™äº›æ•°æ®çš„ç•Œé¢ã€‚</p><h3 id="é›†ç¾¤å±‚é¢æ—¥å¿—"><a href="#é›†ç¾¤å±‚é¢æ—¥å¿—" class="headerlink" title="é›†ç¾¤å±‚é¢æ—¥å¿—"></a>é›†ç¾¤å±‚é¢æ—¥å¿—</h3><p><a href="https://kubernetes.io/zh/docs/concepts/cluster-administration/logging/" target="_blank" rel="noopener">é›†ç¾¤å±‚é¢æ—¥å¿—</a> æœºåˆ¶è´Ÿè´£å°†å®¹å™¨çš„æ—¥å¿—æ•°æ® ä¿å­˜åˆ°ä¸€ä¸ªé›†ä¸­çš„æ—¥å¿—å­˜å‚¨ä¸­ï¼Œè¯¥å­˜å‚¨èƒ½å¤Ÿæä¾›æœç´¢å’Œæµè§ˆæ¥å£ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> å®¹å™¨ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Shellè„šæœ¬åŠ å¯†ç»éªŒåˆ†äº«</title>
      <link href="2020/10/01/linux/shell/shell-jiao-ben-jia-mi-jing-yan-fen-xiang/"/>
      <url>2020/10/01/linux/shell/shell-jiao-ben-jia-mi-jing-yan-fen-xiang/</url>
      
        <content type="html"><![CDATA[<h5 id="ä¸ºå•¥è¦åŠ å¯†shellè„šæœ¬"><a href="#ä¸ºå•¥è¦åŠ å¯†shellè„šæœ¬" class="headerlink" title="ä¸ºå•¥è¦åŠ å¯†shellè„šæœ¬"></a><strong>ä¸ºå•¥è¦åŠ å¯†shellè„šæœ¬</strong></h5><p>ä»¥æˆ‘ä¸ªäººçš„éœ€æ±‚ä¸ºä¾‹ï¼Œæˆ‘è¦åšä¸€ä¸ªè‡ªåŠ¨è¿œç¨‹ç™»å½•çš„è„šæœ¬ï¼Œæ¯æ¬¡æ‰‹åŠ¨è¾“å¯†ç å¤ªæ…¢ï¼Œè€Œä¸”è¾“çš„å¤šäº†å¯†ç ä¹Ÿå®¹æ˜“æ³„éœ²ï¼›ç›´æ¥æŠŠå¯†ç å†™åœ¨è„šæœ¬é‡Œï¼Œå¿«ç¡®å®æ˜¯å¿«ï¼Œä½†æ˜¯å®‰å…¨æ€§è®©äººæ— æ³•å¿å—ï¼Œå†™è„šæœ¬çš„æ—¶å€™éƒ½æœ‰å¯èƒ½è¢«è¿‡è·¯çš„ä¸å°å¿ƒçœ‹åˆ°å¯†ç ï¼Œè¿™å°±å¤ªè›‹ç–¼äº†ã€‚</p><p><strong>shellè„šæœ¬åŠ å¯†å¸¸ç”¨çš„æœ‰ä¸‰ç§æ–¹æ³•ï¼š*</strong>gzexe,shc,upx*</p><h6 id="ç¬¬ä¸€ç§ï¼Œgzexe"><a href="#ç¬¬ä¸€ç§ï¼Œgzexe" class="headerlink" title="ç¬¬ä¸€ç§ï¼Œgzexe"></a><strong>ç¬¬ä¸€ç§ï¼Œgzexe</strong></h6><p><strong>ç‰¹ç‚¹æ˜¯ä¸ç”¨å®‰è£…ï¼ŒåŠ è§£å¯†æå…¶ç®€å•ï¼Œæˆ‘ä¸ªäººçš„æ“ä½œç¯å¢ƒæ˜¯macOS,ç›´æ¥å°±å¯ä»¥ç”¨ï¼Œå‘½ä»¤ç®€å•ç²—æš´</strong></p><pre><code>åŠ å¯†gzexe l.shè§£å¯†gzexe -d l.sh å¤åˆ¶</code></pre><p><strong>ç»“è®º:</strong>gzexeå…¶å®å°±æ˜¯ä¸ªå‹ç¼©å·¥å…·ï¼Œèƒ½èµ·åˆ°éšè—æ–‡ä»¶å†…å®¹çš„æ•ˆæœï¼Œæ‰§è¡Œé€Ÿåº¦å‡ ä¹å’Œè„šæœ¬ä¸€æ ·(åœ¨è„šæœ¬ä¸å¤ªå¤§çš„æƒ…å†µä¸‹),ä½†æ˜¯å¦‚æœåŠ å¯†æ–‡ä»¶æœ¬èº«è¢«å·èµ°ï¼Œé‚£å°±å‡‰å‡‰ï¼Œè½»æ¾å¯ä»¥ç ´è§£ï¼Œå½“ç„¶é«˜æ‰‹ä¹Ÿå¯ä»¥äºŒæ®µåŠ å¯†ï¼Œæ¯”å¦‚æ‰‹åŠ¨ä¿®æ”¹åŠ å¯†åçš„æ–‡ä»¶ä»€ä¹ˆçš„ï¼Œä½†æ˜¯è¿™å°±æ˜¯ä¸€ä¸ªé“é«˜ä¸€å°ºé­”é«˜ä¸€ä¸ˆçš„äº‹äº†ã€‚</p><h6 id="ç¬¬äºŒç§-shc"><a href="#ç¬¬äºŒç§-shc" class="headerlink" title="ç¬¬äºŒç§,shc"></a><strong>ç¬¬äºŒç§,shc</strong></h6><p>å®‰è£…æ–¹æ³•ç•¥è¿‡ï¼Œå¤§å®¶å¯ä»¥è‡ªè¡Œç™¾åº¦ï¼Œè¿™é‡Œç›´æ¥å®æˆ˜ã€‚<br>shcåŠ å¯†ä»¥åï¼ŒåŸæ–‡ä»¶ä¸ä¼šå˜ï¼Œä¼šç”Ÿæˆä¸€ä¸ªåŸæ–‡ä»¶å.xçš„åŠ å¯†åçš„æ–‡ä»¶ï¼Œæˆ‘è¿™é‡Œå°±æ˜¯l.sh.xäº†<br><strong>åŠ å¯†å‘½ä»¤</strong></p><pre><code>shc -r -f l.sh å¤åˆ¶</code></pre><p><strong>ä½†æ˜¯shcæœ‰ä¸ªé—®é¢˜ï¼Œå¯¹äºæˆ‘æ¥è¯´æ˜¯å¾ˆä¸¥é‡çš„ï¼Œå°±æ˜¯åŠ å¯†åçš„è„šæœ¬æ‰§è¡Œéå¸¸æ…¢</strong><br><strong>vim test.sh</strong></p><pre><code>#!/bin/bash# åŠ å¯†å‰start=$(date &quot;+%s&quot;)for i in {1..100}{    ./l.sh}end=$(date &quot;+%s&quot;)echo åŠ å¯†å‰æ‰§è¡Œç”¨æ—¶:$[$end-$start]&quot;ç§’&quot;# åŠ å¯†åstart=$(date &quot;+%s&quot;)./l.sh.xend=$(date &quot;+%s&quot;)echo åŠ å¯†åæ‰§è¡Œç”¨æ—¶:$[$end-$start]&quot;ç§’&quot; å¤åˆ¶</code></pre><p><strong>åŸå§‹è„šæœ¬æ‰§è¡Œ100éï¼Œç”¨æ—¶ä¸åˆ°1ç§’ï¼ŒshcåŠ å¯†åæ‰§è¡Œä¸€æ¬¡ç”¨æ—¶3ç§’ï¼Œè¿™tmæ…¢å¦‚ç‹—å“‡ï¼Œå¦‚æœæ¯æ¬¡æ‰§è¡Œè„šæœ¬éƒ½æ˜¯è¿™ä¸ªé€Ÿåº¦,å®Œå…¨ä¸èƒ½å¿!</strong><br><strong>æ€»ç»“:shcå®‰å…¨æ€§ç¨å¥½ï¼Œè‡³å°‘è§£å¯†èµ·æ¥ä¸å¤ªå®¹æ˜“ï¼Œä½†æ˜¯åŠ å¯†åæ‰§è¡Œé€Ÿåº¦å¤ªæ…¢ï¼Œæ— æ³•å¿å—ã€‚</strong></p><h6 id="ç¬¬ä¸‰ç§-upx"><a href="#ç¬¬ä¸‰ç§-upx" class="headerlink" title="ç¬¬ä¸‰ç§,upx"></a><strong>ç¬¬ä¸‰ç§,upx</strong></h6><p><strong>upxæ˜¯ä¸€ä¸ªåŠ å£³å·¥å…·ï¼Œä¸»è¦ç”¨æ¥ç»™å¯æ‰§è¡Œæ–‡ä»¶åŠ å¯†ç”¨çš„ï¼Œä½†æ˜¯ç½‘ä¸Šä¹Ÿæœ‰æ–‡ç« è¯´å¯ä»¥ç»™shellè„šæœ¬åŠ å¯†ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±æ¥è¯•è¯•ã€‚</strong><br><strong>upxå®‰è£…ä¸åºŸè¯äº†ï¼Œå¤§å®¶å¯ä»¥è‡ªè¡Œç™¾åº¦ï¼Œè¿™é‡Œç›´æ¥æ“ç»ƒã€‚</strong></p><pre><code>upxåŠ å¯†å‘½ä»¤# æœ€å¿«å‹ç¼©upx -1 l.sh# æœ€å¼ºå‹ç¼©upx -9 l.sh å¤åˆ¶</code></pre><p><strong>å‡ºå¸ˆä¸åˆ©ï¼Œupxä¸èƒ½å‹ç¼©å¤ªå°æ–‡ä»¶ï¼Œè€Œè„šæœ¬ä¼—æ‰€å‘¨çŸ¥ä¸€èˆ¬éƒ½ä¸å¤§ï¼Œupxå¯¹shellè„šæœ¬ä»·å€¼å‡å°‘90%ã€‚</strong></p><p>æˆ‘åæ¥åˆç»™è„šæœ¬åŠ äº†ä¸€å †æ³¨é‡Šï¼Œå¼ºè¡Œå¢å¤§äº†è„šæœ¬ï¼ŒupxåŠ å¯†æ˜¯èƒ½åŠ å¯†äº†ï¼Œä½†æ˜¯æ‰§è¡Œä¸äº†æœ‰æ¯›ç”¨å•Šï¼æ€€ç–‘æ˜¯è„šæœ¬ä¸ç®—å¯æ‰§è¡Œæ–‡ä»¶ï¼Œç”¨gzexeæŠŠè„šæœ¬ææˆäº†å¯æ‰§è¡Œæ–‡ä»¶ï¼Œåˆå‹ç¼©äº†ä¸€éï¼Œè¿™å›ç¡®å®šäº†ï¼ŒupxåŠ å¯†åçš„è„šæœ¬å°±æ˜¯æ²¡æ³•æ‰§è¡Œï¼Œupxå¯¹shellè„šæœ¬ä»·å€¼å‡å°ä¸º0ã€‚<br>æœ‰ä¸ä¿¡é‚ªçš„æœ‹å‹å¯ä»¥è‡ªå·±è¯•è¯•ï¼Œæˆ‘åœ¨macOSä¸Šå°è¯•çš„ç»“æœæ˜¯è¿™æ ·çš„ï¼Œæˆ–è®¸å…¶ä»–å¹³å°ä¼šæœ‰ä¸ä¸€æ ·çš„è¡¨ç°å‘¢ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> shell </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mycat</title>
      <link href="2020/09/28/sql/mycat/"/>
      <url>2020/09/28/sql/mycat/</url>
      
        <content type="html"><![CDATA[<h2 id="MySQL-Replication"><a href="#MySQL-Replication" class="headerlink" title="MySQL-Replication"></a>MySQL-Replication</h2><h3 id="MySQL-Replication-1"><a href="#MySQL-Replication-1" class="headerlink" title="MySQL Replication"></a>MySQL Replication</h3><p>ä¸»ä»å¤åˆ¶ï¼ˆä¹Ÿç§° AB å¤åˆ¶ï¼‰å…è®¸å°†æ¥è‡ªä¸€ä¸ªMySQLæ•°æ®åº“æœåŠ¡å™¨ï¼ˆä¸»æœåŠ¡å™¨ï¼‰çš„æ•°æ®å¤åˆ¶åˆ°ä¸€ä¸ªæˆ–å¤šä¸ªMySQLæ•°æ®åº“æœåŠ¡å™¨ï¼ˆä»æœåŠ¡å™¨ï¼‰ã€‚</p><blockquote><p>å¤åˆ¶æ˜¯å¼‚æ­¥çš„ ä»ç«™ä¸éœ€è¦æ°¸ä¹…è¿æ¥ä»¥æ¥æ”¶æ¥è‡ªä¸»ç«™çš„æ›´æ–°ã€‚</p></blockquote><p>æ ¹æ®é…ç½®ï¼Œæ‚¨å¯ä»¥å¤åˆ¶æ•°æ®åº“ä¸­çš„æ‰€æœ‰æ•°æ®åº“ï¼Œæ‰€é€‰æ•°æ®åº“ç”šè‡³é€‰å®šçš„è¡¨ã€‚</p><p>MySQLä¸­å¤åˆ¶çš„ä¼˜ç‚¹åŒ…æ‹¬ï¼š</p><ul><li>æ¨ªå‘æ‰©å±•è§£å†³æ–¹æ¡ˆ - åœ¨å¤šä¸ªä»ç«™ä¹‹é—´åˆ†é…è´Ÿè½½ä»¥æé«˜æ€§èƒ½ã€‚åœ¨æ­¤ç¯å¢ƒä¸­ï¼Œæ‰€æœ‰å†™å…¥å’Œæ›´æ–°éƒ½å¿…é¡»åœ¨ä¸»æœåŠ¡å™¨ä¸Šè¿›è¡Œã€‚ä½†æ˜¯ï¼Œè¯»å–å¯ä»¥åœ¨ä¸€ä¸ªæˆ–å¤šä¸ªä»è®¾å¤‡ä¸Šè¿›è¡Œã€‚è¯¥æ¨¡å‹å¯ä»¥æé«˜å†™å…¥æ€§èƒ½ï¼ˆå› ä¸ºä¸»è®¾å¤‡ä¸“ç”¨äºæ›´æ–°ï¼‰ï¼ŒåŒæ—¶æ˜¾ç€æé«˜äº†è¶Šæ¥è¶Šå¤šçš„ä»è®¾å¤‡çš„è¯»å–é€Ÿåº¦ã€‚</li><li>æ•°æ®å®‰å…¨æ€§ - å› ä¸ºæ•°æ®è¢«å¤åˆ¶åˆ°ä»ç«™ï¼Œå¹¶ä¸”ä»ç«™å¯ä»¥æš‚åœå¤åˆ¶è¿‡ç¨‹ï¼Œæ‰€ä»¥å¯ä»¥åœ¨ä»ç«™ä¸Šè¿è¡Œå¤‡ä»½æœåŠ¡è€Œä¸ä¼šç ´åç›¸åº”çš„ä¸»æ•°æ®ã€‚</li><li>åˆ†æ - å¯ä»¥åœ¨ä¸»æœåŠ¡å™¨ä¸Šåˆ›å»ºå®æ—¶æ•°æ®ï¼Œè€Œä¿¡æ¯åˆ†æå¯ä»¥åœ¨ä»æœåŠ¡å™¨ä¸Šè¿›è¡Œï¼Œè€Œä¸ä¼šå½±å“ä¸»æœåŠ¡å™¨çš„æ€§èƒ½ã€‚</li><li>è¿œç¨‹æ•°æ®åˆ†å‘ - æ‚¨å¯ä»¥ä½¿ç”¨å¤åˆ¶ä¸ºè¿œç¨‹ç«™ç‚¹åˆ›å»ºæ•°æ®çš„æœ¬åœ°å‰¯æœ¬ï¼Œè€Œæ— éœ€æ°¸ä¹…è®¿é—®ä¸»æœåŠ¡å™¨ã€‚</li></ul><h3 id="Replicationçš„åŸç†"><a href="#Replicationçš„åŸç†" class="headerlink" title="Replicationçš„åŸç†"></a>Replicationçš„åŸç†</h3><p><img src="https://i.loli.net/2019/08/13/b8YDSUo3ZM6wLtx.jpg" alt=""></p><p>å‰ææ˜¯ä½œä¸ºä¸»æœåŠ¡å™¨è§’è‰²çš„æ•°æ®åº“æœåŠ¡å™¨å¿…é¡»å¼€å¯äºŒè¿›åˆ¶æ—¥å¿—</p><pre><code>ä¸»æœåŠ¡å™¨ä¸Šé¢çš„ä»»ä½•ä¿®æ”¹éƒ½ä¼šé€šè¿‡è‡ªå·±çš„ I/O tread(I/O çº¿ç¨‹)ä¿å­˜åœ¨äºŒè¿›åˆ¶æ—¥å¿— Binary log é‡Œé¢ã€‚ä»æœåŠ¡å™¨ä¸Šé¢ä¹Ÿå¯åŠ¨ä¸€ä¸ª I/O threadï¼Œé€šè¿‡é…ç½®å¥½çš„ç”¨æˆ·åå’Œå¯†ç , è¿æ¥åˆ°ä¸»æœåŠ¡å™¨ä¸Šé¢è¯·æ±‚è¯»å–äºŒè¿›åˆ¶æ—¥å¿—ï¼Œç„¶åæŠŠè¯»å–åˆ°çš„äºŒè¿›åˆ¶æ—¥å¿—å†™åˆ°æœ¬åœ°çš„ä¸€ä¸ªRealy logï¼ˆä¸­ç»§æ—¥å¿—ï¼‰é‡Œé¢ã€‚ä»æœåŠ¡å™¨ä¸Šé¢åŒæ—¶å¼€å¯ä¸€ä¸ª SQL thread å®šæ—¶æ£€æŸ¥ Realy log(è¿™ä¸ªæ–‡ä»¶ä¹Ÿæ˜¯äºŒè¿›åˆ¶çš„)ï¼Œå¦‚æœå‘ç°æœ‰æ›´æ–°ç«‹å³æŠŠæ›´æ–°çš„å†…å®¹åœ¨æœ¬æœºçš„æ•°æ®åº“ä¸Šé¢æ‰§è¡Œä¸€éã€‚æ¯ä¸ªä»æœåŠ¡å™¨éƒ½ä¼šæ”¶åˆ°ä¸»æœåŠ¡å™¨äºŒè¿›åˆ¶æ—¥å¿—çš„å…¨éƒ¨å†…å®¹çš„å‰¯æœ¬ã€‚ä»æœåŠ¡å™¨è®¾å¤‡è´Ÿè´£å†³å®šåº”è¯¥æ‰§è¡ŒäºŒè¿›åˆ¶æ—¥å¿—ä¸­çš„å“ªäº›è¯­å¥ã€‚é™¤éå¦è¡ŒæŒ‡å®šï¼Œå¦åˆ™ä¸»ä»äºŒè¿›åˆ¶æ—¥å¿—ä¸­çš„æ‰€æœ‰äº‹ä»¶éƒ½åœ¨ä»ç«™ä¸Šæ‰§è¡Œã€‚å¦‚æœéœ€è¦ï¼Œæ‚¨å¯ä»¥å°†ä»æœåŠ¡å™¨é…ç½®ä¸ºä»…å¤„ç†ä¸€äº›ç‰¹å®šæ•°æ®åº“æˆ–è¡¨çš„äº‹ä»¶ã€‚é‡è¦: æ‚¨æ— æ³•å°†ä¸»æœåŠ¡å™¨é…ç½®ä¸ºä»…è®°å½•ç‰¹å®šäº‹ä»¶ã€‚æ¯ä¸ªä»ç«™(ä»æœåŠ¡å™¨)éƒ½ä¼šè®°å½•äºŒè¿›åˆ¶æ—¥å¿—åæ ‡ï¼š     æ–‡ä»¶å     æ–‡ä»¶ä¸­å®ƒå·²ç»ä»ä¸»ç«™è¯»å–å’Œå¤„ç†çš„ä½ç½®ã€‚ç”±äºæ¯ä¸ªä»æœåŠ¡å™¨éƒ½åˆ†åˆ«è®°å½•äº†è‡ªå·±å½“å‰å¤„ç†äºŒè¿›åˆ¶æ—¥å¿—ä¸­çš„ä½ç½®ï¼Œå› æ­¤å¯ä»¥æ–­å¼€ä»æœåŠ¡å™¨çš„è¿æ¥ï¼Œé‡æ–°è¿æ¥ç„¶åæ¢å¤ç»§ç»­å¤„ç†ã€‚</code></pre><h5 id="ä¸€ä¸»å¤šä»"><a href="#ä¸€ä¸»å¤šä»" class="headerlink" title="ä¸€ä¸»å¤šä»"></a>ä¸€ä¸»å¤šä»</h5><p>å¦‚æœä¸€ä¸»å¤šä»çš„è¯ï¼Œè¿™æ—¶ä¸»åº“æ—¢è¦è´Ÿè´£å†™åˆè¦è´Ÿè´£ä¸ºå‡ ä¸ªä»åº“æä¾›äºŒè¿›åˆ¶æ—¥å¿—ã€‚æ­¤æ—¶å¯ä»¥ç¨åšè°ƒæ•´ï¼Œå°†äºŒè¿›åˆ¶æ—¥å¿—åªç»™æŸä¸€ä»ï¼Œè¿™ä¸€ä»å†å¼€å¯äºŒè¿›åˆ¶æ—¥å¿—å¹¶å°†è‡ªå·±çš„äºŒè¿›åˆ¶æ—¥å¿—å†å‘ç»™å…¶å®ƒä»ã€‚æˆ–è€…æ˜¯å¹²è„†è¿™ä¸ªä»ä¸è®°å½•åªè´Ÿè´£å°†äºŒè¿›åˆ¶æ—¥å¿—è½¬å‘ç»™å…¶å®ƒä»ï¼Œè¿™æ ·æ¶æ„èµ·æ¥æ€§èƒ½å¯èƒ½è¦å¥½å¾—å¤šï¼Œè€Œä¸”æ•°æ®ä¹‹é—´çš„å»¶æ—¶åº”è¯¥ä¹Ÿç¨å¾®è¦å¥½ä¸€äº›ã€‚å·¥ä½œåŸç†å›¾å¦‚ä¸‹ï¼š</p><p><img src="https://i.loli.net/2019/08/13/1e8xfpo5rMt3Blg.jpg" alt=""></p><p>ç»ƒä¹ é¢˜:</p><pre class=" language-reStructuredText"><code class="language-reStructuredText">ä½¿ç”¨ä¸‰å°æœºå™¨æ­å»ºä¸€ä¸»å¤šä»çš„mysqlæ¶æ„å¹¶èƒ½å¤Ÿå®ç°æ•°æ®åŒæ­¥, éƒ¨ç½²å½¢å¼ä¸é™<è„šæœ¬ã€æ‰‹åŠ¨éƒ½å¯></code></pre><h4 id="å…³äºäºŒè¿›åˆ¶æ—¥å¿—"><a href="#å…³äºäºŒè¿›åˆ¶æ—¥å¿—" class="headerlink" title="å…³äºäºŒè¿›åˆ¶æ—¥å¿—"></a>å…³äºäºŒè¿›åˆ¶æ—¥å¿—</h4><p><a href="https://links.jianshu.com/go?to=https%3A%2F%2Fdev.mysql.com%2Fdoc%2Frefman%2F5.7%2Fen%2Fmysqld.html" target="_blank" rel="noopener"><strong>mysqld</strong></a>å°†æ•°å­—æ‰©å±•åé™„åŠ åˆ°äºŒè¿›åˆ¶æ—¥å¿—åŸºæœ¬åç§°ä»¥ç”ŸæˆäºŒè¿›åˆ¶æ—¥å¿—æ–‡ä»¶åã€‚æ¯æ¬¡æœåŠ¡å™¨åˆ›å»ºæ–°æ—¥å¿—æ–‡ä»¶æ—¶ï¼Œè¯¥æ•°å­—éƒ½ä¼šå¢åŠ ï¼Œä»è€Œåˆ›å»ºä¸€ç³»åˆ—æœ‰åºçš„æ–‡ä»¶ã€‚æ¯æ¬¡å¯åŠ¨æˆ–åˆ·æ–°æ—¥å¿—æ—¶ï¼ŒæœåŠ¡å™¨éƒ½ä¼šåœ¨ç³»åˆ—ä¸­åˆ›å»ºä¸€ä¸ªæ–°æ–‡ä»¶ã€‚æœåŠ¡å™¨è¿˜ä¼šåœ¨å½“å‰æ—¥å¿—å¤§å°è¾¾åˆ°<a href="https://links.jianshu.com/go?to=https%3A%2F%2Fdev.mysql.com%2Fdoc%2Frefman%2F5.7%2Fen%2Freplication-options-binary-log.html%23sysvar_max_binlog_size" target="_blank" rel="noopener"><code>max_binlog_size</code></a>å‚æ•°è®¾ç½®çš„å¤§å°åè‡ªåŠ¨åˆ›å»ºæ–°çš„äºŒè¿›åˆ¶æ—¥å¿—æ–‡ä»¶ ã€‚äºŒè¿›åˆ¶æ—¥å¿—æ–‡ä»¶å¯èƒ½ä¼šæ¯”<a href="https://links.jianshu.com/go?to=https%3A%2F%2Fdev.mysql.com%2Fdoc%2Frefman%2F5.7%2Fen%2Freplication-options-binary-log.html%23sysvar_max_binlog_size" target="_blank" rel="noopener"><code>max_binlog_size</code></a>ä½¿ç”¨å¤§å‹äº‹åŠ¡æ—¶æ›´å¤§ï¼Œ å› ä¸ºäº‹åŠ¡æ˜¯ä»¥ä¸€ä¸ªéƒ¨åˆ†å†™å…¥æ–‡ä»¶ï¼Œè€Œä¸æ˜¯åœ¨æ–‡ä»¶ä¹‹é—´åˆ†å‰²ã€‚</p><p>ä¸ºäº†è·Ÿè¸ªå·²ä½¿ç”¨çš„äºŒè¿›åˆ¶æ—¥å¿—æ–‡ä»¶ï¼Œ <a href="https://links.jianshu.com/go?to=https%3A%2F%2Fdev.mysql.com%2Fdoc%2Frefman%2F5.7%2Fen%2Fmysqld.html" target="_blank" rel="noopener"><strong>mysqld</strong></a>è¿˜åˆ›å»ºäº†ä¸€ä¸ªäºŒè¿›åˆ¶æ—¥å¿—ç´¢å¼•æ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«æ‰€æœ‰ä½¿ç”¨çš„äºŒè¿›åˆ¶æ—¥å¿—æ–‡ä»¶çš„åç§°ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå®ƒå…·æœ‰ä¸äºŒè¿›åˆ¶æ—¥å¿—æ–‡ä»¶ç›¸åŒçš„åŸºæœ¬åç§°ï¼Œå¹¶å¸¦æœ‰æ‰©å±•å<code>&#39;.index&#39;</code>ã€‚åœ¨<a href="https://links.jianshu.com/go?to=https%3A%2F%2Fdev.mysql.com%2Fdoc%2Frefman%2F5.7%2Fen%2Fmysqld.html" target="_blank" rel="noopener"><strong>mysqld</strong></a>è¿è¡Œæ—¶ï¼Œæ‚¨ä¸åº”æ‰‹åŠ¨ç¼–è¾‘æ­¤æ–‡ä»¶ã€‚</p><p>æœ¯è¯­<code>äºŒè¿›åˆ¶æ—¥å¿—æ–‡ä»¶</code>é€šå¸¸è¡¨ç¤ºåŒ…å«æ•°æ®åº“äº‹ä»¶çš„å•ä¸ªç¼–å·æ–‡ä»¶ã€‚</p><p>æœ¯è¯­ <code>äºŒè¿›åˆ¶æ—¥å¿—</code>  è¡¨ç¤ºå«ç¼–å·çš„äºŒè¿›åˆ¶æ—¥å¿—æ–‡ä»¶é›†åŠ ä¸Šç´¢å¼•æ–‡ä»¶ã€‚</p><p><code>SUPER</code> æƒé™çš„ç”¨æˆ·å¯ä»¥ä½¿ç”¨<code>SET sql_log_bin=0</code>è¯­å¥ç¦ç”¨å…¶å½“å‰ç¯å¢ƒä¸‹è‡ªå·±çš„è¯­å¥çš„äºŒè¿›åˆ¶æ—¥å¿—è®°å½•</p><h3 id="é…ç½®Replication"><a href="#é…ç½®Replication" class="headerlink" title="é…ç½®Replication"></a>é…ç½®Replication</h3><h5 id="é…ç½®æ­¥éª¤ï¼š"><a href="#é…ç½®æ­¥éª¤ï¼š" class="headerlink" title="é…ç½®æ­¥éª¤ï¼š"></a>é…ç½®æ­¥éª¤ï¼š</h5><ol><li>åœ¨ä¸»æœåŠ¡å™¨ä¸Šï¼Œæ‚¨å¿…é¡»å¯ç”¨äºŒè¿›åˆ¶æ—¥å¿—è®°å½•å¹¶é…ç½®å”¯ä¸€çš„æœåŠ¡å™¨IDã€‚éœ€è¦é‡å¯æœåŠ¡å™¨ã€‚</li></ol><p>ç¼–è¾‘ä¸»æœåŠ¡å™¨çš„é…ç½®æ–‡ä»¶ <code>my.cnf</code>ï¼Œæ·»åŠ å¦‚ä¸‹å†…å®¹</p><pre><code>[mysqld]log-bin=/var/log/mysql/mysql-binserver-id=1</code></pre><p>åˆ›å»ºæ—¥å¿—ç›®å½•å¹¶èµ‹äºˆæƒé™</p><pre><code>[root@mysql ~]#  mkdir /var/log/mysql[root@mysql ~]# chown mysql.mysql /var/log/mysql</code></pre><p>é‡å¯æœåŠ¡</p><pre><code>[root@mysql ~]# systemctl restart mysqld</code></pre><p><strong>æ³¨æ„ï¼šï¼š</strong></p><pre><code>å¦‚æœçœç•¥server-idï¼ˆæˆ–å°†å…¶æ˜¾å¼è®¾ç½®ä¸ºé»˜è®¤å€¼0ï¼‰ï¼Œåˆ™ä¸»æœåŠ¡å™¨æ‹’ç»æ¥è‡ªä»æœåŠ¡å™¨çš„ä»»ä½•è¿æ¥ã€‚ä¸ºäº†åœ¨ä½¿ç”¨å¸¦äº‹åŠ¡çš„InnoDBè¿›è¡Œå¤åˆ¶è®¾ç½®æ—¶å°½å¯èƒ½æé«˜æŒä¹…æ€§å’Œä¸€è‡´æ€§ï¼Œæ‚¨åº”è¯¥åœ¨master my.cnfæ–‡ä»¶ä¸­ä½¿ç”¨ä»¥ä¸‹é…ç½®é¡¹ï¼šinnodb_flush_log_at_trx_commit = 1sync_binlog = 1ç¡®ä¿æœªåœ¨å¤åˆ¶ä¸»æœåŠ¡å™¨ä¸Šå¯ç”¨skip-networkingé€‰é¡¹ã€‚å¦‚æœå·²ç¦ç”¨ç½‘ç»œï¼Œåˆ™ä»ç«™æ— æ³•ä¸ä¸»ç«™é€šä¿¡ï¼Œå¹¶ä¸”å¤åˆ¶å¤±è´¥ã€‚</code></pre><p>2.åº”è¯¥åˆ›å»ºä¸€ä¸ªä¸“é—¨ç”¨äºå¤åˆ¶æ•°æ®çš„ç”¨æˆ·</p><p>æ¯ä¸ªä»æœåŠ¡å™¨éœ€è¦ä½¿ç”¨MySQL ä¸»æœåŠ¡å™¨ä¸Šçš„ç”¨æˆ·åå’Œå¯†ç è¿æ¥åˆ°ä¸»ç«™ã€‚</p><p>ä¾‹å¦‚ï¼Œè®¡åˆ’ä½¿ç”¨ç”¨æˆ· <code>repl</code> å¯ä»¥ä»ä»»ä½•ä¸»æœºä¸Šè¿æ¥åˆ° <code>master</code> ä¸Šè¿›è¡Œå¤åˆ¶æ“ä½œ, å¹¶ä¸”ç”¨æˆ· <code>repl</code> ä»…å¯ä»¥ä½¿ç”¨å¤åˆ¶çš„æƒé™ã€‚</p><p>åœ¨ <code>ä¸»æœåŠ¡å™¨</code> ä¸Šæ‰§è¡Œå¦‚ä¸‹æ“ä½œ</p><pre><code>mysql&gt; CREATE USER &#39;repl&#39;@&#39;%&#39; mysql&gt; GRANT REPLICATION SLAVE ON *.*  TO  &#39;repl&#39;@&#39;%&#39;  identified by  &#39;123&#39;;mysql&gt; </code></pre><p>3.åœ¨<code>ä»æœåŠ¡å™¨</code>ä¸Šä½¿ç”¨åˆšæ‰çš„ç”¨æˆ·è¿›è¡Œæµ‹è¯•è¿æ¥</p><pre><code>[root@mysql ~]# mysql -urepl -p&#39;123&#39; -hmysql-master1</code></pre><p>ä¸‹é¢çš„æ“ä½œæ ¹æ®å¦‚ä¸‹æƒ…å†µç»§ç»­</p><h5 id="ä¸»æœåŠ¡å™¨ä¸­æœ‰æ•°æ®"><a href="#ä¸»æœåŠ¡å™¨ä¸­æœ‰æ•°æ®" class="headerlink" title="ä¸»æœåŠ¡å™¨ä¸­æœ‰æ•°æ®"></a>ä¸»æœåŠ¡å™¨ä¸­æœ‰æ•°æ®</h5><ul><li>å¦‚æœåœ¨å¯åŠ¨å¤åˆ¶ä¹‹å‰æœ‰ç°æœ‰æ•°æ®éœ€è¦ä¸ä»å±è®¾å¤‡åŒæ­¥ï¼Œè¯·ä¿æŒå®¢æˆ·ç«¯æ­£å¸¸è¿è¡Œï¼Œä»¥ä¾¿é”å®šä¿æŒä¸å˜ã€‚è¿™å¯ä»¥é˜²æ­¢è¿›è¡Œä»»ä½•è¿›ä¸€æ­¥çš„æ›´æ”¹ï¼Œä»¥ä¾¿å¤åˆ¶åˆ°ä»ç«™çš„æ•°æ®ä¸ä¸»ç«™åŒæ­¥ã€‚</li></ul><ol><li>åœ¨ä¸»æœåŠ¡å™¨ä¸­å¯¼å‡ºå…ˆæœ‰çš„æ•°æ®</li></ol><p>å¦‚æœä¸»æ•°æ®åº“åŒ…å«ç°æœ‰æ•°æ®ï¼Œåˆ™å¿…é¡»å°†æ­¤æ•°æ®å¤åˆ¶åˆ°æ¯ä¸ªä»ç«™ã€‚æœ‰å¤šç§æ–¹æ³•å¯ä»¥å®ç°:</p><ul><li>ä½¿ç”¨<a href="https://links.jianshu.com/go?to=https%3A%2F%2Fdev.mysql.com%2Fdoc%2Frefman%2F5.7%2Fen%2Fmysqldump.html" target="_blank" rel="noopener"><strong>mysqldump</strong></a>å·¥å…·åˆ›å»ºè¦å¤åˆ¶çš„æ‰€æœ‰æ•°æ®åº“çš„è½¬å‚¨ã€‚è¿™æ˜¯æ¨èçš„æ–¹æ³•ï¼Œå°¤å…¶æ˜¯åœ¨ä½¿ç”¨æ—¶ <a href="https://links.jianshu.com/go?to=https%3A%2F%2Fdev.mysql.com%2Fdoc%2Frefman%2F5.7%2Fen%2Finnodb-storage-engine.html" target="_blank" rel="noopener"><code>InnoDB</code></a>ã€‚</li></ul><pre><code>[root@mysql ~]# mysqldump  -uç”¨æˆ·å  -på¯†ç   --all-databases  --master-data=1 &gt; dbdump.dbè¿™é‡Œçš„ç”¨æˆ·æ˜¯ä¸»æœåŠ¡å™¨çš„ç”¨æˆ·</code></pre><p>å¦‚æœä¸ä½¿ç”¨ <code>--master-data</code> å‚æ•°ï¼Œåˆ™éœ€è¦æ‰‹åŠ¨é”å®šå•ç‹¬ä¼šè¯ä¸­çš„æ‰€æœ‰è¡¨ã€‚</p><ol start="2"><li>ä»ä¸»æœåŠ¡å™¨ä¸­ä½¿ç”¨ <code>scp</code> æˆ– <code>rsync</code> ç­‰å·¥å…·ï¼ŒæŠŠå¤‡ä»½å‡ºæ¥çš„æ•°æ®ä¼ è¾“åˆ°ä»æœåŠ¡å™¨ä¸­ã€‚</li></ol><p>åœ¨ä¸»æœåŠ¡ä¸­æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤</p><pre><code>[root@mysql ~]# scp  dbdump.db root@mysql-slave1:/root/è¿™é‡Œçš„ mysql-slave1 éœ€è¦èƒ½è¢«ä¸»æœåŠ¡å™¨è§£æå‡º IP åœ°å€ï¼Œæˆ–è€…è¯´å¯ä»¥åœ¨ä¸»æœåŠ¡å™¨ä¸­ ping é€šã€‚</code></pre><ol start="3"><li>é…ç½®ä»æœåŠ¡å™¨ï¼Œå¹¶é‡å¯<br>åœ¨<code>ä»æœåŠ¡å™¨</code> ä¸Šç¼–è¾‘å…¶é…ç½®æ–‡ä»¶ <code>my.cnf</code> å¹¶æ·»åŠ å¦‚ä¸‹å†…å®¹</li></ol><pre><code>// my.cnf æ–‡ä»¶[mysqld]server-id=2</code></pre><ol start="4"><li>å¯¼å…¥æ•°æ®åˆ°ä»æœåŠ¡å™¨ï¼Œå¹¶é…ç½®è¿æ¥åˆ°ä¸»æœåŠ¡å™¨çš„ç›¸å…³ä¿¡æ¯</li></ol><p>ç™»å½•åˆ°ä»æœåŠ¡å™¨ä¸Šï¼Œæ‰§è¡Œå¦‚ä¸‹æ“ä½œ</p><pre><code>/*å¯¼å…¥æ•°æ®*/mysql&gt; source   /root/fulldb.dump</code></pre><p>åœ¨ä»æœåŠ¡å™¨é…ç½®è¿æ¥åˆ°ä¸»æœåŠ¡å™¨çš„ç›¸å…³ä¿¡æ¯</p><pre><code>mysql&gt; CHANGE MASTER TOMASTER_HOST=&#39;mysql-master1&#39;,  -- ä¸»æœåŠ¡å™¨çš„ä¸»æœºå(ä¹Ÿå¯ä»¥æ˜¯ IP) MASTER_USER=&#39;repl&#39;,           -- è¿æ¥åˆ°ä¸»æœåŠ¡å™¨çš„ç”¨æˆ·MASTER_PASSWORD=&#39;123&#39;;        -- åˆ°ä¸»æœåŠ¡å™¨çš„å¯†ç </code></pre><ol start="5"><li><p>å¯åŠ¨ä»æœåŠ¡å™¨çš„å¤åˆ¶çº¿ç¨‹</p><pre><code>mysql&gt; start slave;Query OK, 0 rows affected (0.09 sec)</code></pre></li></ol><p>æ£€æŸ¥æ˜¯å¦æˆåŠŸ</p><p>åœ¨ä»æœåŠ¡ä¸Šæ‰§è¡Œå¦‚ä¸‹æ“ä½œï¼ŒåŠ é•¿ä»æœåŠ¡å™¨ç«¯ IOçº¿ç¨‹å’Œ SQL çº¿ç¨‹æ˜¯å¦æ˜¯ <code>OK</code></p><pre><code>mysql&gt; show slave status\G</code></pre><p>è¾“å‡ºç»“æœä¸­åº”è¯¥çœ‹åˆ° I/O çº¿ç¨‹å’Œ SQL çº¿ç¨‹éƒ½æ˜¯ <code>YES</code>, å°±è¡¨ç¤ºæˆåŠŸã€‚</p><p>æ‰§è¡Œæ­¤è¿‡ç¨‹åï¼Œåœ¨ä¸»æœåŠ¡ä¸Šæ“ä½œçš„ä¿®æ”¹æ•°æ®çš„æ“ä½œéƒ½ä¼šåœ¨ä»æœåŠ¡å™¨ä¸­æ‰§è¡Œä¸€éï¼Œè¿™æ ·å°±ä¿è¯äº†æ•°æ®çš„ä¸€è‡´æ€§ã€‚</p><h5 id="ä¸»æœåŠ¡å™¨ä¸­æ— æ•°æ®"><a href="#ä¸»æœåŠ¡å™¨ä¸­æ— æ•°æ®" class="headerlink" title="ä¸»æœåŠ¡å™¨ä¸­æ— æ•°æ®"></a>ä¸»æœåŠ¡å™¨ä¸­æ— æ•°æ®</h5><p><strong>ä¸»æœåŠ¡å™¨ä¸­è®¾ç½®</strong></p><ol><li><code>my.cnf</code>é…ç½®æ–‡ä»¶</li></ol><pre><code>[mysqld]log-bin=/var/log/mysql/mysql-binserver-id=1</code></pre><p>åˆ›å»ºæ—¥å¿—ç›®å½•å¹¶èµ‹äºˆæƒé™</p><pre><code>[root@mysql ~]#  mkdir /var/log/mysql[root@mysql ~]#  chown mysql.mysql /var/log/mysql</code></pre><p>é‡å¯æœåŠ¡</p><p><strong>ä»æœåŠ¡å™¨è®¾ç½®</strong></p><ol><li><code>my.cnf</code>é…ç½®æ–‡ä»¶</li></ol><pre><code>[mysqld]server-id=3</code></pre><p>é‡å¯æœåŠ¡</p><ol start="2"><li>æŸ¥çœ‹ä¸»æœåŠ¡å™¨çš„äºŒè¿›åˆ¶æ—¥å¿—çš„åç§°</li></ol><p>é€šè¿‡ä½¿ç”¨å‘½ä»¤è¡Œå®¢æˆ·ç«¯è¿æ¥åˆ°ä¸»æœåŠ¡å™¨æ¥å¯åŠ¨ä¸»æœåŠ¡å™¨ä¸Šçš„ä¼šè¯ï¼Œå¹¶é€šè¿‡æ‰§è¡Œä»¥ä¸‹ <code>FLUSH TABLES WITH READ LOCK</code>  è¯­å¥æ¥åˆ·æ–°æ‰€æœ‰è¡¨å’Œé˜»æ­¢å†™è¯­å¥ï¼š</p><pre><code>mysql&gt; FLUSH TABLES WITH READ LOCK;mysql&gt; show master status \G****************** 1. row ****************             File: mysql-bin.000001         Position: 0     Binlog_Do_DB: Binlog_Ignore_DB:Executed_Gtid_Set:1 row in set (0.00 sec)</code></pre><ol start="3"><li>åœ¨ä»æœåŠ¡å™¨çš„ mysql ä¸­æ‰§è¡Œå¦‚ä¸‹è¯­å¥</li></ol><pre><code>mysql&gt; CHANGE MASTER TOMASTER_HOST=&#39;mysql-master1&#39;,MASTER_USER=&#39;repl&#39;,MASTER_PASSWORD=&#39;123&#39;,MASTER_LOG_FILE=&#39;mysql-bin.000001&#39;,MASTER_LOG_POS=0;mysql&gt; start slave;</code></pre><p><strong>æŸ¥çœ‹</strong></p><p>åœ¨masterä¸Šæ‰§è¡Œshow binlog eventså‘½ä»¤ï¼Œå¯ä»¥çœ‹åˆ°ç¬¬ä¸€ä¸ªbinlogæ–‡ä»¶çš„å†…å®¹ã€‚</p><pre><code>mysql&gt; show binlog events\G*************************** 1. row ***************************   Log_name: mysql-bin.000001        Pos: 4 Event_type: Format_desc  Server_id: 1End_log_pos: 107       Info: Server ver: 5.5.28-0ubuntu0.12.10.2-log, Binlog ver: 4*************************** 2. row ***************************   Log_name: mysql-bin.000001        Pos: 107 Event_type: Query  Server_id: 1End_log_pos: 181       Info: create user rep*************************** 3. row ***************************   Log_name: mysql-bin.000001        Pos: 181 Event_type: Query  Server_id: 1End_log_pos: 316       Info: grant replication slave on *.* to rep identified by &#39;123456&#39;3 rows in set (0.00 sec)Log_name æ˜¯äºŒè¿›åˆ¶æ—¥å¿—æ–‡ä»¶çš„åç§°ï¼Œä¸€ä¸ªäº‹ä»¶ä¸èƒ½æ¨ªè·¨ä¸¤ä¸ªæ–‡ä»¶Pos è¿™æ˜¯è¯¥äº‹ä»¶åœ¨æ–‡ä»¶ä¸­çš„å¼€å§‹ä½ç½®Event_type äº‹ä»¶çš„ç±»å‹ï¼Œäº‹ä»¶ç±»å‹æ˜¯ç»™slaveä¼ é€’ä¿¡æ¯çš„åŸºæœ¬æ–¹æ³•ï¼Œæ¯ä¸ªæ–°çš„binlogéƒ½ä»¥Format_descç±»å‹å¼€å§‹ï¼Œä»¥Rotateç±»å‹ç»“æŸServer_id åˆ›å»ºè¯¥äº‹ä»¶çš„æœåŠ¡å™¨idEnd_log_pos è¯¥äº‹ä»¶çš„ç»“æŸä½ç½®ï¼Œä¹Ÿæ˜¯ä¸‹ä¸€ä¸ªäº‹ä»¶çš„å¼€å§‹ä½ç½®ï¼Œå› æ­¤äº‹ä»¶èŒƒå›´ä¸ºPos~End_log_pos  -  1Info äº‹ä»¶ä¿¡æ¯çš„å¯è¯»æ–‡æœ¬ï¼Œä¸åŒçš„äº‹ä»¶æœ‰ä¸åŒçš„ä¿¡æ¯</code></pre><h4 id="åœ¨ä»ç«™ä¸Šæš‚åœå¤åˆ¶"><a href="#åœ¨ä»ç«™ä¸Šæš‚åœå¤åˆ¶" class="headerlink" title="åœ¨ä»ç«™ä¸Šæš‚åœå¤åˆ¶"></a>åœ¨ä»ç«™ä¸Šæš‚åœå¤åˆ¶</h4><p>æ‚¨å¯ä»¥ä½¿ç”¨<a href="https://links.jianshu.com/go?to=https%3A%2F%2Fdev.mysql.com%2Fdoc%2Frefman%2F5.7%2Fen%2Fstop-slave.html" target="_blank" rel="noopener"><code>STOP SLAVE</code></a>å’Œ <a href="https://links.jianshu.com/go?to=https%3A%2F%2Fdev.mysql.com%2Fdoc%2Frefman%2F5.7%2Fen%2Fstart-slave.html" target="_blank" rel="noopener"><code>START SLAVE</code></a>è¯­å¥åœæ­¢å¹¶å¯åŠ¨ä»ç«™ä¸Šçš„å¤åˆ¶ ã€‚</p><p>è¦åœæ­¢ä»ä¸»æœåŠ¡å™¨å¤„ç†äºŒè¿›åˆ¶æ—¥å¿—ï¼Œè¯·ä½¿ç”¨ <a href="https://links.jianshu.com/go?to=https%3A%2F%2Fdev.mysql.com%2Fdoc%2Frefman%2F5.7%2Fen%2Fstop-slave.html" target="_blank" rel="noopener"><code>STOP SLAVE</code></a>ï¼š</p><pre><code>mysql&gt; STOP SLAVE;</code></pre><p>å½“å¤åˆ¶åœæ­¢æ—¶ï¼Œä»I / Oçº¿ç¨‹åœæ­¢ä»ä¸»äºŒè¿›åˆ¶æ—¥å¿—è¯»å–äº‹ä»¶å¹¶å°†å®ƒä»¬å†™å…¥ä¸­ç»§æ—¥å¿—ï¼Œå¹¶ä¸”SQLçº¿ç¨‹åœæ­¢ä»ä¸­ç»§æ—¥å¿—è¯»å–äº‹ä»¶å¹¶æ‰§è¡Œå®ƒä»¬ã€‚æ‚¨å¯ä»¥é€šè¿‡æŒ‡å®šçº¿ç¨‹ç±»å‹å•ç‹¬æš‚åœI / Oæˆ–SQLçº¿ç¨‹ï¼š</p><pre><code>mysql&gt; STOP SLAVE IO_THREAD;mysql&gt; STOP SLAVE SQL_THREAD;</code></pre><p>è¦å†æ¬¡å¼€å§‹æ‰§è¡Œï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹<a href="https://links.jianshu.com/go?to=https%3A%2F%2Fdev.mysql.com%2Fdoc%2Frefman%2F5.7%2Fen%2Fstart-slave.html" target="_blank" rel="noopener"><code>START SLAVE</code></a>è¯­å¥ï¼š</p><pre><code>mysql&gt; START SLAVE;</code></pre><p>è¦å¯åŠ¨ç‰¹å®šçº¿ç¨‹ï¼Œè¯·æŒ‡å®šçº¿ç¨‹ç±»å‹ï¼š</p><pre><code>mysql&gt; START SLAVE IO_THREAD;mysql&gt; START SLAVE SQL_THREAD;</code></pre><pre><code>å¤åˆ¶åŸç†å®ç°ç»†èŠ‚ï¼ˆäº†è§£ï¼‰MySQLå¤åˆ¶åŠŸèƒ½ä½¿ç”¨ä¸‰ä¸ªçº¿ç¨‹å®ç°ï¼Œä¸€ä¸ªåœ¨ä¸»æœåŠ¡å™¨ä¸Šï¼Œä¸¤ä¸ªåœ¨ä»æœåŠ¡å™¨ä¸Šï¼šBinlogè½¬å‚¨çº¿ç¨‹ ä¸»è®¾å¤‡åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œä»¥ä¾¿åœ¨ä»è®¾å¤‡è¿æ¥æ—¶å°†äºŒè¿›åˆ¶æ—¥å¿—å†…å®¹å‘é€åˆ°ä»è®¾å¤‡ã€‚å¯ä»¥SHOW PROCESSLISTåœ¨ä¸»æœåŠ¡å™¨çš„è¾“å‡ºä¸­å°†æ­¤çº¿ç¨‹æ ‡è¯†ä¸ºBinlog Dumpçº¿ç¨‹ã€‚äºŒè¿›åˆ¶æ—¥å¿—è½¬å‚¨çº¿ç¨‹è·å–ä¸»æœºäºŒè¿›åˆ¶æ—¥å¿—ä¸Šçš„é”ï¼Œç”¨äºè¯»å–è¦å‘é€åˆ°ä»æœºçš„æ¯ä¸ªäº‹ä»¶ã€‚ä¸€æ—¦è¯»å–äº†äº‹ä»¶ï¼Œå³ä½¿åœ¨äº‹ä»¶å‘é€åˆ°ä»ç«™ä¹‹å‰ï¼Œé”ä¹Ÿä¼šè¢«é‡Šæ”¾ã€‚ä»å± I/Oçº¿ç¨‹ åœ¨ä»å±æœåŠ¡å™¨ä¸Šå‘å‡º START SLAVE è¯­å¥æ—¶ï¼Œä»å±æœåŠ¡å™¨ä¼šåˆ›å»ºä¸€ä¸ª I/O çº¿ç¨‹ï¼Œè¯¥çº¿ç¨‹è¿æ¥åˆ°ä¸»æœåŠ¡å™¨å¹¶è¦æ±‚ä¸»æœåŠ¡å™¨å‘é€å…¶åœ¨äºŒè¿›åˆ¶æ—¥å¿—ä¸­çš„æ›´æ–°è®°å½•ã€‚ä»å± I/Oçº¿ç¨‹è¯»å–ä¸»Binlog Dumpçº¿ç¨‹å‘é€çš„æ›´æ–° ï¼ˆè¯·å‚é˜…ä¸Šä¸€é¡¹ï¼‰å¹¶å°†å®ƒä»¬å¤åˆ¶åˆ°åŒ…å«ä»å±ä¸­ç»§æ—¥å¿—çš„æœ¬åœ°æ–‡ä»¶ã€‚æ­¤çº¿ç¨‹çš„çŠ¶æ€æ˜¾ç¤ºä¸º Slave_IO_runningè¾“å‡º SHOW SLAVE STATUSæˆ– Slave_runningè¾“å‡ºä¸­çš„çŠ¶æ€SHOW STATUSã€‚ä»å±SQLçº¿ç¨‹ ä»å±è®¾å¤‡åˆ›å»ºä¸€ä¸ªSQLçº¿ç¨‹æ¥è¯»å–ç”±ä»å± I/O çº¿ç¨‹å†™å…¥çš„ä¸­ç»§æ—¥å¿—ï¼Œå¹¶æ‰§è¡Œå…¶ä¸­åŒ…å«çš„äº‹ä»¶ã€‚å½“ä»å±æœåŠ¡å™¨ä»æ”¾çš„äº‹ä»¶ï¼Œè¿½å¹²ä¸Šä¸»æœåŠ¡å™¨çš„äº‹ä»¶åï¼Œä»å±æœåŠ¡å™¨çš„ I/O çº¿ç¨‹å°†ä¼šå¤„äºä¼‘çœ çŠ¶æ€ï¼Œç›´åˆ°ä¸»æœåŠ¡å™¨çš„äº‹ä»¶æœ‰æ›´æ–°æ—¶ï¼Œè¢«ä¸»æœåŠ¡å™¨å‘é€çš„ä¿¡å·å”¤é†’ã€‚åœ¨å‰é¢çš„æè¿°ä¸­ï¼Œæ¯ä¸ªä¸»/ä»è¿æ¥æœ‰ä¸‰ä¸ªçº¿ç¨‹ã€‚å…·æœ‰å¤šä¸ªä»ç«™çš„ä¸»ç«™ä¸ºæ¯ä¸ªå½“å‰è¿æ¥çš„ä»ç«™åˆ›å»ºä¸€ä¸ªäºŒè¿›åˆ¶æ—¥å¿—è½¬å‚¨çº¿ç¨‹ï¼Œæ¯ä¸ªä»ç«™éƒ½æœ‰è‡ªå·±çš„I / Oå’ŒSQLçº¿ç¨‹ã€‚ä»ç«™ä½¿ç”¨ä¸¤ä¸ªçº¿ç¨‹å°†è¯»å–æ›´æ–°ä¸ä¸»ç«™åˆ†å¼€å¹¶å°†å®ƒä»¬æ‰§è¡Œåˆ°ç‹¬ç«‹ä»»åŠ¡ä¸­ã€‚å› æ­¤ï¼Œå¦‚æœè¯­å¥æ‰§è¡Œç¼“æ…¢ï¼Œåˆ™ä¸ä¼šå‡æ…¢è¯»å–è¯­å¥çš„ä»»åŠ¡ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä»æœåŠ¡å™¨å°šæœªè¿è¡Œä¸€æ®µæ—¶é—´ï¼Œåˆ™å½“ä»æœåŠ¡å™¨å¯åŠ¨æ—¶ï¼Œå…¶I / Oçº¿ç¨‹å¯ä»¥å¿«é€Ÿä»ä¸»æœåŠ¡å™¨è·å–æ‰€æœ‰äºŒè¿›åˆ¶æ—¥å¿—å†…å®¹ï¼Œå³ä½¿SQLçº¿ç¨‹è¿œè¿œè½åã€‚å¦‚æœä»æœåŠ¡å™¨åœ¨SQLçº¿ç¨‹æ‰§è¡Œäº†æ‰€æœ‰è·å–çš„è¯­å¥ä¹‹å‰åœæ­¢ï¼Œåˆ™I / Oçº¿ç¨‹è‡³å°‘å·²è·å–æ‰€æœ‰å†…å®¹ï¼Œä»¥ä¾¿è¯­å¥çš„å®‰å…¨å‰¯æœ¬æœ¬åœ°å­˜å‚¨åœ¨ä»å±çš„ä¸­ç»§æ—¥å¿—ä¸­ï¼Œå‡†å¤‡åœ¨ä¸‹æ¬¡æ‰§è¡Œæ—¶æ‰§è¡Œå¥´éš¶å¼€å§‹ã€‚</code></pre><h3 id="é…ç½®Replication-gtidæ–¹å¼"><a href="#é…ç½®Replication-gtidæ–¹å¼" class="headerlink" title="é…ç½®Replication(gtidæ–¹å¼)"></a>é…ç½®Replication(gtidæ–¹å¼)</h3><p>åŸºäºäº‹åŠ¡çš„Replicationï¼Œå°±æ˜¯åˆ©ç”¨GTIDæ¥å®ç°çš„å¤åˆ¶</p><p>GTIDï¼ˆå…¨å±€äº‹åŠ¡æ ‡ç¤ºç¬¦ï¼‰æœ€åˆç”±googleå®ç°ï¼Œåœ¨MySQL 5.6ä¸­å¼•å…¥.GTIDåœ¨äº‹åŠ¡æäº¤æ—¶ç”Ÿæˆï¼Œç”±UUIDå’Œäº‹åŠ¡IDç»„æˆ.uuidä¼šåœ¨ç¬¬ä¸€æ¬¡å¯åŠ¨MySQLæ—¶ç”Ÿæˆï¼Œä¿å­˜åœ¨æ•°æ®ç›®å½•ä¸‹çš„auto .cnfæ–‡ä»¶é‡Œï¼Œäº‹åŠ¡IDåˆ™ä»1å¼€å§‹è‡ªå¢ä½¿ç”¨GTIDçš„å¥½å¤„ä¸»è¦æœ‰ä¸¤ç‚¹ï¼š</p><ol><li>ä¸å†éœ€è¦æŒ‡å®šä¼ ç»Ÿå¤åˆ¶ä¸­çš„master_log_fileså’Œmaster_log_posï¼Œä½¿ä¸»ä»å¤åˆ¶æ›´ç®€å•å¯é </li><li>å¯ä»¥å®ç°åŸºäºåº“çš„å¤šçº¿ç¨‹å¤åˆ¶ï¼Œå‡å°ä¸»ä»å¤åˆ¶çš„å»¶è¿Ÿ</li></ol><p><strong>å®éªŒç¯å¢ƒè¦æ±‚ï¼š 5.7.6 ä»¥ä¸Šç‰ˆæœ¬</strong></p><h5 id="ä¸»åº“é…ç½®"><a href="#ä¸»åº“é…ç½®" class="headerlink" title="ä¸»åº“é…ç½®"></a>ä¸»åº“é…ç½®</h5><pre><code>[mysqld]log-bin=/var/log/mysql/mysql-binserver-id=1gtid_mode=ONenforce_gtid_consistency=1   # å¼ºåˆ¶æ‰§è¡ŒGTIDä¸€è‡´æ€§ã€‚</code></pre><p>é‡å¯æœåŠ¡</p><p>å…¶ä»–å’Œä¹‹å‰çš„ä¸€æ ·</p><ul><li>åˆ›å»ºä¸“å±ç”¨æˆ·å¹¶æˆæƒ</li><li>å‡å¦‚æœ‰æ•°æ®å¯¼å‡ºæ•°æ®</li></ul><pre><code>mysql&gt; CREATE USER &#39;repl&#39;@&#39;%&#39; IDENTIFIED BY &#39;123&#39;;mysql&gt; GRANT REPLICATION SLAVE ON *.* TO &#39;repl&#39;@&#39;%&#39;;mysql&gt; </code></pre><h5 id="ä»åº“é…ç½®"><a href="#ä»åº“é…ç½®" class="headerlink" title="ä»åº“é…ç½®"></a>ä»åº“é…ç½®</h5><p>æµ‹è¯•ç”¨æˆ·æœ‰æ•ˆæ€§</p><pre><code>mysql -urepl -p&#39;123&#39; -hmysql-master1</code></pre><pre><code>[mysqld]server-id=2gtid_mode=ONenforce_gtid_consistency=1# å¯é€‰é¡¹, æŠŠè¿æ¥åˆ° master çš„ä¿¡æ¯å­˜åˆ°æ•°æ®åº“ä¸­çš„è¡¨ä¸­master-info-repository=TABLErelay-log-info-repository=TABLE</code></pre><p>é‡å¯æœåŠ¡</p><p>å‡å¦‚æœ‰æ•°æ®ï¼Œå…ˆå¯¼å…¥æ•°æ®</p><pre><code>mysql&gt; source dump.db</code></pre><p>Mysql ç»ˆç«¯æ‰§è¡Œè¿æ¥ä¿¡æ¯</p><pre><code>mysql&gt; CHANGE MASTER TOMASTER_HOST=&#39;172.16.153.10&#39;,MASTER_USER=&#39;repl&#39;,MASTER_PASSWORD=&#39;123&#39;,MASTER_AUTO_POSITION=1;&gt; start slave;</code></pre><h3 id="Replicationæ•…éšœæ’é™¤"><a href="#Replicationæ•…éšœæ’é™¤" class="headerlink" title="Replicationæ•…éšœæ’é™¤"></a>Replicationæ•…éšœæ’é™¤</h3><h4 id="å¼€å¯-GTID-åçš„å¯¼å‡ºå¯¼å…¥æ•°æ®çš„æ³¨æ„ç‚¹"><a href="#å¼€å¯-GTID-åçš„å¯¼å‡ºå¯¼å…¥æ•°æ®çš„æ³¨æ„ç‚¹" class="headerlink" title="å¼€å¯ GTID åçš„å¯¼å‡ºå¯¼å…¥æ•°æ®çš„æ³¨æ„ç‚¹"></a>å¼€å¯ GTID åçš„å¯¼å‡ºå¯¼å…¥æ•°æ®çš„æ³¨æ„ç‚¹</h4><blockquote><p>Warning: A partial dump from a server that has GTIDs will by default include the GTIDs of all transactions, even those that changed suppressed parts of the database. If you donâ€™t want to restore GTIDs, pass â€“set-gtid-purged=OFF. To make a complete dump, pass â€“all-databases â€“triggers â€“routines â€“events</p></blockquote><p>æ„æ€æ˜¯ï¼š å½“å‰æ•°æ®åº“å®ä¾‹ä¸­å¼€å¯äº† GTID åŠŸèƒ½, åœ¨å¼€å¯æœ‰ GTID åŠŸèƒ½çš„æ•°æ®åº“å®ä¾‹ä¸­, å¯¼å‡ºå…¶ä¸­ä»»ä½•ä¸€ä¸ªåº“, å¦‚æœæ²¡æœ‰æ˜¾ç¤ºåœ°æŒ‡å®šâ€“set-gtid-purgedå‚æ•°, éƒ½ä¼šæç¤ºè¿™ä¸€è¡Œä¿¡æ¯. æ„æ€æ˜¯é»˜è®¤æƒ…å†µä¸‹, å¯¼å‡ºçš„åº“ä¸­å«æœ‰ GTID ä¿¡æ¯, å¦‚æœä¸æƒ³å¯¼å‡ºåŒ…å«æœ‰ GTID ä¿¡æ¯çš„æ•°æ®åº“, éœ€è¦æ˜¾ç¤ºåœ°æ·»åŠ â€“set-gtid-purged=OFFå‚æ•°.</p><pre><code>mysqldump -uroot  -p  --set-gtid-purged=OFF   --all-databases &gt; alldb.db</code></pre><p>å¯¼å…¥æ•°æ®æ˜¯å°±å¯ä»¥ç›¸å¾€å¸¸ä¸€æ ·å¯¼å…¥äº†ã€‚</p><h4 id="UUIDä¸€è‡´ï¼Œå¯¼è‡´ä¸»ä»å¤åˆ¶I-Oçº¿ç¨‹ä¸æ˜¯yes"><a href="#UUIDä¸€è‡´ï¼Œå¯¼è‡´ä¸»ä»å¤åˆ¶I-Oçº¿ç¨‹ä¸æ˜¯yes" class="headerlink" title="UUIDä¸€è‡´ï¼Œå¯¼è‡´ä¸»ä»å¤åˆ¶I/Oçº¿ç¨‹ä¸æ˜¯yes"></a>UUIDä¸€è‡´ï¼Œå¯¼è‡´ä¸»ä»å¤åˆ¶I/Oçº¿ç¨‹ä¸æ˜¯yes</h4><blockquote><p>Fatal error: The slave I/O thread stops because master and slave have equal MySQL server UUIDs; these UUIDs must be different for replication to work</p></blockquote><p>è‡´å‘½é”™è¯¯ï¼šç”±äºmasterå’Œslaveå…·æœ‰ç›¸åŒçš„mysqlæœåŠ¡å™¨uuidï¼Œä»I/Oçº¿ç¨‹å°†åœæ­¢ï¼›è¿™äº›uuidå¿…é¡»ä¸åŒæ‰èƒ½ä½¿å¤åˆ¶å·¥ä½œã€‚</p><p>é—®é¢˜æç¤ºä¸»ä»ä½¿ç”¨äº†ç›¸åŒçš„server UUIDï¼Œä¸€ä¸ªä¸ªçš„æ£€æŸ¥ï¼š</p><p>æ£€æŸ¥ä¸»ä»server_id</p><p>ä¸»åº“ï¼š</p><p>mysql&gt;  show variables like â€˜server_idâ€™;<br>+â€”â€”â€”â€”â€”+â€”â€”-+<br>| Variable_name | Value |<br>+â€”â€”â€”â€”â€”+â€”â€”-+<br>| server_id     | 1     |<br>+â€”â€”â€”â€”â€”+â€”â€”-+<br>1 row in set (0.01 sec)</p><p>ä»åº“ï¼š</p><p>mysql&gt;  show variables like â€˜server_idâ€™;<br>+â€”â€”â€”â€”â€”+â€”â€”-+<br>| Variable_name | Value |<br>+â€”â€”â€”â€”â€”+â€”â€”-+<br>| server_id     | 2     |<br>+â€”â€”â€”â€”â€”+â€”â€”-+<br>1 row in set (0.01 sec)</p><p>server_idä¸ä¸€æ ·ï¼Œæ’é™¤ã€‚</p><p>æ£€æŸ¥ä¸»ä»çŠ¶æ€ï¼š</p><p>ä¸»åº“ï¼š</p><p>mysql&gt; show master status;<br>+â€”â€”â€”â€”â€”â€”+â€”â€”â€”-+â€”â€”â€”â€”â€“+â€”â€”â€”â€”â€”â€”+â€”â€”â€”â€”â€”â€”-+<br>| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |<br>+â€”â€”â€”â€”â€”â€”+â€”â€”â€”-+â€”â€”â€”â€”â€“+â€”â€”â€”â€”â€”â€”+â€”â€”â€”â€”â€”â€”-+<br>| mysql-bin.000001 |      154 |              |                  |                   |<br>+â€”â€”â€”â€”â€”â€”+â€”â€”â€”-+â€”â€”â€”â€”â€“+â€”â€”â€”â€”â€”â€”+â€”â€”â€”â€”â€”â€”-+<br>1 row in set (0.00 sec)<br>ä»åº“ï¼š</p><p>mysql&gt; show master status;<br>+â€”â€”â€”â€”â€”â€”+â€”â€”â€”-+â€”â€”â€”â€”â€“+â€”â€”â€”â€”â€”â€”+â€”â€”â€”â€”â€”â€”-+<br>| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |<br>+â€”â€”â€”â€”â€”â€”+â€”â€”â€”-+â€”â€”â€”â€”â€“+â€”â€”â€”â€”â€”â€”+â€”â€”â€”â€”â€”â€”-+<br>| mysql-bin.000001 |      306 |              |                  |                   |<br>+â€”â€”â€”â€”â€”â€”+â€”â€”â€”-+â€”â€”â€”â€”â€“+â€”â€”â€”â€”â€”â€”+â€”â€”â€”â€”â€”â€”-+<br>1 row in set (0.00 sec)</p><p>Fileä¸€æ ·ï¼Œæ’é™¤ã€‚</p><p>æœ€åæ£€æŸ¥å‘ç°ä»–ä»¬çš„auto.cnfä¸­çš„server-uuidæ˜¯ä¸€æ ·çš„ã€‚ã€‚ã€‚</p><p>[root@localhost ~]# vim /var/lib/mysql/auto.cnf</p><p>[auto]</p><p>server-uuid=4f37a731-9b79-11e8-8013-000c29f0700f</p><p>ä¿®æ”¹uuidå¹¶é‡å¯æœåŠ¡</p><h3 id="æ•°æ®åº“ä¸­é—´MyCATè¯»å†™åˆ†ç¦»å®ç°-é‡è¦ï¼ï¼ï¼"><a href="#æ•°æ®åº“ä¸­é—´MyCATè¯»å†™åˆ†ç¦»å®ç°-é‡è¦ï¼ï¼ï¼" class="headerlink" title="æ•°æ®åº“ä¸­é—´MyCATè¯»å†™åˆ†ç¦»å®ç° (é‡è¦ï¼ï¼ï¼)"></a>æ•°æ®åº“ä¸­é—´MyCATè¯»å†™åˆ†ç¦»å®ç° (é‡è¦ï¼ï¼ï¼)</h3><p>Mycat æ˜¯ä¸€ä¸ªå¼€æºçš„åˆ†å¸ƒå¼æ•°æ®åº“ç³»ç»Ÿï¼Œä½†æ˜¯ç”±äºçœŸæ­£çš„æ•°æ®åº“éœ€è¦å­˜å‚¨å¼•æ“ï¼Œè€Œ Mycat å¹¶æ²¡æœ‰å­˜ å‚¨å¼•æ“ï¼Œæ‰€ä»¥å¹¶ä¸æ˜¯å®Œå…¨æ„ä¹‰çš„åˆ†å¸ƒå¼æ•°æ®åº“ç³»ç»Ÿã€‚ é‚£ä¹ˆ Mycat æ˜¯ä»€ä¹ˆï¼ŸMycat æ˜¯æ•°æ®åº“ä¸­é—´ä»¶ï¼Œå°±æ˜¯ä»‹äºæ•°æ®åº“ä¸åº”ç”¨ä¹‹é—´ï¼Œè¿›è¡Œæ•°æ®å¤„ç†ä¸äº¤äº’çš„ä¸­é—´æœ åŠ¡ã€‚</p><p><img src="https://i.loli.net/2019/08/12/ZXJxhqTER2UFak5.jpg" alt=""></p><p>MyCAT æ˜¯ä½¿ç”¨ JAVA è¯­è¨€è¿›è¡Œç¼–å†™å¼€å‘ï¼Œä½¿ç”¨å‰éœ€è¦å…ˆå®‰è£… JAVA è¿è¡Œç¯å¢ƒ(JRE),ç”±äº MyCAT ä¸­ä½¿ç”¨äº† JDK7 ä¸­çš„ä¸€äº›ç‰¹æ€§ï¼Œæ‰€ä»¥è¦æ±‚å¿…é¡»åœ¨ JDK7 ä»¥ä¸Šçš„ç‰ˆæœ¬ä¸Šè¿è¡Œã€‚</p><h4 id="éƒ¨ç½²ç¯å¢ƒ"><a href="#éƒ¨ç½²ç¯å¢ƒ" class="headerlink" title="éƒ¨ç½²ç¯å¢ƒ"></a>éƒ¨ç½²ç¯å¢ƒ</h4><p>1ä¸‹è½½JDK</p><pre><code>[root@mycat ~]# wget --no-cookies \--no-check-certificate \--header \&quot;Cookie: oraclelicense=accept-securebackup-cookie&quot; \http://download.oracle.com/otn-pub/java/jdk/8u181-\b13/96a7b8442fe848ef90c96a2fad6ed6d1/jdk-8u181-linux-\x64.tar.gz// --no-check-certificate è¡¨ç¤ºä¸æ ¡éªŒSSLè¯ä¹¦ï¼Œå› ä¸ºä¸­é—´çš„ä¸¤ä¸ª302ä¼šè®¿é—®httpsï¼Œä¼šæ¶‰åŠåˆ°è¯ä¹¦çš„é—®é¢˜ï¼Œä¸æ ¡éªŒèƒ½å¿«ä¸€ç‚¹ï¼Œå½±å“ä¸å¤§.</code></pre><p>2.è§£å‹æ–‡ä»¶</p><pre><code>[root@mycat ~]# tar -xf jdk-8u181-linux-x64.tar.gz   -C  /usr/local/[root@mycat ~]# ln -s /usr/local/jdk1.8.0_181/ /usr/local/java</code></pre><p>3.é…ç½®ç¯å¢ƒå˜é‡</p><pre><code>[root@mycat ~]# vim /etc/profile.d/java.shexport JAVA_HOME=/usr/local/javaexport PATH=$JAVA_HOME/bin:$PATHexport CLASSPATH=.:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jarä½¿ç¯å¢ƒå˜é‡ç”Ÿæ•ˆ[root@mycat ~]# source /etc/profile.d/java.sh</code></pre><h4 id="éƒ¨ç½²Mycat"><a href="#éƒ¨ç½²Mycat" class="headerlink" title="éƒ¨ç½²Mycat"></a>éƒ¨ç½²Mycat</h4><p><img src="https://i.loli.net/2019/08/12/zlZOf4dv95xPkS1.jpg" alt=""></p><pre><code>ä¸‹è½½[root@mycat ~]# wget http://dl.mycat.io/1.6.5/Mycat-server-1.6.5-release-20180122220033-linux.tar.gzè§£å‹[root@mycat ~]# tar xf Mycat-server-1.6.5-release-20180122220033-linux.tar.gz -C /usr/local/</code></pre><h5 id="é…ç½®Mycat"><a href="#é…ç½®Mycat" class="headerlink" title="é…ç½®Mycat"></a>é…ç½®Mycat</h5><p>è®¤è¯†é…ç½®æ–‡ä»¶</p><p>MyCAT ç›®å‰ä¸»è¦é€šè¿‡é…ç½®æ–‡ä»¶çš„æ–¹å¼æ¥å®šä¹‰é€»è¾‘åº“å’Œç›¸å…³é…ç½®:</p><p>/usr/local/mycat/conf/server.xml             å®šä¹‰ç”¨æˆ·ä»¥åŠç³»ç»Ÿç›¸å…³å˜é‡ï¼Œå¦‚ç«¯å£ç­‰ã€‚å…¶ä¸­ç”¨æˆ·ä¿¡æ¯æ˜¯å‰ç«¯åº”ç”¨ç¨‹åºè¿æ¥ mycat çš„ç”¨æˆ·ä¿¡æ¯ã€‚</p><p>/usr/local/mycat/conf/schema.xml       å®šä¹‰é€»è¾‘åº“ï¼Œè¡¨ã€åˆ†ç‰‡èŠ‚ç‚¹ç­‰å†…å®¹ã€‚</p><h5 id="é…ç½®-server-xml"><a href="#é…ç½®-server-xml" class="headerlink" title="é…ç½® server.xml"></a>é…ç½® server.xml</h5><p>ä»¥ä¸‹ä¸ºä»£ç ç‰‡æ®µ</p><p>ä¸‹é¢çš„ç”¨æˆ·å’Œå¯†ç æ˜¯åº”ç”¨ç¨‹åºè¿æ¥åˆ° MyCat ä½¿ç”¨çš„ï¼Œå¯ä»¥è‡ªå®šä¹‰é…ç½®</p><p>è€Œå…¶ä¸­çš„schemas é…ç½®é¡¹æ‰€å¯¹åº”çš„å€¼æ˜¯é€»è¾‘æ•°æ®åº“çš„åå­—ï¼Œä¹Ÿå¯ä»¥è‡ªå®šä¹‰ï¼Œä½†æ˜¯è¿™ä¸ªåå­—éœ€è¦å’Œåé¢ schema.xml æ–‡ä»¶ä¸­é…ç½®çš„ä¸€è‡´ã€‚</p><pre><code>vim server.xml&lt;!--ä¸‹é¢çš„ç”¨æˆ·å’Œå¯†ç æ˜¯åº”ç”¨ç¨‹åºè¿æ¥åˆ° MyCat ä½¿ç”¨çš„.schemas é…ç½®é¡¹æ‰€å¯¹åº”çš„å€¼æ˜¯é€»è¾‘æ•°æ®åº“çš„åå­—,è¿™ä¸ªåå­—éœ€è¦å’Œåé¢ schema.xml æ–‡ä»¶ä¸­é…ç½®çš„ä¸€è‡´ã€‚--&gt;       &lt;user name=&quot;mycatdb&quot; defaultAccount=&quot;true&quot;&gt;                &lt;property name=&quot;password&quot;&gt;1&lt;/property&gt;                &lt;property name=&quot;schemas&quot;&gt;mycat_db&lt;/property&gt;                &lt;!-- è¡¨çº§ DML æƒé™è®¾ç½® --&gt;                &lt;!--                            &lt;privileges check=&quot;false&quot;&gt;                        &lt;schema name=&quot;TESTDB&quot; dml=&quot;0110&quot; &gt;                                &lt;table name=&quot;tb01&quot; dml=&quot;0000&quot;&gt;&lt;/table&gt;                                &lt;table name=&quot;tb02&quot; dml=&quot;1111&quot;&gt;&lt;/table&gt;                        &lt;/schema&gt;                &lt;/privileges&gt;                            --&gt;        &lt;/user&gt;&lt;!--ä¸‹é¢æ˜¯å¦ä¸€ä¸ªç”¨æˆ·ï¼Œå¹¶ä¸”è®¾ç½®çš„è®¿é—® TESTED é€»è¾‘æ•°æ®åº“çš„æƒé™æ˜¯ åªè¯»        &lt;user name=&quot;mycatuser&quot;&gt;                &lt;property name=&quot;password&quot;&gt;123&lt;/property&gt;                &lt;property name=&quot;schemas&quot;&gt;mycat_db&lt;/property&gt;                &lt;property name=&quot;readOnly&quot;&gt;true&lt;/property&gt;        &lt;/user&gt;--&gt;&lt;/mycat:server&gt;</code></pre><p>== ä¸Šé¢çš„é…ç½®ä¸­ï¼Œå‡å¦‚é…ç½®äº†ç”¨æˆ·è®¿é—®çš„é€»è¾‘åº“ï¼Œé‚£ä¹ˆå¿…é¡»åœ¨ <code>schema.xml</code> æ–‡ä»¶ä¸­ä¹Ÿé…ç½®è¿™ä¸ªé€»è¾‘åº“ï¼Œå¦åˆ™æŠ¥é”™ï¼Œå¯åŠ¨ mycat å¤±è´¥ ==</p><h5 id="é…ç½®schema-xml"><a href="#é…ç½®schema-xml" class="headerlink" title="é…ç½®schema.xml"></a>é…ç½®schema.xml</h5><p>ä»¥ä¸‹æ˜¯é…ç½®æ–‡ä»¶ä¸­çš„æ¯ä¸ªéƒ¨åˆ†çš„é…ç½®å—å„¿</p><p><strong>é€»è¾‘åº“å’Œåˆ†è¡¨è®¾ç½®</strong></p><pre><code>&lt;schema name=&quot;mycat_db&quot;           // é€»è¾‘åº“åç§°,ä¸server.xmlçš„ä¸€è‡´        checkSQLschema=&quot;false&quot;    // ä¸æ£€æŸ¥        sqlMaxLimit=&quot;100&quot;         // æœ€å¤§è¿æ¥æ•°        dataNode=&quot;tiger1&quot;&gt;        //  æ•°æ®èŠ‚ç‚¹åç§°&lt;!--è¿™é‡Œå®šä¹‰çš„æ˜¯åˆ†è¡¨çš„ä¿¡æ¯--&gt;        &lt;/schema&gt;</code></pre><p><strong>æ•°æ®èŠ‚ç‚¹</strong></p><pre><code>&lt;dataNode name=&quot;tiger1&quot;             // æ­¤æ•°æ®èŠ‚ç‚¹çš„åç§°          dataHost=&quot;localhost1&quot;     // ä¸»æœºç»„          database=&quot;mycat_test&quot; /&gt;  // çœŸå®çš„æ•°æ®åº“åç§°</code></pre><p><strong>ä¸»æœºç»„</strong></p><pre><code>&lt;dataHost name=&quot;localhost1&quot;                       // ä¸»æœºç»„          maxCon=&quot;1000&quot; minCon=&quot;10&quot;               // è¿æ¥          balance=&quot;0&quot;                             // è´Ÿè½½å‡è¡¡          writeType=&quot;0&quot;                           // å†™æ¨¡å¼é…ç½®          dbType=&quot;mysql&quot; dbDriver=&quot;native&quot;        // æ•°æ®åº“é…ç½®          switchType=&quot;1&quot;  slaveThreshold=&quot;100&quot;&gt;&lt;!--è¿™é‡Œå¯ä»¥é…ç½®å…³äºè¿™ä¸ªä¸»æœºç»„çš„æˆå‘˜ä¿¡æ¯ï¼Œå’Œé’ˆå¯¹è¿™äº›ä¸»æœºçš„å¥åº·æ£€æŸ¥è¯­å¥--&gt;&lt;/dataHost&gt;</code></pre><pre><code>balance å±æ€§è´Ÿè½½å‡è¡¡ç±»å‹,ç›®å‰çš„å–å€¼æœ‰ 3 ç§:1. balance=&quot;0&quot;, ä¸å¼€å¯è¯»å†™åˆ†ç¦»æœºåˆ¶,æ‰€æœ‰è¯»æ“ä½œéƒ½å‘é€åˆ°å½“å‰å¯ç”¨çš„ writeHost ä¸Šã€‚2. balance=&quot;1&quot;, å…¨éƒ¨çš„ readHost ä¸ stand by writeHost å‚ä¸ select è¯­å¥çš„è´Ÿè½½å‡è¡¡,ç®€å•çš„è¯´,å½“åŒä¸»åŒä»æ¨¡å¼(M1-&gt;S1,M2-&gt;S2,å¹¶ä¸” M1 ä¸ M2     äº’ä¸ºä¸»å¤‡),æ­£å¸¸æƒ…å†µä¸‹,M2,S1,S2 éƒ½å‚ä¸ select è¯­å¥çš„è´Ÿè½½å‡è¡¡ã€‚4. balance=&quot;2&quot;, æ‰€æœ‰è¯»æ“ä½œéƒ½éšæœºçš„åœ¨ writeHostã€readhost ä¸Šåˆ†å‘ã€‚5. balance=&quot;3&quot;, æ‰€æœ‰è¯»è¯·æ±‚éšæœºçš„åˆ†å‘åˆ° wiriterHost å¯¹åº”çš„ readhost æ‰§è¡Œ,writerHost ä¸è´Ÿæ‹…è¯»å‹åŠ›,æ³¨æ„ balance=3 åªåœ¨ 1.4 åŠå…¶ä»¥åç‰ˆæœ¬æœ‰,1.3 æ²¡æœ‰ã€‚writeType å±æ€§è´Ÿè½½å‡è¡¡ç±»å‹,ç›®å‰çš„å–å€¼æœ‰ 3 ç§:1. writeType=&quot;0&quot;, æ‰€æœ‰å†™æ“ä½œå‘é€åˆ°é…ç½®çš„ç¬¬ä¸€ä¸ª writeHost,ç¬¬ä¸€ä¸ªæŒ‚äº†åˆ‡åˆ°è¿˜ç”Ÿå­˜çš„ç¬¬äºŒä¸ªwriteHost,é‡æ–°å¯åŠ¨åå·²åˆ‡æ¢åçš„ä¸ºå‡†.2. writeType=&quot;1&quot;,æ‰€æœ‰å†™æ“ä½œéƒ½éšæœºçš„å‘é€åˆ°é…ç½®çš„ writeHost,1.5 ä»¥ååºŸå¼ƒä¸æ¨èã€‚</code></pre><p><strong>å¥åº·æ£€æŸ¥</strong></p><pre><code>&lt;heartbeat&gt;select user()&lt;/heartbeat&gt;</code></pre><p><strong>è¯»å†™é…ç½®</strong></p><pre><code>&lt;writeHost host=&quot;hostM1&quot; url=&quot;192.168.19.176:3306&quot; user=&quot;root&quot; password=&quot;1&quot;&gt;                        &lt;!-- can have multi read hosts --&gt;       &lt;readHost host=&quot;hostS2&quot; url=&quot;192.168.19.177:3306&quot; user=&quot;root&quot; password=&quot;1&quot; /&gt;&lt;/writeHost&gt;</code></pre><p>ä»¥ä¸‹æ˜¯ç»„åˆä¸ºå®Œæ•´çš„é…ç½®æ–‡ä»¶ï¼Œé€‚ç”¨äºä¸€ä¸»ä¸€ä»çš„æ¶æ„</p><pre><code>&lt;?xml version=&quot;1.0&quot;?&gt;&lt;!DOCTYPE mycat:schema SYSTEM &quot;schema.dtd&quot;&gt;&lt;mycat:schema xmlns:mycat=&quot;http://io.mycat/&quot;&gt;  &lt;schema name=&quot;mycat_db&quot;         checkSQLschema=&quot;false&quot;         sqlMaxLimit=&quot;100&quot;         dataNode=&quot;tiger1&quot;&gt;    &lt;!--è¿™é‡Œå®šä¹‰çš„æ˜¯åˆ†åº“åˆ†è¡¨çš„ä¿¡æ¯--&gt;        &lt;/schema&gt;  &lt;dataNode name=&quot;tiger1&quot;           dataHost=&quot;localhost1&quot; database=&quot;mycat_test&quot; /&gt;  &lt;dataHost name=&quot;localhost1&quot;             maxCon=&quot;1000&quot; minCon=&quot;10&quot;             balance=&quot;0&quot;            writeType=&quot;0&quot;             dbType=&quot;mysql&quot; dbDriver=&quot;native&quot;             switchType=&quot;1&quot;  slaveThreshold=&quot;100&quot;&gt;   &lt;heartbeat&gt;select user()&lt;/heartbeat&gt;       &lt;!-- can have multi write hosts --&gt;   &lt;writeHost host=&quot;hostM1&quot; url=&quot;192.168.19.176:3306&quot;               user=&quot;root&quot;  password=&quot;1&quot;&gt;      &lt;!-- can have multi read hosts --&gt;      &lt;readHost host=&quot;hostS2&quot; url=&quot;192.168.19.177:3306&quot;                 user=&quot;root&quot; password=&quot;1&quot; /&gt;     &lt;/writeHost&gt;   &lt;/dataHost&gt;&lt;/mycat:schema&gt;</code></pre><h4 id="å¯åŠ¨-mycat"><a href="#å¯åŠ¨-mycat" class="headerlink" title="å¯åŠ¨ mycat"></a>å¯åŠ¨ mycat</h4><pre><code>[root@mycat ~]# /usr/local/mycat/bin/mycat  startæ”¯æŒä¸€ä¸‹å‚æ•°start | restart |stop | status</code></pre><h4 id="åœ¨çœŸå®çš„-master-æ•°æ®åº“ä¸Šç»™ç”¨æˆ·æˆæƒ"><a href="#åœ¨çœŸå®çš„-master-æ•°æ®åº“ä¸Šç»™ç”¨æˆ·æˆæƒ" class="headerlink" title="åœ¨çœŸå®çš„ master æ•°æ®åº“ä¸Šç»™ç”¨æˆ·æˆæƒ"></a>åœ¨çœŸå®çš„ master æ•°æ®åº“ä¸Šç»™ç”¨æˆ·æˆæƒ</h4><pre><code>mysql&gt; grant all on mycat_test.* to root@&#39;%&#39; identified by &#39;1&#39;;mysql&gt; flush privileges;</code></pre><h4 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h4><p>åœ¨ mycat çš„æœºå™¨ä¸Šæµ‹è¯•ç”¨æˆ·æƒé™æœ‰æ•ˆæ€§</p><p>æµ‹è¯•æ˜¯å¦èƒ½æ­£å¸¸ç™»å½•ä¸Š ä¸»æœåŠ¡å™¨</p><pre><code>mysql -uroot -p&#39;123&#39; -h192.168.19.176</code></pre><p>ç»§ç»­æµ‹è¯•æ˜¯å¦èƒ½ç™»å½•ä¸Šä»æœåŠ¡å™¨</p><pre><code>mysql -uroot -p&#39;123&#39; -h192.168.19.177</code></pre><p>é€šè¿‡å®¢æˆ·ç«¯è¿›è¡Œæµ‹è¯•æ˜¯å¦èƒ½ç™»å½•åˆ° mycat ä¸Š</p><p>192.168.19.178 æ˜¯ mycat çš„ä¸»æœºåœ°å€</p><p>æ³¨æ„ç«¯å£å·æ˜¯ <code>8066</code></p><pre><code>[root@mysqlclient ~]# mysql -umycatdb -p1 -h192.168.19.178 -P8066MySQL [(none)]&gt; show databases;+----------+| DATABASE |+----------+| mycat_db |+----------+1 row in set (0.00 sec)</code></pre><p>ç»§ç»­æµ‹è¯•è¯»å†™åˆ†ç¦»ç­–ç•¥</p><p>ä½¿ç”¨  <code>mysql</code> å®¢æˆ·ç«¯å·¥å…·ä½¿ç”¨  <code>mycat</code> çš„è´¦æˆ·å’Œå¯†ç ç™»å½• <code>mycat</code> ,<br> ä¹‹åæ‰§è¡Œ <code>select</code> è¯­å¥ã€‚</p><p>ä¹‹åæŸ¥è¯¢ <code>mycat</code> ä¸»æœºä¸Š <code>mycat</code> å®‰è£…ç›®å½•ä¸‹çš„ <code>logs/mycat.log</code> æ—¥å¿—ã€‚</p><p>åœ¨æ—¥å¿—é‡æœç´¢æŸ¥è¯¢çš„è¯­å¥æˆ–è€…æŸ¥è¯¢ ä»åº“çš„ ip åœ°å€ï¼Œåº”è¯¥èƒ½æœç´¢åˆ°</p>]]></content>
      
      
      <categories>
          
          <category> SQL </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Mysql </tag>
            
            <tag> Mycat </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>gitlab-ci</title>
      <link href="2020/09/26/devops/gitlab-ci-ru-men/"/>
      <url>2020/09/26/devops/gitlab-ci-ru-men/</url>
      
        <content type="html"><![CDATA[<h5 id="gitlab-ciå…¥é—¨"><a href="#gitlab-ciå…¥é—¨" class="headerlink" title="gitlab-ciå…¥é—¨"></a>gitlab-ciå…¥é—¨</h5><h6 id="ç¤ºèŒƒï¼š"><a href="#ç¤ºèŒƒï¼š" class="headerlink" title="ç¤ºèŒƒï¼š"></a>ç¤ºèŒƒï¼š</h6><pre class=" language-dockerfile"><code class="language-dockerfile">docker run -d --name gitlab-runner   \  -v /data/cyy/gitlab-runner:/etc/gitlab-runner \  -v /var/run/docker.sock:/var/run/docker.sock \ -v /usr/bin/docker:/usr/bin/docker \ -v /usr/lib64/libltdl.so.7:/usr/lib/x86_64-linux-gnu/libltdl.so.7  \  gitlab/gitlab-runneråœ¨å®¿ä¸»æœºä¸Šæ‰§è¡Œ ï¼šchmod 666 /var/run/docker.sock</code></pre><pre class=" language-yml"><code class="language-yml"># cat  .gitlab-ci.ymlstages:  - test  - buildjob1:  stage: test  script:    - echo "it is test"job2:  stage: build  script:    - echo "it is build"</code></pre><h6 id="å„ç§å‚æ•°è¯´æ˜"><a href="#å„ç§å‚æ•°è¯´æ˜" class="headerlink" title="å„ç§å‚æ•°è¯´æ˜"></a>å„ç§å‚æ•°è¯´æ˜</h6><pre class=" language-shell"><code class="language-shell">script             ç”±Runneræ‰§è¡Œçš„Shellè„šæœ¬ã€‚image              ä½¿ç”¨dockeré•œåƒï¼Œ  imageï¼šnameservice            ä½¿ç”¨docker  servicesé•œåƒ, servicesï¼šnamebefore_script      æ‰§è¡Œä½œä¸šå‰è¿è¡Œçš„è„šæœ¬after_script       ä½œä¸šå®Œæˆåè¿è¡Œçš„è„šæœ¬stages             å®šä¹‰ç®¡é“ä¸­çš„æ­¥éª¤ï¼Œä¾æ¬¡è¿è¡Œstage              å®šä¹‰ç®¡é“ä¸­æ­¥éª¤çš„ä½œä¸šæ®µonly    ã€€ã€€        æŒ‡å®šä½œä¸šé™åˆ¶only:refsï¼Œonly:kubernetesï¼Œonly:variablesï¼Œå’Œonly:changestags               æŒ‡å®šæ‰§è¡Œä½œä¸šçš„runnerallow_failure      å…è®¸jobå¤±è´¥when               ä»€ä¹ˆæ—¶å€™å¼€å§‹å·¥ä½œï¼Œ  on_success       åªæœ‰å½“å‰ä¸€ä¸ªé˜¶æ®µçš„æ‰€æœ‰å·¥ä½œéƒ½æˆåŠŸæ—¶ï¼ˆæˆ–è€…å› ä¸ºå®ƒä»¬è¢«æ ‡è®°è€Œè¢«è®¤ä¸ºæ˜¯æˆåŠŸçš„allow_failureï¼‰æ‰æ‰§è¡Œå·¥ä½œ ã€‚è¿™æ˜¯é»˜è®¤å€¼ã€‚  on_failure       ä»…å½“å‰ä¸€é˜¶æ®µçš„è‡³å°‘ä¸€ä¸ªä½œä¸šå¤±è´¥æ—¶æ‰æ‰§è¡Œä½œä¸šã€‚  always           æ— è®ºå…ˆå‰é˜¶æ®µçš„å·¥ä½œçŠ¶æ€å¦‚ä½•ï¼Œéƒ½å¯ä»¥æ‰§è¡Œå·¥ä½œã€‚  manual           æ‰‹åŠ¨æ‰§è¡Œä½œä¸š  delayed          å»¶è¿Ÿä½œä¸šã€‚åé¢è·Ÿstart_in,start_in 30minutes(å»¶è¿Ÿ30åˆ†é’Ÿ)ï¼Œä¸åŠ å•ä½ï¼Œé»˜è®¤ä¸ºç§’ã€‚æœ€é•¿å¯å»¶è¿Ÿ1å°æ—¶ã€‚environment     ä½œä¸šéƒ¨ç½²åˆ°çš„ç¯å¢ƒåç§°   #æš‚æœªææ¸… cache    ã€€ã€€keyï¼š"$CI_JOB_STAGE-$CI_COMMIT_REF_SLUG" #ä¸ºæ¯åˆ†æ”¯ï¼Œæ¯æ­¥éª¤å¯ç”¨ç¼“å­˜artifacts         jobæˆåŠŸæ—¶é™„åŠ åˆ°ä½œä¸šçš„æ–‡ä»¶æˆ–ç›®å½•dependencies      æ­¤jobä¾èµ–å…¶ä»–jobz,ä¸»è¦ä½œç”¨äºä½œä¸šä¼˜å…ˆçº§converage         ç»™å®šä½œä¸šä»£ç è¦†ç›–ç‡è®¾ç½®ã€€ã€€ã€€ã€€ã€€ã€€ retry             åœ¨å‘ç”Ÿæ•…éšœæ—¶ï¼Œå¯ä»¥è‡ªåŠ¨é‡è¯•ä½œä¸šçš„æ¬¡æ•°ã€‚parallelã€€ã€€      åº”è¯¥å¹¶è¡Œè¿è¡Œå¤šå°‘ä¸ªä½œä¸šå®ä¾‹trigger          å®šä¹‰ä¸‹æ¸¸ç®¡é“è§¦å‘å™¨include          å…è®¸æ­¤ä½œä¸šåŒ…å«å¤–éƒ¨YAMLextends          æ­¤ä½œä¸šå°†ç»§æ‰¿çš„é…ç½®é¡¹pages            ä¸Šä¼ ä½œä¸šç»“æœç”¨äºgitlab pagesvariables        ä½œä¸šçº§åˆ«å®šä¹‰ä½œä¸šå˜é‡</code></pre><h6 id="æ¡ˆä¾‹-1-è‡ªåŠ¨æ„å»º-go-ç¨‹åº"><a href="#æ¡ˆä¾‹-1-è‡ªåŠ¨æ„å»º-go-ç¨‹åº" class="headerlink" title="æ¡ˆä¾‹ 1  è‡ªåŠ¨æ„å»º go ç¨‹åº"></a>æ¡ˆä¾‹ 1  è‡ªåŠ¨æ„å»º go ç¨‹åº</h6><pre class=" language-yam"><code class="language-yam">stages:  - testjob1:  stage: test  script:    - docker build -t mygo:v1  .  tags:    - go</code></pre><pre class=" language-dockerfile"><code class="language-dockerfile">FROM golang:1.14.4-alpine3.12RUN mkdir /src /appADD . ../srcENV GOPROXY="https://goproxy.io"RUN cd /src && ls && go build -o ../app/mygo main.go && cd /app && chmod +x mygo && cd /RUN rm src -frWORKDIR /appENTRYPOINT  ["/app/mygo"]</code></pre><h6 id="å‹ç¼©é•œåƒ"><a href="#å‹ç¼©é•œåƒ" class="headerlink" title="å‹ç¼©é•œåƒ"></a>å‹ç¼©é•œåƒ</h6><pre class=" language-dockerfile"><code class="language-dockerfile">FROM golang:1.14.4-alpine3.12RUN mkdir /src /appADD . ../srcENV GOPROXY="https://goproxy.io"RUN cd /src && ls && go build -o ../app/mygo main.go && cd /app && chmod +x mygo && cd /FROM alpine:3.12RUN mkdir /appCOPY --from=0 /app/mygo /appENTRYPOINT ["/app/mygo"]</code></pre><h6 id="å•å…ƒæµ‹è¯•"><a href="#å•å…ƒæµ‹è¯•" class="headerlink" title="å•å…ƒæµ‹è¯•"></a>å•å…ƒæµ‹è¯•</h6><pre class=" language-dockerfile"><code class="language-dockerfile">FROM golang:1.14.4-alpine3.12ADD . /srcWORKDIR /srccmd ["go","test"]</code></pre><pre class=" language-yml"><code class="language-yml">stages:  - test  - buildGoTest:  stage: test  script:    - docker build -f DockerfileTest -t test-mygo:v1 .    - docker run --rm test-mygo:v1  after_script:    - docker rmi test-mygo:v1  tags:    - goGoBuild:  stage: build  script:    - docker build -t mygo:v1  .  after_script:    - docker rmi $(docker images -af "dangling=true" -q)  tags:    - goGoDeploy:   #ä½¿ç”¨ç§æœ‰é•œåƒä»“åº“    stage: deploy    script:      - docker tag  mygo:v1  10.0.0.169:5000/mygo:v1      - docker push 10.0.0.169:5000/mygo:v1    after_script:        - docker rmi 10.0.0.169:5000/mygo:v1        - docker rmi mygo:v1    tags:      - go</code></pre><pre class=" language-shell"><code class="language-shell">æŸ¥çœ‹æ•°æ®curl http://10.0.0.169:5000/v2/_catalog   (æŸ¥çœ‹åˆ—è¡¨)curl http://10.0.0.169:5000/v2/mygo/manifests/v1   (æŸ¥çœ‹redisé•œåƒè¯¦æƒ…)curl http://10.0.0.169:5000/v2/mygo/tags/list</code></pre><h6 id="è‡ªåŠ¨æ›´æ–°æœåŠ¡"><a href="#è‡ªåŠ¨æ›´æ–°æœåŠ¡" class="headerlink" title="è‡ªåŠ¨æ›´æ–°æœåŠ¡"></a>è‡ªåŠ¨æ›´æ–°æœåŠ¡</h6><pre class=" language-shell"><code class="language-shell">docker run -d --name gitlab-runner   \  -v /data/cyy/gitlab-runner:/etc/gitlab-runner \  -v /var/run/docker.sock:/var/run/docker.sock \ -v /usr/bin/docker:/usr/bin/docker \ -v /usr/lib64/libltdl.so.7:/usr/lib/x86_64-linux-gnu/libltdl.so.7  \-v /usr/local/bin/kubectl:/usr/local/bin/kubectl \-v /home/cyy/kubectl/config:/kubeconfig \-e KUBECONFIG=/kubeconfig \  gitlab/gitlab-runner</code></pre><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">stages</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> build  <span class="token punctuation">-</span> deploy  <span class="token punctuation">-</span> pub<span class="token key atrule">GoBuild</span><span class="token punctuation">:</span>  <span class="token key atrule">stage</span><span class="token punctuation">:</span> build  <span class="token key atrule">script</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> docker build <span class="token punctuation">-</span>t mygo<span class="token punctuation">:</span>v1  .  <span class="token key atrule">after_script</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> docker rmi $(docker images <span class="token punctuation">-</span>af "dangling=true" <span class="token punctuation">-</span>q)  <span class="token key atrule">tags</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> go<span class="token key atrule">GoDeploy</span><span class="token punctuation">:</span>  <span class="token key atrule">stage</span><span class="token punctuation">:</span> deploy  <span class="token key atrule">script</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> docker tag  mygo<span class="token punctuation">:</span>v1  10.0.0.169<span class="token punctuation">:</span>5000/mygo<span class="token punctuation">:</span>v1    <span class="token punctuation">-</span> docker push 10.0.0.169<span class="token punctuation">:</span>5000/mygo<span class="token punctuation">:</span>v1  <span class="token key atrule">after_script</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> docker rmi 10.0.0.169<span class="token punctuation">:</span>5000/mygo<span class="token punctuation">:</span>v1    <span class="token punctuation">-</span> docker rmi mygo<span class="token punctuation">:</span>v1  <span class="token key atrule">tags</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> go<span class="token key atrule">GoPub</span><span class="token punctuation">:</span>  <span class="token key atrule">stage</span><span class="token punctuation">:</span> pub  <span class="token key atrule">script</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> kubectl get pod <span class="token punctuation">-</span>n myweb<span class="token punctuation">|</span> grep mygo <span class="token punctuation">|</span> awk '<span class="token punctuation">{</span>print $1<span class="token punctuation">}</span>'  <span class="token punctuation">|</span> xargs kubectl delete pod <span class="token punctuation">-</span>n myweb  <span class="token key atrule">tags</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> go</code></pre>]]></content>
      
      
      <categories>
          
          <category> DevOps </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Gitlab </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ­å»º NFS æœåŠ¡</title>
      <link href="2020/09/24/linux/bu-shu-nfs-fu-wu/"/>
      <url>2020/09/24/linux/bu-shu-nfs-fu-wu/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><p>ç›®çš„ï¼šéƒ¨ç½² NFS æœåŠ¡è¿›è¡Œè·¨ä¸»æœºæ–‡ä»¶å…±äº«</p><p>Network File System<br>      é€šè¿‡ç½‘ç»œï¼Œè®©ä¸åŒçš„æœºå™¨ã€ä¸åŒçš„æ“ä½œç³»ç»Ÿå¯ä»¥å…±äº«å½¼æ­¤çš„æ–‡ä»¶ã€‚</p><h3 id="1ã€ç¯å¢ƒå‡†å¤‡"><a href="#1ã€ç¯å¢ƒå‡†å¤‡" class="headerlink" title="1ã€ç¯å¢ƒå‡†å¤‡"></a>1ã€ç¯å¢ƒå‡†å¤‡</h3><pre class=" language-shell"><code class="language-shell">1.ç³»ç»Ÿç‰ˆæœ¬ï¼šCentOS7.42.NFSç‰ˆæœ¬ï¼šnfs-utils ï¼ˆä½¿ç”¨å½“å‰æœ€æ–°ç‰ˆæœ¬ï¼‰3.åˆå§‹åŒ–ç³»ç»Ÿç¯å¢ƒ4.å…³é—­é˜²ç«å¢™[root@localhost ~]#  systemctl stop iptables firewalld[root@localhost ~]#  systemctl disable iptables firewalld5.å…³é—­SELinux[root@localhost ~]#  sed -ri '/SELINUX=/cSELINUX=disabled' /etc/selinux/config[root@localhost ~]#  setenforce 0           # ä¸´æ—¶å…³é—­SELinux</code></pre><h3 id="2ã€éƒ¨ç½²NFS"><a href="#2ã€éƒ¨ç½²NFS" class="headerlink" title="2ã€éƒ¨ç½²NFS"></a>2ã€éƒ¨ç½²NFS</h3><pre class=" language-shell"><code class="language-shell">    1ã€sudo yum -y install nfs-utils     2ã€é…ç½®    sudo vi /etc/sysconfig/nfs    åŠ å…¥     LOCKD_TCPPORT=30001 #TCPé”ä½¿ç”¨ç«¯å£    LOCKD_UDPPORT=30002 #UDPé”ä½¿ç”¨ç«¯å£    MOUNTD_PORT=30003 #æŒ‚è½½ä½¿ç”¨ç«¯å£    STATD_PORT=30004 #çŠ¶æ€ä½¿ç”¨ç«¯å£</code></pre><h3 id="3ã€å¯åŠ¨-é‡å¯æœåŠ¡"><a href="#3ã€å¯åŠ¨-é‡å¯æœåŠ¡" class="headerlink" title="3ã€å¯åŠ¨/é‡å¯æœåŠ¡"></a>3ã€å¯åŠ¨/é‡å¯æœåŠ¡</h3><pre class=" language-shell"><code class="language-shell">1ã€sudo systemctl restart rpcbind.service 2ã€sudo systemctl restart nfs-server.serviceå¼€æœºå¯åŠ¨ï¼š1ã€sudo  systemctl enable rpcbind.service2ã€ sudo systemctl enable nfs-server.service</code></pre><h3 id="4ã€ç¼–è¾‘å…±äº«ç›®å½•"><a href="#4ã€ç¼–è¾‘å…±äº«ç›®å½•" class="headerlink" title="4ã€ç¼–è¾‘å…±äº«ç›®å½•"></a>4ã€ç¼–è¾‘å…±äº«ç›®å½•</h3><pre class=" language-shell"><code class="language-shell">ç¼–è¾‘/etc/exports  sudo vi /etc/exports å†™å…¥å¦‚ä¸‹å†…å®¹   /home/cyy/goapi    10.0.0.0/24(rw,async,insecure,no_root_squash)</code></pre><h6 id="å‚æ•°è¯´æ˜"><a href="#å‚æ•°è¯´æ˜" class="headerlink" title="å‚æ•°è¯´æ˜"></a>å‚æ•°è¯´æ˜</h6><table><thead><tr><th align="center">å‚æ•°</th><th align="center">ä½œç”¨</th></tr></thead><tbody><tr><td align="center">ro</td><td align="center">åªè¯»</td></tr><tr><td align="center">rw</td><td align="center">è¯»å†™</td></tr><tr><td align="center">root_squash</td><td align="center">å½“NFSå®¢æˆ·ç«¯ä»¥rootç®¡ç†å‘˜è®¿é—®æ—¶ï¼Œæ˜ å°„ä¸ºNFSæœåŠ¡å™¨çš„åŒ¿åç”¨æˆ·</td></tr><tr><td align="center">no_root_squash</td><td align="center">å½“NFSå®¢æˆ·ç«¯ä»¥rootç®¡ç†å‘˜è®¿é—®æ—¶ï¼Œæ˜ å°„ä¸ºNFSæœåŠ¡å™¨çš„rootç®¡ç†å‘˜</td></tr><tr><td align="center">all_squash</td><td align="center">æ— è®ºNFSå®¢æˆ·ç«¯ä½¿ç”¨ä»€ä¹ˆè´¦æˆ·è®¿é—®ï¼Œå‡æ˜ å°„ä¸ºNFSæœåŠ¡å™¨çš„åŒ¿åç”¨æˆ·</td></tr><tr><td align="center">sync</td><td align="center">åŒæ—¶å°†æ•°æ®å†™å…¥åˆ°å†…å­˜ä¸ç¡¬ç›˜ä¸­ï¼Œä¿è¯ä¸ä¸¢å¤±æ•°æ®</td></tr><tr><td align="center">async</td><td align="center">ä¼˜å…ˆå°†æ•°æ®ä¿å­˜åˆ°å†…å­˜ï¼Œç„¶åå†å†™å…¥ç¡¬ç›˜;è¿™æ ·æ•ˆç‡æ›´é«˜ï¼Œä½†å¯èƒ½ä¼šä¸¢å¤±æ•°æ®</td></tr><tr><td align="center">secureï¼ˆé»˜è®¤ï¼‰</td><td align="center">é™åˆ¶å®¢æˆ·ç«¯åªèƒ½ä»å°äº1024çš„tcp/ipç«¯å£è¿æ¥æœåŠ¡å™¨</td></tr><tr><td align="center">insecure</td><td align="center">å…è®¸å®¢æˆ·ç«¯ä»å¤§äº1024çš„tcp/ipç«¯å£è¿æ¥æœåŠ¡å™¨</td></tr><tr><td align="center">anonuid</td><td align="center">åŒ¿åç”¨æˆ·çš„UIDå€¼ï¼Œé€šå¸¸æ˜¯nobodyæˆ–nfsnobodyï¼Œå¯ä»¥åœ¨æ­¤å¤„è‡ªè¡Œè®¾å®š</td></tr><tr><td align="center">anongid</td><td align="center">åŒ¿åç”¨æˆ·çš„GIDå€¼</td></tr><tr><td align="center">no_subtree_check</td><td align="center">å¦‚æœNFSè¾“å‡ºçš„æ˜¯ä¸€ä¸ªå­ç›®å½•ï¼Œåˆ™æ— éœ€æ£€æŸ¥å…¶çˆ¶ç›®å½•çš„æƒé™ï¼ˆå¯ä»¥æé«˜æ•ˆç‡ï¼‰</td></tr></tbody></table><h3 id="5ã€æŸ¥çœ‹æŒ‚è½½"><a href="#5ã€æŸ¥çœ‹æŒ‚è½½" class="headerlink" title="5ã€æŸ¥çœ‹æŒ‚è½½"></a>5ã€æŸ¥çœ‹æŒ‚è½½</h3><pre class=" language-shell"><code class="language-shell">showmount -e localhostå‘ç°æ²¡æœ‰é‡å¯nfsæœåŠ¡  (sudo systemctl restart nfs-server.service)æ¥ä¸‹æ¥  åˆ›å»ºåˆšæ‰çš„æ–‡ä»¶å¤¹ </code></pre><h5 id="æ¥åˆ°å¦å¤–ä¸€å°æœåŠ¡å™¨ä¸Š"><a href="#æ¥åˆ°å¦å¤–ä¸€å°æœåŠ¡å™¨ä¸Š" class="headerlink" title="æ¥åˆ°å¦å¤–ä¸€å°æœåŠ¡å™¨ä¸Š"></a>æ¥åˆ°å¦å¤–ä¸€å°æœåŠ¡å™¨ä¸Š</h5><pre class=" language-shell"><code class="language-shell">sudo yum -y install nfs-utils ä¸éœ€è¦å¯åŠ¨nfsæœåŠ¡ç›´æ¥æ‰§è¡Œå¦‚ä¸‹ï¼šshowmount -e 10.0.0.145å°è¯•è¿›è¡ŒæŒ‚è½½  mount -t nfs 10.0.0.145:/home/cyy/goapi   /home/cyy/goapiå¸è½½åªéœ€ umount /home/cyy/goapi</code></pre>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> NFS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mysql-æ¸¸æ ‡</title>
      <link href="2020/07/16/sql/mysql-you-biao/"/>
      <url>2020/07/16/sql/mysql-you-biao/</url>
      
        <content type="html"><![CDATA[<h5 id="mysqlæ¸¸æ ‡çš„ç”¨æ³•åŠä½œç”¨"><a href="#mysqlæ¸¸æ ‡çš„ç”¨æ³•åŠä½œç”¨" class="headerlink" title="[mysqlæ¸¸æ ‡çš„ç”¨æ³•åŠä½œç”¨]"></a>[mysqlæ¸¸æ ‡çš„ç”¨æ³•åŠä½œç”¨]</h5><p>ä¾‹å­ï¼š</p><p>å½“å‰æœ‰ä¸‰å¼ è¡¨Aã€Bã€Cå…¶ä¸­Aå’ŒBæ˜¯ä¸€å¯¹å¤šå…³ç³»ï¼ŒBå’ŒCæ˜¯ä¸€å¯¹å¤šå…³ç³»ï¼Œç°åœ¨éœ€è¦å°†Bä¸­Aè¡¨çš„ä¸»é”®å­˜åˆ°Cä¸­ï¼›<br>å¸¸è§„æ€è·¯å°±æ˜¯å°†Bä¸­æŸ¥è¯¢å‡ºæ¥ç„¶åé€šè¿‡ä¸€ä¸ªupdateè¯­å¥æ¥æ›´æ–°Cè¡¨å°±å¯ä»¥äº†ï¼Œä½†æ˜¯Bè¡¨ä¸­æœ‰2000å¤šæ¡æ•°æ®ï¼Œ<br>éš¾é“è¦æ‰§è¡Œ2000å¤šæ¬¡ï¼Ÿæ˜¾ç„¶æ˜¯ä¸ç°å®çš„ï¼›æœ€ç»ˆæ‰¾åˆ°å†™ä¸€ä¸ªå­˜å‚¨è¿‡ç¨‹ç„¶åé€šè¿‡å¾ªç¯æ¥æ›´æ–°Cè¡¨ï¼Œ<br>ç„¶è€Œå­˜å‚¨è¿‡ç¨‹ä¸­çš„å†™æ³•ç”¨çš„å°±æ˜¯æ¸¸æ ‡çš„å½¢å¼ã€‚</p><h5 id="ã€ç®€ä»‹ã€‘"><a href="#ã€ç®€ä»‹ã€‘" class="headerlink" title="ã€ç®€ä»‹ã€‘"></a>ã€ç®€ä»‹ã€‘</h5><p>â€‹    æ¸¸æ ‡å®é™…ä¸Šæ˜¯ä¸€ç§èƒ½ä»åŒ…æ‹¬å¤šæ¡æ•°æ®è®°å½•çš„ç»“æœé›†ä¸­æ¯æ¬¡æå–ä¸€æ¡è®°å½•çš„æœºåˆ¶ã€‚</p><p>â€‹    æ¸¸æ ‡å……å½“æŒ‡é’ˆçš„ä½œç”¨ã€‚</p><p>â€‹    å°½ç®¡æ¸¸æ ‡èƒ½éå†ç»“æœä¸­çš„æ‰€æœ‰è¡Œï¼Œä½†ä»–ä¸€æ¬¡åªæŒ‡å‘ä¸€è¡Œã€‚</p><p>â€‹    æ¸¸æ ‡çš„ä½œç”¨å°±æ˜¯ç”¨äºå¯¹æŸ¥è¯¢æ•°æ®åº“æ‰€è¿”å›çš„è®°å½•è¿›è¡Œéå†ï¼Œä»¥ä¾¿è¿›è¡Œç›¸åº”çš„æ“ä½œã€‚</p><h5 id="ã€ç”¨æ³•ã€‘"><a href="#ã€ç”¨æ³•ã€‘" class="headerlink" title="ã€ç”¨æ³•ã€‘"></a>ã€ç”¨æ³•ã€‘</h5><p>â€‹    ä¸€ã€å£°æ˜ä¸€ä¸ªæ¸¸æ ‡: declare æ¸¸æ ‡åç§° CURSOR for table;(è¿™é‡Œçš„tableå¯ä»¥æ˜¯ä½ æŸ¥è¯¢å‡ºæ¥çš„ä»»æ„é›†åˆ)<br>â€‹    äºŒã€æ‰“å¼€å®šä¹‰çš„æ¸¸æ ‡:open æ¸¸æ ‡åç§°;<br>â€‹    ä¸‰ã€è·å¾—ä¸‹ä¸€è¡Œæ•°æ®:FETCH  æ¸¸æ ‡åç§° into testrangeid,versionid;<br>â€‹    å››ã€éœ€è¦æ‰§è¡Œçš„è¯­å¥(å¢åˆ æ”¹æŸ¥):è¿™é‡Œè§†å…·ä½“æƒ…å†µè€Œå®š<br>â€‹    äº”ã€é‡Šæ”¾æ¸¸æ ‡:CLOSE æ¸¸æ ‡åç§°;<br>  æ³¨:mysqlå­˜å‚¨è¿‡ç¨‹æ¯ä¸€å¥åé¢å¿…é¡»ç”¨;ç»“å°¾ï¼Œä½¿ç”¨çš„ä¸´æ—¶å­—æ®µéœ€è¦åœ¨å®šä¹‰æ¸¸æ ‡ä¹‹å‰è¿›è¡Œå£°æ˜ã€‚</p><h5 id="ã€å®ä¾‹ã€‘"><a href="#ã€å®ä¾‹ã€‘" class="headerlink" title="ã€å®ä¾‹ã€‘"></a>ã€å®ä¾‹ã€‘</h5><pre class=" language-sql"><code class="language-sql"><span class="token operator">-</span>  <span class="token keyword">BEGIN</span>  <span class="token comment" spellcheck="true">--å®šä¹‰å˜é‡  </span><span class="token keyword">declare</span> testrangeid <span class="token keyword">BIGINT</span><span class="token punctuation">;</span>  <span class="token keyword">declare</span> versionid <span class="token keyword">BIGINT</span><span class="token punctuation">;</span>   <span class="token keyword">declare</span> done <span class="token keyword">int</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">--åˆ›å»ºæ¸¸æ ‡ï¼Œå¹¶å­˜å‚¨æ•°æ®  </span><span class="token keyword">declare</span> cur_test <span class="token keyword">CURSOR</span> <span class="token keyword">for</span>      <span class="token keyword">select</span> id <span class="token keyword">as</span> testrangeid<span class="token punctuation">,</span>version_id <span class="token keyword">as</span> versionid <span class="token keyword">from</span> tp_testrange<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">--æ¸¸æ ‡ä¸­çš„å†…å®¹æ‰§è¡Œå®Œåå°†doneè®¾ç½®ä¸º1  </span> <span class="token keyword">DECLARE</span> <span class="token keyword">CONTINUE</span> <span class="token keyword">HANDLER</span> <span class="token keyword">FOR</span> <span class="token operator">NOT</span> FOUND <span class="token keyword">SET</span> done<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">--æ‰“å¼€æ¸¸æ ‡  </span><span class="token keyword">open</span> cur_test<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">--æ‰§è¡Œå¾ªç¯  </span>  posLoop:LOOP  <span class="token comment" spellcheck="true">--åˆ¤æ–­æ˜¯å¦ç»“æŸå¾ªç¯  </span>        <span class="token keyword">IF</span> done<span class="token operator">=</span><span class="token number">1</span> <span class="token keyword">THEN</span>          LEAVE posLoop<span class="token punctuation">;</span>      <span class="token keyword">END</span> <span class="token keyword">IF</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">--å–æ¸¸æ ‡ä¸­çš„å€¼  </span>    <span class="token keyword">FETCH</span>  cur_test <span class="token keyword">into</span> testrangeid<span class="token punctuation">,</span>versionid<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">--æ‰§è¡Œæ›´æ–°æ“ä½œ  </span>    <span class="token keyword">update</span> tp_data_execute <span class="token keyword">set</span> version_id<span class="token operator">=</span>versionid <span class="token keyword">where</span> testrange_id <span class="token operator">=</span> testrangeid<span class="token punctuation">;</span>    <span class="token keyword">END</span> LOOP posLoop<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">--é‡Šæ”¾æ¸¸æ ‡  </span><span class="token keyword">CLOSE</span> cur_test<span class="token punctuation">;</span>  <span class="token keyword">END</span>  <span class="token operator">-</span>  </code></pre><p> ä¾‹å­2ï¼š</p><p>æˆ‘ä»¬ç°åœ¨è¦ç”¨å­˜å‚¨è¿‡ç¨‹åšä¸€ä¸ªåŠŸèƒ½ï¼Œç»Ÿè®¡iphoneçš„æ€»åº“å­˜æ˜¯å¤šå°‘ï¼Œå¹¶æŠŠæ€»æ•°è¾“å‡ºåˆ°æ§åˆ¶å°ã€‚</p><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">--åœ¨windowsç³»ç»Ÿä¸­å†™å­˜å‚¨è¿‡ç¨‹æ—¶ï¼Œå¦‚æœéœ€è¦ä½¿ç”¨declareå£°æ˜å˜é‡ï¼Œéœ€è¦æ·»åŠ è¿™ä¸ªå…³é”®å­—ï¼Œå¦åˆ™ä¼šæŠ¥é”™ã€‚  </span><span class="token keyword">delimiter</span> <span class="token comment" spellcheck="true">//  </span><span class="token keyword">drop</span> <span class="token keyword">procedure</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> StatisticStore<span class="token punctuation">;</span>  <span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> StatisticStore<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token keyword">BEGIN</span>      <span class="token comment" spellcheck="true">--åˆ›å»ºæ¥æ”¶æ¸¸æ ‡æ•°æ®çš„å˜é‡  </span>    <span class="token keyword">declare</span> <span class="token number">c</span> <span class="token keyword">int</span><span class="token punctuation">;</span>      <span class="token keyword">declare</span> n <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">--åˆ›å»ºæ€»æ•°å˜é‡  </span>    <span class="token keyword">declare</span> total <span class="token keyword">int</span> <span class="token keyword">default</span> <span class="token number">0</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">--åˆ›å»ºç»“æŸæ ‡å¿—å˜é‡  </span>    <span class="token keyword">declare</span> done <span class="token keyword">int</span> <span class="token keyword">default</span> <span class="token boolean">false</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">--åˆ›å»ºæ¸¸æ ‡  </span>    <span class="token keyword">declare</span> cur <span class="token keyword">cursor</span> <span class="token keyword">for</span> <span class="token keyword">select</span> name<span class="token punctuation">,</span>count <span class="token keyword">from</span> store <span class="token keyword">where</span> name <span class="token operator">=</span> <span class="token string">'iphone'</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">--æŒ‡å®šæ¸¸æ ‡å¾ªç¯ç»“æŸæ—¶çš„è¿”å›å€¼  </span>    <span class="token keyword">declare</span> <span class="token keyword">continue</span> <span class="token keyword">HANDLER</span> <span class="token keyword">for</span> <span class="token operator">not</span> found <span class="token keyword">set</span> done <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">--è®¾ç½®åˆå§‹å€¼  </span>    <span class="token keyword">set</span> total <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">--æ‰“å¼€æ¸¸æ ‡  </span>    <span class="token keyword">open</span> cur<span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">--å¼€å§‹å¾ªç¯æ¸¸æ ‡é‡Œçš„æ•°æ®  </span>    read_loop:loop      <span class="token comment" spellcheck="true">--æ ¹æ®æ¸¸æ ‡å½“å‰æŒ‡å‘çš„ä¸€æ¡æ•°æ®  </span>    <span class="token keyword">fetch</span> cur <span class="token keyword">into</span> n<span class="token punctuation">,</span><span class="token number">c</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">--åˆ¤æ–­æ¸¸æ ‡çš„å¾ªç¯æ˜¯å¦ç»“æŸ  </span>    <span class="token keyword">if</span> done <span class="token keyword">then</span>          leave read_loop<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">--è·³å‡ºæ¸¸æ ‡å¾ªç¯  </span>    <span class="token keyword">end</span> <span class="token keyword">if</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">--è·å–ä¸€æ¡æ•°æ®æ—¶ï¼Œå°†countå€¼è¿›è¡Œç´¯åŠ æ“ä½œï¼Œè¿™é‡Œå¯ä»¥åšä»»æ„ä½ æƒ³åšçš„æ“ä½œï¼Œ  </span>    <span class="token keyword">set</span> total <span class="token operator">=</span> total <span class="token operator">+</span> <span class="token number">c</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">--ç»“æŸæ¸¸æ ‡å¾ªç¯  </span>    <span class="token keyword">end</span> loop<span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">--å…³é—­æ¸¸æ ‡  </span>    <span class="token keyword">close</span> cur<span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">--è¾“å‡ºç»“æœ  </span>    <span class="token keyword">select</span> total<span class="token punctuation">;</span>  <span class="token keyword">END</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">--è°ƒç”¨å­˜å‚¨è¿‡ç¨‹  </span><span class="token keyword">call</span> StatisticStore<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </code></pre><p> fetchæ˜¯è·å–æ¸¸æ ‡å½“å‰æŒ‡å‘çš„æ•°æ®è¡Œï¼Œå¹¶å°†æŒ‡é’ˆæŒ‡å‘ä¸‹ä¸€è¡Œï¼Œå½“æ¸¸æ ‡å·²ç»æŒ‡å‘æœ€åä¸€è¡Œæ—¶ç»§ç»­æ‰§è¡Œä¼šé€ æˆæ¸¸æ ‡æº¢å‡ºã€‚<br>ä½¿ç”¨loopå¾ªç¯æ¸¸æ ‡æ—¶ï¼Œä»–æœ¬èº«æ˜¯ä¸ä¼šç›‘æ§æ˜¯å¦åˆ°æœ€åä¸€æ¡æ•°æ®äº†ï¼Œåƒä¸‹é¢ä»£ç è¿™ç§å†™æ³•ï¼Œå°±ä¼šé€ æˆæ­»å¾ªç¯ï¼›</p><pre class=" language-sql"><code class="language-sql">read_loop:loop  <span class="token keyword">fetch</span> cur <span class="token keyword">into</span> n<span class="token punctuation">,</span><span class="token number">c</span><span class="token punctuation">;</span>  <span class="token keyword">set</span> total <span class="token operator">=</span> total<span class="token operator">+</span><span class="token number">c</span><span class="token punctuation">;</span>  <span class="token keyword">end</span> loop<span class="token punctuation">;</span>  </code></pre><p>åœ¨MySqlä¸­ï¼Œé€ æˆæ¸¸æ ‡æº¢å‡ºæ—¶ä¼šå¼•å‘mysqlé¢„å®šä¹‰çš„NOT FOUNDé”™è¯¯ï¼Œæ‰€ä»¥åœ¨ä¸Šé¢ä½¿ç”¨ä¸‹é¢çš„ä»£ç æŒ‡å®šäº†å½“å¼•å‘not foundé”™è¯¯æ—¶å®šä¹‰ä¸€ä¸ªcontinue çš„äº‹ä»¶ï¼ŒæŒ‡å®šè¿™ä¸ªäº‹ä»¶å‘ç”Ÿæ—¶ä¿®æ”¹doneå˜é‡çš„å€¼ã€‚</p><pre class=" language-sql"><code class="language-sql"><span class="token keyword">declare</span> <span class="token keyword">continue</span> <span class="token keyword">HANDLER</span> <span class="token keyword">for</span> <span class="token operator">not</span> found <span class="token keyword">set</span> done <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>  </code></pre><p>æ‰€ä»¥åœ¨å¾ªç¯æ—¶åŠ ä¸Šäº†ä¸‹é¢è¿™å¥ä»£ç ï¼š</p><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">--åˆ¤æ–­æ¸¸æ ‡çš„å¾ªç¯æ˜¯å¦ç»“æŸ  </span><span class="token keyword">if</span> done <span class="token keyword">then</span>      leave read_loop<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">--è·³å‡ºæ¸¸æ ‡å¾ªç¯  </span><span class="token keyword">end</span> <span class="token keyword">if</span><span class="token punctuation">;</span>  </code></pre><p>å¦‚æœdoneçš„å€¼æ˜¯trueï¼Œå°±ç»“æŸå¾ªç¯ã€‚ç»§ç»­æ‰§è¡Œä¸‹é¢çš„ä»£ç </p><p>ä½¿ç”¨æ–¹å¼</p><p>æ¸¸æ ‡æœ‰ä¸‰ç§ä½¿ç”¨æ–¹å¼ï¼š<br>ç¬¬ä¸€ç§å°±æ˜¯ä¸Šé¢çš„å®ç°ï¼Œä½¿ç”¨loopå¾ªç¯ï¼›<br>ç¬¬äºŒç§æ–¹å¼å¦‚ä¸‹ï¼Œä½¿ç”¨whileå¾ªç¯ï¼š</p><pre class=" language-sql"><code class="language-sql"><span class="token keyword">drop</span> <span class="token keyword">procedure</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> StatisticStore1<span class="token punctuation">;</span>  <span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> StatisticStore1<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token keyword">BEGIN</span>      <span class="token keyword">declare</span> <span class="token number">c</span> <span class="token keyword">int</span><span class="token punctuation">;</span>      <span class="token keyword">declare</span> n <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">declare</span> total <span class="token keyword">int</span> <span class="token keyword">default</span> <span class="token number">0</span><span class="token punctuation">;</span>      <span class="token keyword">declare</span> done <span class="token keyword">int</span> <span class="token keyword">default</span> <span class="token boolean">false</span><span class="token punctuation">;</span>      <span class="token keyword">declare</span> cur <span class="token keyword">cursor</span> <span class="token keyword">for</span> <span class="token keyword">select</span> name<span class="token punctuation">,</span>count <span class="token keyword">from</span> store <span class="token keyword">where</span> name <span class="token operator">=</span> <span class="token string">'iphone'</span><span class="token punctuation">;</span>      <span class="token keyword">declare</span> <span class="token keyword">continue</span> <span class="token keyword">HANDLER</span> <span class="token keyword">for</span> <span class="token operator">not</span> found <span class="token keyword">set</span> done <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>      <span class="token keyword">set</span> total <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>      <span class="token keyword">open</span> cur<span class="token punctuation">;</span>      <span class="token keyword">fetch</span> cur <span class="token keyword">into</span> n<span class="token punctuation">,</span><span class="token number">c</span><span class="token punctuation">;</span>      <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">not</span> done<span class="token punctuation">)</span> <span class="token keyword">do</span>          <span class="token keyword">set</span> total <span class="token operator">=</span> total <span class="token operator">+</span> <span class="token number">c</span><span class="token punctuation">;</span>          <span class="token keyword">fetch</span> cur <span class="token keyword">into</span> n<span class="token punctuation">,</span><span class="token number">c</span><span class="token punctuation">;</span>      <span class="token keyword">end</span> <span class="token keyword">while</span><span class="token punctuation">;</span>      <span class="token keyword">close</span> cur<span class="token punctuation">;</span>      <span class="token keyword">select</span> total<span class="token punctuation">;</span>  <span class="token keyword">END</span><span class="token punctuation">;</span>  <span class="token keyword">call</span> StatisticStore1<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </code></pre><p>ç¬¬ä¸‰ç§æ–¹å¼æ˜¯ä½¿ç”¨repeatæ‰§è¡Œï¼š</p><pre class=" language-sql"><code class="language-sql"><span class="token keyword">drop</span> <span class="token keyword">procedure</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> StatisticStore2<span class="token punctuation">;</span>  <span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> StatisticStore2<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token keyword">BEGIN</span>      <span class="token keyword">declare</span> <span class="token number">c</span> <span class="token keyword">int</span><span class="token punctuation">;</span>      <span class="token keyword">declare</span> n <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">declare</span> total <span class="token keyword">int</span> <span class="token keyword">default</span> <span class="token number">0</span><span class="token punctuation">;</span>      <span class="token keyword">declare</span> done <span class="token keyword">int</span> <span class="token keyword">default</span> <span class="token boolean">false</span><span class="token punctuation">;</span>      <span class="token keyword">declare</span> cur <span class="token keyword">cursor</span> <span class="token keyword">for</span> <span class="token keyword">select</span> name<span class="token punctuation">,</span>count <span class="token keyword">from</span> store <span class="token keyword">where</span> name <span class="token operator">=</span> <span class="token string">'iphone'</span><span class="token punctuation">;</span>      <span class="token keyword">declare</span> <span class="token keyword">continue</span> <span class="token keyword">HANDLER</span> <span class="token keyword">for</span> <span class="token operator">not</span> found <span class="token keyword">set</span> done <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>      <span class="token keyword">set</span> total <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>      <span class="token keyword">open</span> cur<span class="token punctuation">;</span>      repeat      <span class="token keyword">fetch</span> cur <span class="token keyword">into</span> n<span class="token punctuation">,</span><span class="token number">c</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token operator">not</span> done <span class="token keyword">then</span>          <span class="token keyword">set</span> total <span class="token operator">=</span> total <span class="token operator">+</span> <span class="token number">c</span><span class="token punctuation">;</span>      <span class="token keyword">end</span> <span class="token keyword">if</span><span class="token punctuation">;</span>      until done <span class="token keyword">end</span> repeat<span class="token punctuation">;</span>      <span class="token keyword">close</span> cur<span class="token punctuation">;</span>      <span class="token keyword">select</span> total<span class="token punctuation">;</span>  <span class="token keyword">END</span><span class="token punctuation">;</span>  <span class="token keyword">call</span> StatisticStore2<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h5 id="æ¸¸æ ‡åµŒå¥—"><a href="#æ¸¸æ ‡åµŒå¥—" class="headerlink" title="æ¸¸æ ‡åµŒå¥—"></a>æ¸¸æ ‡åµŒå¥—</h5><p>åœ¨mysqlä¸­ï¼Œæ¯ä¸ªbegin end å—éƒ½æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„scopeåŒºåŸŸï¼Œç”±äºMySqlä¸­åŒä¸€ä¸ªerrorçš„äº‹ä»¶åªèƒ½å®šä¹‰ä¸€æ¬¡ï¼Œå¦‚æœå¤šå®šä¹‰çš„è¯åœ¨ç¼–è¯‘æ—¶ä¼šæç¤ºDuplicate handler declared in the same blockã€‚</p><pre class=" language-sql"><code class="language-sql"><span class="token keyword">drop</span> <span class="token keyword">procedure</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> StatisticStore3<span class="token punctuation">;</span>  <span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> StatisticStore3<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token keyword">BEGIN</span>      <span class="token keyword">declare</span> _n <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">declare</span> done <span class="token keyword">int</span> <span class="token keyword">default</span> <span class="token boolean">false</span><span class="token punctuation">;</span>      <span class="token keyword">declare</span> cur <span class="token keyword">cursor</span> <span class="token keyword">for</span> <span class="token keyword">select</span> name <span class="token keyword">from</span> store <span class="token keyword">group</span> <span class="token keyword">by</span> name<span class="token punctuation">;</span>      <span class="token keyword">declare</span> <span class="token keyword">continue</span> <span class="token keyword">HANDLER</span> <span class="token keyword">for</span> <span class="token operator">not</span> found <span class="token keyword">set</span> done <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>      <span class="token keyword">open</span> cur<span class="token punctuation">;</span>      read_loop:loop      <span class="token keyword">fetch</span> cur <span class="token keyword">into</span> _n<span class="token punctuation">;</span>      <span class="token keyword">if</span> done <span class="token keyword">then</span>          leave read_loop<span class="token punctuation">;</span>      <span class="token keyword">end</span> <span class="token keyword">if</span><span class="token punctuation">;</span>      <span class="token keyword">begin</span>          <span class="token keyword">declare</span> <span class="token number">c</span> <span class="token keyword">int</span><span class="token punctuation">;</span>          <span class="token keyword">declare</span> n <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token keyword">declare</span> total <span class="token keyword">int</span> <span class="token keyword">default</span> <span class="token number">0</span><span class="token punctuation">;</span>          <span class="token keyword">declare</span> done <span class="token keyword">int</span> <span class="token keyword">default</span> <span class="token boolean">false</span><span class="token punctuation">;</span>          <span class="token keyword">declare</span> cur <span class="token keyword">cursor</span> <span class="token keyword">for</span> <span class="token keyword">select</span> name<span class="token punctuation">,</span>count <span class="token keyword">from</span> store <span class="token keyword">where</span> name <span class="token operator">=</span> <span class="token string">'iphone'</span><span class="token punctuation">;</span>          <span class="token keyword">declare</span> <span class="token keyword">continue</span> <span class="token keyword">HANDLER</span> <span class="token keyword">for</span> <span class="token operator">not</span> found <span class="token keyword">set</span> done <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>          <span class="token keyword">set</span> total <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>          <span class="token keyword">open</span> cur<span class="token punctuation">;</span>          iphone_loop:loop          <span class="token keyword">fetch</span> cur <span class="token keyword">into</span> n<span class="token punctuation">,</span><span class="token number">c</span><span class="token punctuation">;</span>          <span class="token keyword">if</span> done <span class="token keyword">then</span>              leave iphone_loop<span class="token punctuation">;</span>          <span class="token keyword">end</span> <span class="token keyword">if</span><span class="token punctuation">;</span>          <span class="token keyword">set</span> total <span class="token operator">=</span> total <span class="token operator">+</span> <span class="token number">c</span><span class="token punctuation">;</span>          <span class="token keyword">end</span> loop<span class="token punctuation">;</span>          <span class="token keyword">close</span> cur<span class="token punctuation">;</span>          <span class="token keyword">select</span> _n<span class="token punctuation">,</span>n<span class="token punctuation">,</span>total<span class="token punctuation">;</span>      <span class="token keyword">end</span><span class="token punctuation">;</span>      <span class="token keyword">begin</span>              <span class="token keyword">declare</span> <span class="token number">c</span> <span class="token keyword">int</span><span class="token punctuation">;</span>              <span class="token keyword">declare</span> n <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token keyword">declare</span> total <span class="token keyword">int</span> <span class="token keyword">default</span> <span class="token number">0</span><span class="token punctuation">;</span>              <span class="token keyword">declare</span> done <span class="token keyword">int</span> <span class="token keyword">default</span> <span class="token boolean">false</span><span class="token punctuation">;</span>              <span class="token keyword">declare</span> cur <span class="token keyword">cursor</span> <span class="token keyword">for</span> <span class="token keyword">select</span> name<span class="token punctuation">,</span>count <span class="token keyword">from</span> store <span class="token keyword">where</span> name <span class="token operator">=</span> <span class="token string">'android'</span><span class="token punctuation">;</span>              <span class="token keyword">declare</span> <span class="token keyword">continue</span> <span class="token keyword">HANDLER</span> <span class="token keyword">for</span> <span class="token operator">not</span> found <span class="token keyword">set</span> done <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>              <span class="token keyword">set</span> total <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>              <span class="token keyword">open</span> cur<span class="token punctuation">;</span>              android_loop:loop              <span class="token keyword">fetch</span> cur <span class="token keyword">into</span> n<span class="token punctuation">,</span><span class="token number">c</span><span class="token punctuation">;</span>              <span class="token keyword">if</span> done <span class="token keyword">then</span>                  leave android_loop<span class="token punctuation">;</span>              <span class="token keyword">end</span> <span class="token keyword">if</span><span class="token punctuation">;</span>              <span class="token keyword">set</span> total <span class="token operator">=</span> total <span class="token operator">+</span> <span class="token number">c</span><span class="token punctuation">;</span>              <span class="token keyword">end</span> loop<span class="token punctuation">;</span>              <span class="token keyword">close</span> cur<span class="token punctuation">;</span>          <span class="token keyword">select</span> _n<span class="token punctuation">,</span>n<span class="token punctuation">,</span>total<span class="token punctuation">;</span>      <span class="token keyword">end</span><span class="token punctuation">;</span>      <span class="token keyword">begin</span>      <span class="token keyword">end</span><span class="token punctuation">;</span>      <span class="token keyword">end</span> loop<span class="token punctuation">;</span>      <span class="token keyword">close</span> cur<span class="token punctuation">;</span>  <span class="token keyword">END</span><span class="token punctuation">;</span>  <span class="token keyword">call</span> StatisticStore3<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </code></pre><p>ä¸Šé¢å°±æ˜¯å®ç°ä¸€ä¸ªåµŒå¥—å¾ªç¯ï¼Œå½“ç„¶è¿™ä¸ªä¾‹å­æ¯”è¾ƒç‰µå¼ºã€‚å‡‘åˆçœ‹çœ‹å°±è¡Œã€‚</p><h5 id="åŠ¨æ€SQL"><a href="#åŠ¨æ€SQL" class="headerlink" title="åŠ¨æ€SQL"></a>åŠ¨æ€SQL</h5><p>Mysql æ”¯æŒåŠ¨æ€SQLçš„åŠŸèƒ½</p><pre class=" language-sql"><code class="language-sql"><span class="token keyword">set</span> <span class="token variable">@sqlStr</span><span class="token operator">=</span><span class="token string">'select * from table where condition1 = ?'</span><span class="token punctuation">;</span>  prepare s1 <span class="token keyword">for</span> <span class="token variable">@sqlStr</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">--å¦‚æœæœ‰å¤šä¸ªå‚æ•°ç”¨é€—å·åˆ†éš”  </span><span class="token keyword">execute</span> s1 <span class="token keyword">using</span> <span class="token variable">@condition1</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">--æ‰‹å·¥é‡Šæ”¾ï¼Œæˆ–è€…æ˜¯ connection å…³é—­æ—¶ï¼Œ server è‡ªåŠ¨å›æ”¶  </span><span class="token keyword">deallocate</span> prepare s1<span class="token punctuation">;</span>  </code></pre>]]></content>
      
      
      <categories>
          
          <category> SQL </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MySQL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Vueä¹‹å…¥é—¨ç¯‡_001</title>
      <link href="2020/05/31/devops/vue-ru-men-zhi-001/"/>
      <url>2020/05/31/devops/vue-ru-men-zhi-001/</url>
      
        <content type="html"><![CDATA[<h4 id="æ–‡æ¡£"><a href="#æ–‡æ¡£" class="headerlink" title="æ–‡æ¡£"></a>æ–‡æ¡£</h4><p><a href="https://cli.vuejs.org/zh/" target="_blank" rel="noopener">https://cli.vuejs.org/zh/</a></p><p><strong>ä»¥æ–‡æ¡£ä¸ºä¸»</strong></p><h5 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h5><p><a href="https://cli.vuejs.org/zh/guide/installation.html" target="_blank" rel="noopener">https://cli.vuejs.org/zh/guide/installation.html</a></p><h6 id="1-å¼€å§‹"><a href="#1-å¼€å§‹" class="headerlink" title="1. å¼€å§‹"></a>1. å¼€å§‹</h6><blockquote><p>1ã€æ‰“å¼€ç»ˆç«¯æ‰§è¡Œ npm install -g @vue/cli</p><p>æ¥ä¸‹æ¥å¯ä»¥ç”¨vue -V çœ‹ç‰ˆæœ¬ï¼Œæˆ–where vue çœ‹ä¸‹è£…åˆ°å“ªäº†</p></blockquote><h6 id="2-åˆ›å»ºé¡¹ç›®"><a href="#2-åˆ›å»ºé¡¹ç›®" class="headerlink" title="2. åˆ›å»ºé¡¹ç›®"></a>2. åˆ›å»ºé¡¹ç›®</h6><p><a href="https://cli.vuejs.org/zh/guide/creating-a-project.html#vue-create" target="_blank" rel="noopener">https://cli.vuejs.org/zh/guide/creating-a-project.html#vue-create</a></p><p>åœ¨ä½ çš„å½“å‰æ–‡ä»¶å¤¹ä¸‹æ‰§è¡Œ</p><pre><code>vue create myvue </code></pre><p>1ã€å…·ä½“çœ‹æ–‡æ¡£æ“ä½œï¼ˆä½¿ç”¨é»˜è®¤é€‰é¡¹ï¼‰</p><p>2ã€åˆ›å»ºå¥½åï¼Œä¼šå‡ºç°ä¸€ä¸ªmyvueæ–‡ä»¶å¤¹ï¼Œç„¶åç”¨webstormæ‰“å¼€å®ƒ</p><h5 id="è¿è¡Œå’Œé…ç½®"><a href="#è¿è¡Œå’Œé…ç½®" class="headerlink" title="è¿è¡Œå’Œé…ç½®"></a>è¿è¡Œå’Œé…ç½®</h5><blockquote><ol><li><p>é¦–å…ˆè¿è¡Œ<br>åœ¨å½“å‰é¡¹ç›®ç›®å½•ä¸‹æ‰§è¡Œ npm run serve</p></li><li><p>é»˜è®¤ä¼šå¯åŠ¨webpack â€“devserver(ä»…ä»…å¼€å‘ä½¿ç”¨),é»˜è®¤ç«¯å£æ˜¯ 8080</p></li></ol></blockquote><h5 id="é…ç½®"><a href="#é…ç½®" class="headerlink" title="é…ç½®"></a>é…ç½®</h5><p>è¿›å…¥<br><a href="https://cli.vuejs.org/zh/config/#vue-config-js" target="_blank" rel="noopener">https://cli.vuejs.org/zh/config/#vue-config-js</a></p><h6 id="åˆ›å»º"><a href="#åˆ›å»º" class="headerlink" title="åˆ›å»º"></a>åˆ›å»º</h6><p>vue.config.js  ï¼ˆæ³¨æ„å’Œpackage.jsonåŒçº§ã€åŒçº§ã€åŒçº§ï¼‰</p><p>å†™å…¥å¦‚ä¸‹å†…å®¹</p><pre class=" language-vue"><code class="language-vue">module.exports = { devServer: {    port: 3000  }}</code></pre><p>æˆ–è€…çœ‹<br><a href="https://cn.vuejs.org/v2/api/#%E5%AE%9E%E4%BE%8B%E5%B1%9E%E6%80%A7" target="_blank" rel="noopener">https://cn.vuejs.org/v2/api/#%E5%AE%9E%E4%BE%8B%E5%B1%9E%E6%80%A7</a></p><pre class=" language-vue"><code class="language-vue"> new Vue({        data:{name:"lisi"}    }).$mount('#app');</code></pre><h6 id="ä½¿ç”¨template"><a href="#ä½¿ç”¨template" class="headerlink" title="ä½¿ç”¨template"></a>ä½¿ç”¨template</h6><pre class=" language-vue"><code class="language-vue">new Vue({             data:{                 name:"aa"             },             template:"<h1>{{name}}</h1>"     }     ).$mount('#app');</code></pre><h6 id="ä½¿ç”¨æ¸²æŸ“å‡½æ•°"><a href="#ä½¿ç”¨æ¸²æŸ“å‡½æ•°" class="headerlink" title="ä½¿ç”¨æ¸²æŸ“å‡½æ•°"></a>ä½¿ç”¨æ¸²æŸ“å‡½æ•°</h6><pre class=" language-vue"><code class="language-vue">new Vue({             data:{                 name:"aa"             },             template:"<h1>{{name}}</h1>"     }     ).$mount('#app');å·²åŠnew Vue({             data:{                 name:"lisi"             },             render(c){                 return c("h1",{style:{color:'red'}},this.name)             }     }     ).$mount('#app');</code></pre><h5 id="è·¯ç”±å…¥é—¨"><a href="#è·¯ç”±å…¥é—¨" class="headerlink" title="è·¯ç”±å…¥é—¨"></a>è·¯ç”±å…¥é—¨</h5><h6 id="1ã€å®‰è£…"><a href="#1ã€å®‰è£…" class="headerlink" title="1ã€å®‰è£…"></a>1ã€å®‰è£…</h6><p><a href="https://router.vuejs.org/zh/installation.html" target="_blank" rel="noopener">https://router.vuejs.org/zh/installation.html</a></p><h6 id="2ã€ä½¿ç”¨å¼•å¯¼"><a href="#2ã€ä½¿ç”¨å¼•å¯¼" class="headerlink" title="2ã€ä½¿ç”¨å¼•å¯¼"></a>2ã€ä½¿ç”¨å¼•å¯¼</h6><p><a href="https://router.vuejs.org/zh/guide/#html" target="_blank" rel="noopener">https://router.vuejs.org/zh/guide/#html</a></p><p>åœ¨é¡¹ç›®ç›®å½•ä¸‹æ‰§è¡Œ</p><pre class=" language-vue"><code class="language-vue">npm install vue-router</code></pre><h5 id="iviewæ–‡æ¡£"><a href="#iviewæ–‡æ¡£" class="headerlink" title="iviewæ–‡æ¡£"></a>iviewæ–‡æ¡£</h5><p><a href="http://iview.talkingdata.com/#/components/guide/start" target="_blank" rel="noopener">http://iview.talkingdata.com/#/components/guide/start</a></p><pre class=" language-shell"><code class="language-shell">é¦–å…ˆ æä¸€ä¸ª æ–‡ä»¶å¤¹ ï¼Œæ‰§è¡Œ 1ã€vue create myui 2ã€ç”¨webstorm æ‰“å¼€è¿™ä¸ªæ–‡ä»¶å¤¹3ã€npm install iview --save  å®‰è£…iviewæ¡†æ¶4 ã€ npm install --save vue-router  å®‰è£…vueè·¯ç”±</code></pre>]]></content>
      
      
      <categories>
          
          <category> DevOps </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Vue </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>python-fabric</title>
      <link href="2020/05/31/devops/python-zhi-fabric-mo-kuai/"/>
      <url>2020/05/31/devops/python-zhi-fabric-mo-kuai/</url>
      
        <content type="html"><![CDATA[<h3 id="python-ä¹‹-fabric-æ¨¡å—"><a href="#python-ä¹‹-fabric-æ¨¡å—" class="headerlink" title="python ä¹‹ fabric æ¨¡å—"></a>python ä¹‹ fabric æ¨¡å—</h3><p>Fabric æ˜¯ä¸€ä¸ªç”¨ Python å¼€å‘çš„éƒ¨ç½²å·¥å…·ï¼Œæœ€å¤§ç‰¹ç‚¹æ˜¯ä¸ç”¨ç™»å½•è¿œç¨‹æœåŠ¡å™¨ï¼Œåœ¨æœ¬åœ°è¿è¡Œè¿œç¨‹å‘½ä»¤ï¼Œå‡ è¡Œ Python è„šæœ¬å°±å¯ä»¥è½»æ¾éƒ¨ç½²ã€‚</p><pre><code># doc http://docs.fabfile.org/en/2.5/getting-started.html# pip install fabric -i http://mirrors.aliyun.com/pypi/simple/</code></pre><h5 id="Gç«™éƒ¨ç½²è„šæœ¬-å‚è€ƒ-ç¤ºèŒƒ"><a href="#Gç«™éƒ¨ç½²è„šæœ¬-å‚è€ƒ-ç¤ºèŒƒ" class="headerlink" title="Gç«™éƒ¨ç½²è„šæœ¬ å‚è€ƒ ç¤ºèŒƒ"></a>Gç«™éƒ¨ç½²è„šæœ¬ å‚è€ƒ ç¤ºèŒƒ</h5><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> fabric <span class="token keyword">import</span> Connection<span class="token punctuation">,</span> task<span class="token keyword">from</span> fabric<span class="token punctuation">.</span>api <span class="token keyword">import</span> env<span class="token punctuation">,</span>hosts<span class="token punctuation">,</span>run<span class="token punctuation">,</span>execute@task<span class="token keyword">def</span> <span class="token function">deploy</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">with</span> Connection<span class="token punctuation">(</span><span class="token string">'root@x.x.x.x'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> c<span class="token punctuation">:</span>        c<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token string">"rm -rf giligili"</span><span class="token punctuation">)</span>        c<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token string">"git clone https://github.com/bydmm/giligili.git"</span><span class="token punctuation">,</span> pty<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>        c<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token string">"docker-compose.yml"</span><span class="token punctuation">,</span> <span class="token string">"giligili/docker-compose.yml"</span><span class="token punctuation">)</span>        c<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token string">"cd giligili &amp;&amp; docker-compose build &amp;&amp; docker-compose rm -fsv &amp;&amp; docker-compose up --build -d"</span><span class="token punctuation">,</span> pty<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>        c<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token string">"sleep 15 &amp;&amp; docker logs -f gili-api"</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true"># doc http://docs.fabfile.org/en/2.5/getting-started.html</span><span class="token comment" spellcheck="true"># apt install python-pip</span><span class="token comment" spellcheck="true"># pip install fabric -i http://mirrors.aliyun.com/pypi/simple/</span><span class="token comment" spellcheck="true"># fab deploy</span></code></pre><p>ä»¥ä¸Šå®šä¹‰äº†packå’Œdeployä¸¤ä¸ªä»»åŠ¡ï¼Œå¦‚æœæˆ‘ä»¬ç”¨Fabricéƒ¨ç½²ï¼Œåªéœ€ç®€å•åœ°è¾“å…¥ä¸¤æ¡å‘½ä»¤ï¼š</p><pre><code>$ fab pack$ fab deploy</code></pre><p>Fabricæä¾›å‡ ä¸ªç®€å•çš„APIæ¥å®Œæˆæ‰€æœ‰çš„éƒ¨ç½²ï¼Œæœ€å¸¸ç”¨çš„æ˜¯local()å’Œrun()ï¼Œåˆ†åˆ«åœ¨æœ¬åœ°å’Œè¿œç¨‹æ‰§è¡Œå‘½ä»¤ï¼Œput()å¯ä»¥æŠŠæœ¬åœ°æ–‡ä»¶ä¸Šä¼ åˆ°è¿œç¨‹ï¼Œå½“éœ€è¦åœ¨è¿œç¨‹æŒ‡å®šå½“å‰ç›®å½•æ—¶ï¼Œåªéœ€ç”¨with cd(â€˜/path/to/dir/â€˜):å³å¯ã€‚</p><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œå½“å‘½ä»¤æ‰§è¡Œå¤±è´¥æ—¶ï¼ŒFabricä¼šåœæ­¢æ‰§è¡Œåç»­å‘½ä»¤ã€‚æœ‰æ—¶ï¼Œæˆ‘ä»¬å…è®¸å¿½ç•¥å¤±è´¥çš„å‘½ä»¤ç»§ç»­æ‰§è¡Œï¼Œæ¯”å¦‚run(â€˜rm /tmp/abcâ€™)åœ¨æ–‡ä»¶ä¸å­˜åœ¨çš„æ—¶å€™æœ‰å¯èƒ½å¤±è´¥ï¼Œè¿™æ—¶å¯ä»¥ç”¨with settings(warn_only=True):æ‰§è¡Œå‘½ä»¤ï¼Œè¿™æ ·Fabricåªä¼šæ‰“å‡ºè­¦å‘Šä¿¡æ¯è€Œä¸ä¼šä¸­æ–­æ‰§è¡Œã€‚</p><p>Fabricæ˜¯å¦‚ä½•åœ¨è¿œç¨‹æ‰§è¡Œå‘½ä»¤çš„å‘¢ï¼Ÿå…¶å®Fabricæ‰€æœ‰æ“ä½œéƒ½æ˜¯åŸºäºSSHæ‰§è¡Œçš„ï¼Œå¿…è¦æ—¶å®ƒä¼šæç¤ºè¾“å…¥å£ä»¤ï¼Œæ‰€ä»¥éå¸¸å®‰å…¨ã€‚æ›´å¥½çš„åŠæ³•æ˜¯åœ¨æŒ‡å®šçš„éƒ¨ç½²æœåŠ¡å™¨ä¸Šç”¨è¯ä¹¦é…ç½®æ— å¯†ç çš„sshè¿æ¥ã€‚</p><p>å¦‚æœæ˜¯åŸºäºå›¢é˜Ÿå¼€å‘ï¼Œå¯ä»¥è®©Fabricåˆ©ç”¨ç‰ˆæœ¬åº“è‡ªåŠ¨æ£€å‡ºä»£ç ï¼Œè‡ªåŠ¨æ‰§è¡Œæµ‹è¯•ã€æ‰“åŒ…ã€éƒ¨ç½²çš„ä»»åŠ¡ã€‚ç”±äºFabricè¿è¡Œçš„å‘½ä»¤éƒ½æ˜¯åŸºæœ¬çš„Linuxå‘½ä»¤ï¼Œæ‰€ä»¥æ ¹æœ¬ä¸éœ€è¦ç”¨Fabricæœ¬èº«æ¥æ‰©å±•ï¼Œä¼šæ•²Linuxå‘½ä»¤å°±èƒ½ç”¨Fabricéƒ¨ç½²ã€‚</p><p>åˆ©ç”¨Fabricéƒ¨ç½²Pythonã€Rubyã€PHPè¿™æ ·çš„éç¼–è¯‘å‹ç½‘ç«™åº”ç”¨éå¸¸æ–¹ä¾¿ï¼Œè€Œå¯¹äºç¼–è¯‘å‹çš„Javaã€C#ç­‰å°±éº»çƒ¦äº†ï¼Œç¼–è¯‘æœ¬èº«å°±æ˜¯ä¸€ä¸ªæå…¶å¤æ‚çš„å¤§å·¥ç¨‹ï¼Œéœ€è¦ä¾èµ–ç‰¹å®šå·¥å…·æˆ–è€…IDEï¼Œå¾ˆéš¾åšåˆ°è‡ªåŠ¨åŒ–ã€‚</p><h4 id="fabå‘½ä»¤å¸¸ç”¨å‚æ•°"><a href="#fabå‘½ä»¤å¸¸ç”¨å‚æ•°" class="headerlink" title="fabå‘½ä»¤å¸¸ç”¨å‚æ•°"></a><strong>fabå‘½ä»¤å¸¸ç”¨å‚æ•°</strong></h4><pre class=" language-shell"><code class="language-shell"># fab --help   æŸ¥çœ‹å¸®åŠ©## å¸¸ç”¨å‚æ•°-l æ˜¾ç¤ºå®šä¹‰å¥½çš„ä»»åŠ¡å‡½æ•°å-f æŒ‡å®šfabå…¥å£æ–‡ä»¶ï¼Œé»˜è®¤å…¥å£æ–‡ä»¶åä¸ºfabfile.py.. å³æŒ‡å®šfabfileæ–‡ä»¶-g æŒ‡å®šç½‘å…³ï¼ˆä¸­è½¬ï¼‰è®¾å¤‡ï¼Œå³HOSTé€—å·åˆ†éš”è¦æ“ä½œçš„ä¸»æœº, æ¯”å¦‚å ¡å’æœºç¯å¢ƒï¼Œå¡«å†™å ¡å’æœºIPå³å¯.-H æŒ‡å®šç›®æ ‡ä¸»æœºï¼Œå¤šå°ä¸»æœºç”¨â€˜,â€™å·åˆ†éš”-p è¿œç¨‹è´¦å·çš„å¯†ç ï¼Œfabæ‰§è¡Œæ—¶é»˜è®¤ä½¿ç”¨rootè´¦æˆ·-P ä»¥å¼‚æ­¥å¹¶è¡Œæ–¹å¼è¿è¡Œå¤šä¸»æœºä»»åŠ¡ï¼Œé»˜è®¤ä¸ºä¸²è¡Œè¿è¡Œ-R æŒ‡å®šroleï¼ˆè§’è‰²ï¼‰ï¼Œä»¥è§’è‰²ååŒºåˆ†ä¸åŒä¸šåŠ¡ç»„è®¾å¤‡-t è®¾ç½®è®¾å¤‡è¿æ¥è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰-T è®¾ç½®è¿œç¨‹ä¸»æœºå‘½ä»¤æ‰§è¡Œè¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰-w å½“å‘½ä»¤æ‰§è¡Œå¤±è´¥ï¼Œå‘å‡ºè­¦å‘Šï¼Œè€Œéé»˜è®¤ä¸­æ­¢ä»»åŠ¡ã€‚</code></pre><pre class=" language-shell"><code class="language-shell">å…¶ä»–å‚æ•°:--set=KEY=VALUE,...   é€—å·åˆ†éš”ï¼Œè®¾ç½®ç¯å¢ƒå˜é‡--shortlist       ç®€çŸ­æ‰“å°å¯ç”¨å‘½ä»¤-c PATH         æŒ‡å®šæœ¬åœ°é…ç½®æ–‡ä»¶-D           ä¸åŠ è½½ç”¨æˆ·known_hostsæ–‡ä»¶-i PATH         æŒ‡å®šç§é’¥æ–‡ä»¶-k           ä¸åŠ è½½æ¥è‡ª~/.``ssh``ä¸‹çš„ç§é’¥æ–‡ä»¶--port=PORT       æŒ‡å®šSSHè¿æ¥ç«¯å£-R ROLES        æ ¹æ®è§’è‰²æ“ä½œï¼Œé€—å·åˆ†éš”-s SHELL        æŒ‡å®šæ–°shellï¼Œé»˜è®¤æ˜¯``'/bin/bash -l -c'--show=LEVELS      ä»¥é€—å·åˆ†éš”çš„è¾“å‡º--ssh-config-path=PATH SSHé…ç½®æ–‡ä»¶è·¯å¾„-T N          è®¾ç½®è¿œç¨‹å‘½ä»¤è¶…æ—¶æ—¶é—´ï¼Œå•ä½ç§’-u USER         è¿æ¥è¿œç¨‹ä¸»æœºç”¨æˆ·å-x HOSTS        ä»¥é€—å·åˆ†éš”æ’é™¤ä¸»æœº-z INT         å¹¶å‘è¿›ç¨‹æ•°</code></pre><h4 id="fabfileå…¨å±€å±æ€§-envå¯¹è±¡"><a href="#fabfileå…¨å±€å±æ€§-envå¯¹è±¡" class="headerlink" title="fabfileå…¨å±€å±æ€§ (envå¯¹è±¡)"></a>fabfileå…¨å±€å±æ€§ (envå¯¹è±¡)</h4><p><img src="https://s1.ax1x.com/2020/05/31/t1Gv3F.png" alt="t1Gv3F.png"></p>]]></content>
      
      
      <categories>
          
          <category> DevOps </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è®¡åˆ’ä»»åŠ¡åŠæ—¥å¿—ç®¡ç†</title>
      <link href="2020/05/30/linux/ji-hua-ren-wu-ji-ri-zhi-guan-li/"/>
      <url>2020/05/30/linux/ji-hua-ren-wu-ji-ri-zhi-guan-li/</url>
      
        <content type="html"><![CDATA[<h4 id="å¾ªç¯è°ƒåº¦æ‰§è¡Œcron"><a href="#å¾ªç¯è°ƒåº¦æ‰§è¡Œcron" class="headerlink" title="å¾ªç¯è°ƒåº¦æ‰§è¡Œcron"></a>å¾ªç¯è°ƒåº¦æ‰§è¡Œcron</h4><h5 id="1-1ç®€ä»‹cron"><a href="#1-1ç®€ä»‹cron" class="headerlink" title="1.1ç®€ä»‹cron"></a>1.1ç®€ä»‹cron</h5><pre class=" language-reStructuredText"><code class="language-reStructuredText">    crondçš„æ¦‚å¿µå’Œcrontabæ˜¯ä¸å¯åˆ†å‰²çš„ã€‚crontabæ˜¯ä¸€ä¸ªå‘½ä»¤ï¼Œå¸¸è§äºUnixå’Œç±»Unixçš„æ“ä½œç³»ç»Ÿä¹‹ä¸­ï¼Œç”¨äºè®¾ç½®å‘¨æœŸæ€§è¢«æ‰§è¡Œçš„æŒ‡ä»¤ã€‚è¯¥å‘½ä»¤ä»æ ‡å‡†è¾“å…¥è®¾å¤‡è¯»å–æŒ‡ä»¤ï¼Œå¹¶å°†å…¶å­˜æ”¾äºâ€œcrontabâ€æ–‡ä»¶ä¸­ï¼Œä»¥ä¾›ä¹‹åè¯»å–å’Œæ‰§è¡Œ</code></pre><h5 id="1-2è®¤è¯†crondè¿›ç¨‹"><a href="#1-2è®¤è¯†crondè¿›ç¨‹" class="headerlink" title="1.2è®¤è¯†crondè¿›ç¨‹"></a>1.2è®¤è¯†crondè¿›ç¨‹</h5><pre class=" language-shell"><code class="language-shell">[root@JX01 ~]# systemctl status crondâ— crond.service - Command Scheduler   Loaded: loaded (/usr/lib/systemd/system/crond.service; enabled; vendor preset: enabled)   Active: active (running) since ä¸‰ 2018-08-01 07:03:23 CST; 17min ago Main PID: 671 (crond)   CGroup: /system.slice/crond.service           â””â”€671 /usr/sbin/crond -n8æœˆ 01 07:03:23 JX01 systemd[1]: Started Command Scheduler.8æœˆ 01 07:03:23 JX01 systemd[1]: Starting Command Scheduler...8æœˆ 01 07:03:23 JX01 crond[671]: (CRON) INFO (RANDOM_DELAY will be scaled with factor 2% if used.)8æœˆ 01 07:03:23 JX01 crond[671]: (CRON) INFO (running with inotify support)[root@JX01 ~]#[root@JX01 ~]# ps aux | grep crondroot        671  0.0  0.0 126280  1668 ?        Ss   07:03   0:00 /usr/sbin/crond -nroot       1440  0.0  0.0 112720   980 pts/0    R+   07:21   0:00 grep --color=auto crond[root@JX01 ~]#</code></pre><h5 id="1-3åˆ›å»ºè®¡åˆ’ä»»åŠ¡"><a href="#1-3åˆ›å»ºè®¡åˆ’ä»»åŠ¡" class="headerlink" title="1.3åˆ›å»ºè®¡åˆ’ä»»åŠ¡"></a>1.3åˆ›å»ºè®¡åˆ’ä»»åŠ¡</h5><pre class=" language-shell"><code class="language-shell">#è®¡åˆ’ä»»åŠ¡å­˜å‚¨çš„ä½ç½®[root@JX01 ~]# ls /var/spool/cron/root jack alice#ç®¡ç†è®¡åˆ’ä»»åŠ¡çš„å‘½ä»¤crontab:  -l     Displays the current crontab on standard output.  -r     Removes the current crontab.  -e     Edits  the current crontab using the editor specified.#è®¡åˆ’ä»»åŠ¡ä¹¦å†™çš„æ ¼å¼.---------------- minute (0 - 59)| .-------------- hour (0 - 23)| | .------------ day of month (1 - 31)| | | .---------- month (1 - 12) OR jan,feb,mar,apr ...| | | | .-------- day of week (0 - 6) (Sunday=0 or 7) OR sun,mon,tue,wed,thu,fri,sat| | | | |* * * * * command#è®¡åˆ’ä»»åŠ¡æ¡ˆä¾‹00 02 * * *    ls        //æ¯å¤©2:00æ•´00 02 1 * *    ls        //æ¯æœˆ1å·2:00æ•´00 02 14 2 * ls        //æ¯å¹´2æœˆ14å·2:00æ•´00 02 * * 7 ls        //æ¯å‘¨æ—¥2:00æ•´00 02 * 6 5 ls        //æ¯å¹´6æœˆçš„å‘¨äº”2:00æ•´ï¼ˆç‰¹æ®Šï¼‰00 02 14 * 7 ls        //æ¯æœˆ14å·2:00æ•´ æˆ–è€… æ¯å‘¨æ—¥2:00æ•´ï¼Œè¿™ä¸¤ä¸ªæ—¶é—´éƒ½æ‰§è¡Œ00 02 14 2 7 ls        //æ¯å¹´2æœˆ14å·2:00æ•´ æˆ–è€… æ¯å‘¨æ—¥2:00æ•´ï¼Œè¿™ä¸¤ä¸ªæ—¶é—´éƒ½æ‰§è¡Œ00 02 * * * ls        //æ¯å¤©2:00æ•´* 02 * * * ls        //æ¯å¤©2:00ä¸­çš„æ¯ä¸€åˆ†é’Ÿ* * * * * ls        //æ¯åˆ†é’Ÿæ‰§è¡Œls* * 14 2 * ls        //2æœˆ14å·çš„æ¯åˆ†é’Ÿ 1440åˆ†é’Ÿ*/5 * * * * ls        //æ¯éš”5åˆ†é’Ÿ00 02 1,5,8 * * ls    //æ¯æœˆ1,5,8å·çš„2:00æ•´00 02 1-8 * * ls    //æ¯æœˆ1åˆ°8å·çš„2:00æ•´00 02 * 1-10 * ls#æµ‹è¯•è®¡åˆ’ä»»åŠ¡çš„æ‰§è¡Œæ•ˆæœ1 ç¼–å†™æ‰§è¡Œè„šæœ¬.vim /crontab.sh touch /root/`date +%F-%X`.txt2 ç¼–æ’ä»»åŠ¡è®¡åˆ’[root@localhost ~]# crontab -e* * 1 1 * bash /crontab.sh3 ä¿®æ”¹æ—¥æœŸæ—¶é—´ä¸º1æœˆ2æ—¥3ç‚¹4åˆ†date 01020304ä¿®æ”¹æ—¶é—´ä¸º1ç‚¹2åˆ†3ç§’date -s 01:02:034 ç›‘æ§å½“å‰ç›®å½•watch -n 0.5 'ls /root/*.txt'5 æµ‹è¯•ç›®æ ‡* * * * 1    //æ¯å‘¨1            æ¯åˆ†é’Ÿä¼šæ‰§è¡Œ* * * 1 *    //1æœˆæ¯æ—¥          æ¯åˆ†é’Ÿä¼šæ‰§è¡Œ* * * 1 1    //1æœˆçš„å‘¨1         æ¯åˆ†é’Ÿä¼šæ‰§è¡Œ* * 1 * *    //æ¯æœˆ1æ—¥          æ¯åˆ†é’Ÿä¼šæ‰§è¡Œ* * 1 * 1    //æ¯æœˆ1æ—¥å’Œæ¯æœˆå‘¨1 æ¯åˆ†é’Ÿä¼šæ‰§è¡Œ* * 1 1 *    //1æœˆ1æ—¥           æ¯åˆ†é’Ÿä¼šæ‰§è¡Œ* * 1 1 1    //1æœˆ1æ—¥å’Œ1æœˆçš„å‘¨1 æ¯åˆ†é’Ÿéƒ½ä¼šæ‰§è¡Œ</code></pre><h4 id="æ—¥å¿—ç®¡ç†"><a href="#æ—¥å¿—ç®¡ç†" class="headerlink" title="æ—¥å¿—ç®¡ç†"></a>æ—¥å¿—ç®¡ç†</h4><pre><code>    æ—¥å¿—ï¼šåœ¨ç°ä»£ç¤¾ä¼šé‡Œ,ä¸ºäº†ç»´æŠ¤è‡ªèº«ç³»ç»Ÿèµ„æºçš„è¿è¡ŒçŠ¶å†µ,è®¡ç®—æœºç³»ç»Ÿä¸€èˆ¬éƒ½ä¼šæœ‰ç›¸åº”çš„æ—¥å¿—è®°å½•ç³»ç»Ÿæœ‰å…³æ—¥å¸¸äº‹ä»¶æˆ–è€…è¯¯æ“ä½œè­¦æŠ¥çš„æ—¥æœŸåŠæ—¶é—´æˆ³ä¿¡æ¯ã€‚è¿™äº›æ—¥å¿—ä¿¡æ¯å¯¹è®¡ç®—æœºçŠ¯ç½ªè°ƒæŸ¥äººå‘˜éå¸¸æœ‰ç”¨,ä½†è®¡ç®—æœºæ—¥è®°æ˜¯æŒ‰æ­£å¸¸å·¥ä½œçŠ¶æ€è®°å½•çš„,æ‰€ä»¥å†—ä½™é‡å¾ˆå¤§,å¯¹æŸ¥æ‰¾ä¸åˆ†ææœ‰ç”¨ä¿¡æ¯é€ æˆå¾ˆå¤§å›°éš¾ã€‚#Linuxç³»ç»Ÿä¸­å­˜åœ¨çš„æ—¥å¿—éƒ½åœ¨å“ªé‡Œï¼Ÿ/var/log/    # tail /var/log/messages             //ç³»ç»Ÿä¸»æ—¥å¿—æ–‡ä»¶    # tail -20 /var/log/messages    # tail -f /var/log/messages         //åŠ¨æ€æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶çš„å°¾éƒ¨    # tailf /var/log/secure                 //è®¤è¯ã€å®‰å…¨    # tail /var/log/maillog                 //è·Ÿé‚®ä»¶postfixç›¸å…³ prefix    # tail /var/log/cron                //crondã€atè¿›ç¨‹äº§ç”Ÿçš„æ—¥å¿—    # tail /var/log/dmesg                 //å’Œç³»ç»Ÿå¯åŠ¨ç›¸å…³    # tail /var/log/audit/audit.log        //ç³»ç»Ÿå®¡è®¡æ—¥å¿—    # tail /var/log/yum.log                 //yum    # tail /var/log/mysqld.log             //MySQL    # tail /var/log/xferlog             //å’Œè®¿é—®FTPæœåŠ¡å™¨ç›¸å…³    # tail  /var/log/wtmp                 //å½“å‰ç™»å½•çš„ç”¨æˆ·ï¼ˆå‘½ä»¤ï¼šwï¼‰    # tail  /var/log/btmp                 //æœ€è¿‘ç™»å½•çš„ç”¨æˆ·ï¼ˆå‘½ä»¤lastï¼‰    # tail  /var/log/lastlog            //æ‰€æœ‰ç”¨æˆ·çš„ç™»å½•æƒ…å†µï¼ˆå‘½ä»¤lastlogï¼‰#Linuxç³»ç»Ÿæ˜¯ä»€ä¹ˆè¿›ç¨‹ç¨‹åºåœ¨ç®¡ç†æ—¥å¿—ï¼Ÿrsyslog</code></pre><pre class=" language-shell"><code class="language-shell">##rsyslogrsyslogï¼šlinuxç³»ç»Ÿä¸­ç®¡ç†æ—¥å¿—çš„æœåŠ¡æ‰€äº§ç”Ÿçš„è¿›ç¨‹æ˜¯: rsyslogd -nlinuxä¸­çš„é…ç½®æ–‡ä»¶:    linuxä¸­æ‰€æœ‰çš„æœåŠ¡æˆ–è€…å·¥å…·,éƒ½æ˜¯ç”±é…ç½®æ–‡ä»¶é©±åŠ¨å·¥ä½œçš„;    Linuxä¸­çš„å·¥å…·æˆ–æœåŠ¡éƒ½æ˜¯éµå¾ªé…ç½®æ–‡ä»¶ä¸­çš„è§„åˆ™å·¥ä½œçš„;/etc/rsyslog.conf:    è¿™ä¸ªæ–‡ä»¶å®šä¹‰äº†ç³»ç»Ÿä¸­æ‰€æœ‰çš„æœåŠ¡æˆ–è€…å·¥å…·,å®ƒä»¬æ‰€äº§ç”Ÿçš„æ—¥å¿—,æ ¹æ®ç‰¹å®šçš„çº§åˆ«éœ€è¦å­˜å‚¨åœ¨ç‰¹å®šçš„ä½ç½®æ—¥å¿—ç­‰çº§:    ç­‰çº§ç”±ä½åˆ°é«˜ï¼šdebug<info<warn<Error<Fatalç³»ç»Ÿæˆ–æœåŠ¡çš„æ’é”™:    æ ¹æ®é…ç½®æ–‡ä»¶çš„å¯¹é”™æœ‰ä¸€ä¸‹ä¸¤ç§æ–¹æ¡ˆä¾›ç»™é€‰æ‹©:        1. æŸ¥çœ‹rsyslogçš„ journalctl -xe æ‰¾å‡ºæœåŠ¡æˆ–ç³»ç»Ÿçš„æŠ¥é”™ä¿¡æ¯        2. æ ¹æ®æœåŠ¡è‡ªèº«çš„æ£€æµ‹æœºåˆ¶,å»æ£€æŸ¥é…ç½®æ–‡ä»¶çš„è¯­æ³•        3. ç³»ç»Ÿå¸¸ç”¨æ’é”™æŒ‡ä»¤ journalctl -xe\\ systemctl status service.name\\ æœåŠ¡è‡ªå¸¦æ£€æµ‹å·¥å…·bash -nx    æ£€æµ‹shellè„šæœ¬çš„è¯­æ³•é—®é¢˜httpd -t    æ£€æµ‹apache webæœåŠ¡çš„é…ç½®æ–‡ä»¶è¯­æ³•é—®é¢˜nginx -t    æ£€æµ‹nginx webæœåŠ¡çš„é…ç½®æ–‡ä»¶è¯­æ³•é—®é¢˜[root@JX02 ~]# vim /etc/rsyslog.conf#### RULES ##### Log all kernel messages to the console.# Logging much else clutters up the screen.#kern.*                                                 /dev/console# Log anything (except mail) of level info or higher.# Don't log private authentication messages!*.info;mail.none;authpriv.none;cron.none                /var/log/messages# The authpriv file has restricted access.authpriv.*                                              /var/log/secure# Log all the mail messages in one place.mail.*                                                  -/var/log/maillog# Log cron stuffcron.*                                                  /var/log/cron# Everybody gets emergency messages*.emerg                                                 :omusrmsg:*# Save news errors of level crit and higher in a special file.uucp,news.crit                                          /var/log/spooler# Save boot messages also to boot.loglocal7.*                                                /var/log/boot.log</code></pre><pre class=" language-shell"><code class="language-shell">##logrotate#è®¤è¯†ä¸€ä¸‹logrotateä¸ºäº†èŠ‚çœç©ºé—´å’Œæ•´ç†æ–¹ä¾¿ï¼Œæ—¥å¿—æ–‡ä»¶ç»å¸¸éœ€è¦æŒ‰ï¼æ—¶é—´æˆ–ï¼å¤§å°ç­‰ç»´åº¦åˆ†æˆå¤šä»½ï¼Œåˆ é™¤æ—¶é—´ä¹…è¿œçš„æ—¥å¿—æ–‡ä»¶ã€‚è¿™å°±æ˜¯é€šå¸¸è¯´çš„æ—¥å¿—æ»šåŠ¨(log rotation)logrotateæœ¬èº«ä¸æ˜¯ç³»ç»Ÿå®ˆæŠ¤è¿›ç¨‹ï¼Œå®ƒæ˜¯é€šè¿‡è®¡åˆ’ä»»åŠ¡crondæ¯å¤©æ‰§è¡Œ#logrotateé…ç½®æ–‡ä»¶ï¼šä¸»æ–‡ä»¶ï¼š/etc/logrotate.conf (å†³å®šæ¯ä¸ªæ—¥å¿—æ–‡ä»¶å¦‚ä½•è½®è½¬)å­æ–‡ä»¶å¤¹ï¼š/etc/logrotate.d/*#è®¤è¯†logrotateçš„é€‰é¡¹å«ä¹‰==================å…¨å±€è®¾ç½®==================weekly                              //è½®è½¬å‘¨æœŸï¼Œä¸€å‘¨è½®è½¬rotate 4                            //ä¿ç•™4ä»½create                              //è½®è½¬ååˆ›å»ºæ–°æ–‡ä»¶dateext                             //ä½¿ç”¨æ—¥æœŸä½œä¸ºåç¼€compress                            //æ˜¯å¦å‹ç¼©include /etc/logrotate.d            //åŒ…å«è¯¥ç›®å½•ä¸‹çš„æ–‡ä»¶/var/log/wtmp {                     //å¯¹è¯¥æ—¥å¿—æ–‡ä»¶è®¾ç½®è½®è½¬çš„æ–¹æ³•    monthly                         //ä¸€ä¸ªæœˆè½®è½¬ä¸€æ¬¡    create 0664 root utmp           //è½®è½¬ååˆ›å»ºæ–°æ–‡ä»¶ï¼Œå¹¶è®¾ç½®æƒé™    minsize 1M                      //æœ€å°è¾¾åˆ°1Mæ‰è½®è½¬    rotate 1                        //ä¿ç•™ä¸€ä»½}/var/log/btmp {    missingok                       //ä¸¢å¤±ä¸æç¤º    monthly    create 0600 root utmp    rotate 1}=========================================å‚æ•°========================================compress             é€šè¿‡gzip å‹ç¼©è½¬å‚¨ä»¥åçš„æ—¥å¿—nocompress           ä¸åšgzipå‹ç¼©å¤„ç†copytruncate         ç”¨äºè¿˜åœ¨æ‰“å¼€ä¸­çš„æ—¥å¿—æ–‡ä»¶ï¼ŒæŠŠå½“å‰æ—¥å¿—å¤‡ä»½å¹¶æˆªæ–­ï¼›æ˜¯å…ˆæ‹·è´å†æ¸…ç©ºçš„æ–¹å¼ï¼Œæ‹·è´å’Œæ¸…ç©ºä¹‹é—´æœ‰ä¸€ä¸ªæ—¶é—´å·®ï¼Œå¯èƒ½ä¼šä¸¢å¤±éƒ¨åˆ†æ—¥å¿—æ•°æ®ã€‚nocopytruncate              å¤‡ä»½æ—¥å¿—æ–‡ä»¶ä¸è¿‡ä¸æˆªæ–­create mode owner group    è½®è½¬æ—¶æŒ‡å®šåˆ›å»ºæ–°æ–‡ä»¶çš„å±æ€§ï¼Œå¦‚create 0777 nobody nobodynocreate                   ä¸å»ºç«‹æ–°çš„æ—¥å¿—æ–‡ä»¶delaycompress              å’Œcompress ä¸€èµ·ä½¿ç”¨æ—¶ï¼Œè½¬å‚¨çš„æ—¥å¿—æ–‡ä»¶åˆ°ä¸‹ä¸€æ¬¡è½¬å‚¨æ—¶æ‰å‹ç¼©nodelaycompress            è¦†ç›– delaycompress é€‰é¡¹ï¼Œè½¬å‚¨åŒæ—¶å‹ç¼©missingok                  å¦‚æœæ—¥å¿—ä¸¢å¤±ï¼Œä¸æŠ¥é”™ç»§ç»­æ»šåŠ¨ä¸‹ä¸€ä¸ªæ—¥å¿—errors address             ä¸“å‚¨æ—¶çš„é”™è¯¯ä¿¡æ¯å‘é€åˆ°æŒ‡å®šçš„Email åœ°å€ifempty                    å³ä½¿æ—¥å¿—æ–‡ä»¶ä¸ºç©ºæ–‡ä»¶ä¹Ÿåšè½®è½¬ï¼Œè¿™ä¸ªæ˜¯logrotateçš„ç¼ºçœé€‰é¡¹notifempty                 å½“æ—¥å¿—æ–‡ä»¶ä¸ºç©ºæ—¶ï¼Œä¸è¿›è¡Œè½®è½¬mail address               æŠŠè½¬å‚¨çš„æ—¥å¿—æ–‡ä»¶å‘é€åˆ°æŒ‡å®šçš„E-mail åœ°å€nomail                     è½¬å‚¨æ—¶ä¸å‘é€æ—¥å¿—æ–‡ä»¶olddir directory           è½¬å‚¨åçš„æ—¥å¿—æ–‡ä»¶æ”¾å…¥æŒ‡å®šçš„ç›®å½•ï¼Œå¿…é¡»å’Œå½“å‰æ—¥å¿—æ–‡ä»¶åœ¨åŒä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿnoolddir                   è½¬å‚¨åçš„æ—¥å¿—æ–‡ä»¶å’Œå½“å‰æ—¥å¿—æ–‡ä»¶æ”¾åœ¨åŒä¸€ä¸ªç›®å½•ä¸‹sharedscriptsè¿è¡Œpostrotateè„šæœ¬ï¼Œä½œç”¨æ˜¯åœ¨æ‰€æœ‰æ—¥å¿—éƒ½è½®è½¬åç»Ÿä¸€æ‰§è¡Œä¸€æ¬¡è„šæœ¬ã€‚å¦‚æœæ²¡æœ‰é…ç½®è¿™ä¸ªï¼Œé‚£ä¹ˆæ¯ä¸ªæ—¥å¿—è½®è½¬åéƒ½ä¼šæ‰§è¡Œä¸€æ¬¡è„šæœ¬prerotate        åœ¨logrotateè½¬å‚¨ä¹‹å‰éœ€è¦æ‰§è¡Œçš„æŒ‡ä»¤ï¼Œä¾‹å¦‚ä¿®æ”¹æ–‡ä»¶çš„å±æ€§ç­‰åŠ¨ä½œï¼›å¿…é¡»ç‹¬ç«‹æˆè¡Œpostrotate       åœ¨logrotateè½¬å‚¨ä¹‹åéœ€è¦æ‰§è¡Œçš„æŒ‡ä»¤ï¼Œä¾‹å¦‚é‡æ–°å¯åŠ¨ (kill -HUP) æŸä¸ªæœåŠ¡ï¼å¿…é¡»ç‹¬ç«‹æˆè¡Œdaily                      æŒ‡å®šè½¬å‚¨å‘¨æœŸä¸ºæ¯å¤©weekly                     æŒ‡å®šè½¬å‚¨å‘¨æœŸä¸ºæ¯å‘¨monthly                    æŒ‡å®šè½¬å‚¨å‘¨æœŸä¸ºæ¯æœˆrotate count               æŒ‡å®šæ—¥å¿—æ–‡ä»¶åˆ é™¤ä¹‹å‰è½¬å‚¨çš„æ¬¡æ•°ï¼Œ0 æŒ‡æ²¡æœ‰å¤‡ä»½ï¼Œ5 æŒ‡ä¿ç•™5 ä¸ªå¤‡ä»½dateext                    ä½¿ç”¨å½“æœŸæ—¥æœŸä½œä¸ºå‘½åæ ¼å¼dateformat .%sé…åˆdateextä½¿ç”¨ï¼Œç´§è·Ÿåœ¨ä¸‹ä¸€è¡Œå‡ºç°ï¼Œå®šä¹‰æ–‡ä»¶åˆ‡å‰²åçš„æ–‡ä»¶åï¼Œå¿…é¡»é…åˆdateextä½¿ç”¨ï¼Œåªæ”¯æŒ %Y %m %d %s è¿™å››ä¸ªå‚æ•°size(æˆ–minsize) log-sizeå½“æ—¥å¿—æ–‡ä»¶åˆ°è¾¾æŒ‡å®šçš„å¤§å°æ—¶æ‰è½®è½¬ï¼Œlog-sizeèƒ½æŒ‡å®šbytes(ç¼ºçœ)åŠKB (sizek)æˆ–MB(sizem).å½“æ—¥å¿—æ–‡ä»¶ >= log-size çš„æ—¶å€™å°±è½¬å‚¨ã€‚ ä»¥ä¸‹ä¸ºåˆæ³•æ ¼å¼ï¼šï¼ˆå…¶ä»–æ ¼å¼çš„å•ä½å¤§å°å†™æ²¡æœ‰è¯•è¿‡ï¼‰size = 5 æˆ– size 5 ï¼ˆ>= 5 ä¸ªå­—èŠ‚å°±è½¬å‚¨ï¼‰size = 100k æˆ– size 100ksize = 100M æˆ– size 100M=================================================================================#æ¡ˆä¾‹ä¸€:æ™®é€šåˆ‡å‰²[root@JX02 ~]# vim  /etc/logrotate.d/yum/var/log/yum.log {missingok            //ä¸¢å¤±ä¸æ‰§è¡Œ# notifempty        //ç©ºæ–‡ä»¶ä¸è½®è½¬# size 30k            //è¾¾åˆ°30kè½®è½¬, daily or size# yearly            //æˆ–è€…ä¸€å¹´ä¸€è½®è½¬daily                //ç¼©å°å‘¨æœŸåˆ°1å¤©rotate 3            //è½®è½¬ä¿ç•™3æ¬¡create 0777 root root}[root@JX02 ~]# /usr/sbin/logrotate -f /etc/logrotate.conf        //å¼ºåˆ¶è½®è½¬æ—¥å¿—[root@JX02 ~]# ll /var/log/yum*                                    //å‘ç°æ—¥å¿—å·²ç»è¢«åˆ‡å‰²äº†#æ¡ˆä¾‹äºŒ:åˆ‡å‰²å‰åæ‰§è¡ŒåŠ¨ä½œ[root@JX02 ~]# vim /etc/logrotate.d/httpd/var/log/httpd/* {prerotatechattr -a /var/log/httpdendscript#notifemptydailycreate 0600 root rootmissingokrotate 5postrotatechattr +a /var/log/httpdendscript}[root@JX02 logrotate.d]# /usr/sbin/logrotate -f /etc/logrotate.conf#æ¡ˆä¾‹ä¸‰:åˆ‡å‰²å¤šä¸ªæ—¥å¿—æ–‡ä»¶[root@JX02 ~]# vim /etc/logrotate.d/web/var/log/httpd_test.log/var/log/nginx_test.log/var/log/tomcat_test.log{dailycreate 0600 root rootmissingokrotate 5}[root@JX02 ~]# /usr/sbin/logrotate -f /etc/logrotate.conf#æ¡ˆä¾‹å››:åˆ‡å‰²ä¸€ä¸ªæ–‡ä»¶å¤¹ä¸‹çš„æ‰€æœ‰æ—¥å¿—[root@JX02 ~]# vim /etc/logrotate.d/apache/var/log/apache/*log {dailycreate 0600 root rootmissingokrotate 5}[root@JX02 logrotate.d]# /usr/sbin/logrotate -f /etc/logrotate.conf</code></pre>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Jenkins_æµæ°´çº¿è¯­æ³•_002</title>
      <link href="2020/05/30/devops/jenkins-liu-shui-xian-yu-fa-002/"/>
      <url>2020/05/30/devops/jenkins-liu-shui-xian-yu-fa-002/</url>
      
        <content type="html"><![CDATA[<h4 id="å‚æ•°"><a href="#å‚æ•°" class="headerlink" title="å‚æ•°"></a>å‚æ•°</h4><p><code>parameters</code> æŒ‡ä»¤æä¾›äº†ä¸€ä¸ªç”¨æˆ·åœ¨è§¦å‘æµæ°´çº¿æ—¶åº”è¯¥æä¾›çš„å‚æ•°åˆ—è¡¨ã€‚è¿™äº›ç”¨æˆ·æŒ‡å®šå‚æ•°çš„å€¼å¯é€šè¿‡ <code>params</code> å¯¹è±¡æä¾›ç»™æµæ°´çº¿æ­¥éª¤, äº†è§£æ›´å¤šè¯·å‚è€ƒ<a href="https://www.jenkins.io/zh/doc/book/pipeline/syntax/#parameters-example" target="_blank" rel="noopener">ç¤ºä¾‹</a>ã€‚</p><table><thead><tr><th align="left">Required</th><th>No</th></tr></thead><tbody><tr><td align="left">Parameters</td><td><em>None</em></td></tr><tr><td align="left">Allowed</td><td>Only once, inside the <code>pipeline</code> block.</td></tr></tbody></table><h5 id="å¯ç”¨å‚æ•°"><a href="#å¯ç”¨å‚æ•°" class="headerlink" title="å¯ç”¨å‚æ•°"></a>å¯ç”¨å‚æ•°</h5><ul><li><p>string</p><p>å­—ç¬¦ä¸²ç±»å‹çš„å‚æ•°, ä¾‹å¦‚: <code>parameters { string(name: &#39;DEPLOY_ENV&#39;, defaultValue: &#39;staging&#39;, description: &#39;&#39;) }</code></p></li><li><p>booleanParam</p><p>å¸ƒå°”å‚æ•°, ä¾‹å¦‚: <code>parameters { booleanParam(name: &#39;DEBUG_BUILD&#39;, defaultValue: true, description: &#39;&#39;) }</code></p></li></ul><h5 id="ç¤ºä¾‹"><a href="#ç¤ºä¾‹" class="headerlink" title="ç¤ºä¾‹"></a>ç¤ºä¾‹</h5><p>Jenkinsfile (Declarative Pipeline)</p><pre class=" language-groovy"><code class="language-groovy">pipeline <span class="token punctuation">{</span>    agent any    parameters <span class="token punctuation">{</span>        <span class="token function">string</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token string">'PERSON'</span><span class="token punctuation">,</span> defaultValue<span class="token punctuation">:</span> <span class="token string">'Mr Jenkins'</span><span class="token punctuation">,</span> description<span class="token punctuation">:</span> <span class="token string">'Who should I say hello to?'</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    stages <span class="token punctuation">{</span>        <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'Example'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            steps <span class="token punctuation">{</span>                echo <span class="token string">"Hello ${params.PERSON}"</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><table><thead><tr><th></th><th>ä¸€ä»½å®Œæ•´çš„å¯ç”¨å‚æ•°åˆ—è¡¨æ­£åœ¨ç­‰å¾… <a href="https://issues.jenkins-ci.org/browse/INFRA-1053" target="_blank" rel="noopener">INFRA-1503</a>çš„å®Œæˆã€‚</th></tr></thead><tbody><tr><td></td><td></td></tr></tbody></table><h4 id="è§¦å‘å™¨"><a href="#è§¦å‘å™¨" class="headerlink" title="è§¦å‘å™¨"></a>è§¦å‘å™¨</h4><p><code>triggers</code> æŒ‡ä»¤å®šä¹‰äº†æµæ°´çº¿è¢«é‡æ–°è§¦å‘çš„è‡ªåŠ¨åŒ–æ–¹æ³•ã€‚å¯¹äºé›†æˆäº†æºï¼ˆ æ¯”å¦‚ GitHub æˆ– BitBucketï¼‰çš„æµæ°´çº¿, å¯èƒ½ä¸éœ€è¦ <code>triggers</code> ï¼Œå› ä¸ºåŸºäº web çš„é›†æˆå¾ˆè‚¯èƒ½å·²ç»å­˜åœ¨ã€‚ å½“å‰å¯ç”¨çš„è§¦å‘å™¨æ˜¯ <code>cron</code>, <code>pollSCM</code> å’Œ <code>upstream</code>ã€‚</p><table><thead><tr><th align="left">Required</th><th>No</th></tr></thead><tbody><tr><td align="left">Parameters</td><td><em>None</em></td></tr><tr><td align="left">Allowed</td><td>Only once, inside the <code>pipeline</code> block.</td></tr></tbody></table><ul><li><p>cron</p><p>æ¥æ”¶ cron æ ·å¼çš„å­—ç¬¦ä¸²æ¥å®šä¹‰è¦é‡æ–°è§¦å‘æµæ°´çº¿çš„å¸¸è§„é—´éš” ,æ¯”å¦‚: <code>triggers { cron(&#39;H */4 * * 1-5&#39;) }</code></p></li><li><p>pollSCM</p><p>æ¥æ”¶ cron æ ·å¼çš„å­—ç¬¦ä¸²æ¥å®šä¹‰ä¸€ä¸ªå›ºå®šçš„é—´éš”ï¼Œåœ¨è¿™ä¸ªé—´éš”ä¸­ï¼ŒJenkins ä¼šæ£€æŸ¥æ–°çš„æºä»£ç æ›´æ–°ã€‚å¦‚æœå­˜åœ¨æ›´æ”¹, æµæ°´çº¿å°±ä¼šè¢«é‡æ–°è§¦å‘ã€‚ä¾‹å¦‚: <code>triggers { pollSCM(&#39;H */4 * * 1-5&#39;) }</code></p></li><li><p>upstream</p><p>æ¥å—é€—å·åˆ†éš”çš„å·¥ä½œå­—ç¬¦ä¸²å’Œé˜ˆå€¼ã€‚ å½“å­—ç¬¦ä¸²ä¸­çš„ä»»ä½•ä½œä¸šä»¥æœ€å°é˜ˆå€¼ç»“æŸæ—¶ï¼Œæµæ°´çº¿è¢«é‡æ–°è§¦å‘ã€‚ä¾‹å¦‚: <code>triggers { upstream(upstreamProjects: &#39;job1,job2&#39;, threshold: hudson.model.Result.SUCCESS) }</code></p></li></ul><table><thead><tr><th></th><th><code>pollSCM</code> åªåœ¨Jenkins 2.22 åŠä»¥ä¸Šç‰ˆæœ¬ä¸­å¯ç”¨ã€‚</th></tr></thead><tbody><tr><td></td><td></td></tr></tbody></table><h5 id="ç¤ºä¾‹-1"><a href="#ç¤ºä¾‹-1" class="headerlink" title="ç¤ºä¾‹"></a>ç¤ºä¾‹</h5><p>Jenkinsfile (Declarative Pipeline)</p><pre class=" language-groovy"><code class="language-groovy">pipeline <span class="token punctuation">{</span>    agent any    triggers <span class="token punctuation">{</span>        <span class="token function">cron</span><span class="token punctuation">(</span><span class="token string">'H */4 * * 1-5'</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    stages <span class="token punctuation">{</span>        <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'Example'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            steps <span class="token punctuation">{</span>                echo <span class="token string">'Hello World'</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h4 id="stage"><a href="#stage" class="headerlink" title="stage"></a>stage</h4><p><code>stage</code> æŒ‡ä»¤åœ¨ <code>stages</code> éƒ¨åˆ†è¿›è¡Œï¼Œåº”è¯¥åŒ…å«ä¸€ä¸ª å®é™…ä¸Š, æµæ°´å··æ‰€åšçš„æ‰€æœ‰å®é™…å·¥ä½œéƒ½å°†å°è£…è¿›ä¸€ä¸ªæˆ–å¤šä¸ª <code>stage</code> æŒ‡ä»¤ä¸­ã€‚</p><table><thead><tr><th align="left">Required</th><th>At least one</th></tr></thead><tbody><tr><td align="left">Parameters</td><td>One mandatory parameter, a string for the name of the stage.</td></tr><tr><td align="left">Allowed</td><td>Inside the <code>stages</code> section.</td></tr></tbody></table><h5 id="ç¤ºä¾‹-2"><a href="#ç¤ºä¾‹-2" class="headerlink" title="ç¤ºä¾‹"></a>ç¤ºä¾‹</h5><p>Jenkinsfile (Declarative Pipeline)</p><pre class=" language-groovy"><code class="language-groovy">pipeline <span class="token punctuation">{</span>    agent any    stages <span class="token punctuation">{</span>        <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'Example'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            steps <span class="token punctuation">{</span>                echo <span class="token string">'Hello World'</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h4 id="å·¥å…·"><a href="#å·¥å…·" class="headerlink" title="å·¥å…·"></a>å·¥å…·</h4><p>å®šä¹‰è‡ªåŠ¨å®‰è£…å’Œæ”¾ç½® <code>PATH</code> çš„å·¥å…·çš„ä¸€éƒ¨åˆ†ã€‚å¦‚æœ <code>agent none</code> æŒ‡å®šï¼Œåˆ™å¿½ç•¥è¯¥æ“ä½œã€‚</p><table><thead><tr><th align="left">Required</th><th>No</th></tr></thead><tbody><tr><td align="left">Parameters</td><td><em>None</em></td></tr><tr><td align="left">Allowed</td><td>Inside the <code>pipeline</code> block or a <code>stage</code> block.</td></tr></tbody></table><h5 id="æ”¯æŒå·¥å…·"><a href="#æ”¯æŒå·¥å…·" class="headerlink" title="æ”¯æŒå·¥å…·"></a>æ”¯æŒå·¥å…·</h5><ul><li>maven</li><li>jdk</li><li>gradle</li></ul><h5 id="ç¤ºä¾‹-3"><a href="#ç¤ºä¾‹-3" class="headerlink" title="ç¤ºä¾‹"></a>ç¤ºä¾‹</h5><p>Jenkinsfile (Declarative Pipeline)</p><pre class=" language-groovy"><code class="language-groovy">pipeline <span class="token punctuation">{</span>    agent any    tools <span class="token punctuation">{</span>        maven <span class="token string">'apache-maven-3.0.1'</span>     <span class="token punctuation">}</span>    stages <span class="token punctuation">{</span>        <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'Example'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            steps <span class="token punctuation">{</span>                sh <span class="token string">'mvn --version'</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><table><thead><tr><th></th><th>The tool name must be pre-configured in Jenkins under <strong>Manage Jenkins</strong> â†’ <strong>Global Tool Configuration</strong>.</th></tr></thead><tbody><tr><td></td><td>å·¥å…·åç§°å¿…é¡»åœ¨Jenkinsä¸­çš„Manage Jenkinsâ†’å…¨å±€å·¥å…·é…ç½®ä¸‹é¢„å…ˆé…ç½®ã€‚</td></tr></tbody></table><h4 id="input"><a href="#input" class="headerlink" title="input"></a>input</h4><p><code>stage</code> çš„ <code>input</code> æŒ‡ä»¤å…è®¸ä½ ä½¿ç”¨ <a href="https://jenkins.io/doc/pipeline/steps/pipeline-input-step/#input-wait-for-interactive-input" target="_blank" rel="noopener"><code>input</code> step</a>æç¤ºè¾“å…¥ã€‚ åœ¨åº”ç”¨äº† <code>options</code> åï¼Œè¿›å…¥ <code>stage</code> çš„ <code>agent</code> æˆ–è¯„ä¼° <code>when</code> æ¡ä»¶å‰ï¼Œ <code>stage</code> å°†æš‚åœã€‚ å¦‚æœ <code>input</code> è¢«æ‰¹å‡†, <code>stage</code> å°†ä¼šç»§ç»­ã€‚ ä½œä¸º <code>input</code> æäº¤çš„ä¸€éƒ¨åˆ†çš„ä»»ä½•å‚æ•°éƒ½å°†åœ¨ç¯å¢ƒä¸­ç”¨äºå…¶ä»– <code>stage</code>ã€‚</p><h5 id="é…ç½®é¡¹"><a href="#é…ç½®é¡¹" class="headerlink" title="é…ç½®é¡¹"></a>é…ç½®é¡¹</h5><ul><li><p>message</p><p>å¿…éœ€çš„ã€‚ è¿™å°†åœ¨ç”¨æˆ·æäº¤ <code>input</code> æ—¶å‘ˆç°ç»™ç”¨æˆ·ã€‚</p></li><li><p>id</p><p><code>input</code> çš„å¯é€‰æ ‡è¯†ç¬¦ï¼Œ é»˜è®¤ä¸º <code>stage</code> åç§°ã€‚</p></li><li><p>ok</p><p><code>input</code>è¡¨å•ä¸Šçš„â€okâ€ æŒ‰é’®çš„å¯é€‰æ–‡æœ¬ã€‚</p></li><li><p>submitter</p><p>å¯é€‰çš„ä»¥é€—å·åˆ†éš”çš„ç”¨æˆ·åˆ—è¡¨æˆ–å…è®¸æäº¤ <code>input</code> çš„å¤–éƒ¨ç»„åã€‚é»˜è®¤å…è®¸ä»»ä½•ç”¨æˆ·ã€‚</p></li><li><p>submitterParameter</p><p>ç¯å¢ƒå˜é‡çš„å¯é€‰åç§°ã€‚å¦‚æœå­˜åœ¨ï¼Œç”¨ <code>submitter</code> åç§°è®¾ç½®ã€‚</p></li><li><p>parameters</p><p>æç¤ºæäº¤è€…æä¾›çš„ä¸€ä¸ªå¯é€‰çš„å‚æ•°åˆ—è¡¨ã€‚ æ›´å¤šä¿¡æ¯å‚è§ <a href="https://www.jenkins.io/zh/doc/book/pipeline/syntax/#parameters" target="_blank" rel="noopener">[parameters]</a>ã€‚</p></li></ul><h5 id="ç¤ºä¾‹-4"><a href="#ç¤ºä¾‹-4" class="headerlink" title="ç¤ºä¾‹"></a>ç¤ºä¾‹</h5><p>Jenkinsfile (Declarative Pipeline)</p><pre class=" language-groovy"><code class="language-groovy">pipeline <span class="token punctuation">{</span>    agent any    stages <span class="token punctuation">{</span>        <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'Example'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            input <span class="token punctuation">{</span>                message <span class="token string">"Should we continue?"</span>                ok <span class="token string">"Yes, we should."</span>                submitter <span class="token string">"alice,bob"</span>                parameters <span class="token punctuation">{</span>                    <span class="token function">string</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token string">'PERSON'</span><span class="token punctuation">,</span> defaultValue<span class="token punctuation">:</span> <span class="token string">'Mr Jenkins'</span><span class="token punctuation">,</span> description<span class="token punctuation">:</span> <span class="token string">'Who should I say hello to?'</span><span class="token punctuation">)</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>            steps <span class="token punctuation">{</span>                echo <span class="token string">"Hello, ${PERSON}, nice to meet you."</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h4 id="when"><a href="#when" class="headerlink" title="when"></a>when</h4><p><code>when</code> æŒ‡ä»¤å…è®¸æµæ°´çº¿æ ¹æ®ç»™å®šçš„æ¡ä»¶å†³å®šæ˜¯å¦åº”è¯¥æ‰§è¡Œé˜¶æ®µã€‚ <code>when</code> æŒ‡ä»¤å¿…é¡»åŒ…å«è‡³å°‘ä¸€ä¸ªæ¡ä»¶ã€‚ å¦‚æœ <code>when</code> æŒ‡ä»¤åŒ…å«å¤šä¸ªæ¡ä»¶, æ‰€æœ‰çš„å­æ¡ä»¶å¿…é¡»è¿”å›Trueï¼Œé˜¶æ®µæ‰èƒ½æ‰§è¡Œã€‚ è¿™ä¸å­æ¡ä»¶åœ¨ <code>allOf</code> æ¡ä»¶ä¸‹åµŒå¥—çš„æƒ…å†µç›¸åŒ (å‚è§ä¸‹é¢çš„<a href="https://www.jenkins.io/zh/doc/book/pipeline/syntax/#when-example" target="_blank" rel="noopener">ç¤ºä¾‹</a>)ã€‚</p><p>ä½¿ç”¨è¯¸å¦‚ <code>not</code>, <code>allOf</code>, æˆ– <code>anyOf</code> çš„åµŒå¥—æ¡ä»¶å¯ä»¥æ„å»ºæ›´å¤æ‚çš„æ¡ä»¶ç»“æ„ can be built åµŒå¥—æ¡ä»¶åˆ»æ„æ½œé€ƒåˆ°ä»»æ„æ·±åº¦ã€‚</p><table><thead><tr><th align="left">Required</th><th>No</th></tr></thead><tbody><tr><td align="left">Parameters</td><td><em>None</em></td></tr><tr><td align="left">Allowed</td><td>Inside a <code>stage</code> directive</td></tr></tbody></table><h5 id="å†…ç½®æ¡ä»¶"><a href="#å†…ç½®æ¡ä»¶" class="headerlink" title="å†…ç½®æ¡ä»¶"></a>å†…ç½®æ¡ä»¶</h5><ul><li><p>branch</p><p>å½“æ­£åœ¨æ„å»ºçš„åˆ†æ”¯ä¸æ¨¡å¼ç»™å®šçš„åˆ†æ”¯åŒ¹é…æ—¶ï¼Œæ‰§è¡Œè¿™ä¸ªé˜¶æ®µ, ä¾‹å¦‚: <code>when { branch &#39;master&#39; }</code>ã€‚æ³¨æ„ï¼Œè¿™åªé€‚ç”¨äºå¤šåˆ†æ”¯æµæ°´çº¿ã€‚</p></li><li><p>environment</p><p>å½“æŒ‡å®šçš„ç¯å¢ƒå˜é‡æ˜¯ç»™å®šçš„å€¼æ—¶ï¼Œæ‰§è¡Œè¿™ä¸ªæ­¥éª¤, ä¾‹å¦‚: <code>when { environment name: &#39;DEPLOY_TO&#39;, value: &#39;production&#39; }</code></p></li><li><p>expression</p><p>å½“æŒ‡å®šçš„Groovyè¡¨è¾¾å¼è¯„ä¼°ä¸ºtrueæ—¶ï¼Œæ‰§è¡Œè¿™ä¸ªé˜¶æ®µ, ä¾‹å¦‚: <code>when { expression { return params.DEBUG_BUILD } }</code></p></li><li><p>not</p><p>å½“åµŒå¥—æ¡ä»¶æ˜¯é”™è¯¯æ—¶ï¼Œæ‰§è¡Œè¿™ä¸ªé˜¶æ®µ,å¿…é¡»åŒ…å«ä¸€ä¸ªæ¡ä»¶ï¼Œä¾‹å¦‚: <code>when { not { branch &#39;master&#39; } }</code></p></li><li><p>allOf</p><p>å½“æ‰€æœ‰çš„åµŒå¥—æ¡ä»¶éƒ½æ­£ç¡®æ—¶ï¼Œæ‰§è¡Œè¿™ä¸ªé˜¶æ®µ,å¿…é¡»åŒ…å«è‡³å°‘ä¸€ä¸ªæ¡ä»¶ï¼Œä¾‹å¦‚: <code>when { allOf { branch &#39;master&#39;; environment name: &#39;DEPLOY_TO&#39;, value: &#39;production&#39; } }</code></p></li><li><p>anyOf</p><p>å½“è‡³å°‘æœ‰ä¸€ä¸ªåµŒå¥—æ¡ä»¶ä¸ºçœŸæ—¶ï¼Œæ‰§è¡Œè¿™ä¸ªé˜¶æ®µ,å¿…é¡»åŒ…å«è‡³å°‘ä¸€ä¸ªæ¡ä»¶ï¼Œä¾‹å¦‚: <code>when { anyOf { branch &#39;master&#39;; branch &#39;staging&#39; } }</code></p></li></ul><h5 id="åœ¨è¿›å…¥-stage-çš„-agent-å‰è¯„ä¼°-when"><a href="#åœ¨è¿›å…¥-stage-çš„-agent-å‰è¯„ä¼°-when" class="headerlink" title="åœ¨è¿›å…¥ stage çš„ agent å‰è¯„ä¼° when"></a>åœ¨è¿›å…¥ <code>stage</code> çš„ <code>agent</code> å‰è¯„ä¼° <code>when</code></h5><p>é»˜è®¤æƒ…å†µä¸‹, å¦‚æœå®šä¹‰äº†æŸä¸ªé˜¶æ®µçš„ä»£ç†ï¼Œåœ¨è¿›å…¥è¯¥<code>stage</code> çš„ <code>agent</code> åè¯¥ <code>stage</code> çš„ <code>when</code> æ¡ä»¶å°†ä¼šè¢«è¯„ä¼°ã€‚ä½†æ˜¯, å¯ä»¥é€šè¿‡åœ¨ <code>when</code> å—ä¸­æŒ‡å®š <code>beforeAgent</code> é€‰é¡¹æ¥æ›´æ”¹æ­¤é€‰é¡¹ã€‚ å¦‚æœ <code>beforeAgent</code> è¢«è®¾ç½®ä¸º <code>true</code>, é‚£ä¹ˆå°±ä¼šé¦–å…ˆå¯¹ <code>when</code> æ¡ä»¶è¿›è¡Œè¯„ä¼° , å¹¶ä¸”åªæœ‰åœ¨ <code>when</code> æ¡ä»¶éªŒè¯ä¸ºçœŸæ—¶æ‰ä¼šè¿›å…¥ <code>agent</code> ã€‚</p><h5 id="ç¤ºä¾‹-5"><a href="#ç¤ºä¾‹-5" class="headerlink" title="ç¤ºä¾‹"></a>ç¤ºä¾‹</h5><p>Jenkinsfile (Declarative Pipeline)</p><pre class=" language-groovy"><code class="language-groovy">pipeline <span class="token punctuation">{</span>    agent any    stages <span class="token punctuation">{</span>        <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'Example Build'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            steps <span class="token punctuation">{</span>                echo <span class="token string">'Hello World'</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'Example Deploy'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            when <span class="token punctuation">{</span>                branch <span class="token string">'production'</span>            <span class="token punctuation">}</span>            steps <span class="token punctuation">{</span>                echo <span class="token string">'Deploying'</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>Jenkinsfile (Declarative Pipeline)</p><pre class=" language-groovy"><code class="language-groovy">pipeline <span class="token punctuation">{</span>    agent any    stages <span class="token punctuation">{</span>        <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'Example Build'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            steps <span class="token punctuation">{</span>                echo <span class="token string">'Hello World'</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'Example Deploy'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            when <span class="token punctuation">{</span>                branch <span class="token string">'production'</span>                environment name<span class="token punctuation">:</span> <span class="token string">'DEPLOY_TO'</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> <span class="token string">'production'</span>            <span class="token punctuation">}</span>            steps <span class="token punctuation">{</span>                echo <span class="token string">'Deploying'</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>Jenkinsfile (Declarative Pipeline)</p><pre class=" language-groovy"><code class="language-groovy">pipeline <span class="token punctuation">{</span>    agent any    stages <span class="token punctuation">{</span>        <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'Example Build'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            steps <span class="token punctuation">{</span>                echo <span class="token string">'Hello World'</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'Example Deploy'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            when <span class="token punctuation">{</span>                allOf <span class="token punctuation">{</span>                    branch <span class="token string">'production'</span>                    environment name<span class="token punctuation">:</span> <span class="token string">'DEPLOY_TO'</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> <span class="token string">'production'</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>            steps <span class="token punctuation">{</span>                echo <span class="token string">'Deploying'</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>Jenkinsfile (Declarative Pipeline)</p><pre class=" language-groovy"><code class="language-groovy">pipeline <span class="token punctuation">{</span>    agent any    stages <span class="token punctuation">{</span>        <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'Example Build'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            steps <span class="token punctuation">{</span>                echo <span class="token string">'Hello World'</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'Example Deploy'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            when <span class="token punctuation">{</span>                branch <span class="token string">'production'</span>                anyOf <span class="token punctuation">{</span>                    environment name<span class="token punctuation">:</span> <span class="token string">'DEPLOY_TO'</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> <span class="token string">'production'</span>                    environment name<span class="token punctuation">:</span> <span class="token string">'DEPLOY_TO'</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> <span class="token string">'staging'</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>            steps <span class="token punctuation">{</span>                echo <span class="token string">'Deploying'</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>Jenkinsfile (Declarative Pipeline)</p><pre class=" language-groovy"><code class="language-groovy">pipeline <span class="token punctuation">{</span>    agent any    stages <span class="token punctuation">{</span>        <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'Example Build'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            steps <span class="token punctuation">{</span>                echo <span class="token string">'Hello World'</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'Example Deploy'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            when <span class="token punctuation">{</span>                expression <span class="token punctuation">{</span> BRANCH_NAME <span class="token operator">==~</span> <span class="token string">/(production|staging)/</span> <span class="token punctuation">}</span>                anyOf <span class="token punctuation">{</span>                    environment name<span class="token punctuation">:</span> <span class="token string">'DEPLOY_TO'</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> <span class="token string">'production'</span>                    environment name<span class="token punctuation">:</span> <span class="token string">'DEPLOY_TO'</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> <span class="token string">'staging'</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>            steps <span class="token punctuation">{</span>                echo <span class="token string">'Deploying'</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>Jenkinsfile (Declarative Pipeline)</p><pre class=" language-groovy"><code class="language-groovy">pipeline <span class="token punctuation">{</span>    agent none    stages <span class="token punctuation">{</span>        <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'Example Build'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            steps <span class="token punctuation">{</span>                echo <span class="token string">'Hello World'</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'Example Deploy'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            agent <span class="token punctuation">{</span>                label <span class="token string">"some-label"</span>            <span class="token punctuation">}</span>            when <span class="token punctuation">{</span>                beforeAgent <span class="token boolean">true</span>                branch <span class="token string">'production'</span>            <span class="token punctuation">}</span>            steps <span class="token punctuation">{</span>                echo <span class="token string">'Deploying'</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h3 id="å¹¶è¡Œ"><a href="#å¹¶è¡Œ" class="headerlink" title="å¹¶è¡Œ"></a>å¹¶è¡Œ</h3><p>å£°æ˜å¼æµæ°´çº¿çš„é˜¶æ®µå¯ä»¥åœ¨ä»–ä»¬å†…éƒ¨å£°æ˜å¤šéš”åµŒå¥—é˜¶æ®µ, å®ƒä»¬å°†å¹¶è¡Œæ‰§è¡Œã€‚ æ³¨æ„ï¼Œä¸€ä¸ªé˜¶æ®µå¿…é¡»åªæœ‰ä¸€ä¸ª <code>steps</code> æˆ– <code>parallel</code> çš„é˜¶æ®µã€‚ åµŒå¥—é˜¶æ®µæœ¬èº«ä¸èƒ½åŒ…å«è¿›ä¸€æ­¥çš„ <code>parallel</code> é˜¶æ®µ, ä½†æ˜¯å…¶ä»–çš„é˜¶æ®µçš„è¡Œä¸ºä¸ä»»ä½•å…¶ä»– <code>stage</code> ç›¸åŒã€‚ä»»ä½•åŒ…å« <code>parallel</code> çš„é˜¶æ®µä¸èƒ½åŒ…å« <code>agent</code> æˆ– <code>tools</code> é˜¶æ®µ, å› ä¸ºä»–ä»¬æ²¡æœ‰ç›¸å…³ <code>steps</code>ã€‚</p><p>å¦å¤–, é€šè¿‡æ·»åŠ  <code>failFast true</code> åˆ°åŒ…å« <code>parallel</code>çš„ <code>stage</code> ä¸­ï¼Œ å½“å…¶ä¸­ä¸€ä¸ªè¿›ç¨‹å¤±è´¥æ—¶ï¼Œä½ å¯ä»¥å¼ºåˆ¶æ‰€æœ‰çš„ <code>parallel</code> é˜¶æ®µéƒ½è¢«ç»ˆæ­¢ã€‚</p><h4 id="ç¤ºä¾‹-6"><a href="#ç¤ºä¾‹-6" class="headerlink" title="ç¤ºä¾‹"></a>ç¤ºä¾‹</h4><p>Jenkinsfile (Declarative Pipeline)</p><pre class=" language-groovy"><code class="language-groovy">pipeline <span class="token punctuation">{</span>    agent any    stages <span class="token punctuation">{</span>        <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'Non-Parallel Stage'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            steps <span class="token punctuation">{</span>                echo <span class="token string">'This stage will be executed first.'</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'Parallel Stage'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            when <span class="token punctuation">{</span>                branch <span class="token string">'master'</span>            <span class="token punctuation">}</span>            failFast <span class="token boolean">true</span>            parallel <span class="token punctuation">{</span>                <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'Branch A'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    agent <span class="token punctuation">{</span>                        label <span class="token string">"for-branch-a"</span>                    <span class="token punctuation">}</span>                    steps <span class="token punctuation">{</span>                        echo <span class="token string">"On Branch A"</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span>                <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'Branch B'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    agent <span class="token punctuation">{</span>                        label <span class="token string">"for-branch-b"</span>                    <span class="token punctuation">}</span>                    steps <span class="token punctuation">{</span>                        echo <span class="token string">"On Branch B"</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h3 id="æ­¥éª¤"><a href="#æ­¥éª¤" class="headerlink" title="æ­¥éª¤"></a>æ­¥éª¤</h3><p>å£°æ˜å¼æµæ°´çº¿å¯èƒ½ä½¿ç”¨åœ¨ <a href="https://www.jenkins.io/doc/pipeline/steps" target="_blank" rel="noopener">æµæ°´çº¿æ­¥éª¤å¼•ç”¨</a>ä¸­è®°å½•çš„æ‰€æœ‰å¯ç”¨çš„æ­¥éª¤, å®ƒåŒ…å«ä¸€ä¸ªå®Œæ•´çš„æ­¥éª¤åˆ—è¡¨, å…¶ä¸­æ·»åŠ äº†ä¸‹é¢åˆ—å‡ºçš„æ­¥éª¤ï¼Œè¿™äº›æ­¥éª¤åªåœ¨å£°æ˜å¼æµæ°´çº¿ä¸­ <strong>only supported</strong> ã€‚</p><h4 id="è„šæœ¬"><a href="#è„šæœ¬" class="headerlink" title="è„šæœ¬"></a>è„šæœ¬</h4><p><code>script</code> æ­¥éª¤éœ€è¦ <a href="https://www.jenkins.io/zh/doc/book/pipeline/syntax/#scripted-pipeline" target="_blank" rel="noopener">[scripted-pipeline]</a>å—å¹¶åœ¨å£°æ˜å¼æµæ°´çº¿ä¸­æ‰§è¡Œã€‚ å¯¹äºå¤§å¤šæ•°ç”¨ä¾‹æ¥è¯´,åº”è¯¥å£°æ˜å¼æµæ°´çº¿ä¸­çš„â€œè„šæœ¬â€æ­¥éª¤æ˜¯ä¸å¿…è¦çš„ï¼Œ ä½†æ˜¯å®ƒå¯ä»¥æä¾›ä¸€ä¸ªæœ‰ç”¨çš„â€é€ƒç”Ÿå‡ºå£â€ã€‚ éå¹³å‡¡çš„è§„æ¨¡å’Œ/æˆ–å¤æ‚æ€§çš„ <code>script</code> å—åº”è¯¥è¢«è½¬ç§»åˆ° <a href="https://www.jenkins.io/zh/doc/book/pipeline/syntax/#shared-libraries#" target="_blank" rel="noopener">å…±äº«åº“</a> ã€‚</p><h5 id="ç¤ºä¾‹-7"><a href="#ç¤ºä¾‹-7" class="headerlink" title="ç¤ºä¾‹"></a>ç¤ºä¾‹</h5><p>Jenkinsfile (Declarative Pipeline)</p><pre class=" language-groovy"><code class="language-groovy">pipeline <span class="token punctuation">{</span>    agent any    stages <span class="token punctuation">{</span>        <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'Example'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            steps <span class="token punctuation">{</span>                echo <span class="token string">'Hello World'</span>                script <span class="token punctuation">{</span>                    <span class="token keyword">def</span> browsers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'chrome'</span><span class="token punctuation">,</span> <span class="token string">'firefox'</span><span class="token punctuation">]</span>                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> browsers<span class="token operator">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        echo <span class="token string">"Testing the ${browsers[i]} browser"</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h2 id="è„šæœ¬åŒ–æµæ°´çº¿"><a href="#è„šæœ¬åŒ–æµæ°´çº¿" class="headerlink" title="è„šæœ¬åŒ–æµæ°´çº¿"></a>è„šæœ¬åŒ–æµæ°´çº¿</h2><p>è„šæœ¬åŒ–æµæ°´çº¿, ä¸<a href="https://www.jenkins.io/zh/doc/book/pipeline/syntax/#declarative-pipeline" target="_blank" rel="noopener">[declarative-pipeline]</a>ä¸€æ ·çš„æ˜¯, æ˜¯å»ºç«‹åœ¨åº•å±‚æµæ°´çº¿çš„å­ç³»ç»Ÿä¸Šçš„ã€‚ä¸å£°æ˜å¼ä¸åŒçš„æ˜¯, è„šæœ¬åŒ–æµæ°´çº¿å®é™…ä¸Šæ˜¯ç”± <a href="http://groovy-lang.org/syntax.html" target="_blank" rel="noopener">Groovy</a>æ„å»ºçš„é€šç”¨ DSL [<a href="https://www.jenkins.io/zh/doc/book/pipeline/syntax/#_footnotedef_2" target="_blank" rel="noopener">2</a>]ã€‚ Groovy è¯­è¨€æä¾›çš„å¤§éƒ¨åˆ†åŠŸèƒ½éƒ½å¯ä»¥ç”¨äºè„šæœ¬åŒ–æµæ°´çº¿çš„ç”¨æˆ·ã€‚è¿™æ„å‘³ç€å®ƒæ˜¯ä¸€ä¸ªéå¸¸æœ‰è¡¨ç°åŠ›å’Œçµæ´»çš„å·¥å…·ï¼Œå¯ä»¥é€šè¿‡å®ƒç¼–å†™æŒç»­äº¤ä»˜æµæ°´çº¿ã€‚</p><h3 id="æµæ§åˆ¶"><a href="#æµæ§åˆ¶" class="headerlink" title="æµæ§åˆ¶"></a>æµæ§åˆ¶</h3><p>è„šæœ¬åŒ–æµæ°´çº¿ä» <code>Jenkinsfile</code> çš„é¡¶éƒ¨å¼€å§‹å‘ä¸‹ä¸²è¡Œæ‰§è¡Œ, å°±åƒ Groovy æˆ–å…¶ä»–è¯­è¨€ä¸­çš„å¤§å¤šæ•°ä¼ ç»Ÿè„šæœ¬ä¸€æ ·ã€‚ å› æ­¤ï¼Œæä¾›æµæ§åˆ¶å–å†³äº Groovy è¡¨è¾¾å¼, æ¯”å¦‚ <code>if/else</code> æ¡ä»¶, ä¾‹å¦‚:</p><p>Jenkinsfile (Scripted Pipeline)</p><pre class=" language-groovy"><code class="language-groovy">node <span class="token punctuation">{</span>    <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'Example'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>env<span class="token operator">.</span>BRANCH_NAME <span class="token operator">==</span> <span class="token string">'master'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            echo <span class="token string">'I only execute on the master branch'</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            echo <span class="token string">'I execute elsewhere'</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>å¦ä¸€ç§æ–¹æ³•æ˜¯ä½¿ç”¨Groovyçš„å¼‚å¸¸å¤„ç†æ”¯æŒæ¥ç®¡ç†è„šæœ¬åŒ–æµæ°´çº¿æµæ§åˆ¶ã€‚å½“ <a href="https://www.jenkins.io/zh/doc/book/pipeline/syntax/#scripted-steps" target="_blank" rel="noopener">æ­¥éª¤</a> å¤±è´¥ ï¼Œæ— è®ºä»€ä¹ˆåŸå› ï¼Œå®ƒä»¬éƒ½ä¼šæŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ã€‚å¤„ç†é”™è¯¯çš„è¡Œä¸ºå¿…é¡»ä½¿ç”¨Groovyä¸­çš„ <code>try/catch/finally</code> å— , ä¾‹å¦‚:</p><p>Jenkinsfile (Scripted Pipeline)</p><pre class=" language-groovy"><code class="language-groovy">node <span class="token punctuation">{</span>    <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'Example'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            sh <span class="token string">'exit 1'</span>        <span class="token punctuation">}</span>        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">exc</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            echo <span class="token string">'Something failed, I should sound the klaxons!'</span>            <span class="token keyword">throw</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h3 id="æ­¥éª¤-1"><a href="#æ­¥éª¤-1" class="headerlink" title="æ­¥éª¤"></a>æ­¥éª¤</h3><p>æ­£å¦‚ <a href="https://www.jenkins.io/zh/doc/book/pipeline/" target="_blank" rel="noopener">æœ¬ç« å¼€å§‹</a>æ‰€è®¨è®ºçš„, æµæ°´çº¿æœ€åŸºç¡€çš„éƒ¨åˆ†æ˜¯â€æ­¥éª¤â€ã€‚ä»æ ¹æœ¬ä¸Šè¯´, æ­¥éª¤å‘Šè¯‰ Jenkinsè¦åš <em>what</em> ï¼Œå¹¶ä½œä¸ºå£°æ˜å¼å’Œè„šæœ¬åŒ–æµæ°´çº¿å·²å‘çš„åŸºæœ¬æ„å»ºå—ã€‚</p><p>è„šæœ¬åŒ–æµæ°´çº¿ <strong>not</strong> ä¸å¼•å…¥ä»»ä½•ç‰¹å®šäºå…¶è¯­æ³•çš„æ­¥éª¤; <a href="https://www.jenkins.io/doc/pipeline/steps" target="_blank" rel="noopener">æµæ°´çº¿æ­¥éª¤å¼•ç”¨</a> åŒ…æ‹¬æµæ°´çº¿å’Œæ’ä»¶æä¾›çš„æ­¥éª¤çš„å®Œæ•´åˆ—è¡¨ã€‚</p><h3 id="åŒºåˆ«æ™®é€š-Groovy"><a href="#åŒºåˆ«æ™®é€š-Groovy" class="headerlink" title="åŒºåˆ«æ™®é€š Groovy"></a>åŒºåˆ«æ™®é€š Groovy</h3><p>ä¸ºäº†æä¾› <em>durability</em>, è¿™æ„å‘³ç€è¿è¡Œæµæ°´çº¿å¯ä»¥åœ¨Jenkins <a href="https://www.jenkins.io/zh/doc/book/pipeline/syntax/#../glossary#master" target="_blank" rel="noopener">master</a> é‡å¯åç»§ç»­è¿è¡Œï¼Œè„šæœ¬åŒ–çš„æµæ°´çº¿åºåˆ—åŒ–æ•°æ®åˆ°ä¸»æœåŠ¡å™¨ã€‚ç”±äºè¿™ä¸ªè®¾è®¡éœ€æ±‚, ä¸€äº›Groovy ä¹ æƒ¯ç”¨è¯­ï¼Œæ¯”å¦‚ <code>collection.each { item -&gt; /* perform operation */ }</code> éƒ½ä¸å®Œå…¨æ”¯æŒã€‚è¯¦æƒ…å‚è§ <a href="https://issues.jenkins-ci.org/browse/JENKINS-27421" target="_blank" rel="noopener">JENKINS-27421</a> å’Œ <a href="https://issues.jenkins-ci.org/browse/JENKINS-26481" target="_blank" rel="noopener">JENKINS-26481</a>ã€‚</p><h2 id="è¯­æ³•æ¯”è¾ƒ"><a href="#è¯­æ³•æ¯”è¾ƒ" class="headerlink" title="è¯­æ³•æ¯”è¾ƒ"></a>è¯­æ³•æ¯”è¾ƒ</h2><p>å½“Jenkins æµæ°´çº¿ç¬¬ä¸€æ¬¡æ„å»ºæ—¶, Groovy è¢«é€‰ä¸ºåŸºç¡€ã€‚ Jenkinsé•¿æœŸä½¿ç”¨åµŒå…¥å¼ Groovyå¼•æ“æ¥ä¸ºç®¡ç†å‘˜å’Œç”¨æˆ·æä¾› é«˜çº§è„šæœ¬åŠŸèƒ½ã€‚å¦å¤–, Jenkinsæµæ°´çº¿çš„å®ç°è€…å‘ç° Groovyæ˜¯ æ„å»ºç°åœ¨æˆä¸º â€œè„šæœ¬åŒ–æµæ°´çº¿â€ DSLçš„åšå®åŸºç¡€ [<a href="https://www.jenkins.io/zh/doc/book/pipeline/syntax/#_footnotedef_2" target="_blank" rel="noopener">2</a>]ã€‚</p><p>ç”±äºå®ƒæ˜¯ä¸€ä¸ªåŠŸèƒ½é½å…¨çš„ç¼–ç¨‹ç¯å¢ƒ, è„šæœ¬åŒ–æµæ°´çº¿ä¸ºJenkinsç”¨æˆ·æä¾›äº† å¤§é‡çš„çµæ´»æ€§æ€§å’Œå¯æ‰©å±•æ€§ã€‚ Groovyå­¦ä¹ æ›²çº¿é€šå¸¸ä¸é€‚åˆç»™å®šå›¢é˜Ÿçš„æ‰€æœ‰æˆå‘˜, å› æ­¤åˆ›é€ äº†å£°æ˜å¼æµæ°´çº¿æ¥ä¸ºç¼–å†™Jenkinsæµæ°´çº¿æä¾›ä¸€ç§æ›´ç®€å•ã€æ›´æœ‰ä¸»è§çš„è¯­æ³•ã€‚</p><p>ä¸¤è€…æœ¬è´¨ä¸Šæ˜¯ç›¸åŒçš„æµæ°´çº¿å­ç³»ç»Ÿã€‚ underneath. ä»–ä»¬éƒ½æ˜¯ â€œæµæ°´çº¿å³ä»£ç â€ çš„æŒä¹…å®ç°ã€‚å®ƒä»¬éƒ½èƒ½å¤Ÿä½¿ç”¨æ„å»ºåˆ°æµæ°´çº¿ä¸­æˆ–æ’ä»¶æä¾›çš„æ­¥éª¤ã€‚å®ƒä»¬éƒ½èƒ½å¤Ÿä½¿ç”¨ <a href="https://www.jenkins.io/zh/doc/book/pipeline/syntax/#shared-libraries#" target="_blank" rel="noopener">å…±äº«åº“</a></p><p>ä½†æ˜¯å®ƒä»¬çš„åŒºåˆ«åœ¨äºè¯­æ³•å’Œçµæ´»æ€§ã€‚ å£°æ˜å¼é™åˆ¶äº†ç”¨æˆ·ä½¿ç”¨æ›´ä¸¥æ ¼å’Œé¢„å®šä¹‰çš„ç»“æ„ï¼Œ ä½¿å…¶æˆä¸ºæ›´ç®€å•çš„æŒç»­äº¤ä»˜æµæ°´çº¿çš„ç†æƒ³é€‰æ‹©ã€‚ è„šæœ¬åŒ–æä¾›äº†å¾ˆå°‘çš„é™åˆ¶, ä»¥è‡³äºå¯¹è„šæœ¬å’Œè¯­æ³•çš„å”¯ä¸€é™åˆ¶å¾€å¾€æ˜¯ç”±Groovyå­é›†æœ¬èº«å®šä¹‰çš„ï¼Œè€Œä¸æ˜¯ä»»ä½•ç‰¹å®šäºæµæ°´çº¿çš„ç³»ç»Ÿ, è¿™ä½¿ä»–æˆä¸ºæƒåˆ©ç”¨æˆ·å’Œé‚£äº›æœ‰æ›´å¤æ‚éœ€æ±‚çš„äººçš„ç†æƒ³é€‰æ‹©ã€‚ é¡¾åæ€ä¹‰, å£°æ˜å¼æµæ°´çº¿é¼“åŠ± å£°æ˜å¼ç¼–ç¨‹æ¨¡å‹ã€‚ [<a href="https://www.jenkins.io/zh/doc/book/pipeline/syntax/#_footnotedef_3" target="_blank" rel="noopener">3</a>] è€Œè„šæœ¬åŒ–æµæ°´çº¿éµå¾ªä¸€ä¸ªæ›´å‘½ä»¤å¼çš„ç¼–ç¨‹æ¨¡å‹ [<a href="https://www.jenkins.io/zh/doc/book/pipeline/syntax/#_footnotedef_4" target="_blank" rel="noopener">4</a>]</p>]]></content>
      
      
      <categories>
          
          <category> DevOps </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Jenkins </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Jenkins_æµæ°´çº¿è¯­æ³•_001</title>
      <link href="2020/05/28/devops/jenkins-liu-shui-xian-yu-fa-001/"/>
      <url>2020/05/28/devops/jenkins-liu-shui-xian-yu-fa-001/</url>
      
        <content type="html"><![CDATA[<h4 id="æµæ°´çº¿è¯­æ³•"><a href="#æµæ°´çº¿è¯­æ³•" class="headerlink" title="æµæ°´çº¿è¯­æ³•"></a>æµæ°´çº¿è¯­æ³•</h4><p>æœ¬èŠ‚æ˜¯å»ºç«‹åœ¨ <a href="https://www.jenkins.io/zh/doc/book/pipeline/getting-started" target="_blank" rel="noopener">æµæ°´çº¿å…¥é—¨</a>å†…å®¹çš„åŸºç¡€ä¸Šï¼Œè€Œä¸”ï¼Œåº”å½“è¢«å½“ä½œä¸€ä¸ªå‚è€ƒã€‚ å¯¹äºåœ¨å®é™…ç¤ºä¾‹ä¸­å¦‚ä½•ä½¿ç”¨æµæ°´çº¿è¯­æ³•çš„æ›´å¤šä¿¡æ¯, è¯·å‚é˜…æœ¬ç« åœ¨æµæ°´çº¿æ’ä»¶çš„2.5ç‰ˆæœ¬ä¸­çš„ <a href="https://www.jenkins.io/zh/doc/book/pipeline/jenkinsfile" target="_blank" rel="noopener">ä½¿ç”¨ Jenkinsfile</a>éƒ¨åˆ†, æµæ°´çº¿æ”¯æŒä¸¤ç§ç¦»æ•£çš„è¯­æ³•ï¼Œå…·ä½“å¦‚ä¸‹å¯¹äºæ¯ç§çš„ä¼˜ç¼ºç‚¹, å‚è§<a href="https://www.jenkins.io/zh/doc/book/pipeline/syntax/#compare" target="_blank" rel="noopener">è¯­æ³•æ¯”è¾ƒ</a>ã€‚</p><p>æ­£å¦‚ <a href="https://www.jenkins.io/zh/doc/book/pipeline/" target="_blank" rel="noopener">æœ¬ç« å¼€å§‹</a>è®¨è®ºçš„, æµæ°´çº¿æœ€åŸºç¡€çš„éƒ¨åˆ†æ˜¯ â€œæ­¥éª¤â€ã€‚åŸºæœ¬ä¸Š, æ­¥éª¤å‘Šè¯‰ Jenkins è¦åšä»€ä¹ˆï¼Œä»¥åŠä½œä¸ºå£°æ˜å¼å’Œè„šæœ¬åŒ–æµæ°´çº¿è¯­æ³•çš„åŸºæœ¬æ„å»ºå—ã€‚</p><p>å¯¹äºå¯ç”¨æ­¥éª¤çš„æ¦‚è¿°, è¯·å‚è€ƒ <a href="https://www.jenkins.io/doc/pipeline/steps" target="_blank" rel="noopener">æµæ°´çº¿æ­¥éª¤å¼•ç”¨</a>ï¼Œå®ƒåŒ…å«äº†ä¸€ä¸ªæ„å»ºåˆ°æµæ°´çº¿çš„æ­¥éª¤å’Œ æ’ä»¶æä¾›çš„æ­¥éª¤çš„å…¨é¢çš„åˆ—è¡¨ã€‚</p><h4 id="å£°æ˜å¼æµæ°´çº¿"><a href="#å£°æ˜å¼æµæ°´çº¿" class="headerlink" title="å£°æ˜å¼æµæ°´çº¿"></a>å£°æ˜å¼æµæ°´çº¿</h4><p>å£°æ˜å¼æµæ°´çº¿æ˜¯æœ€è¿‘æ·»åŠ åˆ° Jenkins æµæ°´çº¿çš„ [<a href="https://www.jenkins.io/zh/doc/book/pipeline/syntax/#_footnotedef_1" target="_blank" rel="noopener">1</a>]ï¼Œå®ƒåœ¨æµæ°´çº¿å­ç³»ç»Ÿä¹‹ä¸Šæä¾›äº†ä¸€ç§æ›´ç®€å•ï¼Œæ›´æœ‰ä¸»è§çš„è¯­æ³•ã€‚</p><p>æ‰€æœ‰æœ‰æ•ˆçš„å£°æ˜å¼æµæ°´çº¿å¿…é¡»åŒ…å«åœ¨ä¸€ä¸ª <code>pipeline</code> å—ä¸­, æ¯”å¦‚:</p><pre><code>pipeline {    /* insert Declarative Pipeline here */}</code></pre><p>åœ¨å£°æ˜å¼æµæ°´çº¿ä¸­æœ‰æ•ˆçš„åŸºæœ¬è¯­å¥å’Œè¡¨è¾¾å¼éµå¾ªä¸ <a href="http://groovy-lang.org/syntax.html" target="_blank" rel="noopener">Groovyçš„è¯­æ³•</a>åŒæ ·çš„è§„åˆ™ï¼Œ æœ‰ä»¥ä¸‹ä¾‹å¤–:</p><ul><li>æµæ°´çº¿é¡¶å±‚å¿…é¡»æ˜¯ä¸€ä¸ª <em>block</em>, ç‰¹åˆ«åœ°: <code>pipeline { }</code></li><li>æ²¡æœ‰åˆ†å·ä½œä¸ºè¯­å¥åˆ†éš”ç¬¦ï¼Œï¼Œæ¯æ¡è¯­å¥éƒ½å¿…é¡»åœ¨è‡ªå·±çš„è¡Œä¸Šã€‚</li><li>å—åªèƒ½ç”± <a href="https://www.jenkins.io/zh/doc/book/pipeline/syntax/#declarative-sections" target="_blank" rel="noopener">èŠ‚æ®µ</a>, <a href="https://www.jenkins.io/zh/doc/book/pipeline/syntax/#declarative-directives" target="_blank" rel="noopener">æŒ‡ä»¤</a>, <a href="https://www.jenkins.io/zh/doc/book/pipeline/syntax/#declarative-steps" target="_blank" rel="noopener">æ­¥éª¤</a>, æˆ–èµ‹å€¼è¯­å¥ç»„æˆã€‚ *å±æ€§å¼•ç”¨è¯­å¥è¢«è§†ä¸ºæ— å‚æ–¹æ³•è°ƒç”¨ã€‚ ä¾‹å¦‚, inputè¢«è§†ä¸º input()</li></ul><h3 id="èŠ‚æ®µ"><a href="#èŠ‚æ®µ" class="headerlink" title="èŠ‚æ®µ"></a>èŠ‚æ®µ</h3><p>å£°æ˜å¼æµæ°´çº¿ä¸­çš„èŠ‚æ®µé€šå¸¸åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ª <a href="https://www.jenkins.io/zh/doc/book/pipeline/syntax/#declarative-directives" target="_blank" rel="noopener">æŒ‡ä»¤</a> æˆ– <a href="https://www.jenkins.io/zh/doc/book/pipeline/syntax/#declarative-steps" target="_blank" rel="noopener">æ­¥éª¤</a>ã€‚</p><h4 id="ä»£ç†"><a href="#ä»£ç†" class="headerlink" title="ä»£ç†"></a>ä»£ç†</h4><p><code>agent</code> éƒ¨åˆ†æŒ‡å®šäº†æ•´ä¸ªæµæ°´çº¿æˆ–ç‰¹å®šçš„éƒ¨åˆ†, å°†ä¼šåœ¨Jenkinsç¯å¢ƒä¸­æ‰§è¡Œçš„ä½ç½®ï¼Œè¿™å–å†³äº <code>agent</code> åŒºåŸŸçš„ä½ç½®ã€‚è¯¥éƒ¨åˆ†å¿…é¡»åœ¨ <code>pipeline</code> å—çš„é¡¶å±‚è¢«å®šä¹‰, ä½†æ˜¯ stage çº§åˆ«çš„ä½¿ç”¨æ˜¯å¯é€‰çš„ã€‚</p><table><thead><tr><th align="left">Required</th><th>Yes</th></tr></thead><tbody><tr><td align="left">Parameters</td><td><a href="https://www.jenkins.io/zh/doc/book/pipeline/syntax/#agent-parameters" target="_blank" rel="noopener">Described below</a></td></tr><tr><td align="left">Allowed</td><td>In the top-level <code>pipeline</code> block and each <code>stage</code> block.</td></tr></tbody></table><h5 id="å‚æ•°"><a href="#å‚æ•°" class="headerlink" title="å‚æ•°"></a>å‚æ•°</h5><p>ä¸ºäº†æ”¯æŒä½œè€…å¯èƒ½æœ‰çš„å„ç§å„æ ·çš„ç”¨ä¾‹æµæ°´çº¿, <code>agent</code> éƒ¨åˆ†æ”¯æŒä¸€äº›ä¸åŒç±»å‹çš„å‚æ•°ã€‚è¿™äº›å‚æ•°åº”ç”¨åœ¨<code>pipeline</code>å—çš„é¡¶å±‚, æˆ– <code>stage</code> æŒ‡ä»¤å†…éƒ¨ã€‚</p><ul><li><p>any</p><p>åœ¨ä»»ä½•å¯ç”¨çš„ä»£ç†ä¸Šæ‰§è¡Œæµæ°´çº¿æˆ–é˜¶æ®µã€‚ä¾‹å¦‚: <code>agent any</code></p></li><li><p>none</p><p>å½“åœ¨ <code>pipeline</code> å—çš„é¡¶éƒ¨æ²¡æœ‰å…¨å±€ä»£ç†ï¼Œ è¯¥å‚æ•°å°†ä¼šè¢«åˆ†é…åˆ°æ•´ä¸ªæµæ°´çº¿çš„è¿è¡Œä¸­å¹¶ä¸”æ¯ä¸ª <code>stage</code> éƒ¨åˆ†éƒ½éœ€è¦åŒ…å«ä»–è‡ªå·±çš„ <code>agent</code> éƒ¨åˆ†ã€‚æ¯”å¦‚: <code>agent none</code></p></li><li><p>label</p><p>åœ¨æä¾›äº†æ ‡ç­¾çš„ Jenkins ç¯å¢ƒä¸­å¯ç”¨çš„ä»£ç†ä¸Šæ‰§è¡Œæµæ°´çº¿æˆ–é˜¶æ®µã€‚ ä¾‹å¦‚: <code>agent { label &#39;my-defined-label&#39; }</code></p></li><li><p>node</p><p><code>agent { node { label &#39;labelName&#39; } }</code> å’Œ <code>agent { label &#39;labelName&#39; }</code> ä¸€æ ·, ä½†æ˜¯ <code>node</code> å…è®¸é¢å¤–çš„é€‰é¡¹ (æ¯”å¦‚ <code>customWorkspace</code> )ã€‚</p></li><li><p>docker</p><p>ä½¿ç”¨ç»™å®šçš„å®¹å™¨æ‰§è¡Œæµæ°´çº¿æˆ–é˜¶æ®µã€‚è¯¥å®¹å™¨å°†åœ¨é¢„ç½®çš„ <a href="https://www.jenkins.io/zh/doc/book/pipeline/syntax/#../glossary#node" target="_blank" rel="noopener">node</a>ä¸Šï¼Œæˆ–åœ¨åŒ¹é…å¯é€‰å®šä¹‰çš„<code>label</code> å‚æ•°ä¸Šï¼ŒåŠ¨æ€çš„ä¾›åº”æ¥æ¥å—åŸºäºDockerçš„æµæ°´çº¿ã€‚ <code>docker</code> ä¹Ÿå¯ä»¥é€‰æ‹©çš„æ¥å— <code>args</code> å‚æ•°ï¼Œè¯¥å‚æ•°å¯èƒ½åŒ…å«ç›´æ¥ä¼ é€’åˆ° <code>docker run</code> è°ƒç”¨çš„å‚æ•°, ä»¥åŠ <code>alwaysPull</code> é€‰é¡¹, è¯¥é€‰é¡¹å¼ºåˆ¶ <code>docker pull</code> ï¼Œå³ä½¿é•œåƒåç§°å·²ç»å­˜åœ¨ã€‚ æ¯”å¦‚: </p><pre><code>agent {    docker {        image &#39;maven:3-alpine&#39;        label &#39;my-defined-label&#39;        args  &#39;-v /tmp:/tmp&#39;    }}</code></pre></li><li><p>dockerfile</p><p>æ‰§è¡Œæµæ°´çº¿æˆ–é˜¶æ®µ, ä½¿ç”¨ä»æºä»£ç åº“åŒ…å«çš„ <code>Dockerfile</code> æ„å»ºçš„å®¹å™¨ã€‚ä¸ºäº†ä½¿ç”¨è¯¥é€‰é¡¹ï¼Œ <code>Jenkinsfile</code> å¿…é¡»ä»å¤šä¸ªåˆ†æ”¯æµæ°´çº¿ä¸­åŠ è½½, æˆ–è€…åŠ è½½ â€œPipeline from SCM.â€ é€šå¸¸ï¼Œè¿™æ˜¯æºä»£ç ä»“åº“çš„æ ¹ç›®å½•ä¸‹çš„ <code>Dockerfile</code> : <code>agent { dockerfile true }</code>. å¦‚æœåœ¨å¦ä¸€ä¸ªç›®å½•ä¸‹æ„å»º <code>Dockerfile</code> , ä½¿ç”¨ <code>dir</code> é€‰é¡¹: <code>agent { dockerfile {dir &#39;someSubDir&#39; } }</code>ã€‚å¦‚æœ <code>Dockerfile</code> æœ‰å¦ä¸€ä¸ªåç§°, ä½ å¯ä»¥ä½¿ç”¨ <code>filename</code> é€‰é¡¹æŒ‡å®šè¯¥æ–‡ä»¶åã€‚ä½ å¯ä»¥ä¼ é€’é¢å¤–çš„å‚æ•°åˆ° <code>docker build ...</code> ä½¿ç”¨ <code>additionalBuildArgs</code> é€‰é¡¹æäº¤, æ¯”å¦‚ <code>agent { dockerfile {additionalBuildArgs &#39;--build-arg foo=bar&#39; } }</code>ã€‚ ä¾‹å¦‚, ä¸€ä¸ªå¸¦æœ‰ <code>build/Dockerfile.build</code> çš„ä»“åº“,æœŸæœ›ä¸€ä¸ªæ„å»ºå‚æ•° <code>version</code>:</p><pre><code>agent {    // Equivalent to &quot;docker build -f Dockerfile.build --build-arg version=1.0.2 ./build/    dockerfile {        filename &#39;Dockerfile.build&#39;        dir &#39;build&#39;        label &#39;my-defined-label&#39;        additionalBuildArgs  &#39;--build-arg version=1.0.2&#39;    }}</code></pre></li></ul><h5 id="å¸¸è§é€‰é¡¹"><a href="#å¸¸è§é€‰é¡¹" class="headerlink" title="å¸¸è§é€‰é¡¹"></a>å¸¸è§é€‰é¡¹</h5><p>æœ‰ä¸€äº›åº”ç”¨äºä¸¤ä¸ªæˆ–æ›´å¤š <code>agent</code> çš„å®ç°çš„é€‰é¡¹ã€‚ä»–ä»¬ä¸è¢«è¦æ±‚ï¼Œé™¤éç‰¹åˆ«è§„å®šã€‚</p><ul><li><p>label</p><p>ä¸€ä¸ªå­—ç¬¦ä¸²ã€‚è¯¥æ ‡ç­¾ç”¨äºè¿è¡Œæµæ°´çº¿æˆ–ä¸ªåˆ«çš„ <code>stage</code>ã€‚è¯¥é€‰é¡¹å¯¹ <code>node</code>, <code>docker</code> å’Œ <code>dockerfile</code> å¯ç”¨, <code>node</code>è¦æ±‚å¿…é¡»é€‰æ‹©è¯¥é€‰é¡¹ã€‚</p></li><li><p>customWorkspace</p><p>ä¸€ä¸ªå­—ç¬¦ä¸²ã€‚åœ¨è‡ªå®šä¹‰å·¥ä½œåŒºè¿è¡Œåº”ç”¨äº† <code>agent</code> çš„æµæ°´çº¿æˆ–ä¸ªåˆ«çš„ <code>stage</code>, è€Œä¸æ˜¯é»˜è®¤å€¼ã€‚ å®ƒæ—¢å¯ä»¥æ˜¯ä¸€ä¸ªç›¸å¯¹è·¯å¾„, åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè‡ªå®šä¹‰å·¥ä½œåŒºä¼šå­˜åœ¨äºèŠ‚ç‚¹å·¥ä½œåŒºæ ¹ç›®å½•ä¸‹, æˆ–è€…ä¸€ä¸ªç»å¯¹è·¯å¾„ã€‚æ¯”å¦‚:</p><pre><code>agent {    node {        label &#39;my-defined-label&#39;        customWorkspace &#39;/some/other/path&#39;    }}</code></pre><p>è¯¥é€‰é¡¹å¯¹ <code>node</code>, <code>docker</code> å’Œ <code>dockerfile</code> æœ‰ç”¨ ã€‚</p></li><li><p>reuseNode</p><p>ä¸€ä¸ªå¸ƒå°”å€¼, é»˜è®¤ä¸ºfalseã€‚ å¦‚æœæ˜¯true, åˆ™åœ¨æµæ°´çº¿çš„é¡¶å±‚æŒ‡å®šçš„èŠ‚ç‚¹ä¸Šè¿è¡Œè¯¥å®¹å™¨, åœ¨åŒæ ·çš„å·¥ä½œåŒº, è€Œä¸æ˜¯åœ¨ä¸€ä¸ªå…¨æ–°çš„èŠ‚ç‚¹ä¸Šã€‚è¿™ä¸ªé€‰é¡¹å¯¹ <code>docker</code> å’Œ <code>dockerfile</code> æœ‰ç”¨, å¹¶ä¸”åªæœ‰å½“ ä½¿ç”¨åœ¨ä¸ªåˆ«çš„ <code>stage</code> çš„ <code>agent</code> ä¸Šæ‰ä¼šæœ‰æ•ˆã€‚</p></li></ul><h5 id="ç¤ºä¾‹"><a href="#ç¤ºä¾‹" class="headerlink" title="ç¤ºä¾‹"></a>ç¤ºä¾‹</h5><p>Jenkinsfile (Declarative Pipeline)</p><pre class=" language-groovy"><code class="language-groovy">pipeline <span class="token punctuation">{</span>    agent <span class="token punctuation">{</span> docker <span class="token string">'maven:3-alpine'</span> <span class="token punctuation">}</span>     stages <span class="token punctuation">{</span>        <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'Example Build'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            steps <span class="token punctuation">{</span>                sh <span class="token string">'mvn -B clean verify'</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><table><thead><tr><th></th><th>åœ¨ä¸€ä¸ªç»™å®šåç§°å’Œæ ‡ç­¾(<code>maven:3-alpine</code>)çš„æ–°å»ºçš„å®¹å™¨ä¸Šæ‰§è¡Œå®šä¹‰åœ¨æµæ°´çº¿ä¸­çš„æ‰€æœ‰æ­¥éª¤ ã€‚</th></tr></thead><tbody><tr><td></td><td></td></tr></tbody></table><h6 id="é˜¶æ®µçº§åˆ«çš„-agent-éƒ¨åˆ†"><a href="#é˜¶æ®µçº§åˆ«çš„-agent-éƒ¨åˆ†" class="headerlink" title="é˜¶æ®µçº§åˆ«çš„ agent éƒ¨åˆ†"></a>é˜¶æ®µçº§åˆ«çš„ <code>agent</code> éƒ¨åˆ†</h6><p>Jenkinsfile (Declarative Pipeline)</p><pre class=" language-groovy"><code class="language-groovy">pipeline <span class="token punctuation">{</span>    agent none     stages <span class="token punctuation">{</span>        <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'Example Build'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            agent <span class="token punctuation">{</span> docker <span class="token string">'maven:3-alpine'</span> <span class="token punctuation">}</span>             steps <span class="token punctuation">{</span>                echo <span class="token string">'Hello, Maven'</span>                sh <span class="token string">'mvn --version'</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'Example Test'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            agent <span class="token punctuation">{</span> docker <span class="token string">'openjdk:8-jre'</span> <span class="token punctuation">}</span>             steps <span class="token punctuation">{</span>                echo <span class="token string">'Hello, JDK'</span>                sh <span class="token string">'java -version'</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><table><thead><tr><th></th><th>åœ¨æµæ°´çº¿é¡¶å±‚å®šä¹‰ <code>agent none</code> ç¡®ä¿ <a href="https://www.jenkins.io/zh/doc/book/pipeline/syntax/#../glossary#executor" target="_blank" rel="noopener">an Executor</a> æ²¡æœ‰è¢«åˆ†é…ã€‚ ä½¿ç”¨ <code>agent none</code> ä¹Ÿä¼šå¼ºåˆ¶ <code>stage</code> éƒ¨åˆ†åŒ…å«ä»–è‡ªå·±çš„ <code>agent</code> éƒ¨åˆ†ã€‚</th></tr></thead><tbody><tr><td></td><td>ä½¿ç”¨é•œåƒåœ¨ä¸€ä¸ªæ–°å»ºçš„å®¹å™¨ä¸­æ‰§è¡Œè¯¥é˜¶æ®µçš„è¯¥æ­¥éª¤ã€‚</td></tr><tr><td></td><td>ä½¿ç”¨ä¸€ä¸ªä¸ä¹‹å‰é˜¶æ®µä¸åŒçš„é•œåƒåœ¨ä¸€ä¸ªæ–°å»ºçš„å®¹å™¨ä¸­æ‰§è¡Œè¯¥é˜¶æ®µçš„è¯¥æ­¥éª¤ã€‚</td></tr></tbody></table><h4 id="post"><a href="#post" class="headerlink" title="post"></a>post</h4><p><code>post</code> éƒ¨åˆ†å®šä¹‰ä¸€ä¸ªæˆ–å¤šä¸ª<a href="https://www.jenkins.io/zh/doc/book/pipeline/syntax/#declarative-steps" target="_blank" rel="noopener">steps</a> ï¼Œè¿™äº›é˜¶æ®µæ ¹æ®æµæ°´çº¿æˆ–é˜¶æ®µçš„å®Œæˆæƒ…å†µè€Œ è¿è¡Œ(å–å†³äºæµæ°´çº¿ä¸­ <code>post</code> éƒ¨åˆ†çš„ä½ç½®). <code>post</code> æ”¯æŒä»¥ä¸‹ <a href="https://www.jenkins.io/zh/doc/book/pipeline/syntax/#post-conditions" target="_blank" rel="noopener">post-condition</a> å—ä¸­çš„å…¶ä¸­ä¹‹ä¸€: <code>always</code>, <code>changed</code>, <code>failure</code>, <code>success</code>, <code>unstable</code>, å’Œ <code>aborted</code>ã€‚è¿™äº›æ¡ä»¶å—å…è®¸åœ¨ <code>post</code> éƒ¨åˆ†çš„æ­¥éª¤çš„æ‰§è¡Œå–å†³äºæµæ°´çº¿æˆ–é˜¶æ®µçš„å®ŒæˆçŠ¶æ€ã€‚</p><table><thead><tr><th align="left">Required</th><th>No</th></tr></thead><tbody><tr><td align="left">Parameters</td><td><em>None</em></td></tr><tr><td align="left">Allowed</td><td>In the top-level <code>pipeline</code> block and each <code>stage</code> block.</td></tr></tbody></table><h5 id="Conditions"><a href="#Conditions" class="headerlink" title="Conditions"></a>Conditions</h5><ul><li><p><code>always</code></p><p>æ— è®ºæµæ°´çº¿æˆ–é˜¶æ®µçš„å®ŒæˆçŠ¶æ€å¦‚ä½•ï¼Œéƒ½å…è®¸åœ¨ <code>post</code> éƒ¨åˆ†è¿è¡Œè¯¥æ­¥éª¤ã€‚</p></li><li><p><code>changed</code></p><p>åªæœ‰å½“å‰æµæ°´çº¿æˆ–é˜¶æ®µçš„å®ŒæˆçŠ¶æ€ä¸å®ƒä¹‹å‰çš„è¿è¡Œä¸åŒæ—¶ï¼Œæ‰å…è®¸åœ¨ <code>post</code> éƒ¨åˆ†è¿è¡Œè¯¥æ­¥éª¤ã€‚</p></li><li><p><code>failure</code></p><p>åªæœ‰å½“å‰æµæ°´çº¿æˆ–é˜¶æ®µçš„å®ŒæˆçŠ¶æ€ä¸ºâ€failureâ€ï¼Œæ‰å…è®¸åœ¨ <code>post</code> éƒ¨åˆ†è¿è¡Œè¯¥æ­¥éª¤, é€šå¸¸web UIæ˜¯çº¢è‰²ã€‚</p></li><li><p><code>success</code></p><p>åªæœ‰å½“å‰æµæ°´çº¿æˆ–é˜¶æ®µçš„å®ŒæˆçŠ¶æ€ä¸ºâ€successâ€ï¼Œæ‰å…è®¸åœ¨ <code>post</code> éƒ¨åˆ†è¿è¡Œè¯¥æ­¥éª¤, é€šå¸¸web UIæ˜¯è“è‰²æˆ–ç»¿è‰²ã€‚</p></li><li><p><code>unstable</code></p><p>åªæœ‰å½“å‰æµæ°´çº¿æˆ–é˜¶æ®µçš„å®ŒæˆçŠ¶æ€ä¸ºâ€unstableâ€ï¼Œæ‰å…è®¸åœ¨ <code>post</code> éƒ¨åˆ†è¿è¡Œè¯¥æ­¥éª¤, é€šå¸¸ç”±äºæµ‹è¯•å¤±è´¥,ä»£ç è¿è§„ç­‰é€ æˆã€‚é€šå¸¸web UIæ˜¯é»„è‰²ã€‚</p></li><li><p><code>aborted</code></p><p>åªæœ‰å½“å‰æµæ°´çº¿æˆ–é˜¶æ®µçš„å®ŒæˆçŠ¶æ€ä¸ºâ€abortedâ€ï¼Œæ‰å…è®¸åœ¨ <code>post</code> éƒ¨åˆ†è¿è¡Œè¯¥æ­¥éª¤, é€šå¸¸ç”±äºæµæ°´çº¿è¢«æ‰‹åŠ¨çš„abortedã€‚é€šå¸¸web UIæ˜¯ç°è‰²ã€‚</p></li></ul><h5 id="ç¤ºä¾‹-1"><a href="#ç¤ºä¾‹-1" class="headerlink" title="ç¤ºä¾‹"></a>ç¤ºä¾‹</h5><p>Jenkinsfile (Declarative Pipeline)</p><pre class=" language-groovy"><code class="language-groovy">pipeline <span class="token punctuation">{</span>    agent any    stages <span class="token punctuation">{</span>        <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'Example'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            steps <span class="token punctuation">{</span>                echo <span class="token string">'Hello World'</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    post <span class="token punctuation">{</span>         always <span class="token punctuation">{</span>             echo <span class="token string">'I will always say Hello again!'</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><table><thead><tr><th></th><th>æŒ‰ç…§æƒ¯ä¾‹, <code>post</code> éƒ¨åˆ†åº”è¯¥æ”¾åœ¨æµæ°´çº¿çš„åº•éƒ¨ã€‚</th></tr></thead><tbody><tr><td></td><td><a href="https://www.jenkins.io/zh/doc/book/pipeline/syntax/#post-conditions" target="_blank" rel="noopener">Post-condition</a> å—åŒ…å«ä¸ <a href="https://www.jenkins.io/zh/doc/book/pipeline/syntax/#steps" target="_blank" rel="noopener">steps</a> éƒ¨åˆ†ç›¸åŒçš„<a href="https://www.jenkins.io/zh/doc/book/pipeline/syntax/#declarative-steps" target="_blank" rel="noopener">steps</a>ã€‚</td></tr></tbody></table><h4 id="stages"><a href="#stages" class="headerlink" title="stages"></a>stages</h4><p>åŒ…å«ä¸€ç³»åˆ—ä¸€ä¸ªæˆ–å¤šä¸ª <a href="https://www.jenkins.io/zh/doc/book/pipeline/syntax/#stage" target="_blank" rel="noopener">stage</a> æŒ‡ä»¤, <code>stages</code> éƒ¨åˆ†æ˜¯æµæ°´çº¿æè¿°çš„å¤§éƒ¨åˆ†â€workâ€ çš„ä½ç½®ã€‚ å»ºè®® <code>stages</code> è‡³å°‘åŒ…å«ä¸€ä¸ª <a href="https://www.jenkins.io/zh/doc/book/pipeline/syntax/#stage" target="_blank" rel="noopener">stage</a> æŒ‡ä»¤ç”¨äºè¿ç»­äº¤ä»˜è¿‡ç¨‹çš„æ¯ä¸ªç¦»æ•£éƒ¨åˆ†,æ¯”å¦‚æ„å»º, æµ‹è¯•, å’Œéƒ¨ç½²ã€‚</p><table><thead><tr><th align="left">Required</th><th>Yes</th></tr></thead><tbody><tr><td align="left">Parameters</td><td><em>None</em></td></tr><tr><td align="left">Allowed</td><td>Only once, inside the <code>pipeline</code> block.</td></tr></tbody></table><h5 id="ç¤ºä¾‹-2"><a href="#ç¤ºä¾‹-2" class="headerlink" title="ç¤ºä¾‹"></a>ç¤ºä¾‹</h5><p>Jenkinsfile (Declarative Pipeline)</p><pre class=" language-groovy"><code class="language-groovy">pipeline <span class="token punctuation">{</span>    agent any    stages <span class="token punctuation">{</span>         <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'Example'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            steps <span class="token punctuation">{</span>                echo <span class="token string">'Hello World'</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><table><thead><tr><th></th><th><code>stages</code> éƒ¨åˆ†é€šå¸¸ä¼šéµå¾ªè¯¸å¦‚ <code>agent</code>, <code>options</code> ç­‰çš„æŒ‡ä»¤ã€‚</th></tr></thead><tbody><tr><td></td><td></td></tr></tbody></table><h4 id="steps"><a href="#steps" class="headerlink" title="steps"></a>steps</h4><p><code>steps</code> éƒ¨åˆ†åœ¨ç»™å®šçš„ <code>stage</code> æŒ‡ä»¤ä¸­æ‰§è¡Œçš„å®šä¹‰äº†ä¸€ç³»åˆ—çš„ä¸€ä¸ªæˆ–å¤šä¸ª<a href="https://www.jenkins.io/zh/doc/book/pipeline/syntax/#declarative-steps" target="_blank" rel="noopener">steps</a>ã€‚</p><table><thead><tr><th align="left">Required</th><th>Yes</th></tr></thead><tbody><tr><td align="left">Parameters</td><td><em>None</em></td></tr><tr><td align="left">Allowed</td><td>Inside each <code>stage</code> block.</td></tr></tbody></table><h5 id="ç¤ºä¾‹-3"><a href="#ç¤ºä¾‹-3" class="headerlink" title="ç¤ºä¾‹"></a>ç¤ºä¾‹</h5><p>Jenkinsfile (Declarative Pipeline)</p><pre class=" language-groovy"><code class="language-groovy">pipeline <span class="token punctuation">{</span>    agent any    stages <span class="token punctuation">{</span>        <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'Example'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            steps <span class="token punctuation">{</span>                 echo <span class="token string">'Hello World'</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p><code>steps</code> éƒ¨åˆ†å¿…é¡»åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªæ­¥éª¤ã€‚</p><h3 id="æŒ‡ä»¤"><a href="#æŒ‡ä»¤" class="headerlink" title="æŒ‡ä»¤"></a>æŒ‡ä»¤</h3><h4 id="environment"><a href="#environment" class="headerlink" title="environment"></a>environment</h4><p><code>environment</code> æŒ‡ä»¤åˆ¶å®šä¸€ä¸ª é”®-å€¼å¯¹åºåˆ—ï¼Œè¯¥åºåˆ—å°†è¢«å®šä¹‰ä¸ºæ‰€æœ‰æ­¥éª¤çš„ç¯å¢ƒå˜é‡ï¼Œæˆ–è€…æ˜¯ç‰¹å®šäºé˜¶æ®µçš„æ­¥éª¤ï¼Œ è¿™å–å†³äº <code>environment</code> æŒ‡ä»¤åœ¨æµæ°´çº¿å†…çš„ä½ç½®ã€‚</p><p>è¯¥æŒ‡ä»¤æ”¯æŒä¸€ä¸ªç‰¹æ®Šçš„åŠ©æ‰‹æ–¹æ³• <code>credentials()</code> ï¼Œè¯¥æ–¹æ³•å¯ç”¨äºåœ¨Jenkinsç¯å¢ƒä¸­é€šè¿‡æ ‡è¯†ç¬¦è®¿é—®é¢„å®šä¹‰çš„å‡­è¯ã€‚å¯¹äºç±»å‹ä¸º â€œSecret Textâ€çš„å‡­è¯, <code>credentials()</code> å°†ç¡®ä¿æŒ‡å®šçš„ç¯å¢ƒå˜é‡åŒ…å«ç§˜å¯†æ–‡æœ¬å†…å®¹ã€‚å¯¹äºç±»å‹ä¸º â€œSStandard username and passwordâ€çš„å‡­è¯, æŒ‡å®šçš„ç¯å¢ƒå˜é‡æŒ‡å®šä¸º <code>username:password</code> ï¼Œå¹¶ä¸”ä¸¤ä¸ªé¢å¤–çš„ç¯å¢ƒå˜é‡å°†è¢«è‡ªåŠ¨å®šä¹‰ :åˆ†åˆ«ä¸º <code>MYVARNAME_USR</code> å’Œ <code>MYVARNAME_PSW</code> ã€‚</p><table><thead><tr><th align="left">Required</th><th>No</th></tr></thead><tbody><tr><td align="left">Parameters</td><td><em>None</em></td></tr><tr><td align="left">Allowed</td><td>Inside the <code>pipeline</code> block, or within <code>stage</code> directives.</td></tr></tbody></table><h5 id="ç¤ºä¾‹-4"><a href="#ç¤ºä¾‹-4" class="headerlink" title="ç¤ºä¾‹"></a>ç¤ºä¾‹</h5><p>Jenkinsfile (Declarative Pipeline)</p><pre class=" language-groovy"><code class="language-groovy">pipeline <span class="token punctuation">{</span>    agent any    environment <span class="token punctuation">{</span>         CC <span class="token operator">=</span> <span class="token string">'clang'</span>    <span class="token punctuation">}</span>    stages <span class="token punctuation">{</span>        <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'Example'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            environment <span class="token punctuation">{</span>                 AN_ACCESS_KEY <span class="token operator">=</span> <span class="token function">credentials</span><span class="token punctuation">(</span><span class="token string">'my-prefined-secret-text'</span><span class="token punctuation">)</span>             <span class="token punctuation">}</span>            steps <span class="token punctuation">{</span>                sh <span class="token string">'printenv'</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><table><thead><tr><th></th><th>é¡¶å±‚æµæ°´çº¿å—ä¸­ä½¿ç”¨çš„ <code>environment</code> æŒ‡ä»¤å°†é€‚ç”¨äºæµæ°´çº¿ä¸­çš„æ‰€æœ‰æ­¥éª¤ã€‚</th></tr></thead><tbody><tr><td></td><td>åœ¨ä¸€ä¸ª <code>stage</code> ä¸­å®šä¹‰çš„ <code>environment</code> æŒ‡ä»¤åªä¼šå°†ç»™å®šçš„ç¯å¢ƒå˜é‡åº”ç”¨äº <code>stage</code> ä¸­çš„æ­¥éª¤ã€‚</td></tr><tr><td></td><td><code>environment</code> å—æœ‰ä¸€ä¸ª åŠ©æ‰‹æ–¹æ³• <code>credentials()</code> å®šä¹‰ï¼Œè¯¥æ–¹æ³•å¯ä»¥åœ¨ Jenkins ç¯å¢ƒä¸­ç”¨äºé€šè¿‡æ ‡è¯†ç¬¦è®¿é—®é¢„å®šä¹‰çš„å‡­è¯ã€‚</td></tr></tbody></table><h4 id="options"><a href="#options" class="headerlink" title="options"></a>options</h4><p><code>options</code> æŒ‡ä»¤å…è®¸ä»æµæ°´çº¿å†…éƒ¨é…ç½®ç‰¹å®šäºæµæ°´çº¿çš„é€‰é¡¹ã€‚ æµæ°´çº¿æä¾›äº†è®¸å¤šè¿™æ ·çš„é€‰é¡¹, æ¯”å¦‚ <code>buildDiscarder</code>,ä½†ä¹Ÿå¯ä»¥ç”±æ’ä»¶æä¾›, æ¯”å¦‚ <code>timestamps</code>.</p><table><thead><tr><th align="left">Required</th><th>No</th></tr></thead><tbody><tr><td align="left">Parameters</td><td><em>None</em></td></tr><tr><td align="left">Allowed</td><td>Only once, inside the <code>pipeline</code> block.</td></tr></tbody></table><h5 id="å¯ç”¨é€‰é¡¹"><a href="#å¯ç”¨é€‰é¡¹" class="headerlink" title="å¯ç”¨é€‰é¡¹"></a>å¯ç”¨é€‰é¡¹</h5><ul><li><p>buildDiscarder</p><p>ä¸ºæœ€è¿‘çš„æµæ°´çº¿è¿è¡Œçš„ç‰¹å®šæ•°é‡ä¿å­˜ç»„ä»¶å’Œæ§åˆ¶å°è¾“å‡ºã€‚ä¾‹å¦‚: <code>options { buildDiscarder(logRotator(numToKeepStr: &#39;1&#39;)) }</code></p></li><li><p>disableConcurrentBuilds</p><p>ä¸å…è®¸åŒæ—¶æ‰§è¡Œæµæ°´çº¿ã€‚ å¯è¢«ç”¨æ¥é˜²æ­¢åŒæ—¶è®¿é—®å…±äº«èµ„æºç­‰ã€‚ ä¾‹å¦‚: <code>options { disableConcurrentBuilds() }</code></p></li><li><p>overrideIndexTriggers</p><p>å…è®¸è¦†ç›–åˆ†æ”¯ç´¢å¼•è§¦å‘å™¨çš„é»˜è®¤å¤„ç†ã€‚ å¦‚æœåˆ†æ”¯ç´¢å¼•è§¦å‘å™¨åœ¨å¤šåˆ†æ”¯æˆ–ç»„ç»‡æ ‡ç­¾ä¸­ç¦ç”¨, <code>options { overrideIndexTriggers(true) }</code> å°†åªå…è®¸å®ƒä»¬ç”¨äºä¿ƒå·¥ä½œã€‚å¦åˆ™, <code>options { overrideIndexTriggers(false) }</code> åªä¼šç¦ç”¨æ”¹ä½œä¸šçš„åˆ†æ”¯ç´¢å¼•è§¦å‘å™¨ã€‚</p></li><li><p>skipDefaultCheckout</p><p>åœ¨<code>agent</code> æŒ‡ä»¤ä¸­ï¼Œè·³è¿‡ä»æºä»£ç æ§åˆ¶ä¸­æ£€å‡ºä»£ç çš„é»˜è®¤æƒ…å†µã€‚ä¾‹å¦‚: <code>options { skipDefaultCheckout() }</code></p></li><li><p>skipStagesAfterUnstable</p><p>ä¸€æ—¦æ„å»ºçŠ¶æ€å˜å¾—UNSTABLEï¼Œè·³è¿‡è¯¥é˜¶æ®µã€‚ä¾‹å¦‚: <code>options { skipStagesAfterUnstable() }</code></p></li><li><p>checkoutToSubdirectory</p><p>åœ¨å·¥ä½œç©ºé—´çš„å­ç›®å½•ä¸­è‡ªåŠ¨åœ°æ‰§è¡Œæºä»£ç æ§åˆ¶æ£€å‡ºã€‚ä¾‹å¦‚: <code>options { checkoutToSubdirectory(&#39;foo&#39;) }</code></p></li><li><p>timeout</p><p>è®¾ç½®æµæ°´çº¿è¿è¡Œçš„è¶…æ—¶æ—¶é—´, åœ¨æ­¤ä¹‹åï¼ŒJenkinså°†ä¸­æ­¢æµæ°´çº¿ã€‚ä¾‹å¦‚: <code>options { timeout(time: 1, unit: &#39;HOURS&#39;) }</code></p></li><li><p>retry</p><p>åœ¨å¤±è´¥æ—¶, é‡æ–°å°è¯•æ•´ä¸ªæµæ°´çº¿çš„æŒ‡å®šæ¬¡æ•°ã€‚ For example: <code>options { retry(3) }</code></p></li><li><p>timestamps</p><p>é¢„è°‹æ‰€æœ‰ç”±æµæ°´çº¿ç”Ÿæˆçš„æ§åˆ¶å°è¾“å‡ºï¼Œä¸è¯¥æµæ°´çº¿å‘å‡ºçš„æ—¶é—´ä¸€è‡´ã€‚ ä¾‹å¦‚: <code>options { timestamps() }</code></p></li></ul><h5 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h5><p>Jenkinsfile (Declarative Pipeline)</p><pre class=" language-groovy"><code class="language-groovy">pipeline <span class="token punctuation">{</span>    agent any    options <span class="token punctuation">{</span>        <span class="token function">timeout</span><span class="token punctuation">(</span>time<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> unit<span class="token punctuation">:</span> <span class="token string">'HOURS'</span><span class="token punctuation">)</span>     <span class="token punctuation">}</span>    stages <span class="token punctuation">{</span>        <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'Example'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            steps <span class="token punctuation">{</span>                echo <span class="token string">'Hello World'</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><table><thead><tr><th></th><th>æŒ‡å®šä¸€ä¸ªå°æ—¶çš„å…¨å±€æ‰§è¡Œè¶…æ—¶, åœ¨æ­¤ä¹‹åï¼ŒJenkins å°†ä¸­æ­¢æµæ°´çº¿è¿è¡Œã€‚</th></tr></thead><tbody><tr><td></td><td></td></tr></tbody></table><table><thead><tr><th></th><th>ä¸€ä¸ªå®Œæ•´çš„å¯ç”¨é€‰é¡¹åˆ—è¡¨æ­£åœ¨ç­‰å¾…å®Œæˆç¬¬ <a href="https://issues.jenkins-ci.org/browse/INFRA-1053" target="_blank" rel="noopener">INFRA-1503</a>æ¬¡ã€‚</th></tr></thead><tbody><tr><td></td><td></td></tr></tbody></table><h5 id="é˜¶æ®µé€‰é¡¹"><a href="#é˜¶æ®µé€‰é¡¹" class="headerlink" title="é˜¶æ®µé€‰é¡¹"></a>é˜¶æ®µé€‰é¡¹</h5><p><code>stage</code> çš„ <code>options</code> æŒ‡ä»¤ç±»ä¼¼äºæµæ°´çº¿æ ¹ç›®å½•ä¸Šçš„ <code>options</code> æŒ‡ä»¤ã€‚ç„¶è€Œï¼Œ <code>stage</code> -çº§åˆ« <code>options</code> åªèƒ½åŒ…æ‹¬ <code>retry</code>, <code>timeout</code>, æˆ– <code>timestamps</code> ç­‰æ­¥éª¤, æˆ–ä¸ <code>stage</code> ç›¸å…³çš„å£°æ˜å¼é€‰é¡¹ï¼Œå¦‚ <code>skipDefaultCheckout</code>ã€‚</p><p>åœ¨<code>stage</code>, <code>options</code> æŒ‡ä»¤ä¸­çš„æ­¥éª¤åœ¨è¿›å…¥ <code>agent</code> ä¹‹å‰è¢«è°ƒç”¨æˆ–åœ¨ <code>when</code> æ¡ä»¶å‡ºç°æ—¶è¿›è¡Œæ£€æŸ¥ã€‚</p><h6 id="å¯é€‰çš„é˜¶æ®µé€‰é¡¹"><a href="#å¯é€‰çš„é˜¶æ®µé€‰é¡¹" class="headerlink" title="å¯é€‰çš„é˜¶æ®µé€‰é¡¹"></a>å¯é€‰çš„é˜¶æ®µé€‰é¡¹</h6><ul><li><p>skipDefaultCheckout</p><p>åœ¨ <code>agent</code> æŒ‡ä»¤ä¸­è·³è¿‡é»˜è®¤çš„ä»æºä»£ç æ§åˆ¶ä¸­æ£€å‡ºä»£ç ã€‚ä¾‹å¦‚: <code>options { skipDefaultCheckout() }</code></p></li><li><p>timeout</p><p>è®¾ç½®æ­¤é˜¶æ®µçš„è¶…æ—¶æ—¶é—´, åœ¨æ­¤ä¹‹åï¼Œ Jenkins ä¼šç»ˆæ­¢è¯¥é˜¶æ®µã€‚ ä¾‹å¦‚: <code>options { timeout(time: 1, unit: &#39;HOURS&#39;) }</code></p></li><li><p>retry</p><p>åœ¨å¤±è´¥æ—¶, é‡è¯•æ­¤é˜¶æ®µæŒ‡å®šæ¬¡æ•°ã€‚ ä¾‹å¦‚: <code>options { retry(3) }</code></p></li><li><p>timestamps</p><p>é¢„è°‹æ­¤é˜¶æ®µç”Ÿæˆçš„æ‰€æœ‰æ§åˆ¶å°è¾“å‡ºä»¥åŠè¯¥è¡Œå‘å‡ºçš„æ—¶é—´ä¸€è‡´ã€‚ä¾‹å¦‚: <code>options { timestamps() }</code></p></li></ul><h6 id="ç¤ºä¾‹-5"><a href="#ç¤ºä¾‹-5" class="headerlink" title="ç¤ºä¾‹"></a>ç¤ºä¾‹</h6><p>Jenkinsfile (Declarative Pipeline)</p><pre class=" language-groovy"><code class="language-groovy">pipeline <span class="token punctuation">{</span>    agent any    stages <span class="token punctuation">{</span>        <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'Example'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            options <span class="token punctuation">{</span>                <span class="token function">timeout</span><span class="token punctuation">(</span>time<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> unit<span class="token punctuation">:</span> <span class="token string">'HOURS'</span><span class="token punctuation">)</span>             <span class="token punctuation">}</span>            steps <span class="token punctuation">{</span>                echo <span class="token string">'Hello World'</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>æŒ‡å®š <code>Example</code> é˜¶æ®µçš„æ‰§è¡Œè¶…æ—¶æ—¶é—´, åœ¨æ­¤ä¹‹åï¼ŒJenkins å°†ä¸­æ­¢æµæ°´çº¿è¿è¡Œã€‚</p>]]></content>
      
      
      <categories>
          
          <category> DevOps </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Jenkins </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç³»ç»Ÿè°ƒä¼˜</title>
      <link href="2020/05/26/interview/xi-tong-diao-you/"/>
      <url>2020/05/26/interview/xi-tong-diao-you/</url>
      
        <content type="html"><![CDATA[<p>PSï¼šä»¥ä¸‹å†…å®¹ï¼Œç½‘å‹æä¾›    æ¬¢è¿æŠ•ç¨¿     <a href="mailto:cyylog@aliyun.com">cyylog@aliyun.com</a></p><h3 id="æ€§èƒ½ä¼˜åŒ–"><a href="#æ€§èƒ½ä¼˜åŒ–" class="headerlink" title="æ€§èƒ½ä¼˜åŒ–"></a>æ€§èƒ½ä¼˜åŒ–</h3><p><strong>ä¼˜åŒ–çš„ç›®çš„</strong></p><pre><code>1. æé«˜èµ„æºçš„åˆ©ç”¨ç‡2. æ‰¾åˆ°æ€§èƒ½ç“¶é¢ˆä»¥åŠç¼“è§£è¿™ä¸ªç“¶é¢ˆï¼ˆCPUï¼Œå†…å­˜ï¼ŒIOè°ƒåº¦ã€ç½‘ç»œã€ä½¿ç”¨çš„åº”ç”¨ç¨‹åºï¼‰3. é€šè¿‡æ€§èƒ½ç®¡ç†å®ç°åˆç†çš„èµ„æºåˆ†é…ï¼Œä»¥åŠæå‡ç¡¬ä»¶çš„æ€§ä»·æ¯”4. é€šå¸¸åšä¸¤ç§è°ƒä¼˜ï¼š    response time:  å“åº”æ—¶é—´   WebæœåŠ¡å™¨ï¼Œç”¨æˆ·æ„Ÿå—åº¦å¥½    throughput:         ååé‡       æ–‡ä»¶æœåŠ¡å™¨ï¼Œæ‹·è´çš„é€Ÿåº¦</code></pre><p><strong>è°ƒä¼˜éœ€è¦æŒæ¡çš„æŠ€èƒ½ï¼š</strong></p><pre><code>ç³»ç»Ÿå½“å‰çŠ¶å†µå¦‚ä½•æ˜¯ä¸æ˜¯æœ‰ç“¶é¢ˆçš„1. å¿…é¡»äº†è§£ç¡¬ä»¶å’Œè½¯ä»¶2. èƒ½å¤ŸæŠŠæ‰€æœ‰çš„æ€§èƒ½ã€æŒ‡æ ‡é‡åŒ–ï¼Œç”¨æ•°å­—è¯´è¯3. è®¾ç½®ä¸€ä¸ªæ­£å¸¸æœŸå¾…å€¼ï¼Œæ¯”å¦‚å°†å“åº”é€Ÿåº¦è°ƒåˆ°1.5ç§’   ï¼ˆä¼ä¸šç‰ˆæ“ä½œç³»ç»Ÿåœ¨å‡ºå‚æ—¶å·²ç»è°ƒä¼˜ï¼Œé€‚ç”¨äºæ™®éçš„åº”ç”¨ï¼Œå†æ ¹æ®ä¸ªäººçš„ç¯å¢ƒè¿›è¡Œå¾®è°ƒï¼‰4. å»ºè®®æœ‰ä¸€å®šçš„å¼€å‘èƒ½åŠ›5. æƒ³è¦æ›´å¥½çš„è°ƒä¼˜ï¼Œéœ€è¦æ›´å¤šçš„ç»éªŒçš„ç§¯ç´¯ï¼Œä»è€Œæœ‰ä¸€å®šæ´å¯ŸåŠ›ï¼Œè°ƒèŠ‚æ—¶æ‰€ç»™å‚æ•°æ‰æœ€æ°å½“</code></pre><p><strong>æ€§èƒ½è°ƒä¼˜åˆ†å±‚åŠæ•ˆç‡é—®é¢˜ï¼š</strong></p><pre><code>- ä¸šåŠ¡çº§è°ƒä¼˜                ä¾‹å¦‚ï¼šç½‘ç«™ä¸€å®šè¦ä½¿ç”¨Apacheå—?    ä¾‹å¦‚ï¼šå°†åŸæœ‰çš„è°ƒåº¦å™¨ç”±LVSæ¢æˆF5-BigIPï¼Ÿ redware    ä¾‹å¦‚ï¼šå°†åŸæœ‰çš„è°ƒåº¦å™¨ç”±Nginxæ¢æˆHaproxyï¼Ÿ    ä¾‹å¦‚ï¼šèƒ½ä¸èƒ½è´­ä¹°CDNï¼Ÿ        å†…å®¹å‘å¸ƒç½‘ç»œ    ä¾‹å¦‚ï¼šé€šå¦å¢åŠ æœåŠ¡å™¨æ•°é‡ï¼Ÿ        ä¾‹å¦‚ï¼šå°†åŸæœ‰çš„Memcacheæ¢æˆRedis?    ä¾‹å¦‚ï¼šå°†åŸæœ‰çš„MySQL Proxyæ¢æˆMyCat?- åº”ç”¨çº§è°ƒä¼˜               NFSï¼ŒSambaï¼ŒApacheã€Nginxã€php-fpmã€MySQLã€Oracleã€KVMã€LVSã€PHPæœ¬èº«è°ƒä¼˜                    å¯¹äºæ—¥å¿—çš„å¤„ç†rsyslogï¼šå¯ä»¥è°ƒæ•´è®°å½•çš„æ—¥å¿—ç­‰çº§æˆ–å»¶åæ—¥å¿—å†™ï¼Œä»è€Œé¿å…å¤§é‡çš„I/Oæ“ä½œ    ç¦ç”¨ä¸€äº›ä¸å¿…è¦çš„æœåŠ¡å¦‚è“ç‰™ã€smart cardï¼Œmakewhatis, updatadb    ä»è¿ç»´äººå‘˜è§’åº¦æ¥è¯´æ— éå°±æ˜¯å‚æ•°çš„ä¿®æ”¹å’Œé…ç½®- kernelçº§è°ƒä¼˜        æ“ä½œç³»ç»Ÿç³»ç»Ÿå±‚é¢ï¼Œå³kernelè°ƒä¼˜å…·æœ‰æ™®éæ€§ï¼šI/O CPU Network Memoryï¼Œé€šå¸¸åœ¨ç³»ç»Ÿåˆå§‹å®Œæˆ    vm.dirty_expire_centisecs    = 2    net.ipv4.tcp_tw_recycle = 1           net.ipv4.tcp_tw_reuse = 1              net.ipv4.tcp_synack_retries = 5    è€ƒè™‘çš„æ˜¯æ€ä¹ˆè®©åº”ç”¨ç¨‹åºåœ¨æˆ‘ä»¬ç³»ç»Ÿä¸Šè¿è¡Œçš„æ›´åˆç†è§„èŒƒ,æˆ–è€…è¯´åœ¨ç¡¬ä»¶ä¸å˜åŠ¨çš„æƒ…å†µä¸‹,å¯¹ç³»ç»Ÿä¼˜åŒ–æé«˜æ€§èƒ½å’Œæ•ˆç‡  </code></pre><p><strong>ä¼˜åŒ–æ•ˆæœ</strong></p><pre><code>    1.å½“å‰é…ç½®æ˜¯å¦é€‚åˆå½“å‰çš„è¿è¡Œç¯å¢ƒå’Œç”¨æˆ·éœ€æ±‚(å¦‚æœæ˜¯memcache é‚£æˆ‘ä»¬è€ƒè™‘æ›´å¤šçš„å¯èƒ½æ˜¯å†…å­˜çš„æ¶ˆè€—æ˜¯ä¸æ˜¯æ›´å¤§äº›,å¦‚æœæ˜¯apacheçš„è¯æˆ‘ä»¬è€ƒè™‘çš„è¯å¯èƒ½å°±æ˜¯cpuçš„æ¶ˆè€—,æ‰€ä»¥æ‰€æœ‰çš„ä¼˜åŒ–æ‰‹æ®µéƒ½è¦æ ¹æ®å…·ä½“çš„ç¯å¢ƒ,å¦‚æœæ˜¯ç¼–è¯‘éœ€è¦çš„å†…å­˜å’Œcpu)    2.ç¡¬ä»¶çš„æå‡æ•ˆæœä¼šæ›´å¥½ï¼Œè‡ªä¸Šå¾€ä¸‹ï¼Œæ•ˆæœè¶Šæ¥è¶Šä¸æ˜æ˜¾</code></pre><p><strong>ä¼˜åŒ–</strong></p><pre><code>ï¼ï¼è°ƒæ•´ç³»ç»Ÿkernel/åº”ç”¨çš„æ€§èƒ½å‚æ•°ï¼ï¼åˆç†èµ„æºåˆ†é…PAMï¼ŒCgroup(Docker)ï¼ï¼æ¶æ„ä¼˜åŒ–ï¼ŒNginxè´Ÿè½½é›†ç¾¤ã€MySQLè¯»å†™åˆ†ç¦»/Galera Cluster# man proc         /drop_cache</code></pre><p><strong>Kernelçº§åˆ«çš„ä¼˜åŒ–:æŸ¥çœ‹å†…æ ¸æ–‡æ¡£</strong></p><pre><code># yum -y install kernel-doc# ls /usr/share/doc/kernel-doc-3.10.0/Documentation/sysctl/00-INDEX  abi.txt  fs.txt  kernel.txt  net.txt  README  sunrpc.txt  vm.txt# grep  &quot;_reuse&quot; -R /usr/share/doc/kernel-doc-3.10.0/Documentation//usr/share/doc/kernel-doc-3.10.0/Documentation/networking/ipvs-sysctl.txt:conn_reuse_mode - INTEGER/usr/share/doc/kernel-doc-3.10.0/Documentation/networking/ip-sysctl.txt:tcp_tw_reuse - BOOLEAN# # grep &quot;drop_caches&quot; -R /usr/share/doc/kernel-doc-3.10.0/Documentation//usr/share/doc/kernel-doc-3.10.0/Documentation/sysctl/vm.txt:drop_caches</code></pre><h3 id="è·å–ç¡¬ä»¶ä¿¡æ¯"><a href="#è·å–ç¡¬ä»¶ä¿¡æ¯" class="headerlink" title="è·å–ç¡¬ä»¶ä¿¡æ¯"></a>è·å–ç¡¬ä»¶ä¿¡æ¯</h3><p>ç¡¬ä»¶æ–¹é¢ï¼Œä¸»è¦è¦è°ƒä¼˜çš„å¯¹è±¡<br>    CPU<br>    Memory<br>    Storage<br>    Networking</p><p><strong>åŸºæœ¬çŸ¥è¯†</strong></p><pre><code>åŸºæœ¬çŸ¥è¯†ï¼š æ‰€æœ‰å­˜å‚¨ç±»çš„è®¾å¤‡    ç¦»CPUè¶Šè¿‘ä¼šè¶Šå¿«ï¼Œç¦»CPUè¶Šè¿œå°†è¶Šæ…¢    ç¦»CPUè¶Šè¿‘å­˜å‚¨çš„å®¹é‡è¶Šå°ï¼Œç¦»CPUè¶Šè¿œå­˜å‚¨çš„å®¹é‡è¶Šå¤§    ç¦»CPUæœ€è¿‘çš„æ˜¯å¯„å­˜å™¨ï¼Œå¯„å­˜å™¨çš„æ—¶é’Ÿå‘¨æœŸå’ŒCPUæ˜¯ä¸€æ ·çš„    ç¦»CPUç¨è¿œçš„å­˜å‚¨ï¼š     L1ï¼Œåœ¨CPUä¸­ï¼Œé™æ€å†…å­˜ï¼Œå·¥è‰ºå¤æ‚    L2ï¼Œä½¿ç”¨çš„æ˜¯åŠ¨æ€é«˜é€Ÿå†…å­˜    L3    L4    Memory    Storage   TB, PB# lscpu                                L1d cache                            ä¸€çº§æ•°æ®ç¼“å­˜L1i  cache                            ä¸€çº§æŒ‡ä»¤ç¼“å­˜L2                                        äºŒçº§ç¼“å­˜ï¼ˆL2æ˜¯å¦å…±äº«?ï¼‰Thread(s) per core:            çº¿ç¨‹æ•°ä¸º1ï¼Œä¸æ”¯æŒè¶…çº¿ç¨‹Core(s) per socket:            CPUæ ¸æ•°Socket(s):                         1               å‡ è·¯NUMA node(s):                  1               ä¸æ”¯æŒNUMA# x86info -c                         æŸ¥çœ‹CPUå‹å·# getconf -a                     æ˜¾ç¤ºæ‰€æœ‰ç³»ç»Ÿé…å€¼å˜é‡å€¼  </code></pre><p><strong>æ ¹æ®CPUè®¿é—®å†…å­˜çš„æ–¹æ³•ï¼š</strong></p><pre><code>a. UMAï¼šä¸€è‡´æ€§å†…å­˜è®¿é—®ï¼Œä¼ ç»Ÿæ¶æ„       MCH:      å†…å­˜æ§åˆ¶èŠ¯ç‰‡ï¼Œå³åŒ—æ¡¥       ICHï¼š     I/Oæ§åˆ¶èŠ¯ç‰‡ï¼Œå³å—æ¡¥ï¼Œè¿æ¥å¤–è®¾ï¼Œç¡¬ç›˜ï¼ŒUSBï¼Œæ…¢é€ŸPCIæ€»çº¿è®¾å¤‡b. NUMAï¼šéä¸€è‡´æ€§å†…å­˜è®¿é—®ï¼ˆå†…å­˜åˆ†ä¸ºå¤šç‰‡ï¼Œè€Œä¸æ˜¯UMAæ—¶çš„ä¸€ç‰‡å†…å­˜ï¼‰       IOHï¼š     I/O HUBï¼Œä¹Ÿå¯ä»¥å«åŒ—æ¡¥       NUMA    æ¶æ„æ˜¾è‘—çš„ç‰¹è‰²æ˜¯ï¼šå†…å­˜åˆ’åˆ†æˆç‰‡ï¼ŒCPUè®¿é—®æœ¬åŒºçš„å†…å­˜çš„æ—¶å€™ï¼Œé€Ÿåº¦éå¸¸å¿«</code></pre><p><img src="https://i.loli.net/2019/06/01/5cf21eb40842684062.png" alt=""></p><p><img src="https://i.loli.net/2019/06/01/5cf21ec23c19c60544.png" alt=""></p><p><strong>Memoryçš„ç›¸å…³æŒ‡æ ‡</strong></p><pre><code># cat /proc/meminfo# free# top# vmstatMemory size:å†…å­˜æ•ˆç‡é‡è¦æŒ‡æ ‡ï¼ša. bandwidth:         å¸¦å®½ï¼Œä½¿ç”¨çš„æ˜¯DDRå‡ ä»£ï¼›ä¾‹å¦‚PC2100ï¼ŒæŒ‡2100M/sçš„ååé‡ï¼Œå³å¸¦å®½b. latency:              å»¶è¿Ÿï¼Œçº³ç§’çº§nsc. ECCå†…å­˜ </code></pre><p>å­˜å‚¨çš„ç›¸å…³æŒ‡æ ‡</p><pre><code>ä¸»è¦çš„è°ƒä¼˜å¯¹åƒï¼Œå¯¹å†…å­˜è€Œè¨€ï¼Œç‰¹åˆ«æ…¢æ‹¿16Gçš„å†…å­˜å­˜æ•°æ®ï¼æ‹¿16Gçš„ç¡¬ç›˜å­˜æ•°æ®ï¼å½“å‰ä¸¤ç§ç£ç›˜ç±»å‹ï¼šæœºæ¢°ç£ç›˜ï¼š    ç›˜ç‰‡ç”µå­SSDï¼š     å›ºæ€ç£ç›˜æœºæ¢°ç£ç›˜ï¼šæ˜‚è´µçš„å¯»é“æ—¶é—´ Expensive seek timeä¸»è½´è½¬é€Ÿï¼š    7200RPM 10000RPM(10k) 15000RPM(15k)ç¼ºç‚¹ï¼šå®¹æ˜“åä¼˜ç‚¹ï¼šå­˜å‚¨é‡éå¸¸é«˜ï¼Œä»·æ ¼ä½Burst speed:      çªå‘é€Ÿç‡ï¼Œæœ€å¿«è¯»å†™é€Ÿç‡ï¼ŒæŒ‡çš„æ˜¯é¡ºåºè¯»å†™ Sequential accessaverage speed: å¹³å‡è¯»å†™é€Ÿç‡ï¼Œç”Ÿäº§ä¸­ä¸èƒ½ä¿è¯æ˜¯é¡ºåºè¯»å†™ Random accessè°ƒä¼˜ï¼š è¿›è¡Œå¤§é‡çš„ä¼˜åŒ–åˆå¹¶SSDï¼šElectronic disk:  ç”µå­ç£ç›˜ï¼Œæ²¡æœ‰æœºæ¢°éƒ¨ä»¶No start-up timeï¼Œè¯»å’Œå†™å»¶è¿Ÿéå¸¸ä½å®‰é™ï¼Œå‘çƒ­é‡å°ï¼Œä¸æ€•éœ‡åŠ¨ï¼Œè€Œä¸”å¾ˆè½»ï¼Œç”¨ç”µå°‘ä»·æ ¼é«˜ï¼šåœ¨åŒç­‰å®¹é‡ä¸‹æ¯”è¾ƒ            å¯¿å‘½ç›¸å¯¹çŸ­è¿æ¥çš„æ–¹å¼ï¼šå†…éƒ¨å­˜å‚¨ï¼š        IDEï¼ˆPATAï¼‰ï¼ŒSATAï¼ŒSASï¼ŒFCå¤–éƒ¨å­˜å‚¨ï¼š        SCSIçº¿è¿æ¥, SASçº¿è¿æ¥ï¼ŒSATAçº¿è¿æ¥ï¼ŒFibre Channel, ISCSIï¼Œç½‘ç»œå¸¦å®½ï¼Œå»¶è¿Ÿï¼Œå¤šè·¯å¾„éƒ½ä¼šå½±å“åˆ°å¤–éƒ¨å­˜å‚¨çš„é€Ÿåº¦4k/sector supportï¼š 4kå¯¹é½ï¼Œæ•ˆç‡æ›´é«˜ï¼ˆé»˜è®¤æ‰‡åŒºå¤§å°512Bï¼‰å¤–åœˆå¿«ï¼Œå†…åœˆæ…¢ï¼šç£ç›˜è½¬ä¸€åœˆï¼Œå¤–åœˆè¯»çš„æ‰‡åŒºæ•°å¤šï¼Œæ‰€ä»¥æ•°æ®å†™è¯»æ—¶å¤–åœˆå¿«ï¼Œå†…åœˆæ…¢RHELå®‰è£…æ—¶ï¼Œé»˜è®¤å°†/, /bootåˆ†åŒºæ‰”åˆ°äº†æœ€å¿«åœˆï¼Œäº¤æ¢åŒºè‡ªåŠ¨é€‰æ‹©å†…åœˆï¼ˆå®ƒè®¤ä¸ºswapä¸éœ€è¦ç»å¸¸è®¿é—®ï¼‰</code></pre><p><strong>Networking Profile</strong></p><pre><code>å¸¦å®½å»¶è¿Ÿå°½é‡æŠŠä¸åŒçš„ç½‘ç»œéš”ç¦»å¼€ï¼Œè®©å…¶å¤„äºä¸åŒçš„å¹¿æ’­åŸŸï¼Œåˆ’åˆ†VLANä½¿ç”¨bondingæˆ–TeamæŠ€æœ¯å®ç°å¤šç½‘å¡ç»‘å®šï¼Œä»è€Œå®ç°HAæˆ–LBï¼ˆæé«˜å¸¦å®½ï¼‰é«˜ç«¯ç½‘å¡æ”¯æŒè™šæ‹ŸåŒ–SR-IOVé«˜ç«¯ç½‘å¡æœ‰è‡ªå·±çš„å¤„ç†èŠ¯ç‰‡ï¼Œç½‘ç»œä¸Šçš„æ•°æ®åˆ°è¾¾æ—¶ï¼Œä¸éœ€è¦ä¸­æ–­CPU</code></pre><p><strong>å…¶å®ƒè·å¾—ç¡¬ä»¶æ€§èƒ½æŒ‡æ ‡å·¥å…·</strong></p><pre><code>dmidecode                    ç›´æ¥æŸ¥BIOSä¿¡æ¯dmidecode -t 0            type 0ä¸»è¦æ˜¯ç¡¬ä»¶ä¿¡æ¯powertop                        æŸ¥çœ‹æœ€è€—ç”µè¿›ç¨‹lspci lsusbethtool=================================================================================//æ£€æµ‹æ˜¯å¦æœ‰è¯¥è®¾å¤‡[root@install ~]# lspci |grep -i eth03:00.0 Ethernet controller: Broadcom Corporation NetXtreme II BCM5708 Gigabit Ethernet (rev 12)05:00.0 Ethernet controller: Broadcom Corporation NetXtreme II BCM5708 Gigabit Ethernet (rev 12)[root@install ~]# lspci |grep -i fib12:02.0 Fibre Channel: Emulex Corporation Thor LightPulse Fibre Channel Host Adapter (rev 01)12:02.1 Fibre Channel: Emulex Corporation Thor LightPulse Fibre Channel Host Adapter (rev 01)# ethtool eth0Settings for eth0:    Supported ports: [ TP MII ]    Supported link modes:   10baseT/Half 10baseT/Full                             100baseT/Half 100baseT/Full                             1000baseT/Half 1000baseT/Full     Supported pause frame use: No    Supports auto-negotiation: Yes    Advertised link modes:  10baseT/Half 10baseT/Full                             100baseT/Half 100baseT/Full                             1000baseT/Half 1000baseT/Full     Advertised pause frame use: Symmetric Receive-only    Advertised auto-negotiation: Yes    Link partner advertised link modes:  10baseT/Half 10baseT/Full                                          100baseT/Half 100baseT/Full                                          1000baseT/Half 1000baseT/Full     Link partner advertised pause frame use: Symmetric    Link partner advertised auto-negotiation: Yes    Speed: 1000Mb/s    Duplex: Full    Port: MII    PHYAD: 0    Transceiver: internal    Auto-negotiation: on    Supports Wake-on: pumbg    Wake-on: g    Current message level: 0x00000033 (51)                   drv probe ifdown ifup    Link detected: yes# ethtool -i eth0driver: r8169version: 2.3LK-NAPIfirmware-version: rtl8168e-3_0.0.4 03/27/12bus-info: 0000:04:00.0supports-statistics: yessupports-test: nosupports-eeprom-access: nosupports-register-dump: yessupports-priv-flags: no# mii-tool eth0eth0: negotiated 100baseTx-FD flow-control, link ok//æ˜¯å¦åŠ è½½ç›¸åº”çš„é©±åŠ¨[root@install ~]# dmesg  |grep -i  fibEmulex LightPulse Fibre Channel SCSI driver 8.3.39scsi3 : Emulex LP1050 PCI-X Fibre Channel Adapter  on PCI bus 12 device 10 irq 19scsi4 : Emulex LP1050 PCI-X Fibre Channel Adapter  on PCI bus 12 device 11 irq 18æŸ¥çœ‹FC HBA wwnå·[root@install ~]#  cat /sys/class/fc_host/host3/port_name 0x10000000c9672e4a[root@install ~]#  cat /sys/class/fc_host/host4/port_name 0x10000000c9672e49</code></pre><p><strong>è‡³å¼ºCPU</strong></p><pre><code>Intel E3ï¼ŒE5ï¼ŒE7ä»£è¡¨äº†3ä¸ªä¸åŒæ¡£æ¬¡çš„è‡³å¼ºCPUï¼Œè‡³å¼ºâ€œEç³»åˆ—â€çš„è¿™ç§å‘½åæ–¹å¼æœ‰äº›ç±»ä¼¼æ¡Œé¢ä¸Šçš„Core i3ï¼Œi5ï¼Œi7ï¼›æ¯”è¾ƒé€šä¿—æ˜“æ‡‚çš„è§£é‡Šå°±æ˜¯å¯ä»¥å¯¹åº”æˆ‘ä»¬çš„è±ªåæ±½è½¦ç”Ÿäº§å•†å®é©¬3ç³»ï¼Œ5ç³»å’Œ7ç³»ã€‚åˆ†åˆ«å¯¹åº”å¥½ï¼Œæ›´å¥½å’Œæœ€å¥½ã€‚å…¶ä¸­ï¼šè‡³å¼ºE3å¤„ç†å™¨æ˜¯ç¬¬ä¸€æ¬¾ä½¿ç”¨Haswellå¾®æ¶æ„çš„è‡³å¼ºå¤„ç†å™¨èŠ¯ç‰‡ï¼ˆç›®å‰ï¼Œè‹±ç‰¹å°”çš„å¤šæ•°èŠ¯ç‰‡æ˜¯ä»¥Ivy Bridgeæ¶æ„ä¸ºåŸºç¡€ï¼‰ï¼Œæœ€å¤šé…ç½®4ä¸ªå†…æ ¸ï¼Œæœ€é«˜æ”¯æŒ32GBå†…å­˜ï¼Œè€—ç”µé‡åªæœ‰13ç“¦ï¼Œä¸»è¦ç”¨äºå·¥ä½œç«™å’Œå•è·¯æœåŠ¡å™¨ï¼›è‡³å¼ºE5å¤„ç†å™¨ä¸»è¦ç”¨äºä¸­æ¡£æœåŠ¡å™¨ï¼Œæœ€é«˜æ”¯æŒ768GBå†…å­˜ï¼Œè€—ç”µé‡ä¸º60è‡³130ç“¦ï¼Œé€‚ç”¨å…¥é—¨çº§åŒè·¯æœåŠ¡å™¨ã€é«˜æ€§èƒ½åŒè·¯å’Œå››è·¯æœåŠ¡å™¨ï¼Œä¹Ÿæ˜¯ç›®å‰ä½¿ç”¨æœ€ä¸ºå¹¿æ³›çš„ä¸»æµå¤„ç†å™¨ï¼›è‡³å¼ºE7å¤„ç†å™¨æ˜¯è‹±ç‰¹å°”æ€§èƒ½æœ€é«˜çš„æœåŠ¡å™¨å¤„ç†å™¨ï¼ŒèŠ¯ç‰‡åŒ…æ‹¬30GBä¸‰çº§ç¼“å­˜ï¼Œæœ€é«˜æ”¯æŒ4TBå†…å­˜ï¼Œè€—ç”µé‡ä¸º130ç“¦ã€‚è¿™ç§å¤„ç†å™¨å¯ç”¨äº8è·¯æœåŠ¡å™¨ã€‚è‡³äºå…·ä½“åº”ç”¨å¯ä»¥æ ¹æ®å¤„ç†å™¨çš„å‹å·æ¥åˆ¤å®šï¼Œä»¥è‹±ç‰¹å°”æœ€æ–°å‘å¸ƒçš„E5-2600 V2ä¸ºä¾‹ï¼Œè¿™é‡Œçš„â€œ2â€ï¼Œä¹Ÿå°±æ˜¯è¿å­—ç¬¦åçš„ç¬¬ä¸€ä¸ªæ•°å­—ï¼Œå®ƒä»£è¡¨å¤„ç†å™¨æœ€å¤šæ”¯æŒçš„å¹¶è¡Œè·¯æ•°ï¼Œæœ‰1ã€2ã€4ã€8å››ç§è§„æ ¼ï¼Œåˆ†åˆ«ä»£è¡¨äº†å•è·¯ã€åŒè·¯ã€å››è·¯å’Œå…«è·¯ã€‚æˆ‘ä»¬ç°åœ¨ä¸¾ä¾‹çš„è¿™æ¬¾E5-2600 è‡³å¼ºCPUï¼Œè¿å­—ç¬¦åçš„ç¬¬ä¸€ä¸ªæ•°å­—æ˜¯&quot;2&quot;ï¼Œå°±è¡¨ç¤ºè¿™æ¬¾CPUä¸ºåŒè·¯ï¼Œåªèƒ½ç”¨äºå¯¹åº”çš„åŒè·¯èŠ¯ç‰‡ç»„çš„ä¸»æ¿ã€‚ç´§æ¥ç€ï¼Œæˆ‘ä»¬æ¥çœ‹è¿å­—ç¬¦åçš„ç¬¬äºŒä¸ªæ•°å­—ï¼Œå®ƒä»£è¡¨å¤„ç†å™¨å°è£…æ¥å£å½¢å¼ï¼Œä¸€å…±æœ‰2ï¼Œ4ï¼Œ6ï¼Œ8å››ç§è§„æ ¼ï¼Œåˆ†åˆ«æ˜¯2å¯¹åº”Socket H2(LGA 1155)ã€4å¯¹åº”Socket B2(LGA 1356)ã€6å¯¹åº”Socket R(LGA 2011)ã€8å¯¹åº”Socket LS(LGA 1567)ã€‚æˆ‘ä»¬ä¸¾ä¾‹çš„è¿™æ¬¾E5-2600ï¼Œè¿å­—ç¬¦åçš„ç¬¬äºŒä¸ªæ•°å­—æ˜¯&quot;6&quot;ï¼Œå¯¹åº”Socket R(LGA 2011)ç„¶åï¼Œè¿å­—ç¬¦åç¬¬ä¸‰å’Œç¬¬å››ä½ä»£è¡¨ç¼–å·åºåˆ—ï¼Œä¸€èˆ¬æ˜¯æ•°å­—è¶Šå¤§äº§å“æ€§èƒ½è¶Šé«˜ï¼Œä»·æ ¼ä¹Ÿæ›´è´µã€‚æœ€åï¼Œçœ‹è¿å­—ç¬¦åç¬¬å››ä½æ•°å­—åé¢çš„ä»£è¡¨ä»€ä¹ˆã€‚ç´§è·Ÿç¬¬å››ä½æ•°å­—åçš„&quot;L&quot;ä»£è¡¨æ˜¯ä½åŠŸè€—ç‰ˆï¼Œç•™ç©ºçš„è¯å°±ä»£è¡¨æ˜¯æ ‡å‡†ç‰ˆã€‚è¿å­—ç¬¦åé¢æœ€åçš„æ•°å­—ä»£è¡¨ä¿®è®¢ç‰ˆæœ¬ï¼Œæ¯”å¦‚v2ã€v3ã€v4ç­‰ç­‰ï¼Œè¿™æ¬¡æ–°å‘å¸ƒçš„E5-2600 V2å°±æ˜¯ç¬¬äºŒæ¬¡å‡çº§ç‰ˆã€‚æ³¨ï¼šLGA 1155ï¼šè¡¨ç¤ºä¸åŒçš„å°è£…æŠ€æœ¯</code></pre><h3 id="CPU"><a href="#CPU" class="headerlink" title="CPU"></a>CPU</h3><p>cpuçš„ç›¸å…³æŒ‡æ ‡</p><p># cat /proc/cpuinfo    </p><p>â€‹     ç‰©ç†çš„(å¤šå°‘è·¯)ï¼Œæ ¸å¿ƒçš„ï¼Œè¶…çº¿ç¨‹        </p><pre><code>å¤šè·¯æœåŠ¡å™¨ï¼š    åŒè·¯å››æ ¸ï¼Œæ˜¯æŒ‡æœåŠ¡å™¨/å·¥ä½œç«™æœ‰ä¸¤ä¸ªCPUï¼Œæ¯ä¸ªCPUéƒ½æ˜¯å››æ ¸å¤„ç†å™¨ã€‚    å¤šè·¯æœåŠ¡å™¨/å·¥ä½œç«™çš„å…³é”®éƒ¨ä»¶æ˜¯å¤šè·¯ä¸»æ¿ï¼Œå¯å®‰è£…å¤šä¸ªå¤„ç†å™¨ï¼ŒåŒè·¯ä¸»æ¿ä¸¾ä¸€ç¤ºä¾‹å¦‚å›¾ï¼š    ä¸€ä¸ªCPUï¼Œé…ä¸€å¥—å†…å­˜ï¼ŒåŒè·¯å°±æ˜¯åŒCPUåŠ åŒå¥—å†…å­˜</code></pre><p><img src="https://i.loli.net/2019/06/01/5cf22857981f842559.png" alt=""></p><p><strong>CPUè°ƒåº¦</strong></p><pre><code>cpuè°ƒåº¦ï¼š3ä¸ªè¿›ç¨‹    a  b  c éƒ½æ˜¯R cpuå¤„ç†è°? è¿™æ ·å°±è¦ä¾é è°ƒåº¦ç¨‹åº?    a----b-----c æ‰¹å¤„ç†æ“ä½œç³»ç»ŸåŒæ ·3ä¸ªè¿›ç¨‹    a  b  c  æ¯ä¸ªè¿è¡Œ1ç§’ å¥½åƒæ˜¯cpuç‹¬å   åˆ†æ—¶æ“ä½œç³»ç»Ÿå“ªç§ç³»ç»Ÿæ“ä½œå®Œæ¶ˆè€—çš„æ—¶é—´å°‘?æ‰¹å¤„ç†æ“ä½œç³»ç»Ÿ   OSä»cpuçš„è°ƒåº¦æ¥åˆ†:åˆ†æ—¶                 åˆ†æ—¶æ“ä½œç³»ç»Ÿä»¥&quot;åˆ†æ—¶&quot;åŸåˆ™,ä¸ºæ¯ä¸ªç”¨æˆ·æœåŠ¡.å°†CPUçš„æ—¶é—´åˆ’åˆ†æˆè‹¥å¹²ä¸ªç‰‡æ®µï¼Œç§°ä¸ºæ—¶é—´ç‰‡ã€‚æ“ä½œç³»ç»ŸæŠŠæ¯ä¸ªæ—¶é—´ç‰‡åˆ†ï¼Œè½®æµåœ°åˆ‡æ¢ç»™å„ç»ˆç«¯ç”¨æˆ·çš„ç¨‹åºä½¿ç”¨ã€‚ç”±äºæ—¶é—´é—´éš”å¾ˆçŸ­ï¼Œæ¯ä¸ªç”¨æˆ·çš„æ„Ÿè§‰å°±åƒä»–ç‹¬å è®¡ç®—æœºä¸€æ ·ã€‚åˆ†æ—¶æ“ä½œç³»ç»Ÿçš„ç‰¹ç‚¹æ˜¯å¯æœ‰æ•ˆå¢åŠ èµ„æºçš„ä½¿ç”¨ç‡ã€‚ä¾‹å¦‚UNIXç³»ç»Ÿå°±é‡‡ç”¨å‰¥å¤ºå¼åŠ¨æ€ä¼˜å…ˆçš„CPUè°ƒåº¦ï¼Œæœ‰åŠ›åœ°æ”¯æŒåˆ†æ—¶æ“ä½œã€‚æ‰¹å¤„ç†            æ‰¹å¤„ç†(batch processing )å°±æ˜¯å°†ä½œä¸šæŒ‰ç…§å®ƒä»¬çš„æ€§è´¨åˆ†ç»„ï¼ˆæˆ–åˆ†æ‰¹ï¼‰ï¼Œç„¶åå†æˆç»„ï¼ˆæˆ–æˆæ‰¹ï¼‰åœ°æäº¤ç»™è®¡ç®—æœºç³»ç»Ÿï¼Œç”±è®¡ç®—æœºè‡ªåŠ¨å®Œæˆåå†è¾“å‡ºç»“æœï¼Œä»è€Œå‡å°‘ä½œä¸šå»ºç«‹å’Œç»“æŸè¿‡ç¨‹ä¸­çš„æ—¶é—´æµªè´¹ã€‚        å¦‚:æ‰“å°æœºå°±æ˜¯é‡‡ç”¨è¿™ç§æ“ä½œç³»ç»Ÿå®æ—¶            å®æ—¶æ“ä½œç³»ç»Ÿ(RealTimeOperatingSystemï¼ŒRTOS)æ˜¯æŒ‡ä½¿è®¡ç®—æœºèƒ½åŠæ—¶å“åº”å¤–éƒ¨äº‹ä»¶çš„è¯·æ±‚åœ¨è§„å®šçš„ä¸¥æ ¼æ—¶é—´å†…å®Œæˆå¯¹è¯¥äº‹ä»¶çš„å¤„ç†ï¼Œå¹¶æ§åˆ¶æ‰€æœ‰å®æ—¶è®¾å¤‡å’Œå®æ—¶ä»»åŠ¡åè°ƒä¸€è‡´åœ°å·¥ä½œçš„æ“ä½œç³»ç»Ÿã€‚å®æ—¶æ“ä½œç³»ç»Ÿè¦è¿½æ±‚çš„ç›®æ ‡æ˜¯ï¼šå¯¹å¤–éƒ¨è¯·æ±‚åœ¨ä¸¥æ ¼æ—¶é—´èŒƒå›´å†…åšå‡ºååº”ï¼Œæœ‰é«˜å¯é æ€§å’Œå®Œæ•´æ€§ã€‚å…¶ä¸»è¦ç‰¹ç‚¹æ˜¯èµ„æºçš„åˆ†é…å’Œè°ƒåº¦é¦–å…ˆè¦è€ƒè™‘å®æ—¶æ€§ç„¶åæ‰æ˜¯æ•ˆç‡ã€‚æ­¤å¤–ï¼Œå®æ—¶æ“ä½œç³»ç»Ÿåº”æœ‰è¾ƒå¼ºçš„å®¹é”™èƒ½åŠ›ã€‚åŒºåˆ«:            æ‰¹å¤„ç†ç³»ç»Ÿ(batch processing system)ä¸­ï¼Œä¸€ä¸ªä½œä¸šå¯ä»¥é•¿æ—¶é—´åœ°å ç”¨cpuã€‚è€Œåˆ†æ—¶ç³»ç»Ÿä¸­ï¼Œä¸€ä¸ªä½œä¸šåªèƒ½åœ¨ä¸€ä¸ªæ—¶é—´ç‰‡ï¼ˆTime Sliceï¼Œä¸€èˆ¬å–100msï¼‰çš„æ—¶é—´å†…ä½¿ç”¨cpuã€‚        æ‰¹å¤„ç†ç³»ç»Ÿçš„ç›®çš„ï¼šæé«˜ç³»ç»Ÿååé‡å’Œèµ„æºçš„åˆ©ç”¨ç‡ã€‚        åˆ†æ—¶ç³»ç»Ÿçš„ç›®çš„ï¼š   å¯¹ç”¨æˆ·çš„è¯·æ±‚åŠæ—¶å“åº”ï¼Œå¹¶åœ¨å¯èƒ½æ¡ä»¶ä¸‹å°½é‡æé«˜ç³»ç»Ÿèµ„æºçš„åˆ©ç”¨ç‡ã€‚è¿›ç¨‹ä¸è°ƒåº¦ï¼šè¿›ç¨‹ï¼š    ç¨‹åºæ˜¯ä¸€ä¸ªæ–‡ä»¶,è€Œprocessæ˜¯ä¸€ä¸ªæ‰§è¡Œä¸­çš„ç¨‹åºå®ä¾‹ã€‚    linuxç³»ç»Ÿä¸­åˆ›å»ºæ–°è¿›ç¨‹ä½¿ç”¨fork()ç³»ç»Ÿè°ƒç”¨ã€‚    åˆ©ç”¨åˆ†æ—¶æŠ€æœ¯ï¼Œåœ¨linuxæ“ä½œç³»ç»Ÿä¸ŠåŒæ—¶å¯ä»¥è¿è¡Œå¤šä¸ªè¿›ç¨‹ï¼Œå½“è¿›ç¨‹çš„æ—¶é—´ç‰‡ç”¨å®Œæ—¶ï¼Œkernelå°±åˆ©ç”¨è°ƒåº¦ç¨‹åºåˆ‡æ¢åˆ°å¦ä¸€ä¸ªè¿›ç¨‹å»è¿è¡Œã€‚å†…æ ¸ä¸­çš„è°ƒåº¦ç¨‹åºï¼š    ç”¨äºé€‰æ‹©ç³»ç»Ÿä¸­ä¸‹ä¸€ä¸ªè¦è¿è¡Œçš„è¿›ç¨‹ã€‚ä½ å¯ä»¥å°†è°ƒåº¦ç¨‹åºçœ‹åšåœ¨æ‰€æœ‰å¤„äºè¿è¡ŒçŠ¶æ€çš„è¿›ç¨‹ä¹‹é—´åˆ†é…CPUè¿è¡Œæ—¶é—´çš„ç®¡ç†ä»£ç ã€‚ä¸ºäº†è®©è¿›ç¨‹æœ‰æ•ˆçš„ä½¿ç”¨ç³»ç»Ÿèµ„æºï¼Œåˆèƒ½è®©è¿›ç¨‹æœ‰è¾ƒå¿«çš„å“åº”æ—¶é—´ï¼Œå°±éœ€è¦å¯¹è¿›ç¨‹çš„åˆ‡æ¢è°ƒåº¦é‡‡ç”¨ä¸€å®šçš„è°ƒåº¦ç­–ç•¥ã€‚</code></pre><p><strong>æ—¶é’Ÿé¢‘ç‡</strong></p><pre><code>CPU timer   å›ºå®šé¢‘ç‡ç»™CPUå‘ä¸­æ–­,CPUå¯åœä¸‹æ¥é€šè¿‡è°ƒåº¦å™¨å¤„ç†ä¸‹ä¸€ä¸ªä»»åŠ¡    #grep  HZ  /boot/config-x.x.x    #grep HZ /boot/config-2.6.32-358.el6.x86_64        CONFIG_NO_HZ=y        # CONFIG_HZ_100 is not set        # CONFIG_HZ_250 is not set        # CONFIG_HZ_300 is not set        CONFIG_HZ_1000=y ---------------------------1ç§’1000æ¬¡        CONFIG_HZ=1000        CONFIG_MACHZ_WDT=mæ‰€æœ‰çš„linuxæ“ä½œç³»ç»Ÿéƒ½æ˜¯åŸºäºä¸­æ–­é©±åŠ¨çš„ï¼š    å½“æˆ‘ä»¬åœ¨é”®ç›˜ä¸ŠæŒ‰ä¸‹ä¸€ä¸ªæŒ‰é”®æ—¶ï¼Œé”®ç›˜å°±ä¼šå¯¹CPUè¯´ï¼Œä¸€ä¸ªé”®å·²ç»è¢«æŒ‰ä¸‹ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œé”®ç›˜çš„IRQçº¿è·¯ä¸­çš„ç”µå‹å°±ä¼šå‘ç”Ÿä¸€æ¬¡å˜åŒ–ï¼Œè€Œè¿™ç§ç”µå‹çš„å˜åŒ–å°±æ˜¯æ¥è‡ªè®¾å¤‡çš„è¯·æ±‚ï¼Œå°±ç›¸å½“äºè¯´è¿™ä¸ªè®¾å¤‡æœ‰ä¸€ä¸ªè¯·æ±‚éœ€è¦å¤„ç†ã€‚    [root@mail ~]#watch -n 1 cat /proc/interrupts    //åŒ…å«æœ‰å…³äºå“ªäº›ä¸­æ–­æ­£åœ¨ä½¿ç”¨å’Œæ¯ä¸ªå¤„ç†å™¨å„è¢«ä¸­æ–­äº†å¤šå°‘æ¬¡çš„ä¿¡æ¯ã€‚               CPU0             0:        174   IO-APIC-edge      timer      1:         70   IO-APIC-edge      i8042      3:          1   IO-APIC-edge          4:          1   IO-APIC-edge          7:          0   IO-APIC-edge      parport0      8:          0   IO-APIC-edge      rtc0      9:          0   IO-APIC-fasteoi   acpi     12:       1397   IO-APIC-edge      i8042     14:          0   IO-APIC-edge      ata_piix     15:       4180   IO-APIC-edge      ata_piix     16:        945   IO-APIC-fasteoi   Ensoniq AudioPCI     17:     778014   IO-APIC-fasteoi   ehci_hcd:usb1, ioc0     18:          0   IO-APIC-fasteoi   uhci_hcd:usb2     19:        487   IO-APIC-fasteoi   eth0     ç¬¬ä¸€åˆ—è¡¨ç¤ºIRQå·,IRQå·å†³å®šäº†éœ€è¦è¢«CPUå¤„ç†çš„ä¼˜å…ˆçº§ã€‚IRQå·è¶Šå°æ„å‘³ç€ä¼˜å…ˆçº§è¶Šé«˜ã€‚     ç¬¬äºŒã€ä¸‰ã€å››åˆ—è¡¨ç¤ºç›¸åº”çš„CPUæ ¸å¿ƒè¢«ä¸­æ–­çš„æ¬¡æ•°ã€‚IO-APIC-edgeè¡¨ç¤ºç»ˆç«¯æ¥å£ï¼Œtimerè¡¨ç¤ºä¸­æ–­åç§°ï¼ˆä¸ºç³»ç»Ÿæ—¶é’Ÿï¼‰ã€‚174è¡¨ç¤ºCPU0è¢«ä¸­æ–­äº†174æ¬¡ã€‚i8042è¡¨ç¤ºæ§åˆ¶é”®ç›˜å’Œé¼ æ ‡çš„é”®ç›˜æ§åˆ¶å™¨ã€‚å¯¹äºåƒrtcï¼ˆreal time clockï¼‰è¿™æ ·çš„ä¸­æ–­ï¼ŒCPUæ˜¯ä¸ä¼šè¢«ä¸­æ–­çš„ã€‚å› ä¸ºRTCå­˜åœ¨äºç”µå­è®¾å¤‡ä¸­ï¼Œæ˜¯ç”¨äºè¿½è¸ªæ—¶é—´çš„ã€‚NMIå’ŒLOCæ˜¯ç³»ç»Ÿæ‰€ä½¿ç”¨çš„é©±åŠ¨ï¼Œç”¨æˆ·æ— æ³•è®¿é—®å’Œé…ç½®ã€‚     ä¾‹å¦‚ï¼Œå¦‚æœCPUåŒæ—¶æ¥æ”¶äº†æ¥è‡ªé”®ç›˜å’Œç³»ç»Ÿæ—¶é’Ÿçš„ä¸­æ–­ï¼Œé‚£ä¹ˆCPUé¦–å…ˆä¼šæœåŠ¡äºç³»ç»Ÿæ—¶é’Ÿï¼Œå› ä¸ºä»–çš„IRQå·æ˜¯ 0 ã€‚     IRQ0 ï¼šç³»ç»Ÿæ—¶é’Ÿï¼ˆä¸èƒ½æ”¹å˜ï¼‰     IRQ1 ï¼šé”®ç›˜æ§åˆ¶å™¨ï¼ˆä¸èƒ½æ”¹å˜ï¼‰     IRQ3 ï¼šä¸²å£2çš„ä¸²å£æ§åˆ¶å™¨ï¼ˆå¦‚æœ‰ä¸²å£4ï¼Œåˆ™å…¶ä¹Ÿä½¿ç”¨è¿™ä¸ªä¸­æ–­ï¼‰     IRQ4 ï¼šä¸²å£1çš„ä¸²å£æ§åˆ¶å™¨ï¼ˆå¦‚æœ‰ä¸²å£3ï¼Œåˆ™å…¶ä¹Ÿä½¿ç”¨è¿™ä¸ªä¸­æ–­ï¼‰     IRQ5 ï¼šå¹¶å£2å’Œ3 æˆ– å£°å¡     IRQ6 ï¼šè½¯ç›˜æ§åˆ¶å™¨     IRQ7 : å¹¶å£1ã€‚å®ƒè¢«ç”¨äºæ‰“å°æœºæˆ–è‹¥æ˜¯æ²¡æœ‰æ‰“å°æœºï¼Œå¯ä»¥ç”¨äºä»»ä½•çš„å¹¶å£ã€‚è°ƒæ•´ï¼šæ¯æ¥æ”¶åˆ°ä¸€ä¸ªæ—¶é’Ÿä¸­æ–­å°±è¦å¤„ç†å¦ä¸€ä¸ªä»»åŠ¡.è°ƒåº¦å™¨----æ ¹æ®è°ƒåº¦ç®—æ³•       é¢‘ç‡é«˜   å“åº”é€Ÿåº¦é«˜  ååé‡ä½       é¢‘ç‡ä½   å“åº”é€Ÿåº¦åº•  ååé‡é«˜    æ¡Œé¢æ¨èé«˜é¢‘ç‡,æœåŠ¡å™¨æ¨èä½é¢‘ç‡    å¯¹äºåº”ç”¨ç¨‹åºçš„è¿è¡Œï¼Œæœ€å¥½çš„åŠæ³•æ˜¯çºµå‘å‡çº§ï¼ˆæå‡CPUé¢‘ç‡ï¼‰è€Œä¸æ˜¯æ¨ªå‘å‡çº§ï¼ˆå¢åŠ CPUæ•°é‡ï¼‰ã€‚è¿™å–å†³äºä½ çš„åº”ç”¨ç¨‹åºæ˜¯å¦èƒ½ä½¿ç”¨åˆ°å¤šä¸ªå¤„ç†å™¨ã€‚ä¾‹å¦‚ä¸€ä¸ªå•çº¿ç¨‹åº”ç”¨ç¨‹åºçš„å‡çº§æ–¹å¼æœ€å¥½æ˜¯æ›´æ¢æˆæ›´å¿«çš„CPUè€Œä¸æ˜¯å¢åŠ ä¸ºå¤šä¸ªCPU</code></pre><p><strong>PSå‘½ä»¤</strong></p><pre><code>pså‘½ä»¤ï¼š    ps -o user,pid,%cpu -p 3288    ps -eo  user,pid,%cpu  --sort %cpu     //å‡åº -%cpu é™åºtopå‘½ä»¤#top -d 1    top - 10:18:15 up  1:45,  4 users,  load average: 2.44, 2.42, 1.82    Tasks: 225 total,   3 running, 222 sleeping,   0 stopped,   0 zombie    Cpu(s): 79.2%us, 17.6%sy,  0.0%ni,  0.3%id,  0.0%wa,  0.0%hi,  2.8%si,  0.0%st    Mem:   4019424k total,  2419520k used,  1599904k free,   248248k buffers    Swap:  8191992k total,        0k used,  8191992k free,   525780k cached----------------------------------------------------------å¿«æ·é”®ï¼š    P æŒ‰cpuæ’åº    M æŒ‰å†…å­˜æ’åº    f  æ·»åŠ åˆ é™¤å­—æ®µï¼Œå¸¦*çš„æ˜¯é»˜è®¤æ˜¾ç¤º  å¤§å†™çš„æ˜¯å½“å‰æ˜¾ç¤º  å°å†™çš„æ˜¯ç°åœ¨æ²¡æœ‰æ˜¾ç¤ºçš„ å¯ä»¥å…³æ‰æŒ‡å®šçš„åˆ—ï¼Œå¼€å¯éœ€è¦çš„åˆ—ï¼ŒæŒ‰å¯¹åº”çš„å­—æ¯å°±å¯ä»¥    1 å¯ä»¥å±•å¼€cpuï¼Œä¹Ÿå°±æ˜¯å¦‚æœæœ‰å¤šä¸ªcpuå¯ä»¥è¿™æ ·æŸ¥çœ‹ ï¼Œæ²¡æœ‰å±•å¼€ä¹‹å‰æ˜¯å¹³å‡å€¼        topåæŒ‰1ï¼Œç„¶åæŒ‰Wï¼Œä¼šå°†æ­¤æ¬¡çš„æ˜¾ç¤ºé…ç½®ä¿å­˜åˆ° ~/.toprc æ–‡ä»¶ä¸­,ä¸‹æ¬¡å†topçš„æ—¶å€™å°±ä¼šç›´æ¥æ˜¾ç¤ºå¤šCPUä½¿ç”¨ç‡ã€‚å¯ä»¥åœ¨è„šæœ¬ä¸­ç›´æ¥ä½¿ç”¨topçš„Batchæ¨¡å¼    #top -bn1</code></pre><p><strong>ä¸€å°æœåŠ¡å™¨æ˜¯å¦ç¨³å®š</strong></p><pre><code>upåé¢çš„æ—¶é—´å¯ä»¥ä½œä¸ºåˆ¤æ–­æ ‡å‡†ä¹‹ä¸€load average: 1 5 151åˆ†é’Ÿï¼Œ5åˆ†é’Ÿï¼Œ15åˆ†é’Ÿä¹‹å‰åˆ°ç°åœ¨çš„cpuå¹³å‡è´Ÿè½½(ç­‰å¾…cpuå¤„ç†çš„è¿›ç¨‹é˜Ÿåˆ—å¹³å‡é•¿åº¦)è´Ÿè½½ï¼š    æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹    è¿›å…¥åˆ°IOç­‰å¾…ä½ç½®çš„è¿›ç¨‹æˆ‘æ˜¯cpu ä½ ä»¬æ˜¯ç¨‹åº æ²¡äººè·Ÿæˆ‘è¯´è¯  æˆ‘ç°åœ¨æ˜¯æ²¡æœ‰è´Ÿè½½çš„æœ‰ä¸€ä¸ªäººé—®é—®é¢˜ æˆ‘æœ‰è´Ÿè½½å—ï¼Ÿ    æ²¡æœ‰     å¦‚æœå†æœ‰ä¸€ä¸ªäººé—®é—®é¢˜ï¼Œå¦‚æœä¹‹å‰åŒå­¦çš„é—®é¢˜å¤„ç†å®Œäº†æˆ–è€…ä»–ä¿©çš„é—®é¢˜å¾ˆç®€å•ï¼Œæˆ‘ä¸€æ¬¡å°±è§£å†³å®Œäº†ï¼Œè¿™æ—¶å€™æ˜¯æ²¡æœ‰è´Ÿè½½çš„    å¦‚æœç¬¬ä¸€ä¸ªé—®çš„é—®é¢˜å¾ˆå›°éš¾ï¼Œæˆ‘ä¸€æ—¶è§£å†³ä¸å®Œï¼Œè¿™æ—¶å€™å†æœ‰äººé—®é—®é¢˜çš„æ—¶å€™æˆ‘å°±äº§ç”Ÿè´Ÿè½½äº†1åˆ†é’Ÿä¹‹å†…ä¸¾ä¾‹ï¼š    0   10  20    30  40  50  60  CPU     A   åªç”¨äº†10ç§’ï¼Œè¿™æ—¶å€™cpuçš„è´Ÿè½½æ˜¯1/6    B   ç”¨äº†20ç§’ï¼Œ  è¿™æ—¶å€™è´Ÿè½½æ˜¯1/2    C   ç”¨30ç§’ï¼Œ    è¿™æ—¶å€™è´Ÿè½½æ˜¯1æœ€å¥½çš„å•æ ¸CPUè´Ÿè½½æ˜¯1åŠ ä¸Šcpuæ ¸æ•°ï¼Œæœ€å¥½çš„è´Ÿè½½æ˜¯è·Ÿæ ¸æ•°ç›¸ç­‰ï¼Œæ ¸æ•°çš„2å€ä»¥å†…æ²¡ä»€ä¹ˆå¤§é—®é¢˜ï¼Œ2å€ä»¥ä¸Šè¯´æ˜è´Ÿè½½è¿‡é«˜8æ ¸è´Ÿè½½ 25 15 3 ï¼Œè¿™æ ·çš„è´Ÿè½½æ˜¯æ²¡ä»€ä¹ˆé—®é¢˜çš„ä½†æ˜¯ä¸€å®šè¦åˆ¤æ–­åˆ°25é‚£ä¸ªåœ°æ–¹å‘ç”Ÿäº†ä»€ä¹ˆäº‹æƒ…ï¼Œèƒ½ä¸èƒ½æŠŠé‚£ä¸ªå³°å€¼åŒ–è§£æ‰ï¼Œä¸ç„¶å¦‚æœå³°å€¼è¶Šæ¥è¶Šé«˜ï¼Œé‚£ä¹ˆæœåŠ¡å™¨å¯èƒ½æ‰¿å—ä¸ä½æ¯”å¦‚é‚®ä»¶æœåŠ¡å™¨çš„æ”¶å‘é«˜å³°å’Œé‚®ä»¶å¤‡ä»½äº§ç”Ÿçš„è´Ÿè½½é«˜å³°ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠä»–ä»¬ä¸¤ä¸ªæ“ä½œåˆ†å¼€æˆä¸¤ä¸ªå°é«˜å³°ï¼Œè¿™æ ·æœ€å¥½-----------------------------------------------------------running ä¸¤ä¸ªå«ä¹‰1.æ­£åœ¨è¿è¡Œ 2.å¯è¿è¡Œçš„      //ä¹Ÿå°±æ˜¯æ­¤ç¨‹åºå¿…é¡»åœ¨è°ƒç”¨cpuä¹‹å‰è¦å‡†å¤‡å¥½è¿è¡Œsleeping å¯ä»¥å«ç¡çœ ï¼Œç­‰å¾…æˆ–è€…é˜»å¡stopedè¡¨ç¤ºæŒ‚èµ·(æš‚åœ)------------------------------------------------------------%us     ç”¨æˆ·æ€ç¨‹åºå ç”¨cpuç™¾åˆ†æ¯”%sy     å†…æ ¸æ€ç¨‹åºå ç”¨cpuç™¾åˆ†æ¯”%ni     è°ƒæ•´è¿‡niceå€¼çš„ç¨‹åºå ç”¨cpuç™¾åˆ†æ¯”%id     cpuç©ºé—²ç™¾åˆ†æ¯”%wa    ioç­‰å¾…æ¶ˆè€—cpuçš„ç™¾åˆ†æ¯”ï¼ˆcpuç©ºè½¬ï¼‰%hi     ç¡¬ä»¶ä¸­æ–­å ç”¨cpuçš„ç™¾åˆ†æ¯”%si     è½¯ä¸­æ–­%st     cpuè¢«å·èµ°çš„ç™¾åˆ†æ¯”    â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦    å†…æ ¸æ€å’Œç”¨æˆ·æ€        å½“ä¸€ä¸ªä»»åŠ¡ï¼ˆè¿›ç¨‹ï¼‰æ‰§è¡Œç³»ç»Ÿè°ƒç”¨è€Œé™·å…¥å†…æ ¸ä»£ç ä¸­æ‰§è¡Œæ—¶ï¼Œæˆ‘ä»¬å°±ç§°è¿›ç¨‹å¤„äºå†…æ ¸è¿è¡Œæ€ï¼ˆæˆ–ç®€ç§°ä¸ºå†…æ ¸æ€ï¼‰ã€‚æ­¤æ—¶å¤„ç†å™¨å¤„äºç‰¹æƒçº§æœ€é«˜çš„ï¼ˆ0çº§ï¼‰å†…æ ¸ä»£ç ä¸­æ‰§è¡Œã€‚å½“è¿›ç¨‹å¤„äºå†…æ ¸æ€æ—¶ï¼Œæ‰§è¡Œçš„å†…æ ¸ä»£ç ä¼šä½¿ç”¨å½“å‰è¿›ç¨‹çš„å†…æ ¸æ ˆã€‚æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰è‡ªå·±çš„å†…æ ¸æ ˆã€‚å½“è¿›ç¨‹åœ¨æ‰§è¡Œç”¨æˆ·è‡ªå·±çš„ä»£ç æ—¶ï¼Œåˆ™ç§°å…¶å¤„äºç”¨æˆ·è¿è¡Œæ€ï¼ˆç”¨æˆ·æ€ï¼‰ã€‚å³æ­¤æ—¶å¤„ç†å™¨åœ¨ç‰¹æƒçº§æœ€ä½çš„ï¼ˆ3çº§ï¼‰ç”¨æˆ·ä»£ç ä¸­è¿è¡Œã€‚å½“æ­£åœ¨æ‰§è¡Œç”¨æˆ·ç¨‹åºè€Œçªç„¶è¢«ä¸­æ–­ç¨‹åºä¸­æ–­æ—¶ï¼Œæ­¤æ—¶ç”¨æˆ·ç¨‹åºä¹Ÿå¯ä»¥è±¡å¾æ€§åœ°ç§°ä¸ºå¤„äºè¿›ç¨‹çš„å†…æ ¸æ€ã€‚å› ä¸ºä¸­æ–­å¤„ç†ç¨‹åºå°†ä½¿ç”¨å½“å‰è¿›ç¨‹çš„å†…æ ¸æ ˆã€‚è¿™ä¸å¤„äºå†…æ ¸æ€çš„è¿›ç¨‹çš„çŠ¶æ€æœ‰äº›ç±»ä¼¼ã€‚     ä¾‹ï¼š        #cat /etc/passwd        åœ¨ç”¨æˆ·çº§åˆ«æ‰§è¡Œcat     //è¿™äº›å¼€é”€å°±æ˜¯ç”¨æˆ·çš„å¼€é”€        è¦ç”¨catæŸ¥çœ‹æ–‡ä»¶ï¼Œå¿…é¡»å¾—å»ç¡¬ç›˜ä¸Šæ‰¾æ–‡ä»¶ï¼Œé‚£ä¹ˆéœ€è¦æœ‰ç¡¬ç›˜é©±åŠ¨ï¼Œè¿™æ ·å°±ä¼šéœ€è¦å†…æ ¸ï¼Œæ‰€ä»¥å°±ä¼šç”¨åˆ°ç³»ç»Ÿè°ƒç”¨ï¼Œå› ä¸ºæœ‰äº†ç³»ç»Ÿè°ƒç”¨æ‰èƒ½è·Ÿå†…æ ¸å¯¹è¯  //è¿™äº›å¼€é”€å°±æ˜¯å†…æ ¸æ€çš„å¼€é”€        åœ¨å†…å­˜é‡Œå°±ä¼šæœ‰ä¸€ä¸ªcatå‘½ä»¤çš„è¿›ç¨‹ æŠŠcatå‘½ä»¤æ‰€éœ€è¦çš„Libåº“å‡†å¤‡å¥½    å¸¸ç”¨çš„ç³»ç»Ÿè°ƒç”¨    open()    read()    write()    close()    us &gt; sy    ç”¨æˆ·çš„å¼€é”€ä¸€èˆ¬å¤§äºç³»ç»Ÿå¼€é”€    usä¸€èˆ¬ä¸ä¼šè¶…è¿‡%70ï¼Œå¦‚æœå¤§äº%70ï¼Œé‚£çœ‹çœ‹æ˜¯ä¸æ˜¯è¿è¡Œçš„ç¨‹åºæ˜¯å¦è¿‡å¤šæˆ–è€…ä¸€ä¸ªç±»ä¼¼æ­»å¾ªç¯çš„ç¨‹åº    syä¸€èˆ¬ä¸ä¼šè¶…è¿‡%30ï¼Œå¦‚æœå¤§äº%30ï¼Œé‚£çœ‹çœ‹æ˜¯ä¸æ˜¯è¿è¡Œäº†å¤§é‡çš„å†…æ ¸æ€ç¨‹åºï¼Œæ¯”å¦‚iptableså’Œlvséƒ½æ˜¯å†…æ ¸æ€ç¨‹åº    â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦    ni  niceå€¼çš„è°ƒæ•´å¯èƒ½ä¸¤ç§æƒ…å†µ:ç³»ç»Ÿè‡ªåŠ¨å»è°ƒæ•´æˆ–è€…äººå·¥è°ƒæ•´  é‚£ä¹ˆè¿™é‡Œçš„ç™¾åˆ†æ¯”æ˜¯æŒ‡äººå·¥è°ƒæ•´    id  ç©ºé—²å¤ªé«˜ä¸å¥½ï¼Œæµªè´¹èµ„æºï¼Œé‚£ä¹ˆåœ¨20-30ä¹‹é—´æœ€å¥½        å¦‚æœ%idle çš„å€¼é«˜ä½†ç³»ç»Ÿå“åº”æ…¢æ—¶ï¼Œæœ‰å¯èƒ½æ˜¯ CPU ç­‰å¾…åˆ†é…å†…å­˜ï¼Œæ­¤æ—¶åº”åŠ å¤§å†…å­˜å®¹é‡        å¦‚æœ%idle çš„å€¼æŒç»­ä½äº1ï¼Œåˆ™ç³»ç»Ÿçš„ CPU å¤„ç†èƒ½åŠ›ç›¸å¯¹è¾ƒä½ï¼Œè¡¨æ˜ç³»ç»Ÿä¸­æœ€éœ€è¦è§£å†³çš„èµ„æºæ˜¯ CPU ã€‚    wa        aåœ¨è¿è¡Œè¿‡ç¨‹å½“ä¸­è¦äº§ç”Ÿ10Gæ•°æ®ï¼Œç°åœ¨å…ˆäº§ç”Ÿäº†2Gï¼Œcpuè¯´ä½ å…ˆåœï¼Œä½ å…ˆæŠŠè¿™2Gå†™åˆ°ç¡¬ç›˜ä¸Šï¼Œä½†æ˜¯ç°åœ¨ç¡¬ç›˜æ…¢ï¼Œcpuè¦ç­‰ï¼Œæ‰€ä»¥ä»–å¯ä»¥å»æ‰¾bå»è¿è¡Œï¼Œç°åœ¨bç¨‹åºå‘ç”Ÿäº†å’Œaä¸€æ ·çš„æƒ…å†µï¼Œä¹Ÿåœ¨å¾€ç¡¬ç›˜å†™æ•°æ®ï¼Œé‚£ä¹ˆcpuç°åœ¨å¹²ä»€ä¹ˆï¼Ÿåœ¨ç­‰ï¼Œè¿™æ—¶å€™çš„ç­‰å¾…çŠ¶æ€æˆ‘ä»¬ç§°ä»–ä¸ºç©ºè½¬çŠ¶æ€ï¼Œæ‰€ä»¥é€šè¿‡è¿™ä¸ªæ•°å€¼å¯ä»¥åˆ¤æ–­ç¡¬ç›˜æ…¢ä¸æ…¢        å¦‚æœ%iowait çš„å€¼è¿‡é«˜ï¼Œè¡¨ç¤ºç¡¬ç›˜å­˜åœ¨I/Oç“¶é¢ˆ    hi          ä¸­æ–­ï¼šå¯¹cpuå½“å‰æ“ä½œçš„ä¸€ä¸ªæ‰“æ–­        ç¡¬ä¸­æ–­ï¼Œä¹Ÿå°±æ˜¯ç¡¬ä»¶äº§ç”Ÿçš„ä¸­æ–­ï¼ˆæ¯”å¦‚é”®ç›˜ï¼Œé¼ æ ‡ï¼Œç½‘å¡ï¼‰åœ¨å®é™…å·¥ä½œå½“ä½œï¼Œç½‘å¡äº§ç”Ÿçš„ä¸­æ–­æœ€å¤šï¼Œ    si  è½¯ä»¶ä¸­æ–­ï¼Œæ¯”å¦‚è¯´è®¡åˆ’ä»»åŠ¡        ç¡¬ä¸­æ–­ä¼˜å…ˆçº§æ¯”è½¯ä¸­æ–­ä¼˜å…ˆçº§é«˜    st    è¿™ä¸ªæ•°å€¼æ˜¯é’ˆå¯¹è™šæ‹Ÿæœºçš„  ä»–çš„å€¼æˆ‘ä»¬çœ‹ä¸åˆ°        vm1        vm2          //è™šæ‹Ÿæœº        vcpu     vcpu            //è™šæ‹Ÿcpu        cpu                        //çœŸå®cpu        å‡å¦‚ç°åœ¨vm1æ­£åœ¨ä½¿ç”¨vcpuï¼Œé‚£ä¹ˆä»–å®é™…ä¸Šç”¨çš„æ˜¯cpuï¼Œé‚£ä¹ˆè¿™æ—¶å€™å¦‚æœvm2è¦ä½¿ç”¨cpuçš„è¯ï¼Œä¸èƒ½ç”¨ï¼Œå› ä¸ºç°åœ¨cpuæ­£è¢«vm1å·èµ°äº†-------------------------------------------------------------buffers cached    cachedè¿™ä¸ªæ˜¯å±äºmemé‚£ä¸€è¡Œçš„ï¼Œè¯´æ˜¯è¿™é‡Œæ”¾ä¸ä¸‹äº†æ‰€ä»¥æ‰æ”¾åˆ°äº†ä¸‹é¢    ä¸¤è€…éƒ½æ˜¯RAMä¸­çš„æ•°æ®ã€‚ç®€å•æ¥è¯´ï¼Œbufferæ˜¯å³å°†è¦è¢«å†™å…¥ç£ç›˜çš„ï¼Œcacheæ˜¯è¢«ä»ç£ç›˜ä¸­è¯»å‡ºæ¥çš„ã€‚        bufferæ˜¯ç”±å„ç§è¿›ç¨‹åˆ†é…çš„ï¼Œè¢«ç”¨åœ¨å¦‚è¾“å…¥é˜Ÿåˆ—ç­‰æ–¹é¢ï¼Œç´¢å¼•ç¼“å­˜ï¼Œå­˜inodeä¿¡æ¯ã€‚ä¸€ä¸ªç®€å•çš„ä¾‹å­å¦‚æŸä¸ªè¿›ç¨‹è¦æ±‚æœ‰å¤šä¸ªå­—æ®µè¯»å…¥ï¼Œåœ¨æ‰€æœ‰å­—æ®µè¢«è¯»å…¥å®Œæ•´ä¹‹å‰ï¼Œè¿›ç¨‹æŠŠå…ˆå‰è¯»å…¥çš„å­—æ®µæ”¾åœ¨bufferä¸­ä¿å­˜ã€‚        cacheç»å¸¸è¢«ç”¨åœ¨ç£ç›˜çš„I/Oè¯·æ±‚ä¸Šï¼Œå­˜blockä¿¡æ¯ï¼Œå¦‚æœæœ‰å¤šä¸ªè¿›ç¨‹éƒ½è¦è®¿é—®æŸä¸ªæ–‡ä»¶ï¼Œäºæ˜¯è¯¥æ–‡ä»¶ä¾¿è¢«åšæˆcacheä»¥æ–¹ä¾¿ä¸‹æ¬¡è¢«è®¿é—®ï¼Œè¿™æ ·å¯æé«˜ç³»ç»Ÿæ€§èƒ½ã€‚    æ‰‹åŠ¨é‡Šæ”¾bufferså’Œcached:    #echo 3 &gt; /proc/sys/vm/drop_caches  =======================ä¼˜å…ˆçº§    ä½œç”¨ï¼š        1ã€ä¼˜å…ˆçº§é«˜ä¼šè¢«ä¼˜å…ˆè°ƒåº¦ã€‚        2ã€æ—¶é—´ç‰‡ä¼šä¸åŒã€‚    èŒƒå›´ï¼š        æ—©å…ˆä¼˜å…ˆçº§èŒƒå›´     niceèŒƒå›´        0                              -20        20                          0        39                         19        0~39                    -20~19        ç°åœ¨ï¼š        0-139  linuxä¼˜å…ˆçº§çš„æ•´ä¸ªèŒƒå›´ï¼Œå…¶ä¸­0å·ä¸ºä¼˜å…ˆçº§æœ€é«˜ï¼Œ139ä¸ºæœ€ä½            0-99        RTå®æ—¶è¿›ç¨‹(é™æ€)ä¼˜å…ˆçº§èŒƒå›´ ï¼Œ 0å·ä¿ç•™ï¼Œè®¾ç½®æ—¶ä½¿ç”¨1-99            100-139  éå®æ—¶è¿›ç¨‹(åŠ¨æ€)çš„ä¼˜å…ˆçº§åˆ«èŒƒå›´ (ç”±niceå€¼æ˜ å°„è¿‡æ¥)         åˆ†ç±»ï¼š            åŠ¨æ€ä¼˜å…ˆçº§å’Œé™æ€ä¼˜å…ˆçº§                topé‡Œé¢æ˜¾ç¤ºçš„PRæ˜¯åŠ¨æ€ä¼˜å…ˆçº§ï¼Œæ•°å€¼è¶Šå°æœ‰é™çº§è¶Šé«˜                SYSVåˆåŠ äº†60ä¸ªä¼˜å…ˆçº§  ï¼Œé‚£60ä¸ªä¼˜å…ˆçº§å°±æ˜¯é™æ€ä¼˜å…ˆçº§                ç°åœ¨Linuxåœ¨ä¹‹å‰40ä¸ªä¼˜å…ˆçº§çš„åŸºç¡€ä¸ŠåŠ äº†100ä¸ªé™æ€ä¼˜å…ˆçº§ï¼ŒRT        å®æ—¶ä¼˜å…ˆçº§è‚¯å®šå¤§äºéå®æ—¶ä¼˜å…ˆçº§        å®é™…ä¼˜å…ˆçº§èŒƒå›´æ˜¯99ä¼˜å…ˆçº§æœ€å¤§ï¼Œ0æœ€å°ï¼Œåœ¨å¾€åï¼Œä»RTçš„è§’åº¦æ¥çœ‹å…¨æ˜¯0ï¼Œä½†æ˜¯å®é™…æ˜¯0-39            0--------------------99 100-----------139          æ•´ä¸ªä¼˜å…ˆçº§èŒƒå›´           -99---FIFO RR---------0--------------0    ä»RTçš„è§’åº¦çœ‹åé¢ä¼˜å…ˆçº§éƒ½æ˜¯0                                          0--------------39   åé¢éƒ¨åˆ†å®é™…ä¼˜å…ˆçº§    æŸ¥çœ‹å®æ—¶è¿›ç¨‹ä¼˜å…ˆçº§ï¼š        # chrt -p 5752        //pidä¸º5752çš„è¿›ç¨‹åœ¨topå†…æ˜¾ç¤ºPRä¸º20,ä½†æ˜¯åœ¨ä»RTçš„è§’åº¦æ¥çœ‹æ˜¯0             pid 5752&#39;s current scheduling policy: SCHED_OTHER        pid 5752&#39;s current scheduling priority: 0                          ä¼˜å…ˆçº§ä¸€æ ·çš„æ—¶å€™å…ˆæ‰§è¡Œè°ï¼Ÿ        æ—©æœŸï¼šå•cpu,å•ç”¨æˆ·ï¼Œå•ä»»åŠ¡            åœ¨è¿è¡Œä¸€ä¸ªåº”ç”¨ç¨‹åºçš„æ—¶å€™ï¼Œä½¿ç”¨å†…å­˜ï¼Œä¼šæœ‰ç©ºé—²å†…å­˜ï¼Œcpuç©ºé—²ï¼Œç¡¬ç›˜ç©ºé—²            ä½†æ˜¯å½“æ—¶çš„ç¡¬ä»¶é…ç½®ç›¸å½“ä½(æ¯”å¦‚4kçš„å†…å­˜)ï¼Œè€Œä¸”æ‰§è¡Œå¾ˆå¿«(æ±‡ç¼–å†™çš„ç¨‹åº)ï¼Œæ‰€ä»¥ä¹Ÿä¸ä¼šå‡ºç°èµ„æºæµªè´¹ï¼Œé‚£ä¹ˆç°åœ¨éšç€ç¡¬ä»¶çš„æ€§èƒ½æé«˜å°±ä¼šå‡ºç°èµ„æºæµªè´¹ç°è±¡        ç°åœ¨ï¼šå¤šcpu,å¤šç”¨æˆ·ï¼Œå¤šä»»åŠ¡            å‡å¦‚æœ‰ä¸€ä¸ªåº”ç”¨ç¨‹åºå ç”¨CPUæ—¶é—´å¤ªé•¿ï¼Œé‚£ä¹ˆåé¢çš„ç¨‹åºä¼šæ— æ³•æ‰§è¡Œ            æ‰€ä»¥å†…æ ¸ä¼šå¯¹åŒä¼˜å…ˆçº§çš„ç¨‹åºè¿›ç¨‹åˆ¤æ–­æ˜¯cpuæ¶ˆè€—å‹è¿˜æ˜¯IOæ¶ˆè€—å‹ï¼ŒIOæ¶ˆè€—å‹çš„ç¨‹åºå¹¶ä¸æ˜¯ä¸ä½¿ç”¨cpuï¼Œåªæ˜¯ç”¨çš„æ—¶é—´å¾ˆçŸ­ï¼Œæ‰€ä»¥æˆ‘ä»¬è®©ä»–ä»¬ä¸¤ä¸ªéƒ½å¯ä»¥è¿è¡Œï¼Œä½†æ˜¯åœ¨ioæ¶ˆè€—å‹ç¨‹åºä½¿ç”¨cpuçš„æ—¶å€™ä¸´æ—¶ç»™ä»–è°ƒæ•´ä¸€ä¸‹ä¼˜å…ˆçº§            å†…æ ¸å¯ä»¥è®©cpuæ¶ˆè€—å‹åœ¨+5èŒƒå›´å†…ä¼˜å…ˆçº§è¿›ç¨‹åç§»ï¼Œioæ¶ˆè€—å‹åœ¨-5èŒƒå›´å†…ä¼˜å…ˆçº§è¿›ç¨‹åç§»ï¼Œæ‰€ä»¥è¿™é‡Œçš„ä¼˜å…ˆçº§æ˜¯åŠ¨æ€ä¼˜å…ˆçº§ï¼Œ            ç¨‹åºåˆ†ä¸ºå‡ ç§:1.cpuæ¶ˆè€—å‹ï¼ˆè®¡ç®—ï¼‰ 2.IOæ¶ˆè€—å‹ï¼ˆé€šå¸¸å¦‚æœä¸æ˜¯æ¶æ„ç¨‹åºï¼ŒåŸºæœ¬ä¸Šå°±æ˜¯IOæ¶ˆè€—å‹ï¼Œæ¯”å¦‚QQï¼Œåªæœ‰åœ¨æ”¶å‘ä¿¡æ¯çš„ä¸€ç¬é—´æ‰ä¼šæ¶ˆè€—cpuã€‚å¬æ­Œæ¶ˆè€—çš„æ˜¯ç¡¬ç›˜å’Œå£°å¡ä¹Ÿæ˜¯IOæ¶ˆè€—å‹ï¼‰        cpuæ¶ˆè€—å‹çš„ priå€¼ä¸º80~85 85æ ‡å‡†cpuæ¶ˆè€—å‹ï¼Œå¦‚ï¼šæ­»å¾ªç¯            ioæ¶ˆè€—å‹çš„    priå€¼ä¸º75~80  75æ ‡å‡†ioæ¶ˆè€—å‹ï¼Œå¾€å¾€æ˜¯å’Œç”¨æˆ·äº¤äº’çš„ç¨‹åºï¼Œå¦‚ï¼šbash,viï¼Œä¸‹è½½    æœ¬èº«å CPUå¹¶ä¸å¤šï¼Œä½†I/0æ¶ˆè€—å¤š    è°ƒæ•´ä¼˜å…ˆçº§ï¼š        å¯ä»¥é€šè¿‡reniceå‘½ä»¤è°ƒæ•´niceå€¼,priå€¼è°ƒæ•´ä¸äº†,ç³»ç»Ÿè‡ªå·²è¯„ä¼°.        æˆ‘ä»¬è®¾ç½®ä¼˜å…ˆçº§åˆ«ï¼Œè®¾ç½®çš„æ˜¯nice å€¼ï¼Œå®é™…ç³»ç»Ÿçœ‹çš„æ˜¯priå€¼ã€‚ç”¨æˆ·è°ƒæ•´niceå€¼ï¼Œç³»ç»Ÿä¼šå¹²é¢„priå€¼        ç³»ç»Ÿè¦è€ƒè™‘åœ¨ä¸¤ç§è¿›ç¨‹çš„niceå€¼ä¸€æ ·çš„æƒ…å†µä¸‹,i/oæ¶ˆè€—å‹çš„è¿›ç¨‹åº”è¯¥ä¼˜å…ˆçº§åˆ«æ›´é«˜ä¸€äº›(ä¹Ÿå°±æ˜¯priå€¼æ›´å°)             ps -l              pri  ni              77   0   ps             75   0   bash        bash  å…¸å‹çš„I/0æ¶ˆè€—å‹,priå€¼å¤§æ¦‚ä¸º75        priæ˜¯ç³»ç»Ÿä»¥niceå€¼ä¸ºåŸºæ•°çš„è°ƒæ•´            pri æµ®åŠ¨èŒƒå›´    85 &lt;---- 80 -----&gt; 75                                CPU                      I/O       è¿›ç¨‹é˜Ÿåˆ—ä¸­å¦‚æœæœ‰å®æ—¶è¿›ç¨‹é™¤éå®ƒé‡Šæ”¾èµ„æº,æ‰æ‰§è¡Œéå®æ—¶è¿›ç¨‹.å½“ç„¶å®æ—¶è¿›ç¨‹ä¹Ÿæœ‰ä¼˜å…ˆçº§åˆ«é«˜çš„,å…ˆæ‰§è¡Œå®Œé«˜ä¼˜å…ˆçº§çš„æ‰æ‰§è¡Œä¸€ä¸‹ä¸ªè¿›ç¨‹.</code></pre><p><strong>è°ƒåº¦ç­–ç•¥</strong></p><pre><code>       æŸ¥çœ‹æ‰€æœ‰è°ƒåº¦ç­–ç•¥ï¼š        #chrt -m              SCHED_OTHER min/max priority    : 0/0            SCHED_FIFO min/max priority    : 1/99            SCHED_RR min/max priority    : 1/99            SCHED_BATCH min/max priority    : 0/0            SCHED_IDLE min/max priority    : 0/0            1/99æ˜¯å®æ—¶è¿›ç¨‹ä½¿ç”¨çš„è°ƒåº¦ç­–ç•¥            0/0éå®æ—¶è¿›ç¨‹ä½¿ç”¨çš„è°ƒåº¦ç­–ç•¥            FIFO     å…ˆè¿›å…ˆå‡ºï¼Œè°å…ˆæ¥ï¼Œå¤„ç†è°            RR       åˆ†æ—¶ç®—æ³•ï¼Œç¨‹åºè¢«åˆ†é…æ—¶é—´ç‰‡ï¼Œæ¯ä¸ªç¨‹åºä½¿ç”¨ä¸€ä¼šå„¿            OTHER è·ŸRRä¸€æ ·è®ºè¯¢ï¼Œå¦‚æœæ²¡æœ‰ç‰¹æ®Šæƒ…å†µè·ŸRRä¸€æ ·            BATCH  æ‰¹å¤„ç†ï¼Œæ¥5ä¸ªäººå¤„ç†ä¸€æ¬¡            IDLE             FIFO å’Œ RR å±äºå®æ—¶è¿›ç¨‹ï¼ˆä¹Ÿå«é™æ€ä¼˜å…ˆçº§è¿›ç¨‹ï¼‰çš„è°ƒåº¦ç­–ç•¥ã€‚ä¼˜å…ˆçº§é«˜äºéå®æ—¶è¿›ç¨‹ï¼ˆåŠ¨æ€ä¼˜å…ˆçº§è¿›ç¨‹ï¼‰ BATCHå’ŒOTHER ï¼Œå¦‚æœä¸€ä¸ªå®æ—¶è¿›ç¨‹å‡†å¤‡è¿è¡Œï¼Œè°ƒåº¦å™¨æ€»æ˜¯è¯•å›¾å…ˆè°ƒåº¦å®æ—¶è¿›ç¨‹ã€‚            BATCHæ˜¯2.6å†…æ ¸æ–°åŠ å…¥çš„ç­–ç•¥ï¼Œè¿™ç§ç±»å‹é¢è¿›ç¨‹ä¸€èˆ¬éƒ½æ˜¯åå°å¤„ç†è¿›ç¨‹ï¼Œæ€»æ˜¯å€¾å‘äºè·‘å®Œè‡ªå·±çš„æ—¶é—´ç‰‡ï¼Œæ²¡æœ‰äº¤äº’æ€§ï¼Œå¯¹äºè¿™æ ·çš„è°ƒåº¦ç­–ç•¥ï¼Œè°ƒåº¦å™¨ä¸€èˆ¬ç»™çš„ä¼˜å…ˆçº§æ¯”è¾ƒä½ã€‚å¦‚æœæœ‰ä¸€ä¸ªç¨‹åºè®¾ç½®æˆBATCHï¼Œcpuä¼šå°½é‡ç»™è¿™ä¸ªç¨‹åºä½¿ç”¨ï¼Œä½†æ˜¯ä¸€æ—¦æœ‰OTHERï¼Œé‚£ä¹ˆå…ˆç»™OTHERç­–ç•¥çš„ç¨‹åº ï¼Œä¹Ÿå°±æ˜¯OTHERä¼˜å…ˆçº§é«˜            IDLEæ˜¯åªè¦æœ‰å…¶ä»–ç¨‹åºè¿è¡Œï¼Œæˆ‘å°±ä¸è¿è¡Œï¼Œä¹Ÿå°±æ˜¯åªæœ‰åœ¨cpuç©ºé—²çš„æ—¶å€™å°±æŠŠè¿™ä¸ªç¨‹åºè®¾ç½®æˆIDLE            OTHER&gt;BATCH&gt;IDLE            IDLEçš„niceå€¼æ¯”19è¿˜è¦ä½ï¼Œrhel6æ–°å‡ºçš„ï¼Œrhel5æ²¡æœ‰        ä¿®æ”¹è°ƒåº¦ç­–ç•¥ï¼š                #chrt  è°ƒåº¦ä¸­å®æ—¶è¿›ç¨‹çš„ä¼˜å…ˆçº§å¯ä»¥è®©ä¸€ä¸ªéå®æ—¶è¿›ç¨‹ä»¥å®æ—¶è¿›ç¨‹çš„æ–¹å¼è¿è¡Œï¼Œä¹Ÿç›¸å½“ä¸æé«˜äº†è¿™ä¸ªè¿›ç¨‹çš„ä¼˜å…ˆçº§                #cat     æ‰§è¡Œä¸€ä¸ªcatå‘½ä»¤                #ps -e | grep cat  æŸ¥çœ‹PID                6183                #chrt -p 6183   æŸ¥çœ‹é»˜è®¤ç­–ç•¥                #chrt -p 10 6183   ä¼˜å…ˆçº§æ”¹æˆ10ï¼Œé»˜è®¤ç­–ç•¥å˜æˆRR                 #chrt -f 20 cat    åœ¨å¼€å§‹è¿è¡Œcatå‘½ä»¤çš„æ—¶å€™åˆ¶å®šä¼˜å…ˆçº§ï¼Œç­–ç•¥ä¸ºFIFO         top ä¸­æœ‰RTå­—æ ·çš„æ˜¯å®æ—¶è¿›ç¨‹ï¼š                ä¾‹å¦‚ï¼š                    2 root      RT  -5     0    0    0 S  0.0  0.0   0:00.00 migration/0                  # ps -el  //ç»“æœä¸­NIå€¼ä¸º-çš„æ˜¯å®æ—¶è¿›ç¨‹                 åªè¦å®æ—¶è¿›ç¨‹å¤„äºrçŠ¶æ€ é‚£ä¹ˆéå®æ—¶è¿›ç¨‹å°±æ²¡æœ‰æ—¶é—´ç‰‡äº†                pid 10ä»¥å†…çš„è¿›ç¨‹ä¸ºå†…æ ¸è¿›ç¨‹ æ˜¯å†…æ ¸çš„ä¸€éƒ¨åˆ†</code></pre><h4 id="cpuäº²å’ŒåŠ›"><a href="#cpuäº²å’ŒåŠ›" class="headerlink" title="cpuäº²å’ŒåŠ›"></a>cpuäº²å’ŒåŠ›</h4><pre><code>cpuäº²å’ŒåŠ›ï¼ˆä¹Ÿå°±æ˜¯cpuç»‘å®šï¼‰ç³»ç»Ÿèµ„æºä¸å¤Ÿç”¨ï¼Œä¸€å°æœºå­ä¸Šè·‘äº†å‡ ä¸ªæ¯”è¾ƒé‡è¦çš„æœåŠ¡ï¼Œæ¯å¤©æˆ‘ä»¬è¿˜è¦åœ¨ä¸Šé¢è¿›è¡Œä¸ªå¤‡ä»½å‹ç¼©ç­‰å¤„ç†ï¼Œç½‘ç»œé•¿æ—¶é—´ä¼ è¾“ï¼Œè¿™å°±å¾ˆå½±å“æœ¬å°±ä¸å¤Ÿç”¨çš„ç³»ç»Ÿèµ„æºï¼›è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±å¯ä»¥æŠŠä¸€äº›ä¸å¤ªé‡è¦çš„æ¯”å¦‚copy/å¤‡ä»½/åŒæ­¥ç­‰å·¥ä½œé™å®šåœ¨ä¸€é¢—cpuä¸Šï¼Œæˆ–è€…æ˜¯å¤šæ ¸çš„cpuçš„ä¸€é¢—æ ¸å¿ƒä¸Šè¿›è¡Œå¤„ç†ï¼Œè™½ç„¶è¿™ä¸ä¸€å®šæ˜¯æœ€æœ‰æ•ˆçš„æ–¹æ³•ï¼Œä½†å¯ä»¥æœ€å¤§ç¨‹åº¦ä¸Šåˆ©ç”¨äº†æœ‰æ•ˆèµ„æºï¼Œé™ä½é‚£äº›ä¸å¤ªé‡è¦çš„è¿›ç¨‹å ç”¨cpuèµ„æºï¼›cpuç»‘å®šï¼š      æŠŠä¸€ä¸ªç¨‹åºç»‘å®šåˆ°ä¸€ä¸ªcpuä¸Šå»æ‰§è¡Œ    å¥½å¤„ï¼š        1.å¤šæ ¸cpuä½¿ç”¨çš„æ—¶å€™ï¼Œå†…æ ¸ä¼šä¼˜å…ˆä½¿ç”¨0ï¼Œ1å·cpuï¼Œå‡å¦‚æœ‰4æ ¸ï¼Œ2ï¼Œ3å·å¯èƒ½ä¼šåˆ©ç”¨ç‡æ¯”è¾ƒä½ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥æŠŠä¸åŒçš„ç¨‹åºç»‘å®šåˆ°2ï¼Œ3å·cpuä¸Šä»¥æé«˜cpuä½¿ç”¨ç‡        2.å¯ä»¥æé«˜ç¼“å­˜å‘½ä¸­ç‡    å®‰è£…è½¯ä»¶ï¼š        util-linux-ng-2.17.2-12.9.el6.x86_64    æŸ¥çœ‹cpuç»‘å®š:        # taskset -p 1         pid 1&#39;s current affinity mask: 3        affinity //cpuäº²å’ŒåŠ›(ä¹Ÿå°±æ˜¯cpuç»‘å®š)        å‡å¦‚4æ ¸cpuï¼š3 2 1 0   cpuç¼–å·ä»0å¼€å§‹        2^3+2^2+2^1+2^0=å’Œ å†æŠŠå’Œæ¢ç®—æˆ16è¿›åˆ¶å°±æ˜¯maskåé¢çš„å€¼ï¼Œå¯ä»¥åˆ©ç”¨è¿™ä¸ªç®—å¼å’Œå€¼æ‰¾åˆ°æˆ‘ä»¬æ­£åœ¨ä½¿ç”¨å“ªä¸ªcpu    ç»‘å®šcpu:        #taskset -c 1ï¼Œ2 cat         æŠŠcatç¨‹åºç»‘å®šåˆ°1å·å’Œ2å·cpuä¸Šæ‰§è¡Œ    ä¿®æ”¹å·²ç»å¯åŠ¨è¿›ç¨‹çš„cpuç»‘å®šï¼š        # taskset -pc 0 11358        è®©è¿›ç¨‹11358è¿è¡Œåœ¨0å·cpuä¸Š=======================================å¤šå¹¶å‘ï¼š    å¤šæ ¸æƒ…å†µä¸‹ä»¥çº¿ç¨‹æ–¹å¼è¿è¡Œæ•ˆæœæ›´å¥½ä¸€äº›,å•æ ¸çš„è¯åŒºåˆ«å°±ä¸å¤§äº†    è¿›ç¨‹å’Œçº¿ç¨‹ æœ‰æœ¬è´¨çš„åŒºåˆ«        çº¿ç¨‹æ¨¡å¼      åˆ›å»ºå’Œæ’¤é”€å¼€é”€å°  èµ„æºç«äº‰é—®é¢˜        è¿›ç¨‹æ¨¡å¼         åˆ›å»ºå’Œæ’¤é”€å¼€é”€å¤§  æ²¡æœ‰èµ„æºç«äº‰é—®é¢˜    å¦‚apache çº¿ç¨‹å’Œè¿›ç¨‹æ¨¡å¼ å¤šæ ¸æ¯ç§’å¤„ç†å¹¶å‘è®¿é—®é‡ è¾¾åˆ°1000 ï¼Œè¿™æ—¶çº¿ç¨‹è¡¨ç°è¾ƒå¥½æµ‹è¯•ï¼š#ab -n 1000 -c 1000 http://localhostå½“2000æ—¶ apache æŒ‚äº†  abå‘½ä»¤æœ€å¤šæ”¯æŒ2ä¸ªä¸‡æµ‹è¯•    æµ‹è¯•nginx    å•è¿›ç¨‹å’Œå¤šè¿›ç¨‹    åŠ å¤§é¡µé¢å†…å®¹    cps æ¯ç§’çš„å¹¶å‘è¿æ¥æ•°(TCP)    qps æ¯ç§’çš„å¹¶å‘è¯·æ±‚æ•° GET/HEAD/DELETE/PUT--------------------------------------å¹³è¡¡cpuä¸­æ–­:        ä¸Šä¸‹æ–‡åˆ‡æ¢:        cpuè¯»å–æ•°æ®çš„æ—¶å€™ä¼šä»L1,L2,L3ç­‰ä¸€çº§äºŒçº§ä¸‰çº§ç¼“å­˜é‡Œé¢è¯»ï¼Œå…ˆå»L1æ‰¾ï¼ŒL1æ²¡æœ‰ï¼Œå»L2é‡Œæ‰¾ï¼ŒL2æ²¡æœ‰ï¼Œå»L3æ‰¾ï¼ŒL3æ²¡æœ‰æ‰¾å†…å­˜ï¼Œå†…å­˜æ²¡æœ‰æ‰¾ç¡¬ç›˜ã€‚        å¦‚æœAè¢«å¤„ç†è¦æŠŠAæ”¾åˆ°L1é‡Œé¢ï¼Œé‚£ä¹ˆç°åœ¨Béœ€è¦å¤„ç†ï¼Œæ‰€ä»¥éœ€è¦æŠŠBæ”¾åˆ°L1é‡Œï¼Œé‚£ä¹ˆåŸæ¥L1é‡Œçš„Aæ¸…é™¤æ‰ï¼Œè¿™å°±æ˜¯ä¸Šä¸‹æ–‡åˆ‡æ¢    å½“äº§ç”Ÿä¸­æ–­çš„æ—¶å€™å°±ä¼šäº§ç”Ÿä¸€æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢    aè¿˜æ²¡æœ‰è¿è¡Œå®Œçš„æ—¶å€™ï¼Œå‡ºç°ä¸€ä¸ªä¸­æ–­ä¿¡å·ï¼Œcpuä¼šå¤„ç†è¿™ä¸ªä¸­æ–­ï¼Œå¤„ç†å®Œæˆå†å›æ¥å¤„ç†a    é‚£ä¹ˆæ‰“æ–­å¤šäº†å¥½è¿˜æ˜¯å°‘äº†å¥½?ä¸ä¸€å®šï¼Œå¤šæœ‰å¤šçš„å¥½å¤„ï¼Œå°‘æœ‰å°‘çš„å¥½å¤„        æ‰“æ–­å°‘äº†ä¼šå¢åŠ ååé‡ï¼Œä½†æ˜¯å“åº”å°±ä¼šå˜æ…¢        æ‰€ä»¥åœ¨ä¸­æ–­çš„æ—¶å€™è¦è€ƒè™‘æ˜¯è¦ååé‡è¿˜æ˜¯è¦å“åº”èƒ½åŠ›    å‡å¦‚æˆ‘æ˜¯4æ ¸cpuï¼š        æˆ‘ä»¬å‘ç°å¤§éƒ¨åˆ†ä¸­æ–­éƒ½é›†ä¸­åœ¨ä¸€ä¸ªcpuä¸Šï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å¹³è¡¡ä¸­æ–­ï¼ŒæŠŠä¸­æ–­å¹³åˆ†åˆ°å…¶ä»–cpuä¸Šå»            #cat /proc/interrupts   æ˜¾ç¤ºç³»ç»Ÿå†…å·²ç»æ³¨å†Œçš„ä¸­æ–­            ç¬¬1åˆ—æ³¨å†Œäº†çš„ä¸­æ–­ç¼–å·   ç¬¬2ï¼Œ3ï¼Œ4ï¼Œ5åˆ— æ¯ä¸ªcpuå¤„ç†äº†å¤šå°‘æ¬¡ä¸­æ–­        è‡ªåŠ¨å¹³è¡¡ï¼Œrhel6ç›´æ¥å¯åŠ¨è¿™ä¸ªå‘½ä»¤å°±å¯ä»¥            #/etc/init.d/irqbalance start              rhel5é‡Œé¢æ²¡æœ‰è‡ªåŠ¨å¹³è¡¡ï¼Œåªèƒ½æ‰‹å·¥å¹³è¡¡            rhel6å¦‚æœæƒ³æ‰‹å·¥å¹³è¡¡çš„è¯ï¼Œéœ€è¦å…³é—­ä¸Šé¢çš„irqbalanceæœåŠ¡            æ‰‹å·¥å¹³è¡¡å®éªŒï¼š                ç¡®å®šæƒ³è°ƒæ•´è°ï¼Œå°±è®°ä½ä»–çš„ä¸­æ–­ç¼–å·ï¼Œç„¶åå»/proc/irq/é‡Œé¢æ‰¾åˆ°ç›¸åº”çš„ç¼–å·ï¼Œæ¯”å¦‚23  /proc/irq/23                #cat /proc/irq/23/smp_affinity  è¿™ä¸ªæ–‡ä»¶é‡Œçš„å€¼å°±æ˜¯äº²å’ŒåŠ›ï¼Œç®—æ³•ä¸€æ ·è·Ÿä¹‹å‰ä¸€æ ·                å®éªŒï¼š                #watch -n 1 cat /proc/interrupts   1ç§’é’Ÿç›‘æ§ä¸€æ¬¡åé¢çš„ç¨‹åº                ç„¶åæ‹¿å¦ä¸€å°æœºå™¨ä¸€ç›´pingè¿™å°ç›‘æ§æœºå™¨ï¼Œæˆ‘ä»¬å‘ç°ç½‘å¡ä¸­æ–­åœ¨cpu0ä¸Šï¼Œé‚£ä¹ˆç°åœ¨è¦æ±‚æŠŠç½‘å¡ä¸­æ–­äº¤ç»™cpu1å¤„ç†                28:   25202611    1428501   PCI-MSI-edge      eth0                #echo 2 &gt; /proc/irq/28/smp_affinity                å‘ç°ä¸­æ–­ä¼šè·‘åˆ°ç¬¬2å—å„¿cpuä¸Š</code></pre><h4 id="cpuç›‘æ§"><a href="#cpuç›‘æ§" class="headerlink" title="cpuç›‘æ§"></a>cpuç›‘æ§</h4><pre><code>ç›¸å…³ç›‘æµ‹å‘½ä»¤ç³»ç»Ÿè´Ÿè½½ uptime                 ä¸¾ä¾‹ï¼š             å¤„ç†å™¨ 1            1åˆ†é’Ÿçš„è´Ÿè½½å€¼     &lt;=3CPUä½¿ç”¨ç‡TOPå·¥å…·ï¼š   ç¬¬ä¸‰æ’ä¿¡æ¯å€¼Cpu(s): æ¶ˆè€—CPUå¤„ç†æ—¶é—´çš„ç™¾åˆ†æ¯”  ï¼ˆiostat çœ‹æ›´å…¨çš„å•è¯ï¼‰95.8%us,        ç”¨æˆ·æ€     1.1%sy,          å†…æ ¸æ€ 2.6%ni,          ä¼˜å…ˆçº§åˆ‡æ¢0.0%id,          CPUç©ºé—²                ï¼Šï¼Šï¼Š0.0%wa,      ç­‰å¾…ï¼ŒIOè¾“å…¥è¾“å‡ºç­‰å¾…0.0%hi,          ç¡¬ä¸­æ–­                           ä»€ä¹ˆå«ä¸­æ–­å‘¢ï¼Ÿ  æ¯ä¸ªç¡¬ä»¶éƒ½æœ‰ä¼šä¸­æ–­åœ°å€/proc/interrupts0.5%si,          è½¯ä¸­æ–­0.0%st        CPUå·çªƒæ—¶é—´    ï¼Œä¸xenè™šæ‹ŸåŒ–æœ‰å…³ç³»[root@xen ~]# iostat Linux 2.6.18-194.el5xen (xen.pg.com)    2011å¹´01æœˆ18æ—¥avg-cpu:  %user   %nice %system %iowait  %steal   %idle               2.75     0.75      1.31        1.89       0.01       93.29Device:            tps   Blk_read/s   Blk_wrtn/s   Blk_read   Blk_wrtnsda               7.46       152.21        82.99    1240948     676550sda1              1.05        11.99         0.03      97781        256sda2              0.00         0.00         0.00          6          0sda5              0.12         5.22         0.00      42549          0sda6              0.05         1.30         0.00      10621         16sda7              0.01         0.22         0.00       1818         38sda8              0.01         0.16         0.00       1315          0sda9              6.22       133.26        82.95    1086402     676240è§‚æµ‹å ç”¨CPUæ—¶é—´top    (è¿™ä¸ªå‘½ä»¤æœ¬èº«å°±æŒºæ¶ˆè€—CPUæ—¶é—´çš„)æ‰¾å‡º R çŠ¶æ€çš„è¿›ç¨‹ã€‚    ä¸´æ—¶:    ä½¿ç”¨renice è°ƒæ•´è¿›ç¨‹çš„ä¼˜å…ˆçº§ã€‚    æ²»æœ¬ï¼š    è¦æ˜ç¡®è¿™ä¸ªè¿›ç¨‹çš„åŠŸèƒ½äº†ã€‚            å¦‚æœæœ‰é—®é¢˜çš„ï¼Œç»“æŸï¼Œä¿®æ”¹ç¨‹åºã€‚            å¦‚æœæ²¡æœ‰é—®é¢˜ï¼Œæ˜¯æ­£å¸¸çš„è¿›ç¨‹ã€‚èŠ±é’±ä¹°CPUã€‚ä¸¾ä¾‹ï¼š    WEBæœåŠ¡å™¨ï¼ˆPHPï¼‰    CPUè´Ÿè½½è·ŸCPUä½¿ç”¨ç‡éƒ½å¾ˆé«˜ï¼Œè€Œä¸”CPUä¸èƒ½æ‰©å……ã€‚    æ€ä¹ˆåŠï¼Ÿ        â€œé›†ç¾¤â€œè¿›ç¨‹åˆ—è¡¨:    ps    åªå¯¹å…·ä½“è¿›ç¨‹è¿›è¡Œè§‚æµ‹ #ps -eo &quot;pid,comm,rss,pcpu&quot; --sort pcpu  å‡åº#ps -eo &quot;pid,comm,rss,pcpu&quot; --sort -pcpu  é™åº#ps -eo &quot;pid,comm,rss,pcpu,rtprio,ni,pri,stat&quot; --sort -pcpu   å®æ—¶è¿›ç¨‹ä¼˜å…ˆçº§   å¦‚æœæ˜¾ç¤ºä¸ºç©ºï¼Œè¯´æ˜ä¸æ˜¯å®æ—¶è¿›ç¨‹man psAIX FORMAT DESCRIPTORSThis ps supports AIX format descriptors, which work somewhat like the formatting codes ofprintf(1) and printf(3). For example, the normal default output can be produced with this:ps -eo &quot;%p %y %x %c&quot;. The NORMAL codes are described in the next section.CODE   NORMAL   HEADER%C     pcpu     %CPU%G     group    GROUP%P     ppid     PPID%U     user     USER%a     args     COMMAND%c     comm     COMMAND%g     rgroup   RGROUP%n     nice     NI%p     pid      PID%r     pgid     PGID%t     etime    ELAPSED%u     ruser    RUSER%x     time     TIME    %y     tty      TTY%z     vsz      VSZå¤šæ ¸å¿ƒç›‘æµ‹mpstatå·¥å…·ï¼š    mpstatæ˜¯Multiprocessor  Statisticsçš„ç¼©å†™ï¼Œæ˜¯å®æ—¶ç³»ç»Ÿç›‘æ§å·¥å…·ã€‚å…¶æŠ¥å‘Šä¸CPUçš„ä¸€äº›ç»Ÿè®¡ä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯å­˜æ”¾åœ¨/proc/statæ–‡ä»¶ä¸­ã€‚åœ¨å¤šCPUsç³»ç»Ÿé‡Œï¼Œå…¶ä¸ ä½†èƒ½æŸ¥çœ‹æ‰€æœ‰CPUçš„å¹³å‡çŠ¶å†µä¿¡æ¯ï¼Œè€Œä¸”èƒ½å¤ŸæŸ¥çœ‹ç‰¹å®šCPUçš„ä¿¡æ¯ã€‚mpstatæœ€å¤§çš„ç‰¹ç‚¹æ˜¯ï¼šå¯ä»¥æŸ¥çœ‹å¤šæ ¸å¿ƒcpuä¸­æ¯ä¸ªè®¡ç®—æ ¸å¿ƒçš„ç»Ÿè®¡æ•°æ®ï¼›è€Œç±»ä¼¼å·¥ å…·vmstatåªèƒ½æŸ¥çœ‹ç³»ç»Ÿæ•´ä½“cpuæƒ…å†µ    #mpstat -P ALL 1 1000    #mpstat [-P {|ALL}] [internal [count]]    å‚æ•° è§£é‡Š    -P {|ALL} è¡¨ç¤ºç›‘æ§å“ªä¸ªCPUï¼Œ cpuåœ¨[0,cpuä¸ªæ•°-1]ä¸­å–å€¼    internal ç›¸é‚»çš„ä¸¤æ¬¡é‡‡æ ·çš„é—´éš”æ—¶é—´ã€    count é‡‡æ ·çš„æ¬¡æ•°ï¼Œcountåªèƒ½å’Œdelayä¸€èµ·ä½¿ç”¨    å½“æ²¡æœ‰å‚æ•°æ—¶ï¼Œmpstatåˆ™æ˜¾ç¤ºç³»ç»Ÿå¯åŠ¨ä»¥åæ‰€æœ‰ä¿¡æ¯çš„å¹³å‡å€¼ã€‚æœ‰intervalæ—¶ï¼Œç¬¬ä¸€è¡Œçš„ä¿¡æ¯è‡ªç³»ç»Ÿå¯åŠ¨ä»¥æ¥çš„å¹³å‡ä¿¡æ¯ã€‚ä»ç¬¬äºŒè¡Œå¼€å§‹ï¼Œè¾“å‡ºä¸ºå‰ä¸€ä¸ªintervalæ—¶é—´æ®µçš„å¹³å‡ä¿¡æ¯ã€‚    [root@xen ~]# mpstat     Linux 2.6.18-194.el5xen (xen.pg.com)    2011å¹´01æœˆ18æ—¥    12æ—¶16åˆ†20ç§’  CPU   %user   %nice    %sys %iowait    %irq   %soft  %steal   %idle    intr/s    12æ—¶16åˆ†20ç§’  all    2.70    0.62    1.19    1.64    0.00    0.00    0.03   93.82    212.95    [root@xen ~]# mpstat -P ALL    Linux 2.6.18-194.el5xen (xen.pg.com)    2011å¹´01æœˆ18æ—¥    12æ—¶16åˆ†29ç§’  CPU   %user   %nice    %sys %iowait    %irq   %soft  %steal   %idle    intr/s    12æ—¶16åˆ†29ç§’  all    2.70    0.62    1.19    1.64    0.00    0.00    0.03   93.82    213.14    12æ—¶16åˆ†29ç§’    0    3.10    0.63    1.39    2.71    0.00    0.00    0.04   92.14    121.29    12æ—¶16åˆ†29ç§’    1    2.31    0.61    0.98    0.58    0.00    0.00    0.02   95.50     91.85[root@xen ~]# mpstat -P 0 1 10 æ¯éš”ä¸€ç§’å–ä¸€æ¬¡ï¼Œå–10æ¬¡é«˜çº§ç³»ç»Ÿæ£€æŸ¥sar -u    ä½¿ç”¨ç‡sar -q    ç³»ç»Ÿå¹³å‡è´Ÿè½½ç«‹åˆ»é‡‡é›†æ˜¾ç¤º &lt;interval&gt;  &lt;count&gt; sar -q 1 10sar -u 1 10 å³æ—¶æ€§çš„æŠ¥å‘Šè·å–CPUå„ä¸ªæ ¸å¿ƒä¿¡æ¯sar -u -P ALL 1[root@xen sa]# sar -I ALL 1è·å–æ¯ä¸ªè¿›ç¨‹CPUä½¿ç”¨ç‡ï¼Œæ³¨æ„é»˜è®¤è¿™ä¸ªæ•°æ®ä¸è®°å½•åœ¨æ•°æ®åº“ã€‚sar -x ALL 1 3  *æŒ‡å®šæ–‡ä»¶è¯»å–sar -u -f /var/log/sa/sa28è¾“å‡ºSARæ ¼å¼æ•°æ®sar -u 1 10 -o /tmp/oooæ ¹æ®æ—¶é—´è¿‡æ»¤æ•°æ®sar -u -s 13:00:00 -e 13:05:01[root@xen sa]# sar -u -f /var/log/sa/sa18  -s 09:50:01 -e 12:40:01Linux 2.6.18-194.el5xen (xen.pg.com)    2019å¹´01æœˆ18æ—¥09æ—¶50åˆ†01ç§’       CPU     %user     %nice   %system   %iowait    %steal     %idle10æ—¶00åˆ†01ç§’       all      2.08      0.00      0.32      0.15      0.01     97.4410æ—¶10åˆ†01ç§’       all      1.74      0.00      0.36      0.21      0.01     97.6810æ—¶20åˆ†01ç§’       all      3.04      0.00      0.33      0.02      0.01     96.6010æ—¶30åˆ†01ç§’       all      6.22      0.00      1.16      0.15      0.01     92.4510æ—¶40åˆ†01ç§’       all      2.79      0.17      0.75      0.16      0.01     96.1310æ—¶50åˆ†01ç§’       all      5.55      9.29      9.93     15.51      0.03     59.6811æ—¶00åˆ†01ç§’       all      4.32      0.50      1.28      0.49      0.01     93.4011æ—¶10åˆ†01ç§’       all      0.03      0.00      0.02      0.00      0.01     99.9411æ—¶20åˆ†01ç§’       all      0.03      0.00      0.03      0.06      0.01     99.8711æ—¶30åˆ†01ç§’       all      0.04      0.00      0.01      0.03      0.01     99.9111æ—¶40åˆ†01ç§’       all      0.04      0.08      0.04      0.04      0.01     99.7911æ—¶50åˆ†01ç§’       all      3.06      0.00      0.67      0.03      0.01     96.2312æ—¶00åˆ†01ç§’       all      2.72      0.00      0.70      1.17      0.23     95.1712æ—¶10åˆ†01ç§’       all      0.64      0.00      0.28      0.04      0.05     98.9912æ—¶20åˆ†01ç§’       all      3.52      0.00      0.66      0.04      0.07     95.7012æ—¶30åˆ†01ç§’       all      4.52      0.00      1.05      0.04      0.08     94.3112æ—¶40åˆ†01ç§’       all      4.31      0.08      1.22      0.05      0.08     94.27Average:          all      2.63      0.60      1.11      1.07      0.04     94.56===============================================    é€šè¿‡ä¸Šé¢é‚£äº›å·¥å…·å¯ä»¥æœé›†ä¸€æ®µæ—¶é—´çš„æ•°æ®ï¼Œé€šè¿‡æ•°æ®å¯ä»¥åˆ†æç³»ç»ŸçŠ¶æ€æ¯”å¦‚åœ¨å…¬å¸å†™æœåŠ¡å™¨è¿è¡ŒæŠ¥å‘Šçš„æ—¶å€™ï¼Œæ€ä¹ˆå†™ï¼Œå¯ä»¥å†™è¿™äº›å·¥å…·æœé›†çš„ä¿¡æ¯å®é™…ä¸Šæœé›†é‚£äº›ä¿¡æ¯ä¸ç”¨æˆ‘ä»¬è‡ªå·±å»åšï¼Œå¦‚æœå®‰è£…äº†sysstatå·¥å…·ï¼Œé‚£ä¹ˆå°±ä¼šæœ‰ä¸‹é¢çš„è®¡åˆ’ä»»åŠ¡    # ls /etc/cron.d/sysstat     /etc/cron.d/sysstat  è¿™ä¸ªè®¡åˆ’ä»»åŠ¡ä¼šç»™æˆ‘ç”Ÿæˆä¸‹é¢çš„è®°å½•æ–‡ä»¶ï¼Œè¿™äº›è®°å½•æ–‡ä»¶è®°å½•äº†cpuï¼Œmemå’Œnetï¼Œioç­‰ç­‰æ‰€æœ‰çš„ä¿¡æ¯    # cd  /var/log/sa/        sa01 sa07  è¿™äº›æ–‡ä»¶åé¢çš„æ•°å­—æ˜¯æ—¥å¿—ï¼Œæ¯”å¦‚01å°±æ˜¯1å·    # sar -f sa01 æŸ¥çœ‹é‚£äº›è®°å½•æ–‡ä»¶[root@xen sa]# sar  -f /var/log/sa/sa18 Linux 2.6.18-194.el5xen (xen.pg.com)    2019å¹´01æœˆ18æ—¥09æ—¶50åˆ†01ç§’       CPU     %user     %nice   %system   %iowait    %steal     %idle10æ—¶00åˆ†01ç§’       all      2.08      0.00      0.32      0.15      0.01     97.4410æ—¶10åˆ†01ç§’       all      1.74      0.00      0.36      0.21      0.01     97.6810æ—¶20åˆ†01ç§’       all      3.04      0.00      0.33      0.02      0.01     96.6010æ—¶30åˆ†01ç§’       all      6.22      0.00      1.16      0.15      0.01     92.4510æ—¶40åˆ†01ç§’       all      2.79      0.17      0.75      0.16      0.01     96.1310æ—¶50åˆ†01ç§’       all      5.55      9.29      9.93     15.51      0.03     59.6811æ—¶00åˆ†01ç§’       all      4.32      0.50      1.28      0.49      0.01     93.4011æ—¶10åˆ†01ç§’       all      0.03      0.00      0.02      0.00      0.01     99.9411æ—¶20åˆ†01ç§’       all      0.03      0.00      0.03      0.06      0.01     99.8711æ—¶30åˆ†01ç§’       all      0.04      0.00      0.01      0.03      0.01     99.9111æ—¶40åˆ†01ç§’       all      0.04      0.08      0.04      0.04      0.01     99.7911æ—¶50åˆ†01ç§’       all      3.06      0.00      0.67      0.03      0.01     96.2312æ—¶00åˆ†01ç§’       all      2.72      0.00      0.70      1.17      0.23     95.1712æ—¶10åˆ†01ç§’       all      0.64      0.00      0.28      0.04      0.05     98.9912æ—¶20åˆ†01ç§’       all      3.52      0.00      0.66      0.04      0.07     95.7012æ—¶30åˆ†01ç§’       all      4.52      0.00      1.05      0.04      0.08     94.3112æ—¶40åˆ†01ç§’       all      4.31      0.08      1.22      0.05      0.08     94.27Average:          all      2.63      0.60      1.11      1.07      0.04     94.56[root@xen sa]# sar -u -f /var/log/sa/sa18 Linux 2.6.18-194.el5xen (xen.pg.com)    2019å¹´01æœˆ18æ—¥09æ—¶50åˆ†01ç§’       CPU     %user     %nice   %system   %iowait    %steal     %idle10æ—¶00åˆ†01ç§’       all      2.08      0.00      0.32      0.15      0.01     97.4410æ—¶10åˆ†01ç§’       all      1.74      0.00      0.36      0.21      0.01     97.6810æ—¶20åˆ†01ç§’       all      3.04      0.00      0.33      0.02      0.01     96.6010æ—¶30åˆ†01ç§’       all      6.22      0.00      1.16      0.15      0.01     92.4510æ—¶40åˆ†01ç§’       all      2.79      0.17      0.75      0.16      0.01     96.1310æ—¶50åˆ†01ç§’       all      5.55      9.29      9.93     15.51      0.03     59.6811æ—¶00åˆ†01ç§’       all      4.32      0.50      1.28      0.49      0.01     93.4011æ—¶10åˆ†01ç§’       all      0.03      0.00      0.02      0.00      0.01     99.9411æ—¶20åˆ†01ç§’       all      0.03      0.00      0.03      0.06      0.01     99.8711æ—¶30åˆ†01ç§’       all      0.04      0.00      0.01      0.03      0.01     99.9111æ—¶40åˆ†01ç§’       all      0.04      0.08      0.04      0.04      0.01     99.7911æ—¶50åˆ†01ç§’       all      3.06      0.00      0.67      0.03      0.01     96.2312æ—¶00åˆ†01ç§’       all      2.72      0.00      0.70      1.17      0.23     95.1712æ—¶10åˆ†01ç§’       all      0.64      0.00      0.28      0.04      0.05     98.9912æ—¶20åˆ†01ç§’       all      3.52      0.00      0.66      0.04      0.07     95.7012æ—¶30åˆ†01ç§’       all      4.52      0.00      1.05      0.04      0.08     94.3112æ—¶40åˆ†01ç§’       all      4.31      0.08      1.22      0.05      0.08     94.27Average:          all      2.63      0.60      1.11      1.07      0.04     94.56[root@xen sa]# sar -q -f /var/log/sa/sa18 Linux 2.6.18-194.el5xen (xen.pg.com)    2019å¹´01æœˆ18æ—¥09æ—¶50åˆ†01ç§’   runq-sz  plist-sz   ldavg-1   ldavg-5  ldavg-1510æ—¶00åˆ†01ç§’         0       220      0.03      0.12      0.1710æ—¶10åˆ†01ç§’         0       220      0.25      0.10      0.1010æ—¶20åˆ†01ç§’         0       220      0.02      0.07      0.0810æ—¶30åˆ†01ç§’         0       220      0.16      0.19      0.1210æ—¶40åˆ†01ç§’         0       225      0.32      0.22      0.1310æ—¶50åˆ†01ç§’         4       227      1.65      1.28      0.6911æ—¶00åˆ†01ç§’         0       220      0.00      0.24      0.4011æ—¶10åˆ†01ç§’         0       220      0.00      0.02      0.1911æ—¶20åˆ†01ç§’         0       221      0.00      0.00      0.0811æ—¶30åˆ†01ç§’         0       221      0.00      0.00      0.0211æ—¶40åˆ†01ç§’         0       221      0.08      0.02      0.0111æ—¶50åˆ†01ç§’         2       221      0.42      0.22      0.0812æ—¶00åˆ†01ç§’         0       229      0.17      0.13      0.0812æ—¶10åˆ†01ç§’         0       232      0.00      0.01      0.0312æ—¶20åˆ†01ç§’         2       228      0.30      0.16      0.0912æ—¶30åˆ†01ç§’         1       228      0.33      0.18      0.1112æ—¶40åˆ†01ç§’         1       228      0.31      0.20      0.11Average:            1       224      0.24      0.19      0.15===============================================</code></pre><h3 id="mem"><a href="#mem" class="headerlink" title="mem"></a>mem</h3><pre><code>    å†…å­˜çš„ç‰¹ç‚¹:    é€Ÿåº¦å¿«,æ‰€å­˜æ•°æ®ä¸ä¼šä¿å­˜,å†…å­˜çš„æœ€å¤§æ¶ˆè€—æ¥æºäºè¿›ç¨‹æµ‹è¯•å†…å­˜é€Ÿåº¦ï¼šå®‰è£…è½¯ä»¶:memtest86+-4.10-2.el6.x86_64.rpmæ‰§è¡Œ memtest-setupå‘½ä»¤ å¤šå‡ºä¸€ä¸ªæ“ä½œç³»ç»Ÿå†…å­˜å­˜å‚¨çš„æ•°æ®æœ‰é‚£äº›?    ç¨‹åºä»£ç ,ç¨‹åºå®šä¹‰çš„å˜é‡(åˆå§‹åŒ–å’Œæœªåˆå§‹åŒ–),ç»§æ‰¿çˆ¶è¿›ç¨‹çš„ç¯å¢ƒå˜é‡,è¿›ç¨‹è¯»å–çš„æ–‡ä»¶,ç¨‹åºéœ€è¦çš„åº“æ–‡ä»¶.è¿˜æœ‰ç¨‹åºæœ¬èº«åŠ¨æ€ç”³è¯·çš„å†…å­˜å­˜æ”¾è‡ªå·±çš„æ•°æ®    é™¤äº†è¿›ç¨‹ä»¥å¤–è¿˜æœ‰å†…æ ¸ä¹Ÿè¦å ç”¨,è¿˜æœ‰bufferå’Œcache,è¿˜æœ‰å…±äº«å†…å­˜(å¦‚å…±äº«åº“)    æˆ‘ä»¬ä½¿ç”¨ç®¡é“ç¬¦| è¿›ç¨‹ä¹‹é—´é€šè®¯ä¹Ÿè¦ä½¿ç”¨åˆ°å†…å­˜,socketæ–‡ä»¶é‚£æˆ‘ä»¬å¯ä»¥ä¼˜åŒ–å“ªéƒ¨åˆ†ç¨‹åº?    å†…æ ¸å†…å­˜ä¸èƒ½çœ    buffer/cacheä¸èƒ½çœ    è¿›ç¨‹é€šè®¯ä¸çœç³»ç»Ÿæ”¯æŒçš„å†…å­˜å¤§å°ï¼š    2çš„32æ¬¡æ–¹ 32ä½ç³»ç»Ÿæ”¯æŒçš„å†…å­˜  windowså—åˆ°çº¦æŸ  linuxåªè¦æ¢ä¸ªpae(ç‰©ç†åœ°å€æ‰©å±•)å†…æ ¸ å¯ä»¥æ”¯æŒ2çš„36æ¬¡æ–¹     2çš„64æ¬¡æ–¹ æŸ¥çœ‹ç³»ç»Ÿå†…å­˜ä¿¡æ¯    [root@localhost ~]# free -m                total           used     free     shared     buffers     cached    Mem:     1010         981         29         0         145         649    -/+ buffers/cache:     186         824    Swap:     2047         0             2047    share åœ¨6ä¹‹å‰åŒ…æ‹¬6ï¼Œè¿™ä¸ªåœ°æ–¹æ°¸è¿œéƒ½æ˜¯0ï¼Œå·²ç»è¢«åºŸå¼ƒäº†ï¼Œrhel7é‡Œé¢å·²ç»å¯ä»¥æ­£å¸¸æ˜¾ç¤º    # cat /proc/meminfo | grep -i shm   shareå°±æ˜¯è¿™ä¸ªå€¼,freeå’Œvmstatéƒ½æ˜¯ä»/proc/meminfoæ–‡ä»¶é‡Œé¢æœé›†çš„ä¿¡æ¯    Shmem:             26620 kB    usedåŒ…æ‹¬bufferså’Œcachedï¼Œæ˜¯å·²ä½¿ç”¨çš„å†…å­˜+buffers+cached ï¼Œå‰©ä¸‹çš„æ˜¯free    -/+ buffers/cache:        186       824    186æ˜¯å‡å»bufferså’Œcachedä¹‹åçš„ç‰©ç†å†…å­˜ï¼Œ824æ˜¯æ€»å†…å­˜å‡å»186ä¹‹åçš„å€¼    buffers  ç´¢å¼•ç¼“å­˜ å­˜inodeä¿¡æ¯    cached é¡µç¼“å­˜    å­˜blockä¿¡æ¯            catchedå®éªŒ:                # watch -n 0.5 free -m  ç›‘æ§å†…å­˜ä¿¡æ¯                åœ¨å¦å¤–ä¸€ä¸ªçª—å£ddä¸€ä¸ª1Gçš„æ–‡ä»¶ï¼Œè§‚å¯Ÿbufferå’Œcache                # dd if=/dev/zero of=abc bs=1000M count=1                ä»/dev/zeroé‡Œé¢è¯»äº†1Gæ•°æ®åˆ°cacheé‡Œé¢                ddä¹‹å‰:                             total         used       free     shared    buffers     cached                Mem:     3724    619        3105          0         59        242                ddä¹‹å:                             total         used       free     shared    buffers   cached                Mem:     3724    1652       2071          0         59       1246            bufferså®éªŒ:                #find /      æŠŠ/ä¸‹æ‰€æœ‰æ–‡ä»¶éƒ½åˆ—å‡ºæ¥  ä¼šè¯»åˆ°directory blockï¼Œé€šè¿‡inodeæ‰¾åˆ°æ–‡ä»¶åï¼Œæœ‰å¤šå°‘ä¸ªæ–‡ä»¶å°±ä¼šè¯»å¤šå°‘æ¬¡ç›®å½•å—ï¼Œæ‰€ä»¥æˆ‘ä»¬ç°åœ¨çš„æŸ¥æ‰¾å®é™…ä¸Šæ˜¯å—æ“ä½œï¼Œæ‰€ä»¥ä½¿ç”¨çš„æ˜¯buffer                findä¹‹å:                             total         used       free     shared    buffers     cached                Mem:     3724    1713       2010          0         95       1246    [root@localhost ~]# vmstatprocs -----------memory----------           ---swap--   -----io----     --system-- -----cpu------r b     swpd   free   buff       cache         si     so         bi     bo     in      cs            us sy id wa st0 0     0         48584 118300 663564       0      0              12 23     60  240        3  2   95 0  0procs:    r   æ­£åœ¨è¿è¡Œæˆ–å¯è¿è¡Œçš„è¿›ç¨‹æ•°ï¼Œå¦‚æœé•¿æœŸå¤§äºcpuä¸ªæ•°ï¼Œè¯´æ˜cpuä¸è¶³ï¼Œéœ€è¦å¢åŠ cpu    b  block  ä½†æ˜¯è¿™ä¸ªæ˜¯é˜»å¡ï¼Œè¡¨ç¤ºåœ¨ç­‰å¾…èµ„æºçš„è¿›ç¨‹æ•°ï¼Œæ¯”å¦‚æ­£åœ¨ç­‰å¾…I/Oã€æˆ–è€…å†…å­˜äº¤æ¢ç­‰ã€‚  ç”±äºç¡¬ç›˜é€Ÿåº¦ç‰¹åˆ«æ…¢è€Œå¯¼è‡´å†…å­˜åŒæ­¥çš„æ—¶å€™æ²¡æˆåŠŸï¼Œé‚£ä¹ˆç°åœ¨å‘Šè¯‰ç¨‹åºï¼Œè¯´ä½ å…ˆä¸è¦äº§ç”Ÿæ•°æ®ï¼Œè¿™å°±æ˜¯é˜»å¡ï¼ï¼ï¼ï¼ï¼ ---&gt;  bè¶Šå¤§è¯æ˜ç¡¬ç›˜å‹åŠ›å¾ˆå¤§memory    swpd åˆ‡æ¢åˆ°å†…å­˜äº¤æ¢åŒºçš„å†…å­˜æ•°é‡(kè¡¨ç¤º)ã€‚å¦‚æœswpdçš„å€¼ä¸ä¸º0ï¼Œæˆ–è€…æ¯”è¾ƒå¤§ï¼Œæ¯”å¦‚è¶…è¿‡äº†100mï¼Œåªè¦siã€soçš„å€¼é•¿æœŸä¸º0ï¼Œç³»ç»Ÿæ€§èƒ½è¿˜æ˜¯æ­£å¸¸    free å½“å‰çš„ç©ºé—²é¡µé¢åˆ—è¡¨ä¸­å†…å­˜æ•°é‡(kè¡¨ç¤º)    buff ä½œä¸ºbuffer cacheçš„å†…å­˜æ•°é‡    cache: ä½œä¸ºpage cacheçš„å†…å­˜æ•°é‡swap    si swapin    æŠŠswapåˆ†åŒºçš„æ•°æ®æ”¾åˆ°å†…å­˜    so swapout  æŠŠå†…å­˜æ•°æ®æ”¾åˆ°ç£ç›˜    é€šè¿‡ä¸Šé¢ä¸¤ä¸ªå¯ä»¥åˆ†æå†…å­˜çš„ä½¿ç”¨æƒ…å†µï¼Œå¦‚æœswapæœ‰æ•°æ®æ˜¯ä¸æ˜¯å†…å­˜ä¸å¤Ÿç”¨äº†ï¼Ÿä¸ä¸€å®šï¼Œå› ä¸ºç³»ç»Ÿä¼šæŠŠä¸€äº›ç”¨ä¸åˆ°çš„è¿›ç¨‹æ”¾åˆ°swapé‡Œé¢ï¼ŒæŠŠè…¾å‡ºæ¥çš„ç©ºé—´åšç¼“å­˜ï¼Œå¦‚æœå‘ç°si,soé‡Œé¢æœ‰æ•°æ®ï¼Œè¯´æ˜å†…å­˜å¯èƒ½ä¸å¤Ÿç”¨äº†    IO    bi blockin è¿™ä¸ªæ˜¯å—è¿›æ¥  ï¼ŒæŠŠå—å„¿ä»ç¡¬ç›˜æ¬è¿›æ¥ï¼Œä¹Ÿå°±æ˜¯è¯´biæ˜¯è¯»    bo blockout  æŠŠå—å„¿ä»å†…å­˜æ¬åˆ°ç¡¬ç›˜ï¼Œä¹Ÿå°±æ˜¯è¯´boæ˜¯å†™        å®éªŒ:        # vmstat -1         # dd if=/dev/zero  of=/aa bs=1G count=1   //è¿™æ¡å‘½ä»¤ä¹‹åæŸ¥çœ‹boçš„æ•°å€¼ï¼Œå‘ç°boäº§ç”Ÿæ•°æ®         è®°å½•äº†1+0 çš„è¯»å…¥         è®°å½•äº†1+0 çš„å†™å‡º         1073741824å­—èŠ‚(1.1 GB)å·²å¤åˆ¶ï¼Œ4.90872 ç§’ï¼Œ219 MB/ç§’        #find /        //è¿™æ¡å‘½ä»¤ä¹‹åæŸ¥çœ‹biï¼Œå‘ç°biäº§ç”Ÿæ•°æ®        å¦‚æœ ä¸€ç›´å¼€ç€vmstatå‘ç°bo 5ç§’é’Ÿä¸€ä¸ªæ•°ï¼Œè¿™å°±æ˜¯å› ä¸ºè„æ•°æ®5ç§’é’Ÿä¸€æ¬¡        å¦‚æœè¦æ‹¿è¿™ä¸ªæ•°æ®åšå›¾ï¼Œboçš„ç¬¬ä¸€ä¸ªæ•°æ®ä¸€å®šè¦å‰”é™¤åˆ°ï¼Œè¿™ä¸ªæ•°å­—æ˜¯ä¸Šä¸€æ¬¡é‡å¯åˆ°æ•²vmstatè¿™æ¡å‘½ä»¤ä¹‹é—´çš„å¹³å‡å€¼ï¼Œæ‰€ä»¥è¿™ä¸ªæ•°å­—æ²¡ç”¨system æ˜¾ç¤ºé‡‡é›†é—´éš”å†…å‘ç”Ÿçš„ä¸­æ–­æ•°    in åˆ—è¡¨ç¤ºåœ¨æŸä¸€æ—¶é—´é—´éš”ä¸­è§‚æµ‹åˆ°çš„æ¯ç§’è®¾å¤‡ä¸­æ–­æ•°ã€‚    csåˆ—è¡¨ç¤ºæ¯ç§’äº§ç”Ÿçš„ä¸Šä¸‹æ–‡åˆ‡æ¢æ¬¡æ•°cpuï¼š    å‰©ä¸‹çš„å°±æ˜¯cpuçš„å„ç§ä½¿ç”¨ç™¾åˆ†æ¯”ä»¥ä¸Šè§£é‡Šéƒ½å¯ä»¥æŸ¥çœ‹manæ‰‹å†Œ:#man vmstat    ========================================buffer/cacheæ ¹æ®æ—¶é—´å’Œæ•°æ®å¤§å°åŒæ­¥  ä¸»è¦ç”¨äºå†™ç¼“å­˜å†…æ ¸é‡Œé¢çš„ä¸€å¥—ç³»ç»Ÿï¼šä¼™ä¼´ç³»ç»Ÿï¼Œè´Ÿè´£æŠŠå†…å­˜é‡Œé¢çš„æ•°æ®å¾€ç¡¬ç›˜ä¸Šæ¬    rhel5ï¼š        kswapd pdflush        kswapdè´Ÿè´£è¯´ä»€ä¹ˆæ—¶å€™æ¬æ•°æ®        pdflushè´Ÿè´£å¹²æ´»å„¿,ä»–ä¼šä¸€ç›´å¼€å¯ç€    rhel6:        kswapdè´Ÿè´£è¯´ä»€ä¹ˆæ—¶å€™æ¬æ•°æ®ï¼Œä½†æ˜¯å¹²æ´»å„¿çš„ä¸æ˜¯pdflushäº†        æœ‰éœ€è¦æ¬çš„æ•°æ®çš„æ—¶å€™ï¼Œæ‰äº§ç”Ÿä¸€ä¸ªè¿›ç¨‹---&gt; flush ä¸»è®¾å¤‡å·:ä»è®¾å¤‡å· è´Ÿè´£æ¬æ•°æ®å·²ç»åŒæ­¥åˆ°ç¡¬ç›˜çš„æ•°æ®å°±æ˜¯å¹²å‡€æ•°æ®# cat /proc/sys/vm/dirty_    æŸ¥çœ‹çš„æ˜¯è„æ•°æ®ï¼ˆç¼“å­˜å†…è¿˜æ²¡æ¥å¾—æ€¥åŒæ­¥åˆ°ç¡¬ç›˜çš„æ•°æ®ï¼‰dirty_background_bytes     dirty_expire_centisecsdirty_background_ratio     dirty_ratiodirty_bytes                dirty_writeback_centisecs[root@localhost ~]# cat /proc/sys/vm/dirty_expire_centisecs   //æƒ³çŸ¥é“è¿™é‡Œé¢æ˜¯ä»€ä¹ˆå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„manæˆ–è€…kernel-docæŸ¥çœ‹2999        //å•ä½ç™¾åˆ†ä¹‹ä¸€ç§’ï¼Œè¿™é‡Œä¹Ÿå°±æ˜¯30ç§’ï¼Œ30ç§’ä¹‹åæ ‡è®°ä¸ºè„æ•°æ®ï¼Œæ„å‘³ç€ç”¨æˆ·å†™çš„æ•°æ®åœ¨30ç§’ä¹‹åæ‰æœ‰å¯èƒ½è¢«åˆ·å…¥ç£ç›˜ï¼Œåœ¨è¿™æœŸé—´æ–­ç”µå¯èƒ½ä¼šä¸¢æ•°æ®[root@localhost ~]# cat /proc/sys/vm/dirty_writeback_centisecs499         //  5ç§’é’Ÿå¾€ç¡¬ç›˜åŒæ­¥ä¸€æ¬¡æ•°æ®5ç§’åŒæ­¥ä¸€æ¬¡è„æ•°æ®ï¼ˆåœ¨ç¼“å­˜ä¸­çš„ï¼‰å‡å¦‚æˆ‘å†…å­˜1G1ç§’  100M2ç§’  300M3ç§’  400M4ç§’  400Mè¿˜æ²¡åˆ°5ç§’ï¼Œä½†æ˜¯å†…å­˜ä½¿ç”¨å·²ç»è¶…è¿‡1Gäº†ï¼Œè¿™æ—¶å€™æ€ä¹ˆåŠï¼Ÿä¸‹é¢çš„æ–‡ä»¶æ¥è§£å†³[root@localhost ~]# cat /proc/sys/vm/dirty_ratio40          //å¦‚æœå•ä¸ªè¿›ç¨‹å ç”¨çš„buffer/cacheè¾¾åˆ°å†…å­˜æ€»é‡çš„40%,ç«‹åˆ»åŒæ­¥ã€‚å‡å¦‚æˆ‘å†…å­˜1Gï¼Œä¸€ä¸ªè¿›ç¨‹1ç§’  1M2ç§’  3M3ç§’  4M4ç§’  40Mé‚£è¦æ˜¯1000ä¸ªè¿›ç¨‹å‘¢ï¼Ÿè¿™æ—¶å€™æ€ä¹ˆåŠï¼Ÿä¸‹é¢çš„æ–‡ä»¶æ¥è§£å†³[root@localhost ~]# cat /proc/sys/vm/dirty_background_ratio10          //æ‰€æœ‰è¿›ç¨‹å ç”¨çš„buffer/cacheä½¿å¾—å‰©ä½™å†…å­˜ä½äºå†…å­˜æ€»é‡çš„10%ï¼Œç«‹åˆ»åŒæ­¥# cat /proc/sys/vm/dirty_background_bytes //ä¸Šé¢çš„ratioæ–‡ä»¶ç”¨ç™¾åˆ†æ¯”ï¼Œè¿™ä¸ªç”¨å­—èŠ‚é™åˆ¶ï¼Œä½†æ˜¯ç™¾åˆ†æ¯”å­˜åœ¨çš„æ—¶å€™ï¼Œå­—èŠ‚ä¸ç”Ÿæ•ˆ0å¦‚æœæœåŠ¡å™¨æ˜¯ä¸€ä¸ªæ•°æ®æœåŠ¡å™¨ï¼Œæ¯”å¦‚NASï¼Œdirty_writebackå’Œdirty_ratioé‡Œé¢çš„æ•°å€¼å¯ä»¥é€‚å½“æ”¹å¤§ä¸€ç‚¹,å­˜å‚¨éœ€è¦é¢‘ç¹è¯»æ•°æ®çš„æ—¶å€™ï¼Œå¯ä»¥ç›´æ¥ä»å†…å­˜é‡Œé¢è¯»ï¼Œè€Œä¸”åœ¨åŒæ­¥æ•°æ®çš„æ—¶å€™ä¼šä½¿ç”¨æ›´å¤§çš„è¿ç»­çš„å—å„¿ã€‚=============================================é‡Šæ”¾buffer/cache    [root@localhost ~]# cat /proc/sys/vm/drop_caches    0    1 é‡Šæ”¾buffer    2 é‡Šæ”¾cache    3 buffer/cacheéƒ½é‡Šæ”¾    éœ€è¦ç¼–è¯‘å®‰è£…ä¸€ä¸ªç¨‹åºï¼Œåœ¨makeçš„æ—¶å€™æŠ¥é”™å†…å­˜ä¸è¶³ï¼Œè¿™æ—¶å€™å°±å¯ä»¥é‡Šæ”¾ä¸€ä¸‹ç¼“å­˜ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ä¸è¦ç”¨    # watch -n 0.5 free -m    # echo 3 &gt; /proc/sys/vm/drop_caches=============================å†…å­˜å¦‚æœçœŸè€—å°½äº†ï¼Œåæœæ— æ³•é¢„æµ‹OOMè¿›ç¨‹  OOM killer out      å½“å†…å­˜è€—å°½çš„æ—¶å€™ï¼Œç³»ç»Ÿä¼šå‡ºç°ä¸€ä¸ªOOM killerè¿›ç¨‹åœ¨ç³»ç»Ÿå†…éšæœºæ€è¿›ç¨‹    æ¯ä¸ªè¿è¡Œçš„ç¨‹åºéƒ½ä¼šæœ‰ä¸€ä¸ªscore(åˆ†)ï¼Œè¿™ä¸ªæ˜¯ä¸è‰¯å¾—åˆ†ï¼Œæ‰€ä»¥è°åˆ†é«˜ï¼Œå°±æ€è°    å¦‚æœè¿˜ä¸è¡Œçš„è¯ï¼Œä»–ä¼šè‡ªæ€ï¼Œä¹Ÿå°±æ˜¯æ€kernelï¼Œå°±ä¼šå‡ºç°å†…æ ¸ææ…Œ(panic),æ‰€ä»¥ä¼šæ­»æœº    å®éªŒï¼š        #cat         # ps -el | grep cat        0 S     0  9566  2975  0  80   0 - 25232 n_tty_ pts/1    00:00:00 cat        # cat /proc/9566/oom_score        1        # cat /proc/9566/oom_adj        0 å¯ä»¥ç”¨è¿™ä¸ªå€¼å¹²é¢„ä¸Šé¢oomå¾—åˆ†        -17 15     -17å…æ€ï¼Œ15æ˜¯å…ˆå¹²æ‰        # echo 15 &gt; /proc/9566/oom_adj        # echo f &gt; /proc/sysrq-trigger   //å¯åŠ¨OOM_KILLER å¿…æ€ä¸€ä¸ª        # cat    //å› ä¸ºä¸Šé¢å·²ç»æŠŠ9566çš„adjæ”¹æˆäº†15ï¼Œæ‰€ä»¥è¿™æ¬¡å¯åŠ¨æ€æ­»äº†catè¿›ç¨‹          å·²æ€æ­» swap     é‚£ä¹ˆåˆ°åº•æ€ä¹ˆè§£å†³å†…å­˜è€—å°½çš„é—®é¢˜ï¼Ÿswap    å‡å¦‚aï¼Œbï¼Œcå·²ç»æŠŠå†…å­˜å æ»¡äº†ï¼Œé‚£ä¹ˆæ¥äº†ä¸ªdï¼Œå†…æ ¸å…ˆçœ‹çœ‹abcè°ä¸å¿™ï¼Œå°±æŠŠè°çš„æ•°æ®å…ˆæ”¾åˆ°swapé‡Œé¢å»ï¼Œæ¯”å¦‚aä¸ç”¨ï¼ŒæŠŠaçš„æ•°æ®æ”¾åˆ°swapé‡Œé¢å»ï¼Œé‡Šæ”¾å‡ºæ¥çš„ç©ºé—´ç»™d    swapåˆ†åŒºåˆ†å¤šå¤§ï¼Ÿç°åœ¨å†…å­˜å¾ˆå¤§æ¯”å¦‚256Gï¼Œé‚£ä¹ˆå°±æ²¡å¿…è¦2å€äº†ã€‚ã€‚ã€‚    ä»€ä¹ˆæ ·çš„æ•°æ®æ‰èƒ½å¾€swapé‡Œé¢æ”¾ï¼Ÿ        # cat /proc/meminfo | grep -i active         Active:           233836 kB         Inactive:        1280348 kB         Active(anon):     138780 kB         Inactive(anon):    26740 kB         Active(file):      95056 kB         Inactive(file):  1253608 kB        activeæ´»è·ƒæ•°æ®ï¼Œinactiveéæ´»è·ƒæ•°æ®ï¼Œåˆåˆ†ä¸ºåŒ¿åæ•°æ®å’Œæ–‡ä»¶æ•°æ®        åŒ¿åæ•°æ®ä¸èƒ½å¾€swapé‡Œé¢æ”¾        æ–‡ä»¶å½¢å¼çš„activeä¸èƒ½å¾€swapé‡Œæ”¾ï¼Œåªæœ‰æ–‡ä»¶çš„inactiveæ‰èƒ½å¾€swapæ”¾               æ‰€ä»¥å¹¶ä¸æ˜¯æœ‰äº†swapï¼Œå†…å­˜å°±è§£å†³äº†    ä»€ä¹ˆæ—¶å€™æ”¾è¿›å»ï¼Ÿæ ¹æ®swap_tendencyï¼ˆswapè¶‹åŠ¿ï¼‰        swap_tendency = mapped_ratio/2 + distress + vm_swappiness          è¿™å°±æ˜¯swapè¶‹åŠ¿ï¼Œå¦‚æœè¿™ä¸ªå€¼åˆ°è¾¾100ï¼Œå°±å¾€äº¤æ¢åˆ†åŒºé‡Œé¢æ”¾ï¼Œå¦‚æœå°äº100ï¼Œå°½é‡ä¸å¾€é‡Œé¢æ”¾ï¼Œä½†æ˜¯å°±ç®—åˆ°100ï¼Œä¹Ÿåªèƒ½è¯´å†…æ ¸å€¾å‘ä¸è¦å¾€swapé‡Œé¢æ”¾ï¼Œä½†ä¹Ÿä¸ä¸€å®šæ”¾        ç³»ç»Ÿå°±åªå¼€æ”¾ç¬¬ä¸‰ä¸ªç»™ç”¨æˆ·è®¾ç½®         # cat /proc/sys/vm/swappiness  swapçš„å–œå¥½ç¨‹åº¦ï¼ŒèŒƒå›´0-100          60=============================ä½¿ç”¨å†…å­˜æ–‡ä»¶ç³»ç»Ÿ    #df -h    tmpfs                 1.9G  224K  1.9G   1% /dev/shm  ï¼ˆå…±äº«å†…å­˜ï¼‰    tmpfs   å†…å­˜é‡Œé¢çš„ä¸´æ—¶æ–‡ä»¶ç³»ç»Ÿ  ç³»ç»Ÿä¼šæ‰¿è¯ºæ‹¿å‡º50%ï¼ˆè¿™é‡Œæ˜¯2Gï¼‰çš„ç©ºé—´æ¥åšSHMï¼Œåªæ˜¯æ‰¿è¯ºï¼Œå®é™…ç”¨å¤šå°‘ç»™å¤šå°‘ï¼Œå¦‚æœå†…å­˜æ¯”è¾ƒå¯Œè£•çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥æ‹¿å†…å­˜å½“ç¡¬ç›˜ä½¿ç”¨    #mount  -t tmpfs -o size=1000M tmpfs /mnt   //æŒ‚å†…å­˜    #dd if=/dev/zero of=/mnt/file1 bs=1M count=800     è®°å½•äº†800+0 çš„è¯»å…¥    è®°å½•äº†800+0 çš„å†™å‡º    838860800å­—èŠ‚(839 MB)å·²å¤åˆ¶ï¼Œ0.310507 ç§’ï¼Œ2.7 GB/ç§’    //è¿™é‡Œç”¨çš„æ˜¯å†…å­˜çš„é€Ÿåº¦    # dd if=/dev/zero of=/tmp/file1 bs=1M count=800 oflag=direct     è®°å½•äº†800+0 çš„è¯»å…¥     è®°å½•äº†800+0 çš„å†™å‡º     838860800å­—èŠ‚(839 MB)å·²å¤åˆ¶ï¼Œ8.77251 ç§’ï¼Œ95.6 MB/ç§’   //è¿™é‡Œç”¨çš„æ˜¯ç¡¬ç›˜çš„é€Ÿåº¦    å¦‚æœä¸´æ—¶å¯¹æŸä¸€ä¸ªç›®å½•æœ‰è¾ƒé«˜çš„ioéœ€æ±‚ï¼Œå¯ä»¥ä½¿ç”¨ä¸Šé¢çš„æ–¹æ³•ä½¿ç”¨å†…å­˜    ----------------------------------------------------------------------------------------------    # mount -t tmpfs -o size=20000M tmpfs /mnt    //å‘ç°è¿™æ ·ä¹Ÿå¯ä»¥ï¼Œä¸ºä»€ä¹ˆï¼Œè¿™åªæ˜¯æ‰¿è¯ºç»™20Gï¼Œå¹¶æ²¡æœ‰å®é™…ç»™20G    #dd if=/dev/zero of=/mnt/file1   //ä¸æŒ‡å®šå¤šå¤§ï¼ŒæŠŠswapå…³é—­ï¼ˆå¦‚æœä¸å…³ä¼šç­‰åŠå¤©ï¼‰ï¼Œè¿™æ ·å°±ä¼šæŠŠå†…å­˜è€—å°½ï¼Œ========================è™šæ‹Ÿå†…å­˜å’Œç‰©ç†å†…å­˜    æŸ¥çœ‹ï¼š        #top        VIRT RES SHR    è™šæ‹Ÿå†…å­˜ï¼š        åº”ç”¨ç¨‹åºæ²¡åŠæ³•ç›´æ¥ä½¿ç”¨ç‰©ç†å†…å­˜ï¼Œæ¯ä¸ªç¨‹åºéƒ½æœ‰ä¸€ä¸ªè¢«å†…æ ¸åˆ†é…ç»™è‡ªå·±çš„è™šæ‹Ÿå†…å­˜    è™šæ‹Ÿå†…å­˜ç”³è¯·ï¼š        32ä½CPU,2^32ä¹Ÿå°±æ˜¯4G        64ä½cpu,2^64        æ¯ä¸ªç¨‹åºéƒ½æœ€å¤šèƒ½ç”³è¯·4Gçš„è™šæ‹Ÿå†…å­˜ï¼Œä½†æ˜¯ç°åœ¨è¿™4Gå†…å­˜è¿˜å’Œç‰©ç†å†…å­˜æ²¡å…³ç³»å‘¢ï¼Œaè¯´æˆ‘å…ˆç”¨100Mï¼Œç„¶åå†…æ ¸å°±ä¼šæŠŠ100Mæ˜ å°„ç»™ç‰©ç†å†…å­˜        VIRTå°±æ˜¯ç¨‹åºè¿è¡Œçš„æ—¶å€™è¯´ç”³è¯·çš„è™šæ‹Ÿå†…å­˜ï¼ŒRESå°±æ˜¯æ˜ å°„çš„å†…å­˜    ä¸ºä»€ä¹ˆè¦æœ‰è™šæ‹Ÿå†…å­˜ï¼Ÿ            è·Ÿå¼€å‘æœ‰å…³ç³»ï¼Œå†…å­˜æ˜¯æœ‰åœ°å€ç©ºé—´çš„ï¼Œå¼€å‘è€…åœ¨è°ƒç”¨å†…å­˜çš„æ—¶å€™å¦‚æœç›´æ¥è°ƒç”¨ç‰©ç†å†…å­˜ï¼Œå¼€å‘è€…ä¸çŸ¥é“å“ªå—å„¿åœ°å€è¢«å ç”¨äº†ï¼Œæ‰€ä»¥åœ¨ä¸­é—´å†…æ ¸ç«™å‡ºæ¥ç»™å¼€å‘è€…åˆ†é…ï¼Œå¼€å‘è€…åªéœ€è¦æå‡ºéœ€è¦å¤šå¤§å†…å­˜ï¼Œç”±å†…æ ¸æ¥è§£å†³ä½ çš„å†…å­˜å°±å¯ä»¥äº†                ------------                ç¨‹åº1 ç¨‹åº2                4G     4G                -----------                kernel                -----------                ç‰©ç†å†…å­˜                -----------            ä»¥ä¸Š3å±‚ï¼Œç¬¬ä¸€å±‚å°±æ˜¯ç¨‹åºå¯ä»¥ä½¿ç”¨çš„è™šæ‹Ÿå†…å­˜ï¼Œç¨‹åºå¯ä»¥è·Ÿå†…æ ¸ç”³è¯·éœ€è¦å¤šå°‘å†…å­˜ï¼Œå†…æ ¸å°±åˆ†é…ç›¸åº”å¤§å°çš„ç‰©ç†å†…å­˜ç»™ç¨‹åºå°±å¯ä»¥äº†========================æ˜ å°„è¡¨ï¼šæ¦‚å¿µï¼š    å†…å­˜æ˜¯åˆ†é¡µçš„ï¼Œ1ä¸ªpageæ˜¯4k(é»˜è®¤å€¼),åœ¨ç¡¬ç›˜ä¸Šåˆ†å—ï¼Œç¡¬ç›˜æ•°æ®å’Œå†…å­˜æ•°æ®æ˜¯ä¸€ä¸€å¯¹åº”é—®é¢˜ï¼š    æ¡ç›®éå¸¸å¤šï¼ŒæŸ¥è¯¢ç‰¹åˆ«æ…¢è§£å†³ï¼š    å›ºæœ‰æ–¹æ³•ï¼š        ç¡¬ä»¶TLB ï¼Œåœ¨cpué‡Œé¢ï¼Œç”¨æ¥è§£å†³æŸ¥è¯¢æ˜ å°„è¡¨æ…¢çš„é—®é¢˜ï¼Œç¬¬ä¸€æ¬¡æŸ¥è¯¢è¿‡ä¹‹åæŠŠç»“æœç¼“å­˜åˆ°TLBé‡Œé¢ï¼Œä»¥åå†æŸ¥çš„æ—¶å€™å°±å¯ä»¥ç›´æ¥ä»TLBé‡Œé¢æå–            # yum install x86info            # x86info  -a  å¯ä»¥æŸ¥è¯¢TLBä¿¡æ¯    è‡ªå®šä¹‰æ–¹æ³•ï¼š        å¦‚æœpageå˜å¤§ï¼Œæ¡ç›®å°±ä¼šå˜å°‘ï¼Œè¿™æ ·å°±ä¼šæé«˜æŸ¥è¯¢é€Ÿåº¦        å¤§äº4kçš„åˆ†é¡µç§°ä¸ºhugepage å·¨é¡µ ï¼Œä½†æ˜¯è¿™ä¸ªéœ€è¦ç¨‹åºæ”¯æŒ        é‚£æˆ‘ä»¬ç°åœ¨çš„æ“ä½œç³»ç»Ÿæ˜¯å¦æ”¯æŒå·¨é¡µ            # cat /proc/meminfo | grep -i hugepage            AnonHugePages:     26624 kB            HugePages_Total:       0      æˆ‘ç°åœ¨æ²¡æœ‰å·¨é¡µ            HugePages_Free:        0            HugePages_Rsvd:        0            HugePages_Surp:        0            Hugepagesize:       2048 kB    è¯´æ˜ç°åœ¨æˆ‘çš„ç³»ç»Ÿæ”¯æŒ2Mçš„å·¨é¡µ        å‡å¦‚ä¸€ä¸ªç¨‹åºéœ€è¦200Mçš„å·¨é¡µï¼Œé‚£ä¹ˆå°±è¦æŠŠtotalæ”¹æˆ100            #echo 100 &gt; /proc/sys/vm/nr_hugepages  //ä¿®æ”¹å·¨é¡µtotalæ•°ç›®            #mkdir dir1            #mount -t hugetlbfs none /dir1    é‚£ä¹ˆç°åœ¨ç¨‹åºä½¿ç”¨/dir1å°±å¯ä»¥äº†å¤–ç¿»ï¼š    TLB(Translation Lookaside Buffer)ä¼ è¾“åå¤‡ç¼“å†²å™¨æ˜¯ä¸€ä¸ªå†…å­˜ç®¡ç†å•å…ƒç”¨äºæ”¹è¿›è™šæ‹Ÿåœ°å€åˆ°ç‰©ç†åœ°å€è½¬æ¢é€Ÿåº¦çš„ç¼“å­˜ã€‚TLBæ˜¯ä¸€ä¸ªå°çš„ï¼Œè™šæ‹Ÿå¯»å€çš„ç¼“å­˜ï¼Œå…¶ä¸­æ¯ä¸€è¡Œéƒ½ä¿å­˜ç€ä¸€ä¸ªç”±å•ä¸ªPTEç»„æˆçš„å—ã€‚å¦‚æœæ²¡æœ‰TLBï¼Œåˆ™æ¯æ¬¡å–æ•°æ®éƒ½éœ€è¦ä¸¤æ¬¡è®¿é—®å†…å­˜ï¼Œå³æŸ¥é¡µè¡¨è·å¾—ç‰©ç†åœ°å€å’Œå–æ•°æ®========================è¿›ç¨‹é—´é€šä¿¡(IPC)ç§ç±»ï¼š        è¿›ç¨‹é—´é€šä¿¡çš„æ–¹å¼æœ‰5ç§:    1.ç®¡é“(pipe)      æœ¬åœ°è¿›ç¨‹é—´é€šä¿¡ï¼Œç”¨æ¥è¿æ¥ä¸åŒè¿›ç¨‹ä¹‹é—´çš„æ•°æ®æµ    2.socket    ç½‘ç»œè¿›ç¨‹é—´é€šä¿¡ï¼Œå¥—æ¥å­—(Socket)æ˜¯ç”±Berkeleyåœ¨BSDç³»ç»Ÿä¸­å¼•å…¥çš„ä¸€ç§åŸºäºè¿æ¥çš„IPCï¼Œæ˜¯å¯¹ç½‘ç»œæ¥å£(ç¡¬ä»¶)å’Œç½‘ç»œåè®®(è½¯ä»¶)çš„æŠ½è±¡ã€‚å®ƒæ—¢è§£å†³äº†æ— åç®¡é“åªèƒ½åœ¨ç›¸å…³è¿›ç¨‹é—´å•å‘é€šä¿¡çš„é—®é¢˜ï¼Œåˆè§£å†³äº†ç½‘ç»œä¸Šä¸åŒä¸»æœºä¹‹é—´æ— æ³•é€šä¿¡çš„é—®é¢˜ã€‚    ä»¥ä¸Šä¸¤ç§unixé—ç•™ä¸‹æ¥çš„    3.æ¶ˆæ¯é˜Ÿåˆ—(Message Queues)  æ¶ˆæ¯é˜Ÿåˆ—ä¿å­˜åœ¨å†…æ ¸ä¸­ï¼Œæ˜¯ä¸€ä¸ªç”±æ¶ˆæ¯ç»„æˆçš„é“¾è¡¨ã€‚    4.å…±äº«å†…å­˜æ®µ(Shared Memory)  å…±äº«å†…å­˜å…è®¸ä¸¤ä¸ªæˆ–å¤šä¸ªè¿›ç¨‹å…±äº«ä¸€å®šçš„å­˜å‚¨åŒºï¼Œå› ä¸ºä¸éœ€è¦æ‹·è´æ•°æ®ï¼Œæ‰€ä»¥è¿™æ˜¯æœ€å¿«çš„ä¸€ç§IPCã€‚    5.ä¿¡å·é‡é›†(Semaphore Arrays)        System Vçš„ä¿¡å·é‡é›†è¡¨ç¤ºçš„æ˜¯ä¸€ä¸ªæˆ–å¤šä¸ªä¿¡å·é‡çš„é›†åˆã€‚æŸ¥çœ‹ï¼š    ipc è¿›ç¨‹é—´é€šä¿¡    #ipcs   //è¿™æ¡å‘½ä»¤å¯ä»¥çœ‹åˆ°å3ç§,å‰ä¸¤ç§å¯ä»¥é€šè¿‡æ–‡ä»¶ç±»å‹æŸ¥çœ‹å«ä¹‰ï¼š    ç®¡é“        a | b        åœ¨å†…å­˜æ‰“å¼€ä¸€ä¸ªç¼“å†²åŒºï¼ŒaæŠŠç»“æœå­˜åˆ°ç¼“å†²åŒºï¼Œbå»ç¼“å†²åŒºé‡Œé¢æ‹¿æ•°æ®        ç®¡é“é€šä¿¡çš„æ—¶å€™ ç‹¬æœ¨æ¡¥ï¼šç‰¹ç‚¹--&gt;åªèƒ½ä¸€ä¸ªäºº å•å‘  å…ˆè¿›å…ˆå‡º        3ä¸ªäººè¿‡æ¡¥ï¼Œä¸€ä¸ªä¸€ä¸ªçš„è¿‡ï¼Œé‚£å¦‚æœ100ä¸ªäººè¿‡ï¼Œé€Ÿåº¦ä¼šå¾ˆæ…¢ï¼Œæ‰€ä»¥ç®¡é“ä¼ è¾“çš„æ•°æ®æœ‰é™    socket           IEæµè§ˆå™¨  è®¿é—®ç½‘ç«™ é€šè¿‡ç«¯å£ ç«¯å£åœ¨ç³»ç»Ÿå†…å®é™…ä¸å­˜åœ¨æ˜¯ä¸ªä¼ªæ¦‚å¿µï¼Œåªæ˜¯ä¸€ä¸ªæ ‡è¯†ï¼Œ        aä¼šæ‰“å¼€ä¸€ä¸ªbuffer  bä¼šæ‰“å¼€ä¸€ä¸ªbuffer  ï¼Œè¿™ä¸¤ä¸ªbufferç”¨æ¥æ¥å—æ•°æ®åŒ…ï¼Œå¹¶ä¸”é‡ç»„ï¼Œäº¤ç»™apacheçš„socketï¼Œapacheå°±ä¼šå»socketæ¥å—æ•°æ®    æ¶ˆæ¯é˜Ÿåˆ—        è·Ÿç®¡é“åŸºæœ¬ä¸€æ ·  ä¹Ÿæ˜¯ç‹¬æœ¨æ¡¥ï¼Œä¹Ÿæ˜¯å•å‘ï¼Œå…ˆè¿›å…ˆå‡ºï¼Œä½†æ˜¯ä»–ä¼šå¯¹æ¶ˆæ¯è¿›ç¨‹æ’é˜Ÿï¼Œè°ç€æ€¥è°å…ˆèµ°ï¼Œé‚£ä¹ˆè¿‡æ²³çš„äººå¤šäº†ä¹‹åï¼ŒåŒæ ·ä¹Ÿæ˜¯æ•°æ®ä¼ è¾“è¾ƒæ…¢    å…±äº«å†…å­˜æ®µ        å¼€è¾Ÿä¸€å—å†…å­˜ï¼ŒaæŠŠæ•°æ®å…¨éƒ½ä¸¢åˆ°å…±äº«å†…å­˜é‡Œé¢ï¼Œbå»å…±äº«å†…å­˜æ‹¿æ•°æ®ï¼Œè€Œä¸”bå¯ä»¥æŒ‰éœ€é€‰æ‹©æ‹¿å“ªäº›æ•°æ®        å…±äº«å†…å­˜æ®µåœ¨oracleé‡Œé¢è‚¯å®šè¦ä½¿ç”¨    ä¿¡å·é‡             åœ¨aå’Œbä¹‹é—´ä¼ é€’ä¿¡å·ï¼ŒaæŠŠä¸€ä¸ªæ–‡ä»¶é”ä½ç»™bå‘ä¸€ä¸ªä¿¡å·ï¼Œè¯´è¿™ä¸ªæ–‡ä»¶æˆ‘æ­£åœ¨ä½¿ç”¨            ä¿¡å·æ‰€æºå¸¦çš„æ•°æ®é‡éå¸¸æœ‰é™ï¼Œåªèƒ½æŒ‡å®šä¿¡å·æ˜¯å¹²ä»€ä¹ˆç”¨çš„==============================================æŸ¥çœ‹å†…å­˜ä½¿ç”¨æƒ…å†µ[root@localhost ~]# sar -r 1 101æ—¶31åˆ†38ç§’   kbmemfree kbmemused  %memused kbbuffers  kbcached  kbcommit   %commit01æ—¶31åˆ†39ç§’   6045368     1917916        24.08        67236       649020     2435764     17.73kbcommitï¼šä¿è¯å½“å‰ç³»ç»Ÿæ‰€éœ€è¦çš„å†…å­˜,å³ä¸ºäº†ç¡®ä¿ä¸æº¢å‡ºè€Œéœ€è¦çš„å†…å­˜(RAM+swap).%commitï¼šè¿™ä¸ªå€¼æ˜¯kbcommitä¸å†…å­˜æ€»é‡(åŒ…æ‹¬swap)çš„ä¸€ä¸ªç™¾åˆ†æ¯”.</code></pre><h3 id="I-O"><a href="#I-O" class="headerlink" title="I/O"></a>I/O</h3><pre><code>I/Oè¿™å—æ˜¯å½±å“ç³»ç»Ÿæ€§èƒ½æ¯”è¾ƒå¤§çš„åœ°æ–¹æŸ¥çœ‹é€Ÿåº¦ï¼š    #hdparm -t /dev/sdaå½±å“I/Oæ€§èƒ½çš„å› ç´ 1.mount2.æ–‡ä»¶ç³»ç»Ÿï¼šæ—¥å¿—æ–‡ä»¶ç³»ç»Ÿå’Œéæ—¥å¿—æ–‡ä»¶ç³»ç»Ÿ3.I/Oè°ƒåº¦ç®—æ³•4.RAIDï¼ŒLVMï¼ˆæ¡å¸¦åŒ–ï¼‰ ç½‘ç»œé™„åŠ å­˜å‚¨ï¼ˆcpuçš„iowaitè½¬ç§»åˆ°å­˜å‚¨æœåŠ¡å™¨ï¼‰</code></pre><h5 id="mount"><a href="#mount" class="headerlink" title="mount"></a>mount</h5><p>â€‹    rw    ro</p><hr><p>â€‹    atime noatime</p><hr><p>â€‹    Update inode access time for each access. This is the default.<br>â€‹    atimeæ˜¯è¿™é‡Œå½±å“æ€§èƒ½çš„ä¸€ä¸ªé‡è¦å› ç´ ï¼Œå¯ä»¥ç”¨noatimeå…³æ‰</p><p>â€‹    asyncã€sync</p><hr><p>â€‹    [root@node1 ~]# mount /dev/sdb1 /mnt/<br>â€‹    [root@node1 ~]# mount -o remount,sync /dev/sdb1 /mnt/</p><p>â€‹    æ•°æ®ä¼ è¾“3ç§:<br>â€‹        sync   åº”ç”¨ç¨‹åºäº§ç”Ÿæ•°æ®ä¹Ÿæ˜¯å†™åˆ°ç¼“å­˜ï¼Œä½†æ˜¯ä¼šç­‰åˆ°ç¼“å­˜å†…çš„è„æ•°æ®åŒæ­¥åˆ°ç¡¬ç›˜ä¹‹åæ‰ä¼šäº§ç”Ÿæ–°çš„æ•°æ®<br>â€‹        async  åº”ç”¨ç¨‹åºæŠŠæ•°æ®å†™åˆ°ç¼“å­˜ï¼Œæ“ä½œç³»ç»Ÿé€šè¿‡ä¼™ä¼´ç¨‹åºkswapdæŠŠè„æ•°æ®å†™åˆ°ç¡¬ç›˜ï¼Œè€Œä¸”ä¼šä¸€ç›´äº§ç”Ÿè„æ•°æ®ï¼Œä¸ä¼šç­‰<br>â€‹        directIOç›´æ¥IO  ä¸ä¼šç»è¿‡ç¼“å­˜ï¼Œç›´æ¥å¾€ç¡¬ç›˜ä¸Šå†™</p><p>â€‹    ç»ƒä¹ ï¼š<br>â€‹    ä½¿ç”¨ddå‘½ä»¤æµ‹è¯•sync async directIOä¸‰ç§æ–¹å¼è°å¿«è°æ…¢</p><p>â€‹    é‚£ä¹ˆä¸Šé¢3ç§æ–¹å¼ï¼Œå¯¹åº”ç”¨ç¨‹åºæ¥è¯´ï¼Œasyncæœ€å¿«ï¼Œå…¶æ¬¡æ˜¯ç›´æ¥IOï¼Œæœ€æ…¢çš„æ˜¯åŒæ­¥</p><p>é—®é¢˜ï¼š<br>    è™½ç„¶å¼‚æ­¥å¯¹åº”ç”¨ç¨‹åºå¿«äº†ï¼Œä½†æ˜¯ä¼šäº§ç”Ÿé—®é¢˜ï¼Œæ¯”å¦‚è„æ•°æ®è¿˜æ²¡æ¥å¾—åŠå…¨éƒ¨åŒæ­¥åˆ°ç¡¬ç›˜ï¼Œçªç„¶æ–­ç”µäº†ï¼Œè¿™æ—¶å€™æˆ‘ä»¬ç§°ç¡¬ç›˜ä¸Šçš„ä¸å®Œæ•´æ•°æ®è¢«æŸåï¼Œæˆ–è€…æ•°æ®ä¸ä¸€è‡´</p><pre><code>è§£å†³ï¼š    æ–­ç”µæˆ‘ä»¬é˜»æ­¢ä¸äº†ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥é‡æ–°å†™æ•°æ®ï¼Œä½†æ˜¯ç°åœ¨ä»–æ€ä¹ˆçŸ¥é“å“ªä¸ªæ•°æ®åäº†ï¼Ÿå¼€æœºå¯åŠ¨çš„æ—¶å€™ä½¿ç”¨fsckæ£€æµ‹åå—å„¿</code></pre><p>é—®é¢˜ï¼š<br>    ä½†æ˜¯fsckåœ¨æ•°æ®é‡æ¯”è¾ƒå¤§çš„æ—¶å€™ä¼šéå¸¸æ…¢ï¼Œé‚£æ€ä¹ˆè§£å†³è¿™ä¸ªé—®é¢˜ï¼Ÿ</p><pre><code>è§£å†³ï¼š    é€šè¿‡Journalæ—¥å¿—</code></pre><p>â€‹    åœ¨æ•°æ®å†™åˆ°å†…å­˜ä¹‹å‰å…ˆè®°å½•ä¸€ä¸‹æ—¥å¿—ï¼Œå¦‚æœæ–­ç”µé‡å¯ä¹‹åå‘ç°å“ªä¸ªå†™æ“ä½œæ²¡æœ‰å®Œæˆï¼Œå°±é€šè¿‡æ—¥å¿—æ¢å¤å“ªä¸ªå°±å¯ä»¥äº†</p><p>â€‹    æœ‰æ—¥å¿—ä»¥åçš„æ•°æ®å­˜å‚¨è¿‡ç¨‹:<br>â€‹        å†™æ—¥å¿—<br>â€‹        å†™æ•°æ®<br>â€‹        åˆ é™¤æ—¥å¿—</p><p>ext4å¯ä»¥å…³æ‰æ—¥å¿—ï¼Œä½†æ˜¯åªæœ‰åœ¨æ ¼å¼åŒ–çš„æ—¶å€™æ‰èƒ½å…³</p><p>æœ‰æ—¥å¿—çš„è¯ï¼Œä¼šå˜æ…¢ï¼Œé‚£è¿™ä¸ªé—®é¢˜å¦‚ä½•è§£å†³ï¼Ÿ<br>    åˆ›å»º2ä¸ªåˆ†åŒºï¼Œåˆ†åˆ«æ ¼å¼åŒ–ä¸ºext2ã€ext3ï¼Œddæ–‡ä»¶æµ‹è¯•é€Ÿåº¦å·®å¼‚</p><pre><code>è®°å½•æ—¥å¿—çš„æ–¹æ³•ï¼š    #man mount    Mount options for ext3    data={journal|ordered|writeback}</code></pre><p>â€‹        journalæœ€å¥½ï¼Œä½†æ˜¯è¿™ç§å¼€é”€æœ€å¤§<br>â€‹        journal æŠŠä¿¡æ¯å†™åˆ°ç¼“å­˜ï¼Œè®°å½•æ—¥å¿—ï¼Œè®°å½•inodeå’Œæ•°æ®åˆ°æ—¥å¿—ï¼Œç„¶åå†™åˆ°ç¡¬ç›˜<br>â€‹        ordered è¿™æ˜¯é»˜è®¤çš„æ¨¡å¼æŠŠä¿¡æ¯å†™åˆ°ç¼“å­˜ï¼Œè®°å½•æ—¥å¿—ï¼Œåªè®°å½•inodeï¼Œç„¶åå†™åˆ°ç¡¬ç›˜<br>â€‹        writebacké¦–å…ˆåœ¨ç¼“å­˜å†…æŠŠæ‰€æœ‰çš„å†™æ’å¥½åº,ç„¶åè®°å½•inodeï¼Œæœ€åå†™åˆ°ç¡¬ç›˜<br>â€‹<br>â€‹        æ€§èƒ½ä¸Šorderedå’Œwritebackå·®ä¸å¤š<br>â€‹<br>â€‹    è§£å†³è®°å½•æ—¥å¿—æ…¢é—®é¢˜ï¼š<br>â€‹        ä¹‹æ‰€ä»¥æ—¥å¿—æ…¢ï¼šç¡¬ç›˜æ˜¯ä¸€ä¸ªä¸€ä¸ªçš„ç£ç›˜ç‰‡ï¼Œç¡¬ç›˜æ•ˆç‡æœ€é«˜çš„æ—¶å€™æ˜¯ç£å¤´åœ¨æŸä¸€ä¸ªç£é“ä¸æ¢ä½ç½®ï¼Œå¦‚æœæ•°æ®ä¸è¿ç»­ä¹Ÿå°±æ„å‘³ç€ç£å¤´è¦æ¥å›åœ¨æ—¥å¿—æ•°æ®æ‰€åœ¨çš„ç£é“å’Œæ•°æ®æ‰€åœ¨çš„ç£é“è·³æ¢ï¼Œå¦‚æœèƒ½è§£å†³è¿™ä¸ªé—®é¢˜å°±OKäº†ã€‚æˆ‘ä»¬å¯ä»¥é‡‡ç”¨æ—¥å¿—åˆ†ç¦»çš„æ–¹å¼</p><p>â€‹        æ—¥å¿—åˆ†ç¦»:<br>â€‹            ä¸¤å—ç¡¬ç›˜ï¼Œä¸€å—å­˜æ—¥å¿—ï¼Œä¸€å—å­˜æ•°æ®ï¼Œå¿…é¡»æ˜¯ä¸¤å—ç£ç›˜ï¼Œä¸¤ä¸ªåˆ†åŒºæ˜¯ä¸å¯ä»¥çš„<br>â€‹            #mke2fs -O journal_dev /dev/sdb5   //æŠŠè¿™ä¸ªè®¾å¤‡æ ¼å¼åŒ–æˆä¸“é—¨è®°å½•æ—¥å¿—çš„è®¾å¤‡<br>â€‹            #mkfs.ext3 -J device=/dev/sdb5 /dev/sdb1  //åœ¨æ ¼å¼åŒ–sdb1çš„æ—¶å€™å£°æ˜æ—¥å¿—è®°å½•åœ¨sdb5ä¸Šï¼Œå› ä¸ºæ˜¯åšå®éªŒï¼Œè¿™é‡Œç”¨çš„æ˜¯åˆ†åŒº<br>â€‹            #mount -o data=journal /dev/sdb1 /mnt/<br>â€‹            åœ¨å·¥ä½œå½“ä¸­ä¸€èˆ¬ä¸ç”¨æ—¥å¿—åˆ†ç¦»ï¼Œå› ä¸ºä¸€èˆ¬æˆ‘ä»¬çš„æœåŠ¡å™¨ä¸Šéƒ½æ˜¯raidï¼Œæ‰€ä»¥é€Ÿåº¦ä¸ä¼šæ…¢åˆ°å“ªå»ï¼Œå¦‚æœä¸ç”¨raidçš„è®¾å¤‡å°±å¯èƒ½è¦ç”¨åˆ°æ—¥å¿—åˆ†ç¦»</p><hr><p>å„ç§æ—¥å¿—æ–‡ä»¶ç³»ç»Ÿ:<br>ext3<br>ext4<br>jfs IBMçš„ æ¢å¤ç›¸å½“å¿«<br>xfs å¤„ç†å¤§æ–‡ä»¶æ€§èƒ½ç‰¹åˆ«å¥½<br>reiserfs suseç”¨çš„æ–‡ä»¶ç³»ç»Ÿ<br>btresfs å¤„ç†å°æ–‡ä»¶é€Ÿåº¦ç‰¹åˆ«å¿«</p><p>zfs zæ˜¯26ä¸ªè‹±æ–‡å­—æ¯çš„æœ€åä¸€ä¸ªï¼Œå¯“æ„åœ¨ä»–ä¹‹åä¸ä¼šå†æœ‰å…¶ä»–æ–‡ä»¶ç³»ç»Ÿ</p><p>rhel7å·²ç»æ”¾å¼ƒext4äº†ï¼Œä½¿ç”¨xfs</p><h5 id="I-Oè°ƒåº¦ç®—æ³•"><a href="#I-Oè°ƒåº¦ç®—æ³•" class="headerlink" title="I/Oè°ƒåº¦ç®—æ³•"></a>I/Oè°ƒåº¦ç®—æ³•</h5><pre><code>æŸ¥çœ‹è°ƒåº¦ç®—æ³•[root@localhost ~]# cat /sys/block/sda/queue/schedulernoop anticipatory deadline [cfq]      //è¿™é‡Œæ˜¯æ‰€æœ‰çš„ç®—æ³•ï¼Œè¢«ä¸­æ‹¬å·æ‰©èµ·æ¥çš„cfqå°±æ˜¯é»˜è®¤çš„è°ƒåº¦ç®—æ³•    CFQ (Completely Fair Queuing å®Œå…¨å…¬å¹³çš„æ’é˜Ÿ)(elevator=cfq)ï¼š        è¿™æ˜¯é»˜è®¤ç®—æ³•ï¼Œå¯¹äºé€šç”¨æœåŠ¡å™¨æ¥è¯´é€šå¸¸æ˜¯æœ€å¥½çš„é€‰æ‹©ã€‚å®ƒè¯•å›¾å‡åŒ€åœ°åˆ†å¸ƒå¯¹I/Oå¸¦å®½çš„è®¿é—®ã€‚åœ¨å¤šåª’ä½“åº”ç”¨, æ€»èƒ½ä¿è¯audioã€videoåŠæ—¶ä»ç£ç›˜è¯»å–æ•°æ®ã€‚ä½†å¯¹äºå…¶ä»–å„ç±»åº”ç”¨è¡¨ç°ä¹Ÿå¾ˆå¥½ã€‚æ¯ä¸ªè¿›ç¨‹ä¸€ä¸ªqueueï¼Œæ¯ä¸ªqueueæŒ‰ç…§ä¸Šè¿°è§„åˆ™è¿›è¡Œmerge å’Œsortã€‚è¿›ç¨‹ä¹‹é—´round robinè°ƒåº¦ï¼Œæ¯æ¬¡æ‰§è¡Œä¸€ä¸ªè¿›ç¨‹çš„4ä¸ªè¯·æ±‚ã€‚    Deadline (elevator=deadline)ï¼š        è¿™ä¸ªç®—æ³•è¯•å›¾æŠŠæ¯æ¬¡è¯·æ±‚çš„å»¶è¿Ÿé™è‡³æœ€ä½ã€‚è¯¥ç®—æ³•é‡æ’äº†è¯·æ±‚çš„é¡ºåºæ¥æé«˜æ€§èƒ½ã€‚    NOOP (elevator=noop):        è¿™ä¸ªç®—æ³•å®ç°äº†ä¸€ä¸ªç®€å•FIFOé˜Ÿåˆ—ã€‚ä»–å‡å®šI/Oè¯·æ±‚ç”±é©±åŠ¨ç¨‹åºæˆ–è€…è®¾å¤‡åšäº†ä¼˜åŒ–æˆ–è€…é‡æ’äº†é¡ºåº(å°±åƒä¸€ä¸ªæ™ºèƒ½æ§åˆ¶å™¨å®Œæˆçš„å·¥ä½œé‚£æ ·)ã€‚åœ¨æœ‰äº›SANç¯å¢ƒä¸‹ï¼Œè¿™ä¸ªé€‰æ‹©å¯èƒ½æ˜¯æœ€å¥½é€‰æ‹©ã€‚é€‚ç”¨äºéšæœºå­˜å–è®¾å¤‡, no seek costï¼Œéæœºæ¢°å¯éšæœºå¯»å€çš„ç£ç›˜ã€‚    Anticipatory (elevator=as):        è¿™ä¸ªç®—æ³•æ¨è¿ŸI/Oè¯·æ±‚ï¼Œå¸Œæœ›èƒ½å¯¹å®ƒä»¬è¿›è¡Œæ’åºï¼Œè·å¾—æœ€é«˜çš„æ•ˆç‡ã€‚åŒdeadlineä¸åŒä¹‹å¤„åœ¨äºæ¯æ¬¡å¤„ç†å®Œè¯»è¯·æ±‚ä¹‹å, ä¸æ˜¯ç«‹å³è¿”å›, è€Œæ˜¯ç­‰å¾…å‡ ä¸ªå¾®å¦™åœ¨è¿™æ®µæ—¶é—´å†…, ä»»ä½•æ¥è‡ªä¸´è¿‘åŒºåŸŸçš„è¯·æ±‚éƒ½è¢«ç«‹å³æ‰§è¡Œ. è¶…æ—¶ä»¥å, ç»§ç»­åŸæ¥çš„å¤„ç†.åŸºäºä¸‹é¢çš„å‡è®¾: å‡ ä¸ªå¾®å¦™å†…, ç¨‹åºæœ‰å¾ˆå¤§æœºä¼šæäº¤å¦ä¸€æ¬¡è¯·æ±‚.è°ƒåº¦å™¨è·Ÿè¸ªæ¯ä¸ªè¿›ç¨‹çš„ioè¯»å†™ç»Ÿè®¡ä¿¡æ¯, ä»¥è·å¾—æœ€ä½³é¢„æœŸ.-------------------------------------    APP    appå‘å‡ºè¯·æ±‚åˆ°ä¸‹å±‚    buffer cache    ioè°ƒåº¦å™¨    ç¡¬ç›˜cfq å®Œå…¨å…¬å¹³é˜Ÿåˆ—    aï¼Œbï¼Œcä¸‰ä¸ªappå‘å‡ºè¯·æ±‚ï¼Œ cfqä¼šä¸ºæ¯ä¸ªappå‡†å¤‡ä¸€ä¸ªé˜Ÿåˆ—ï¼Œcfgä¼šåœ¨æ¯ä¸ªé˜Ÿåˆ—é‡Œé¢ä¸€æ¬¡å–4ä¸ªè¯·æ±‚ï¼Œå¦‚æœè¿˜æœ‰å‰©ä½™è¯·æ±‚ï¼Œç»§ç»­å†å–ï¼Œæ€»ä¹‹æ˜¯4ä¸ª4ä¸ªçš„å–ï¼Œä»–çš„å¥½å¤„å°±æ˜¯æ¯ä¸ªappéƒ½ä¼šå¾—åˆ°å“åº”    æ¯ä¸ªappè‡ªå·±çš„è¯·æ±‚å¯èƒ½éƒ½æ˜¯è¿ç»­çš„ï¼Œä½†æ˜¯appå’Œappä¹‹é—´ä»–ä»¬å¯èƒ½å°±ä¸ä¼šåœ¨åŒä¸€ä¸ªç£é“ä¸Šï¼Œè¿™æ ·å°±ä¼šå¢åŠ ç£å¤´çš„å¯»å€    æ‰€ä»¥cfgé€‚ç”¨äºå¤šåª’ä½“æˆ–è€…è¯´æ¡Œé¢çº§ç³»ç»Ÿdeadline    deadlineä¼šæŠŠa,b,cçš„æ‰€æœ‰è¯·æ±‚æ”¾åˆ°åŒä¸€ä¸ªé˜Ÿåˆ—ï¼Œç„¶åå¯¹ä»–ä»¬è¿›è¡Œæ’åºï¼Œç„¶ååœ¨æŠŠç»Ÿä¸€ç±»å‹çš„è¯·æ±‚æ¯”å¦‚è¯»çš„è¯·æ±‚æ”¾åˆ°fifoé‡Œé¢(fifoå°±æ˜¯å…ˆè¿›å…ˆå‡º)    æ¯”å¦‚ï¼š    a 11 12 13 47    b 31 32 38 39    c 27 28 41 42    deadline    11    12    13    27    28    31    32    38    39    41    42    47    å…ˆå¤„ç†11ï¼Œç„¶å12ï¼Œ13ï¼Œã€‚ã€‚ã€‚ã€‚ç›´åˆ°æœ€åçš„47    ä½†æ˜¯deadlineä¼šä½¿aè¿›å…¥é¥¿æ­»çŠ¶æ€(æ¯”å¦‚47)ï¼Œæ€æ ·è§£å†³ æˆ‘ä»¬ä¼šç»™æ¯ä¸€ä¸ªè¯·æ±‚è§„å®šä¸€ä¸ªæ—¶é—´ï¼ˆè¿‡äº†è¿™ä¸ªæ—¶é—´å°±é¥¿æ­»äº†ï¼‰ï¼Œå¦‚æœå‘ç°æŸä¸€ä¸ªè¯·æ±‚åˆ°æ—¶é—´äº†ï¼Œé‚£ä¹ˆåœæ­¢ç°åœ¨å…¶ä»–æ‰€æœ‰çš„æ“ä½œå»å¤„ç†åˆ°è¾¾è§„å®šæ—¶é—´çš„é‚£ä¸ªè¯·æ±‚    11    12    13    27    28    31    32    38    39    41    42    47    anticipatoryè·Ÿdeadlineå·®ä¸å¤š,3.0çš„å†…æ ¸é‡Œé¢å·²ç»ç æ‰äº†ï¼Œä½†æ˜¯è·Ÿdeadlineä¸ä¸€æ ·çš„åœ°æ–¹æ˜¯å¤„ç†11ï¼Œ12ï¼Œ13å®Œäº‹å„¿ä¹‹åå…ˆç­‰ä¸€ä¸‹ï¼Œçœ‹è¿˜æœ‰æ²¡æœ‰14ï¼Œ15å¦‚æœæ²¡æœ‰çš„è¯å†ç»§ç»­    noopç›´æ¥fifoï¼Œè°å…ˆæ¥ï¼Œå…ˆå¤„ç†è°  ssdçš„ç¡¬ç›˜ä¼šä½¿ç”¨  sanå­˜å‚¨ä¹Ÿä¼šç”¨åˆ°--------------------------------------------------------------------å¯¹IOè°ƒåº¦ä½¿ç”¨çš„å»ºè®®Deadline I/O scheduler ä½¿ç”¨è½®è¯¢çš„è°ƒåº¦å™¨,ç®€æ´å°å·§,æä¾›äº†æœ€å°çš„è¯»å–å»¶è¿Ÿå’Œå°šä½³çš„ååé‡,ç‰¹åˆ«é€‚åˆäºè¯»å–è¾ƒå¤šçš„ç¯å¢ƒ(æ¯”å¦‚æ•°æ®åº“,Oracle 10G ä¹‹ç±»).Anticipatory I/O scheduler å‡è®¾ä¸€ä¸ªå—è®¾å¤‡åªæœ‰ä¸€ä¸ªç‰©ç†æŸ¥æ‰¾ç£å¤´(ä¾‹å¦‚ä¸€ä¸ªå•ç‹¬çš„SATAç¡¬ç›˜),å°†å¤šä¸ªéšæœºçš„å°å†™å…¥æµåˆå¹¶æˆä¸€ä¸ªå¤§å†™å…¥æµ,ç”¨å†™å…¥å»¶æ—¶æ¢å–æœ€å¤§çš„å†™å…¥ååé‡.é€‚ç”¨äºå¤§å¤šæ•°ç¯å¢ƒ,ç‰¹åˆ«æ˜¯å†™å…¥è¾ƒå¤šçš„ç¯å¢ƒ(æ¯”å¦‚æ–‡ä»¶æœåŠ¡å™¨)Web,Appç­‰åº”ç”¨æˆ‘ä»¬å¯ä»¥é‡‡çº³asè°ƒåº¦.CFQ I/O schedulerä½¿ç”¨QoSç­–ç•¥ä¸ºæ‰€æœ‰ä»»åŠ¡åˆ†é…ç­‰é‡çš„å¸¦å®½,é¿å…è¿›ç¨‹è¢«é¥¿æ­»å¹¶å®ç°äº†è¾ƒä½çš„å»¶è¿Ÿ,å¯ä»¥è®¤ä¸ºæ˜¯ä¸Šè¿°ä¸¤ç§è°ƒåº¦å™¨çš„æŠ˜ä¸­.é€‚ç”¨äºæœ‰å¤§é‡è¿›ç¨‹çš„å¤šç”¨æˆ·ç³»ç»Ÿè®¾ç½®è°ƒåº¦æ–¹æ³•ï¼š    linuxå¯åŠ¨æ—¶è®¾ç½®é»˜è®¤IOè°ƒåº¦,è®©ç³»ç»Ÿå¯åŠ¨æ—¶å°±ä½¿ç”¨é»˜è®¤çš„IOæ–¹æ³•,åªéœ€åœ¨grub.confæ–‡ä»¶ä¸­åŠ å…¥ç±»ä¼¼å¦‚ä¸‹è¡Œ    kernel /vmlinuz-2.6.24 ro root=/dev/sda1 elevator=deadline</code></pre><h5 id="æŸ¥çœ‹I-OçŠ¶æ€"><a href="#æŸ¥çœ‹I-OçŠ¶æ€" class="headerlink" title="æŸ¥çœ‹I/OçŠ¶æ€"></a>æŸ¥çœ‹I/OçŠ¶æ€</h5><pre><code>[root@localhost ~]# sar -d 1 100Linux 2.6.32-358.el6.x86_64 (mail.robin.com)     2013å¹´11æœˆ21æ—¥     _x86_64_    (1 CPU)22æ—¶25åˆ†22ç§’       DEV       tps  rd_sec/s  wr_sec/s  avgrq-sz  avgqu-sz     await     svctm     %util22æ—¶25åˆ†23ç§’   dev11-0      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.0022æ—¶25åˆ†23ç§’    dev8-0    844.58      0.00  10987.95     13.01      0.54      0.65      0.48     40.84æ—¶é—´    è®¾å¤‡ä¸»ä»å·  æ¯ç§’è¯»å†™è¯·æ±‚æ¬¡æ•° æ¯ç§’è¯»å¤šå°‘ä¸ªæ‰‡åŒº  æ¯ç§’å†™çš„æ‰‡åŒºä¸ªæ•° å¹³å‡è¯·æ±‚å¤§å° å¹³å‡é˜Ÿåˆ—é•¿åº¦ ç­‰å¾…æ—¶é—´tps æ¯ç§’è¯·æ±‚æ•°rd_sec/s æ¯ç§’è¯»çš„æ‰‡åŒºæ•°wr_sec/s æ¯ç§’å†™çš„æ‰‡åŒºæ•°avgrq-sz  å¹³å‡æ¯ä¸ªè¯·æ±‚çš„å¤§å°(è¯»å†™)avgqu-sz å¹³å‡é˜Ÿåˆ—é•¿åº¦  é˜Ÿåˆ—è¶Šé•¿ioæ€§èƒ½è¶Šä½await  ioè¯·æ±‚æ¶ˆè€—çš„å¹³å‡æ—¶é—´(æ¯«ç§’)   æ‰€æœ‰æ—¶é—´(åŒ…æ‹¬ç­‰å¾…æ—¶é—´å’ŒæœåŠ¡æ—¶é—´)       await-svctm=ioçš„ç­‰å¾…æ—¶é—´ å·®å€¼è¶Šå¤§  ioè¶Šç¹å¿™         ç­‰å¾…æ—¶é—´ï¼šå‡å¦‚ç°åœ¨æœ‰å—ç¡¬ç›˜ï¼Œå¤„ç†é€Ÿåº¦æ¯ç§’èƒ½å¤„ç†10ä¸ªè¯·æ±‚ï¼Œé‚£ä¹ˆæˆ‘ç°åœ¨ç»™ä»–å‘15ä¸ªï¼Œå¤„ç†ä¸è¿‡æ¥æ€ä¹ˆåŠï¼Ÿæ’é˜Ÿ awaitå°±æ˜¯ä»è¿›é˜Ÿåˆ—ä¸€ç›´åˆ°å¤„ç†å®Œä¸€å…±ç”¨äº†å¤šé•¿æ—¶é—´svctmï¼šè°ƒåº¦å™¨å¤„ç†è¿™ä¸ªæ’é˜Ÿçš„è¯·æ±‚ç”¨äº†å¤šé•¿æ—¶é—´ï¼Œæ¯”å¦‚ä½ æ’é˜Ÿçœ‹åŒ»ç”Ÿï¼ŒåŒ»ç”Ÿç»™ä½ çœ‹ç—…èŠ±äº†å¤šé•¿æ—¶é—´%util ioå¤„ç†ioè¯·æ±‚æ‰€æ¶ˆè€—çš„cpuç™¾åˆ†æ¯”[root@localhost ~]# iostat -kDevice:            tps    kB_read/s    kB_wrtn/s    kB_read    kB_wrtnscd0              0.00         0.02         0.00        216          0sda             653.44        28.39      4613.55     365863   59445489[root@localhost ~]# iostat -x 1Device:         rrqm/s   wrqm/s     r/s     w/s   rsec/s   wsec/s avgrq-sz avgqu-sz   await  svctm  %utilscd0              0.00     0.00    0.00    0.00     0.03     0.00     6.86     0.00    2.76   2.76   0.00sda               2.46   500.26    0.82  651.74    56.41  9215.99    14.21     0.69    1.06   0.73  47.67rrqm/s æ¯ç§’åˆå¹¶çš„è¯»è¯·æ±‚æ¬¡æ•°wrqm/s æ¯ç§’åˆå¹¶çš„å†™è¯·æ±‚æ¬¡æ•°aå¯¹æŸä¸€ä¸ªå—å‘å‡ºä¸€ä¸ªè¯»è¯·æ±‚ï¼Œä½†æ˜¯ç°åœ¨å› ä¸ºç¡¬ç›˜é€Ÿåº¦æ…¢ï¼Œè¿˜æ²¡æ¥å¾—åŠå¤„ç†ï¼Œç»“æœaåˆå¯¹è¿™ä¸ªå—å‘å‡ºä¸€ä¸ªè¯»è¯·æ±‚ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥æŠŠè¿™ä¸¤ä¸ªè¯»è¯·æ±‚åˆå¹¶åˆ°ä¸€èµ·aå¯¹æŸä¸€ä¸ªå—å‘å‡ºä¸€ä¸ªå†™è¯·æ±‚ï¼Œæ¯”å¦‚æŠŠæŸä¸€å—æ•°æ®æ”¹æˆ123ï¼Œä½†æ˜¯æ²¡æ¥å¾—åŠå¤„ç†ï¼Œaåˆå¯¹è¿™ä¸ªå—å„¿å‘å‡ºä¸€ä¸ªå†™è¯·æ±‚è¦æŠŠæ•°æ®æ”¹æˆ789ï¼Œé‚£ä¹ˆè¿™ä¸ªæœ€åçš„ç»“æœæ˜¯789ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æŠŠè¿™ä¸¤ä¸ªå†™è¯·æ±‚åˆå¹¶</code></pre><h6 id="filesystemï¼ˆäº†è§£ï¼‰"><a href="#filesystemï¼ˆäº†è§£ï¼‰" class="headerlink" title="filesystemï¼ˆäº†è§£ï¼‰"></a>filesystemï¼ˆäº†è§£ï¼‰</h6><pre><code>éœ€è¦ä¸€äº›ç¼–è¯‘å·¥å…·ï¼Œå®‰è£…â€œå¼€å‘å·¥å…·â€ â€œå¼€å‘åº“â€[root@localhost ~]# yum groupinstall &quot;Development Libraries&quot; &quot;Development Tools&quot;å®‰è£…ä¸ç°æœ‰å†…æ ¸ç‰ˆæœ¬ç›¸å¯¹åº”çš„src.rpm[root@localhost ~]# uname -r2.6.18-308.el5xen[root@localhost ~]# rpm -ivh /tmp/kernel-2.6.18-308.el5.src.rpmrhel5ä¼šå°†src .rpmé‡Šæ”¾åˆ°/usr/src/redhat/ä¸­ï¼ˆrhel6ä¼šé‡Šæ”¾åˆ°å½“å‰ç”¨æˆ·å®¶ç›®å½•ä¸‹çš„rpmbuildï¼‰[root@localhost ~]# cd /usr/src/redhat/[root@localhost redhat]# lsBUILD  RPMS  SOURCES  SPECS  SRPMSBUILD         æ“ä½œæºç è¿‡ç¨‹ä¸­äº§ç”Ÿçš„æ•°æ®RPMS         å­˜æ”¾åˆ¶ä½œå¥½çš„rpmSOURCES     å­˜æ”¾ç¨‹åºçš„æºä»£ç å’Œç›¸å…³æ–‡ä»¶SPECS         å­˜æ”¾åˆ¶ä½œrpmæ‰€ä½¿ç”¨çš„specè„šæœ¬SRPMS         å­˜æ”¾src.rpm[root@localhost redhat]# cd SPECS/[root@localhost SPECS]# ls -l æ€»è®¡ 820-rw-r--r-- 1 root root 834836 2010-03-17 kernel-2.6.spec[root@localhost SPECS]# rpmbuild  -bp --target=$(uname -m)  kernel-2.6.spec [root@localhost ~]# cd /usr/src/redhat/BUILD/kernel-2.6.18/linux-2.6.18.i686[root@localhost linux-2.6.18.i686]# cp /boot/config-2.6.18-308.el5xen  .configç¼–è¾‘Makefileï¼ŒEXTRAVERSION = -308.el5xen ä¸å½“å‰å†…æ ¸ç‰ˆæœ¬ç›¸å¯¹åº”[root@localhost linux-2.6.18.i686]# vim Makefile    EXTRAVERSION = -308.el5xen        #ç¬¬å››è¡Œ[root@localhost linux-2.6.18.i686]# make oldconfigåœ¨ç¼–è¯‘æ¨¡å—çš„è¿‡ç¨‹ä¸­éœ€è¦ .tmp_versionsä¸´æ—¶ç›®å½•[root@localhost linux-2.6.18.i686]# mkdir .tmp_versionsåœ¨å­—ç¬¦èœå•ä¸­æ‰¾åˆ°æ–‡ä»¶ç³»ç»Ÿæ–‡ä»¶ç³»ç»Ÿï¼Œåœ¨å…¶ä¸­æ‰¾åˆ°Reiserfsã€JFSã€XFSï¼Œä½¿ç”¨Mé€‰ä¸­ï¼ˆext4é»˜è®¤å°±å·²ç»æœ‰äº†ï¼‰[root@localhost linux-2.6.18.i686]# make menuconfig File systems  ---&gt;       &lt;M&gt; Reiserfs support      &lt;M&gt; JFS filesystem support      &lt;M&gt; XFS filesystem supportå•ç‹¬ç¼–è¯‘3ä¸ªæ–‡ä»¶ç³»ç»Ÿæ¨¡å—[root@localhost linux-2.6.18.i686]# make fs/xfs/xfs.ko[root@localhost linux-2.6.18.i686]# make fs/jfs/jfs.ko[root@localhost linux-2.6.18.i686]# make fs/reiserfs/reiserfs.koåœ¨ç³»ç»Ÿå†…æ ¸æ¨¡å—ç›®å½•ä¸­ï¼Œåˆ›å»º3ä¸ªæ–‡ä»¶ç³»ç»Ÿçš„å¯¹åº”ç›®å½•ï¼Œå¹¶å°†ç¼–è¯‘å¥½çš„æ¨¡å—æ‹·è´åˆ°å¯¹åº”çš„ç›®å½•ä¸­[root@localhost linux-2.6.18.i686]# mkdir  /lib/modules/2.6.18-308.el5xen/kernel/fs/jfs[root@localhost linux-2.6.18.i686]# mkdir  /lib/modules/2.6.18-308.el5xen/kernel/fs/reiserfs[root@localhost linux-2.6.18.i686]# mkdir  /lib/modules/2.6.18-308.el5xen/kernel/fs/xfs[root@localhost linux-2.6.18.i686]# cp  fs/jfs/jfs.ko  /lib/modules/2.6.18-308.el5xen/kernel/fs/jfs[root@localhost linux-2.6.18.i686]# cp  fs/reiserfs/reiserfs.ko  /lib/modules/2.6.18-308.el5xen/kernel/fs/reiserfs[root@localhost linux-2.6.18.i686]# cp  fs/xfs/xfs.ko  /lib/modules/2.6.18-308.el5xen/kernel/fs/xfsext4çš„æ¨¡å—rhel5u8ä¸­é»˜è®¤å°±æœ‰ï¼Œæ”¾åœ¨ä»¥ä¸‹ä½ç½® [root@localhost linux-2.6.18.i686]# ls /lib/modules/2.6.18-194.el5/kernel/fs/ext4/ext4.ko /lib/modules/2.6.18-194.el5/kernel/fs/ext4/ext4.koæ£€æŸ¥æ¨¡å—ä¾èµ–æ€§å¹¶åŠ è½½æ¨¡å—[root@lcoalhost linux-2.6.18.i686]# depmod -a[root@lcoalhost linux-2.6.18.i686]# modprobe  xfs[root@localhost linux-2.6.18.i686]# modprobe  jfs[root@localhost linux-2.6.18.i686]# modprobe  reiserfs[root@localhost linux-2.6.18.i686]# modprobe  ext4å®‰è£…åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿçš„å·¥å…·ext4ï¼š    [root@localhost tmp]# yum install e4fsprogsJFS:    [root@localhost tmp]# tar xf jfsutils-1.1.14.tar.gz      ./configure &amp;&amp; make &amp;&amp; make installXFS:    [root@localhost tmp]# tar xf xfsprogs_2.9.8-1.tar.bz2      ./configure &amp;&amp; make &amp;&amp; make installREISERFS:    [root@localhost tmp]# tar xf reiserfsprogs-3.6.21.tar.bz2      ./configure &amp;&amp; make &amp;&amp; make installåˆ›å»º4ä¸ªåˆ†åŒºæ¯ä¸ª2Gï¼Œåˆ†åˆ«ç»™4ä¸ªåˆ†åŒºåˆ›å»º4ç§æ–‡ä»¶ç³»ç»Ÿï¼Œå¹¶æŒ‚è½½åˆ°å¯¹åº”åç§°çš„ç›®å½•[root@localhost tmp]# mkfs.xfs /dev/sda13[root@localhost tmp]# mkfs.jfs /dev/sda12[root@localhost tmp]# mkreiserfs /dev/sda11[root@localhost tmp]# mkfs.ext4 /dev/sda10[root@localhost tmp]# mkdir /xfs[root@localhost tmp]# mkdir /jfs[root@localhost tmp]# mkdir /reiserfs[root@localhost tmp]# mkdir /ext4[root@localhost tmp]# mount -t xfs /dev/sda13 /xfs[root@localhost tmp]# mount -t reiserfs /dev/sda11 /reiserfs/[root@localhost tmp]# mount -t jfs  /dev/sda12  /jfs/[root@localhost tmp]# mount -t ext4 /dev/sda10  /ext4[root@apache xfsprogs-2.9.8]# df -Tæ–‡ä»¶ç³»ç»Ÿ          ç±»å‹         1K-å—           å·²ç”¨         å¯ç”¨         å·²ç”¨%     æŒ‚è½½ç‚¹/dev/sda13       xfs         1949656          4256       1945400       1%         /xfs/dev/sda11       reiserfs     1959808         32840       1926968       2%         /reiserfs/dev/sda12      jfs         1951440           372         1951068       1%         /jfs/dev/sda10      ext4         1929068         35648       1795428       2%         /ext4</code></pre><h6 id="xfsï¼ˆäº†è§£ï¼‰"><a href="#xfsï¼ˆäº†è§£ï¼‰" class="headerlink" title="xfsï¼ˆäº†è§£ï¼‰"></a>xfsï¼ˆäº†è§£ï¼‰</h6><pre><code>XFS æœ€åˆæ˜¯ç”± Silicon Graphicsï¼ŒInc. å¼€å‘çš„ã€‚æ”¯æŒæœ€å¤§æ–‡ä»¶ç³»ç»Ÿåˆ°16EBï¼Œæœ€å¤§æ–‡ä»¶8EBï¼Œé‚£æ•°ä»¥åƒä¸‡è®¡çš„ç›®å½•ç»“æ„æ¡ç›®ã€‚XFSæ–‡ä»¶ç³»ç»Ÿæ”¯æŒmetadata æ—¥å¿—ï¼Œæ›´å¿«çš„å´©æºƒæ¢å¤ï¼Œåœ¨çº¿æ•´ç†ç¢ç‰‡ï¼Œåœ¨çº¿å¢é•¿ï¼Œä½¿ç”¨å®ç”¨å·¥å…·ï¼ˆxfsdumpå’Œxfsrestoreï¼‰å¤‡ä»½ä¸æ¢å¤ã€‚xfsåœ¨å¤„ç†ç‰¹å¤§æ–‡ä»¶ä¸Šæœ‰å¾ˆå¥½çš„è¡¨ç°ï¼Œåœ¨å¤šçº¿ç¨‹å¹¶è¡ŒI/Oçš„å·¥ä½œæ¨¡å¼ä¸‹å¤„ç†å°æ–‡ä»¶ä¹Ÿæœ‰å¾ˆå¥½çš„è¡¨ç°xfsä¹Ÿæ”¯æŒä»¥ä¸‹ç‰¹å¾åŸºäºExtentçš„åˆ†é…æ–¹å¼XFSæ–‡ä»¶ç³»ç»Ÿä¸­çš„æ–‡ä»¶ç”¨åˆ°çš„å—ç”±å˜é•¿Extentç®¡ç†ï¼Œæ¯ä¸€ä¸ªExtentæè¿°äº†ä¸€ä¸ªæˆ–å¤šä¸ªè¿ç»­çš„å—ã€‚ç›¸æ¯”å°†æ¯ä¸ªæ–‡ä»¶ç”¨åˆ°çš„æ‰€æœ‰çš„å—å­˜å‚¨ä¸ºåˆ—è¡¨çš„æ–‡ä»¶ç³»ç»Ÿï¼Œè¿™ç§ç­–ç•¥å¤§å¹…ç¼©çŸ­äº†åˆ—è¡¨çš„é•¿åº¦ã€‚æœ‰äº›æ–‡ä»¶ç³»ç»Ÿç”¨ä¸€ä¸ªæˆ–å¤šä¸ªé¢å‘å—çš„æ …æ ¼ç®¡ç†ç©ºé—´åˆ†é…åœ¨XFSä¸­è¿™ç§ç»“æ„è¢«ç”±ä¸€å¯¹B+æ ‘ç»„æˆçš„ã€é¢å‘Extentçš„ç»“æ„æ›¿ä»£äº†ï¼›æ¯ä¸ªæ–‡ä»¶ç³»ç»Ÿåˆ†é…ç»„(AG)åŒ…å«è¿™æ ·çš„ä¸€ä¸ªç»“æ„ã€‚å…¶ä¸­ï¼Œä¸€ä¸ªB+æ ‘ç”¨äºç´¢å¼•æœªè¢«ä½¿ç”¨çš„Extentçš„é•¿åº¦ï¼Œå¦ä¸€ä¸ªç´¢å¼•è¿™äº›Extentçš„èµ·å§‹å—ã€‚è¿™ç§åŒç´¢å¼•ç­–ç•¥ä½¿å¾—æ–‡ä»¶ç³»ç»Ÿåœ¨å®šä½å‰©ä½™ç©ºé—´ä¸­çš„Extentæ—¶ååˆ†é«˜æ•ˆã€‚æ¡å¸¦åŒ–åˆ†é…åœ¨æ¡å¸¦åŒ–RAIDé˜µåˆ—ä¸Šåˆ›å»ºXFSæ–‡ä»¶ç³»ç»Ÿæ—¶ï¼Œå¯ä»¥æŒ‡å®šä¸€ä¸ªâ€œæ¡å¸¦åŒ–æ•°æ®å•å…ƒâ€ã€‚è¿™å¯ä»¥ä¿è¯æ•°æ®åˆ†é…ã€inodeåˆ†é…ã€ä»¥åŠå†…éƒ¨æ—¥å¿—è¢«å¯¹é½åˆ°è¯¥æ¡å¸¦å•å…ƒä¸Šï¼Œä»¥æ­¤æœ€å¤§åŒ–ååé‡ã€‚å»¶è¿Ÿåˆ†é…XFSåœ¨æ–‡ä»¶åˆ†é…ä¸Šä½¿ç”¨äº†æƒ°æ€§è®¡ç®—æŠ€æœ¯ã€‚å½“ä¸€ä¸ªæ–‡ä»¶è¢«å†™å…¥ç¼“å­˜æ—¶ï¼ŒXFSç®€å•åœ°åœ¨å†…å­˜ä¸­å¯¹è¯¥æ–‡ä»¶ä¿ç•™åˆé€‚æ•°é‡çš„å—ï¼Œè€Œä¸æ˜¯ç«‹å³å¯¹æ•°æ®åˆ†é…Extentã€‚å®é™…çš„å—åˆ†é…ä»…åœ¨è¿™æ®µæ•°æ®è¢«å†²åˆ·åˆ°ç£ç›˜æ—¶æ‰å‘ç”Ÿã€‚è¿™ä¸€æœºåˆ¶æé«˜äº†å°†è¿™ä¸€æ–‡ä»¶å†™å…¥ä¸€ç»„è¿ç»­çš„å—ä¸­çš„æœºä¼šï¼Œå‡å°‘ç¢ç‰‡çš„åŒæ—¶æå‡äº†æ€§èƒ½ã€‚æ‰©å±•å±æ€§XFSé€šè¿‡å®ç°æ‰©å±•æ–‡ä»¶å±æ€§ç»™æ–‡ä»¶æä¾›äº†å¤šä¸ªæ•°æ®æµï¼Œä½¿æ–‡ä»¶å¯ä»¥è¢«é™„åŠ å¤šä¸ªå/å€¼å¯¹ã€‚æ–‡ä»¶åæ˜¯ä¸€ä¸ªæœ€å¤§é•¿åº¦ä¸º256å­—èŠ‚çš„ã€ä»¥NULLå­—ç¬¦ç»“å°¾çš„å¯æ‰“å°å­—ç¬¦ä¸²ï¼Œå…¶å®ƒçš„å…³è”å€¼åˆ™å¯åŒ…å«å¤šè¾¾ 64KB çš„äºŒè¿›åˆ¶æ•°æ®ã€‚è¿™äº›æ•°æ®è¢«è¿›ä¸€æ­¥åˆ†å…¥ä¸¤ä¸ªåå­—ç©ºé—´ä¸­ï¼Œrootå’Œuserã€‚ä¿å­˜åœ¨rootåå­—ç©ºé—´ä¸­çš„æ‰©å±•å±æ€§åªèƒ½è¢«è¶…çº§ç”¨æˆ·ä¿®æ”¹ï¼Œuseråå­—ç©ºé—´ä¸­çš„å¯ä»¥è¢«ä»»ä½•å¯¹è¯¥æ–‡ä»¶æ‹¥æœ‰å†™æƒé™çš„ç”¨æˆ·ä¿®æ”¹ã€‚æ‰©å±•å±æ€§å¯ä»¥è¢«æ·»åŠ åˆ°ä»»æ„ä¸€ç§XFS inodeä¸Šï¼ŒåŒ…æ‹¬ç¬¦å·é“¾æ¥ã€è®¾å¤‡èŠ‚ç‚¹ã€ç›®å½•ï¼Œç­‰ç­‰ã€‚å¯ä»¥ä½¿ç”¨ attr è¿™ä¸ªå‘½ä»¤è¡Œç¨‹åºæ“ä½œè¿™äº›æ‰©å±•å±æ€§ã€‚xfsdump å’Œ xfsrestore å·¥å…·åœ¨è¿›è¡Œå¤‡ä»½å’Œæ¢å¤æ—¶ä¼šä¸€åŒæ“ä½œæ‰©å±•å±æ€§ï¼Œè€Œå…¶å®ƒçš„å¤§å¤šæ•°å¤‡ä»½ç³»ç»Ÿåˆ™ä¼šå¿½ç•¥æ‰©å±•å±æ€§ã€‚XFS æ”¯æ´ disk quotaã€‚ xfså±€é™æ€§1.XFSæ˜¯ä¸€ä¸ªå•èŠ‚ç‚¹æ–‡ä»¶ç³»ç»Ÿï¼Œå¦‚æœéœ€è¦å¤šèŠ‚ç‚¹åŒæ—¶è®¿é—®éœ€è¦è€ƒè™‘ä½¿ç”¨GFS2æ–‡ä»¶ç³»ç»Ÿ2.XFSæ”¯æŒ16EBæ–‡ä»¶ç³»ç»Ÿï¼Œè€Œredhatä»…æ”¯æŒ100TBæ–‡ä»¶ç³»ç»Ÿ3.XFSè¾ƒå°‘çš„é€‚ç”¨åœ¨å•çº¿ç¨‹å…ƒæ•°æ®å¯†é›†çš„å·¥ä½œè´Ÿè·ï¼Œåœ¨å•çº¿ç¨‹åˆ›å»ºåˆ é™¤å·¨å¤§æ•°é‡çš„å°æ–‡ä»¶çš„å·¥ä½œè´Ÿè·ä¸‹ï¼Œå…¶ä»–æ–‡ä»¶ç³»ç»Ÿï¼ˆext4ï¼‰è¡¨ç°çš„ä¼šæ›´å¥½ä¸€äº›4.xfsæ–‡ä»¶åœ¨æ“ä½œå…ƒæ•°æ®æ—¶å¯èƒ½ä¼šä½¿ç”¨2å€çš„ext4CPUèµ„æºï¼Œåœ¨CPUèµ„æºæœ‰é™åˆ¶çš„æƒ…å†µä¸‹å¯ä»¥ç ”ç©¶ä½¿ç”¨ä¸åŒæ–‡ä»¶ç³»ç»Ÿ5.xfsæ›´å¤šé€‚ç”¨çš„ç‰¹å¤§æ–‡ä»¶çš„ç³»ç»Ÿå¿«é€Ÿå­˜å‚¨ï¼Œext4åœ¨å°æ–‡ä»¶çš„ç³»ç»Ÿæˆ–ç³»ç»Ÿå­˜å‚¨å¸¦å®½æœ‰é™çš„æƒ…å†µä¸‹è¡¨ç°çš„æ›´å¥½[root@node6 ~]# yum install xfsprogs -y[root@node6 ~]# mkfs.xfs /dev/vdb1meta-data=/dev/vdb1           isize=256        agcount=4, agsize=6016 blks              =                           sectsz=512       attr=2, projid32bit=0data          =                           bsize=4096       blocks=24064, imaxpct=25              =                           sunit=0          swidth=0 blksnaming    =version 2              bsize=4096       ascii-ci=0log          =internal log           bsize=4096       blocks=1200, version=2             =                           sectsz=512       sunit=0 blks, lazy-count=1realtime  =none                    extsz=4096       blocks=0, rtextents=0[root@node6 ~]# mkfs.xfs -l logdev=/dev/vdb2 /dev/vdb1 -fmeta-data=/dev/vdb1       isize=256        agcount=4, agsize=6016 blks              =                           sectsz=512       attr=2, projid32bit=0data         =                           bsize=4096       blocks=24064, imaxpct=25             =                           sunit=0          swidth=0 blksnaming     =version 2           bsize=4096       ascii-ci=0log           =/dev/vdb2          bsize=4096       blocks=24576, version=2              =                           sectsz=512       sunit=0 blks, lazy-count=1realtime     =none                      extsz=4096       blocks=0, rtextents=0[root@node6 ~]# mount -o logdev=/dev/vdb2 /dev/vdb1 /xfs/[root@node6 ~]# pvcreate /dev/vdb1 /dev/vdb2 [root@node6 ~]# vgcreate vgxfs /dev/vdb2 /dev/vdb1[root@node6 ~]# lvcreate -l 25 -n lvxfs vgxfs  Logical volume &quot;lvxfs&quot; created[root@node6 ~]# mkfs.xfs /dev/vgxfs/lvxfs meta-data=/dev/vgxfs/lvxfs           isize=256        agcount=4, agsize=6400 blks              =                               sectsz=512       attr=2, projid32bit=0data          =                               bsize=4096       blocks=25600, imaxpct=25              =                               sunit=0          swidth=0 blksnaming     =version 2                  bsize=4096       ascii-ci=0log           =internal log               bsize=4096       blocks=1200, version=2              =                               sectsz=512       sunit=0 blks, lazy-count=1realtime =none                           extsz=4096       blocks=0, rtextents=0[root@node6 ~]# mount /dev/vgxfs/lvxfs /xfs/[root@node6 ~]# lvextend -l +100%FREE /dev/vgxfs/lvxfs [root@node6 ~]# xfs_growfs /xfs/meta-data=/dev/mapper/vgxfs-lvxfs     isize=256        agcount=4, agsize=6400 blks              =                                   sectsz=512       attr=2, projid32bit=0data          =                                   bsize=4096       blocks=25600, imaxpct=25                 =                                   sunit=0          swidth=0 blksnaming      =version 2                      bsize=4096       ascii-ci=0log          =internal                       bsize=4096      blocks=1200, version=2                =                                   sectsz=512       sunit=0 blks, lazy-count=1realtime     =none                               extsz=4096       blocks=0, rtextents=0data blocks changed from 25600 to 47104[root@node6 ~]# umount /xfs[root@node6 ~]# xfs_repair /dev/vgxfs/lvxfs [root@node6 ~]# mkfs.xfs -l logdev=/dev/vdb2 /dev/vdb1[root@node6 ~]# mount -o logdev=/dev/vdb2 /dev/vdb1 /xfs[root@node6 ~]# for FILE in file{0..3} ; do dd if=/dev/zero of=/xfs/${FILE} bs=4M count=100 &amp; done[root@node6 ~]# filefrag /xfs/file*[root@node6 ~]# xfs_fsr -v[root@node6 ~]# umount /xfs[root@node6 ~]# xfs_repair -n -l /dev/vdb2 /dev/vdb1 Phase 1 - find and verify superblock...Phase 2 - using external log on /dev/vdb2        - scan filesystem freespace and inode maps...        - found root inode chunkPhase 3 - for each AG...        - scan (but don&#39;t clear) agi unlinked lists...        - process known inodes and perform inode discovery...        - agno = 0        - agno = 1        - agno = 2        - agno = 3        - process newly discovered inodes...Phase 4 - check for duplicate blocks...        - setting up duplicate extent list...        - check for inodes claiming duplicate blocks...        - agno = 0        - agno = 1        - agno = 2        - agno = 3No modify flag set, skipping phase 5Phase 6 - check inode connectivity...        - traversing filesystem ...        - traversal finished ...        - moving disconnected inodes to lost+found ...Phase 7 - verify link counts...No modify flag set, skipping filesystem flush and exiting.[root@node6 ~]# [root@node6 ~]# xfs_repair -l /dev/vdb2 /dev/vdb1 Phase 1 - find and verify superblock...Phase 2 - using external log on /dev/vdb2        - zero log...        - scan filesystem freespace and inode maps...        - found root inode chunkPhase 3 - for each AG...        - scan and clear agi unlinked lists...        - process known inodes and perform inode discovery...        - agno = 0        - agno = 1        - agno = 2        - agno = 3        - process newly discovered inodes...Phase 4 - check for duplicate blocks...        - setting up duplicate extent list...        - check for inodes claiming duplicate blocks...        - agno = 0        - agno = 1        - agno = 2        - agno = 3Phase 5 - rebuild AG headers and trees...        - reset superblock...Phase 6 - check inode connectivity...        - resetting contents of realtime bitmap and summary inodes        - traversing filesystem ...        - traversal finished ...        - moving disconnected inodes to lost+found ...Phase 7 - verify and correct link counts...done[root@node6 ~]# mount -o logdev=/dev/vdb2 /dev/vdb1 /xfs[root@node6 ~]# yum install xfsdump[root@node6 ~]# xfsdump -L full -M dumpfile -l 0 - /xfs | xz &gt; /tmp/xfs.$(date +%Y%m%d).0.xzxfsdump: using file dump (drive_simple) strategyxfsdump: version 3.0.4 (dump format 3.0) - Running single-threadedxfsdump: level 0 dump of node6.uplooking.com:/xfsxfsdump: dump date: Sat Sep 14 17:39:47 2013xfsdump: session id: 75f91e6b-c0bc-4ad1-978b-e2ee5deb01d4xfsdump: session label: &quot;full&quot;xfsdump: ino map phase 1: constructing initial dump listxfsdump: ino map phase 2: skipping (no pruning necessary)xfsdump: ino map phase 3: skipping (only one dump stream)xfsdump: ino map construction completexfsdump: estimated dump size: 1677743680 bytesxfsdump: /var/lib/xfsdump/inventory createdxfsdump: creating dump session media file 0 (media 0, file 0)xfsdump: dumping ino mapxfsdump: dumping directoriesxfsdump: dumping non-directory filesxfsdump: ending media filexfsdump: media file size 1678152296 bytesxfsdump: dump size (non-dir files) : 1678101072 bytesxfsdump: dump complete: 152 seconds elapsedxfsdump: Dump Status: SUCCESS[root@node6 ~]# [root@node6 ~]# xfsdump -Ifile system 0:    fs id:        467c218c-22b5-45bc-9b0e-cd5782be6e2e    session 0:        mount point:    node6.uplooking.com:/xfs        device:        node6.uplooking.com:/dev/vdb1        time:        Sat Sep 14 17:39:47 2013        session label:    &quot;full&quot;        session id:    75f91e6b-c0bc-4ad1-978b-e2ee5deb01d4        level:        0        resumed:    NO        subtree:    NO        streams:    1        stream 0:            pathname:    stdio            start:        ino 131 offset 0            end:        ino 135 offset 0            interrupted:    NO            media files:    1            media file 0:                mfile index:    0                mfile type:    data                mfile size:    1678152296                mfile start:    ino 131 offset 0                mfile end:    ino 135 offset 0                media label:    &quot;dumpfile&quot;                media id:    de67b2b5-db72-4555-9804-a050829b2179xfsdump: Dump Status: SUCCESS[root@node6 ~]# rm -rf /xfs/*[root@node6 ~]# xzcat /tmp/xfs.20130914.0.xz | xfsrestore - /xfsxfsrestore: using file dump (drive_simple) strategyxfsrestore: version 3.0.4 (dump format 3.0) - Running single-threadedxfsrestore: searching media for dumpxfsrestore: examining media file 0xfsrestore: dump description: xfsrestore: hostname: node6.uplooking.comxfsrestore: mount point: /xfsxfsrestore: volume: /dev/vdb1xfsrestore: session time: Sat Sep 14 17:39:47 2013xfsrestore: level: 0xfsrestore: session label: &quot;full&quot;xfsrestore: media label: &quot;dumpfile&quot;xfsrestore: file system id: 467c218c-22b5-45bc-9b0e-cd5782be6e2exfsrestore: session id: 75f91e6b-c0bc-4ad1-978b-e2ee5deb01d4xfsrestore: media id: de67b2b5-db72-4555-9804-a050829b2179xfsrestore: searching media for directory dumpxfsrestore: reading directoriesxfsrestore: 1 directories and 4 entries processedxfsrestore: directory post-processingxfsrestore: restoring non-directory filesxfsrestore: restore complete: 33 seconds elapsedxfsrestore: Restore Status: SUCCESS[root@node6 ~]# ls /xfsfile0  file1  file2  file3</code></pre><h3 id="net"><a href="#net" class="headerlink" title="net"></a>net</h3><pre><code>ä¸€å°æœåŠ¡å™¨CPUå’Œå†…å­˜èµ„æºé¢å®šæœ‰é™çš„æƒ…å†µä¸‹ï¼Œå¦‚ä½•æé«˜æœåŠ¡å™¨çš„æ€§èƒ½æ˜¯ä½œä¸ºç³»ç»Ÿè¿ç»´çš„é‡è¦å·¥ä½œã€‚è¦æé«˜Linuxç³»ç»Ÿä¸‹çš„è´Ÿè½½èƒ½åŠ›ï¼Œå½“ç½‘ç«™å‘å±•èµ·æ¥ä¹‹åï¼Œwebè¿æ¥æ•°è¿‡å¤šçš„é—®é¢˜å°±ä¼šæ—¥ç›Šæ˜æ˜¾ã€‚åœ¨èŠ‚çœæˆæœ¬çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥è€ƒè™‘ä¿®æ”¹Linux çš„å†…æ ¸TCP/IPå‚æ•°æ¥éƒ¨åˆ†å®ç°ï¼›Linuxç³»ç»Ÿä¸‹ï¼ŒTCP/IPè¿æ¥æ–­å¼€åï¼Œä¼šä»¥TIME_WAITçŠ¶æ€ä¿ç•™ä¸€å®šçš„æ—¶é—´ï¼Œç„¶åæ‰ä¼šé‡Šæ”¾ç«¯å£ã€‚å½“å¹¶å‘è¯·æ±‚è¿‡å¤šçš„æ—¶å€™ï¼Œå°±ä¼šäº§ç”Ÿå¤§é‡çš„ TIME_WAITçŠ¶æ€çš„è¿æ¥ï¼Œæ— æ³•åŠæ—¶æ–­å¼€çš„è¯ï¼Œä¼šå ç”¨å¤§é‡çš„ç«¯å£èµ„æºå’ŒæœåŠ¡å™¨èµ„æº(å› ä¸ºå…³é—­åè¿›ç¨‹æ‰ä¼šé€€å‡º)ã€‚è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å¯ä»¥è€ƒè™‘ä¼˜åŒ–TCP/IP çš„å†…æ ¸å‚æ•°ï¼Œæ¥åŠæ—¶å°†TIME_WAITçŠ¶æ€çš„ç«¯å£æ¸…ç†æ‰ã€‚å†™åœ¨/etc/sysctl.confé‡Œ.å¼€è·¯ç”±çš„ä¹Ÿåœ¨è¿™é‡Œ.net.ipv4.tcp_syncookies = 1     è¡¨ç¤ºå¼€å¯SYN Cookiesã€‚å½“å‡ºç°SYNç­‰å¾…é˜Ÿåˆ—æº¢å‡ºæ—¶ï¼Œå¯ç”¨cookiesæ¥å¤„ç†ï¼Œå¯é˜²èŒƒå°‘é‡SYNæ”»å‡»ï¼Œé»˜è®¤ä¸º0ï¼Œè¡¨ç¤ºå…³é—­ï¼›net.ipv4.tcp_tw_reuse = 1     è¡¨ç¤ºå¼€å¯é‡ç”¨ã€‚å…è®¸å°†TIME-WAIT socketsé‡æ–°ç”¨äºæ–°çš„TCPè¿æ¥ï¼Œé»˜è®¤ä¸º0ï¼Œè¡¨ç¤ºå…³é—­ï¼›net.ipv4.tcp_tw_recycle = 1     è¡¨ç¤ºå¼€å¯TCPè¿æ¥ä¸­TIME-WAIT socketsçš„å¿«é€Ÿå›æ”¶ï¼Œé»˜è®¤ä¸º0ï¼Œè¡¨ç¤ºå…³é—­ï¼›net.ipv4.tcp_fin_timeout = 5  ä¿®æ”¹ç³»ç»Ÿé»˜è®¤çš„ TIMEOUT æ—¶é—´ã€‚net.ipv4.tcp_timestamps = 1 ä»¥ä¸€ç§æ¯”é‡å‘è¶…æ—¶æ›´ç²¾ç¡®çš„æ–¹æ³•ï¼ˆå‚é˜… RFC 1323ï¼‰æ¥å¯ç”¨å¯¹ RTT çš„è®¡ç®—ï¼›ä¸ºäº†å®ç°æ›´å¥½çš„æ€§èƒ½åº”è¯¥å¯ç”¨è¿™ä¸ªé€‰é¡¹net.ipv4.tcp_keepalive_time = 1200     è¡¨ç¤ºå½“keepaliveèµ·ç”¨çš„æ—¶å€™ï¼ŒTCPå‘é€keepaliveæ¶ˆæ¯çš„é¢‘åº¦ã€‚ç¼ºçœæ˜¯2å°æ—¶ï¼Œæ”¹ä¸º20åˆ†é’Ÿã€‚net.ipv4.ip_local_port_range = 10000     65000 è¡¨ç¤ºç”¨äºå‘å¤–è¿æ¥çš„ç«¯å£èŒƒå›´ã€‚ç¼ºçœæƒ…å†µä¸‹å¾ˆå°ï¼š32768åˆ°61000ï¼Œæ”¹ä¸º10000åˆ°65000ã€‚(æ³¨æ„ï¼šè¿™é‡Œä¸è¦å°†æœ€ä½å€¼è®¾çš„å¤ªä½ï¼Œå¦åˆ™å¯èƒ½ä¼šå ç”¨æ‰æ­£å¸¸çš„ç«¯å£ï¼)net.ipv4.tcp_max_syn_backlog = 8192 è¡¨ç¤ºSYNé˜Ÿåˆ—çš„é•¿åº¦ï¼Œé»˜è®¤ä¸º1024ï¼ŒåŠ å¤§é˜Ÿåˆ—é•¿åº¦ä¸º8192ï¼Œå¯ä»¥å®¹çº³æ›´å¤šç­‰å¾…è¿æ¥çš„ç½‘ç»œè¿æ¥æ•°ã€‚net.ipv4.tcp_max_tw_buckets = 5000 è¡¨ç¤ºç³»ç»ŸåŒæ—¶ä¿æŒTIME_WAITçš„æœ€å¤§æ•°é‡ï¼Œå¦‚æœè¶…è¿‡è¿™ä¸ªæ•°å­—ï¼ŒTIME_WAITå°†ç«‹åˆ»è¢«æ¸…é™¤å¹¶æ‰“å°è­¦å‘Šä¿¡æ¯ã€‚é»˜è®¤ä¸º180000ï¼Œæ”¹ä¸º5000ã€‚å¯¹äºApacheã€Nginxç­‰æœåŠ¡å™¨ï¼Œä¸Šå‡ è¡Œçš„å‚æ•°å¯ä»¥å¾ˆå¥½åœ°å‡å°‘TIME_WAITå¥—æ¥å­—æ•°é‡ã€‚</code></pre><h5 id="ç½‘å¡ç»‘å®š"><a href="#ç½‘å¡ç»‘å®š" class="headerlink" title="ç½‘å¡ç»‘å®š"></a>ç½‘å¡ç»‘å®š</h5><pre><code>ç½‘å¡ç»‘å®šç½‘å¡ç»‘å®šçš„åˆ†ç±» æ¨¡å¼ 7ä¸­Ethernet Channel Bonding    LinuxåŒç½‘å¡ç»‘å®šçš„å®ç°æ˜¯ä½¿ç”¨ä¸¤å—ç½‘å¡è™šæ‹Ÿæˆä¸ºä¸€å—ç½‘å¡ï¼Œè¿™ä¸ªèšåˆèµ·æ¥çš„è®¾å¤‡çœ‹èµ·æ¥æ˜¯ä¸€ä¸ªå•ç‹¬çš„ä»¥å¤ªç½‘æ¥å£è®¾å¤‡ï¼Œé€šä¿—ç‚¹è®²å°±æ˜¯ä¸¤å—ç½‘å¡å…·æœ‰ç›¸åŒçš„IPåœ°å€è€Œå¹¶è¡Œé“¾æ¥èšåˆæˆä¸€ä¸ªé€»è¾‘é“¾è·¯å·¥ä½œã€‚å…¶å®è¿™é¡¹æŠ€æœ¯åœ¨Sunå’ŒCiscoä¸­æ—©å·²å­˜åœ¨ï¼Œè¢«ç§°ä¸ºTrunkingå’ŒEtherchannelæŠ€æœ¯ï¼Œåœ¨Linuxçš„2.4.xä»¥ä¸Šå†…æ ¸ä¸­ä¹Ÿé‡‡ç”¨è¿™è¿™ç§æŠ€æœ¯ï¼Œè¢«ç§°ä¸ºbondingã€‚bondingæŠ€æœ¯çš„æœ€æ—©åº”ç”¨æ˜¯åœ¨é›†ç¾¤ï¼Œä¸ºäº†æé«˜é›†ç¾¤èŠ‚ç‚¹é—´çš„æ•°æ®ä¼ è¾“è€Œè®¾è®¡çš„ã€‚bondingçš„é…ç½®æ–¹å¼æ–‡æ¡£    [root@localhost ~]# rpm -q kernel-doc    /usr/share/doc/kernel-doc-2.6.18/Documentation/networking/bonding.txtç³»ç»Ÿæ˜¯å¦æ”¯æŒbonding    # modinfo bonding    å¦‚æœæ²¡æœ‰è¿”å›æ¶ˆæ¯ï¼Œè¯´æ˜ä¸æ”¯æŒéœ€è¦é‡æ–°ç¼–è¯‘å†…æ ¸æ£€æŸ¥ifenslave     #which ifenslave     /sbin/ifenslave    åˆ†åˆ«ä¿®æ”¹2ä¸ªç½‘å¡é…ç½®æ–‡ä»¶ï¼Œå£°æ˜è‡ªå·±ä¸ºslaveï¼Œmasteræ˜¯bond0    [root@localhost ~]# vim /etc/sysconfig/network-scripts/ifcfg-eth0    ï¼ï¼ï¼    DEVICE=eth0    USERCTL=no    ONBOOT=yes    BOOTPROTO=none    MASTER=bond0    SLAVE=yesï¼ï¼ï¼ç”Ÿæˆmasterè®¾å¤‡çš„é…ç½®æ–‡ä»¶    [root@localhost ~]# vim /etc/sysconfig/network-scripts/ifcfg-bond0    -----------    DEVICE=bond0    IPADDR=192.168.122.254    NETMASK=255.255.255.0    ONBOOT=yes    BOOTPROTO=none    USERCTL=no-----------bond0æ˜¯ä»€ä¹ˆè®¾å¤‡ï¼Ÿå®é™…æˆ‘ä»¬åšçš„ç½‘å¡ç»‘å®šï¼Œæ˜¯é€šè¿‡bondingæ¨¡å—æ¥å®ç°çš„ï¼Œæ‰€ä»¥è¦bondingæ¨¡å—è®¾ç½®ä¸€ä¸ªåˆ«åï¼ŒæŒ‡å‘æˆ‘ä»¬åˆ›å»ºçš„bond0[root@localhost ~]# vim /etc/modprobe.conf  ï¼ï¼ï¼alias bond0 bondingoptions bonding miimon=100 mode=balance-rroptions bond0 miimon=100 mode=1 primary=eth0   //æ¨¡å¼ä¸º1çš„æ—¶å€™ä½¿ç”¨è¿™è¡Œé…ç½®RHEL6ä¸‹ä¸å†æœ‰modprobe.confè¿™ä¸ªæ–‡ä»¶    åœ¨/etc/modprobe.d/é‡Œå»ºç«‹bond0.conf    # cat /etc/modprobe.d/bond0.conf       alias bond0 bondingï¼ï¼ï¼miimonæ˜¯ç”¨æ¥è¿›è¡Œé“¾è·¯ç›‘æµ‹çš„ã€‚ æ¯”å¦‚:miimon=100ï¼Œé‚£ä¹ˆç³»ç»Ÿæ¯100msç›‘æµ‹ä¸€æ¬¡é“¾è·¯è¿æ¥çŠ¶æ€ï¼Œå¦‚æœæœ‰ä¸€æ¡çº¿è·¯ä¸é€šå°±è½¬å…¥å¦ä¸€æ¡çº¿è·¯ï¼›modeçš„å€¼è¡¨ç¤ºå·¥ä½œæ¨¡å¼ï¼Œä»–å…±æœ‰0ï¼Œ1,2,3å››ç§æ¨¡å¼ï¼Œå¸¸ç”¨çš„ä¸º0,1ä¸¤ç§ã€‚    mode=0è¡¨ç¤ºload balancing (round-robin)ä¸ºè´Ÿè½½å‡è¡¡æ–¹å¼ï¼Œä¸¤å—ç½‘å¡éƒ½å·¥ä½œã€‚    mode=1è¡¨ç¤ºfault-tolerance (active-backup)æä¾›å†—ä½™åŠŸèƒ½ï¼Œå·¥ä½œæ–¹å¼æ˜¯ä¸»å¤‡çš„å·¥ä½œæ–¹å¼,ä¹Ÿå°±æ˜¯è¯´é»˜è®¤æƒ…å†µä¸‹åªæœ‰ä¸€å—ç½‘å¡å·¥ä½œ,å¦ä¸€å—åšå¤‡ä»½.é‡å¯æœåŠ¡ï¼Œå¦‚æœä¸ç”Ÿæ•ˆéœ€è¦é‡å¯ç³»ç»Ÿï¼š    [root@localhost ~]# service network restartéªŒè¯bond0æ˜¯å¦æˆåŠŸï¼š    [root@localhost ~]# cat /proc/net/bonding/bond0===================================rhel6    DEVICE=bond0    IPADDR=192.168.0.253    NETMASK=255.255.255.0    ONBOOT=yes    NM_CONTROLLED=no    BOOTPROTO=none    USERCTL=no    BONDING_OPTS=&quot;miimon=50 mode=0&quot;    å»ºç«‹bonding.conf      #cat  /etc/modprobe.d/bond.conf       alias bond0 bonding       åœ¨/etc/rc.localæ–‡ä»¶æœ«å°¾åŠ å…¥å¦‚ä¸‹å†…å®¹     #vi /etc/rc.local      ifenslave bond0 eth0 eth2</code></pre><h3 id="èµ„æºæ§åˆ¶"><a href="#èµ„æºæ§åˆ¶" class="headerlink" title="èµ„æºæ§åˆ¶"></a>èµ„æºæ§åˆ¶</h3><h5 id="ulimit"><a href="#ulimit" class="headerlink" title="ulimit"></a>ulimit</h5><pre><code>ç³»ç»Ÿæ€§èƒ½ä¸€ç›´æ˜¯ä¸€ä¸ªå—å…³æ³¨çš„è¯é¢˜ï¼Œå¦‚ä½•é€šè¿‡æœ€ç®€å•çš„è®¾ç½®æ¥å®ç°æœ€æœ‰æ•ˆçš„æ€§èƒ½è°ƒä¼˜ï¼Œå¦‚ä½•åœ¨æœ‰é™èµ„æºçš„æ¡ä»¶ä¸‹ä¿è¯ç¨‹åºçš„è¿ä½œï¼Œulimit æ˜¯æˆ‘ä»¬åœ¨å¤„ç†è¿™äº›é—®é¢˜æ—¶ï¼Œç»å¸¸ä½¿ç”¨çš„ä¸€ç§ç®€å•æ‰‹æ®µã€‚ulimit æ˜¯ä¸€ç§ linux ç³»ç»Ÿçš„å†…é”®åŠŸèƒ½ï¼Œå®ƒå…·æœ‰ä¸€å¥—å‚æ•°é›†ï¼Œç”¨äºä¸ºç”±å®ƒç”Ÿæˆçš„ shell è¿›ç¨‹åŠå…¶å­è¿›ç¨‹çš„èµ„æºä½¿ç”¨è®¾ç½®é™åˆ¶ã€‚ulimit åŠŸèƒ½ç®€è¿°å‡è®¾æœ‰è¿™æ ·ä¸€ç§æƒ…å†µï¼Œå½“ä¸€å° Linux ä¸»æœºä¸ŠåŒæ—¶ç™»é™†äº† 10 ä¸ªäººï¼Œåœ¨ç³»ç»Ÿèµ„æºæ— é™åˆ¶çš„æƒ…å†µä¸‹ï¼Œè¿™ 10 ä¸ªç”¨æˆ·åŒæ—¶æ‰“å¼€äº† 500 ä¸ªæ–‡æ¡£ï¼Œè€Œå‡è®¾æ¯ä¸ªæ–‡æ¡£çš„å¤§å°æœ‰ 10Mï¼Œè¿™æ—¶ç³»ç»Ÿçš„å†…å­˜èµ„æºå°±ä¼šå—åˆ°å·¨å¤§çš„æŒ‘æˆ˜ã€‚è€Œå®é™…åº”ç”¨çš„ç¯å¢ƒè¦æ¯”è¿™ç§å‡è®¾å¤æ‚çš„å¤šï¼Œä¾‹å¦‚åœ¨ä¸€ä¸ªåµŒå…¥å¼å¼€å‘ç¯å¢ƒä¸­,å„æ–¹é¢çš„èµ„æºéƒ½æ˜¯éå¸¸ç´§ç¼ºçš„ï¼Œå¯¹äºå¼€å¯æ–‡ä»¶æè¿°ç¬¦çš„æ•°é‡ï¼Œåˆ†é…å †æ ˆçš„å¤§å°ï¼ŒCPU æ—¶é—´ï¼Œè™šæ‹Ÿå†…å­˜å¤§å°ï¼Œç­‰ç­‰ï¼Œéƒ½æœ‰éå¸¸ä¸¥æ ¼çš„è¦æ±‚ã€‚èµ„æºçš„åˆç†é™åˆ¶å’Œåˆ†é…ï¼Œä¸ä»…ä»…æ˜¯ä¿è¯ç³»ç»Ÿå¯ç”¨æ€§çš„å¿…è¦æ¡ä»¶ï¼Œä¹Ÿä¸ç³»ç»Ÿä¸Šè½¯ä»¶è¿è¡Œçš„æ€§èƒ½æœ‰ç€å¯†ä¸å¯åˆ†çš„è”ç³»ã€‚è¿™æ—¶ï¼Œulimit å¯ä»¥èµ·åˆ°å¾ˆå¤§çš„ä½œç”¨ï¼Œå®ƒæ˜¯ä¸€ç§ç®€å•å¹¶ä¸”æœ‰æ•ˆçš„å®ç°èµ„æºé™åˆ¶çš„æ–¹å¼ã€‚ulimit ç”¨äºé™åˆ¶ shell å¯åŠ¨è¿›ç¨‹æ‰€å ç”¨çš„èµ„æºï¼Œæ”¯æŒä»¥ä¸‹å„ç§ç±»å‹çš„é™åˆ¶ï¼šæ‰€åˆ›å»ºçš„å†…æ ¸æ–‡ä»¶çš„å¤§å°ã€è¿›ç¨‹æ•°æ®å—çš„å¤§å°ã€Shell è¿›ç¨‹åˆ›å»ºæ–‡ä»¶çš„å¤§å°ã€å†…å­˜é”ä½çš„å¤§å°ã€å¸¸é©»å†…å­˜é›†çš„å¤§å°ã€æ‰“å¼€æ–‡ä»¶æè¿°ç¬¦çš„æ•°é‡ã€åˆ†é…å †æ ˆçš„æœ€å¤§å¤§å°ã€CPU æ—¶é—´ã€å•ä¸ªç”¨æˆ·çš„æœ€å¤§çº¿ç¨‹æ•°ã€Shell è¿›ç¨‹æ‰€èƒ½ä½¿ç”¨çš„æœ€å¤§è™šæ‹Ÿå†…å­˜ã€‚åŒæ—¶ï¼Œå®ƒæ”¯æŒç¡¬èµ„æºå’Œè½¯èµ„æºçš„é™åˆ¶ã€‚ä½œä¸ºä¸´æ—¶é™åˆ¶ï¼Œulimit å¯ä»¥ä½œç”¨äºé€šè¿‡ä½¿ç”¨å…¶å‘½ä»¤ç™»å½•çš„ shell ä¼šè¯ï¼Œåœ¨ä¼šè¯ç»ˆæ­¢æ—¶ä¾¿ç»“æŸé™åˆ¶ï¼Œå¹¶ä¸å½±å“äºå…¶ä»– shell ä¼šè¯ã€‚è€Œå¯¹äºé•¿æœŸçš„å›ºå®šé™åˆ¶ï¼Œulimit å‘½ä»¤è¯­å¥åˆå¯ä»¥è¢«æ·»åŠ åˆ°ç”±ç™»å½• shell è¯»å–çš„æ–‡ä»¶ä¸­ï¼Œä½œç”¨äºç‰¹å®šçš„ shell ç”¨æˆ·ã€‚[root@localhost Desktop]# ulimit  -acore file size                  (blocks, -c)     0            #æœ€å¤§çš„ core æ–‡ä»¶çš„å¤§å°ï¼Œ ä»¥ blocks ä¸ºå•ä½coreæ–‡ä»¶çš„ç®€å•ä»‹ç»åœ¨ä¸€ä¸ªç¨‹åºå´©æºƒæ—¶ï¼Œå®ƒä¸€èˆ¬ä¼šåœ¨æŒ‡å®šç›®å½•ä¸‹ç”Ÿæˆä¸€ä¸ªcoreæ–‡ä»¶ã€‚coreæ–‡ä»¶ä»…ä»…æ˜¯ä¸€ä¸ªå†…å­˜æ˜ è±¡(åŒæ—¶åŠ ä¸Šè°ƒè¯•ä¿¡æ¯)ï¼Œä¸»è¦æ˜¯ç”¨æ¥è°ƒè¯•çš„ã€‚ data seg size               (kbytes, -d)     unlimited    #è¿›ç¨‹æœ€å¤§çš„æ•°æ®æ®µçš„å¤§å°ï¼Œä»¥ Kbytes ä¸ºå•ä½ã€‚scheduling priority            (-e)             0file size                       (blocks, -f)     unlimited    #è¿›ç¨‹å¯ä»¥åˆ›å»ºæ–‡ä»¶çš„æœ€å¤§å€¼ï¼Œä»¥ blocks ä¸ºå•ä½ã€‚pending signals                 (-i)             59335        max locked memory        (kbytes, -l)     64            #æœ€å¤§å¯åŠ é”å†…å­˜å¤§å°ï¼Œä»¥ Kbytes ä¸ºå•ä½ã€‚max memory size             (kbytes, -m)     unlimited    #æœ€å¤§å†…å­˜å¤§å°ï¼Œä»¥ Kbytes ä¸ºå•ä½open files                          (-n)             1024        #å¯ä»¥æ‰“å¼€æœ€å¤§æ–‡ä»¶æè¿°ç¬¦çš„æ•°é‡ã€‚pipe size                    (512 bytes, -p) 8            #ç®¡é“ç¼“å†²åŒºçš„å¤§å°ï¼Œä»¥ 512byte/ä¸ª ä¸ºå•ä½ã€‚POSIX message queues    (bytes, -q)     819200        real-time priority               (-r)             0stack size                      (kbytes, -s)     10240        #å †æ ˆå¤§å°ï¼Œä»¥ Kbytes ä¸ºå•ä½ã€‚cpu time                       (seconds, -t)     unlimited    #æœ€å¤§çš„ CPU å ç”¨æ—¶é—´ï¼Œä»¥ç§’ä¸ºå•ä½ã€‚max user processes         (-u)             59335        #ç”¨æˆ·æœ€å¤§å¯ç”¨çš„è¿›ç¨‹æ•°ã€‚virtual memory              (kbytes, -v)     unlimited    #è¿›ç¨‹æœ€å¤§å¯ç”¨çš„è™šæ‹Ÿå†…å­˜ï¼Œä»¥ Kbytes ä¸ºå•ä½ã€‚file locks                          (-x)             unlimited-a     æ˜¾ç¤ºå½“å‰æ‰€æœ‰çš„ limit ä¿¡æ¯ã€‚-H     è®¾ç½®ç¡¬èµ„æºé™åˆ¶ï¼Œä¸€æ—¦è®¾ç½®ä¸èƒ½å¢åŠ ã€‚     ulimit  Hs 64ï¼›é™åˆ¶ç¡¬èµ„æºï¼Œçº¿ç¨‹æ ˆå¤§å°ä¸º 64Kã€‚-S     è®¾ç½®è½¯èµ„æºé™åˆ¶ï¼Œè®¾ç½®åå¯ä»¥å¢åŠ ï¼Œä½†æ˜¯ä¸èƒ½è¶…è¿‡ç¡¬èµ„æºè®¾ç½®ã€‚     ulimit  Sn 32ï¼›é™åˆ¶è½¯èµ„æºï¼Œ32 ä¸ªæ–‡ä»¶æè¿°ç¬¦ã€‚é™åˆ¶ä½¿ç”¨CPUæ—¶é—´[root@localhost ~]# vim /tmp/a.sh #!/bin/bashwhile  truedo    :done[root@localhost ~]# ulimit -t 20[root@localhost ~]# ulimit -a | grep &quot;cpu time&quot;cpu time               (seconds, -t) 20[root@localhost ~]# /tmp/a.sh Killedé™åˆ¶ç”¨æˆ·ä½¿ç”¨çš„è™šæ‹Ÿå†…å­˜[root@localhost ~]# ulimit -v 0[root@localhost ~]# lsKilled[root@localhost ~]# df Killed[root@localhost ~]# psKilled[root@localhost ~]# cd /etc[root@localhost etc]# echo 111111[root@localhost etc]# type cdcd is a shell builtin[root@localhost etc]# type echoecho is a shell builtiné™åˆ¶åˆ›å»ºæ–‡ä»¶å¤§å°[root@node5 ~]# ulimit -f 1000[root@node5 ~]# dd if=/dev/zero of=file1 bs=1024 count=1001File size limit exceeded (core dumped)[root@node5 ~]# dd if=/dev/zero of=file1 bs=1024 count=900900+0 records in900+0 records out921600 bytes (922 kB) copied, 0.0031932 s, 289 MB/sç³»ç»Ÿæ€§èƒ½ä¸€ç›´æ˜¯ä¸€ä¸ªå—å…³æ³¨çš„è¯é¢˜ï¼Œå¦‚ä½•é€šè¿‡æœ€ç®€å•çš„è®¾ç½®æ¥å®ç°æœ€æœ‰æ•ˆçš„æ€§èƒ½è°ƒä¼˜ï¼Œå¦‚ä½•åœ¨æœ‰é™èµ„æºçš„æ¡ä»¶ä¸‹ä¿è¯ç¨‹åºçš„è¿ä½œï¼Œulimit æ˜¯æˆ‘ä»¬åœ¨å¤„ç†è¿™äº›é—®é¢˜æ—¶ï¼Œç»å¸¸ä½¿ç”¨çš„ä¸€ç§ç®€å•æ‰‹æ®µã€‚ulimit æ˜¯ä¸€ç§ linux ç³»ç»Ÿçš„å†…é”®åŠŸèƒ½ï¼Œå®ƒå…·æœ‰ä¸€å¥—å‚æ•°é›†ï¼Œç”¨äºä¸ºç”±å®ƒç”Ÿæˆçš„ shell è¿›ç¨‹åŠå…¶å­è¿›ç¨‹çš„èµ„æºä½¿ç”¨è®¾ç½®é™åˆ¶ã€‚ulimit åŠŸèƒ½ç®€è¿°å‡è®¾æœ‰è¿™æ ·ä¸€ç§æƒ…å†µï¼Œå½“ä¸€å° Linux ä¸»æœºä¸ŠåŒæ—¶ç™»é™†äº† 10 ä¸ªäººï¼Œåœ¨ç³»ç»Ÿèµ„æºæ— é™åˆ¶çš„æƒ…å†µä¸‹ï¼Œè¿™ 10 ä¸ªç”¨æˆ·åŒæ—¶æ‰“å¼€äº† 500 ä¸ªæ–‡æ¡£ï¼Œè€Œå‡è®¾æ¯ä¸ªæ–‡æ¡£çš„å¤§å°æœ‰ 10Mï¼Œè¿™æ—¶ç³»ç»Ÿçš„å†…å­˜èµ„æºå°±ä¼šå—åˆ°å·¨å¤§çš„æŒ‘æˆ˜ã€‚è€Œå®é™…åº”ç”¨çš„ç¯å¢ƒè¦æ¯”è¿™ç§å‡è®¾å¤æ‚çš„å¤šï¼Œä¾‹å¦‚åœ¨ä¸€ä¸ªåµŒå…¥å¼å¼€å‘ç¯å¢ƒä¸­,å„æ–¹é¢çš„èµ„æºéƒ½æ˜¯éå¸¸ç´§ç¼ºçš„ï¼Œå¯¹äºå¼€å¯æ–‡ä»¶æè¿°ç¬¦çš„æ•°é‡ï¼Œåˆ†é…å †æ ˆçš„å¤§å°ï¼ŒCPU æ—¶é—´ï¼Œè™šæ‹Ÿå†…å­˜å¤§å°ï¼Œç­‰ç­‰ï¼Œéƒ½æœ‰éå¸¸ä¸¥æ ¼çš„è¦æ±‚ã€‚èµ„æºçš„åˆç†é™åˆ¶å’Œåˆ†é…ï¼Œä¸ä»…ä»…æ˜¯ä¿è¯ç³»ç»Ÿå¯ç”¨æ€§çš„å¿…è¦æ¡ä»¶ï¼Œä¹Ÿä¸ç³»ç»Ÿä¸Šè½¯ä»¶è¿è¡Œçš„æ€§èƒ½æœ‰ç€å¯†ä¸å¯åˆ†çš„è”ç³»ã€‚è¿™æ—¶ï¼Œulimit å¯ä»¥èµ·åˆ°å¾ˆå¤§çš„ä½œç”¨ï¼Œå®ƒæ˜¯ä¸€ç§ç®€å•å¹¶ä¸”æœ‰æ•ˆçš„å®ç°èµ„æºé™åˆ¶çš„æ–¹å¼ã€‚ulimit ç”¨äºé™åˆ¶ shell å¯åŠ¨è¿›ç¨‹æ‰€å ç”¨çš„èµ„æºï¼Œæ”¯æŒä»¥ä¸‹å„ç§ç±»å‹çš„é™åˆ¶ï¼šæ‰€åˆ›å»ºçš„å†…æ ¸æ–‡ä»¶çš„å¤§å°ã€è¿›ç¨‹æ•°æ®å—çš„å¤§å°ã€Shell è¿›ç¨‹åˆ›å»ºæ–‡ä»¶çš„å¤§å°ã€å†…å­˜é”ä½çš„å¤§å°ã€å¸¸é©»å†…å­˜é›†çš„å¤§å°ã€æ‰“å¼€æ–‡ä»¶æè¿°ç¬¦çš„æ•°é‡ã€åˆ†é…å †æ ˆçš„æœ€å¤§å¤§å°ã€CPU æ—¶é—´ã€å•ä¸ªç”¨æˆ·çš„æœ€å¤§çº¿ç¨‹æ•°ã€Shell è¿›ç¨‹æ‰€èƒ½ä½¿ç”¨çš„æœ€å¤§è™šæ‹Ÿå†…å­˜ã€‚åŒæ—¶ï¼Œå®ƒæ”¯æŒç¡¬èµ„æºå’Œè½¯èµ„æºçš„é™åˆ¶ã€‚ä½œä¸ºä¸´æ—¶é™åˆ¶ï¼Œulimit å¯ä»¥ä½œç”¨äºé€šè¿‡ä½¿ç”¨å…¶å‘½ä»¤ç™»å½•çš„ shell ä¼šè¯ï¼Œåœ¨ä¼šè¯ç»ˆæ­¢æ—¶ä¾¿ç»“æŸé™åˆ¶ï¼Œå¹¶ä¸å½±å“äºå…¶ä»– shell ä¼šè¯ã€‚è€Œå¯¹äºé•¿æœŸçš„å›ºå®šé™åˆ¶ï¼Œulimit å‘½ä»¤è¯­å¥åˆå¯ä»¥è¢«æ·»åŠ åˆ°ç”±ç™»å½• shell è¯»å–çš„æ–‡ä»¶ä¸­ï¼Œä½œç”¨äºç‰¹å®šçš„ shell ç”¨æˆ·ã€‚[root@localhost Desktop]# ulimit  -acore file size                  (blocks, -c)     0            #æœ€å¤§çš„ core æ–‡ä»¶çš„å¤§å°ï¼Œ ä»¥ blocks ä¸ºå•ä½coreæ–‡ä»¶çš„ç®€å•ä»‹ç»åœ¨ä¸€ä¸ªç¨‹åºå´©æºƒæ—¶ï¼Œå®ƒä¸€èˆ¬ä¼šåœ¨æŒ‡å®šç›®å½•ä¸‹ç”Ÿæˆä¸€ä¸ªcoreæ–‡ä»¶ã€‚coreæ–‡ä»¶ä»…ä»…æ˜¯ä¸€ä¸ªå†…å­˜æ˜ è±¡(åŒæ—¶åŠ ä¸Šè°ƒè¯•ä¿¡æ¯)ï¼Œä¸»è¦æ˜¯ç”¨æ¥è°ƒè¯•çš„ã€‚ data seg size               (kbytes, -d)     unlimited    #è¿›ç¨‹æœ€å¤§çš„æ•°æ®æ®µçš„å¤§å°ï¼Œä»¥ Kbytes ä¸ºå•ä½ã€‚scheduling priority            (-e)             0file size                       (blocks, -f)     unlimited    #è¿›ç¨‹å¯ä»¥åˆ›å»ºæ–‡ä»¶çš„æœ€å¤§å€¼ï¼Œä»¥ blocks ä¸ºå•ä½ã€‚pending signals                 (-i)             59335        max locked memory        (kbytes, -l)     64            #æœ€å¤§å¯åŠ é”å†…å­˜å¤§å°ï¼Œä»¥ Kbytes ä¸ºå•ä½ã€‚max memory size             (kbytes, -m)     unlimited    #æœ€å¤§å†…å­˜å¤§å°ï¼Œä»¥ Kbytes ä¸ºå•ä½open files                          (-n)             1024        #å¯ä»¥æ‰“å¼€æœ€å¤§æ–‡ä»¶æè¿°ç¬¦çš„æ•°é‡ã€‚pipe size                    (512 bytes, -p) 8            #ç®¡é“ç¼“å†²åŒºçš„å¤§å°ï¼Œä»¥ 512byte/ä¸ª ä¸ºå•ä½ã€‚POSIX message queues    (bytes, -q)     819200        real-time priority               (-r)             0stack size                      (kbytes, -s)     10240        #å †æ ˆå¤§å°ï¼Œä»¥ Kbytes ä¸ºå•ä½ã€‚cpu time                       (seconds, -t)     unlimited    #æœ€å¤§çš„ CPU å ç”¨æ—¶é—´ï¼Œä»¥ç§’ä¸ºå•ä½ã€‚max user processes         (-u)             59335        #ç”¨æˆ·æœ€å¤§å¯ç”¨çš„è¿›ç¨‹æ•°ã€‚virtual memory              (kbytes, -v)     unlimited    #è¿›ç¨‹æœ€å¤§å¯ç”¨çš„è™šæ‹Ÿå†…å­˜ï¼Œä»¥ Kbytes ä¸ºå•ä½ã€‚file locks                          (-x)             unlimited-a     æ˜¾ç¤ºå½“å‰æ‰€æœ‰çš„ limit ä¿¡æ¯ã€‚-H     è®¾ç½®ç¡¬èµ„æºé™åˆ¶ï¼Œä¸€æ—¦è®¾ç½®ä¸èƒ½å¢åŠ ã€‚     ulimit  Hs 64ï¼›é™åˆ¶ç¡¬èµ„æºï¼Œçº¿ç¨‹æ ˆå¤§å°ä¸º 64Kã€‚-S     è®¾ç½®è½¯èµ„æºé™åˆ¶ï¼Œè®¾ç½®åå¯ä»¥å¢åŠ ï¼Œä½†æ˜¯ä¸èƒ½è¶…è¿‡ç¡¬èµ„æºè®¾ç½®ã€‚     ulimit  Sn 32ï¼›é™åˆ¶è½¯èµ„æºï¼Œ32 ä¸ªæ–‡ä»¶æè¿°ç¬¦ã€‚é™åˆ¶ä½¿ç”¨CPUæ—¶é—´[root@localhost ~]# vim /tmp/a.sh #!/bin/bashwhile  truedo    :done[root@localhost ~]# ulimit -t 20[root@localhost ~]# ulimit -a | grep &quot;cpu time&quot;cpu time               (seconds, -t) 20[root@localhost ~]# /tmp/a.sh Killedé™åˆ¶ç”¨æˆ·ä½¿ç”¨çš„è™šæ‹Ÿå†…å­˜[root@localhost ~]# ulimit -v 0[root@localhost ~]# lsKilled[root@localhost ~]# df Killed[root@localhost ~]# psKilled[root@localhost ~]# cd /etc[root@localhost etc]# echo 111111[root@localhost etc]# type cdcd is a shell builtin[root@localhost etc]# type echoecho is a shell builtiné™åˆ¶åˆ›å»ºæ–‡ä»¶å¤§å°[root@node5 ~]# ulimit -f 1000[root@node5 ~]# dd if=/dev/zero of=file1 bs=1024 count=1001File size limit exceeded (core dumped)[root@node5 ~]# dd if=/dev/zero of=file1 bs=1024 count=900900+0 records in900+0 records out921600 bytes (922 kB) copied, 0.0031932 s, 289 MB/s</code></pre><h5 id="pam-limit-so"><a href="#pam-limit-so" class="headerlink" title="pam_limit.so"></a>pam_limit.so</h5><pre><code>pam_limits èµ„æºé™åˆ¶æ¨¡å—ï¼ˆæä¾›çš„ç®¡ç†ç»„:sessionï¼‰pam æ’å…¥å¼éªŒè¯æ¨¡å—ä¸ºä½¿ç”¨æ­¤æ¨¡å—, ç³»ç»Ÿç®¡ç†å‘˜å¿…é¡»é¦–å…ˆå»ºç«‹ä¸€ä¸ª rootåªè¯» çš„æ–‡ä»¶(é»˜è®¤æ˜¯ /etc/security/limits.conf). è¿™æ–‡ä»¶æè¿°äº†superuseræƒ³å¼ºè¿«ç”¨æˆ·å’Œç”¨æˆ·ç»„çš„èµ„æºé™åˆ¶. uid=0çš„å¸å·ä¸ä¼šå—é™åˆ¶.ä»¥ä¸‹å‚æ•°å¯ä»¥ç”¨æ¥æ”¹å˜æ­¤æ¨¡å—çš„è¡Œä¸º:    * debug - å¾€syslog(3)å†™å…¥å†—é•¿çš„è®°å½•.    * conf=/path/to/file.conf - æŒ‡å®šä¸€ä¸ªæ›¿æ¢çš„limitsè®¾å®šæ¡£.è®¾å®šæ¡£çš„æ¯ä¸€è¡Œæè¿°äº†ä¸€ä¸ªç”¨æˆ·çš„é™åˆ¶,ä»¥ä¸‹é¢çš„æ ¼å¼:&lt;domain&gt; &lt;type&gt; &lt;item&gt; &lt;value&gt;ä¸Šé¢åˆ—å‡ºçš„æ ä½å¯ä»¥å¡«ä¸‹é¢çš„å€¼:...&lt;domain&gt; å¯ä»¥æ˜¯:    * ä¸€ä¸ªç”¨æˆ·å    * ä¸€ä¸ªç»„å,è¯­æ³•æ˜¯@group    * é€šé…ç¬¦*, å®šä¹‰é»˜è®¤æ¡ç›®&lt;type&gt; å¯ä»¥æœ‰ä¸€ä¸‹ä¸¤ä¸ªå€¼:    * hard ä¸ºæ–½è¡Œç¡¬ èµ„æºé™åˆ¶. è¿™äº›é™åˆ¶ç”±superuserè®¾å®š,ç”±Linuxå†…æ ¸æ–½è¡Œ. ç”¨æˆ·ä¸èƒ½æå‡ä»–å¯¹èµ„æºçš„éœ€æ±‚åˆ°å¤§äºæ­¤å€¼.    * soft ä¸ºæ–½è¡Œè½¯ èµ„æºé™åˆ¶. ç”¨æˆ·çš„é™åˆ¶èƒ½åœ¨è½¯ç¡¬é™åˆ¶ä¹‹é—´ä¸Šä¸‹æµ®åŠ¨. è¿™ç§é™åˆ¶åœ¨æ™®é€šç”¨æ³•ä¸‹å¯ä»¥çœ‹æˆæ˜¯é»˜è®¤å€¼.&lt;item&gt; å¯ä»¥æ˜¯ä»¥ä¸‹ä¹‹ä¸€:    * core - é™åˆ¶coreæ–‡ä»¶çš„å¤§å°(KB)    * data - æœ€å¤§çš„èµ„æ–™å¤§å° (KB)    * fsize - æœ€å¤§çš„æ–‡ä»¶å°ºå¯¸ (KB)    * memlock - æœ€å¤§èƒ½é”å®šçš„å†…å­˜ç©ºé—´(KB)    * nofile - æœ€å¤šèƒ½æ‰“å¼€çš„æ–‡ä»¶    * rss - æœ€å¤§çš„é©»ç•™ç¨‹åºå¤§å°(KB)    * stack - æœ€å¤§çš„å †æ ˆå°ºå¯¸(KB)    * cpu - æœ€å¤§çš„CPU æ—¶é—´(åˆ†é’Ÿ)    * nproc - æœ€å¤šçš„è¿›ç¨‹æ•°    * as - åœ°å€ç©ºé—´çš„é™åˆ¶    * maxlogins - ç”¨æˆ·çš„æœ€å¤šç™»å½•æ•°    * priority - ç”¨æˆ·è¿›ç¨‹æ‰§è¡Œæ—¶çš„ä¼˜å…ˆçº§è¦å®Œå…¨ä¸é™åˆ¶ç”¨æˆ·(æˆ–ç»„), å¯ä»¥ç”¨ä¸€ä¸ª(-)(ä¾‹å¦‚: ``bin -&#39;&#39;, ``@admin -&#39;&#39;). æ³¨æ„,ä¸ªä½“çš„é™åˆ¶æ¯”ç»„é™åˆ¶çš„ä¼˜å…ˆçº§é«˜, æ‰€ä»¥å¦‚æœä½ è®¾å®šadminç»„ä¸å—é™åˆ¶, ä½†æ˜¯ç»„ä¸­çš„æŸä¸ªæˆå‘˜è¢«è®¾å®šæ¡£ä¸­æŸè¡Œé™åˆ¶, é‚£ä¹ˆæ­¤ç”¨æˆ·å°±ä¼šä¾æ®è¿™æ ·è¢«é™åˆ¶.è¿˜åº”è¯¥æ³¨æ„, æ‰€æœ‰çš„é™åˆ¶è®¾å®šåªæ˜¯æ¯ä¸ªç™»å½•çš„è®¾å®š. ä»–ä»¬æ—¢ä¸æ˜¯å…¨å±€çš„,ä¹Ÿä¸æ˜¯æ°¸ä¹…çš„ ; ä¹‹å­˜åœ¨äºä¼šè¯æœŸé—´.pam_limits æ¨¡å—ä¼šé€šè¿‡syslog(3)æŠ¥å‘Šå®ƒä»è®¾å®šæ¡£ä¸­æ‰¾åˆ°çš„é—®é¢˜.ä¸‹é¢é…ç½®æ–‡ä»¶å®ä¾‹:# EXAMPLE /etc/security/limits.conf file:# =======================================# &lt;domain&gt; &lt;type&gt; &lt;item&gt; &lt;value&gt;    *         soft     core     0    *         hard     rss         10000   @student     hard     nproc    20   @faculty     soft     nproc     20   @faculty     hard     nproc     50      ftp         hard     nproc     0æ³¨æ„, å¯¹åŒä¸€ä¸ªèµ„æºçš„è½¯é™åˆ¶å’Œç¡¬é™åˆ¶ - è¿™å»ºç«‹äº†ç”¨æˆ·å¯ä»¥ä»æŒ‡å®šæœåŠ¡ä¼šè¯ä¸­å¾—åˆ°çš„é»˜è®¤å’Œæœ€å¤§å…è®¸çš„èµ„æºæ•°.é™åˆ¶ç”¨æˆ·ç™»å½•æ¬¡æ•°/etc/security/limits.conf[root@localhost ~]# vim /etc/pam.d/loginsession required pam_limits.so[root@localhost ~]# vim /etc/security/limits.confhulk hard maxlogins 2é™åˆ¶ç”¨æˆ·æ‰“å¼€è¿›ç¨‹æ•°[root@localhost ~]# vim /etc/security/limits.conf hulk        hard     nproc     3[root@localhost ~]# useradd hulk[root@localhost ~]# echo &quot;123456&quot; | passwd --stdin hulk[root@localhost ~]# su - hulk[hulk@localhost ~]$ sleep 3000 &amp;[1] 4650[hulk@localhost ~]$ sleep 3000 &amp;[2] 4651[hulk@localhost ~]$ sleep 3000 &amp;-bash: fork: retry: Resource temporarily unavailableé™åˆ¶ç”¨æˆ·ä½¿ç”¨CPUæ—¶é—´[root@localhost ~]# vim /etc/security/limits.conf hulk     hard   cpu     1[hulk@localhost ~]$ ./a.sh    è„šæœ¬æ‰§è¡Œ1åˆ†é’Ÿå Killedé™åˆ¶ç”¨æˆ·åˆ›å»ºæ–‡ä»¶å¤§å°[root@localhost ~]# vim /etc/security/limits.conf hulk    hard   fsize    500[root@localhost ~]# su - hulk[hulk@localhost ~]$ dd if=/dev/zero of=file1 bs=1M count=1File size limit exceeded (core dumped)</code></pre><h5 id="cgroup"><a href="#cgroup" class="headerlink" title="cgroup"></a>cgroup</h5><pre><code>Cgroupsæ˜¯ä»€ä¹ˆï¼ŸCgroupsæ˜¯control groupsçš„ç¼©å†™ï¼Œæ˜¯Linuxå†…æ ¸æä¾›çš„ä¸€ç§å¯ä»¥é™åˆ¶ã€è®°å½•ã€éš”ç¦»è¿›ç¨‹ç»„ï¼ˆprocess groupsï¼‰æ‰€ä½¿ç”¨çš„ç‰©ç†èµ„æºï¼ˆå¦‚ï¼šcpu,memory,IOç­‰ç­‰ï¼‰çš„æœºåˆ¶ã€‚æœ€åˆç”±googleçš„å·¥ç¨‹å¸ˆæå‡ºï¼Œåæ¥è¢«æ•´åˆè¿›Linuxå†…æ ¸ã€‚Cgroupsä¹Ÿæ˜¯LXCä¸ºå®ç°è™šæ‹ŸåŒ–æ‰€ä½¿ç”¨çš„èµ„æºç®¡ç†æ‰‹æ®µï¼Œå¯ä»¥è¯´æ²¡æœ‰cgroupså°±æ²¡æœ‰LXCã€‚ æ¦‚è¿°LXCä¸ºLinuxContainerçš„ç®€å†™ã€‚LinuxContainerå®¹å™¨æ˜¯ä¸€ç§å†…æ ¸è™šæ‹ŸåŒ–æŠ€æœ¯ï¼Œå¯ä»¥æä¾›è½»é‡çº§çš„è™šæ‹ŸåŒ–Cgroupså¯ä»¥åšä»€ä¹ˆï¼ŸCgroupsæœ€åˆçš„ç›®æ ‡æ˜¯ä¸ºèµ„æºç®¡ç†æä¾›çš„ä¸€ä¸ªç»Ÿä¸€çš„æ¡†æ¶ï¼Œæ—¢æ•´åˆç°æœ‰çš„cpusetç­‰å­ç³»ç»Ÿï¼Œä¹Ÿä¸ºæœªæ¥å¼€å‘æ–°çš„å­ç³»ç»Ÿæä¾›æ¥å£ã€‚ç°åœ¨çš„cgroupsé€‚ç”¨äºå¤šç§åº”ç”¨åœºæ™¯ï¼Œä»å•ä¸ªè¿›ç¨‹çš„èµ„æºæ§åˆ¶ï¼Œåˆ°å®ç°æ“ä½œç³»ç»Ÿå±‚æ¬¡çš„è™šæ‹ŸåŒ–ï¼ˆOS Level Virtualizationï¼‰ã€‚Cgroupsæä¾›äº†ä¸€ä¸‹åŠŸèƒ½ï¼š1.é™åˆ¶è¿›ç¨‹ç»„å¯ä»¥ä½¿ç”¨çš„èµ„æºæ•°é‡ï¼ˆResource limiting ï¼‰ã€‚æ¯”å¦‚ï¼šmemoryå­ç³»ç»Ÿå¯ä»¥ä¸ºè¿›ç¨‹ç»„è®¾å®šä¸€ä¸ªmemoryä½¿ç”¨ä¸Šé™ï¼Œä¸€æ—¦è¿›ç¨‹ç»„ä½¿ç”¨çš„å†…å­˜è¾¾åˆ°é™é¢å†ç”³è¯·å†…å­˜ï¼Œå°±ä¼šå‡ºå‘OOMï¼ˆout of memoryï¼‰ã€‚2.è¿›ç¨‹ç»„çš„ä¼˜å…ˆçº§æ§åˆ¶ï¼ˆPrioritization ï¼‰ã€‚æ¯”å¦‚ï¼šå¯ä»¥ä½¿ç”¨cpuå­ç³»ç»Ÿä¸ºæŸä¸ªè¿›ç¨‹ç»„åˆ†é…ç‰¹å®šcpu shareã€‚3.è®°å½•è¿›ç¨‹ç»„ä½¿ç”¨çš„èµ„æºæ•°é‡ï¼ˆAccounting ï¼‰ã€‚æ¯”å¦‚ï¼šå¯ä»¥ä½¿ç”¨cpuacctå­ç³»ç»Ÿè®°å½•æŸä¸ªè¿›ç¨‹ç»„ä½¿ç”¨çš„cpuæ—¶é—´4.è¿›ç¨‹ç»„éš”ç¦»ï¼ˆIsolationï¼‰ã€‚æ¯”å¦‚ï¼šä½¿ç”¨nså­ç³»ç»Ÿå¯ä»¥ä½¿ä¸åŒçš„è¿›ç¨‹ç»„ä½¿ç”¨ä¸åŒçš„namespaceï¼Œä»¥è¾¾åˆ°éš”ç¦»çš„ç›®çš„ï¼Œä¸åŒçš„è¿›ç¨‹ç»„æœ‰å„è‡ªçš„è¿›ç¨‹ã€ç½‘ç»œã€æ–‡ä»¶ç³»ç»ŸæŒ‚è½½ç©ºé—´ã€‚5.è¿›ç¨‹ç»„æ§åˆ¶ï¼ˆControlï¼‰ã€‚æ¯”å¦‚ï¼šä½¿ç”¨freezerå­ç³»ç»Ÿå¯ä»¥å°†è¿›ç¨‹ç»„æŒ‚èµ·å’Œæ¢å¤ã€‚Cgroupsç›¸å…³æ¦‚å¿µåŠå…¶å…³ç³»ç›¸å…³æ¦‚å¿µ1.ä»»åŠ¡ï¼ˆtaskï¼‰ã€‚åœ¨cgroupsä¸­ï¼Œä»»åŠ¡å°±æ˜¯ç³»ç»Ÿçš„ä¸€ä¸ªè¿›ç¨‹ã€‚2.æ§åˆ¶æ—ç¾¤ï¼ˆcontrol groupï¼‰ã€‚æ§åˆ¶æ—ç¾¤å°±æ˜¯ä¸€ç»„æŒ‰ç…§æŸç§æ ‡å‡†åˆ’åˆ†çš„è¿›ç¨‹ã€‚Cgroupsä¸­çš„èµ„æºæ§åˆ¶éƒ½æ˜¯ä»¥æ§åˆ¶æ—ç¾¤ä¸ºå•ä½å®ç°ã€‚ä¸€ä¸ªè¿›ç¨‹å¯ä»¥åŠ å…¥åˆ°æŸä¸ªæ§åˆ¶æ—ç¾¤ï¼Œä¹Ÿä»ä¸€ä¸ªè¿›ç¨‹ç»„è¿ç§»åˆ°å¦ä¸€ä¸ªæ§åˆ¶æ—ç¾¤ã€‚ä¸€ä¸ªè¿›ç¨‹ç»„çš„è¿›ç¨‹å¯ä»¥ä½¿ç”¨cgroupsä»¥æ§åˆ¶æ—ç¾¤ä¸ºå•ä½åˆ†é…çš„èµ„æºï¼ŒåŒæ—¶å—åˆ°cgroupsä»¥æ§åˆ¶æ—ç¾¤ä¸ºå•ä½è®¾å®šçš„é™åˆ¶ã€‚3.å±‚çº§ï¼ˆhierarchyï¼‰ã€‚æ§åˆ¶æ—ç¾¤å¯ä»¥ç»„ç»‡æˆhierarchicalçš„å½¢å¼ï¼Œæ—¢ä¸€é¢—æ§åˆ¶æ—ç¾¤æ ‘ã€‚æ§åˆ¶æ—ç¾¤æ ‘ä¸Šçš„å­èŠ‚ç‚¹æ§åˆ¶æ—ç¾¤æ˜¯çˆ¶èŠ‚ç‚¹æ§åˆ¶æ—ç¾¤çš„å­©å­ï¼Œç»§æ‰¿çˆ¶æ§åˆ¶æ—ç¾¤çš„ç‰¹å®šçš„å±æ€§ã€‚4.å­ç³»ç»Ÿï¼ˆsubsytemï¼‰ã€‚ä¸€ä¸ªå­ç³»ç»Ÿå°±æ˜¯ä¸€ä¸ªèµ„æºæ§åˆ¶å™¨ï¼Œæ¯”å¦‚cpuå­ç³»ç»Ÿå°±æ˜¯æ§åˆ¶cpuæ—¶é—´åˆ†é…çš„ä¸€ä¸ªæ§åˆ¶å™¨ã€‚å­ç³»ç»Ÿå¿…é¡»é™„åŠ ï¼ˆattachï¼‰åˆ°ä¸€ä¸ªå±‚çº§ä¸Šæ‰èƒ½èµ·ä½œç”¨ï¼Œä¸€ä¸ªå­ç³»ç»Ÿé™„åŠ åˆ°æŸä¸ªå±‚çº§ä»¥åï¼Œè¿™ä¸ªå±‚çº§ä¸Šçš„æ‰€æœ‰æ§åˆ¶æ—ç¾¤éƒ½å—åˆ°è¿™ä¸ªå­ç³»ç»Ÿçš„æ§åˆ¶ã€‚ç›¸äº’å…³ç³»1.æ¯æ¬¡åœ¨ç³»ç»Ÿä¸­åˆ›å»ºæ–°å±‚çº§æ—¶ï¼Œè¯¥ç³»ç»Ÿä¸­çš„æ‰€æœ‰ä»»åŠ¡éƒ½æ˜¯é‚£ä¸ªå±‚çº§çš„é»˜è®¤ cgroupï¼ˆæˆ‘ä»¬ç§°ä¹‹ä¸º root cgroup ï¼Œæ­¤cgroupåœ¨åˆ›å»ºå±‚çº§æ—¶è‡ªåŠ¨åˆ›å»ºï¼Œåé¢åœ¨è¯¥å±‚çº§ä¸­åˆ›å»ºçš„cgroupéƒ½æ˜¯æ­¤cgroupçš„åä»£ï¼‰çš„åˆå§‹æˆå‘˜ã€‚2.ä¸€ä¸ªå­ç³»ç»Ÿæœ€å¤šåªèƒ½é™„åŠ åˆ°ä¸€ä¸ªå±‚çº§ã€‚3.ä¸€ä¸ªå±‚çº§å¯ä»¥é™„åŠ å¤šä¸ªå­ç³»ç»Ÿ4.ä¸€ä¸ªä»»åŠ¡å¯ä»¥æ˜¯å¤šä¸ªcgroupçš„æˆå‘˜ï¼Œä½†æ˜¯è¿™äº›cgroupå¿…é¡»åœ¨ä¸åŒçš„å±‚çº§ã€‚5.ç³»ç»Ÿä¸­çš„è¿›ç¨‹ï¼ˆä»»åŠ¡ï¼‰åˆ›å»ºå­è¿›ç¨‹ï¼ˆä»»åŠ¡ï¼‰æ—¶ï¼Œè¯¥å­ä»»åŠ¡è‡ªåŠ¨æˆä¸ºå…¶çˆ¶è¿›ç¨‹æ‰€åœ¨ cgroup çš„æˆå‘˜ã€‚ç„¶åå¯æ ¹æ®éœ€è¦å°†è¯¥å­ä»»åŠ¡ç§»åŠ¨åˆ°ä¸åŒçš„ cgroup ä¸­ï¼Œä½†å¼€å§‹æ—¶å®ƒæ€»æ˜¯ç»§æ‰¿å…¶çˆ¶ä»»åŠ¡çš„cgroupã€‚Cgroupså­ç³»ç»Ÿä»‹ç»blkio      è¿™ä¸ªå­ç³»ç»Ÿä¸ºå—è®¾å¤‡è®¾å®šè¾“å…¥/è¾“å‡ºé™åˆ¶ï¼Œæ¯”å¦‚ç‰©ç†è®¾å¤‡ï¼ˆç£ç›˜ï¼Œå›ºæ€ç¡¬ç›˜ï¼ŒUSB ç­‰ç­‰ï¼‰ã€‚cpu         è¿™ä¸ªå­ç³»ç»Ÿä½¿ç”¨è°ƒåº¦ç¨‹åºæä¾›å¯¹ CPU çš„ cgroup ä»»åŠ¡è®¿é—®ã€‚cpuacct     è¿™ä¸ªå­ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆ cgroup ä¸­ä»»åŠ¡æ‰€ä½¿ç”¨çš„ CPU æŠ¥å‘Šã€‚cpuset     è¿™ä¸ªå­ç³»ç»Ÿä¸º cgroup ä¸­çš„ä»»åŠ¡åˆ†é…ç‹¬ç«‹ CPUï¼ˆåœ¨å¤šæ ¸ç³»ç»Ÿï¼‰å’Œå†…å­˜èŠ‚ç‚¹ã€‚devices     è¿™ä¸ªå­ç³»ç»Ÿå¯å…è®¸æˆ–è€…æ‹’ç» cgroup ä¸­çš„ä»»åŠ¡è®¿é—®è®¾å¤‡ã€‚freezer     è¿™ä¸ªå­ç³»ç»ŸæŒ‚èµ·æˆ–è€…æ¢å¤ cgroup ä¸­çš„ä»»åŠ¡ã€‚memory     è¿™ä¸ªå­ç³»ç»Ÿè®¾å®š cgroup ä¸­ä»»åŠ¡ä½¿ç”¨çš„å†…å­˜é™åˆ¶ï¼Œå¹¶è‡ªåŠ¨ç”Ÿæˆç”±é‚£äº›ä»»åŠ¡ä½¿ç”¨çš„å†…å­˜èµ„æºæŠ¥å‘Šã€‚net_cls     è¿™ä¸ªå­ç³»ç»Ÿä½¿ç”¨ç­‰çº§è¯†åˆ«ç¬¦ï¼ˆclassidï¼‰æ ‡è®°ç½‘ç»œæ•°æ®åŒ…ï¼Œå¯å…è®¸ Linux æµé‡æ§åˆ¶ç¨‹åºï¼ˆtcï¼‰è¯†åˆ«ä»å…·ä½“ cgroup ä¸­ç”Ÿæˆçš„æ•°æ®åŒ…ã€‚ns         åç§°ç©ºé—´å­ç³»ç»Ÿã€‚å®‰è£…kernel-docæŸ¥çœ‹å¸®åŠ©[root@localhost ~]# ls /usr/share/doc/kernel-doc-2.6.32/Documentation/cgroups/00-INDEX                  cpuacct.txt      freezer-subsystem.txt      net_prio.txtblkio-controller.txt  cpusets.txt      memcg_test.txt             resource_counter.txtcgroups.txt               devices.txt      memory.txt</code></pre>]]></content>
      
      
      <categories>
          
          <category> Interview </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Prometheus-å…¥é—¨</title>
      <link href="2020/05/26/jian-kong/prometheus/prometheus-ru-men/"/>
      <url>2020/05/26/jian-kong/prometheus/prometheus-ru-men/</url>
      
        <content type="html"><![CDATA[<h1 id="Prometheusæ­å»ºç®€å•çš„ç›‘æ§å‘Šè­¦ç³»ç»Ÿ"><a href="#Prometheusæ­å»ºç®€å•çš„ç›‘æ§å‘Šè­¦ç³»ç»Ÿ" class="headerlink" title="Prometheusæ­å»ºç®€å•çš„ç›‘æ§å‘Šè­¦ç³»ç»Ÿ"></a>Prometheusæ­å»ºç®€å•çš„ç›‘æ§å‘Šè­¦ç³»ç»Ÿ</h1><h1 id="è¯´æ˜"><a href="#è¯´æ˜" class="headerlink" title="è¯´æ˜"></a>è¯´æ˜</h1><blockquote><p>ä½¿ç”¨çš„æ“ä½œç³»ç»Ÿä¸ºCentOS 7.6.1810ï¼Œå…¶ä»–ç³»ç»Ÿè¯·è‡ªå·±æ ¹æ®å·®å¼‚åšå¯¹åº”è°ƒæ•´</p><p>ä»…ç”¨äºè®°å½•éƒ¨ç½²è¿‡ç¨‹</p><p>å‘Šè­¦é€šçŸ¥å¯¹æ¥äº†é‚®ä»¶å’Œé’‰é’‰æœºå™¨äºº</p></blockquote><h1 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h1><blockquote><p>åœ¨ç›‘æ§å‘Šè­¦ç³»ç»Ÿä¸»æœºä¸Šå®‰è£…prometheusã€alertmanagerå’Œgrafana</p><p>è¢«ç›‘æ§çš„ä¸»æœºå®‰è£…å„ç§å„æ ·çš„exporterï¼Œæ¯ä¸ªexporteråªç›‘æ§è‡ªèº«çš„æœåŠ¡çŠ¶æ€</p></blockquote><h2 id="ç¯å¢ƒå‡†å¤‡"><a href="#ç¯å¢ƒå‡†å¤‡" class="headerlink" title="ç¯å¢ƒå‡†å¤‡"></a>ç¯å¢ƒå‡†å¤‡</h2><pre><code># åˆ›å»ºprometheusé…ç½®ç›®å½•mkdir -p /etc/prometheus /etc/prometheus/rules.d# åˆ›å»ºprometheusç”¨æˆ·useradd prometheus# ä¿®æ”¹å±ä¸»å±ç»„chown -R prometheus:prometheus /etc/prometheus</code></pre><h2 id="è½¯ä»¶åŒ…"><a href="#è½¯ä»¶åŒ…" class="headerlink" title="è½¯ä»¶åŒ…"></a>è½¯ä»¶åŒ…</h2><h3 id="prometheus"><a href="#prometheus" class="headerlink" title="prometheus"></a>prometheus</h3><p><a href="https://github.com/prometheus/prometheus/releases/download/v2.9.2/prometheus-2.9.2.linux-amd64.tar.gz" target="_blank" rel="noopener">prometheus-v2.9.2</a></p><pre><code># ä¸‹è½½è§£å‹wget -O - https://github.com/prometheus/prometheus/releases/download/v2.9.2/prometheus-2.9.2.linux-amd64.tar.gz | tar xz# åˆ›å»ºæ•°æ®ç›®å½•mkdir -p /var/lib/prometheuschwon -R prometheus:prometheus /var/lib/prometheus# æ‹·è´æ–‡ä»¶åˆ°å¯¹åº”ä½ç½®cd prometheus-2.9.2.linux-amd64chown -R prometheus:prometheus prometheus promtool console_libraries consoles prometheus.ymlmv prometheus promtool /usr/local/bin/mv console_libraries consoles prometheus.yml /etc/prometheus/</code></pre><h3 id="alertmanager"><a href="#alertmanager" class="headerlink" title="alertmanager"></a>alertmanager</h3><p><a href="https://github.com/prometheus/alertmanager/releases/download/v0.17.0/alertmanager-0.17.0.linux-amd64.tar.gz" target="_blank" rel="noopener">alertmanager-v0.17.0</a></p><pre><code># ä¸‹è½½è§£å‹wget -O - https://github.com/prometheus/alertmanager/releases/download/v0.17.0/alertmanager-0.17.0.linux-amd64.tar.gz | tar xz# åˆ›å»ºæ•°æ®ç›®å½•mkdir -p /var/lib/prometheuschwon -R prometheus:prometheus /var/lib/prometheus# æ‹·è´æ–‡ä»¶cd alertmanager-0.17.0.linux-amd64chown -R prometheus:prometheus alertmanager alertmanager.yml amtoolmv alertmanager amtool /usr/local/bin/mv alertmanager.yml /etc/prometheus</code></pre><h3 id="node-exporter"><a href="#node-exporter" class="headerlink" title="node_exporter"></a>node_exporter</h3><p><a href="https://github.com/prometheus/node_exporter/releases/download/v0.18.0/node_exporter-0.18.0.linux-amd64.tar.gz" target="_blank" rel="noopener">node_exporter-v0.18.0</a></p><pre><code># ä¸‹è½½è§£å‹wget -O - https://github.com/prometheus/node_exporter/releases/download/v0.18.0/node_exporter-0.18.0.linux-amd64.tar.gz | tar xzcd node_exporter-0.18.0.linux-amd64chown prometheus:prometheus node_exporter# æ‹·è´æ–‡ä»¶mv node_exporter /usr/local/bin/</code></pre><h3 id="mysqld-exporter"><a href="#mysqld-exporter" class="headerlink" title="mysqld_exporter"></a>mysqld_exporter</h3><p><a href="https://github.com/prometheus/mysqld_exporter/releases/download/v0.11.0/mysqld_exporter-0.11.0.linux-amd64.tar.gz" target="_blank" rel="noopener">mysqld_exporter-v0.11.0</a></p><pre><code># ä¸‹è½½è§£å‹wget -O - https://github.com/prometheus/mysqld_exporter/releases/download/v0.11.0/mysqld_exporter-0.11.0.linux-amd64.tar.gz | tar xzcd mysqld_exporter-0.11.0.linux-amd64chown prometheus:prometheus mysqld_exporter# æ‹·è´æ–‡ä»¶mv mysqld_exporter /usr/local/bin/</code></pre><h3 id="postgresql-exporter"><a href="#postgresql-exporter" class="headerlink" title="postgresql_exporter"></a>postgresql_exporter</h3><pre><code># ä¸‹è½½è§£å‹wget -O - https://github.com/wrouesnel/postgres_exporter/releases/download/v0.4.7/postgres_exporter_v0.4.7_linux-amd64.tar.gz | tar xzcd postgres_exporter_v0.4.7_linux-amd64chown prometheus:prometheus postgres_exporter# æ‹·è´æ–‡ä»¶mv postgres_exporter /usr/local/bin/</code></pre><h3 id="blackbox-exporter"><a href="#blackbox-exporter" class="headerlink" title="blackbox_exporter"></a>blackbox_exporter</h3><p><a href="https://github.com/prometheus/blackbox_exporter/releases/download/v0.14.0/blackbox_exporter-0.14.0.linux-amd64.tar.gz" target="_blank" rel="noopener">blackbox_exporter-v0.14.0</a></p><pre><code># ä¸‹è½½è§£å‹wget -O - https://github.com/prometheus/blackbox_exporter/releases/download/v0.14.0/blackbox_exporter-0.14.0.linux-amd64.tar.gz | tar xzcd blackbox_exporter-0.14.0.linux-amd64chown prometheus:prometheus blackbox_exporter blackbox.yml# æ‹·è´æ–‡ä»¶mv blackbox_exporter /usr/local/bin/mv blackbox.yml /etc/prometheus/</code></pre><h3 id="grafana"><a href="#grafana" class="headerlink" title="grafana"></a>grafana</h3><p><a href="https://dl.grafana.com/oss/release/grafana-6.1.6-1.x86_64.rpm" target="_blank" rel="noopener">grafana-v6.1.6</a></p><pre><code># ä¸‹è½½wget https://dl.grafana.com/oss/release/grafana-6.1.6-1.x86_64.rpmyum localinstall grafana-6.1.6-1.x86_64.rpm</code></pre><h2 id="é…ç½®"><a href="#é…ç½®" class="headerlink" title="é…ç½®"></a>é…ç½®</h2><h3 id="Prometheus"><a href="#Prometheus" class="headerlink" title="Prometheus"></a>Prometheus</h3><p>/etc/prometheus/prometheus.yml</p><pre><code>global:  scrape_interval: 15s  scrape_timeout: 10s  evaluation_interval: 15salerting:  alertmanagers:  - static_configs:    - targets:      - localhost:9093    scheme: http    timeout: 10srule_files:- /etc/prometheus/rules.d/*.rulesscrape_configs:- job_name: prometheus  honor_timestamps: true  scrape_interval: 5s  scrape_timeout: 5s  metrics_path: /metrics  scheme: http  static_configs:  - targets:    - localhost:9090- job_name: node-exporter  honor_timestamps: true  scrape_interval: 5s  scrape_timeout: 5s  metrics_path: /metrics  scheme: http  static_configs:  - targets:    - localhost:9100- job_name: mysqld-exporter  honor_timestamps: true  scrape_interval: 5s  scrape_timeout: 5s  metrics_path: /metrics  scheme: http  static_configs:  - targets:    - localhost:9104- job_name: postgresql-exporter  honor_timestamps: true  scrape_interval: 5s  scrape_timeout: 5s  metrics_path: /metrics  scheme: http  static_configs:  - targets:    - localhost:9187</code></pre><p>/etc/prometheus/rules.d/host-status.rules</p><pre><code>groups:  - name: host-status-rule    rules:    - alert: NodeFilesystemSpaceUsage      expr: ( 1 - (node_filesystem_avail_bytes{fstype=~&quot;ext[234]|btrfs|xfs|zfs&quot;} / node_filesystem_size_bytes{fstype=~&quot;ext[234]|btrfs|xfs|zfs&quot;}) ) * 100 &gt; 85      for: 1m      labels:        team: node      annotations:        summary: &quot;{{$labels.instance}}: æ–‡ä»¶ç³»ç»Ÿç©ºé—´ä½¿ç”¨ç‡è¿‡é«˜&quot;        description: &quot;{{$labels.instance}}: æ–‡ä»¶ç³»ç»Ÿç©ºé—´ä½¿ç”¨ç‡è¶…è¿‡ 85% (å½“å‰ä½¿ç”¨ç‡: {{ $value }})&quot;    - alert: NodeFilesystemInodeUsage      expr: ( 1 - (node_filesystem_files_free{fstype=~&quot;ext[234]|btrfs|xfs|zfs&quot;} / node_filesystem_files{fstype=~&quot;ext[234]|btrfs|xfs|zfs&quot;}) ) * 100 &gt; 80      for: 1m      labels:        team: node      annotations:        summary: &quot;{{$labels.instance}}: æ–‡ä»¶ç³»ç»Ÿinodeä½¿ç”¨ç‡è¿‡é«˜&quot;        description: &quot;{{$labels.instance}}: æ–‡ä»¶ç³»ç»Ÿinodeä½¿ç”¨ç‡è¶…è¿‡ 80% (å½“å‰ä½¿ç”¨ç‡: {{ $value }})&quot;    - alert: NodeFilesystemReadOnly      expr: node_filesystem_readonly{job=&quot;node-exporter&quot;,device!~&#39;rootfs&#39;} == 1      for: 1m      labels:        team: node      annotations:        summary: &quot;{{$labels.instance}}: æ–‡ä»¶ç³»ç»Ÿåªè¯»çŠ¶æ€&quot;        description: &quot;{{$labels.instance}}: æ–‡ä»¶ç³»ç»Ÿåªè¯»çŠ¶æ€&quot;    - alert: NodeMemoryUsage      expr: (node_memory_MemTotal - (node_memory_MemFree+node_memory_Buffers+node_memory_Cached )) / node_memory_MemTotal * 100 &gt; 80      for: 1m      labels:        team: node      annotations:        summary: &quot;{{$labels.instance}}: å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜&quot;        description: &quot;{{$labels.instance}}: å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜è¶…è¿‡80% (å½“å‰ä½¿ç”¨ç‡: {{ $value }})&quot;    - alert: NodeCPUUsage      expr: (100 - (avg by (instance) (irate(node_cpu_seconds_total{mode=&#39;idle&#39;,job=&quot;node-exporter&quot;}[1m])) * 100)) &gt; 80      for: 1m      labels:        team: node      annotations:        summary: &quot;{{$labels.instance}}: CPUä½¿ç”¨ç‡è¿‡é«˜&quot;        description: &quot;{{$labels.instance}}: CPUä½¿ç”¨ç‡è¶…è¿‡80% (å½“å‰ä½¿ç”¨ç‡: {{ $value }})&quot;</code></pre><p>/etc/prometheus/rules.d/mysql-status.rules</p><pre><code>groups:  - name: MySQLStatsAlert    rules:    - alert: MySQL is down      expr: mysql_up == 0      for: 1m      labels:        severity: critical      annotations:        summary: &quot;Instance {{ $labels.instance }} MySQL is down&quot;        description: &quot;MySQL database is down. This requires immediate action!&quot;    - alert: open files high      expr: mysql_global_status_innodb_num_open_files &gt; (mysql_global_variables_open_files_limit) * 0.75      for: 1m      labels:        severity: warning      annotations:        summary: &quot;Instance {{ $labels.instance }} open files high&quot;        description: &quot;Open files is high. Please consider increasing open_files_limit.&quot;    - alert: Read buffer size is bigger than max. allowed packet size      expr: mysql_global_variables_read_buffer_size &gt; mysql_global_variables_slave_max_allowed_packet       for: 1m      labels:        severity: warning      annotations:        summary: &quot;Instance {{ $labels.instance }} Read buffer size is bigger than max. allowed packet size&quot;        description: &quot;Read buffer size (read_buffer_size) is bigger than max. allowed packet size (max_allowed_packet).This can break your replication.&quot;    - alert: Sort buffer possibly missconfigured      expr: mysql_global_variables_innodb_sort_buffer_size &lt;256*1024 or mysql_global_variables_read_buffer_size &gt; 4*1024*1024       for: 1m      labels:        severity: warning      annotations:        summary: &quot;Instance {{ $labels.instance }} Sort buffer possibly missconfigured&quot;        description: &quot;Sort buffer size is either too big or too small. A good value for sort_buffer_size is between 256k and 4M.&quot;    - alert: Thread stack size is too small      expr: mysql_global_variables_thread_stack &lt;196608      for: 1m      labels:        severity: warning      annotations:        summary: &quot;Instance {{ $labels.instance }} Thread stack size is too small&quot;        description: &quot;Thread stack size is too small. This can cause problems when you use Stored Language constructs for example. A typical is 256k for thread_stack_size.&quot;    - alert: Used more than 80% of max connections limited       expr: mysql_global_status_max_used_connections &gt; mysql_global_variables_max_connections * 0.8      for: 1m      labels:        severity: warning      annotations:        summary: &quot;Instance {{ $labels.instance }} Used more than 80% of max connections limited&quot;        description: &quot;Used more than 80% of max connections limited&quot;    - alert: InnoDB Force Recovery is enabled      expr: mysql_global_variables_innodb_force_recovery != 0       for: 1m      labels:        severity: warning      annotations:        summary: &quot;Instance {{ $labels.instance }} InnoDB Force Recovery is enabled&quot;        description: &quot;InnoDB Force Recovery is enabled. This mode should be used for data recovery purposes only. It prohibits writing to the data.&quot;    - alert: InnoDB Log File size is too small      expr: mysql_global_variables_innodb_log_file_size &lt; 16777216       for: 1m      labels:        severity: warning      annotations:        summary: &quot;Instance {{ $labels.instance }} InnoDB Log File size is too small&quot;        description: &quot;The InnoDB Log File size is possibly too small. Choosing a small InnoDB Log File size can have significant performance impacts.&quot;    - alert: InnoDB Flush Log at Transaction Commit      expr: mysql_global_variables_innodb_flush_log_at_trx_commit != 1      for: 1m      labels:        severity: warning      annotations:        summary: &quot;Instance {{ $labels.instance }} InnoDB Flush Log at Transaction Commit&quot;        description: &quot;InnoDB Flush Log at Transaction Commit is set to a values != 1. This can lead to a loss of commited transactions in case of a power failure.&quot;    - alert: Table definition cache too small      expr: mysql_global_status_open_table_definitions &gt; mysql_global_variables_table_definition_cache      for: 1m      labels:        severity: page      annotations:        summary: &quot;Instance {{ $labels.instance }} Table definition cache too small&quot;        description: &quot;Your Table Definition Cache is possibly too small. If it is much too small this can have significant performance impacts!&quot;    - alert: Table open cache too small      expr: mysql_global_status_open_tables &gt;mysql_global_variables_table_open_cache * 99/100      for: 1m      labels:        severity: page      annotations:        summary: &quot;Instance {{ $labels.instance }} Table open cache too small&quot;        description: &quot;Your Table Open Cache is possibly too small (old name Table Cache). If it is much too small this can have significant performance impacts!&quot;    - alert: Thread stack size is possibly too small      expr: mysql_global_variables_thread_stack &lt; 262144      for: 1m      labels:        severity: page      annotations:        summary: &quot;Instance {{ $labels.instance }} Thread stack size is possibly too small&quot;        description: &quot;Thread stack size is possibly too small. This can cause problems when you use Stored Language constructs for example. A typical is 256k for thread_stack_size.&quot;    - alert: InnoDB Plugin is enabled      expr: mysql_global_variables_ignore_builtin_innodb == 1      for: 1m      labels:        severity: page      annotations:        summary: &quot;Instance {{ $labels.instance }} InnoDB Plugin is enabled&quot;        description: &quot;InnoDB Plugin is enabled&quot;    - alert: Binary Log is disabled      expr: mysql_global_variables_log_bin != 1      for: 1m      labels:        severity: warning      annotations:        summary: &quot;Instance {{ $labels.instance }} Binary Log is disabled&quot;        description: &quot;Binary Log is disabled. This prohibits you to do Point in Time Recovery (PiTR).&quot;    - alert: Binlog Cache size too small      expr: mysql_global_variables_binlog_cache_size &lt; 1048576      for: 1m      labels:        severity: page      annotations:        summary: &quot;Instance {{ $labels.instance }} Binlog Cache size too small&quot;        description: &quot;Binlog Cache size is possibly to small. A value of 1 Mbyte or higher is OK.&quot;    - alert: Binlog Transaction Cache size too small      expr: mysql_global_variables_binlog_cache_size  &lt; 1048576      for: 1m      labels:        severity: page      annotations:        summary: &quot;Instance {{ $labels.instance }} Binlog Transaction Cache size too small&quot;        description: &quot;Binlog Transaction Cache size is possibly to small. A value of 1 Mbyte or higher is typically OK.&quot;</code></pre><p>/etc/prometheus/rules.d/postgresql-status.rules</p><pre><code>groups:- name: PostgreSQL-Status-Alert  rules:########## EXPORTER RULES ##########  - alert: PGExporterScrapeError    expr: pg_exporter_last_scrape_error &gt; 0    for: 60s    labels:      service: postgresql      severity: critical      severity_num: 300    annotations:      summary: &#39;Postgres Exporter running on {{ $labels.job }} (instance: {{ $labels.instance }}) is encountering scrape errors processing queries. Error count: ( {{ $value }} )&#39;  - alert: NodeExporterScrapeError    expr: node_textfile_scrape_error &gt; 0    for: 60s    labels:      service: system       severity: critical      severity_num: 300    annotations:      summary: &#39;Node Exporter running on {{ $labels.job }} (instance: {{ $labels.instance }}) is encountering scrape errors processing custom metrics.  Error count: ( {{ $value }} )&#39;########## POSTGRESQL RULES ##########  - alert: PGIsUp    expr: pg_up &lt; 1    for: 60s    labels:      service: postgresql      severity: critical      severity_num: 300    annotations:      summary: &#39;postgres_exporter running on {{ $labels.job }} is unable to communicate with the configured database&#39;# Whether a system switches from primary to replica or vice versa must be configured per named job.# No way to tell what value a system is supposed to be without a rule expression for that specific system# 2 to 1 means it changed from primary to replica. 1 to 2 means it changed from replica to primary# Set this alert for each system that you want to monitor a recovery status change# Below is an example for a target job called &quot;Replica&quot; and watches for the value to change above 1 which means it&#39;s no longer a replica##  - alert: PGRecoveryStatusSwitch_Replica #    expr: ccp_is_in_recovery_status{job=&quot;Replica&quot;} &gt; 1 #    for: 60s#    labels:#      service: postgresql#      severity: critical#      severity_num: 300#    annotations:#      summary: &#39;{{ $labels.job }} has changed from replica to primary&#39;# Absence alerts must be configured per named job, otherwise there&#39;s no way to know which job is down# Below is an example for a target job called &quot;Prod&quot;#  - alert: PGConnectionAbsent#    expr: absent(ccp_connection_stats_max_connections{job=&quot;Prod&quot;})#    for: 10s#    labels:#      service: postgresql#      severity: critical#      severity_num: 300#    annotations:#      description: &#39;Connection metric is absent from target (Prod). Check that postgres_exporter can connect to PostgreSQL.&#39;  - alert: PGIdleTxn    expr: ccp_connection_stats_max_idle_in_txn_time &gt; 300    for: 60s    labels:      service: postgresql      severity: warning      severity_num: 200    annotations:      description: &#39;{{ $labels.job }} has at least one session idle in transaction for over 5 minutes.&#39;      summary: &#39;PGSQL Instance idle transactions&#39;  - alert: PGIdleTxn    expr: ccp_connection_stats_max_idle_in_txn_time &gt; 900    for: 60s    labels:      service: postgresql      severity: critical      severity_num: 300    annotations:      description: &#39;{{ $labels.job }} has at least one session idle in transaction for over 15 minutes.&#39;      summary: &#39;PGSQL Instance idle transactions&#39;  - alert: PGQueryTime    expr: ccp_connection_stats_max_query_time &gt; 43200    for: 60s    labels:      service: postgresql      severity: warning       severity_num: 200    annotations:      description: &#39;{{ $labels.job }} has at least one query running for over 12 hours.&#39;      summary: &#39;PGSQL Max Query Runtime&#39;  - alert: PGQueryTime    expr: ccp_connection_stats_max_query_time &gt; 86400     for: 60s    labels:      service: postgresql      severity: critical      severity_num: 300    annotations:      description: &#39;{{ $labels.job }} has at least one query running for over 1 day.&#39;      summary: &#39;PGSQL Max Query Runtime&#39;  - alert: PGConnPerc    expr: 100 * (ccp_connection_stats_total / ccp_connection_stats_max_connections) &gt; 75    for: 60s    labels:      service: postgresql      severity: warning      severity_num: 200    annotations:      description: &#39;{{ $labels.job }} is using 75% or more of available connections ({{ $value }}%)&#39;      summary: &#39;PGSQL Instance connections&#39;  - alert: PGConnPerc    expr: 100 * (ccp_connection_stats_total / ccp_connection_stats_max_connections) &gt; 90     for: 60s    labels:      service: postgresql      severity: critical      severity_num: 300    annotations:      description: &#39;{{ $labels.job }} is using 90% or more of available connections ({{ $value }}%)&#39;      summary: &#39;PGSQL Instance connections&#39;  - alert: PGDBSize    expr: ccp_database_size &gt; 1.073741824e+11    for: 60s    labels:      service: postgresql      severity: warning      severity_num: 200    annotations:      description: &#39;PGSQL Instance {{ $labels.job }} over 100GB in size: {{ $value }} bytes&#39;      summary: &#39;PGSQL Instance size warning&#39;  - alert: PGDBSize    expr: ccp_database_size &gt; 2.68435456e+11    for: 60s    labels:      service: postgresql      severity: critical      severity_num: 300    annotations:      description: &#39;PGSQL Instance {{ $labels.job }} over 250GB in size: {{ $value }} bytes&#39;      summary: &#39;PGSQL Instance size critical&#39;  - alert: PGReplicationByteLag    expr: ccp_replication_status_byte_lag &gt; 5.24288e+07    for: 60s    labels:      service: postgresql      severity: warning      severity_num: 200    annotations:      description: &#39;PGSQL Instance {{ $labels.job }} has at least one replica lagging over 50MB behind.&#39;      summary: &#39;PGSQL Instance replica lag warning&#39;  - alert: PGReplicationByteLag    expr: ccp_replication_status_byte_lag &gt; 1.048576e+08    for: 60s    labels:      service: postgresql      severity: critical      severity_num: 300    annotations:      description: &#39;PGSQL Instance {{ $labels.job }} has at least one replica lagging over 100MB behind.&#39;      summary: &#39;PGSQL Instance replica lag warning&#39;  - alert: PGReplicationSlotsInactive    expr: ccp_replication_slots_active == 0    for: 60s    labels:      service: postgresql      severity: critical      severity_num: 300    annotations:      description: &#39;PGSQL Instance {{ $labels.job }} has one or more inactive replication slots&#39;      summary: &#39;PGSQL Instance inactive replication slot&#39;  - alert: PGXIDWraparound    expr: ccp_transaction_wraparound_percent_towards_wraparound &gt; 50    for: 60s    labels:      service: postgresql      severity: warning      severity_num: 200    annotations:      description: &#39;PGSQL Instance {{ $labels.job }} is over 50% towards transaction id wraparound.&#39;      summary: &#39;PGSQL Instance {{ $labels.job }} transaction id wraparound imminent&#39;  - alert: PGXIDWraparound    expr: ccp_transaction_wraparound_percent_towards_wraparound &gt; 75    for: 60s    labels:      service: postgresql      severity: critical      severity_num: 300    annotations:      description: &#39;PGSQL Instance {{ $labels.job }} is over 75% towards transaction id wraparound.&#39;      summary: &#39;PGSQL Instance transaction id wraparound imminent&#39;  - alert: PGEmergencyVacuum    expr: ccp_transaction_wraparound_percent_towards_emergency_autovac &gt; 75    for: 60s    labels:      service: postgresql      severity: warning      severity_num: 200    annotations:      description: &#39;PGSQL Instance {{ $labels.job }} is over 75% towards emergency autovacuum processes beginning&#39;      summary: &#39;PGSQL Instance emergency vacuum imminent&#39;  - alert: PGEmergencyVacuum    expr: ccp_transaction_wraparound_percent_towards_emergency_autovac &gt; 90    for: 60s    labels:      service: postgresql      severity: critical      severity_num: 300    annotations:      description: &#39;PGSQL Instance {{ $labels.job }} is over 90% towards emergency autovacuum processes beginning&#39;      summary: &#39;PGSQL Instance emergency vacuum imminent&#39;  - alert: PGArchiveCommandStatus    expr: ccp_archive_command_status_seconds_since_last_fail &gt; 300    for: 60s    labels:        service: postgresql        severity: critical        severity_num: 300    annotations:        description: &#39;PGSQL Instance {{ $labels.job }} has a recent failing archive command&#39;        summary: &#39;Seconds since the last recorded failure of the archive_command&#39;  - alert: PGSequenceExhaustion    expr: ccp_sequence_exhaustion_count &gt; 0    for: 60s    labels:        service: postgresql        severity: critical        severity_num: 300    annotations:        description: &#39;Count of sequences on instance {{ $labels.job }} at over 75% usage: {{ $value }}. Run following query to see full sequence status: SELECT * FROM monitor.sequence_status() WHERE percent &gt;= 75&#39;########## SYSTEM RULES ##########  - alert: ExporterDown    expr: avg_over_time(up[5m]) &lt; 0.9     for: 10s     labels:      service: system      severity: critical      severity_num: 300    annotations:      description: &#39;Metrics exporter service for {{ $labels.job }} running on {{ $labels.instance }} has been down at least 50% of the time for the last 5 minutes. Service may be flapping or down.&#39;      summary: &#39;Prometheus Exporter Service Down&#39;  - alert: DiskUsagePerc    expr: (100 - 100 * sum(node_filesystem_avail_bytes{device!~&quot;tmpfs|by-uuid&quot;,fstype=~&quot;xfs|ext&quot;} / node_filesystem_size_bytes{device!~&quot;tmpfs|by-uuid&quot;,fstype=~&quot;xfs|ext&quot;}) BY (job,device)) &gt; 70    for: 2m    labels:      service: system      severity: warning      severity_num: 200    annotations:      description: &#39;Disk usage on target {{ $labels.job }} at {{ $value }}%&#39;  - alert: DiskUsagePerc    expr: (100 - 100 * sum(node_filesystem_avail_bytes{device!~&quot;tmpfs|by-uuid&quot;,fstype=~&quot;xfs|ext&quot;} / node_filesystem_size_bytes{device!~&quot;tmpfs|by-uuid&quot;,fstype=~&quot;xfs|ext&quot;}) BY (job,device)) &gt; 85    for: 2m    labels:      service: system      severity: critical      severity_num: 300    annotations:      description: &#39;Disk usage on target {{ $labels.job }} at {{ $value }}%&#39;  - alert: DiskFillPredict    expr: predict_linear(node_filesystem_free_bytes{device!~&quot;tmpfs|by-uuid&quot;,fstype=~&quot;xfs|ext&quot;}[1h], 4 * 3600) &lt; 0    for: 5m    labels:      service: system      severity: warning      severity_num: 200    annotations:      description: &#39;(EXPERIMENTAL) Disk {{ $labels.device }} on target {{ $labels.job }} is predicted to fill in 4 hrs based on current usage&#39;  - alert: SystemLoad5m    expr: node_load5 &gt; 5    for: 10m    labels:      service: system      severity: warning      severity_num: 200    annotations:      description: &#39;System load for target {{ $labels.job }} is high ({{ $value }})&#39;  - alert: SystemLoad5m    expr: node_load5 &gt; 10    for: 10m    labels:      service: system      severity: critical      severity_num: 300    annotations:      description: &#39;System load for target {{ $labels.job }} is high ({{ $value }})&#39;  - alert: MemoryAvailable    expr: (100 * (node_memory_Available_bytes) / node_memory_MemTotal_bytes) &lt; 25    for: 1m    labels:      service: system      severity: warning      severity_num: 200    annotations:      description: &#39;Memory available for target {{ $labels.job }} is at {{ $value }}%&#39;  - alert: MemoryAvailable    expr: (100 * (node_memory_MemAvailable_bytes) / node_memory_MemTotal_bytes) &lt; 10    for: 1m    labels:      service: system      severity: critical      severity_num: 300    annotations:      description: &#39;Memory available for target {{ $labels.job }} is at {{ $value }}%&#39;  - alert: SwapUsage    expr: (100 - (100 * (node_memory_SwapFree_bytes / node_memory_SwapTotal_bytes))) &gt; 60    for: 1m    labels:      service: system      severity: warning      severity_num: 200    annotations:      description: &#39;Swap usage for target {{ $labels.job }} is at {{ $value }}%&#39;  - alert: SwapUsage    expr: (100 - (100 * (node_memory_SwapFree_byte / node_memory_SwapTotal_bytes))) &gt; 80    for: 1m    labels:      service: system      severity: critical      severity_num: 300    annotations:      description: &#39;Swap usage for target {{ $labels.job }} is at {{ $value }}%&#39;########## PGBACKREST RULES ############ Uncomment and customize one or more of these rules to monitor your pgbackrest backups. # Full backups are considered the equivalent of both differentials and incrementals since both are based on the last full#   And differentials are considered incrementals since incrementals will be based off the last diff if one exists#   This avoid false alerts, for example when you don&#39;t run diff/incr backups on the days that you run a full# Stanza should also be set if different intervals are expected for each stanza. #   Otherwise rule will be applied to all stanzas returned on target system if not set.# Otherwise, all backups returned by the pgbackrest info command run from where the database exists will be checked## Relevant metric names are: #   ccp_backrest_last_full_time_since_completion_seconds#   ccp_backrest_last_incr_time_since_completion_seconds#   ccp_backrest_last_diff_time_since_completion_seconds##  - alert: PGBackRestLastCompletedFull_main#    expr: ccp_backrest_last_full_backup_time_since_completion_seconds{stanza=&quot;main&quot;} &gt; 604800#    for: 60s#    labels:#       service: postgresql#       severity: critical#       severity_num: 300#    annotations:#       summary: &#39;Full backup for stanza [main] on system {{ $labels.job }} has not completed in the last week.&#39;##  - alert: PGBackRestLastCompletedIncr_main#    expr: ccp_backrest_last_incr_backup_time_since_completion_seconds{stanza=&quot;main&quot;} &gt; 86400#    for: 60s#    labels:#       service: postgresql#       severity: critical#       severity_num: 300#    annotations:#       summary: &#39;Incremental backup for stanza [main] on system {{ $labels.job }} has not completed in the last 24 hours.&#39;### Runtime monitoring is handled with a single metric:##   ccp_backrest_last_runtime_backup_runtime_seconds## Runtime monitoring should have the &quot;backup_type&quot; label set. #   Otherwise the rule will apply to the last run of all backup types returned (full, diff, incr)# Stanza should also be set if runtimes per stanza have different expected times##  - alert: PGBackRestLastRuntimeFull_main#    expr: ccp_backrest_last_runtime_backup_runtime_seconds{backup_type=&quot;full&quot;, stanza=&quot;main&quot;} &gt; 14400#    for: 60s#    labels:#       service: postgresql#       severity: critical#       severity_num: 300#    annotations:#       summary: &#39;Expected runtime of full backup for stanza [main] has exceeded 4 hours&#39;##  - alert: PGBackRestLastRuntimeDiff_main#    expr: ccp_backrest_last_runtime_backup_runtime_seconds{backup_type=&quot;diff&quot;, stanza=&quot;main&quot;} &gt; 3600#    for: 60s#    labels:#       service: postgresql#       severity: critical#       severity_num: 300#    annotations:#       summary: &#39;Expected runtime of diff backup for stanza [main] has exceeded 1 hour&#39;##### If the pgbackrest command fails to run, the metric disappears from the exporter output and the alert never fires. ## An absence alert must be configured explicitly for each target (job) that backups are being monitored.## Checking for absence of just the full backup type should be sufficient (no need for diff/incr).## Note that while the backrest check command failing will likely also cause a scrape error alert, the addition of this ## check gives a clearer answer as to what is causing it and that something is wrong with the backups.##  - alert: PGBackrestAbsentFull_Prod#    expr: absent(ccp_backrest_last_full_backup_time_since_completion_seconds{job=&quot;Prod&quot;})#    for: 10s#    labels:#      service: postgresql#      severity: critical#      severity_num: 300#    annotations:#      description: &#39;Backup Full status missing for Prod. Check that pgbackrest info command is working on target system.&#39;</code></pre><h3 id="Alertmanager"><a href="#Alertmanager" class="headerlink" title="Alertmanager"></a>Alertmanager</h3><p>/etc/prometheus/alertmanager.yml</p><pre><code>global:  resolve_timeout: 5m  http_config: {}  smtp_from: monitor@example.com  smtp_hello: localhost  smtp_smarthost: smtp.example.com:465  smtp_auth_username: monitor@example.com  smtp_auth_password: &#39;è¿™é‡Œå†™å¯†ç &#39;  smtp_require_tls: false  pagerduty_url: https://events.pagerduty.com/v2/enqueue  hipchat_api_url: https://api.hipchat.com/  opsgenie_api_url: https://api.opsgenie.com/  wechat_api_url: https://qyapi.weixin.qq.com/cgi-bin/  victorops_api_url: https://alert.victorops.com/integrations/generic/20131114/alert/route:  # è¿™é‡Œé…ç½®é»˜è®¤è·¯ç”±åˆ°&#39;default-receiver&#39;  receiver: default-receiver  group_by:  - alertname  - cluster  group_wait: 10s  group_interval: 10s  repeat_interval: 1hinhibit_rules:- source_match:    severity: critical  target_match:    severity: warning  equal:  - alertname  - dev  - instancereceivers:- name: default-receiver  email_configs:  - send_resolved: false    to: monitor@example.com    from: monitor@example.com    hello: localhost    smarthost: smtp.example.com:465    auth_username: monitor@example.com    auth_password: &#39;è¿™é‡Œå†™å¯†ç &#39;    headers:      From: monitor@example.com      Subject: &#39;{{ template "email.default.subject" . }}&#39;      To: monitor@example.com    html: &#39;{{ template "email.default.html" . }}&#39;    require_tls: false  # é…ç½®é’‰é’‰æœºå™¨äºº  webhook_configs:  - send_resolved: false    url: http://localhost:8060/dingtalk/webhook001/send# é…ç½®é’‰é’‰æœºå™¨äºº- name: dingtalk002  webhook_configs:  - send_resolved: false    url: http://localhost:8060/dingtalk/webhook002/sendtemplates: []</code></pre><p>é…ç½®dingtalk webhookç¨‹åº</p><pre><code># è¿™é‡Œå·æ‡’ç”¨dockerè·‘é’‰é’‰çš„webhookdocker run -d \           --restart=always \           --name prometheus-webhook-dingtalk \           -p 8060:8060 \           -v /usr/share/zoneinfo/Asia/Shanghai:/etc/localtime:ro \           timonwong/prometheus-webhook-dingtalk \           --ding.profile=&quot;webhook001=https://oapi.dingtalk.com/robot/send?access_token=xxxxxxxxxxxx&quot; \           --ding.profile=&quot;webhook002=https://oapi.dingtalk.com/robot/send?access_token=yyyyyyyyyyy&quot;</code></pre><h3 id="blackbox-exporter-1"><a href="#blackbox-exporter-1" class="headerlink" title="blackbox_exporter"></a>blackbox_exporter</h3><p>/etc/prometheus/backbox_exporter.yml</p><pre><code>æ²¡ç©ºæï¼Œå ä¸ªä½</code></pre><h3 id="mysqld-exporter-1"><a href="#mysqld-exporter-1" class="headerlink" title="mysqld_exporter"></a>mysqld_exporter</h3><p>éœ€è¦åˆ›å»ºç”¨äºç›‘æ§çš„æ•°æ®åº“ç”¨æˆ·</p><pre><code>CREATE USER &#39;prometheus&#39;@&#39;127.0.0.1&#39; IDENTIFIED BY &#39;prometheus_password&#39; WITH MAX_USER_CONNECTIONS 3;GRANT PROCESS, REPLICATION CLIENT, SELECT ON *.* TO &#39;prometheus&#39;@&#39;127.0.0.1&#39;;flush privileges;</code></pre><h3 id="postgresql-exporter-1"><a href="#postgresql-exporter-1" class="headerlink" title="postgresql_exporter"></a>postgresql_exporter</h3><p>æ ¹æ®éœ€æ±‚å†³å®šæ˜¯å¦ä½¿ç”¨superuserä½œä¸ºpostgresql_exporterçš„æ•°æ®åº“ç”¨æˆ·</p><p>å¦‚æœè¦åˆ›å»ºä¸“ç”¨ç”¨æˆ·å¯ä»¥å‚ç…§ä¸‹é¢çš„æ–¹å¼åˆ›å»ºç”¨æˆ·</p><pre><code># åˆ›å»ºpostgresql_exporterä¸“ç”¨ç”¨æˆ·CREATE USER postgres_exporter PASSWORD &#39;password&#39;;ALTER USER postgres_exporter SET SEARCH_PATH TO postgres_exporter,pg_catalog;# åˆ›å»ºschemaCREATE SCHEMA postgres_exporter;# æˆæƒschemaGRANT USAGE ON SCHEMA postgres_exporter TO postgres_exporter;# åˆ›å»ºå‡½æ•°CREATE FUNCTION get_pg_stat_activity() RETURNS SETOF pg_stat_activity AS$$ SELECT * FROM pg_catalog.pg_stat_activity; $$LANGUAGE sqlVOLATILESECURITY DEFINER;# åˆ›å»ºè§†å›¾CREATE VIEW postgres_exporter.pg_stat_activityAS  SELECT * from get_pg_stat_activity();# è§†å›¾æˆæƒGRANT SELECT ON postgres_exporter.pg_stat_activity TO postgres_exporter;# åˆ›å»ºå‡½æ•°CREATE FUNCTION get_pg_stat_replication() RETURNS SETOF pg_stat_replication AS$$ SELECT * FROM pg_catalog.pg_stat_replication; $$LANGUAGE sqlVOLATILESECURITY DEFINER;# åˆ›å»ºè§†å›¾CREATE VIEW postgres_exporter.pg_stat_replicationAS  SELECT * FROM get_pg_stat_replication();# è§†å›¾æˆæƒGRANT SELECT ON postgres_exporter.pg_stat_replication TO postgres_exporter;</code></pre><h3 id="grafana-1"><a href="#grafana-1" class="headerlink" title="grafana"></a>grafana</h3><p>/etc/grafana/grafana.ini</p><pre><code>app_mode = production[paths]data = /var/lib/grafanatemp_data_lifetime = 24hlogs = /var/log/grafanaplugins = /var/lib/grafana/plugins[server]protocol = httphttp_port = 3000domain = gkhtroot_url = http://localhost:3000enable_gzip = true[database]log_queries =[remote_cache][session]provider = file[dataproxy][analytics]reporting_enabled = falsecheck_for_updates = false[security]admin_user = adminadmin_password = adminsecret_key = SW2YcwTIb9zpOOhoPsMm[snapshots][dashboards]versions_to_keep = 10[users]default_theme = dark[auth][auth.anonymous]enabled = trueorg_role = Viewer[auth.github][auth.google][auth.generic_oauth][auth.grafana_com][auth.proxy][auth.basic][auth.ldap][smtp][emails][log]mode = console filelevel = info[log.console][log.file]log_rotate = truedaily_rotate = truemax_days = 7[log.syslog][alerting]enabled = trueexecute_alerts = true[explore][metrics]enabled           = trueinterval_seconds  = 10[metrics.graphite][tracing.jaeger][grafana_com]url = https://grafana.com[external_image_storage][external_image_storage.s3][external_image_storage.webdav][external_image_storage.gcs][external_image_storage.azure_blob][external_image_storage.local][rendering][enterprise][panels]</code></pre><h2 id="systemdæœåŠ¡"><a href="#systemdæœåŠ¡" class="headerlink" title="systemdæœåŠ¡"></a>systemdæœåŠ¡</h2><h3 id="prometheus-service"><a href="#prometheus-service" class="headerlink" title="prometheus.service"></a>prometheus.service</h3><p>/usr/lib/systemd/system/prometheus.service</p><pre><code>[Unit]Description=prometheusAfter=network.target[Service]Type=simpleUser=prometheusExecStart=/usr/local/bin/prometheus \          --config.file=/etc/prometheus/prometheus.yml \          --storage.tsdb.path=/var/lib/prometheus \          --storage.tsdb.retention.time=15d \          --storage.tsdb.retention.size=40GB \          --web.console.templates=/etc/prometheus/consoles \          --web.console.libraries=/etc/prometheus/console_librariesExecReload=/bin/kill -HUP $MAINPIDRestart=on-failureRestartSec=60s[Install]WantedBy=multi-user.target</code></pre><h3 id="alertmanager-servicce"><a href="#alertmanager-servicce" class="headerlink" title="alertmanager.servicce"></a>alertmanager.servicce</h3><p>/usr/lib/systemd/system/alertmanager.service</p><pre><code>[Unit]Description=alertmanagerAfter=network.target[Service]Type=simpleUser=prometheusExecStart=/usr/local/bin/alertmanager \          --config.file=/etc/prometheus/alertmanager.yml \          --storage.path=/var/lib/alertmanager \          --data.retention=120hRestart=on-failureRestartSec=60s[Install]WantedBy=multi-user.target</code></pre><h3 id="node-exporter-service"><a href="#node-exporter-service" class="headerlink" title="node_exporter.service"></a>node_exporter.service</h3><p>/usr/lib/systemd/system/node_exporter.service</p><pre><code>[Unit]Description=node_exporterAfter=network.target[Service]Type=simpleUser=prometheusExecStart=/usr/local/bin/node_exporterRestart=on-failureRestartSec=60s[Install]WantedBy=multi-user.target</code></pre><h3 id="blackbox-exporter-service"><a href="#blackbox-exporter-service" class="headerlink" title="blackbox_exporter.service"></a>blackbox_exporter.service</h3><p>/usr/lib/systemd/system/balckbox_exporter.service</p><pre><code>[Unit]Description=blackbox_exporterAfter=network.target[Service]Type=simpleUser=prometheusExecStart=/usr/local/bin/blackbox_exporter \          --config.file=/etc/prometheus/blackbox.yml \          --web.listen-address=:9115 \          --log.level=info          Restart=on-failureRestartSec=60s[Install]WantedBy=multi-user.target</code></pre><h3 id="mysqld-exporter-service"><a href="#mysqld-exporter-service" class="headerlink" title="mysqld_exporter.service"></a>mysqld_exporter.service</h3><p>/usr/lib/systemd/system/mysqld_exporter.service</p><pre><code>[Unit]Description=mysqld_exporterAfter=network.target[Service]Type=simpleUser=prometheusEnvironment=&#39;DATA_SOURCE_NAME=prometheus:prometheus_password@tcp(127.0.0.1:3306)&#39;ExecStart=/usr/local/bin/mysqld_exporter \          --collect.engine_innodb_status \          --collect.info_schema.innodb_metrics \          --collect.info_schema.userstats \          --collect.perf_schema.eventsstatements \          --collect.perf_schema.indexiowaits \          --collect.perf_schema.tableiowaits \          --collect.slave_status \          --log.level=info \          --web.listen-address=:9104 \          --web.telemetry-path=/metricsRestart=on-failureRestartSec=60s[Install]WantedBy=multi-user.target</code></pre><h3 id="postgresql-exporter-service"><a href="#postgresql-exporter-service" class="headerlink" title="postgresql_exporter.service"></a>postgresql_exporter.service</h3><p>/usr/lib/systemd/system/postgresql_exporter.service</p><pre><code>[Unit]Description=postgresql_exporterAfter=network.target[Service]Type=simpleUser=prometheusEnvironment=DATA_SOURCE_NAME=postgresql://postgres_exporter:password@localhost:5432/postgres?sslmode=disableExecStart=/usr/local/bin/postgresql_exporter \          --web.listen-address=:9187 \          --web.telemetry-path=/metrics \          --log.level=info \          --log.format=logger:stderrRestart=on-failureRestartSec=60s[Install]WantedBy=multi-user.target</code></pre><h2 id="å¯åŠ¨æœåŠ¡"><a href="#å¯åŠ¨æœåŠ¡" class="headerlink" title="å¯åŠ¨æœåŠ¡"></a>å¯åŠ¨æœåŠ¡</h2><p>ä¿®æ”¹äº†systemdè„šæœ¬ä¹‹åéœ€è¦reloadä¸€ä¸‹</p><pre><code>systemctl daemon-reload</code></pre><h3 id="prometheus-1"><a href="#prometheus-1" class="headerlink" title="prometheus"></a>prometheus</h3><pre><code>systemctl enable --now prometheus.service</code></pre><h3 id="alertmanager-1"><a href="#alertmanager-1" class="headerlink" title="alertmanager"></a>alertmanager</h3><pre><code>systemctl enable --now alertmanager.service</code></pre><h3 id="node-exporter-1"><a href="#node-exporter-1" class="headerlink" title="node_exporter"></a>node_exporter</h3><pre><code>systemctl enable --now node_exporter.service</code></pre><h3 id="grafana-2"><a href="#grafana-2" class="headerlink" title="grafana"></a>grafana</h3><pre><code>systemctl enable --now grafana.service</code></pre><h3 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h3><blockquote><p>å…¶ä»–æœåŠ¡åŒç†ï¼Œæ‹©éœ€å¯åŠ¨å¯¹åº”çš„æœåŠ¡å³å¯</p></blockquote><h2 id="éªŒè¯æœåŠ¡"><a href="#éªŒè¯æœåŠ¡" class="headerlink" title="éªŒè¯æœåŠ¡"></a>éªŒè¯æœåŠ¡</h2><h3 id="prometheus-2"><a href="#prometheus-2" class="headerlink" title="prometheus"></a>prometheus</h3><p>æµè§ˆå™¨è®¿é—®<code>http://prometheus_server_ip:9090</code></p><h3 id="alertmanager-2"><a href="#alertmanager-2" class="headerlink" title="alertmanager"></a>alertmanager</h3><p>æµè§ˆå™¨è®¿é—®<code>http://prometheus_server_ip:9093</code></p><h3 id="node-exporter-2"><a href="#node-exporter-2" class="headerlink" title="node_exporter"></a>node_exporter</h3><p>æµè§ˆå™¨è®¿é—®<code>http://prometheus_server_ip:9100</code></p><h3 id="grafana-3"><a href="#grafana-3" class="headerlink" title="grafana"></a>grafana</h3><p>æµè§ˆå™¨è®¿é—®<code>http://prometheus_server_ip:3000</code></p><p>é»˜è®¤ç”¨æˆ·å¯†ç <code>admin</code>/<code>admin</code>ï¼Œåˆæ¬¡ç™»å½•éœ€è¦æ”¹å¯†ç </p><h1 id="é…ç½®grafanaç›‘æ§é¢æ¿"><a href="#é…ç½®grafanaç›‘æ§é¢æ¿" class="headerlink" title="é…ç½®grafanaç›‘æ§é¢æ¿"></a>é…ç½®grafanaç›‘æ§é¢æ¿</h1><p><a href="https://grafana.com/dashboards" target="_blank" rel="noopener">è¿™é‡Œ</a>å¾ˆå¤šä½œä¸šå¯ä»¥æŠ„ï¼Œè¿™é‡Œç®€å•åˆ—ä¸¾å‡ ä¸ªæˆ‘ç”¨åˆ°çš„é¢æ¿</p><h2 id="node-exporteré¢æ¿"><a href="#node-exporteré¢æ¿" class="headerlink" title="node_exporteré¢æ¿"></a>node_exporteré¢æ¿</h2><p><a href="https://grafana.com/dashboards/8919" target="_blank" rel="noopener">1 Node Exporter 0.16â€“0.18 for Prometheus ç›‘æ§å±•ç¤ºçœ‹æ¿</a></p><p><img src="https://cdn.nlark.com/yuque/0/2019/jpeg/293789/1558407617091-d0ca215d-674c-49cf-b10e-9d157894413b.jpeg" alt="img"></p><h2 id="mysqld-exporteré¢æ¿"><a href="#mysqld-exporteré¢æ¿" class="headerlink" title="mysqld_exporteré¢æ¿"></a>mysqld_exporteré¢æ¿</h2><p><a href="https://github.com/percona/grafana-dashboards" target="_blank" rel="noopener">Perconaå‡ºå“çš„dashboard</a></p><p><img src="https://cdn.nlark.com/yuque/0/2019/png/293789/1558407620385-f6d98cbe-73b0-46fc-81e6-e68f535538f5.png" alt="img"></p><p><a href="https://grafana.com/dashboards/6239" target="_blank" rel="noopener">ç¬¬ä¸‰æ–¹äººå‘˜æä¾›çš„dashboard</a></p><p><img src="https://cdn.nlark.com/yuque/0/2019/png/293789/1558407617454-4f3f9655-0509-4ed6-a9c1-24cecec00993.png?x-oss-process=image/resize,w_2222" alt="img"></p>]]></content>
      
      
      <categories>
          
          <category> ç›‘æ§ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Prometheus </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç½‘ç»œè§£æä¸æŠ“åŒ…å·¥å…·</title>
      <link href="2020/05/21/wang-luo-jie-xi-yu-zhua-bao-gong-ju/"/>
      <url>2020/05/21/wang-luo-jie-xi-yu-zhua-bao-gong-ju/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h3 id="ç½‘ç»œè§£æä¸æŠ“åŒ…â€“ç®€ä»‹"><a href="#ç½‘ç»œè§£æä¸æŠ“åŒ…â€“ç®€ä»‹" class="headerlink" title="ç½‘ç»œè§£æä¸æŠ“åŒ…â€“ç®€ä»‹"></a>ç½‘ç»œè§£æä¸æŠ“åŒ…â€“ç®€ä»‹</h3><p>æœ¬æ–‡ç®€è¿°ä¸€ä¸‹å†…å®¹ï¼š</p><p>TCPä¸‰æ¬¡æ¡æ‰‹å’Œå››æ¬¡æŒ¥æ‰‹</p><p>ç½‘ç»œåˆ†æå·¥å…·tcpdumpæŠ“åŒ…</p><h5 id="No-1-tcpä¸‰æ¬¡æ¡æ‰‹å’Œå››æ¬¡æŒ¥æ‰‹"><a href="#No-1-tcpä¸‰æ¬¡æ¡æ‰‹å’Œå››æ¬¡æŒ¥æ‰‹" class="headerlink" title="No.1 tcpä¸‰æ¬¡æ¡æ‰‹å’Œå››æ¬¡æŒ¥æ‰‹"></a><strong>No.1 tcpä¸‰æ¬¡æ¡æ‰‹å’Œå››æ¬¡æŒ¥æ‰‹</strong></h5><p>â€”ç¡®è®¤ACK, ä»…å½“ACK=1æ—¶, ç¡®è®¤å·å­—æ®µæ‰æœ‰æ•ˆ. TCPè§„å®šåœ¨è¿æ¥å»ºç«‹åæ‰€æœ‰æŠ¥æ–‡çš„ä¼ è¾“éƒ½å¿…é¡»æŠŠACKç½®1</p><p>â€”åŒæ­¥SYN, åœ¨è¿æ¥å»ºç«‹æ—¶ç”¨æ¥åŒæ­¥åºå·. å½“SYN=1 ACK=0 è¡¨æ˜æ˜¯è¿æ¥è¯·æ±‚æŠ¥æ–‡, è‹¥åŒæ„è¿æ¥åˆ™å“åº”æŠ¥æ–‡ä¸­åº”è¯¥ä½¿SYN=1 ACK=1</p><p>â€”ç»ˆæ­¢FIN, ç”¨æ¥é‡Šæ”¾è¿æ¥. å½“FIN=1è¡¨æ˜æ­¤æŠ¥æ–‡çš„å‘é€æ–¹çš„æ•°æ®å·²ç»å‘é€å®Œæ¯•å¹¶ä¸”è¦æ±‚é‡Šæ”¾</p><h6 id="ä¸‰æ¬¡æ¡æ‰‹-å»ºç«‹è¿æ¥"><a href="#ä¸‰æ¬¡æ¡æ‰‹-å»ºç«‹è¿æ¥" class="headerlink" title="ä¸‰æ¬¡æ¡æ‰‹_å»ºç«‹è¿æ¥"></a>ä¸‰æ¬¡æ¡æ‰‹_å»ºç«‹è¿æ¥</h6><ul><li>ç¬¬ä¸€æ¬¡æ¡æ‰‹:Clientå°†æ ‡å¿—ä½SYNç½®ä¸º1, éšæœºäº§ç”Ÿä¸€ä¸ªå€¼seq=x, å¹¶å°†è¯¥æ•°æ®åŒ…å‘é€ç»™Server, Clientè¿›å…¥SYN_SENTçŠ¶æ€, ç­‰å¾…Serverç¡®è®¤</li><li>ç¬¬äºŒæ¬¡æ¡æ‰‹:Serveræ”¶åˆ°æ•°æ®åŒ…åç”±æ ‡å¿—ä½SYN=1çŸ¥é“Clientè¯·æ±‚å»ºç«‹è¿æ¥, Serverå°†æ ‡å¿—ä½SYNå’ŒACKéƒ½ç½®ä¸º1, ack=x+1, éšæœºäº§ç”Ÿä¸€ä¸ªå€¼seq=y, å¹¶å°†è¯¥æ•°æ®åŒ…å‘é€ç»™Clientä»¥ç¡®è®¤è¿æ¥è¯·æ±‚, Serverè¿›å…¥SYN_RCVDçŠ¶æ€</li><li>ç¬¬ä¸‰æ¬¡æ¡æ‰‹: Clientæ”¶åˆ°ç¡®è®¤å, æ£€æŸ¥ackæ˜¯å¦ä¸ºx+1, ACKæ˜¯å¦ä¸º1, å¦‚æœæ­£ç¡®åˆ™å°†æ ‡å¿—ä½ACKç½®ä¸º1, ack=y+1å¹¶å°†è¯¥æ•°æ®åŒ…å‘é€ç»™Server, Serveræ£€æŸ¥ackæ˜¯å¦ä¸ºy+1, ACKæ˜¯å¦ä¸º1, å¦‚æœæ­£ç¡®åˆ™è¿æ¥å»ºç«‹æˆåŠŸ, Clientå’ŒServerè¿›å…¥ESTABLISHEDçŠ¶æ€, å®Œæˆä¸‰æ¬¡æ¡æ‰‹, éšåClientä¸Serverä¹‹é—´å¯ä»¥å¼€å§‹ä¼ è¾“æ•°æ®äº†</li></ul><p><img src="http://pb3.pstatp.com/large/pgc-image/b58d300a5a7c45e7ae396651edf473a7" alt="img"></p><h6 id="å››æ¬¡æŒ¥æ‰‹-æ–­å¼€è¿æ¥"><a href="#å››æ¬¡æŒ¥æ‰‹-æ–­å¼€è¿æ¥" class="headerlink" title="å››æ¬¡æŒ¥æ‰‹_æ–­å¼€è¿æ¥"></a>å››æ¬¡æŒ¥æ‰‹_æ–­å¼€è¿æ¥</h6><ul><li>ç¬¬ä¸€æ¬¡æŒ¥æ‰‹ï¼šClientå‘é€ä¸€ä¸ªFIN, ç”¨æ¥å…³é—­Clientåˆ°Serverçš„æ•°æ®ä¼ é€, Clientè¿›å…¥FIN_WAIT_1çŠ¶æ€</li><li>ç¬¬äºŒæ¬¡æŒ¥æ‰‹ï¼šServeræ”¶åˆ°FINå, å‘é€ä¸€ä¸ªACKç»™Client, ç¡®è®¤åºå·ä¸ºæ”¶åˆ°åºå·+1, Serverè¿›å…¥CLOSE_WAITçŠ¶</li><li>ç¬¬ä¸‰æ¬¡æŒ¥æ‰‹ï¼šServerå‘é€ä¸€ä¸ªFIN, ç”¨æ¥å…³é—­Serveråˆ°Clientçš„æ•°æ®ä¼ é€, Serverè¿›å…¥LAST_ACKçŠ¶æ€</li><li>ç¬¬å››æ¬¡æŒ¥æ‰‹ï¼šClientæ”¶åˆ°FINå, Clientè¿›å…¥TIME_WAITçŠ¶æ€, æ¥ç€å‘é€ä¸€ä¸ªACKç»™Server, ç¡®è®¤åºå·ä¸ºæ”¶åˆ°åºå·+1, Serverè¿›å…¥CLOSEDçŠ¶æ€, å®Œæˆå››æ¬¡æŒ¥æ‰‹</li></ul><p><img src="http://pb3.pstatp.com/large/pgc-image/5ab36dab139a42e6be52ff4976cc84ea" alt="img"></p><h5 id="No-2-ç½‘ç»œåˆ†æå·¥å…·tcpdumpæŠ“åŒ…"><a href="#No-2-ç½‘ç»œåˆ†æå·¥å…·tcpdumpæŠ“åŒ…" class="headerlink" title="No.2 ç½‘ç»œåˆ†æå·¥å…·tcpdumpæŠ“åŒ…"></a><strong>No.2 ç½‘ç»œåˆ†æå·¥å…·tcpdumpæŠ“åŒ…</strong></h5><p>æŠ“å–tcpçš„ä¸‰æ¬¡æ¡æ‰‹</p><p>tcpdump -S host 192.168.0.108 and 151.101.100.133</p><p><img src="http://pb3.pstatp.com/large/pgc-image/cde15b7285c641cd9ce597ecebf0599e" alt="img"></p><h6 id="æŠ“å–tcpçš„å››æ¬¡æŒ¥æ‰‹"><a href="#æŠ“å–tcpçš„å››æ¬¡æŒ¥æ‰‹" class="headerlink" title="æŠ“å–tcpçš„å››æ¬¡æŒ¥æ‰‹"></a>æŠ“å–tcpçš„å››æ¬¡æŒ¥æ‰‹</h6><p>ï¼ˆç®—äº†ï¼Œæ‡’å¾—å†™äº†ï¼‰åœ¨ä¸Šæ–¹çš„åŸºç¡€ä¸Šæ–­å¼€è¿æ¥å³å¯</p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Tools </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Interview Go_001--undone</title>
      <link href="2020/04/22/interview/interview-go-001/"/>
      <url>2020/04/22/interview/interview-go-001/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h4 id="goï¼š"><a href="#goï¼š" class="headerlink" title="goï¼š"></a>goï¼š</h4><ol><li>è¶…æ—¶é€€å‡º</li><li>contextçš„åˆå§‹å½¢æ€ï¼Ÿæ€ä¹ˆä½¿ç”¨contenxtï¼Ÿ</li><li>wait groupçš„ä½¿ç”¨ï¼Ÿä¸åŠ addç›´æ¥waitæ˜¯å¦ä¼španicï¼Ÿ</li><li>newå’Œmakeæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿå“ªä¸ªå¯ä»¥åˆå§‹åŒ–å†…å­˜ä¸º0ï¼Ÿ</li><li>runtimeæ˜¯ä»€ä¹ˆï¼Ÿruntimeå±äºçº¿ç¨‹è¿˜æ˜¯åç¨‹</li></ol><h4 id="é¡¹ç›®ï¼š"><a href="#é¡¹ç›®ï¼š" class="headerlink" title="é¡¹ç›®ï¼š"></a>é¡¹ç›®ï¼š</h4><ol><li><p>ä»€ä¹ˆæ˜¯JWTï¼ŸJWTæœ‰å‡ éƒ¨åˆ†ç»„æˆï¼Ÿç”¨ä»€ä¹ˆç­¾åç®—æ³•ï¼Ÿå¦‚ä½•å®ç°æŠŠä¸€ä¸ªç”¨æˆ·ä»ç™»é™†çŠ¶æ€è¸¢å‡ºï¼ŸJWTå’Œsessionä»€ä¹ˆåŒºåˆ«ï¼Ÿ</p></li><li><p>ä»€ä¹ˆæ˜¯å‰ç¼€æ ‘ï¼Ÿ</p></li></ol><ol start="3"><li>ginä¸­é—´ä»¶åŸç†ï¼Ÿä¸­é—´ä»¶ç”¨åˆ°äº†ä»€ä¹ˆè®¾è®¡æ¨¡å¼ï¼Ÿ</li></ol><ol start="4"><li>è·¨åŸŸ</li></ol><ol start="5"><li>ginæ–‡ä»¶ä¼ é€çš„æ—¶å€™æ€ä¹ˆæ¥æ”¶ï¼Ÿhttpå¤´éƒ¨çš„content-typeå†™ä»€ä¹ˆ</li></ol>]]></content>
      
      
      <categories>
          
          <category> Interview </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Go </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Interview MySQL_001--undone</title>
      <link href="2020/04/22/interview/interview-mysql-001/"/>
      <url>2020/04/22/interview/interview-mysql-001/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><p>mysqlï¼š</p><ol><li>mysqläº‹åŠ¡çš„éš”ç¦»çº§åˆ«</li></ol><ol start="2"><li>ä»€ä¹ˆæ˜¯ä¹è§‚é”å’Œæ‚²è§‚é”ï¼Ÿä¹è§‚é”çš„ä¸€è‡´æ€§æ€ä¹ˆä¿è¯</li></ol>]]></content>
      
      
      <categories>
          
          <category> Interview </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MySQL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Interview Network_001--undone</title>
      <link href="2020/04/22/interview/interview-network-001/"/>
      <url>2020/04/22/interview/interview-network-001/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><p>ç½‘ç»œ</p><ol><li>httpçš„3æ¬¡æ¡æ‰‹</li></ol><ol start="2"><li>httpsçš„è¿æ¥è¿‡ç¨‹ï¼ŸåŒæ–¹ä½¿ç”¨çš„åŠ å¯†å¥—ä»¶æ˜¯ç”±å®¢æˆ·ç«¯å†³å®šçš„ï¼Œè¿˜æ˜¯æœåŠ¡ç«¯å†³å®šçš„ï¼Ÿ</li></ol>]]></content>
      
      
      <categories>
          
          <category> Interview </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Network </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Interview System_001--undone</title>
      <link href="2020/04/22/interview/interview-system-001/"/>
      <url>2020/04/22/interview/interview-system-001/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><p>æ“ä½œç³»ç»Ÿï¼š</p><ol><li><p>è¿›ç¨‹ã€çº¿ç¨‹ã€åç¨‹æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ4ä¸ªçº¿ç¨‹æ‰§è¡Œ3ä¸ªæ–‡ä»¶å¥æŸ„æ˜¯å…±äº«è¿™3ä¸ªæ–‡ä»¶ä¹ˆï¼Ÿ</p></li><li><p>epollçš„åŸç†è¿‡ç¨‹</p><pre><code>1ã€é¦–å…ˆæ‰§è¡Œepoll_createåœ¨å†…æ ¸ä¸“å±äºepollçš„é«˜é€ŸcacheåŒºï¼Œå¹¶åœ¨è¯¥ç¼“å†²åŒºå»ºç«‹çº¢é»‘æ ‘å’Œå°±ç»ªé“¾è¡¨ï¼Œç”¨æˆ·æ€ä¼ å…¥çš„æ–‡ä»¶å¥æŸ„å°†è¢«æ”¾åˆ°çº¢é»‘æ ‘ä¸­ï¼ˆç¬¬ä¸€æ¬¡æ‹·è´ï¼‰ã€‚2ã€å†…æ ¸é’ˆå¯¹è¯»ç¼“å†²åŒºå’Œå†™ç¼“å†²åŒºæ¥åˆ¤æ–­æ˜¯å¦å¯è¯»å¯å†™ 3ã€epoll_ctlæ‰§è¡ŒaddåŠ¨ä½œæ—¶é™¤äº†å°†æ–‡ä»¶å¥æŸ„æ”¾åˆ°çº¢é»‘æ ‘ä¸Šä¹‹å¤–ï¼Œè¿˜å‘å†…æ ¸æ³¨å†Œäº†è¯¥æ–‡ä»¶å¥æŸ„çš„å›è°ƒå‡½æ•°ï¼Œå†…æ ¸åœ¨æ£€æµ‹åˆ°æŸå¥æŸ„å¯è¯»å¯å†™æ—¶åˆ™è°ƒç”¨è¯¥å›è°ƒå‡½æ•°ï¼Œå›è°ƒå‡½æ•°å°†æ–‡ä»¶å¥æŸ„æ”¾åˆ°å°±ç»ªé“¾è¡¨ã€‚4ã€epoll_waitåªç›‘æ§å°±ç»ªé“¾è¡¨å°±å¯ä»¥ï¼Œå¦‚æœå°±ç»ªé“¾è¡¨æœ‰æ–‡ä»¶å¥æŸ„ï¼Œåˆ™è¡¨ç¤ºè¯¥æ–‡ä»¶å¥æŸ„å¯è¯»å¯å†™ï¼Œå¹¶è¿”å›åˆ°ç”¨æˆ·æ€ï¼ˆå°‘é‡çš„æ‹·è´ï¼‰ï¼›5ã€ç”±äºå†…æ ¸ä¸ä¿®æ”¹æ–‡ä»¶å¥æŸ„çš„ä½ï¼Œå› æ­¤åªéœ€è¦åœ¨ç¬¬ä¸€æ¬¡ä¼ å…¥å°±å¯ä»¥é‡å¤ç›‘æ§ï¼Œç›´åˆ°ä½¿ç”¨epoll_ctlåˆ é™¤ï¼Œå¦åˆ™ä¸éœ€è¦é‡æ–°ä¼ å…¥ï¼Œå› æ­¤æ— å¤šæ¬¡æ‹·è´ã€‚     æ€»ç»“ï¼šepollæ˜¯ç»§æ‰¿äº†select/pollçš„I/Oå¤ç”¨çš„æ€æƒ³ï¼Œå¹¶åœ¨äºŒè€…çš„åŸºç¡€ä¸Šä»ç›‘æ§IOæµã€æŸ¥æ‰¾I/Oäº‹ä»¶ç­‰è§’åº¦æ¥æé«˜æ•ˆç‡ï¼Œå…·ä½“åœ°è¯´å°±æ˜¯å†…æ ¸å¥æŸ„åˆ—è¡¨ã€çº¢é»‘æ ‘ã€å°±ç»ªlisté“¾è¡¨æ¥å®ç°çš„ã€‚</code></pre></li></ol>]]></content>
      
      
      <categories>
          
          <category> Interview </category>
          
      </categories>
      
      
        <tags>
            
            <tag> System </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åˆ†å¸ƒå¼-undone</title>
      <link href="2020/04/22/interview/fen-bu-shi-jian-jie/"/>
      <url>2020/04/22/interview/fen-bu-shi-jian-jie/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h4 id="ä¸‰å¤§-åè®®"><a href="#ä¸‰å¤§-åè®®" class="headerlink" title="ä¸‰å¤§ åè®®"></a>ä¸‰å¤§ åè®®</h4><p>raft zab gossip</p><p>raftæ˜¯etcdç”¨çš„.    zabæ˜¯zookeeprç”¨çš„   gossipæ˜¯redisé›†ç¾¤ç”¨çš„</p><ol><li>raft  ä¸€è¨€ä»¥è”½ä¹‹ å°±æ˜¯ çŠ¶æ€æœº+ æ“ä½œæ—¥å¿— +å¿«ç…§</li></ol><h6 id="è§è§£ï¼š"><a href="#è§è§£ï¼š" class="headerlink" title="è§è§£ï¼š"></a>è§è§£ï¼š</h6><ol><li><p>æ‰€è°“çš„åˆ†å¸ƒå¼ æœ€å…³é”®çš„ å°±æ˜¯  å„ä¸ªèŠ‚ç‚¹ä¹‹é—´â€œäº§ç”Ÿå…³è”â€ï¼Œæ‰€è°“çš„åˆ†å¸ƒå¼ æœ€å…³é”®çš„ å°±æ˜¯  å„ä¸ªèŠ‚ç‚¹ä¹‹é—´â€œäº§ç”Ÿå…³è”â€</p><p>æ‰€è°“çš„åˆ†å¸ƒå¼ æœ€å…³é”®çš„ å°±æ˜¯  å„ä¸ªèŠ‚ç‚¹ä¹‹é—´â€œäº§ç”Ÿå…³è”â€</p><p>å¦‚æœ æ²¡æœ‰â€œå…³è”â€ é‚£ä¹ˆ è¿™åªèƒ½å«åšåˆ†å¼€éƒ¨ç½²</p><p>ä¸€æ—¦æœ‰äº†å…³è”  æ‰å« â€œåˆ†å¸ƒå¼â€œ</p></li></ol><ol start="2"><li><p>åˆ†å¸ƒå¼ æœ‰ç®€å•çš„ åœºæ™¯  æœ€åŸºç¡€çš„æ˜¯ ä¸»ä»</p><p>è­¬å¦‚MySQLä¸»ä»  redisä¸»ä»</p><p>åæ¥é€æ­¥æ¼”åŒ–ä¸º é€‰ä¸»ã€‚ ä¸€æ—¦æœ‰äº†é€‰ä¸» é‚£ä¹ˆå°±çœŸæ­£å«åšé›†ç¾¤äº†</p></li></ol>]]></content>
      
      
      <categories>
          
          <category> Interview </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Go </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Tomcat__05_JVM_æ’éšœå·¥å…·</title>
      <link href="2020/04/02/linux/tomcat/tomcat-05/"/>
      <url>2020/04/02/linux/tomcat/tomcat-05/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h3 id="JVM-è¿ç»´å®ç”¨æ’éšœå·¥å…·"><a href="#JVM-è¿ç»´å®ç”¨æ’éšœå·¥å…·" class="headerlink" title="JVM è¿ç»´å®ç”¨æ’éšœå·¥å…·"></a>JVM è¿ç»´å®ç”¨æ’éšœå·¥å…·</h3><h4 id="1ã€jps"><a href="#1ã€jps" class="headerlink" title="1ã€jps"></a>1ã€jps</h4><pre><code>ç”¨æ¥æŸ¥çœ‹Javaè¿›ç¨‹çš„å…·ä½“çŠ¶æ€, åŒ…æ‹¬è¿›ç¨‹IDï¼Œè¿›ç¨‹å¯åŠ¨çš„è·¯å¾„åŠå¯åŠ¨å‚æ•°ç­‰ç­‰ï¼Œä¸unixä¸Šçš„psç±»ä¼¼ï¼Œåªä¸è¿‡jpsæ˜¯ç”¨æ¥æ˜¾ç¤ºjavaè¿›ç¨‹ï¼Œå¯ä»¥æŠŠjpsç†è§£ä¸ºpsçš„ä¸€ä¸ªå­é›†ã€‚å¸¸ç”¨å‚æ•°å¦‚ä¸‹:-qï¼šå¿½ç•¥è¾“å‡ºçš„ç±»åã€Jaråä»¥åŠä¼ é€’ç»™mainæ–¹æ³•çš„å‚æ•°ï¼Œåªè¾“å‡ºpid-mï¼šè¾“å‡ºä¼ é€’ç»™mainæ–¹æ³•çš„å‚æ•°ï¼Œå¦‚æœæ˜¯å†…åµŒçš„JVMåˆ™è¾“å‡ºä¸ºnull-lï¼šè¾“å‡ºå®Œå…¨çš„åŒ…åï¼Œåº”ç”¨ä¸»ç±»åï¼Œjarçš„å®Œå…¨è·¯å¾„å-vï¼šè¾“å‡ºä¼ ç»™jvmçš„å‚æ•°æ³¨æ„: ä½¿ç”¨jps æ—¶çš„è¿è¡Œè´¦æˆ·è¦å’ŒJVM è™šæ‹Ÿæœºå¯åŠ¨çš„è´¦æˆ·ä¸€è‡´ã€‚è‹¥å¯åŠ¨JVMè™šæ‹Ÿæœºæ˜¯è¿è¡Œçš„è´¦æˆ·ä¸ºwwwï¼Œé‚£ä½¿ç”¨jpsæŒ‡ä»¤æ—¶ï¼Œä¹Ÿè¦ä½¿ç”¨www ç”¨æˆ·å»æŒ‡å®šã€‚ sudo -u www jps</code></pre><p>Example</p><pre class=" language-shell"><code class="language-shell">// æŸ¥çœ‹å·²ç»è¿è¡Œçš„JVM è¿›ç¨‹çš„å®é™…å¯åŠ¨å‚æ•°[root@mouse03 bin]# jps  -v38372 Jps -Dapplication.home=/usr/local/jdk -Xms8m38360 Bootstrap -Djava.util.logging.config.file=/data0/tomcat/conf/logging.properties -Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager -Xms4096m -Xmx4096m -XX:PermSize=1024m -XX:MaxPermSize=2048m -Djdk.tls.ephemeralDHKeySize=2048 -Djava.protocol.handler.pkgs=org.apache.catalina.webresources -Dignore.endorsed.dirs= -Dcatalina.base=/data0/tomcat -Dcatalina.home=/data0/tomcat -Djava.io.tmpdir=/data0/tomcat/temp</code></pre><h4 id="2ã€jstack"><a href="#2ã€jstack" class="headerlink" title="2ã€jstack"></a>2ã€jstack</h4><pre><code>jstackç”¨äºæ‰“å°å‡ºç»™å®šçš„javaè¿›ç¨‹IDæˆ–core fileæˆ–è¿œç¨‹è°ƒè¯•æœåŠ¡çš„Javaå †æ ˆä¿¡æ¯ã€‚å¦‚æœç°åœ¨è¿è¡Œçš„javaç¨‹åºå‘ˆç°hungçš„çŠ¶æ€ï¼Œjstackæ˜¯éå¸¸æœ‰ç”¨çš„ã€‚æ­¤ä¿¡æ¯é€šå¸¸åœ¨è¿ç»´çš„è¿‡ç¨‹ä¸­è¢«ä¿å­˜èµ·æ¥(ä¿å­˜æ•…éšœç°åœº)ï¼Œä»¥ä¾›RDä»¬å»åˆ†ææ•…éšœã€‚å¸¸ç”¨å‚æ•°å¦‚ä¸‹:jstack &lt;pid&gt;jstack [-l] &lt;pid&gt; //é•¿åˆ—è¡¨. æ‰“å°å…³äºé”çš„é™„åŠ ä¿¡æ¯jstack [-F] &lt;pid&gt; //å½“â€™jstack [-l] pidâ€™æ²¡æœ‰å“åº”çš„æ—¶å€™å¼ºåˆ¶æ‰“å°æ ˆä¿¡æ¯</code></pre><p>Example</p><pre class=" language-shell"><code class="language-shell">// æ‰“å°JVM çš„å †æ ˆä¿¡æ¯ï¼Œä»¥ä¾›é—®é¢˜æ’æŸ¥[root@mouse03 ~]# jstack -F 38360 > /tmp/jstack.log</code></pre><h4 id="3ã€jinfo"><a href="#3ã€jinfo" class="headerlink" title="3ã€jinfo"></a>3ã€jinfo</h4><pre><code>å¯ä»¥æŸ¥çœ‹æˆ–ä¿®æ”¹è¿è¡Œæ—¶çš„JVMè¿›ç¨‹çš„å‚æ•°ã€‚å¸¸ç”¨å‚æ•°:jinfo [option] pidwhere &lt;option&gt; is one of:    -flag &lt;name&gt;         to print the value of the named VM flag    -flag [+|-]&lt;name&gt;    to enable or disable the named VM flag    -flag &lt;name&gt;=&lt;value&gt; to set the named VM flag to the given value    -flags               to print VM flags</code></pre><p>Example</p><pre class=" language-shell"><code class="language-shell">// æ ¹æ® PID æŸ¥çœ‹ç›®å‰åˆ†é…çš„æœ€å¤§å †æ ˆ[root@mouse03 ~]# jinfo -flag MaxHeapSize 38360-XX:MaxHeapSize=4294967296// åŠ¨æ€æ›´æ”¹ JVM çš„æœ€å¤§å †æ ˆå€¼[root@mouse03 ~]# jinfo -flag MaxHeapSize=4294967296  38360Exception in thread "main" com.sun.tools.attach.AttachOperationFailedException: flag 'MaxHeapSize' cannot be changed    at sun.tools.attach.LinuxVirtualMachine.execute(LinuxVirtualMachine.java:229)    at sun.tools.attach.HotSpotVirtualMachine.executeCommand(HotSpotVirtualMachine.java:261)    at sun.tools.attach.HotSpotVirtualMachine.setFlag(HotSpotVirtualMachine.java:234)    at sun.tools.jinfo.JInfo.flag(JInfo.java:134)    at sun.tools.jinfo.JInfo.main(JInfo.java:81)// jinfo å¹¶ä¸èƒ½åŠ¨æ€çš„æ”¹å˜æ‰€æœ‰çš„JVM å‚æ•°ã€‚ é‚£åˆ°åº•æœ‰å“ªäº›å‚æ•°èƒ½å¤Ÿè¢«åŠ¨æ€çš„æ”¹å˜å‘¢?// java -XX:+PrintFlagsFinal -version ç­”åº”JVM çš„æ‰€æœ‰å‚æ•°// java -XX:+PrintFlagsFinal -version | grep manageable[root@mouse03 ~]# java -XX:+PrintFlagsFinal -version | grep manageable     intx CMSAbortablePrecleanWaitMillis            = 100                                 {manageable}     intx CMSTriggerInterval                        = -1                                  {manageable}     intx CMSWaitDuration                           = 2000                                {manageable}     bool HeapDumpAfterFullGC                       = false                               {manageable}     bool HeapDumpBeforeFullGC                      = false                               {manageable}     bool HeapDumpOnOutOfMemoryError                = false                               {manageable}    ccstr HeapDumpPath                              =                                     {manageable}    uintx MaxHeapFreeRatio                          = 70                                  {manageable}    uintx MinHeapFreeRatio                          = 40                                  {manageable}     bool PrintClassHistogram                       = false                               {manageable}     bool PrintClassHistogramAfterFullGC            = false                               {manageable}     bool PrintClassHistogramBeforeFullGC           = false                               {manageable}     bool PrintConcurrentLocks                      = false                               {manageable}     bool PrintGC                                   = false                               {manageable}     bool PrintGCDateStamps                         = false                               {manageable}     bool PrintGCDetails                            = false                               {manageable}     bool PrintGCID                                 = false                               {manageable}     bool PrintGCTimeStamps                         = false                               {manageable}// ä¹Ÿåªæœ‰ä»¥ä¸Šè¿™äº›å€¼æ‰èƒ½å¤ŸåŠ¨æ€çš„è¢«æ”¹å˜[root@mouse03 ~]# jinfo -flag CMSWaitDuration=1900  38360# æŸ¥çœ‹ï¼Œ jinfo -flags æŸ¥çœ‹ JVM çš„ flags [root@mouse03 ~]# jinfo -flags 38360Attaching to process ID 38360, please wait...Debugger attached successfully.Server compiler detected.JVM version is 25.91-b14Non-default VM flags: -XX:CICompilerCount=2 -XX:CMSWaitDuration=1900 -XX:InitialHeapSize=4294967296 -XX:MaxHeapSize=4294967296 -XX:MaxNewSize=1431633920 -XX:MinHeapDeltaBytes=196608 -XX:NewSize=1431633920 -XX:OldSize=2863333376 -XX:+UseCompressedClassPointers -XX:+UseCompressedOops -XX:+UseFastUnorderedTimeStampsCommand line:  -Djava.util.logging.config.file=/data0/tomcat/conf/logging.properties -Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager -Xms4096m -Xmx4096m -XX:PermSize=1024m -XX:MaxPermSize=2048m -Djdk.tls.ephemeralDHKeySize=2048 -Djava.protocol.handler.pkgs=org.apache.catalina.webresources -Dignore.endorsed.dirs= -Dcatalina.base=/data0/tomcat -Dcatalina.home=/data0/tomcat -Djava.io.tmpdir=/data0/tomcat/temp</code></pre><h4 id="4ã€jstat"><a href="#4ã€jstat" class="headerlink" title="4ã€jstat"></a>4ã€jstat</h4><pre class=" language-shell"><code class="language-shell">// ç›‘æ§JVM çš„çŠ¶æ€ï¼Œå¸¸ç”¨æŒ‡ä»¤:# jstat -gc 113059 1000 10 // æ‰“å°PID ä¸º 113059 JVM çŠ¶æ€ï¼Œä¸€å…±æ‰“å°10æ¬¡ï¼Œæ¯æ¬¡é—´éš”æ—¶é—´ä¸º1s(1000ms)// æ³¨ jstat çš„ç”¨æ³•è¶…çº§å¼ºå¤§ï¼Œ æˆ‘ä»¬è¿™é‡Œåªæ˜¯åˆ—ä¸¾å‡ºåˆ—å…¶ä¸­ä¸€ä¸ªç®€å•çš„åº”ç”¨ã€‚</code></pre><p>Example</p><pre class=" language-shell"><code class="language-shell"># jstat -gc 113059 1000 10 S0C    S1C    S0U    S1U      EC       EU        OC         OU       PC     PU    YGC     YGCT    FGC    FGCT     GCT195904.0 195904.0  0.0   21610.3 1567680.0 1516721.9 8526272.0  3557507.8  1048576.0 163148.4   2577   92.033   0      0.000   92.033195904.0 195904.0 23600.9  0.0   1567680.0 142541.6 8526272.0  3558435.8  1048576.0 163148.4   2578   92.060   0      0.000   92.060195904.0 195904.0 23600.9  0.0   1567680.0 266338.1 8526272.0  3558435.8  1048576.0 163148.4   2578   92.060   0      0.000   92.060195904.0 195904.0 23600.9  0.0   1567680.0 413941.8 8526272.0  3558435.8  1048576.0 163148.4   2578   92.060   0      0.000   92.060195904.0 195904.0 23600.9  0.0   1567680.0 642390.6 8526272.0  3558435.8  1048576.0 163148.4   2578   92.060   0      0.000   92.060195904.0 195904.0 23600.9  0.0   1567680.0 813957.3 8526272.0  3558435.8  1048576.0 163148.4   2578   92.060   0      0.000   92.060195904.0 195904.0 23600.9  0.0   1567680.0 984223.2 8526272.0  3558435.8  1048576.0 163148.4   2578   92.060   0      0.000   92.060195904.0 195904.0 23600.9  0.0   1567680.0 1155472.7 8526272.0  3558435.8  1048576.0 163148.4   2578   92.060   0      0.000   92.060195904.0 195904.0 23600.9  0.0   1567680.0 1399228.5 8526272.0  3558435.8  1048576.0 163148.4   2578   92.060   0      0.000   92.060195904.0 195904.0  0.0   23866.6 1567680.0 38005.6  8526272.0  3559196.7  1048576.0 163148.4   2579   92.092   0      0.000   92.092</code></pre><p><strong>å­—æ®µæ„ä¹‰å¦‚ä¸‹</strong></p><table><thead><tr><th>åˆ—å</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>S0C</td><td>æ–°ç”Ÿä»£ä¸­Survivor spaceä¸­S0å½“å‰å®¹é‡çš„å¤§å°ï¼ˆKBï¼‰</td></tr><tr><td>S1C</td><td>æ–°ç”Ÿä»£ä¸­Survivor spaceä¸­S1å½“å‰å®¹é‡çš„å¤§å°ï¼ˆKBï¼‰</td></tr><tr><td>S0U</td><td>æ–°ç”Ÿä»£ä¸­Survivor spaceä¸­S0å®¹é‡ä½¿ç”¨çš„å¤§å°ï¼ˆKBï¼‰</td></tr><tr><td>S1U</td><td>æ–°ç”Ÿä»£ä¸­Survivor spaceä¸­S1å®¹é‡ä½¿ç”¨çš„å¤§å°ï¼ˆKBï¼‰</td></tr><tr><td>EC</td><td>Eden spaceå½“å‰å®¹é‡çš„å¤§å°ï¼ˆKBï¼‰</td></tr><tr><td>EU</td><td>Eden spaceå®¹é‡ä½¿ç”¨çš„å¤§å°ï¼ˆKBï¼‰</td></tr><tr><td>OC</td><td>Old spaceå½“å‰å®¹é‡çš„å¤§å°ï¼ˆKBï¼‰</td></tr><tr><td>OU</td><td>Old spaceä½¿ç”¨å®¹é‡çš„å¤§å°ï¼ˆKBï¼‰</td></tr><tr><td>PC</td><td>Permanent spaceå½“å‰å®¹é‡çš„å¤§å°ï¼ˆKBï¼‰</td></tr><tr><td>PU</td><td>Permanent spaceä½¿ç”¨å®¹é‡çš„å¤§å°ï¼ˆKBï¼‰</td></tr><tr><td>YGC</td><td>ä»åº”ç”¨ç¨‹åºå¯åŠ¨åˆ°é‡‡æ ·æ—¶å‘ç”Ÿ Young GC çš„æ¬¡æ•°</td></tr><tr><td>YGCT</td><td>ä»åº”ç”¨ç¨‹åºå¯åŠ¨åˆ°é‡‡æ ·æ—¶ Young GC æ‰€ç”¨çš„æ—¶é—´(ç§’)</td></tr><tr><td>FGC</td><td>ä»åº”ç”¨ç¨‹åºå¯åŠ¨åˆ°é‡‡æ ·æ—¶å‘ç”Ÿ Full GC çš„æ¬¡æ•°</td></tr><tr><td>FGCT</td><td>ä»åº”ç”¨ç¨‹åºå¯åŠ¨åˆ°é‡‡æ ·æ—¶ Full GC æ‰€ç”¨çš„æ—¶é—´(ç§’)</td></tr><tr><td>GCT</td><td>Tä»åº”ç”¨ç¨‹åºå¯åŠ¨åˆ°é‡‡æ ·æ—¶ç”¨äºåƒåœ¾å›æ”¶çš„æ€»æ—¶é—´(å•ä½ç§’)ï¼Œå®ƒçš„å€¼ç­‰äºYGC+FGC</td></tr></tbody></table><h4 id="5ã€jvmtop"><a href="#5ã€jvmtop" class="headerlink" title="5ã€jvmtop"></a>5ã€jvmtop</h4><pre><code>ä»¥ä¸Šä»‹ç»çš„jpsã€jstackã€jinfoç­‰éƒ½æ˜¯å®‰è£…JDK æ—¶è‡ªå¸¦çš„ç³»ç»Ÿåˆ†æå·¥å…·ï¼Œè€Œjvmtopæ˜¯ä¸€æ¬¾å¼€æºçš„JVMå·¥å…·ã€‚å®ƒçš„ä¸‹è½½åœ°å€å¦‚ä¸‹: https://github.com/patric-r/jvmtopé¡¾åæ€ä¹‰ï¼Œå®ƒæ˜¯ä¸€ä¸ªåªé’ˆå¯¹JVMçš„å·¥å…·ï¼Œå±•ç¤ºçš„æ–¹å¼å’Œunixçš„topå‘½ä»¤ç›¸ä¼¼.jvmtop æä¾›äº†ä¸¤ä¸ªè§†å›¾ï¼Œä¸€ä¸ªæ˜¯æ¦‚è§ˆè§†å›¾ï¼Œå¯ä»¥å±•ç¤ºå‡ºå½“å‰æœºå™¨çš„æ‰€æœ‰çš„ JVM çš„æƒ…å†µ. è¿˜æœ‰ä¸€ä¸ªè§†å›¾æ˜¯è¯¦æƒ…è§†å›¾ï¼Œå±•ç¤ºä¸€ä¸ª JVM çš„è¯¦ç»†æƒ…å†µ.</code></pre><p><strong>æ¦‚è§ˆè§†å›¾</strong></p><pre><code>jvmtop.sh</code></pre><p><img src="https://s1.ax1x.com/2020/05/21/YHC9BV.png" alt="YHC9BV.png"></p><pre><code>å…¶ä¸­ï¼Œå„ä¸ªå­—æ®µçš„æ„ä¹‰åˆ†åˆ«å¦‚ä¸‹ï¼šPIDï¼šè¿›ç¨‹ IDMAIN-CLASSï¼šmain ç±»çš„åå­—HPCURï¼šå½“å‰è¢«ä½¿ç”¨çš„ heap çš„å¤§å°HPMAXï¼šæœ€å¤§å¯ç”¨çš„ heap çš„å¤§å°NHCURï¼šå½“å‰è¢«ä½¿ç”¨çš„é heap å¤§å°ï¼ˆæ¯”å¦‚ï¼šperm genï¼‰NHMAXï¼šæœ€å¤§å¯ç”¨çš„é heap å¤§å°CPUï¼šCPU çš„ä½¿ç”¨æƒ…å†µGCï¼šæ¶ˆè€—åœ¨ GC ä¸Šçš„æ—¶é—´æ¯”ä¾‹VMï¼šJVM çš„æä¾›è€…ï¼Œå¤§ç‰ˆæœ¬å·ï¼Œå°ç‰ˆæœ¬å·ï¼Œå›¾ä¸­çš„æ„æ€æ˜¯ Apple æä¾›çš„ JDK 6U51 ç‰ˆæœ¬ã€‚USERNAMEï¼šå½“å‰çš„ç”¨æˆ·å#Tï¼šçº¿ç¨‹æ•°é‡DLï¼šæ˜¯å¦æœ‰ç°æˆå‘ç”Ÿæ­»é”</code></pre><p><strong>è¯¦æƒ…è§†å›¾</strong></p><pre><code>jvmtop.sh &lt;pid&gt;</code></pre><p><img src="https://s1.ax1x.com/2020/05/21/YHCiAU.png" alt="YHCiAU.png"></p><pre><code>å…¶ä¸­ï¼Œå„ä¸ªå­—æ®µçš„æ„ä¹‰å¦‚ä¸‹ï¼šTIDï¼šçº¿ç¨‹ IDNAMEï¼šçº¿ç¨‹åSTATEï¼šçº¿ç¨‹çŠ¶æ€CPUï¼šçº¿ç¨‹å½“å‰çš„ CPU å ç”¨æƒ…å†µTOTALCPUï¼šä»çº¿ç¨‹è¢«åˆ›å»ºå¼€å§‹æ€»ä½“çš„ CPU å ç”¨æƒ…å†µBLOCKBYï¼šé˜»å¡è¿™ä¸ªçº¿ç¨‹çš„çº¿ç¨‹ ID</code></pre>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Tomcat </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Tomcat_04_å®‰å…¨ä¼˜åŒ–</title>
      <link href="2020/03/30/linux/tomcat/tomcat-04/"/>
      <url>2020/03/30/linux/tomcat/tomcat-04/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h4 id="10ã€Tomcatå®‰å…¨ä¼˜åŒ–"><a href="#10ã€Tomcatå®‰å…¨ä¼˜åŒ–" class="headerlink" title="10ã€Tomcatå®‰å…¨ä¼˜åŒ–"></a>10ã€Tomcatå®‰å…¨ä¼˜åŒ–</h4><h5 id="1ã€telnetç®¡ç†ç«¯å£ä¿æŠ¤ï¼ˆå¼ºåˆ¶ï¼‰"><a href="#1ã€telnetç®¡ç†ç«¯å£ä¿æŠ¤ï¼ˆå¼ºåˆ¶ï¼‰" class="headerlink" title="1ã€telnetç®¡ç†ç«¯å£ä¿æŠ¤ï¼ˆå¼ºåˆ¶ï¼‰"></a>1ã€telnetç®¡ç†ç«¯å£ä¿æŠ¤ï¼ˆå¼ºåˆ¶ï¼‰</h5><table><thead><tr><th><strong>ç±»åˆ«</strong></th><th><strong>é…ç½®å†…å®¹åŠè¯´æ˜</strong></th><th><strong>æ ‡å‡†é…ç½®</strong></th><th><strong>å¤‡æ³¨</strong></th></tr></thead><tbody><tr><td>telnetç®¡ç†ç«¯å£ä¿æŠ¤</td><td>1.ä¿®æ”¹é»˜è®¤çš„8005ç®¡ç†ç«¯å£ä¸ºä¸æ˜“çŒœæµ‹çš„ç«¯å£ï¼ˆå¤§äº1024ï¼‰ï¼›2.ä¿®æ”¹SHUTDOWNæŒ‡ä»¤ä¸ºå…¶ä»–å­—ç¬¦ä¸²ï¼›</td><td><Server port="**8527**" shutdown="**dangerous**"></td><td>1.ä»¥ä¸Šé…ç½®é¡¹çš„é…ç½®å†…å®¹åªæ˜¯å»ºè®®é…ç½®ï¼Œå¯ä»¥æŒ‰ç…§æœåŠ¡å®é™…æƒ…å†µè¿›è¡Œåˆç†é…ç½®ï¼Œä½†è¦æ±‚ç«¯å£é…ç½®åœ¨<strong>8000~8999</strong>ä¹‹é—´ï¼›</td></tr></tbody></table><h5 id="2ã€-ajpè¿æ¥ç«¯å£ä¿æŠ¤ï¼ˆæ¨èï¼‰"><a href="#2ã€-ajpè¿æ¥ç«¯å£ä¿æŠ¤ï¼ˆæ¨èï¼‰" class="headerlink" title="2ã€ ajpè¿æ¥ç«¯å£ä¿æŠ¤ï¼ˆæ¨èï¼‰"></a>2ã€ ajpè¿æ¥ç«¯å£ä¿æŠ¤ï¼ˆæ¨èï¼‰</h5><table><thead><tr><th><strong>ç±»åˆ«</strong></th><th><strong>é…ç½®å†…å®¹åŠè¯´æ˜</strong></th><th><strong>æ ‡å‡†é…ç½®</strong></th><th><strong>å¤‡æ³¨</strong></th></tr></thead><tbody><tr><td>Ajp è¿æ¥ç«¯å£ä¿æŠ¤</td><td>1.ä¿®æ”¹é»˜è®¤çš„ajp 8009ç«¯å£ä¸ºä¸æ˜“å†²çªçš„å¤§äº1024ç«¯å£ï¼›2.é€šè¿‡iptablesè§„åˆ™é™åˆ¶ajpç«¯å£è®¿é—®çš„æƒé™ä»…ä¸ºçº¿ä¸Šæœºå™¨ï¼›</td><td>&lt;Connector port=â€<strong>8528</strong>â€œprotocol=â€AJP/1.3â€ /&gt;</td><td>ä»¥ä¸Šé…ç½®é¡¹çš„é…ç½®å†…å®¹ä»…ä¸ºå»ºè®®é…ç½®ï¼Œè¯·æŒ‰ç…§æœåŠ¡å®é™…æƒ…å†µè¿›è¡Œåˆç†é…ç½®ï¼Œä½†è¦æ±‚ç«¯å£é…ç½®åœ¨<strong>8000~8999</strong>ä¹‹é—´ï¼›ï¼›ä¿æŠ¤æ­¤ç«¯å£çš„ç›®çš„åœ¨äºé˜²æ­¢çº¿ä¸‹çš„æµ‹è¯•æµé‡è¢«mod_jkè½¬å‘è‡³çº¿ä¸ŠtomcatæœåŠ¡å™¨ï¼›</td></tr></tbody></table><h5 id="3ã€ç¦ç”¨ç®¡ç†ç«¯ï¼ˆå¼ºåˆ¶ï¼‰"><a href="#3ã€ç¦ç”¨ç®¡ç†ç«¯ï¼ˆå¼ºåˆ¶ï¼‰" class="headerlink" title="3ã€ç¦ç”¨ç®¡ç†ç«¯ï¼ˆå¼ºåˆ¶ï¼‰"></a>3ã€ç¦ç”¨ç®¡ç†ç«¯ï¼ˆå¼ºåˆ¶ï¼‰</h5><table><thead><tr><th><strong>ç±»åˆ«</strong></th><th><strong>é…ç½®å†…å®¹åŠè¯´æ˜</strong></th><th><strong>æ ‡å‡†é…ç½®</strong></th><th><strong>å¤‡æ³¨</strong></th></tr></thead><tbody><tr><td>ç¦ç”¨ç®¡ç†ç«¯</td><td>1. åˆ é™¤é»˜è®¤çš„{Tomcatå®‰è£…ç›®å½•}/conf/tomcat-users.xmlæ–‡ä»¶ï¼Œé‡å¯tomcatåå°†ä¼šè‡ªåŠ¨ç”Ÿæˆæ–°çš„æ–‡ä»¶ï¼›2. åˆ é™¤{Tomcatå®‰è£…ç›®å½•}/webappsä¸‹é»˜è®¤çš„æ‰€æœ‰ç›®å½•å’Œæ–‡ä»¶ï¼›3.å°†tomcat åº”ç”¨æ ¹ç›®å½•é…ç½®ä¸ºtomcatå®‰è£…ç›®å½•ä»¥å¤–çš„ç›®å½•ï¼›</td><td>&lt;Context path=â€â€ docBase=â€<strong>/home/work/local/tomcat**</strong>_webapps**â€debug=â€0â€reloadable=â€falseâ€crossContext=â€trueâ€/&gt;</td><td>å¯¹äºå‰æ®µwebæ¨¡å—ï¼ŒTomcatç®¡ç†ç«¯å±äºtomcatçš„é«˜å±å®‰å…¨éšæ‚£ï¼Œä¸€æ—¦è¢«æ”»ç ´ï¼Œé»‘å®¢é€šè¿‡ä¸Šä¼ web shellçš„æ–¹å¼å°†ä¼šç›´æ¥å–å¾—æœåŠ¡å™¨çš„æ§åˆ¶æƒï¼Œåæœæå…¶ä¸¥é‡ï¼›</td></tr></tbody></table><h5 id="4ã€é™æƒå¯åŠ¨ï¼ˆå¼ºåˆ¶ï¼‰"><a href="#4ã€é™æƒå¯åŠ¨ï¼ˆå¼ºåˆ¶ï¼‰" class="headerlink" title="4ã€é™æƒå¯åŠ¨ï¼ˆå¼ºåˆ¶ï¼‰"></a>4ã€é™æƒå¯åŠ¨ï¼ˆå¼ºåˆ¶ï¼‰</h5><table><thead><tr><th><strong>ç±»åˆ«</strong></th><th><strong>é…ç½®å†…å®¹åŠè¯´æ˜</strong></th><th><strong>æ ‡å‡†é…ç½®</strong></th><th><strong>å¤‡æ³¨</strong></th></tr></thead><tbody><tr><td>é™æƒå¯åŠ¨</td><td>1.tomcatå¯åŠ¨ç”¨æˆ·æƒé™å¿…é¡»ä¸ºérootæƒé™ï¼Œå°½é‡é™ä½tomcatå¯åŠ¨ç”¨æˆ·çš„ç›®å½•è®¿é—®æƒé™ï¼›2.å¦‚éœ€ç›´æ¥å¯¹å¤–ä½¿ç”¨80ç«¯å£ï¼Œå¯é€šè¿‡æ™®é€šè´¦å·å¯åŠ¨åï¼Œé…ç½®iptablesè§„åˆ™è¿›è¡Œè½¬å‘ï¼›</td><td></td><td>é¿å…ä¸€æ—¦tomcat æœåŠ¡è¢«å…¥ä¾µï¼Œé»‘å®¢ç›´æ¥è·å–é«˜çº§ç”¨æˆ·æƒé™å±å®³æ•´ä¸ªserverçš„å®‰å…¨ï¼›</td></tr></tbody></table><pre><code>[root@web03 ~]# useradd tomcat[root@web03 ~]# cp -a /application/tools/tomcat8_1 /home/tomcat/[root@web03 ~]# chown -R tomcat.tomcat /home/tomcat/tomcat8_1/[root@web03 ~]# su -c &#39;/home/tomcat/tomcat8_1/bin/startup.sh&#39; tomcatUsing CATALINA_BASE:   /home/tomcat/tomcat8_1Using CATALINA_HOME:   /home/tomcat/tomcat8_1Using CATALINA_TMPDIR: /home/tomcat/tomcat8_1/tempUsing JRE_HOME:        /application/jdkUsing CLASSPATH:       /home/tomcat/tomcat8_1/bin/bootstrap.jar:/home/tomcat/tomcat8_1/bin/tomcat-juli.jarTomcat started.[root@web03 ~]# ps -ef|grep tomcat</code></pre><h5 id="5ã€æ–‡ä»¶åˆ—è¡¨è®¿é—®æ§åˆ¶ï¼ˆå¼ºåˆ¶ï¼‰"><a href="#5ã€æ–‡ä»¶åˆ—è¡¨è®¿é—®æ§åˆ¶ï¼ˆå¼ºåˆ¶ï¼‰" class="headerlink" title="5ã€æ–‡ä»¶åˆ—è¡¨è®¿é—®æ§åˆ¶ï¼ˆå¼ºåˆ¶ï¼‰"></a>5ã€æ–‡ä»¶åˆ—è¡¨è®¿é—®æ§åˆ¶ï¼ˆå¼ºåˆ¶ï¼‰</h5><table><thead><tr><th><strong>ç±»åˆ«</strong></th><th><strong>é…ç½®å†…å®¹åŠè¯´æ˜</strong></th><th><strong>æ ‡å‡†é…ç½®</strong></th><th><strong>å¤‡æ³¨</strong></th></tr></thead><tbody><tr><td>æ–‡ä»¶åˆ—è¡¨è®¿é—®æ§åˆ¶</td><td>1.conf/web.xmlæ–‡ä»¶ä¸­defaultéƒ¨åˆ†listingsçš„é…ç½®å¿…é¡»ä¸ºfalseï¼›</td><td><init-param><param-name><strong>listings</strong></param-name><param-value><strong>false</strong></param-value></init-param></td><td>falseä¸ºä¸åˆ—å‡ºç›®å½•æ–‡ä»¶ï¼Œtrueä¸ºå…è®¸åˆ—å‡ºï¼Œé»˜è®¤ä¸ºfalseï¼›</td></tr></tbody></table><h5 id="6ã€ç‰ˆæœ¬ä¿¡æ¯éšè—ï¼ˆå¼ºåˆ¶ï¼‰"><a href="#6ã€ç‰ˆæœ¬ä¿¡æ¯éšè—ï¼ˆå¼ºåˆ¶ï¼‰" class="headerlink" title="6ã€ç‰ˆæœ¬ä¿¡æ¯éšè—ï¼ˆå¼ºåˆ¶ï¼‰"></a>6ã€ç‰ˆæœ¬ä¿¡æ¯éšè—ï¼ˆå¼ºåˆ¶ï¼‰</h5><table><thead><tr><th><strong>ç±»åˆ«</strong></th><th><strong>é…ç½®å†…å®¹åŠè¯´æ˜</strong></th><th><strong>æ ‡å‡†é…ç½®</strong></th><th><strong>å¤‡æ³¨</strong></th></tr></thead><tbody><tr><td>ç‰ˆæœ¬ä¿¡æ¯éšè—</td><td>1.ä¿®æ”¹conf/web.xmlï¼Œé‡å®šå‘403ã€404ä»¥åŠ500ç­‰é”™è¯¯åˆ°æŒ‡å®šçš„é”™è¯¯é¡µé¢ï¼›2.ä¹Ÿå¯ä»¥é€šè¿‡ä¿®æ”¹åº”ç”¨ç¨‹åºç›®å½•ä¸‹çš„WEB-INF/web.xmlä¸‹çš„é…ç½®è¿›è¡Œé”™è¯¯é¡µé¢çš„é‡å®šå‘ï¼›</td><td><error-page><error-code><strong>403</strong></error-code><location><strong>/forbidden.jsp</strong></location></error-page><error-page><error-code><strong>404</strong></error-code><location><strong>/notfound.jsp</strong></location></error-page><error-page><error-code><strong>500</strong></error-code><location><strong>/systembusy.jsp</strong></location></error-page></td><td>åœ¨é…ç½®ä¸­å¯¹ä¸€äº›å¸¸è§é”™è¯¯è¿›è¡Œé‡å®šå‘ï¼Œé¿å…å½“å‡ºç°é”™è¯¯æ—¶tomcaté»˜è®¤æ˜¾ç¤ºçš„é”™è¯¯é¡µé¢æš´éœ²æœåŠ¡å™¨å’Œç‰ˆæœ¬ä¿¡æ¯ï¼›å¿…é¡»ç¡®ä¿ç¨‹åºæ ¹ç›®å½•ä¸‹çš„é”™è¯¯é¡µé¢å·²ç»å­˜åœ¨ï¼›</td></tr></tbody></table><h5 id="7ã€Server-headeré‡å†™ï¼ˆæ¨èï¼‰"><a href="#7ã€Server-headeré‡å†™ï¼ˆæ¨èï¼‰" class="headerlink" title="7ã€Server headeré‡å†™ï¼ˆæ¨èï¼‰"></a>7ã€Server headeré‡å†™ï¼ˆæ¨èï¼‰</h5><table><thead><tr><th><strong>ç±»åˆ«</strong></th><th><strong>é…ç½®å†…å®¹åŠè¯´æ˜</strong></th><th><strong>æ ‡å‡†é…ç½®</strong></th><th><strong>å¤‡æ³¨</strong></th></tr></thead><tbody><tr><td>Server headeré‡å†™</td><td>åœ¨HTTP Connectoré…ç½®ä¸­åŠ å…¥serverçš„é…ç½®ï¼›</td><td>server=â€<strong>webserver</strong>â€œ</td><td>å½“tomcat HTTPç«¯å£ç›´æ¥æä¾›webæœåŠ¡æ—¶æ­¤é…ç½®ç”Ÿæ•ˆï¼ŒåŠ å…¥æ­¤é…ç½®ï¼Œå°†ä¼šæ›¿æ¢http å“åº”Server headeréƒ¨åˆ†çš„é»˜è®¤é…ç½®ï¼Œé»˜è®¤æ˜¯<code>Apache-Coyote/1.1</code></td></tr></tbody></table><h5 id="8ã€è®¿é—®é™åˆ¶ï¼ˆå¯é€‰ï¼‰"><a href="#8ã€è®¿é—®é™åˆ¶ï¼ˆå¯é€‰ï¼‰" class="headerlink" title="8ã€è®¿é—®é™åˆ¶ï¼ˆå¯é€‰ï¼‰"></a>8ã€è®¿é—®é™åˆ¶ï¼ˆå¯é€‰ï¼‰</h5><table><thead><tr><th><strong>ç±»åˆ«</strong></th><th><strong>é…ç½®å†…å®¹åŠè¯´æ˜</strong></th><th><strong>æ ‡å‡†é…ç½®æˆ–æ“ä½œ</strong></th><th><strong>å¤‡æ³¨</strong></th></tr></thead><tbody><tr><td>è®¿é—®é™åˆ¶</td><td>é€šè¿‡é…ç½®ï¼Œé™å®šè®¿é—®çš„ipæ¥æº</td><td><Context path="" docBase="/home/work/tomcat" debug="0" reloadable="false" crossContext="true">&lt;Valve className=â€org.apache.catalina.valves.RemoteAddrValveâ€ <strong>allow=â€61.148.18.138,61.135.165.*â€œ deny=â€*.*.*.*â€œ</strong>/&gt;</Context></td><td>é€šè¿‡é…ç½®ä¿¡ä»»ipçš„ç™½åå•ï¼Œæ‹’ç»éç™½åå•ipçš„è®¿é—®ï¼Œæ­¤é…ç½®ä¸»è¦æ˜¯é’ˆå¯¹é«˜ä¿å¯†çº§åˆ«çš„ç³»ç»Ÿï¼Œä¸€èˆ¬äº§å“çº¿ä¸éœ€è¦ï¼›</td></tr></tbody></table><h5 id="9ã€èµ·åœè„šæœ¬æƒé™å›æ”¶ï¼ˆæ¨èï¼‰"><a href="#9ã€èµ·åœè„šæœ¬æƒé™å›æ”¶ï¼ˆæ¨èï¼‰" class="headerlink" title="9ã€èµ·åœè„šæœ¬æƒé™å›æ”¶ï¼ˆæ¨èï¼‰"></a>9ã€èµ·åœè„šæœ¬æƒé™å›æ”¶ï¼ˆæ¨èï¼‰</h5><table><thead><tr><th><strong>ç±»åˆ«</strong></th><th><strong>é…ç½®å†…å®¹åŠè¯´æ˜</strong></th><th><strong>æ ‡å‡†é…ç½®æˆ–æ“ä½œ</strong></th><th><strong>å¤‡æ³¨</strong></th></tr></thead><tbody><tr><td>èµ·åœè„šæœ¬æƒé™å›æ”¶</td><td>å»é™¤å…¶ä»–ç”¨æˆ·å¯¹Tomcatçš„binç›®å½•ä¸‹shutdown.shã€startup.shã€catalina.shçš„å¯æ‰§è¡Œæƒé™ï¼›</td><td>chmod -R 744 tomcat/bin/*</td><td>é˜²æ­¢å…¶ä»–ç”¨æˆ·æœ‰èµ·åœçº¿ä¸ŠTomcatçš„æƒé™ï¼›</td></tr></tbody></table><h5 id="10ã€-è®¿é—®æ—¥å¿—æ ¼å¼è§„èŒƒï¼ˆæ¨èï¼‰"><a href="#10ã€-è®¿é—®æ—¥å¿—æ ¼å¼è§„èŒƒï¼ˆæ¨èï¼‰" class="headerlink" title="10ã€ è®¿é—®æ—¥å¿—æ ¼å¼è§„èŒƒï¼ˆæ¨èï¼‰"></a>10ã€ è®¿é—®æ—¥å¿—æ ¼å¼è§„èŒƒï¼ˆæ¨èï¼‰</h5><table><thead><tr><th><strong>ç±»åˆ«</strong></th><th><strong>é…ç½®å†…å®¹åŠè¯´æ˜</strong></th><th><strong>æ ‡å‡†é…ç½®æˆ–æ“ä½œ</strong></th><th><strong>å¤‡æ³¨</strong></th></tr></thead><tbody><tr><td>è®¿é—®æ—¥å¿—æ ¼å¼è§„èŒƒ</td><td>å¼€å¯Tomcaté»˜è®¤è®¿é—®æ—¥å¿—ä¸­çš„Refererå’ŒUser-Agentè®°å½•</td><td><Valve className="org.apache.catalina.valves.AccessLogValve"                 directory="logs"  prefix="localhost_access_log." suffix=".txt"                 pattern="%h %l %u %t %r %s %b %{Referer}i %{User-Agent}i %D" resolveHosts="false"/></td><td>å¼€å¯Refererå’ŒUser-Agentæ˜¯ä¸ºäº†ä¸€æ—¦å‡ºç°å®‰å…¨é—®é¢˜èƒ½å¤Ÿæ›´å¥½çš„æ ¹æ®æ—¥å¿—è¿›è¡Œé—®é¢˜æ’æŸ¥ï¼›</td></tr></tbody></table><h5 id="11ã€-é™„å½•ï¼šå»ºè®®é…ç½®åŠæ ‡å‡†æ‰§è¡Œæ–¹æ¡ˆ"><a href="#11ã€-é™„å½•ï¼šå»ºè®®é…ç½®åŠæ ‡å‡†æ‰§è¡Œæ–¹æ¡ˆ" class="headerlink" title="11ã€ é™„å½•ï¼šå»ºè®®é…ç½®åŠæ ‡å‡†æ‰§è¡Œæ–¹æ¡ˆ"></a>11ã€ é™„å½•ï¼šå»ºè®®é…ç½®åŠæ ‡å‡†æ‰§è¡Œæ–¹æ¡ˆ</h5><p><strong>1.</strong>       <strong>é…ç½®éƒ¨åˆ†ï¼ˆ**</strong>${ CATALINA_HOME }conf/server.xml<strong>**ï¼‰</strong></p><pre><code>&lt;Server port=&quot;8527&quot; shutdown=&quot; dangerous&quot;&gt;&lt;!-- Define a non-SSL HTTP/1.1 Connector on port 8080 --&gt;&lt;Connector port=&quot;8080&quot; server=&quot;webserver&quot;/&gt; &lt;!-- Define an AJP 1.3 Connector on port 8528 --&gt;&lt;!--Define an accesslog --&gt; &lt;Valve className=&quot;org.apache.catalina.valves.AccessLogValve&quot;                 directory=&quot;logs&quot;  prefix=&quot;localhost_access_log.&quot; suffix=&quot;.txt&quot;                 pattern=&quot;%h %l %u %t %r %s %b %{Referer}i %{User-Agent}i %D&quot; resolveHosts=&quot;false&quot;/&gt;    &lt;Connector port=&quot;8528&quot; protocol=&quot;AJP/1.3&quot; /&gt;&lt;Context path=&quot;&quot; docBase=&quot;/home/work/local/tomcat_webapps&quot; debug=&quot;0&quot; reloadable=&quot;false&quot; crossContext=&quot;true&quot;/&gt;</code></pre><p><strong>2.</strong>       <strong>é…ç½®éƒ¨åˆ†ï¼ˆ**</strong>${ CATALINA_HOME }conf/web.xml<strong><strong>æˆ–è€…</strong></strong>WEB-INF/web.xml<strong>**ï¼‰</strong></p><pre><code>&lt;init-param&gt;    &lt;param-name&gt;listings&lt;/param-name&gt;    &lt;param-value&gt;false&lt;/param-value&gt;&lt;/init-param&gt;&lt;error-page&gt;    &lt;error-code&gt;403&lt;/error-code&gt;    &lt;location&gt;/forbidden.jsp&lt;/location&gt;&lt;/error-page&gt;&lt;error-page&gt;    &lt;error-code&gt;404&lt;/error-code&gt;    &lt;location&gt;/notfound.jsp&lt;/location&gt;&lt;/error-page&gt;&lt;error-page&gt;    &lt;error-code&gt;500&lt;/error-code&gt;    &lt;location&gt;/systembusy.jsp&lt;/location&gt;&lt;/error-page&gt;</code></pre><p><strong>3.</strong>       <strong>åˆ é™¤å¦‚ä¸‹**</strong>tomcat<strong>**çš„é»˜è®¤ç›®å½•å’Œé»˜è®¤æ–‡ä»¶</strong></p><pre><code>tomcat/webapps/*tomcat/conf/tomcat-user.xml</code></pre><p><strong>4.</strong>       <strong>å»é™¤å…¶ä»–ç”¨æˆ·å¯¹**</strong>tomcat** <strong>èµ·åœè„šæœ¬çš„æ‰§è¡Œæƒé™</strong></p><pre><code>chmod 744 â€“R tomcat/bin/*</code></pre><h4 id="11ã€Tomcatæ€§èƒ½ä¼˜åŒ–"><a href="#11ã€Tomcatæ€§èƒ½ä¼˜åŒ–" class="headerlink" title="11ã€Tomcatæ€§èƒ½ä¼˜åŒ–"></a>11ã€Tomcatæ€§èƒ½ä¼˜åŒ–</h4><p>tomcatæ€§èƒ½å–å†³äº å†…å­˜å¤§å°</p><p><strong>ä¸Šç­–ï¼šä¼˜åŒ–ä»£ç </strong></p><p>   è¯¥é¡¹éœ€è¦å¼€å‘ç»éªŒè¶³å¤Ÿä¸°å¯Œï¼Œå¯¹å¼€å‘äººå‘˜è¦æ±‚è¾ƒé«˜</p><p><strong>ä¸­ç­–ï¼šjvm**</strong>ä¼˜åŒ–æœºåˆ¶** <strong>åƒåœ¾å›æ”¶æœºåˆ¶</strong> <strong>æŠŠä¸éœ€è¦çš„å†…å­˜å›æ”¶</strong></p><p>â€‹                  ä¼˜åŒ–jvmâ€“ä¼˜åŒ–åƒåœ¾å›æ”¶ç­–ç•¥</p><p>ä¼˜åŒ–catalina.shé…ç½®æ–‡ä»¶ã€‚åœ¨catalina.shé…ç½®æ–‡ä»¶ä¸­æ·»åŠ ä»¥ä¸‹ä»£ç </p><pre><code># tomcatåˆ†é…1Gå†…å­˜æ¨¡æ¿JAVA_OPTS=&quot;-Djava.awt.headless=true -Dfile.encoding=UTF-8 -server -Xms1024m -Xmx1024m -XX:NewSize=512m -XX:MaxNewSize=512m -XX:PermSize=512m -XX:MaxPermSize=512m&quot;        JAVA_OPTS=&quot;-Djava.awt.headless=true -Dfile.encoding=UTF-8 -server -Xms800m -Xmx800m -XX:NewSize=400m -XX:MaxNewSize=400m -XX:PermSize=400m -XX:MaxPermSize=400m&quot;    # é‡å¯æœåŠ¡su -c &#39;/home/tomcat/tomcat8_1/bin/shutdown.sh&#39; tomcatsu -c &#39;/home/tomcat/tomcat8_1/bin/startup.sh&#39; tomcat</code></pre><p>â€‹         <strong>ä¿®æ”¹ä¹‹å‰</strong></p><p><img src="https://s1.ax1x.com/2020/05/21/YHitTf.png" alt="YHitTf.png"></p><p>â€‹         <strong>ä¿®æ”¹ä¹‹å</strong></p><p><img src="https://s1.ax1x.com/2020/05/21/YHiUk8.png" alt="YHiUk8.png"></p><p><strong>ä¸‹ç­–ï¼šåŠ è¶³å¤Ÿå¤§çš„å†…å­˜</strong></p><p>è¯¥é¡¹çš„èµ„é‡‘æŠ•å…¥è¾ƒå¤§</p><p><strong>ä¸‹ä¸‹ç­–ï¼šæ¯å¤©0**</strong>ç‚¹å®šæ—¶é‡å¯tomcat**</p><p>ä½¿ç”¨è¾ƒä¸ºå¹¿æ³›</p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Tomcat </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kuberneteså¸¸ç”¨å‘½ä»¤</title>
      <link href="2020/03/29/rong-qi/kubernetes-chang-yong-ming-ling/"/>
      <url>2020/03/29/rong-qi/kubernetes-chang-yong-ming-ling/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h4 id="å¸¸ç”¨å‘½ä»¤"><a href="#å¸¸ç”¨å‘½ä»¤" class="headerlink" title="å¸¸ç”¨å‘½ä»¤"></a>å¸¸ç”¨å‘½ä»¤</h4><h5 id="Kubernetes-Cheat-Sheet"><a href="#Kubernetes-Cheat-Sheet" class="headerlink" title="Kubernetes Cheat Sheet"></a>Kubernetes Cheat Sheet</h5><p>Viewing Resource Information     //æŸ¥çœ‹èµ„æºä¿¡æ¯</p><h5 id="Nodes"><a href="#Nodes" class="headerlink" title="Nodes"></a>Nodes</h5><pre><code>$ kubectl get no$ kubectl get no -o wide$ kubectl describe no$ kubectl get no - o yaml$ kubectl get node - - sel ect or =[ l abel _name]$ kubectl get nodes -o jsonpath=&#39; {.items[*].status.addresses [?(@.type==&quot;ExternalIP&quot;)].address}&#39;$ kubectl top node [node_name]</code></pre><h5 id="Pods"><a href="#Pods" class="headerlink" title="Pods"></a>Pods</h5><pre><code>$ kubectl get po -o wide$ kubectl describe po$ kubectl get po$ kubectl get po --show-labels$ kubectl get po -l app=nginx$ kubectl get po -o yaml$ kubectl get pod [pod_name] - o yaml --export$ kubect l get pod [ pod_name] - o yaml --export &gt; nameoffile.yaml$ kubectl get pods -- field-selector status.phase=Running</code></pre><h5 id="Namespaces"><a href="#Namespaces" class="headerlink" title="Namespaces"></a>Namespaces</h5><pre><code>$ kubectl get ns$ kubectl get ns - o yaml$ kubectl describe ns</code></pre><h5 id="Deployments"><a href="#Deployments" class="headerlink" title="Deployments"></a>Deployments</h5><pre><code>$ kubectl get deploy$ kubectl describe deploy$ kubectl get deploy - o wide$ kubectl get deploy - o yaml</code></pre><h5 id="Services"><a href="#Services" class="headerlink" title="Services"></a>Services</h5><pre><code>$ kubectl get svc$ kubectl describe svc$ kubectl get svc - o wide$ kubectl get svc - o yaml$ kubectl get svc --show-labels</code></pre><h5 id="DaemonSets"><a href="#DaemonSets" class="headerlink" title="DaemonSets"></a>DaemonSets</h5><pre><code>$ kubectl get ds$ kubectl get ds --all-namespaces$ kubectl describe ds [daemonset_name] - n [namespce_name]$ kubectl get ds [ds_name] -n [ns_name] -o yaml</code></pre><h5 id="Events"><a href="#Events" class="headerlink" title="Events"></a>Events</h5><pre><code>$ kubectl get events$ kubectl get events -n kube-system$ kubectl get events -w</code></pre><h5 id="logs"><a href="#logs" class="headerlink" title="logs"></a>logs</h5><pre><code>$ kubectl logs [pod_name]$ kubectl logs --since=1h [pod_name]$ kubectl logs --tail =20 [pod_name]$ kubectl logs -f -c [container_name] [pod_name]$ kubectl logs [pod_name] &gt; pod.log</code></pre><h5 id="Service-Accounts"><a href="#Service-Accounts" class="headerlink" title="Service Accounts"></a>Service Accounts</h5><pre><code>$ kubectl get sa$ kubectl get sa -o yaml$ kubectl get serviceaccounts default -o yaml &gt;./sa.yaml$ kubectl replace serviceaccount default -f ./sa.yaml</code></pre><h5 id="ReplicaSets"><a href="#ReplicaSets" class="headerlink" title="ReplicaSets"></a>ReplicaSets</h5><pre><code>$ kubectl get rs$ kubectl describe rs$ kubectl get rs -o wide$ kubectl get rs -o yaml</code></pre><h5 id="Roles"><a href="#Roles" class="headerlink" title="Roles"></a>Roles</h5><pre><code>$ kubectl get roles --all -namespaces$ kubectl get roles --all -namespaces -o yaml</code></pre><h5 id="Secrets"><a href="#Secrets" class="headerlink" title="Secrets"></a>Secrets</h5><pre><code>$ kubectl get secrets$ kubectl get secrets --all -namespaces$ kubectl get secrets -o yaml</code></pre><h5 id="ConfigMaps"><a href="#ConfigMaps" class="headerlink" title="ConfigMaps"></a>ConfigMaps</h5><pre><code>$ kubectl get cm$ kubectl get cm --all-namespaces$ kubectl get cm --all-namespaces -o yaml</code></pre><h5 id="Ingress"><a href="#Ingress" class="headerlink" title="Ingress"></a>Ingress</h5><pre><code>$ kubectl get ing$ kubectl get ing --all-namespaces</code></pre><h5 id="PersistentVolume"><a href="#PersistentVolume" class="headerlink" title="PersistentVolume"></a>PersistentVolume</h5><pre><code>$ kubectl get pv$ kubectl describe pv</code></pre><h5 id="PersistentVolumeClaim"><a href="#PersistentVolumeClaim" class="headerlink" title="PersistentVolumeClaim"></a>PersistentVolumeClaim</h5><pre><code>$ kubectl get pvc$ kubectl describe pvc</code></pre><h5 id="StorageClass"><a href="#StorageClass" class="headerlink" title="StorageClass"></a>StorageClass</h5><pre><code>$ kubectl get sc$ kubectl get sc -o yaml</code></pre><h5 id="Multiple-Resources"><a href="#Multiple-Resources" class="headerlink" title="Multiple Resources"></a>Multiple Resources</h5><pre><code>$ kubectl get svc,po$ kubectl get deploy,no$ kubectl get all$ kubectl get all --all -namespaces</code></pre><p>Changing Resource Attributes  //æ”¹å˜èµ„æºå±æ€§</p><h5 id="Taint"><a href="#Taint" class="headerlink" title="Taint"></a>Taint</h5><pre><code>$ kubectl taint [node_name] [taint_name] </code></pre><h5 id="Labels"><a href="#Labels" class="headerlink" title="Labels"></a>Labels</h5><pre><code>$ kubectl label [node_name] disktype=ssd$ kubectl label [pod_name] env=prod</code></pre><h5 id="Cordon-Uncordon"><a href="#Cordon-Uncordon" class="headerlink" title="Cordon/Uncordon"></a>Cordon/Uncordon</h5><pre><code>$ kubectl cordon [node_name]$ kunectl uncordon [node_name]</code></pre><h5 id="Drain"><a href="#Drain" class="headerlink" title="Drain"></a>Drain</h5><pre><code>$ kubectl drain [node_name]</code></pre><h5 id="Nodes-Pods"><a href="#Nodes-Pods" class="headerlink" title="Nodes/Pods"></a>Nodes/Pods</h5><pre><code>$ kubectl delet enode [node_name]$ kubectl delet epod [pod_name]$ kubectl edit node [node_name]$ kubectl edit pod [pod_name] </code></pre><h5 id="Deployments-Namespaces"><a href="#Deployments-Namespaces" class="headerlink" title="Deployments/Namespaces"></a>Deployments/Namespaces</h5><pre><code>$ kubectl edit deploy [deploy_name]$ kubectl delete deploy [deploy_name]$ kubectl expse deploy [deploy_name] --por=80  -type=NodePort$ kubectl scale deploy [deploy_name] --repicas=5$ kubectl delete ns $ kubectl edit ns [ns_name]</code></pre><h5 id="Services-1"><a href="#Services-1" class="headerlink" title="Services"></a>Services</h5><pre><code>$ kubectl edit svc [svc_name]$ kubectl delete svc [svc_name]</code></pre><h5 id="DaemonSets-1"><a href="#DaemonSets-1" class="headerlink" title="DaemonSets"></a>DaemonSets</h5><pre><code>$ kubectl edit ds [ds_name] -n kube-system$ kubectl delete ds [ds_name]</code></pre><h5 id="Service-Accounts-1"><a href="#Service-Accounts-1" class="headerlink" title="Service Accounts"></a>Service Accounts</h5><pre><code>$ kubectl edit sa [sa_name]$ kubectl delete sa [sa_name]</code></pre><h5 id="Annotate"><a href="#Annotate" class="headerlink" title="Annotate"></a>Annotate</h5><pre><code>$ kubectl annotate po [pod_name] [annotation]$ kubectl annotate no [node_name]</code></pre><p>Adding Resources    //æ·»åŠ èµ„æº</p><h5 id="Creating-a-Pod"><a href="#Creating-a-Pod" class="headerlink" title="Creating a Pod"></a>Creating a Pod</h5><pre><code>$ kubectl create -f [name_of_file]$ kubectl apply -f [name_of_file]$ kubectl run [pod_name] --image=nginx --resart=Never$ kubectl run [pod_name] --geneator=run-pod/v1 --image=nginx$ kubectl run [pod_name] --image=nginx --restart=Never</code></pre><h5 id="Creating-a-Service"><a href="#Creating-a-Service" class="headerlink" title="Creating a Service"></a>Creating a Service</h5><pre><code>$ kubectl create svc nodeport [svc_name] --tcp=8080: 80</code></pre><h5 id="Creating-a-Deployment"><a href="#Creating-a-Deployment" class="headerlink" title="Creating a Deployment"></a>Creating a Deployment</h5><pre><code>$ kubectl create -f [name_of_file]$ kubectl apply -f [name_of_file]$ kubectl create deploy [deploy_name] --image=ngi nx</code></pre><h5 id="Interactive-Pod"><a href="#Interactive-Pod" class="headerlink" title="Interactive Pod"></a>Interactive Pod</h5><pre><code>$ kubectl run [pod_name] --image=busybox --rm -it --restart=Never -- sh</code></pre><h5 id="Output-YAML-to-a-File"><a href="#Output-YAML-to-a-File" class="headerlink" title="Output YAML to a File"></a>Output YAML to a File</h5><pre><code>$ kubectl create deploy [deploy_name] --image=nginx --dry-run -o yaml &gt; depl oy. yaml$ kubectl get po [pod_name] -o yaml --export &gt; pod. yaml</code></pre><h5 id="Getting-Help"><a href="#Getting-Help" class="headerlink" title="Getting Help"></a>Getting Help</h5><pre><code>$ kubectl -h $ kubectl create -h$ kubectl run -h$ kubectl explain deploy.spec</code></pre><p>Requests    //è¯·æ±‚</p><h5 id="API-Call"><a href="#API-Call" class="headerlink" title="API Call"></a>API Call</h5><pre><code>$ kubectl get --raw /apis/metrics.k8s.io/</code></pre><h5 id="Cluster-Info"><a href="#Cluster-Info" class="headerlink" title="Cluster Info"></a>Cluster Info</h5><pre><code>$ kubectl config $ kubectl cluster-info$ kubectl get componentstatuses</code></pre>]]></content>
      
      
      <categories>
          
          <category> å®¹å™¨ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Tomcat_03_ç›‘æ§</title>
      <link href="2020/03/27/linux/tomcat/tomcat-03/"/>
      <url>2020/03/27/linux/tomcat/tomcat-03/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h4 id="9ã€ç›‘æ§tomcaté›†ç¾¤çŠ¶æ€"><a href="#9ã€ç›‘æ§tomcaté›†ç¾¤çŠ¶æ€" class="headerlink" title="9ã€ç›‘æ§tomcaté›†ç¾¤çŠ¶æ€"></a>9ã€ç›‘æ§tomcaté›†ç¾¤çŠ¶æ€</h4><h5 id="1ã€æ–¹æ³•ä¸€ï¼šå¼€å‘javaç›‘æ§é¡µé¢"><a href="#1ã€æ–¹æ³•ä¸€ï¼šå¼€å‘javaç›‘æ§é¡µé¢" class="headerlink" title="1ã€æ–¹æ³•ä¸€ï¼šå¼€å‘javaç›‘æ§é¡µé¢"></a>1ã€æ–¹æ³•ä¸€ï¼šå¼€å‘javaç›‘æ§é¡µé¢</h5><pre><code>[root@web03 tomcat8_1]# cat /application/tomcat/webapps/memtest/meminfo.jsp &lt;%Runtime rtm = Runtime.getRuntime();long mm = rtm.maxMemory()/1024/1024;long tm = rtm.totalMemory()/1024/1024;long fm = rtm.freeMemory()/1024/1024;out.println(&quot;JVM memory detail info :&lt;br&gt;&quot;);out.println(&quot;Max memory:&quot;+mm+&quot;MB&quot;+&quot;&lt;br&gt;&quot;);out.println(&quot;Total memory:&quot;+tm+&quot;MB&quot;+&quot;&lt;br&gt;&quot;);out.println(&quot;Free memory:&quot;+fm+&quot;MB&quot;+&quot;&lt;br&gt;&quot;);out.println(&quot;Available memory can be used is :&quot;+(mm+fm-tm)+&quot;MB&quot;+&quot;&lt;br&gt;&quot;);%&gt;</code></pre><h5 id="2ã€æ–¹æ³•äºŒï¼šä½¿ç”¨jpså‘½ä»¤è¿›è¡Œç›‘æ§"><a href="#2ã€æ–¹æ³•äºŒï¼šä½¿ç”¨jpså‘½ä»¤è¿›è¡Œç›‘æ§" class="headerlink" title="2ã€æ–¹æ³•äºŒï¼šä½¿ç”¨jpså‘½ä»¤è¿›è¡Œç›‘æ§"></a>2ã€æ–¹æ³•äºŒï¼šä½¿ç”¨jpså‘½ä»¤è¿›è¡Œç›‘æ§</h5><pre><code>[root@web03 ~]# jps -lvm31906 org.apache.catalina.startup.Bootstrap start -Djava.util.logging.config.file=/application/tomcat8_1/conf/logging.properties -Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager -Djava.endorsed.dirs=/application/tomcat8_1/endorsed -Dcatalina.base=/application/tomcat8_1 -Dcatalina.home=/application/tomcat8_1 -Djava.io.tmpdir=/application/tomcat8_1/temp31812 org.apache.catalina.startup.Bootstrap start -Djava.util.logging.config.file=/application/tomcat/conf/logging.properties -Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager -Djava.endorsed.dirs=/application/tomcat/endorsed -Dcatalina.base=/application/tomcat -Dcatalina.home=/application/tomcat -Djava.io.tmpdir=/application/tomcat/temp31932 org.apache.catalina.startup.Bootstrap start -Djava.util.logging.config.file=/application/tomcat8_2/conf/logging.properties -Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager -Djava.endorsed.dirs=/application/tomcat8_2/endorsed -Dcatalina.base=/application/tomcat8_2 -Dcatalina.home=/application/tomcat8_2 -Djava.io.tmpdir=/application/tomcat8_2/temp32079 sun.tools.jps.Jps -lvm -Denv.class.path=.:/application/jdk/lib:/application/jdk/jre/lib:/application/jdk/lib/tools.jar -Dapplication.home=/application/jdk1.8.0_60 -Xms8m</code></pre><h5 id="3ã€Tomcatè¿œç¨‹ç›‘æ§åŠŸèƒ½"><a href="#3ã€Tomcatè¿œç¨‹ç›‘æ§åŠŸèƒ½" class="headerlink" title="3ã€Tomcatè¿œç¨‹ç›‘æ§åŠŸèƒ½"></a>3ã€Tomcatè¿œç¨‹ç›‘æ§åŠŸèƒ½</h5><p>ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œå¼€å¯è¿œç¨‹ç›‘æ§</p><pre><code>vim /application/tomcat8_1/bin/catalina.sh +97CATALINA_OPTS=&quot;$CATALINA_OPTS-Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.port=12345  -Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.ssl=false -Djava.rmi.server.hostname=10.0.0.17&quot;</code></pre><p>â€‹         é‡å¯æœåŠ¡ï¼Œæ£€æŸ¥12345ç«¯å£æ˜¯å¦å¼€å¯</p><pre><code>/application/tomcat8_1/bin/shutdown.sh /application/tomcat8_1/bin/startup.sh netstat -tunlp|grep 12345</code></pre><p>â€‹         æ£€æŸ¥ç«¯å£</p><pre><code>[root@web03 ~]# netstat -tunlp|grep 12345tcp6       0      0 :::12345           :::*          LISTEN      33158/java  </code></pre><p><strong>åœ¨windows**</strong>ä¸Šç›‘æ§tomcat**</p><p><strong>æ³¨æ„ï¼šwindwos**</strong>éœ€è¦å®‰è£…jdk<strong>**ç¯å¢ƒï¼</strong></p><p>æŸ¥è€ƒï¼š<a href="http://www.oracle.com/technetwork/java/javase/downloads/index.html" target="_blank" rel="noopener">http://www.oracle.com/technetwork/java/javase/downloads/index.html</a></p><h5 id="4ã€zabbixç›‘æ§tomcatç¨‹åº"><a href="#4ã€zabbixç›‘æ§tomcatç¨‹åº" class="headerlink" title="4ã€zabbixç›‘æ§tomcatç¨‹åº"></a>4ã€zabbixç›‘æ§tomcatç¨‹åº</h5><p>zabbixæ­å»ºè¯¦æƒ…å‚è€ƒï¼š<em><a href="https://www.toutiao.com/i6808897883299906059/" target="_blank" rel="noopener">https://www.toutiao.com/i6808897883299906059/</a></em></p><p>è‹¥æ˜¯æœ‰é—®é¢˜ï¼Œè¯·ç§»æ­¥å®˜ç½‘ ï¼š <em><a href="https://www.zabbix.com/documentation/4.0/zh/manual/installation" target="_blank" rel="noopener">https://www.zabbix.com/documentation/4.0/zh/manual/installation</a></em></p><p><strong>æœåŠ¡ç«¯å®‰è£…é…ç½®java**</strong>ç›‘æ§æœåŠ¡**</p><pre><code>[root@m01 ~]# yum install zabbix-java-gateway -y</code></pre><p><strong>æŸ¥çœ‹é…ç½®æ–‡ä»¶</strong></p><pre><code>é…ç½®æ–‡ä»¶è·¯å¾„ï¼š/etc/zabbix/zabbix_java_gateway.confsed -i -e &#39;220a JavaGateway=127.0.0.1&#39; -e &#39;236a StartJavaPollers=5&#39;  /etc/zabbix/zabbix_server.conf</code></pre><p>å¯åŠ¨zabbix-java-gatewayæœåŠ¡ï¼Œä¸zabbixæœåŠ¡</p><pre><code>systemctl start zabbix-java-gateway.servicesystemctl restart zabbix-server.service</code></pre><p>æ£€æŸ¥javaç«¯å£æ˜¯å¦å¼€å¯</p><pre><code>[root@m01 ~]# netstat -lntup |grep javatcp6       0      0 :::10052   :::*    LISTEN      72971/java  </code></pre><p>â€‹         æ£€æŸ¥javaè¿›ç¨‹æ˜¯å¦å­˜åœ¨</p><pre><code>[root@m01 ~]# ps -ef |grep [j]avazabbix    72971      1  0 11:29 ?        00:00:00 java -server -Dlogback.configurationFile=/etc/zabbix/zabbix_java_gateway_logback.xml -classpath lib:lib/android-json-4.3_r3.1.jar:lib/logback-classic-0.9.27.jar:lib/logback-core-0.9.27.jar:lib/slf4j-api-1.6.1.jar:bin/zabbix-java-gateway-3.0.13.jar -Dzabbix.pidFile=/var/run/zabbix/zabbix_java.pid -Dzabbix.timeout=3 -Dsun.rmi.transport.tcp.responseTimeout=3000 com.zabbix.gateway.JavaGatewayzabbix    73255  73226  0 11:35 ?        00:00:00 /usr/sbin/zabbix_server: java poller #1 [got 0 values in 0.000002 sec, idle 5 sec]zabbix    73256  73226  0 11:35 ?        00:00:00 /usr/sbin/zabbix_server: java poller #2 [got 0 values in 0.000002 sec, idle 5 sec]zabbix    73257  73226  0 11:35 ?        00:00:00 /usr/sbin/zabbix_server: java poller #3 [got 0 values in 0.000002 sec, idle 5 sec]zabbix    73258  73226  0 11:35 ?        00:00:00 /usr/sbin/zabbix_server: java poller #4 [got 0 values in 0.000002 sec, idle 5 sec]zabbix    73259  73226  0 11:35 ?        00:00:00 /usr/sbin/zabbix_server: java poller #5 [got 0 values in 0.000004 sec, idle 5 sec]</code></pre><p><strong>web**</strong>ç•Œé¢æ·»åŠ **</p><p>â€‹         æ·»åŠ ä¸»æœº</p><p><img src="https://s1.ax1x.com/2020/05/21/YHilSH.png" alt="YHilSH.png"> </p><p>â€‹         ä¸»æœºç®¡ç†æ¨¡æ¿ï¼Œæ³¨æ„æ˜¯JMXæ¨¡æ¿</p><p><img src="https://s1.ax1x.com/2020/05/21/YHi36A.png" alt="YHi36A.png">         ç›‘æ§å®Œæˆ</p><p><img src="https://s1.ax1x.com/2020/05/21/YHi8OI.png" alt="YHi8OI.png"> </p><h5 id="5ã€æ’é™¤tomcatæ•…éšœæ­¥éª¤"><a href="#5ã€æ’é™¤tomcatæ•…éšœæ­¥éª¤" class="headerlink" title="5ã€æ’é™¤tomcatæ•…éšœæ­¥éª¤"></a>5ã€æ’é™¤tomcatæ•…éšœæ­¥éª¤</h5><p>a. æŸ¥çœ‹catalina.out</p><p>b. ä½¿ç”¨sh show-busy-java-threads.shè„šæœ¬è¿›è¡Œæ£€æµ‹</p><p>è„šæœ¬ä¸‹è½½åœ°å€</p><p><em><a href="https://files.cnblogs.com/files/clsn/show-busy-java-threads.sh" target="_blank" rel="noopener">https://files.cnblogs.com/files/clsn/show-busy-java-threads.sh</a></em></p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Tomcat </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Tomcat_02_åº”ç”¨éƒ¨ç½²</title>
      <link href="2020/03/25/linux/tomcat/tomcat-02/"/>
      <url>2020/03/25/linux/tomcat/tomcat-02/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h4 id="6ã€WEBç«™ç‚¹éƒ¨ç½²"><a href="#6ã€WEBç«™ç‚¹éƒ¨ç½²" class="headerlink" title="6ã€WEBç«™ç‚¹éƒ¨ç½²"></a>6ã€WEBç«™ç‚¹éƒ¨ç½²</h4><p>ä¸Šçº¿çš„ä»£ç æœ‰ä¸¤ç§æ–¹å¼ï¼š</p><p>ç¬¬ä¸€ç§æ–¹å¼æ˜¯ç›´æ¥å°†ç¨‹åºç›®å½•æ”¾åœ¨webappsç›®å½•ä¸‹é¢ï¼Œè¿™ç§æ–¹å¼å¤§å®¶å·²ç»æ˜ç™½äº†ï¼Œå°±ä¸å¤šè¯´äº†ã€‚</p><p>ç¬¬äºŒç§æ–¹å¼æ˜¯ä½¿ç”¨å¼€å‘å·¥å…·å°†ç¨‹åºæ‰“åŒ…æˆwaråŒ…ï¼Œç„¶åä¸Šä¼ åˆ°webappsç›®å½•ä¸‹é¢ã€‚</p><h5 id="1ã€ä½¿ç”¨waråŒ…éƒ¨ç½²webç«™ç‚¹"><a href="#1ã€ä½¿ç”¨waråŒ…éƒ¨ç½²webç«™ç‚¹" class="headerlink" title="1ã€ä½¿ç”¨waråŒ…éƒ¨ç½²webç«™ç‚¹"></a>1ã€ä½¿ç”¨waråŒ…éƒ¨ç½²webç«™ç‚¹</h5><pre><code>[root@web03 webapps]# pwd/application/tomcat/webapps[root@web03 webapps]# wget http://10.0.0.1/apache/tomcat/memtest.war</code></pre><p>ç«™ç‚¹ä¸»åŠ¨è§£å‹éƒ¨ç½²</p><pre><code>[root@web03 webapps]# lsdocs  examples  host-manager  logs  manager  memtest  memtest.war  ROOT</code></pre><p>æµè§ˆå™¨è®¿é—®ï¼š</p><p><em><a href="http://10.0.0.17:8080//memtest/meminfo.jsp" target="_blank" rel="noopener">http://10.0.0.17:8080//memtest/meminfo.jsp</a></em></p><p><img src="https://s1.ax1x.com/2020/05/21/YHPrdK.png" alt="YHPrdK.png"></p><h5 id="2ã€è‡ªå®šä¹‰é»˜è®¤ç½‘ç«™ç›®å½•"><a href="#2ã€è‡ªå®šä¹‰é»˜è®¤ç½‘ç«™ç›®å½•" class="headerlink" title="2ã€è‡ªå®šä¹‰é»˜è®¤ç½‘ç«™ç›®å½•"></a>2ã€è‡ªå®šä¹‰é»˜è®¤ç½‘ç«™ç›®å½•</h5><p>ä¸Šé¢è®¿é—®çš„ç½‘å€ä¸º <em><a href="http://10.0.0.3:8080/memtest/meminfo.jsp" target="_blank" rel="noopener">http://10.0.0.3:8080/memtest/meminfo.jsp</a></em></p><p>ç°åœ¨æƒ³è®¿é—®æ ¼å¼ä¸º<em><a href="http://10.0.0.3:8080/meminfo.jsp" target="_blank" rel="noopener">http://10.0.0.3:8080/meminfo.jsp</a></em></p><p><strong>æ–¹æ³•ä¸€</strong></p><p>å°†meminfo.jspæˆ–å…¶ä»–ç¨‹åºæ”¾åœ¨tomcat/webapps/ROOTç›®å½•ä¸‹å³å¯ã€‚å› ä¸ºé»˜è®¤ç½‘ç«™æ ¹ç›®å½•ä¸ºtomcat/webapps/ROOT</p><p><strong>æ–¹æ³•äºŒ</strong></p><pre><code>[root@web03 ~]# vim /application/tomcat/conf/server.xml +125â€¦â€¦ #æ·»åŠ ä¸Šè¿™ä¸¤è¡Œ        &lt;Context path=&quot;&quot; docBase=&quot;/application/tomcat/webapps/memtest&quot; debug=&quot;0&quot; reloadable=&quot;false&quot; crossContext=&quot;true&quot;/&gt;        &lt;Context path=&quot;/40team&quot; docBase=&quot;/application/tomcat/webapps/memtest&quot; debug=&quot;0&quot; reloadable=&quot;false&quot; crossContext=&quot;true&quot;/&gt;â€¦â€¦</code></pre><p>ä¿®æ”¹é…ç½®æ–‡ä»¶åï¼Œè¦é‡å¯æœåŠ¡</p><pre><code>[root@web03 ~]# /application/tomcat/bin/shutdown.sh [root@web03 ~]# /application/tomcat/bin/startup.sh  </code></pre><h5 id="3ã€éƒ¨ç½²å¼€æºç«™ç‚¹ï¼ˆjpressï¼‰"><a href="#3ã€éƒ¨ç½²å¼€æºç«™ç‚¹ï¼ˆjpressï¼‰" class="headerlink" title="3ã€éƒ¨ç½²å¼€æºç«™ç‚¹ï¼ˆjpressï¼‰"></a>3ã€éƒ¨ç½²å¼€æºç«™ç‚¹ï¼ˆjpressï¼‰</h5><p>jpresså®˜ç½‘ï¼š<a href="http://jpress.io" target="_blank" rel="noopener">http://jpress.io</a></p><p>ä¸‹è½½åœ°å€ï¼š<a href="https://github.com/JpressProjects/jpress" target="_blank" rel="noopener">https://github.com/JpressProjects/jpress</a></p><p>â€‹         ç¬¬ä¸€ä¸ªé‡Œç¨‹ç¢‘ï¼šå®‰è£…é…ç½®æ•°æ®åº“</p><pre><code>yum -y install mariadb-serversystemctl start mariadb.service</code></pre><p>â€‹         #é…ç½®æ•°æ®åº“</p><pre><code>mysqlcreate database jpress DEFAULT CHARACTER SET utf8;grant all on jpress.* to jpress@&#39;localhost&#39; identified by &#39;123456&#39;;exit</code></pre><p>â€‹         ç¬¬äºŒä¸ªé‡Œç¨‹ç¢‘ï¼šjpressç«™ç‚¹ä¸Šçº¿</p><pre><code>[root@web03 webapps]# pwd/application/tomcat/webapps[root@web03 webapps]# wget http://10.0.0.1/apache/tomcat/jpress-web-newest.war</code></pre><p>â€‹         ç¬¬ä¸‰ä¸ªé‡Œç¨‹ç¢‘ï¼šæµè§ˆå™¨è®¿é—®</p><p>æµè§ˆå™¨è®¿é—®ï¼š <a href="http://10.0.0.17:8080/jpress-web-newest/install" target="_blank" rel="noopener">http://10.0.0.17:8080/jpress-web-newest/install</a></p><p><img src="https://s1.ax1x.com/2020/05/21/YHPsIO.png" alt="YHPsIO.png"></p><p>å¡«å†™æ•°æ®åº“ä¿¡æ¯</p><p><img src="https://s1.ax1x.com/2020/05/21/YHPWQA.png" alt="YHPWQA.png"></p><p>è®¾ç½®ç«™ç‚¹åç§°ç­‰</p><p><img src="https://s1.ax1x.com/2020/05/21/YHPIdf.png" alt="YHPIdf.png"></p><p>å®‰è£…å®Œæˆ</p><p><img src="https://s1.ax1x.com/2020/05/21/YHP7FS.png" alt="YHP7FS.png"></p><p>é‡å¯tomcatæœåŠ¡</p><pre><code>[root@web03 ~]# /application/tomcat/bin/shutdown.sh [root@web03 ~]# /application/tomcat/bin/startup.sh  </code></pre><h4 id="7ã€Tomcatå¤šå®ä¾‹é…ç½®"><a href="#7ã€Tomcatå¤šå®ä¾‹é…ç½®" class="headerlink" title="7ã€Tomcatå¤šå®ä¾‹é…ç½®"></a>7ã€Tomcatå¤šå®ä¾‹é…ç½®</h4><p><strong>å¤šè™šæ‹Ÿä¸»æœº</strong>ï¼šnginx å¤šä¸ªServeræ ‡ç­¾ï¼ˆåŸŸåï¼Œipï¼Œç«¯å£ï¼‰ è¿›ç¨‹æ•°é‡å›ºå®š master+worker</p><p><strong>å¤šå®ä¾‹ï¼ˆå¤šè¿›ç¨‹ï¼‰</strong>ï¼šåŒä¸€ä¸ªç¨‹åºå¯åŠ¨å¤šæ¬¡ï¼Œåˆ†ä¸ºä¸¤ç§æƒ…å†µ:</p><p>ç¬¬ä¸€ç§ï¼šä¸€å°æœºå™¨è·‘å¤šä¸ªç«™ç‚¹ï¼› </p><p>ç¬¬äºŒç§ï¼šä¸€ä¸ªæœºå™¨è·‘ä¸€ä¸ªç«™ç‚¹å¤šä¸ªå®ä¾‹ï¼Œé…åˆè´Ÿè½½å‡è¡¡</p><h5 id="1ã€å¤åˆ¶ç¨‹åºæ–‡ä»¶"><a href="#1ã€å¤åˆ¶ç¨‹åºæ–‡ä»¶" class="headerlink" title="1ã€å¤åˆ¶ç¨‹åºæ–‡ä»¶"></a>1ã€å¤åˆ¶ç¨‹åºæ–‡ä»¶</h5><pre><code>    cd /application/tools/    tar xf apache-tomcat-8.0.27.tar.gz    cp -a apache-tomqcat-8.0.27 tomcat8_1    cp -a apache-tomcat-8.0.27 tomcat8_2</code></pre><p>ä¿®æ”¹ç«¯å£ï¼Œä»¥å¯åŠ¨å¤šå®ä¾‹ã€‚å¤šå®ä¾‹ä¹‹é—´ç«¯å£ä¸èƒ½ä¸€è‡´</p><pre><code>sed -i &#39;s#8005#8011#;s#8080#8081#&#39; tomcat8_1/conf/server.xmlsed -i &#39;s#8005#8012#;s#8080#8082#&#39; tomcat8_2/conf/server.xml[root@web03 application]# diff tomcat8_1/conf/server.xml tomcat8_2/conf/server.xml22c22&lt; &lt;Server port=&quot;8011&quot; shutdown=&quot;SHUTDOWN&quot;&gt;---&gt; &lt;Server port=&quot;8012&quot; shutdown=&quot;SHUTDOWN&quot;&gt;67c67&lt;          Define a non-SSL/TLS HTTP/1.1 Connector on port 8081---&gt;          Define a non-SSL/TLS HTTP/1.1 Connector on port 808269c69&lt;     &lt;Connector port=&quot;8081&quot; protocol=&quot;HTTP/1.1&quot;---&gt;     &lt;Connector port=&quot;8082&quot; protocol=&quot;HTTP/1.1&quot;75c75&lt;                port=&quot;8081&quot; protocol=&quot;HTTP/1.1&quot;---&gt;                port=&quot;8082&quot; protocol=&quot;HTTP/1.1&quot;</code></pre><p>ã€€ã€€ å°†é…ç½®å¥½çš„tomcatç¨‹åºæ‰“åŒ…ï¼Œä»¥å¤‡ä¹‹åä½¿ç”¨</p><pre><code>tar zcf muti_tomcat8.tar.gz ./tomcat8_1 ./tomcat8_2</code></pre><p>å¯åŠ¨tomcatå¤šå®ä¾‹</p><pre><code> /application/tomcat8_1/bin/startup.sh  /application/tomcat8_2/bin/startup.sh</code></pre><p>æ£€æŸ¥ç«¯å£æ˜¯å¦å¯åŠ¨</p><pre><code>[root@web03 tomcat8_1]# netstat -lntup |grep javatcp6   0   0 127.0.0.1:8011    :::*    LISTEN   31906/javatcp6   0   0 127.0.0.1:8012    :::*    LISTEN   31932/javatcp6   0   0 :::8080           :::*    LISTEN   31812/javatcp6   0   0 :::8081           :::*    LISTEN   31906/javatcp6   0   0 :::8082           :::*    LISTEN   31932/javatcp6   0   0 127.0.0.1:8005    :::*    LISTEN   31812/javatcp6   0   0 :::8009           :::*    LISTEN   31812/java</code></pre><p>å°†æ¯ä¸ªå®ä¾‹çš„ç½‘é¡µè¿›è¡ŒåŒºåˆ†</p><pre><code>echo 8081 &gt;&gt;/application/tomcat8_1/webapps/ROOT/index.jsp echo 8082 &gt;&gt;/application/tomcat8_2/webapps/ROOT/index.jsp</code></pre><h5 id="2ã€åœ¨æµè§ˆå™¨è®¿é—®ï¼Œè¿›è¡Œæµ‹è¯•"><a href="#2ã€åœ¨æµè§ˆå™¨è®¿é—®ï¼Œè¿›è¡Œæµ‹è¯•" class="headerlink" title="2ã€åœ¨æµè§ˆå™¨è®¿é—®ï¼Œè¿›è¡Œæµ‹è¯•"></a>2ã€åœ¨æµè§ˆå™¨è®¿é—®ï¼Œè¿›è¡Œæµ‹è¯•</h5><p>æ£€æŸ¥å¤šå®ä¾‹çš„å¯åŠ¨</p><p>â€‹                  <a href="http://10.0.0.17:8082" target="_blank" rel="noopener">http://10.0.0.17:8082</a></p><p><img src="https://s1.ax1x.com/2020/05/21/YHPbWQ.png" alt="YHPbWQ.png"></p><p><a href="http://10.0.0.17:8081" target="_blank" rel="noopener">http://10.0.0.17:8081</a></p><p><img src="https://s1.ax1x.com/2020/05/21/YHPXyn.png" alt="YHPXyn.png"></p><h4 id="8ã€tomcatåå‘ä»£ç†é›†ç¾¤"><a href="#8ã€tomcatåå‘ä»£ç†é›†ç¾¤" class="headerlink" title="8ã€tomcatåå‘ä»£ç†é›†ç¾¤"></a>8ã€tomcatåå‘ä»£ç†é›†ç¾¤</h4><h5 id="1ã€è´Ÿè½½å‡è¡¡å™¨è¯´æ˜"><a href="#1ã€è´Ÿè½½å‡è¡¡å™¨è¯´æ˜" class="headerlink" title="1ã€è´Ÿè½½å‡è¡¡å™¨è¯´æ˜"></a>1ã€è´Ÿè½½å‡è¡¡å™¨è¯´æ˜</h5><pre><code>[root@lb01 ~]# cat /etc/redhat-release CentOS release 6.9 (Final)[root@lb01 ~]# uname -aLinux lb01 2.6.32-696.el6.x86_64 #1 SMP Tue Mar 21 19:29:05 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux[root@lb01 ~]# getenforce Disabled[root@lb01 ~]# /etc/init.d/iptables statusiptables: Firewall is not running.</code></pre><p>è´Ÿè½½å‡è¡¡è½¯ä»¶ä½¿ç”¨nginxï¼Œè¯¦æƒ…å‚ç…§</p><p><a href="http://www.cnblogs.com/clsn/p/7750615.html" target="_blank" rel="noopener">http://www.cnblogs.com/clsn/p/7750615.html</a></p><h5 id="2ã€é…ç½®è´Ÿè½½å‡è¡¡å™¨"><a href="#2ã€é…ç½®è´Ÿè½½å‡è¡¡å™¨" class="headerlink" title="2ã€é…ç½®è´Ÿè½½å‡è¡¡å™¨"></a>2ã€é…ç½®è´Ÿè½½å‡è¡¡å™¨</h5><p>å¤‡ä»½åŸé…ç½®æ–‡ä»¶</p><pre><code>mv  /application/nginx/conf/nginx.conf{,.20171127}    egrep -v &#39;#|^$&#39; /application/nginx/conf/nginx.conf.default  &gt; /application/nginx/conf/nginx.conf</code></pre><p>â€‹         é…ç½®æ–‡ä»¶å†…å®¹</p><pre><code>[root@lb01 ~]# cat /application/nginx/conf/nginx.confworker_processes  1;events {    worker_connections  1024;}http {    include       mime.types;    default_type  application/octet-stream;    sendfile        on;    keepalive_timeout  65;    upstream web_pools {        server 10.0.0.17:8081;        server 10.0.0.17:8082;    }    server {        listen       80;        server_name  localhost;        location / {            root   html;            index  index.jsp index.htm;        proxy_pass http://web_pools;        }        error_page   500 502 503 504  /50x.html;        location = /50x.html {            root   html;        }    }}</code></pre><p>â€‹         é…ç½®å®Œæˆåé‡å¯nginxæœåŠ¡</p><pre><code>/application/nginx/sbin/nginx  -s stop /application/nginx/sbin/nginx</code></pre><h5 id="3ã€ä½¿ç”¨å‘½ä»¤è¿›è¡Œè®¿é—®æµ‹è¯•"><a href="#3ã€ä½¿ç”¨å‘½ä»¤è¿›è¡Œè®¿é—®æµ‹è¯•" class="headerlink" title="3ã€ä½¿ç”¨å‘½ä»¤è¿›è¡Œè®¿é—®æµ‹è¯•"></a>3ã€ä½¿ç”¨å‘½ä»¤è¿›è¡Œè®¿é—®æµ‹è¯•</h5><p>ä½¿ç”¨curl å‘½ä»¤è¿›è¡Œæµ‹è¯•ï¼Œtailè¿›è¡Œå…³é”®å­—æå–</p><pre><code>[root@lb01 ~]# curl -s 10.0.0.5|tail -18081[root@lb01 ~]# curl -s 10.0.0.5|tail -18082</code></pre><p>ä½¿ç”¨curl å‘½ä»¤è¿›è¡Œæµ‹è¯•ï¼Œawkè¿›è¡Œå…³é”®å­—æå–</p><pre><code>[root@lb01 ~]# curl -s 10.0.0.5|awk &#39;END{print}&#39;8082[root@lb01 ~]# curl -s 10.0.0.5|awk &#39;END{print}&#39;8081</code></pre><p> ä½¿ç”¨curl å‘½ä»¤è¿›è¡Œæµ‹è¯•ï¼Œsedè¿›è¡Œå…³é”®å­—æå–</p><pre><code>[root@lb01 ~]# curl -s 10.0.0.5|sed -n &#39;$p&#39;8082[root@lb01 ~]# curl -s 10.0.0.5|sed -n &#39;$p&#39;8081</code></pre><h5 id="4ã€åœ¨æµè§ˆå™¨ä¸Šè¿›è¡Œè®¿é—®æµ‹è¯•"><a href="#4ã€åœ¨æµè§ˆå™¨ä¸Šè¿›è¡Œè®¿é—®æµ‹è¯•" class="headerlink" title="4ã€åœ¨æµè§ˆå™¨ä¸Šè¿›è¡Œè®¿é—®æµ‹è¯•"></a>4ã€åœ¨æµè§ˆå™¨ä¸Šè¿›è¡Œè®¿é—®æµ‹è¯•</h5><p><img src="https://s1.ax1x.com/2020/05/21/YHPjLq.png" alt="YHPjLq.png"></p><p><img src="https://s1.ax1x.com/2020/05/21/YHPxe0.png" alt="YHPxe0.png"></p><p>â€‹         å»ºè®®ä½¿ç”¨googleæµè§ˆå™¨chrome çš„éšèº«æ¨¡å¼è¿›è¡Œè®¿é—®ï¼Œä½¿ç”¨ctrl+f5 è¿›è¡Œå¼ºåˆ¶åˆ·æ–°</p><h4 id=""><a href="#" class="headerlink" title=""></a></h4>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Tomcat </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Tomcat_01_ç®€ä»‹</title>
      <link href="2020/03/21/linux/tomcat/tomcat-01/"/>
      <url>2020/03/21/linux/tomcat/tomcat-01/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h4 id="1ã€Tomcat-ç®€ä»‹"><a href="#1ã€Tomcat-ç®€ä»‹" class="headerlink" title="1ã€Tomcat ç®€ä»‹"></a><strong>1ã€Tomcat ç®€ä»‹</strong></h4><p>Tomcatæ˜¯Apacheè½¯ä»¶åŸºé‡‘ä¼šï¼ˆApache Software Foundationï¼‰çš„Jakarta é¡¹ç›®ä¸­çš„ä¸€ä¸ªæ ¸å¿ƒé¡¹ç›®ï¼Œç”±Apacheã€Sunå’Œå…¶ä»–ä¸€äº›å…¬å¸åŠä¸ªäººå…±åŒå¼€å‘è€Œæˆã€‚</p><p>TomcatæœåŠ¡å™¨æ˜¯ä¸€ä¸ªå…è´¹çš„å¼€æ”¾æºä»£ç çš„Webåº”ç”¨æœåŠ¡å™¨ï¼Œå±äºè½»é‡çº§åº”ç”¨æœåŠ¡å™¨ï¼Œåœ¨ä¸­å°å‹ç³»ç»Ÿå’Œå¹¶å‘è®¿é—®ç”¨æˆ·ä¸æ˜¯å¾ˆå¤šçš„åœºåˆä¸‹è¢«æ™®éä½¿ç”¨ï¼Œæ˜¯å¼€å‘å’Œè°ƒè¯•JSPç¨‹åºçš„é¦–é€‰ã€‚</p><p>Tomcatå’ŒNginxã€Apache(httpd)ã€lighttpdç­‰WebæœåŠ¡å™¨ä¸€æ ·ï¼Œå…·æœ‰å¤„ç†HTMLé¡µé¢çš„åŠŸèƒ½ï¼Œå¦å¤–å®ƒè¿˜æ˜¯ä¸€ä¸ªServletå’ŒJSPå®¹å™¨ï¼Œç‹¬ç«‹çš„Servletå®¹å™¨æ˜¯Tomcatçš„é»˜è®¤æ¨¡å¼ã€‚ä¸è¿‡ï¼ŒTomcatå¤„ç†é™æ€HTMLçš„èƒ½åŠ›ä¸å¦‚Nginx/ApacheæœåŠ¡å™¨ã€‚</p><p>ç›®å‰Tomcatæœ€æ–°ç‰ˆæœ¬ä¸º9.0ã€‚Javaå®¹å™¨è¿˜æœ‰resinã€weblogicç­‰ã€‚</p><p><strong>Tomcat**</strong>å®˜ç½‘ï¼š** <a href="http://tomcat.apache.org/" target="_blank" rel="noopener">http://tomcat.apache.org</a></p><h5 id="1ã€Tomcatå¥½å¸®æ‰‹â€”JDK"><a href="#1ã€Tomcatå¥½å¸®æ‰‹â€”JDK" class="headerlink" title="1ã€Tomcatå¥½å¸®æ‰‹â€”JDK"></a>1ã€Tomcatå¥½å¸®æ‰‹â€”JDK</h5><p>JDKæ˜¯ Java è¯­è¨€çš„è½¯ä»¶å¼€å‘å·¥å…·åŒ…ï¼Œä¸»è¦ç”¨äºç§»åŠ¨è®¾å¤‡ã€åµŒå…¥å¼è®¾å¤‡ä¸Šçš„javaåº”ç”¨ç¨‹åºã€‚JDKæ˜¯æ•´ä¸ªjavaå¼€å‘çš„æ ¸å¿ƒï¼Œå®ƒåŒ…å«äº†JAVAçš„è¿è¡Œç¯å¢ƒï¼ˆJVM+Javaç³»ç»Ÿç±»åº“ï¼‰å’ŒJAVAå·¥å…·ã€‚</p><p><strong>JDK**</strong>åŒ…å«äº†ä¸€æ‰¹ç”¨äºJava<strong>**å¼€å‘çš„ç»„ä»¶ï¼Œå…¶ä¸­åŒ…æ‹¬ï¼š</strong></p><pre><code>javacï¼šç¼–è¯‘å™¨ï¼Œå°†åç¼€åä¸º.javaçš„æºä»£ç ç¼–è¯‘æˆåç¼€åä¸ºâ€œ.classâ€çš„å­—èŠ‚ç javaï¼šè¿è¡Œå·¥å…·ï¼Œè¿è¡Œ.classçš„å­—èŠ‚ç jarï¼šæ‰“åŒ…å·¥å…·ï¼Œå°†ç›¸å…³çš„ç±»æ–‡ä»¶æ‰“åŒ…æˆä¸€ä¸ªæ–‡ä»¶javadocï¼šæ–‡æ¡£ç”Ÿæˆå™¨ï¼Œä»æºç æ³¨é‡Šä¸­æå–æ–‡æ¡£ï¼Œæ³¨é‡Šéœ€åŒ¹é…è§„èŒƒjdb debuggerï¼šè°ƒè¯•å·¥å…·jpsï¼šæ˜¾ç¤ºå½“å‰javaç¨‹åºè¿è¡Œçš„è¿›ç¨‹çŠ¶æ€javapï¼šåç¼–è¯‘ç¨‹åºappletviewerï¼šè¿è¡Œå’Œè°ƒè¯•appletç¨‹åºçš„å·¥å…·ï¼Œä¸éœ€è¦ä½¿ç”¨æµè§ˆå™¨javahï¼šä»Javaç±»ç”ŸæˆCå¤´æ–‡ä»¶å’ŒCæºæ–‡ä»¶ã€‚è¿™äº›æ–‡ä»¶æä¾›äº†è¿æ¥èƒ¶åˆï¼Œä½¿Javaå’ŒCä»£ç å¯è¿›è¡Œäº¤äº’ã€‚javawsï¼šè¿è¡ŒJNLPç¨‹åºextcheckï¼šä¸€ä¸ªæ£€æµ‹jaråŒ…å†²çªçš„å·¥å…·aptï¼šæ³¨é‡Šå¤„ç†å·¥å…· jhatï¼šjavaå †åˆ†æå·¥å…·jstackï¼šæ ˆè·Ÿè¸ªç¨‹åºjstatï¼šJVMæ£€æµ‹ç»Ÿè®¡å·¥å…·jstatdï¼šjstatå®ˆæŠ¤è¿›ç¨‹jinfoï¼šè·å–æ­£åœ¨è¿è¡Œæˆ–å´©æºƒçš„javaç¨‹åºé…ç½®ä¿¡æ¯jmapï¼šè·å–javaè¿›ç¨‹å†…å­˜æ˜ å°„ä¿¡æ¯idljï¼šIDL-to-Javaç¼–è¯‘å™¨ã€‚å°†IDLè¯­è¨€è½¬åŒ–ä¸ºjavaæ–‡ä»¶ policytoolï¼šä¸€ä¸ªGUIçš„ç­–ç•¥æ–‡ä»¶åˆ›å»ºå’Œç®¡ç†å·¥å…·jrunscriptï¼šå‘½ä»¤è¡Œè„šæœ¬è¿è¡Œ</code></pre><p>JDKä¸­è¿˜åŒ…æ‹¬å®Œæ•´çš„JREï¼ˆJava Runtime Environmentï¼‰ï¼ŒJavaè¿è¡Œç¯å¢ƒï¼Œä¹Ÿè¢«ç§°ä¸ºprivate runtimeã€‚åŒ…æ‹¬äº†ç”¨äºäº§å“ç¯å¢ƒçš„å„ç§åº“ç±»ï¼Œå¦‚åŸºç¡€ç±»åº“rt.jarï¼Œä»¥åŠç»™å¼€å‘äººå‘˜ä½¿ç”¨çš„è¡¥å……åº“ï¼Œå¦‚å›½é™…åŒ–ä¸æœ¬åœ°åŒ–çš„ç±»åº“ã€IDLåº“ç­‰ç­‰ã€‚</p><p>JDKä¸­è¿˜åŒ…æ‹¬å„ç§æ ·ä¾‹ç¨‹åºï¼Œç”¨ä»¥å±•ç¤ºJava APIä¸­çš„å„éƒ¨åˆ†ã€‚</p><p><strong>JDK**</strong>ä¸‹è½½é¢é¡µï¼š</p><p>**<a href="http://www.oracle.com/technetwork/java/javase/downloads/index.html" target="_blank" rel="noopener">http://www.oracle.com/technetwork/java/javase/downloads/index.html</a> **</p><h5 id="2ã€å®‰è£…Tomcat-amp-JDK"><a href="#2ã€å®‰è£…Tomcat-amp-JDK" class="headerlink" title="2ã€å®‰è£…Tomcat &amp; JDK"></a>2ã€å®‰è£…Tomcat &amp; JDK</h5><p>å®‰è£…æ—¶å€™é€‰æ‹©tomcatè½¯ä»¶ç‰ˆæœ¬è¦ä¸ç¨‹åºå¼€å‘ä½¿ç”¨çš„ç‰ˆæœ¬ä¸€è‡´ã€‚jdkç‰ˆæœ¬è¦è¿›è¡Œä¸tomcatä¿æŒä¸€è‡´ã€‚</p><h6 id="1ã€ç³»ç»Ÿç¯å¢ƒè¯´æ˜"><a href="#1ã€ç³»ç»Ÿç¯å¢ƒè¯´æ˜" class="headerlink" title="1ã€ç³»ç»Ÿç¯å¢ƒè¯´æ˜"></a>1ã€ç³»ç»Ÿç¯å¢ƒè¯´æ˜</h6><pre><code>[root@web03 ~]# cat /etc/redhat-release CentOS Linux release 7.4.1708 (Core) [root@web03 ~]# uname -a Linux web03 3.10.0-693.el7.x86_64 #1 SMP Tue Aug 22 21:09:27 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux[root@web03 ~]# getenforce Disabled[root@web03 ~]# systemctl status firewalld.serviceâ— firewalld.service - firewalld - dynamic firewall daemon   Loaded: loaded (/usr/lib/systemd/system/firewalld.service; disabled; vendor preset: enabled)   Active: inactive (dead)     Docs: man:firewalld(1)</code></pre><h6 id="2-ã€å®‰è£…JDK"><a href="#2-ã€å®‰è£…JDK" class="headerlink" title="2 ã€å®‰è£…JDK"></a>2 ã€å®‰è£…JDK</h6><p>å‘½ä»¤é›†ï¼š</p><pre><code>tar xf jdk-8u60-linux-x64.tar.gz -C /application/ln -s /application/jdk1.8.0_60 /application/jdk# è®¾ç½®ç¯å¢ƒå˜é‡sed -i.ori &#39;$a export JAVA_HOME=/application/jdk\nexport PATH=$JAVA_HOME/bin:$JAVA_HOME/jre/bin:$PATH\nexport CLASSPATH=.:$JAVA_HOME/lib:$JAVA_HOME/jre/lib:$JAVA_HOME/lib/tools.jar&#39; /etc/profilesource /etc/profile</code></pre><p>æµ‹è¯•jdkæ˜¯å¦å®‰è£…æˆåŠŸâ†“</p><pre><code>[root@web03 ~]# java -versionjava version &quot;1.8.0_60&quot;Java(TM) SE Runtime Environment (build 1.8.0_60-b27)Java HotSpot(TM) 64-Bit Server VM (build 25.60-b23, mixed mode)</code></pre><h6 id="3ã€å®‰è£…Tomcat"><a href="#3ã€å®‰è£…Tomcat" class="headerlink" title="3ã€å®‰è£…Tomcat"></a>3ã€å®‰è£…Tomcat</h6><p>å‘½ä»¤é›†ï¼š</p><pre><code>tar xf apache-tomcat-8.0.27.tar.gz -C /application/ln -s /application/apache-tomcat-8.0.27 /application/tomcat# è®¾ç½®ç¯å¢ƒå˜é‡echo &#39;export TOMCAT_HOME=/application/tomcat&#39;&gt;&gt;/etc/profilesource /etc/profile# æ³¨æ„æˆæƒï¼Œç»Ÿä¸€æƒé™chown -R root.root /application/jdk/ /application/tomcat/</code></pre><p>æ£€æŸ¥tomcatæ˜¯å¦å®‰è£…æˆåŠŸ</p><pre><code>[root@web03 ~]# /application/tomcat/bin/version.shUsing CATALINA_BASE:   /application/tomcatUsing CATALINA_HOME:   /application/tomcatUsing CATALINA_TMPDIR: /application/tomcat/tempUsing JRE_HOME:        /application/jdkUsing CLASSPATH:       /application/tomcat/bin/bootstrap.jar:/application/tomcat/bin/tomcat-juli.jarServer version: Apache Tomcat/8.0.27Server built:   Sep 28 2015 08:17:25 UTCServer number:  8.0.27.0OS Name:        LinuxOS Version:     3.10.0-693.el7.x86_64Architecture:   amd64JVM Version:    1.8.0_60-b27JVM Vendor:     Oracle Corporation</code></pre><h4 id="2ã€Tomcatç›®å½•ä»‹ç»"><a href="#2ã€Tomcatç›®å½•ä»‹ç»" class="headerlink" title="2ã€Tomcatç›®å½•ä»‹ç»"></a>2ã€Tomcatç›®å½•ä»‹ç»</h4><h5 id="1ã€tomcatä¸»ç›®å½•ä»‹ç»"><a href="#1ã€tomcatä¸»ç›®å½•ä»‹ç»" class="headerlink" title="1ã€tomcatä¸»ç›®å½•ä»‹ç»"></a>1ã€tomcatä¸»ç›®å½•ä»‹ç»</h5><pre><code>[root@web03 ~]# cd /application/tomcat/[root@web03 tomcat]# tree -L 1.â”œâ”€â”€ bin              #å­˜æ”¾tomcatç®¡ç†è„šæœ¬â”œâ”€â”€ conf             # tomcat é…ç½®æ–‡ä»¶å­˜æ”¾ç›®å½•â”œâ”€â”€ lib              # webåº”ç”¨è°ƒç”¨çš„jaråŒ…å­˜æ”¾è·¯å¾„â”œâ”€â”€ LICENSEâ”œâ”€â”€ logs             # tomcat æ—¥å¿—å­˜æ”¾ç›®å½•ï¼Œcatalina.out ä¸ºä¸»è¦è¾“å‡ºæ—¥å¿—â”œâ”€â”€ NOTICEâ”œâ”€â”€ RELEASE-NOTESâ”œâ”€â”€ RUNNING.txtâ”œâ”€â”€ temp             # å­˜æ”¾ä¸´æ—¶æ–‡ä»¶â”œâ”€â”€ webapps         # webç¨‹åºå­˜æ”¾ç›®å½•â””â”€â”€ work             # å­˜æ”¾ç¼–è¯‘äº§ç”Ÿçš„.java ä¸ .classæ–‡ä»¶7 directories, 4 files</code></pre><h5 id="2ã€webappsç›®å½•ä»‹ç»"><a href="#2ã€webappsç›®å½•ä»‹ç»" class="headerlink" title="2ã€webappsç›®å½•ä»‹ç»"></a>2ã€webappsç›®å½•ä»‹ç»</h5><pre><code>[root@web03 tomcat]# cd webapps/[root@web03 webapps]# tree -L 1.â”œâ”€â”€ docs            # tomcat å¸®åŠ©æ–‡æ¡£â”œâ”€â”€ examples       # webåº”ç”¨å®ä¾‹â”œâ”€â”€ host-manager  # ä¸»æœºç®¡ç†â”œâ”€â”€ manager         # ç®¡ç†â””â”€â”€ ROOT             # é»˜è®¤ç«™ç‚¹æ ¹ç›®å½•5 directories, 0 files</code></pre><h5 id="3ã€Tomcaté…ç½®æ–‡ä»¶ç›®å½•ä»‹ç»ï¼ˆconfï¼‰"><a href="#3ã€Tomcaté…ç½®æ–‡ä»¶ç›®å½•ä»‹ç»ï¼ˆconfï¼‰" class="headerlink" title="3ã€Tomcaté…ç½®æ–‡ä»¶ç›®å½•ä»‹ç»ï¼ˆconfï¼‰"></a>3ã€Tomcaté…ç½®æ–‡ä»¶ç›®å½•ä»‹ç»ï¼ˆconfï¼‰</h5><pre><code>[root@web03 conf]# tree -L 1.â”œâ”€â”€ Catalinaâ”œâ”€â”€ catalina.policyâ”œâ”€â”€ catalina.propertiesâ”œâ”€â”€ context.xmlâ”œâ”€â”€ logging.propertiesâ”œâ”€â”€ logsâ”œâ”€â”€ server.xml           # tomcat ä¸»é…ç½®æ–‡ä»¶â”œâ”€â”€ server.xml.bakâ”œâ”€â”€ server.xml.bak2â”œâ”€â”€ tomcat-users.xml    # tomcat ç®¡ç†ç”¨æˆ·é…ç½®æ–‡ä»¶â”œâ”€â”€ tomcat-users.xsdâ””â”€â”€ web.xml2 directories, 10 files</code></pre><h5 id="4ã€Tomcatçš„ç®¡ç†"><a href="#4ã€Tomcatçš„ç®¡ç†" class="headerlink" title="4ã€Tomcatçš„ç®¡ç†"></a>4ã€Tomcatçš„ç®¡ç†</h5><pre><code>#  å¯åŠ¨ç¨‹åº/application/tomcat/bin/startup.sh#  å…³é—­ç¨‹åº/application/tomcat/bin/shutdown.sh</code></pre><p>å¯åŠ¨åœæ­¢</p><pre><code>[root@web03 ~]# /application/tomcat/bin/shutdown.sh Using CATALINA_BASE:   /application/tomcatUsing CATALINA_HOME:   /application/tomcatUsing CATALINA_TMPDIR: /application/tomcat/tempUsing JRE_HOME:        /application/jdkUsing CLASSPATH:       /application/tomcat/bin/bootstrap.jar:/application/tomcat/bin/tomcat-juli.jar[root@web03 ~]# /application/tomcat/bin/startup.sh Using CATALINA_BASE:   /application/tomcatUsing CATALINA_HOME:   /application/tomcatUsing CATALINA_TMPDIR: /application/tomcat/tempUsing JRE_HOME:        /application/jdkUsing CLASSPATH:       /application/tomcat/bin/bootstrap.jar:/application/tomcat/bin/tomcat-juli.jarTomcat started.</code></pre><p>â€‹         æ³¨æ„ï¼štomcatæœªå¯åŠ¨çš„æƒ…å†µä¸‹ä½¿ç”¨shutdownè„šæœ¬ï¼Œä¼šæœ‰å¤§é‡çš„è¾“å‡ºä¿¡æ¯ã€‚</p><p>æ£€æŸ¥tomcatæ˜¯å¦å¯åŠ¨æ­£å¸¸</p><pre><code>[root@web03 ~]# netstat -lntup  |grep javatcp6       0      0 :::8080         :::*                   LISTEN      30560/java          tcp6       0      0 127.0.0.1:8005          :::*          LISTEN      30560/java          tcp6       0      0 :::8009                 :::*           LISTEN      30560/java      </code></pre><p><strong>è¯´æ˜ï¼š</strong>æ‰€æœ‰ä¸javaç›¸å…³çš„ï¼ŒæœåŠ¡å¯åŠ¨éƒ½æ˜¯javaå‘½åçš„è¿›ç¨‹</p><p>å¯åŠ¨å®Œæˆæµè§ˆå™¨è¿›è¡Œè®¿é—®</p><p><a href="http://10.0.0.17:8080/" target="_blank" rel="noopener">http://10.0.0.17:8080/</a></p><p><img src="https://s1.ax1x.com/2020/05/21/YHPn2j.png" alt="YHPn2j.png"></p><h4 id="3ã€Tomcatæ—¥å¿—è¯´æ˜"><a href="#3ã€Tomcatæ—¥å¿—è¯´æ˜" class="headerlink" title="3ã€Tomcatæ—¥å¿—è¯´æ˜"></a>3ã€Tomcatæ—¥å¿—è¯´æ˜</h4><h5 id="1ã€æŸ¥çœ‹æ—¥å¿—"><a href="#1ã€æŸ¥çœ‹æ—¥å¿—" class="headerlink" title="1ã€æŸ¥çœ‹æ—¥å¿—"></a>1ã€æŸ¥çœ‹æ—¥å¿—</h5><pre><code>[root@web03 ~]# tailf /application/tomcat/logs/catalina.out24-Nov-2017 15:09:51.654 INFO [main] org.apache.coyote.AbstractProtocol.start Starting ProtocolHandler [&quot;http-nio-8080&quot;]24-Nov-2017 15:09:51.665 INFO [main] org.apache.coyote.AbstractProtocol.start Starting ProtocolHandler [&quot;ajp-nio-8009&quot;]24-Nov-2017 15:09:51.670 INFO [main] org.apache.catalina.startup.Catalina.start Server startup in 60037 ms</code></pre><p>â€‹         å‘ç°å¯åŠ¨æ—¶é—´è¾ƒé•¿ï¼Œå…¶ä¸­æœ‰ä¸€é¡¹çš„å¯åŠ¨æ—¶é—´å æ®äº†ç»å¤§å¤šæ•°</p><pre><code>24-Nov-2017 15:09:50.629 INFO [localhost-startStop-1] org.apache.catalina.startup.HostConfig.deployWAR Deployment of web application archive /application/apache-tomcat-8.0.27/webapps/memtest.war has finished in 58,892 ms</code></pre><p>â€‹         å‘ç°è€—æ—¶åœ¨è¿™é‡Œï¼šæ˜¯sessionå¼•èµ·çš„éšæœºæ•°é—®é¢˜å¯¼è‡´çš„ã€‚Tocmatçš„Session IDæ˜¯é€šè¿‡SHA1ç®—æ³•è®¡ç®—å¾—åˆ°çš„ï¼Œè®¡ç®—Session IDçš„æ—¶å€™å¿…é¡»æœ‰ä¸€ä¸ªå¯†é’¥ã€‚ä¸ºäº†æé«˜å®‰å…¨æ€§Tomcatåœ¨å¯åŠ¨çš„æ—¶å€™ä¼šé€šè¿‡éšæœºç”Ÿæˆä¸€ä¸ªå¯†é’¥ã€‚</p><h5 id="2ã€è§£å†³Tomcatå¯åŠ¨æ…¢çš„æ–¹æ³•"><a href="#2ã€è§£å†³Tomcatå¯åŠ¨æ…¢çš„æ–¹æ³•" class="headerlink" title="2ã€è§£å†³Tomcatå¯åŠ¨æ…¢çš„æ–¹æ³•"></a>2ã€è§£å†³Tomcatå¯åŠ¨æ…¢çš„æ–¹æ³•</h5><p>Tomcatå¯åŠ¨æ…¢ä¸»è¦åŸå› æ˜¯ç”Ÿæˆéšæœºæ•°çš„æ—¶å€™å¡ä½äº†,å¯¼è‡´tomcatå¯åŠ¨ä¸äº†ã€‚</p><p>æ˜¯å¦æœ‰è¶³å¤Ÿçš„ç†µæ¥ç”¨äºäº§ç”Ÿéšæœºæ•°ï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤æ¥æŸ¥çœ‹</p><pre><code>[root@web03 ~]# cat /proc/sys/kernel/random/entropy_avail6</code></pre><p>ä¸ºäº†åŠ é€Ÿ/dev/randomæä¾›éšæœºæ•°çš„é€Ÿåº¦ï¼Œä½ å¯ä»¥é€šè¿‡æ“ä½œè®¾å¤‡çš„å¤–è®¾ï¼Œè®©å…¶äº§ç”Ÿå¤§é‡çš„ä¸­æ–­ï¼Œç½‘ç»œä¼ è¾“æ•°æ®ï¼ŒæŒ‰é”®ï¼Œç§»åŠ¨é¼ æ ‡ï¼Œåœ¨å‘½ä»¤è¡Œæ•²å‡ ä¸ªä¸åŒçš„å‘½ä»¤ï¼Œä¿—ç§°èšæ°”ã€‚</p><p>cat /dev/random ä¼šæ¶ˆè€—èƒ½é‡</p><p><strong>æ–¹æ³•1**</strong>ï¼š**</p><pre><code>vim $JAVA_HOME/jre/lib/security/java.securitysecurerandom.source=file:/dev/random</code></pre><p>æ”¹ä¸º</p><pre><code>securerandom.source=file:/dev/urandom</code></pre><p><strong>æ–¹æ³•2**</strong>ï¼š**</p><pre><code>vim $TOMCAT_HOME/bin/catalina.shif [[ &quot;$JAVA_OPTS&quot; != *-Djava.security.egd=* ]]; then    JAVA_OPTS=&quot;$JAVA_OPTS -Djava.security.egd=file:/dev/urandom&quot;fi</code></pre><p>è¿™ä¸ªç³»ç»Ÿå±æ€§egdè¡¨ç¤ºç†µæ”¶é›†å®ˆæŠ¤è¿›ç¨‹(entropy gathering daemon)</p><p><strong>æ–¹æ³•3**</strong>ï¼šï¼ˆæ¨èï¼‰**</p><pre><code>yum install rng-tools # å®‰è£…rngdæœåŠ¡ï¼ˆç†µæœåŠ¡ï¼Œå¢å¤§ç†µæ± ï¼‰systemctl start rngd  # å¯åŠ¨æœåŠ¡</code></pre><h4 id="4ã€Tomcatç®¡ç†åŠŸèƒ½ä½¿ç”¨"><a href="#4ã€Tomcatç®¡ç†åŠŸèƒ½ä½¿ç”¨" class="headerlink" title="4ã€Tomcatç®¡ç†åŠŸèƒ½ä½¿ç”¨"></a>4ã€Tomcatç®¡ç†åŠŸèƒ½ä½¿ç”¨</h4><p><strong>æ³¨æ„ï¼šæµ‹è¯•åŠŸèƒ½ï¼Œç”Ÿäº§ç¯å¢ƒä¸è¦ç”¨</strong></p><p>Tomcatç®¡ç†åŠŸèƒ½ç”¨äºå¯¹Tomcatè‡ªèº«ä»¥åŠéƒ¨ç½²åœ¨Tomcatä¸Šçš„åº”ç”¨è¿›è¡Œç®¡ç†çš„webåº”ç”¨ã€‚åœ¨é»˜è®¤æƒ…å†µä¸‹æ˜¯å¤„äºç¦ç”¨çŠ¶æ€çš„ã€‚å¦‚æœéœ€è¦å¼€å¯è¿™ä¸ªåŠŸèƒ½ï¼Œå°±éœ€è¦é…ç½®ç®¡ç†ç”¨æˆ·ï¼Œå³é…ç½®tomcat-users.xml æ–‡ä»¶ã€‚</p><pre><code>[root@web03 ~]# vim /application/tomcat/conf/tomcat-users.xmlâ€¦â€¦39 &lt;role rolename=&quot;manager-gui&quot;/&gt; 40 &lt;role rolename=&quot;admin-gui&quot;/&gt; 41 &lt;user username=&quot;tomcat&quot; password=&quot;tomcat&quot; roles=&quot;manager-gui,admin-gui&quot;/&gt; 42 &lt;/tomcat-users&gt;   # åœ¨æ­¤è¡Œå‰åŠ å…¥ä¸Šé¢ä¸‰è¡Œ</code></pre><p><strong>æœªä¿®æ”¹æ–‡ä»¶å‰è¿›è¡Œè®¿é—®</strong></p><p><img src="https://s1.ax1x.com/2020/05/21/YHPuxs.png" alt="YHPuxs.png"></p><pre><code>&lt;role rolename=&quot;manager-gui&quot;/&gt;&lt;user username=&quot;tomcat&quot; password=&quot;s3cret&quot; roles=&quot;manager-gui&quot;/&gt;</code></pre><p><img src="https://s1.ax1x.com/2020/05/21/YHPMMn.png" alt="YHPMMn.png"></p><pre><code>&lt;role rolename=&quot;admin-gui&quot;/&gt;&lt;user username=&quot;tomcat&quot; password=&quot;s3cret&quot; roles=&quot;admin-gui&quot;/&gt;</code></pre><p>â€‹         ä»è€Œå¾—å‡ºä¸Šé¢çš„é…ç½®æ–‡ä»¶ä¿¡æ¯ã€‚</p><h5 id="1ã€åœ¨webç•Œé¢è®¿é—®ç®¡ç†ç•Œé¢"><a href="#1ã€åœ¨webç•Œé¢è®¿é—®ç®¡ç†ç•Œé¢" class="headerlink" title="1ã€åœ¨webç•Œé¢è®¿é—®ç®¡ç†ç•Œé¢"></a>1ã€åœ¨webç•Œé¢è®¿é—®ç®¡ç†ç•Œé¢</h5><p><img src="https://s1.ax1x.com/2020/05/21/YHP3ZV.png" alt="YHP3ZV.png"></p><p>â€‹         è¾“å…¥ä¹‹å‰é…ç½®çš„è´¦æˆ·ä¸å¯†ç å³å¯</p><p><img src="https://s1.ax1x.com/2020/05/21/YHPGIU.png" alt="YHPGIU.png"></p><p><img src="https://s1.ax1x.com/2020/05/21/YHPtG4.png" alt="YHPtG4.png"></p><h4 id="5ã€Tomcatä¸»é…ç½®æ–‡ä»¶è¯¦è§£"><a href="#5ã€Tomcatä¸»é…ç½®æ–‡ä»¶è¯¦è§£" class="headerlink" title="5ã€Tomcatä¸»é…ç½®æ–‡ä»¶è¯¦è§£"></a>5ã€Tomcatä¸»é…ç½®æ–‡ä»¶è¯¦è§£</h4><h5 id="1ã€server-xmlç»„ä»¶ç±»åˆ«"><a href="#1ã€server-xmlç»„ä»¶ç±»åˆ«" class="headerlink" title="1ã€server.xmlç»„ä»¶ç±»åˆ«"></a>1ã€server.xmlç»„ä»¶ç±»åˆ«</h5><p>é¡¶çº§ç»„ä»¶ï¼šä½äºæ•´ä¸ªé…ç½®çš„é¡¶å±‚ï¼Œå¦‚serverã€‚</p><p>å®¹å™¨ç±»ç»„ä»¶ï¼šå¯ä»¥åŒ…å«å…¶å®ƒç»„ä»¶çš„ç»„ä»¶ï¼Œå¦‚serviceã€engineã€hostã€contextã€‚</p><p>è¿æ¥å™¨ç»„ä»¶ï¼šè¿æ¥ç”¨æˆ·è¯·æ±‚è‡³tomcatï¼Œå¦‚connectorã€‚</p><p>è¢«åµŒå¥—ç±»ç»„ä»¶ï¼šä½äºä¸€ä¸ªå®¹å™¨å½“ä¸­ï¼Œä¸èƒ½åŒ…å«å…¶ä»–ç»„ä»¶ï¼Œå¦‚Valveã€loggerã€‚</p><pre><code>&lt;server&gt;     &lt;service&gt;     &lt;connector /&gt;     &lt;engine&gt;     &lt;host&gt;     &lt;context&gt;&lt;/context&gt;     &lt;/host&gt;     &lt;host&gt;     &lt;context&gt;&lt;/context&gt;     &lt;/host&gt;     &lt;/engine&gt;     &lt;/service&gt;&lt;/server&gt;</code></pre><h5 id="2ã€ç»„ä»¶ä»‹ç»"><a href="#2ã€ç»„ä»¶ä»‹ç»" class="headerlink" title="2ã€ç»„ä»¶ä»‹ç»"></a>2ã€ç»„ä»¶ä»‹ç»</h5><table><thead><tr><th><strong>ç»„ä»¶åç§°</strong></th><th><strong>åŠŸèƒ½ä»‹ç»</strong></th></tr></thead><tbody><tr><td><strong>engine</strong></td><td>æ ¸å¿ƒå®¹å™¨ç»„ä»¶ï¼Œcatalinaå¼•æ“ï¼Œè´Ÿè´£é€šè¿‡connectoræ¥æ”¶ç”¨æˆ·è¯·æ±‚ï¼Œå¹¶å¤„ç†è¯·æ±‚ï¼Œå°†è¯·æ±‚è½¬è‡³å¯¹åº”çš„è™šæ‹Ÿä¸»æœºhostã€‚</td></tr><tr><td><strong>host</strong></td><td>ç±»ä¼¼äºhttpdä¸­çš„è™šæ‹Ÿä¸»æœºï¼Œä¸€èˆ¬è€Œè¨€æ”¯æŒåŸºäºFQDNçš„è™šæ‹Ÿä¸»æœºã€‚</td></tr><tr><td><strong>context</strong></td><td>å®šä¹‰ä¸€ä¸ªåº”ç”¨ç¨‹åºï¼Œæ˜¯ä¸€ä¸ªæœ€å†…å±‚çš„å®¹å™¨ç±»ç»„ä»¶ï¼ˆä¸èƒ½å†åµŒå¥—ï¼‰ã€‚é…ç½®contextçš„ä¸»è¦ç›®çš„æŒ‡å®šå¯¹åº”å¯¹çš„webappçš„æ ¹ç›®å½•ï¼Œç±»ä¼¼äºhttpdçš„aliasï¼Œå…¶è¿˜èƒ½ä¸ºwebappæŒ‡å®šé¢å¤–çš„å±æ€§ï¼Œå¦‚éƒ¨ç½²æ–¹å¼ç­‰ã€‚</td></tr><tr><td><strong>connector</strong></td><td>æ¥æ”¶ç”¨æˆ·è¯·æ±‚ï¼Œç±»ä¼¼äºhttpdçš„listené…ç½®ç›‘å¬ç«¯å£çš„ã€‚</td></tr><tr><td><strong>service**</strong>ï¼ˆæœåŠ¡ï¼‰**</td><td>å°†connectorå…³è”è‡³engineï¼Œå› æ­¤ä¸€ä¸ªserviceå†…éƒ¨å¯ä»¥æœ‰å¤šä¸ªconnectorï¼Œä½†åªèƒ½æœ‰ä¸€ä¸ªå¼•æ“engineã€‚serviceå†…éƒ¨æœ‰ä¸¤ä¸ªconnectorï¼Œä¸€ä¸ªengineã€‚å› æ­¤ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ä¸€ä¸ªserverå†…éƒ¨åªæœ‰ä¸€ä¸ªserviceï¼Œä¸€ä¸ªserviceå†…éƒ¨åªæœ‰ä¸€ä¸ªengineï¼Œä½†ä¸€ä¸ªserviceå†…éƒ¨å¯ä»¥æœ‰å¤šä¸ªconnectorã€‚</td></tr><tr><td><strong>server</strong></td><td>è¡¨ç¤ºä¸€ä¸ªè¿è¡ŒäºJVMä¸­çš„tomcatå®ä¾‹ã€‚</td></tr><tr><td><strong>Valve</strong></td><td>é˜€é—¨ï¼Œæ‹¦æˆªè¯·æ±‚å¹¶åœ¨å°†å…¶è½¬è‡³å¯¹åº”çš„webappå‰è¿›è¡ŒæŸç§å¤„ç†æ“ä½œï¼Œå¯ä»¥ç”¨äºä»»ä½•å®¹å™¨ä¸­ï¼Œæ¯”å¦‚è®°å½•æ—¥å¿—(access log valve)ã€åŸºäºIPåšè®¿é—®æ§åˆ¶(remote address filter valve)ã€‚</td></tr><tr><td><strong>logger</strong></td><td>æ—¥å¿—è®°å½•å™¨ï¼Œç”¨äºè®°å½•ç»„ä»¶å†…éƒ¨çš„çŠ¶æ€ä¿¡æ¯ï¼Œå¯ä»¥ç”¨äºé™¤contextå¤–çš„ä»»ä½•å®¹å™¨ä¸­ã€‚</td></tr><tr><td><strong>realm</strong></td><td>å¯ä»¥ç”¨äºä»»æ„å®¹å™¨ç±»çš„ç»„ä»¶ä¸­ï¼Œå…³è”ä¸€ä¸ªç”¨æˆ·è®¤è¯åº“ï¼Œå®ç°è®¤è¯å’Œæˆæƒã€‚å¯ä»¥å…³è”çš„è®¤è¯åº“æœ‰ä¸¤ç§ï¼šUserDatabaseRealmã€MemoryRealmå’ŒJDBCRealmã€‚</td></tr><tr><td><strong>UserDatabaseRealm</strong></td><td>ä½¿ç”¨JNDIè‡ªå®šä¹‰çš„ç”¨æˆ·è®¤è¯åº“ã€‚</td></tr><tr><td><strong>MemoryRealm</strong></td><td>è®¤è¯ä¿¡æ¯å®šä¹‰åœ¨tomcat-users.xmlä¸­ã€‚</td></tr><tr><td><strong>JDBCRealm</strong></td><td>è®¤è¯ä¿¡æ¯å®šä¹‰åœ¨æ•°æ®åº“ä¸­ï¼Œå¹¶é€šè¿‡JDBCè¿æ¥è‡³æ•°æ®åº“ä¸­æŸ¥æ‰¾è®¤è¯ç”¨æˆ·ã€‚</td></tr></tbody></table><h5 id="3ã€server-xmlé…ç½®æ–‡ä»¶æ³¨é‡Š"><a href="#3ã€server-xmlé…ç½®æ–‡ä»¶æ³¨é‡Š" class="headerlink" title="3ã€server.xmlé…ç½®æ–‡ä»¶æ³¨é‡Š"></a>3ã€server.xmlé…ç½®æ–‡ä»¶æ³¨é‡Š</h5><pre><code>&lt;?xml version=&#39;1.0&#39; encoding=&#39;utf-8&#39;?&gt;&lt;!--&lt;Server&gt;å…ƒç´ ä»£è¡¨æ•´ä¸ªå®¹å™¨,æ˜¯Tomcatå®ä¾‹çš„é¡¶å±‚å…ƒç´ .ç”±org.apache.catalina.Serveræ¥å£æ¥å®šä¹‰.å®ƒåŒ…å«ä¸€ä¸ª&lt;Service&gt;å…ƒç´ .å¹¶ä¸”å®ƒä¸èƒ½åšä¸ºä»»ä½•å…ƒç´ çš„å­å…ƒç´ .    portæŒ‡å®šTomcatç›‘å¬shutdownå‘½ä»¤ç«¯å£.ç»ˆæ­¢æœåŠ¡å™¨è¿è¡Œæ—¶,å¿…é¡»åœ¨TomcatæœåŠ¡å™¨æ‰€åœ¨çš„æœºå™¨ä¸Šå‘å‡ºshutdownå‘½ä»¤.è¯¥å±æ€§æ˜¯å¿…é¡»çš„.    shutdownæŒ‡å®šç»ˆæ­¢TomcatæœåŠ¡å™¨è¿è¡Œæ—¶,å‘ç»™TomcatæœåŠ¡å™¨çš„shutdownç›‘å¬ç«¯å£çš„å­—ç¬¦ä¸².è¯¥å±æ€§å¿…é¡»è®¾ç½®--&gt;&lt;Server port=&quot;8005&quot; shutdown=&quot;SHUTDOWN&quot;&gt;  &lt;Listener className=&quot;org.apache.catalina.startup.VersionLoggerListener&quot; /&gt;  &lt;Listener className=&quot;org.apache.catalina.core.AprLifecycleListener&quot; SSLEngine=&quot;on&quot; /&gt;  &lt;Listener className=&quot;org.apache.catalina.core.JreMemoryLeakPreventionListener&quot; /&gt;  &lt;Listener className=&quot;org.apache.catalina.mbeans.GlobalResourcesLifecycleListener&quot; /&gt;  &lt;Listener className=&quot;org.apache.catalina.core.ThreadLocalLeakPreventionListener&quot; /&gt;  &lt;GlobalNamingResources&gt;    &lt;Resource name=&quot;UserDatabase&quot; auth=&quot;Container&quot;              type=&quot;org.apache.catalina.UserDatabase&quot;              description=&quot;User database that can be updated and saved&quot;              factory=&quot;org.apache.catalina.users.MemoryUserDatabaseFactory&quot;              pathname=&quot;conf/tomcat-users.xml&quot; /&gt;  &lt;/GlobalNamingResources&gt;  &lt;!--serviceæœåŠ¡ç»„ä»¶--&gt;  &lt;Service name=&quot;Catalina&quot;&gt;    &lt;!-- Connectorä¸»è¦å‚æ•°è¯´æ˜ï¼ˆè§ä¸‹è¡¨ï¼‰ --&gt;    &lt;Connector port=&quot;8080&quot; protocol=&quot;HTTP/1.1&quot;               connectionTimeout=&quot;20000&quot;               redirectPort=&quot;8443&quot; /&gt;    &lt;Connector port=&quot;8009&quot; protocol=&quot;AJP/1.3&quot; redirectPort=&quot;8443&quot; /&gt;    &lt;!--engine,æ ¸å¿ƒå®¹å™¨ç»„ä»¶,catalinaå¼•æ“,è´Ÿè´£é€šè¿‡connectoræ¥æ”¶ç”¨æˆ·è¯·æ±‚,å¹¶å¤„ç†è¯·æ±‚,å°†è¯·æ±‚è½¬è‡³å¯¹åº”çš„è™šæ‹Ÿä¸»æœºhost        defaultHostæŒ‡å®šç¼ºçœçš„å¤„ç†è¯·æ±‚çš„ä¸»æœºåï¼Œå®ƒè‡³å°‘ä¸å…¶ä¸­çš„ä¸€ä¸ªhostå…ƒç´ çš„nameå±æ€§å€¼æ˜¯ä¸€æ ·çš„    --&gt;    &lt;Engine name=&quot;Catalina&quot; defaultHost=&quot;localhost&quot;&gt;      &lt;!--Realmè¡¨ç¤ºå­˜æ”¾ç”¨æˆ·åï¼Œå¯†ç åŠroleçš„æ•°æ®åº“--&gt;      &lt;Realm className=&quot;org.apache.catalina.realm.LockOutRealm&quot;&gt;        &lt;Realm className=&quot;org.apache.catalina.realm.UserDatabaseRealm&quot;               resourceName=&quot;UserDatabase&quot;/&gt;      &lt;/Realm&gt;      &lt;!-- è¯¦æƒ…å¸¸è§ä¸‹è¡¨ï¼ˆhostå‚æ•°è¯¦è§£ï¼‰--&gt;      &lt;Host name=&quot;localhost&quot;  appBase=&quot;webapps&quot;            unpackWARs=&quot;true&quot; autoDeploy=&quot;true&quot;&gt;        &lt;!-- è¯¦æƒ…å¸¸è§ä¸‹è¡¨ï¼ˆContextå‚æ•°è¯´æ˜ ï¼‰--&gt;        &lt;Context path=&quot;&quot; docBase=&quot;&quot; debug=&quot;&quot;/&gt;        &lt;Valve className=&quot;org.apache.catalina.valves.AccessLogValve&quot; directory=&quot;logs&quot;               prefix=&quot;localhost_access_log&quot; suffix=&quot;.txt&quot;               pattern=&quot;%h %l %u %t &amp;quot;%r&amp;quot; %s %b&quot; /&gt;      &lt;/Host&gt;    &lt;/Engine&gt;  &lt;/Service&gt;&lt;/Server&gt;</code></pre><h5 id="4ã€Connectorä¸»è¦å‚æ•°è¯´æ˜"><a href="#4ã€Connectorä¸»è¦å‚æ•°è¯´æ˜" class="headerlink" title="4ã€Connectorä¸»è¦å‚æ•°è¯´æ˜"></a>4ã€Connectorä¸»è¦å‚æ•°è¯´æ˜</h5><table><thead><tr><th><strong>å‚æ•°</strong></th><th><strong>å‚æ•°è¯´æ˜</strong></th></tr></thead><tbody><tr><td><strong>connector</strong></td><td>æ¥æ”¶ç”¨æˆ·è¯·æ±‚ï¼Œç±»ä¼¼äºhttpdçš„listené…ç½®ç›‘å¬ç«¯å£.</td></tr><tr><td><strong>port</strong></td><td>æŒ‡å®šæœåŠ¡å™¨ç«¯è¦åˆ›å»ºçš„ç«¯å£å·ï¼Œå¹¶åœ¨è¿™ä¸ªç«¯å£ç›‘å¬æ¥è‡ªå®¢æˆ·ç«¯çš„è¯·æ±‚ã€‚</td></tr><tr><td><strong>address</strong></td><td>æŒ‡å®šè¿æ¥å™¨ç›‘å¬çš„åœ°å€ï¼Œé»˜è®¤ä¸ºæ‰€æœ‰åœ°å€ï¼ˆå³0.0.0.0ï¼‰</td></tr><tr><td><strong>protocol</strong></td><td>è¿æ¥å™¨ä½¿ç”¨çš„åè®®ï¼Œæ”¯æŒHTTPå’ŒAJPã€‚AJPï¼ˆApache Jserv Protocolï¼‰ä¸“ç”¨äºtomcatä¸apacheå»ºç«‹é€šä¿¡çš„ï¼Œ åœ¨httpdåå‘ä»£ç†ç”¨æˆ·è¯·æ±‚è‡³tomcatæ—¶ä½¿ç”¨ï¼ˆå¯è§Nginxåå‘ä»£ç†æ—¶ä¸å¯ç”¨AJPåè®®ï¼‰ã€‚</td></tr><tr><td><strong>minProcessors</strong></td><td>æœåŠ¡å™¨å¯åŠ¨æ—¶åˆ›å»ºçš„å¤„ç†è¯·æ±‚çš„çº¿ç¨‹æ•°</td></tr><tr><td><strong>maxProcessors</strong></td><td>æœ€å¤§å¯ä»¥åˆ›å»ºçš„å¤„ç†è¯·æ±‚çš„çº¿ç¨‹æ•°</td></tr><tr><td><strong>enableLookups</strong></td><td>å¦‚æœä¸ºtrueï¼Œåˆ™å¯ä»¥é€šè¿‡è°ƒç”¨request.getRemoteHost()è¿›è¡ŒDNSæŸ¥è¯¢æ¥å¾—åˆ°è¿œç¨‹å®¢æˆ·ç«¯çš„å®é™…ä¸»æœºåï¼Œè‹¥ä¸ºfalseåˆ™ä¸è¿›è¡ŒDNSæŸ¥è¯¢ï¼Œè€Œæ˜¯è¿”å›å…¶ipåœ°å€</td></tr><tr><td><strong>redirectPort</strong></td><td>æŒ‡å®šæœåŠ¡å™¨æ­£åœ¨å¤„ç†httpè¯·æ±‚æ—¶æ”¶åˆ°äº†ä¸€ä¸ªSSLä¼ è¾“è¯·æ±‚åé‡å®šå‘çš„ç«¯å£å·</td></tr><tr><td><strong>acceptCount</strong></td><td>æŒ‡å®šå½“æ‰€æœ‰å¯ä»¥ä½¿ç”¨çš„å¤„ç†è¯·æ±‚çš„çº¿ç¨‹æ•°éƒ½è¢«ä½¿ç”¨æ—¶ï¼Œå¯ä»¥æ”¾åˆ°å¤„ç†é˜Ÿåˆ—ä¸­çš„è¯·æ±‚æ•°ï¼Œè¶…è¿‡è¿™ä¸ªæ•°çš„è¯·æ±‚å°†ä¸äºˆå¤„ç†</td></tr><tr><td><strong>connectionTimeout</strong></td><td>æŒ‡å®šè¶…æ—¶çš„æ—¶é—´æ•°(ä»¥æ¯«ç§’ä¸ºå•ä½)</td></tr></tbody></table><h5 id="5ã€hostå‚æ•°è¯¦è§£"><a href="#5ã€hostå‚æ•°è¯¦è§£" class="headerlink" title="5ã€hostå‚æ•°è¯¦è§£"></a>5ã€hostå‚æ•°è¯¦è§£</h5><table><thead><tr><th><strong>å‚æ•°</strong></th><th><strong>å‚æ•°è¯´æ˜</strong></th></tr></thead><tbody><tr><td><strong>host</strong></td><td>è¡¨ç¤ºä¸€ä¸ªè™šæ‹Ÿä¸»æœº</td></tr><tr><td><strong>name</strong></td><td>æŒ‡å®šä¸»æœºå</td></tr><tr><td><strong>appBase</strong></td><td>åº”ç”¨ç¨‹åºåŸºæœ¬ç›®å½•ï¼Œå³å­˜æ”¾åº”ç”¨ç¨‹åºçš„ç›®å½•.ä¸€èˆ¬ä¸ºappBase=â€webappsâ€ï¼Œç›¸å¯¹äºCATALINA_HOMEè€Œè¨€çš„ï¼Œä¹Ÿå¯ä»¥å†™ç»å¯¹è·¯å¾„ã€‚</td></tr><tr><td><strong>unpackWARs</strong></td><td>å¦‚æœä¸ºtrueï¼Œåˆ™tomcatä¼šè‡ªåŠ¨å°†WARæ–‡ä»¶è§£å‹ï¼Œå¦åˆ™ä¸è§£å‹ï¼Œç›´æ¥ä»WARæ–‡ä»¶ä¸­è¿è¡Œåº”ç”¨ç¨‹åº</td></tr><tr><td><strong>autoDeploy</strong></td><td>åœ¨tomcatå¯åŠ¨æ—¶ï¼Œæ˜¯å¦è‡ªåŠ¨éƒ¨ç½²ã€‚</td></tr><tr><td><strong>xmlValidation</strong></td><td>æ˜¯å¦å¯åŠ¨xmlçš„æ ¡éªŒåŠŸèƒ½ï¼Œä¸€èˆ¬xmlValidation=â€falseâ€ã€‚</td></tr><tr><td><strong>xmlNamespaceAware</strong></td><td>æ£€æµ‹åç§°ç©ºé—´ï¼Œä¸€èˆ¬xmlNamespaceAware=â€falseâ€ã€‚</td></tr></tbody></table><h5 id="6ã€Contextå‚æ•°è¯´æ˜"><a href="#6ã€Contextå‚æ•°è¯´æ˜" class="headerlink" title="6ã€Contextå‚æ•°è¯´æ˜"></a>6ã€Contextå‚æ•°è¯´æ˜</h5><table><thead><tr><th><strong>å‚æ•°</strong></th><th><strong>å‚æ•°è¯´æ˜</strong></th></tr></thead><tbody><tr><td><strong>Context</strong></td><td>è¡¨ç¤ºä¸€ä¸ªwebåº”ç”¨ç¨‹åºï¼Œé€šå¸¸ä¸ºWARæ–‡ä»¶</td></tr><tr><td><strong>docBase</strong></td><td>åº”ç”¨ç¨‹åºçš„è·¯å¾„æˆ–è€…æ˜¯WARæ–‡ä»¶å­˜æ”¾çš„è·¯å¾„,ä¹Ÿå¯ä»¥ä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼Œèµ·å§‹è·¯å¾„ä¸ºæ­¤Contextæ‰€å±Hostä¸­appBaseå®šä¹‰çš„è·¯å¾„ã€‚</td></tr><tr><td><strong>path</strong></td><td>è¡¨ç¤ºæ­¤webåº”ç”¨ç¨‹åºçš„urlçš„å‰ç¼€ï¼Œè¿™æ ·è¯·æ±‚çš„urlä¸º<a href="http://localhost:8080/path/" target="_blank" rel="noopener">http://localhost:8080/path/</a>****</td></tr><tr><td><strong>reloadable</strong></td><td>è¿™ä¸ªå±æ€§éå¸¸é‡è¦ï¼Œå¦‚æœä¸ºtrueï¼Œåˆ™tomcatä¼šè‡ªåŠ¨æ£€æµ‹åº”ç”¨ç¨‹åºçš„/WEB-INF/libå’Œ/WEB-INF/classesç›®å½•çš„å˜åŒ–ï¼Œè‡ªåŠ¨è£…è½½æ–°çš„åº”ç”¨ç¨‹åºï¼Œå¯ä»¥åœ¨ä¸é‡å¯tomcatçš„æƒ…å†µä¸‹æ”¹å˜åº”ç”¨ç¨‹åº</td></tr></tbody></table>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Tomcat </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>xshell é…ç½®</title>
      <link href="2020/03/21/xshell-tu-chu-xian-shi-ji/"/>
      <url>2020/03/21/xshell-tu-chu-xian-shi-ji/</url>
      
        <content type="html"><![CDATA[<h3 id="xshellé…è‰²æ–¹æ¡ˆ"><a href="#xshellé…è‰²æ–¹æ¡ˆ" class="headerlink" title="[xshellé…è‰²æ–¹æ¡ˆ]"></a>[xshellé…è‰²æ–¹æ¡ˆ]</h3><pre><code>[cyylog]text=00ff80cyan(bold)=00fffftext(bold)=e9e9e9magenta=c000c0green=80ff00green(bold)=3c5a38background=042028cyan=00c0c0red(bold)=ff0000yellow=c0c000magenta(bold)=ff00ffyellow(bold)=ffff00red=ff4500white=c0c0c0blue(bold)=1e90ffwhite(bold)=fdf6e3black=000000blue=00bfffblack(bold)=808080[Names]name0=cyylogcount=1</code></pre><h5 id="ï¼ï¼ï¼-è¯·è‡ªè¡Œåˆ›å»º-xcs-åç¼€çš„æ–‡ä»¶"><a href="#ï¼ï¼ï¼-è¯·è‡ªè¡Œåˆ›å»º-xcs-åç¼€çš„æ–‡ä»¶" class="headerlink" title="ï¼ï¼ï¼ è¯·è‡ªè¡Œåˆ›å»º xcs åç¼€çš„æ–‡ä»¶"></a>ï¼ï¼ï¼ è¯·è‡ªè¡Œåˆ›å»º <code>xcs</code> åç¼€çš„æ–‡ä»¶</h5><h3 id="xshellçªå‡ºæ˜¾ç¤ºé›†"><a href="#xshellçªå‡ºæ˜¾ç¤ºé›†" class="headerlink" title="[xshellçªå‡ºæ˜¾ç¤ºé›†]"></a>[xshellçªå‡ºæ˜¾ç¤ºé›†]</h3><h3 id="xshellçªå‡ºæ˜¾ç¤ºé›†ï¼ˆå‚è€ƒmobaxtermï¼Œç›´æ¥æ‹·è´è¿‡æ¥ä¸è¡Œï¼Œåº”è¯¥æ˜¯xshellå¯¹æ­£åˆ™è¡¨è¾¾å¼çš„æ”¯æŒä¸å¤Ÿå¥½ï¼‰"><a href="#xshellçªå‡ºæ˜¾ç¤ºé›†ï¼ˆå‚è€ƒmobaxtermï¼Œç›´æ¥æ‹·è´è¿‡æ¥ä¸è¡Œï¼Œåº”è¯¥æ˜¯xshellå¯¹æ­£åˆ™è¡¨è¾¾å¼çš„æ”¯æŒä¸å¤Ÿå¥½ï¼‰" class="headerlink" title="xshellçªå‡ºæ˜¾ç¤ºé›†ï¼ˆå‚è€ƒmobaxtermï¼Œç›´æ¥æ‹·è´è¿‡æ¥ä¸è¡Œï¼Œåº”è¯¥æ˜¯xshellå¯¹æ­£åˆ™è¡¨è¾¾å¼çš„æ”¯æŒä¸å¤Ÿå¥½ï¼‰:"></a>xshellçªå‡ºæ˜¾ç¤ºé›†ï¼ˆå‚è€ƒmobaxtermï¼Œç›´æ¥æ‹·è´è¿‡æ¥ä¸è¡Œï¼Œåº”è¯¥æ˜¯xshellå¯¹æ­£åˆ™è¡¨è¾¾å¼çš„æ”¯æŒä¸å¤Ÿå¥½ï¼‰:</h3><p>Underline:</p><pre class=" language-shell"><code class="language-shell">\b(http(s)?://[A-Za-z0-9_./&?=%~#{}()@+-]+)\b</code></pre><p>Red:</p><pre class=" language-shell"><code class="language-shell">(\b((bad|wrong|incorrect|improper|invalid|unsupported|bad)( file| memory)? (descriptor|alloc(ation)?|addr(ess)?|owner(ship)?|arg(ument)?|param(eter)?|setting|length|filename)|not properly|improperly|(operation |connection |authentication |access |permission )?(false|no|ko|denied|disallowed|not allowed|refused|problem|failed|failure|not permitted)|no [A-Za-z]+( [A-Za-z]+)? found|invalid|unsupported|not supported|seg(mentation )?fault|corruption|corrupted|corrupt|overflow|underrun|not ok|unimplemented|unsuccessfull|not implemented|permerrors?|fehlers?|errore|errors?|erreurs?|fejl|virhe|greÅ¡ka|erro|fel|\(ee\)|\(ni\))\b)</code></pre><p>Green:</p><pre class=" language-shell"><code class="language-shell">(\b(true|yes|ok|accepted|allowed|enabled|connected|erfolgreich|exitoso|successo|sucedido|framgÃ¥ngsrik|successfully|successful|succeeded|success)\b)</code></pre><p>Yellow:</p><pre><code>(\b(\[\-w[A-Za-z-]+\]|caught signal [0-9]+|cannot|(connection (to (remote host|[a-z0-9.]+) )?)?(closed|terminated|stopped|not responding)|exited|no more [A-Za-z] available|unexpected|(command |binary |file )?not found|(o)+ps|out of (space|memory)|low (memory|disk)|unknown|disabled|disconnected|deprecated|refused|disconnect(ion)?|advertencia|avvertimento|attention|warnings?|achtung|exclamation|alerts?|warnungs?|advarsel|pedwarn|aviso|varoitus|upozorenje|peringatan|uyari|varning|avertissement|\(ww\)|\(\?\?\)|could not|unable to)\b)</code></pre><p>shellMagenta:</p><pre class=" language-shell"><code class="language-shell">(\b(localhost|([1-9]|[1-9][0-9]|1[0-9][0-9]|2[0-4][0-9]|25[0-4])\.[0-9]+\.[0-9]+\.[0-9]+|null|none)\b)</code></pre><p>Cyan:</p><pre class=" language-shell"><code class="language-shell">(\b(last (failed )?login:|launching|checking|loading|creating|building|important|booting|starting|notice|informational|informationen|informazioni|informaÃ§Ã£o|oplysninger|informations?|info|informaciÃ³n|informasi|note|\(ii\)|\(\!\!\))\b)</code></pre>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Tools </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>kubeadmå¿«é€Ÿéƒ¨ç½²kubernetesé›†ç¾¤</title>
      <link href="2020/03/17/rong-qi/kubeadm-kuai-su-bu-shu-kubernetes-ji-qun/"/>
      <url>2020/03/17/rong-qi/kubeadm-kuai-su-bu-shu-kubernetes-ji-qun/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><p>kubeadmæ˜¯å®˜æ–¹ç¤¾åŒºæ¨å‡ºçš„ä¸€ä¸ªç”¨äºå¿«é€Ÿéƒ¨ç½²kubernetesé›†ç¾¤çš„å·¥å…·ã€‚</p><p>è¿™ä¸ªå·¥å…·èƒ½é€šè¿‡ä¸¤æ¡æŒ‡ä»¤å®Œæˆä¸€ä¸ªkubernetesé›†ç¾¤çš„éƒ¨ç½²ï¼š</p><pre><code># åˆ›å»ºä¸€ä¸ª Master èŠ‚ç‚¹$ kubeadm init# å°†ä¸€ä¸ª Node èŠ‚ç‚¹åŠ å…¥åˆ°å½“å‰é›†ç¾¤ä¸­$ kubeadm join &lt;MasterèŠ‚ç‚¹çš„IPå’Œç«¯å£ &gt;</code></pre><h2 id="1-å®‰è£…è¦æ±‚"><a href="#1-å®‰è£…è¦æ±‚" class="headerlink" title="1. å®‰è£…è¦æ±‚"></a>1. å®‰è£…è¦æ±‚</h2><p>åœ¨å¼€å§‹ä¹‹å‰ï¼Œéƒ¨ç½²Kubernetesé›†ç¾¤æœºå™¨éœ€è¦æ»¡è¶³ä»¥ä¸‹å‡ ä¸ªæ¡ä»¶ï¼š</p><ul><li>ä¸€å°æˆ–å¤šå°æœºå™¨ï¼Œæ“ä½œç³»ç»Ÿ CentOS7.x-86_x64</li><li>ç¡¬ä»¶é…ç½®ï¼š2GBæˆ–æ›´å¤šRAMï¼Œ2ä¸ªCPUæˆ–æ›´å¤šCPUï¼Œç¡¬ç›˜30GBæˆ–æ›´å¤š</li><li>é›†ç¾¤ä¸­æ‰€æœ‰æœºå™¨ä¹‹é—´ç½‘ç»œäº’é€š</li><li>å¯ä»¥è®¿é—®å¤–ç½‘ï¼Œéœ€è¦æ‹‰å–é•œåƒ</li><li>ç¦æ­¢swapåˆ†åŒº</li></ul><h2 id="2-å­¦ä¹ ç›®æ ‡"><a href="#2-å­¦ä¹ ç›®æ ‡" class="headerlink" title="2. å­¦ä¹ ç›®æ ‡"></a>2. å­¦ä¹ ç›®æ ‡</h2><ol><li>åœ¨æ‰€æœ‰èŠ‚ç‚¹ä¸Šå®‰è£…Dockerå’Œkubeadm</li><li>éƒ¨ç½²Kubernetes Master</li><li>éƒ¨ç½²å®¹å™¨ç½‘ç»œæ’ä»¶</li><li>éƒ¨ç½² Kubernetes Nodeï¼Œå°†èŠ‚ç‚¹åŠ å…¥Kubernetesé›†ç¾¤ä¸­</li><li>éƒ¨ç½²Dashboard Webé¡µé¢ï¼Œå¯è§†åŒ–æŸ¥çœ‹Kubernetesèµ„æº</li></ol><h2 id="3-å‡†å¤‡ç¯å¢ƒ"><a href="#3-å‡†å¤‡ç¯å¢ƒ" class="headerlink" title="3. å‡†å¤‡ç¯å¢ƒ"></a>3. å‡†å¤‡ç¯å¢ƒ</h2><p><img src="http://p9.pstatp.com/large/pgc-image/d244ddcca380403e816a8705da3898c6" alt="kubeadmå¿«é€Ÿéƒ¨ç½²kubernetesé›†ç¾¤"></p><p>Kubernetes æ¶æ„å›¾</p><p><img src="http://p3.pstatp.com/large/pgc-image/8f8781176b8d4670b94214caa934d880" alt="kubeadmå¿«é€Ÿéƒ¨ç½²kubernetesé›†ç¾¤"></p><p>Kubernetes æ¶æ„å›¾</p><pre><code>å…³é—­é˜²ç«å¢™ï¼š$ systemctl stop firewalld$ systemctl disable firewalldå…³é—­selinuxï¼š$ sed -i &#39;s/enforcing/disabled/&#39; /etc/selinux/config $ setenforce 0å…³é—­swapï¼š$ swapoff -a  $ ä¸´æ—¶$ vim /etc/fstab  $ æ°¸ä¹…æ·»åŠ ä¸»æœºåä¸IPå¯¹åº”å…³ç³»ï¼ˆè®°å¾—è®¾ç½®ä¸»æœºåï¼‰ï¼š$ cat /etc/hosts192.168.31.63 k8s-master192.168.31.65 k8s-node1192.168.31.66 k8s-node2å°†æ¡¥æ¥çš„IPv4æµé‡ä¼ é€’åˆ°iptablesçš„é“¾ï¼š$ cat &gt; /etc/sysctl.d/k8s.conf &lt;&lt; EOFnet.bridge.bridge-nf-call-ip6tables = 1net.bridge.bridge-nf-call-iptables = 1EOF$ sysctl --system</code></pre><h2 id="4-æ‰€æœ‰èŠ‚ç‚¹å®‰è£…Docker-kubeadm-kubelet"><a href="#4-æ‰€æœ‰èŠ‚ç‚¹å®‰è£…Docker-kubeadm-kubelet" class="headerlink" title="4. æ‰€æœ‰èŠ‚ç‚¹å®‰è£…Docker/kubeadm/kubelet"></a>4. æ‰€æœ‰èŠ‚ç‚¹å®‰è£…Docker/kubeadm/kubelet</h2><p>Kubernetesé»˜è®¤CRIï¼ˆå®¹å™¨è¿è¡Œæ—¶ï¼‰ä¸ºDockerï¼Œå› æ­¤å…ˆå®‰è£…Dockerã€‚</p><h3 id="4-1-å®‰è£…Docker"><a href="#4-1-å®‰è£…Docker" class="headerlink" title="4.1 å®‰è£…Docker"></a>4.1 å®‰è£…Docker</h3><pre><code>$ wget https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo -O /etc/yum.repos.d/docker-ce.repo$ yum -y install docker-ce-18.06.1.ce-3.el7$ systemctl enable docker &amp;&amp; systemctl start docker$ docker --versionDocker version 18.06.1-ce, build e68fc7a</code></pre><h3 id="4-2-æ·»åŠ é˜¿é‡Œäº‘YUMè½¯ä»¶æº"><a href="#4-2-æ·»åŠ é˜¿é‡Œäº‘YUMè½¯ä»¶æº" class="headerlink" title="4.2 æ·»åŠ é˜¿é‡Œäº‘YUMè½¯ä»¶æº"></a>4.2 æ·»åŠ é˜¿é‡Œäº‘YUMè½¯ä»¶æº</h3><pre><code>$ cat &gt; /etc/yum.repos.d/kubernetes.repo &lt;&lt; EOF[kubernetes]name=Kubernetesbaseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64enabled=1gpgcheck=1repo_gpgcheck=1gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpgEOF</code></pre><h3 id="4-3-å®‰è£…kubeadmï¼Œkubeletå’Œkubectl"><a href="#4-3-å®‰è£…kubeadmï¼Œkubeletå’Œkubectl" class="headerlink" title="4.3 å®‰è£…kubeadmï¼Œkubeletå’Œkubectl"></a>4.3 å®‰è£…kubeadmï¼Œkubeletå’Œkubectl</h3><p>ç”±äºç‰ˆæœ¬æ›´æ–°é¢‘ç¹ï¼Œè¿™é‡ŒæŒ‡å®šç‰ˆæœ¬å·éƒ¨ç½²ï¼š</p><pre><code>$ yum install -y kubelet-1.14.0 kubeadm-1.14.0 kubectl-1.14.0$ systemctl enable kubelet</code></pre><h2 id="5-éƒ¨ç½²Kubernetes-Master"><a href="#5-éƒ¨ç½²Kubernetes-Master" class="headerlink" title="5. éƒ¨ç½²Kubernetes Master"></a>5. éƒ¨ç½²Kubernetes Master</h2><p>åœ¨192.168.31.63ï¼ˆMasterï¼‰æ‰§è¡Œã€‚</p><pre><code>$ kubeadm init \  --apiserver-advertise-address=192.168.31.63 \  --image-repository registry.aliyuncs.com/google_containers \  --kubernetes-version v1.14.0 \  --service-cidr=10.1.0.0/16 \  --pod-network-cidr=10.244.0.0/16</code></pre><p>ç”±äºé»˜è®¤æ‹‰å–é•œåƒåœ°å€k8s.gcr.ioå›½å†…æ— æ³•è®¿é—®ï¼Œè¿™é‡ŒæŒ‡å®šé˜¿é‡Œäº‘é•œåƒä»“åº“åœ°å€ã€‚</p><p>ä½¿ç”¨kubectlå·¥å…·ï¼š</p><pre><code>mkdir -p $HOME/.kubesudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/configsudo chown $(id -u):$(id -g) $HOME/.kube/config$ kubectl get nodes</code></pre><h2 id="6-å®‰è£…Podç½‘ç»œæ’ä»¶ï¼ˆCNIï¼‰"><a href="#6-å®‰è£…Podç½‘ç»œæ’ä»¶ï¼ˆCNIï¼‰" class="headerlink" title="6. å®‰è£…Podç½‘ç»œæ’ä»¶ï¼ˆCNIï¼‰"></a>6. å®‰è£…Podç½‘ç»œæ’ä»¶ï¼ˆCNIï¼‰</h2><pre><code>$ kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/a70459be0084506e4ec919aa1c114638878db11b/Documentation/kube-flannel.yml</code></pre><p>ç¡®ä¿èƒ½å¤Ÿè®¿é—®åˆ°quay.ioè¿™ä¸ªregisteryã€‚ masteræ‰§è¡Œ</p><p># kubectl get pods -n kube-system</p><h2 id="7-åŠ å…¥Kubernetes-Node"><a href="#7-åŠ å…¥Kubernetes-Node" class="headerlink" title="7. åŠ å…¥Kubernetes Node"></a>7. åŠ å…¥Kubernetes Node</h2><p>åœ¨192.168.31.65/66ï¼ˆNodeï¼‰æ‰§è¡Œã€‚</p><p>å‘é›†ç¾¤æ·»åŠ æ–°èŠ‚ç‚¹ï¼Œæ‰§è¡Œåœ¨kubeadm initè¾“å‡ºçš„kubeadm joinå‘½ä»¤ï¼š</p><pre><code>$  kubeadm join 192.168.31.63:6443 --token l79g5t.6ov4jkddwqki1dxe --discovery-token-ca-cert-hash sha256:4f07f9068c543130461c9db368d62b4aabc22105451057f887defa35f47fa076</code></pre><h2 id="8-æµ‹è¯•kubernetesé›†ç¾¤"><a href="#8-æµ‹è¯•kubernetesé›†ç¾¤" class="headerlink" title="8. æµ‹è¯•kubernetesé›†ç¾¤"></a>8. æµ‹è¯•kubernetesé›†ç¾¤</h2><p>åœ¨Kubernetesé›†ç¾¤ä¸­åˆ›å»ºä¸€ä¸ªpodï¼ŒéªŒè¯æ˜¯å¦æ­£å¸¸è¿è¡Œï¼š</p><pre><code>$ kubectl create deployment nginx --image=nginx$ kubectl expose deployment nginx --port=80 --type=NodePort$ kubectl get pod,svc$ kubectl get pod,svc -o wide</code></pre><p>è®¿é—®åœ°å€ï¼š<a href="http://NodeIP:Port">http://NodeIP:Port</a></p><h2 id="9-éƒ¨ç½²-Dashboard"><a href="#9-éƒ¨ç½²-Dashboard" class="headerlink" title="9. éƒ¨ç½² Dashboard"></a>9. éƒ¨ç½² Dashboard</h2><pre><code>$ kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v1.10.1/src/deploy/recommended/kubernetes-dashboard.yamlé•œåƒä¸‹è½½å› ä¸ºç½‘ç»œçš„åŸå› ï¼šé•œåƒéš¾ä»¥ä¸‹è½½ï¼Œéœ€è¦ä¿®æ”¹ä»¥ä¸‹ä¸¤ä¸ªåœ°æ–¹        image: tigerfive/kubernetes-dashboard-amd64:v1.10.1spec:  type: NodePort  ports:    - port: 443      targetPort: 8443</code></pre><p>é»˜è®¤Dashboardåªèƒ½é›†ç¾¤å†…éƒ¨è®¿é—®ï¼Œä¿®æ”¹Serviceä¸ºNodePortç±»å‹ï¼Œæš´éœ²åˆ°å¤–éƒ¨ï¼š</p><pre><code>kind: ServiceapiVersion: v1metadata:  labels:    k8s-app: kubernetes-dashboard  name: kubernetes-dashboard  namespace: kube-systemspec:  type: NodePort  ports:    - port: 443      targetPort: 8443      nodePort: 30001  selector:    k8s-app: kubernetes-dashboard$ kubectl apply -f kubernetes-dashboard.yaml</code></pre><p>è®¿é—®åœ°å€ï¼š<a href="http://NodeIP:30001" target="_blank" rel="noopener">http://NodeIP:30001</a></p><p>åˆ›å»ºservice accountå¹¶ç»‘å®šé»˜è®¤cluster-adminç®¡ç†å‘˜é›†ç¾¤è§’è‰²ï¼š</p><pre><code>$ kubectl create serviceaccount dashboard-admin -n kube-system$ kubectl create clusterrolebinding dashboard-admin --clusterrole=cluster-admin --serviceaccount=kube-system:dashboard-admin$ kubectl describe secrets -n kube-system $(kubectl -n kube-system get secret | awk &#39;/dashboard-admin/{print $1}&#39;)</code></pre><p>ä½¿ç”¨è¾“å‡ºçš„tokenç™»å½•Dashboardã€‚</p>]]></content>
      
      
      <categories>
          
          <category> å®¹å™¨ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kubernetes-å…¥é—¨</title>
      <link href="2020/03/14/rong-qi/kubernetes-ru-men/"/>
      <url>2020/03/14/rong-qi/kubernetes-ru-men/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h2 id="KubernetesåŠŸèƒ½"><a href="#KubernetesåŠŸèƒ½" class="headerlink" title="KubernetesåŠŸèƒ½"></a>KubernetesåŠŸèƒ½</h2><p>â€‹        å®˜æ–¹å®šä¹‰k8sèƒ½å¤Ÿå¯¹å®¹å™¨åŒ–è½¯ä»¶è¿›è¡Œéƒ¨ç½²ç®¡ç†ï¼Œåœ¨ä¸åœæœºçš„å‰æä¸‹æä¾›ç®€å•å¿«é€Ÿçš„å‘å¸ƒå’Œæ›´æ–°æ–¹å¼ã€‚æ¢å¥è¯è¯´ï¼Œå¦‚æœé¡¹ç›®éœ€è¦å¤šæœºå™¨èŠ‚ç‚¹çš„å¾®æœåŠ¡æ¶æ„ï¼Œå¹¶ä¸”é‡‡ç”¨Docker imageï¼ˆé•œåƒï¼‰è¿›è¡Œå®¹å™¨åŒ–éƒ¨ç½²ï¼Œé‚£ä¹ˆk8så¯ä»¥å¸®åŠ©æˆ‘ä»¬å±è”½æ‰é›†ç¾¤çš„å¤æ‚æ€§ï¼Œè‡ªåŠ¨é€‰æ‹©æœ€ä¼˜èµ„æºåˆ†é…æ–¹å¼è¿›è¡Œéƒ¨ç½²ã€‚åœ¨æ­¤åŸºç¡€ä¸Šï¼Œk8sè¿˜æä¾›ç®€å•çš„å¤šå®ä¾‹éƒ¨ç½²åŠæ›´æ–°æ–¹æ¡ˆï¼Œä»…éœ€å‡ ä¸ªæ“ä½œå‘½ä»¤å°±å¯ä»¥è½»æ¾å®ç°ã€‚</p><h2 id="k8sé›†ç¾¤ç®€å•ä»‹ç»"><a href="#k8sé›†ç¾¤ç®€å•ä»‹ç»" class="headerlink" title="k8sé›†ç¾¤ç®€å•ä»‹ç»"></a>k8sé›†ç¾¤ç®€å•ä»‹ç»</h2><p><img src="https://s1.ax1x.com/2020/05/04/YCTTYR.png" alt="YCTTYR.png"></p><p><strong>Master è´Ÿè´£ç®¡ç†é›†ç¾¤</strong> è´Ÿè´£åè°ƒé›†ç¾¤ä¸­çš„æ‰€æœ‰æ´»åŠ¨ï¼Œä¾‹å¦‚è°ƒåº¦åº”ç”¨ç¨‹åºï¼Œç»´æŠ¤åº”ç”¨ç¨‹åºçš„çŠ¶æ€ï¼Œæ‰©å±•å’Œæ›´æ–°åº”ç”¨ç¨‹åºã€‚</p><p><strong>WorkerèŠ‚ç‚¹(å³å›¾ä¸­çš„Node)æ˜¯VM(è™šæ‹Ÿæœº)æˆ–ç‰©ç†è®¡ç®—æœºï¼Œå……å½“k8sé›†ç¾¤ä¸­çš„å·¥ä½œè®¡ç®—æœºã€‚</strong> æ¯ä¸ªWorkerèŠ‚ç‚¹éƒ½æœ‰ä¸€ä¸ªKubeletï¼Œå®ƒç®¡ç†è¯¥WorkerèŠ‚ç‚¹å¹¶è´Ÿè´£ä¸MasterèŠ‚ç‚¹é€šä¿¡ã€‚è¯¥WorkerèŠ‚ç‚¹è¿˜åº”å…·æœ‰ç”¨äºå¤„ç†å®¹å™¨æ“ä½œçš„å·¥å…·ï¼Œä¾‹å¦‚Dockerã€‚</p><h1 id="1-éƒ¨ç½²ä¸€ä¸ªåº”ç”¨ç¨‹åº"><a href="#1-éƒ¨ç½²ä¸€ä¸ªåº”ç”¨ç¨‹åº" class="headerlink" title="1.éƒ¨ç½²ä¸€ä¸ªåº”ç”¨ç¨‹åº"></a>1.éƒ¨ç½²ä¸€ä¸ªåº”ç”¨ç¨‹åº</h1><h3 id="å‰æ"><a href="#å‰æ" class="headerlink" title="å‰æ"></a>å‰æ</h3><p>å·²ç»</p><ul><li>å®Œæˆ Kubernetes é›†ç¾¤çš„å®‰è£…ï¼Œè¯·å‚è€ƒæ–‡æ¡£ <a href="https://www.kuboard.cn/install/install-k8s.html" target="_blank" rel="noopener">å®‰è£… Kubernetes å•MasterèŠ‚ç‚¹</a></li></ul><h3 id="ç›®æ ‡"><a href="#ç›®æ ‡" class="headerlink" title="ç›®æ ‡"></a>ç›®æ ‡</h3><ul><li>ä½¿ç”¨ kubectl åœ¨ k8s ä¸Šéƒ¨ç½²ç¬¬ä¸€ä¸ªåº”ç”¨ç¨‹åºã€‚</li></ul><p>TIP</p><ul><li>kubectl æ˜¯ k8s çš„å®¢æˆ·ç«¯å·¥å…·ï¼Œå¯ä»¥ä½¿ç”¨å‘½ä»¤è¡Œç®¡ç†é›†ç¾¤ã€‚</li><li>å¦‚æœå‚è€ƒæ–‡æ¡£ <a href="https://www.kuboard.cn/install/install-k8s.html" target="_blank" rel="noopener">å®‰è£… Kubernetes å•MasterèŠ‚ç‚¹</a>ï¼Œæ‚¨å¯ä»¥åœ¨ master èŠ‚ç‚¹çš„ root ç”¨æˆ·ä½¿ç”¨ kubectl æ“ä½œæ‚¨çš„é›†ç¾¤</li><li>æ‚¨ä¹Ÿå¯ä»¥å°è¯• <a href="https://www.kuboard.cn/install/install-kubectl.html" target="_blank" rel="noopener">ä»å®¢æˆ·ç«¯ç”µè„‘è¿œç¨‹ç®¡ç† Kubernetes</a></li></ul><h3 id="Kubernetes-éƒ¨ç½²"><a href="#Kubernetes-éƒ¨ç½²" class="headerlink" title="Kubernetes éƒ¨ç½²"></a>Kubernetes éƒ¨ç½²</h3><p>åœ¨ k8s ä¸Šè¿›è¡Œéƒ¨ç½²å‰ï¼Œé¦–å…ˆéœ€è¦äº†è§£ä¸€ä¸ªåŸºæœ¬æ¦‚å¿µ <strong>Deployment</strong></p><p><strong>Deployment</strong> è¯‘åä¸º <strong>éƒ¨ç½²</strong>ã€‚åœ¨k8sä¸­ï¼Œé€šè¿‡å‘å¸ƒ Deploymentï¼Œå¯ä»¥åˆ›å»ºåº”ç”¨ç¨‹åº (docker image) çš„å®ä¾‹ (docker container)ï¼Œè¿™ä¸ªå®ä¾‹ä¼šè¢«åŒ…å«åœ¨ç§°ä¸º <strong>Pod</strong> çš„æ¦‚å¿µä¸­ï¼Œ<strong>Pod</strong> æ˜¯ k8s ä¸­æœ€å°å¯ç®¡ç†å•å…ƒã€‚</p><p>åœ¨ k8s é›†ç¾¤ä¸­å‘å¸ƒ Deployment åï¼ŒDeployment å°†æŒ‡ç¤º k8s å¦‚ä½•åˆ›å»ºå’Œæ›´æ–°åº”ç”¨ç¨‹åºçš„å®ä¾‹ï¼Œmaster èŠ‚ç‚¹å°†åº”ç”¨ç¨‹åºå®ä¾‹è°ƒåº¦åˆ°é›†ç¾¤ä¸­çš„å…·ä½“çš„èŠ‚ç‚¹ä¸Šã€‚</p><p>åˆ›å»ºåº”ç”¨ç¨‹åºå®ä¾‹åï¼ŒKubernetes Deployment Controller ä¼šæŒç»­ç›‘æ§è¿™äº›å®ä¾‹ã€‚å¦‚æœè¿è¡Œå®ä¾‹çš„ worker èŠ‚ç‚¹å…³æœºæˆ–è¢«åˆ é™¤ï¼Œåˆ™ Kubernetes Deployment Controller å°†åœ¨ç¾¤é›†ä¸­èµ„æºæœ€ä¼˜çš„å¦ä¸€ä¸ª worker èŠ‚ç‚¹ä¸Šé‡æ–°åˆ›å»ºä¸€ä¸ªæ–°çš„å®ä¾‹ã€‚<strong>è¿™æä¾›äº†ä¸€ç§è‡ªæˆ‘ä¿®å¤æœºåˆ¶æ¥è§£å†³æœºå™¨æ•…éšœæˆ–ç»´æŠ¤é—®é¢˜ã€‚</strong></p><p>åœ¨å®¹å™¨ç¼–æ’ä¹‹å‰çš„æ—¶ä»£ï¼Œå„ç§å®‰è£…è„šæœ¬é€šå¸¸ç”¨äºå¯åŠ¨åº”ç”¨ç¨‹åºï¼Œä½†æ˜¯ä¸èƒ½å¤Ÿä½¿åº”ç”¨ç¨‹åºä»æœºå™¨æ•…éšœä¸­æ¢å¤ã€‚é€šè¿‡åˆ›å»ºåº”ç”¨ç¨‹åºå®ä¾‹å¹¶ç¡®ä¿å®ƒä»¬åœ¨é›†ç¾¤èŠ‚ç‚¹ä¸­çš„è¿è¡Œå®ä¾‹ä¸ªæ•°ï¼ŒKubernetes Deployment æä¾›äº†ä¸€ç§å®Œå…¨ä¸åŒçš„æ–¹å¼æ¥ç®¡ç†åº”ç”¨ç¨‹åºã€‚</p><h2 id="åœ¨-Kubernetes-ä¸Šéƒ¨ç½²ç¬¬ä¸€ä¸ªåº”ç”¨ç¨‹åº"><a href="#åœ¨-Kubernetes-ä¸Šéƒ¨ç½²ç¬¬ä¸€ä¸ªåº”ç”¨ç¨‹åº" class="headerlink" title="åœ¨ Kubernetes ä¸Šéƒ¨ç½²ç¬¬ä¸€ä¸ªåº”ç”¨ç¨‹åº"></a>åœ¨ Kubernetes ä¸Šéƒ¨ç½²ç¬¬ä¸€ä¸ªåº”ç”¨ç¨‹åº</h2><p><img src="https://s1.ax1x.com/2020/05/04/YCLxJJ.png" alt="YCLxJJ.png"></p><p>â€‹        Deployment å¤„äº master èŠ‚ç‚¹ä¸Šï¼Œé€šè¿‡å‘å¸ƒ Deploymentï¼Œmaster èŠ‚ç‚¹ä¼šé€‰æ‹©åˆé€‚çš„ worker èŠ‚ç‚¹åˆ›å»º Containerï¼ˆå³å›¾ä¸­çš„æ­£æ–¹ä½“ï¼‰ï¼ŒContainer ä¼šè¢«åŒ…å«åœ¨ Pod ï¼ˆå³è“è‰²åœ†åœˆï¼‰é‡Œã€‚</p><h2 id="éƒ¨ç½²-nginx-Deployment"><a href="#éƒ¨ç½²-nginx-Deployment" class="headerlink" title="éƒ¨ç½² nginx Deployment"></a>éƒ¨ç½² nginx Deployment</h2><p><strong>åˆ›å»º YAML æ–‡ä»¶</strong></p><p>åˆ›å»ºæ–‡ä»¶ nginx-deployment.yamlï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1    <span class="token comment" spellcheck="true">#ä¸k8sé›†ç¾¤ç‰ˆæœ¬æœ‰å…³ï¼Œä½¿ç”¨ kubectl api-versions å³å¯æŸ¥çœ‹å½“å‰é›†ç¾¤æ”¯æŒçš„ç‰ˆæœ¬</span><span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment    <span class="token comment" spellcheck="true">#è¯¥é…ç½®çš„ç±»å‹ï¼Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ Deployment</span><span class="token key atrule">metadata</span><span class="token punctuation">:</span>            <span class="token comment" spellcheck="true">#è¯‘åä¸ºå…ƒæ•°æ®ï¼Œå³ Deployment çš„ä¸€äº›åŸºæœ¬å±æ€§å’Œä¿¡æ¯</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>deployment    <span class="token comment" spellcheck="true">#Deployment çš„åç§°</span>  <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token comment" spellcheck="true">#æ ‡ç­¾ï¼Œå¯ä»¥çµæ´»å®šä½ä¸€ä¸ªæˆ–å¤šä¸ªèµ„æºï¼Œå…¶ä¸­keyå’Œvalueå‡å¯è‡ªå®šä¹‰ï¼Œå¯ä»¥å®šä¹‰å¤šç»„ï¼Œç›®å‰ä¸éœ€è¦ç†è§£</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx    <span class="token comment" spellcheck="true">#ä¸ºè¯¥Deploymentè®¾ç½®keyä¸ºappï¼Œvalueä¸ºnginxçš„æ ‡ç­¾</span><span class="token key atrule">spec</span><span class="token punctuation">:</span>            <span class="token comment" spellcheck="true">#è¿™æ˜¯å…³äºè¯¥Deploymentçš„æè¿°ï¼Œå¯ä»¥ç†è§£ä¸ºä½ æœŸå¾…è¯¥Deploymentåœ¨k8sä¸­å¦‚ä½•ä½¿ç”¨</span>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1    </span><span class="token comment" spellcheck="true">#ä½¿ç”¨è¯¥Deploymentåˆ›å»ºä¸€ä¸ªåº”ç”¨ç¨‹åºå®ä¾‹</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>        <span class="token comment" spellcheck="true">#æ ‡ç­¾é€‰æ‹©å™¨ï¼Œä¸ä¸Šé¢çš„æ ‡ç­¾å…±åŒä½œç”¨ï¼Œç›®å‰ä¸éœ€è¦ç†è§£</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true">#é€‰æ‹©åŒ…å«æ ‡ç­¾app:nginxçš„èµ„æº</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx  <span class="token key atrule">template</span><span class="token punctuation">:</span>        <span class="token comment" spellcheck="true">#è¿™æ˜¯é€‰æ‹©æˆ–åˆ›å»ºçš„Podçš„æ¨¡æ¿</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>    <span class="token comment" spellcheck="true">#Podçš„å…ƒæ•°æ®</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token comment" spellcheck="true">#Podçš„æ ‡ç­¾ï¼Œä¸Šé¢çš„selectorå³é€‰æ‹©åŒ…å«æ ‡ç­¾app:nginxçš„Pod</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx    <span class="token key atrule">spec</span><span class="token punctuation">:</span>        <span class="token comment" spellcheck="true">#æœŸæœ›Podå®ç°çš„åŠŸèƒ½ï¼ˆå³åœ¨podä¸­éƒ¨ç½²ï¼‰</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>    <span class="token comment" spellcheck="true">#ç”Ÿæˆcontainerï¼Œä¸dockerä¸­çš„containeræ˜¯åŒä¸€ç§</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx    <span class="token comment" spellcheck="true">#containerçš„åç§°</span>        <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.7.9    <span class="token comment" spellcheck="true">#ä½¿ç”¨é•œåƒnginx:1.7.9åˆ›å»ºcontainerï¼Œè¯¥containeré»˜è®¤80ç«¯å£å¯è®¿é—®</span></code></pre><p><strong>åº”ç”¨ YAML æ–‡ä»¶</strong></p><pre class=" language-shell"><code class="language-shell">kubectl apply -f nginx-deployment.yaml</code></pre><p><strong>æŸ¥çœ‹éƒ¨ç½²ç»“æœ</strong></p><pre><code># æŸ¥çœ‹ Deploymentkubectl get deployments# æŸ¥çœ‹ Podkubectl get pods</code></pre><p>å¯åˆ†åˆ«æŸ¥çœ‹åˆ°ä¸€ä¸ªåä¸º nginx-deployment çš„ Deployment å’Œä¸€ä¸ªåä¸º nginx-deployment-xxxxxxx çš„ Pod</p><h1 id="2-æŸ¥çœ‹Pods-Nodes"><a href="#2-æŸ¥çœ‹Pods-Nodes" class="headerlink" title="2.æŸ¥çœ‹Pods/Nodes"></a>2.æŸ¥çœ‹Pods/Nodes</h1><h2 id="Kubernetes-Pods"><a href="#Kubernetes-Pods" class="headerlink" title="Kubernetes Pods"></a>Kubernetes Pods</h2><p>åœ¨ <a href="https://www.kuboard.cn/learning/k8s-basics/deploy-app.html" target="_blank" rel="noopener">éƒ¨ç½²ç¬¬ä¸€ä¸ªåº”ç”¨ç¨‹åº</a> ä¸­åˆ›å»º Deployment åï¼Œk8såˆ›å»ºäº†ä¸€ä¸ª <strong>Podï¼ˆå®¹å™¨ç»„ï¼‰</strong> æ¥æ”¾ç½®åº”ç”¨ç¨‹åºå®ä¾‹ï¼ˆcontainer å®¹å™¨ï¼‰ã€‚</p><h2 id="Podsæ¦‚è¿°"><a href="#Podsæ¦‚è¿°" class="headerlink" title="Podsæ¦‚è¿°"></a>Podsæ¦‚è¿°</h2><p><img src="https://s1.ax1x.com/2020/05/04/YCjWdK.png" alt="YCjWdK.png"></p><p><strong>Pod å®¹å™¨ç»„</strong> æ˜¯ä¸€ä¸ªk8sä¸­ä¸€ä¸ªæŠ½è±¡çš„æ¦‚å¿µï¼Œç”¨äºå­˜æ”¾ä¸€ç»„ containerï¼ˆå¯åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ª container å®¹å™¨ï¼Œå³å›¾ä¸Šæ­£æ–¹ä½“)ï¼Œä»¥åŠè¿™äº› container ï¼ˆå®¹å™¨ï¼‰çš„ä¸€äº›å…±äº«èµ„æºã€‚è¿™äº›èµ„æºåŒ…æ‹¬ï¼š</p><ul><li>å…±äº«å­˜å‚¨ï¼Œç§°ä¸ºå·(Volumes)ï¼Œå³å›¾ä¸Šç´«è‰²åœ†æŸ±</li><li>ç½‘ç»œï¼Œæ¯ä¸ª Podï¼ˆå®¹å™¨ç»„ï¼‰åœ¨é›†ç¾¤ä¸­æœ‰ä¸ªå”¯ä¸€çš„ IPï¼Œpodï¼ˆå®¹å™¨ç»„ï¼‰ä¸­çš„ containerï¼ˆå®¹å™¨ï¼‰å…±äº«è¯¥IPåœ°å€</li><li>containerï¼ˆå®¹å™¨ï¼‰çš„åŸºæœ¬ä¿¡æ¯ï¼Œä¾‹å¦‚å®¹å™¨çš„é•œåƒç‰ˆæœ¬ï¼Œå¯¹å¤–æš´éœ²çš„ç«¯å£ç­‰</li></ul><blockquote><p>ä¾‹å¦‚ï¼ŒPodå¯èƒ½æ—¢åŒ…å«å¸¦æœ‰Node.jsåº”ç”¨ç¨‹åºçš„ container å®¹å™¨ï¼Œä¹ŸåŒ…å«å¦ä¸€ä¸ªé Node.js çš„ container å®¹å™¨ï¼Œç”¨äºæä¾› Node.js webserver è¦å‘å¸ƒçš„æ•°æ®ã€‚Podä¸­çš„å®¹å™¨å…±äº« IP åœ°å€å’Œç«¯å£ç©ºé—´ï¼ˆåŒä¸€ Pod ä¸­çš„ä¸åŒ container ç«¯å£ä¸èƒ½ç›¸äº’å†²çªï¼‰ï¼Œå§‹ç»ˆä½äºåŒä¸€ä½ç½®å¹¶å…±åŒè°ƒåº¦ï¼Œå¹¶åœ¨åŒä¸€èŠ‚ç‚¹ä¸Šçš„å…±äº«ä¸Šä¸‹æ–‡ä¸­è¿è¡Œã€‚ï¼ˆåŒä¸€ä¸ªPodå†…çš„å®¹å™¨å¯ä»¥ä½¿ç”¨ localhost + ç«¯å£å·äº’ç›¸è®¿é—®ï¼‰ã€‚</p></blockquote><p>Podï¼ˆå®¹å™¨ç»„ï¼‰æ˜¯ k8s é›†ç¾¤ä¸Šçš„æœ€åŸºæœ¬çš„å•å…ƒã€‚å½“æˆ‘ä»¬åœ¨ k8s ä¸Šåˆ›å»º Deployment æ—¶ï¼Œä¼šåœ¨é›†ç¾¤ä¸Šåˆ›å»ºåŒ…å«å®¹å™¨çš„ Pod (è€Œä¸æ˜¯ç›´æ¥åˆ›å»ºå®¹å™¨)ã€‚æ¯ä¸ªPodéƒ½ä¸è¿è¡Œå®ƒçš„ worker èŠ‚ç‚¹ï¼ˆNodeï¼‰ç»‘å®šï¼Œå¹¶ä¿æŒåœ¨é‚£é‡Œç›´åˆ°ç»ˆæ­¢æˆ–è¢«åˆ é™¤ã€‚å¦‚æœèŠ‚ç‚¹ï¼ˆNodeï¼‰å‘ç”Ÿæ•…éšœï¼Œåˆ™ä¼šåœ¨ç¾¤é›†ä¸­çš„å…¶ä»–å¯ç”¨èŠ‚ç‚¹ï¼ˆNodeï¼‰ä¸Šè¿è¡Œç›¸åŒçš„ Podï¼ˆä»åŒæ ·çš„é•œåƒåˆ›å»º Containerï¼Œä½¿ç”¨åŒæ ·çš„é…ç½®ï¼ŒIP åœ°å€ä¸åŒï¼ŒPod åå­—</p><p>TIP</p><p>é‡è¦ï¼š</p><ul><li><p>Pod æ˜¯ä¸€ç»„å®¹å™¨ï¼ˆå¯åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªåº”ç”¨ç¨‹åºå®¹å™¨ï¼‰ï¼Œä»¥åŠå…±äº«å­˜å‚¨ï¼ˆå· Volumesï¼‰ã€IP åœ°å€å’Œæœ‰å…³å¦‚ä½•è¿è¡Œå®¹å™¨çš„ä¿¡æ¯ã€‚</p></li><li><p>å¦‚æœå¤šä¸ªå®¹å™¨ç´§å¯†è€¦åˆå¹¶ä¸”éœ€è¦å…±äº«ç£ç›˜ç­‰èµ„æºï¼Œåˆ™ä»–ä»¬åº”è¯¥è¢«éƒ¨ç½²åœ¨åŒä¸€ä¸ªPodï¼ˆå®¹å™¨ç»„ï¼‰ä¸­ã€‚</p></li></ul><h2 id="Nodeï¼ˆèŠ‚ç‚¹ï¼‰"><a href="#Nodeï¼ˆèŠ‚ç‚¹ï¼‰" class="headerlink" title="Nodeï¼ˆèŠ‚ç‚¹ï¼‰"></a>Nodeï¼ˆèŠ‚ç‚¹ï¼‰</h2><p>ä¸‹å›¾æ˜¾ç¤ºä¸€ä¸ª Nodeï¼ˆèŠ‚ç‚¹ï¼‰ä¸Šå«æœ‰4ä¸ª Podï¼ˆå®¹å™¨ç»„ï¼‰</p><p><img src="https://s1.ax1x.com/2020/05/04/YCxkjA.png" alt="YCxkjA.png"></p><p>Podï¼ˆå®¹å™¨ç»„ï¼‰æ€»æ˜¯åœ¨ <strong>Nodeï¼ˆèŠ‚ç‚¹ï¼‰</strong> ä¸Šè¿è¡Œã€‚Nodeï¼ˆèŠ‚ç‚¹ï¼‰æ˜¯ kubernetes é›†ç¾¤ä¸­çš„è®¡ç®—æœºï¼Œå¯ä»¥æ˜¯è™šæ‹Ÿæœºæˆ–ç‰©ç†æœºã€‚æ¯ä¸ª Nodeï¼ˆèŠ‚ç‚¹ï¼‰éƒ½ç”± master ç®¡ç†ã€‚ä¸€ä¸ª Nodeï¼ˆèŠ‚ç‚¹ï¼‰å¯ä»¥æœ‰å¤šä¸ªPodï¼ˆå®¹å™¨ç»„ï¼‰ï¼Œkubernetes master ä¼šæ ¹æ®æ¯ä¸ª Nodeï¼ˆèŠ‚ç‚¹ï¼‰ä¸Šå¯ç”¨èµ„æºçš„æƒ…å†µï¼Œè‡ªåŠ¨è°ƒåº¦ Podï¼ˆå®¹å™¨ç»„ï¼‰åˆ°æœ€ä½³çš„ Nodeï¼ˆèŠ‚ç‚¹ï¼‰ä¸Šã€‚</p><p>æ¯ä¸ª Kubernetes Nodeï¼ˆèŠ‚ç‚¹ï¼‰è‡³å°‘è¿è¡Œï¼š</p><ul><li><p>Kubeletï¼Œè´Ÿè´£ master èŠ‚ç‚¹å’Œ worker èŠ‚ç‚¹ä¹‹é—´é€šä¿¡çš„è¿›ç¨‹ï¼›ç®¡ç† Podï¼ˆå®¹å™¨ç»„ï¼‰å’Œ Podï¼ˆå®¹å™¨ç»„ï¼‰å†…è¿è¡Œçš„ Containerï¼ˆå®¹å™¨ï¼‰ã€‚</p></li><li><p>å®¹å™¨è¿è¡Œç¯å¢ƒï¼ˆå¦‚Dockerï¼‰è´Ÿè´£ä¸‹è½½é•œåƒã€åˆ›å»ºå’Œè¿è¡Œå®¹å™¨ç­‰ã€‚</p></li></ul><h2 id="æ•…éšœæ’é™¤"><a href="#æ•…éšœæ’é™¤" class="headerlink" title="æ•…éšœæ’é™¤"></a>æ•…éšœæ’é™¤</h2><p>åœ¨<a href="https://www.kuboard.cn/learning/k8s-basics/deploy-app.html" target="_blank" rel="noopener">éƒ¨ç½²ç¬¬ä¸€ä¸ªåº”ç”¨ç¨‹åº</a> ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº† kubectl å‘½ä»¤è¡Œç•Œé¢éƒ¨ç½²äº† nginx å¹¶ä¸”æŸ¥çœ‹äº† Deployment å’Œ Podã€‚kubectl è¿˜æœ‰å¦‚ä¸‹å››ä¸ªå¸¸ç”¨å‘½ä»¤ï¼Œåœ¨æˆ‘ä»¬æ’æŸ¥é—®é¢˜æ—¶å¯ä»¥æä¾›å¸®åŠ©ï¼š</p><ul><li><strong>kubectl get</strong> - æ˜¾ç¤ºèµ„æºåˆ—è¡¨</li></ul><pre class=" language-shell"><code class="language-shell"># kubectl get èµ„æºç±»å‹#è·å–ç±»å‹ä¸ºDeploymentçš„èµ„æºåˆ—è¡¨kubectl get deployments#è·å–ç±»å‹ä¸ºPodçš„èµ„æºåˆ—è¡¨kubectl get pods#è·å–ç±»å‹ä¸ºNodeçš„èµ„æºåˆ—è¡¨kubectl get nodes</code></pre><blockquote><p>åç§°ç©ºé—´</p><p>åœ¨å‘½ä»¤åå¢åŠ  <code>-A</code> æˆ– <code>--all-namespaces</code> å¯æŸ¥çœ‹æ‰€æœ‰ <a href="https://www.kuboard.cn/learning/k8s-intermediate/obj/namespaces.html" target="_blank" rel="noopener">åç§°ç©ºé—´ä¸­</a> çš„å¯¹è±¡ï¼Œä½¿ç”¨å‚æ•° <code>-n</code> å¯æŸ¥çœ‹æŒ‡å®šåç§°ç©ºé—´çš„å¯¹è±¡ï¼Œä¾‹å¦‚</p><pre class=" language-shell"><code class="language-shell"># æŸ¥çœ‹æ‰€æœ‰åç§°ç©ºé—´çš„ Deploymentkubectl get deployments -Akubectl get deployments --all-namespaces# æŸ¥çœ‹ kube-system åç§°ç©ºé—´çš„ Deploymentkubectl get deployments -n kube-system</code></pre><p>å¹¶éæ‰€æœ‰å¯¹è±¡éƒ½åœ¨åç§°ç©ºé—´é‡Œ)</p></blockquote><ul><li><strong>kubectl describe</strong> - æ˜¾ç¤ºæœ‰å…³èµ„æºçš„è¯¦ç»†ä¿¡æ¯</li></ul><pre class=" language-shell"><code class="language-shell"># kubectl describe èµ„æºç±»å‹ èµ„æºåç§°#æŸ¥çœ‹åç§°ä¸ºnginx-XXXXXXçš„Podçš„ä¿¡æ¯kubectl describe pod nginx-XXXXXX    #æŸ¥çœ‹åç§°ä¸ºnginxçš„Deploymentçš„ä¿¡æ¯kubectl describe deployment nginx    </code></pre><ul><li><strong>kubectl logs</strong> - æŸ¥çœ‹podä¸­çš„å®¹å™¨çš„æ‰“å°æ—¥å¿—ï¼ˆå’Œå‘½ä»¤docker logs ç±»ä¼¼ï¼‰</li></ul><pre class=" language-shell"><code class="language-shell"># kubectl logs Podåç§°#æŸ¥çœ‹åç§°ä¸ºnginx-pod-XXXXXXXçš„Podå†…çš„å®¹å™¨æ‰“å°çš„æ—¥å¿—#æœ¬æ¡ˆä¾‹ä¸­çš„ nginx-pod æ²¡æœ‰è¾“å‡ºæ—¥å¿—ï¼Œæ‰€ä»¥æ‚¨çœ‹åˆ°çš„ç»“æœæ˜¯ç©ºçš„kubectl logs -f nginx-pod-XXXXXXX</code></pre><p>å°è¯•åœ¨é›†ç¾¤ä¸­æ‰§è¡Œä¸€ä¸‹ä¸Šè¿°çš„å‡ ä¸ªå‘½ä»¤ï¼Œå¯ä»¥äº†è§£å¦‚ä½•é€šè¿‡ kubectl æ“ä½œ kubernetes é›†ç¾¤ä¸­çš„ Nodeã€Podã€Containerã€‚</p><blockquote><p>TIP</p><p>WorkerèŠ‚ç‚¹æ˜¯k8sä¸­çš„å·¥ä½œè®¡ç®—æœºï¼Œå¯èƒ½æ˜¯VMæˆ–ç‰©ç†è®¡ç®—æœºï¼Œå…·ä½“å–å†³äºç¾¤é›†ã€‚å¤šä¸ªPodå¯ä»¥åœ¨ä¸€ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œã€‚</p></blockquote><h1 id="3-å…¬å¸ƒåº”ç”¨ç¨‹åº"><a href="#3-å…¬å¸ƒåº”ç”¨ç¨‹åº" class="headerlink" title="3.å…¬å¸ƒåº”ç”¨ç¨‹åº"></a>3.å…¬å¸ƒåº”ç”¨ç¨‹åº</h1><h2 id="Kubernetes-Serviceï¼ˆæœåŠ¡ï¼‰æ¦‚è¿°"><a href="#Kubernetes-Serviceï¼ˆæœåŠ¡ï¼‰æ¦‚è¿°" class="headerlink" title="Kubernetes Serviceï¼ˆæœåŠ¡ï¼‰æ¦‚è¿°"></a>Kubernetes Serviceï¼ˆæœåŠ¡ï¼‰æ¦‚è¿°</h2><p>äº‹å®ä¸Šï¼ŒPodï¼ˆå®¹å™¨ç»„ï¼‰æœ‰è‡ªå·±çš„ <a href="https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle/" target="_blank" rel="noopener">ç”Ÿå‘½å‘¨æœŸ</a>ã€‚å½“ worker nodeï¼ˆèŠ‚ç‚¹ï¼‰æ•…éšœæ—¶ï¼ŒèŠ‚ç‚¹ä¸Šè¿è¡Œçš„ Podï¼ˆå®¹å™¨ç»„ï¼‰ä¹Ÿä¼šæ¶ˆå¤±ã€‚ç„¶åï¼Œ<a href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/" target="_blank" rel="noopener">Deployment</a> å¯ä»¥é€šè¿‡åˆ›å»ºæ–°çš„ Podï¼ˆå®¹å™¨ç»„ï¼‰æ¥åŠ¨æ€åœ°å°†ç¾¤é›†è°ƒæ•´å›åŸæ¥çš„çŠ¶æ€ï¼Œä»¥ä½¿åº”ç”¨ç¨‹åºä¿æŒè¿è¡Œã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œå‡è®¾æœ‰ä¸€ä¸ªå›¾åƒå¤„ç†åç«¯ç¨‹åºï¼Œå…·æœ‰ 3 ä¸ªè¿è¡Œæ—¶å‰¯æœ¬ã€‚è¿™ 3 ä¸ªå‰¯æœ¬æ˜¯å¯ä»¥æ›¿æ¢çš„ï¼ˆæ— çŠ¶æ€åº”ç”¨ï¼‰ï¼Œå³ä½¿ Podï¼ˆå®¹å™¨ç»„ï¼‰æ¶ˆå¤±å¹¶è¢«é‡æ–°åˆ›å»ºï¼Œæˆ–è€…å‰¯æœ¬æ•°ç”± 3 å¢åŠ åˆ° 5ï¼Œå‰ç«¯ç³»ç»Ÿä¹Ÿæ— éœ€å…³æ³¨åç«¯å‰¯æœ¬çš„å˜åŒ–ã€‚ç”±äº Kubernetes é›†ç¾¤ä¸­æ¯ä¸ª Podï¼ˆå®¹å™¨ç»„ï¼‰éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„ IP åœ°å€ï¼ˆå³ä½¿æ˜¯åŒä¸€ä¸ª Node ä¸Šçš„ä¸åŒ Podï¼‰ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ç§æœºåˆ¶ï¼Œä¸ºå‰ç«¯ç³»ç»Ÿå±è”½åç«¯ç³»ç»Ÿçš„ Podï¼ˆå®¹å™¨ç»„ï¼‰åœ¨é”€æ¯ã€åˆ›å»ºè¿‡ç¨‹ä¸­æ‰€å¸¦æ¥çš„ IP åœ°å€çš„å˜åŒ–ã€‚</p><p>Kubernetes ä¸­çš„ <strong>Serviceï¼ˆæœåŠ¡ï¼‰</strong> æä¾›äº†è¿™æ ·çš„ä¸€ä¸ªæŠ½è±¡å±‚ï¼Œå®ƒé€‰æ‹©å…·å¤‡æŸäº›ç‰¹å¾çš„ Podï¼ˆå®¹å™¨ç»„ï¼‰å¹¶ä¸ºå®ƒä»¬å®šä¹‰ä¸€ä¸ªè®¿é—®æ–¹å¼ã€‚Serviceï¼ˆæœåŠ¡ï¼‰ä½¿ Podï¼ˆå®¹å™¨ç»„ï¼‰ä¹‹é—´çš„ç›¸äº’ä¾èµ–è§£è€¦ï¼ˆåŸæœ¬ä»ä¸€ä¸ª Pod ä¸­è®¿é—®å¦å¤–ä¸€ä¸ª Podï¼Œéœ€è¦çŸ¥é“å¯¹æ–¹çš„ IP åœ°å€ï¼‰ã€‚ä¸€ä¸ª Serviceï¼ˆæœåŠ¡ï¼‰é€‰å®šå“ªäº› <strong>Podï¼ˆå®¹å™¨ç»„ï¼‰</strong> é€šå¸¸ç”± <strong>LabelSelector(æ ‡ç­¾é€‰æ‹©å™¨)</strong> æ¥å†³å®šã€‚</p><p>åœ¨åˆ›å»ºServiceçš„æ—¶å€™ï¼Œé€šè¿‡è®¾ç½®é…ç½®æ–‡ä»¶ä¸­çš„ spec.type å­—æ®µçš„å€¼ï¼Œå¯ä»¥ä»¥ä¸åŒæ–¹å¼å‘å¤–éƒ¨æš´éœ²åº”ç”¨ç¨‹åºï¼š</p><ul><li><p><strong>ClusterIP</strong>ï¼ˆé»˜è®¤ï¼‰</p><p>åœ¨ç¾¤é›†ä¸­çš„å†…éƒ¨IPä¸Šå…¬å¸ƒæœåŠ¡ï¼Œè¿™ç§æ–¹å¼çš„ Serviceï¼ˆæœåŠ¡ï¼‰åªåœ¨é›†ç¾¤å†…éƒ¨å¯ä»¥è®¿é—®åˆ°</p></li><li><p><strong>NodePort</strong></p><p>ä½¿ç”¨ NAT åœ¨é›†ç¾¤ä¸­æ¯ä¸ªçš„åŒä¸€ç«¯å£ä¸Šå…¬å¸ƒæœåŠ¡ã€‚è¿™ç§æ–¹å¼ä¸‹ï¼Œå¯ä»¥é€šè¿‡è®¿é—®é›†ç¾¤ä¸­ä»»æ„èŠ‚ç‚¹+ç«¯å£å·çš„æ–¹å¼è®¿é—®æœåŠ¡ <code>:</code>ã€‚æ­¤æ—¶ ClusterIP çš„è®¿é—®æ–¹å¼ä»ç„¶å¯ç”¨ã€‚</p></li><li><p><strong>LoadBalancer</strong></p><p>åœ¨äº‘ç¯å¢ƒä¸­ï¼ˆéœ€è¦äº‘ä¾›åº”å•†å¯ä»¥æ”¯æŒï¼‰åˆ›å»ºä¸€ä¸ªé›†ç¾¤å¤–éƒ¨çš„è´Ÿè½½å‡è¡¡å™¨ï¼Œå¹¶ä¸ºä½¿ç”¨è¯¥è´Ÿè½½å‡è¡¡å™¨çš„ IP åœ°å€ä½œä¸ºæœåŠ¡çš„è®¿é—®åœ°å€ã€‚æ­¤æ—¶ ClusterIP å’Œ NodePort çš„è®¿é—®æ–¹å¼ä»ç„¶å¯ç”¨ã€‚</p></li></ul><blockquote><p>TIP</p><p>Serviceæ˜¯ä¸€ä¸ªæŠ½è±¡å±‚ï¼Œå®ƒé€šè¿‡ LabelSelector é€‰æ‹©äº†ä¸€ç»„ Podï¼ˆå®¹å™¨ç»„ï¼‰ï¼ŒæŠŠè¿™äº› Pod çš„æŒ‡å®šç«¯å£å…¬å¸ƒåˆ°åˆ°é›†ç¾¤å¤–éƒ¨ï¼Œå¹¶æ”¯æŒè´Ÿè½½å‡è¡¡å’ŒæœåŠ¡å‘ç°ã€‚</p><ul><li>å…¬å¸ƒ Pod çš„ç«¯å£ä»¥ä½¿å…¶å¯è®¿é—®</li><li>åœ¨å¤šä¸ª Pod é—´å®ç°è´Ÿè½½å‡è¡¡</li><li>ä½¿ç”¨ Label å’Œ LabelSelector</li></ul></blockquote><h2 id="æœåŠ¡å’Œæ ‡ç­¾"><a href="#æœåŠ¡å’Œæ ‡ç­¾" class="headerlink" title="æœåŠ¡å’Œæ ‡ç­¾"></a>æœåŠ¡å’Œæ ‡ç­¾</h2><p>ä¸‹å›¾ä¸­æœ‰ä¸¤ä¸ªæœåŠ¡Service A(é»„è‰²è™šçº¿)å’ŒService B(è“è‰²è™šçº¿) Service A å°†è¯·æ±‚è½¬å‘åˆ° IP ä¸º 10.10.10.1 çš„Podä¸Šï¼Œ Service B å°†è¯·æ±‚è½¬å‘åˆ° IP ä¸º 10.10.10.2ã€10.10.10.3ã€10.10.10.4 çš„Podä¸Šã€‚</p><p><img src="https://s1.ax1x.com/2020/05/04/YP1c6J.png" alt="YP1c6J.png"></p><p>Service å°†å¤–éƒ¨è¯·æ±‚è·¯ç”±åˆ°ä¸€ç»„ Pod ä¸­ï¼Œå®ƒæä¾›äº†ä¸€ä¸ªæŠ½è±¡å±‚ï¼Œä½¿å¾— Kubernetes å¯ä»¥åœ¨ä¸å½±å“æœåŠ¡è°ƒç”¨è€…çš„æƒ…å†µä¸‹ï¼ŒåŠ¨æ€è°ƒåº¦å®¹å™¨ç»„ï¼ˆåœ¨å®¹å™¨ç»„å¤±æ•ˆåé‡æ–°åˆ›å»ºå®¹å™¨ç»„ï¼Œå¢åŠ æˆ–è€…å‡å°‘åŒä¸€ä¸ª Deployment å¯¹åº”å®¹å™¨ç»„çš„æ•°é‡ç­‰ï¼‰ã€‚</p><p>Serviceä½¿ç”¨ <a href="https://kubernetes.io/docs/concepts/overview/working-with-objects/labels" target="_blank" rel="noopener">Labelsã€LabelSelector(æ ‡ç­¾å’Œé€‰æ‹©å™¨)</a> åŒ¹é…ä¸€ç»„ Podã€‚Labelsï¼ˆæ ‡ç­¾ï¼‰æ˜¯é™„åŠ åˆ° Kubernetes å¯¹è±¡çš„é”®/å€¼å¯¹ï¼Œå…¶ç”¨é€”æœ‰å¤šç§ï¼š</p><ul><li>å°† Kubernetes å¯¹è±¡ï¼ˆNodeã€Deploymentã€Podã€Serviceç­‰ï¼‰æŒ‡æ´¾ç”¨äºå¼€å‘ç¯å¢ƒã€æµ‹è¯•ç¯å¢ƒæˆ–ç”Ÿäº§ç¯å¢ƒ</li><li>åµŒå…¥ç‰ˆæœ¬æ ‡ç­¾ï¼Œä½¿ç”¨æ ‡ç­¾åŒºåˆ«ä¸åŒåº”ç”¨è½¯ä»¶ç‰ˆæœ¬</li><li>ä½¿ç”¨æ ‡ç­¾å¯¹ Kubernetes å¯¹è±¡è¿›è¡Œåˆ†ç±»</li></ul><p>ä¸‹å›¾ä½“ç°äº† Labelsï¼ˆæ ‡ç­¾ï¼‰å’Œ LabelSelectorï¼ˆæ ‡ç­¾é€‰æ‹©å™¨ï¼‰ä¹‹é—´çš„å…³è”å…³ç³»</p><ul><li>Deployment B å«æœ‰ LabelSelector ä¸º app=B é€šè¿‡æ­¤æ–¹å¼å£°æ˜å«æœ‰ app=B æ ‡ç­¾çš„ Pod ä¸ä¹‹å…³è”</li><li>é€šè¿‡ Deployment B åˆ›å»ºçš„ Pod åŒ…å«æ ‡ç­¾ä¸º app=B</li><li>Service B é€šè¿‡æ ‡ç­¾é€‰æ‹©å™¨ app=B é€‰æ‹©å¯ä»¥è·¯ç”±çš„ Pod</li></ul><p><img src="https://s1.ax1x.com/2020/05/04/YP1X7t.png" alt="YP1X7t.png"></p><p>abelsï¼ˆæ ‡ç­¾ï¼‰å¯ä»¥åœ¨åˆ›å»º Kubernetes å¯¹è±¡æ—¶é™„åŠ ä¸Šå»ï¼Œä¹Ÿå¯ä»¥åœ¨åˆ›å»ºä¹‹åå†é™„åŠ ä¸Šå»ã€‚ä»»ä½•æ—¶å€™éƒ½å¯ä»¥ä¿®æ”¹ä¸€ä¸ª Kubernetes å¯¹è±¡çš„ Labelsï¼ˆæ ‡ç­¾ï¼‰</p><h2 id="ç»ƒä¹ ï¼šä¸º-nginx-Deployment-åˆ›å»ºä¸€ä¸ª-Service"><a href="#ç»ƒä¹ ï¼šä¸º-nginx-Deployment-åˆ›å»ºä¸€ä¸ª-Service" class="headerlink" title="ç»ƒä¹ ï¼šä¸º nginx Deployment åˆ›å»ºä¸€ä¸ª Service"></a>ç»ƒä¹ ï¼šä¸º nginx Deployment åˆ›å»ºä¸€ä¸ª Service</h2><ul><li><strong>åˆ›å»ºnginxçš„Deploymentä¸­å®šä¹‰äº†Labelsï¼Œå¦‚ä¸‹ï¼š</strong></li></ul><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">metadata</span><span class="token punctuation">:</span>    <span class="token comment" spellcheck="true">#è¯‘åä¸ºå…ƒæ•°æ®ï¼Œå³Deploymentçš„ä¸€äº›åŸºæœ¬å±æ€§å’Œä¿¡æ¯</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>deployment    <span class="token comment" spellcheck="true">#Deploymentçš„åç§°</span>  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token comment" spellcheck="true">#æ ‡ç­¾ï¼Œå¯ä»¥çµæ´»å®šä½ä¸€ä¸ªæˆ–å¤šä¸ªèµ„æºï¼Œå…¶ä¸­keyå’Œvalueå‡å¯è‡ªå®šä¹‰ï¼Œå¯ä»¥å®šä¹‰å¤šç»„</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx    <span class="token comment" spellcheck="true">#ä¸ºè¯¥Deploymentè®¾ç½®keyä¸ºappï¼Œvalueä¸ºnginxçš„æ ‡ç­¾</span></code></pre><ul><li><strong>åˆ›å»ºæ–‡ä»¶ nginx-service.yaml</strong></li></ul><pre class=" language-shell"><code class="language-shell">vim nginx-service.yaml</code></pre><ul><li><strong>æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š</strong></li></ul><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>service    <span class="token comment" spellcheck="true">#Service çš„åç§°</span>  <span class="token key atrule">labels</span><span class="token punctuation">:</span>         <span class="token comment" spellcheck="true">#Service è‡ªå·±çš„æ ‡ç­¾</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx    <span class="token comment" spellcheck="true">#ä¸ºè¯¥ Service è®¾ç½® key ä¸º appï¼Œvalue ä¸º nginx çš„æ ‡ç­¾</span><span class="token key atrule">spec</span><span class="token punctuation">:</span>        <span class="token comment" spellcheck="true">#è¿™æ˜¯å…³äºè¯¥ Service çš„å®šä¹‰ï¼Œæè¿°äº† Service å¦‚ä½•é€‰æ‹© Podï¼Œå¦‚ä½•è¢«è®¿é—®</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>        <span class="token comment" spellcheck="true">#æ ‡ç­¾é€‰æ‹©å™¨</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx    <span class="token comment" spellcheck="true">#é€‰æ‹©åŒ…å«æ ‡ç­¾ app:nginx çš„ Pod</span>  <span class="token key atrule">ports</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>port    <span class="token comment" spellcheck="true">#ç«¯å£çš„åå­—</span>    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP        <span class="token comment" spellcheck="true">#åè®®ç±»å‹ TCP/UDP</span>    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80            </span><span class="token comment" spellcheck="true">#é›†ç¾¤å†…çš„å…¶ä»–å®¹å™¨ç»„å¯é€šè¿‡ 80 ç«¯å£è®¿é—® Service</span>    <span class="token key atrule">nodePort</span><span class="token punctuation">:</span> <span class="token number">32600   </span><span class="token comment" spellcheck="true">#é€šè¿‡ä»»æ„èŠ‚ç‚¹çš„ 32600 ç«¯å£è®¿é—® Service</span>    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80    </span><span class="token comment" spellcheck="true">#å°†è¯·æ±‚è½¬å‘åˆ°åŒ¹é… Pod çš„ 80 ç«¯å£</span>  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort    <span class="token comment" spellcheck="true">#Seriveçš„ç±»å‹ï¼ŒClusterIP/NodePort/LoaderBalancer</span></code></pre><ul><li><strong>æ‰§è¡Œå‘½ä»¤</strong></li></ul><pre><code>kubectl apply -f nginx-service.yaml</code></pre><ul><li><p><strong>æ£€æŸ¥æ‰§è¡Œç»“æœ</strong></p><pre class=" language-shell"><code class="language-shell">kubectl get services -o wide</code></pre></li><li><p><strong>è®¿é—®æœåŠ¡</strong></p></li></ul><pre class=" language-shell"><code class="language-shell">curl <ä»»æ„èŠ‚ç‚¹çš„ IP>:32600</code></pre><h1 id="4-ä¼¸ç¼©åº”ç”¨ç¨‹åº"><a href="#4-ä¼¸ç¼©åº”ç”¨ç¨‹åº" class="headerlink" title="4.ä¼¸ç¼©åº”ç”¨ç¨‹åº"></a>4.ä¼¸ç¼©åº”ç”¨ç¨‹åº</h1><h2 id="Scalingï¼ˆä¼¸ç¼©ï¼‰åº”ç”¨ç¨‹åº"><a href="#Scalingï¼ˆä¼¸ç¼©ï¼‰åº”ç”¨ç¨‹åº" class="headerlink" title="Scalingï¼ˆä¼¸ç¼©ï¼‰åº”ç”¨ç¨‹åº"></a>Scalingï¼ˆä¼¸ç¼©ï¼‰åº”ç”¨ç¨‹åº</h2><p>åœ¨å‰é¢ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ª <a href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/" target="_blank" rel="noopener">Deployment</a>ï¼Œç„¶åé€šè¿‡ <a href="https://kubernetes.io/docs/concepts/services-networking/service/" target="_blank" rel="noopener">æœåŠ¡</a> æä¾›è®¿é—® Pod çš„æ–¹å¼ã€‚æˆ‘ä»¬å‘å¸ƒçš„ Deployment åªåˆ›å»ºäº†ä¸€ä¸ª Pod æ¥è¿è¡Œæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºã€‚å½“æµé‡å¢åŠ æ—¶ï¼Œæˆ‘ä»¬éœ€è¦å¯¹åº”ç”¨ç¨‹åºè¿›è¡Œä¼¸ç¼©æ“ä½œä»¥æ»¡è¶³ç³»ç»Ÿæ€§èƒ½éœ€æ±‚ã€‚</p><p><strong>ä¼¸ç¼©</strong> çš„å®ç°å¯ä»¥é€šè¿‡æ›´æ”¹ nginx-deployment.yaml æ–‡ä»¶ä¸­éƒ¨ç½²çš„ replicasï¼ˆå‰¯æœ¬æ•°ï¼‰æ¥å®Œæˆ</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">2    </span><span class="token comment" spellcheck="true">#ä½¿ç”¨è¯¥Deploymentåˆ›å»ºä¸¤ä¸ªåº”ç”¨ç¨‹åºå®ä¾‹</span></code></pre><h2 id="Scalingï¼ˆä¼¸ç¼©ï¼‰æ¦‚è¿°"><a href="#Scalingï¼ˆä¼¸ç¼©ï¼‰æ¦‚è¿°" class="headerlink" title="Scalingï¼ˆä¼¸ç¼©ï¼‰æ¦‚è¿°"></a>Scalingï¼ˆä¼¸ç¼©ï¼‰æ¦‚è¿°</h2><p>ä¸‹å›¾ä¸­ï¼ŒService A åªå°†è®¿é—®æµé‡è½¬å‘åˆ° IP ä¸º 10.0.0.5 çš„Podä¸Š</p><p><img src="https://s1.ax1x.com/2020/05/04/YP8Wi6.png" alt="YP8Wi6.png"></p><p>â€‹        ä¿®æ”¹äº† Deployment çš„ replicas ä¸º 4 åï¼ŒKubernetes åˆä¸ºè¯¥ Deployment åˆ›å»ºäº† 3 æ–°çš„ Podï¼Œè¿™ 4 ä¸ª Pod æœ‰ç›¸åŒçš„æ ‡ç­¾ã€‚å› æ­¤Service Aé€šè¿‡æ ‡ç­¾é€‰æ‹©å™¨ä¸æ–°çš„ Podå»ºç«‹äº†å¯¹åº”å…³ç³»ï¼Œå°†è®¿é—®æµé‡é€šè¿‡è´Ÿè½½å‡è¡¡åœ¨ 4 ä¸ª Pod ä¹‹é—´è¿›è¡Œè½¬å‘ã€‚</p><p><img src="https://s1.ax1x.com/2020/05/04/YP84zD.png" alt="YP84zD.png"></p><blockquote><p>TIP</p><p>é€šè¿‡æ›´æ”¹éƒ¨ç½²ä¸­çš„ replicasï¼ˆå‰¯æœ¬æ•°ï¼‰æ¥å®Œæˆæ‰©å±•</p></blockquote><h2 id="ç»ƒä¹ ï¼šå°†-nginx-Deployment-æ‰©å®¹åˆ°-4-ä¸ªå‰¯æœ¬"><a href="#ç»ƒä¹ ï¼šå°†-nginx-Deployment-æ‰©å®¹åˆ°-4-ä¸ªå‰¯æœ¬" class="headerlink" title="ç»ƒä¹ ï¼šå°† nginx Deployment æ‰©å®¹åˆ° 4 ä¸ªå‰¯æœ¬"></a>ç»ƒä¹ ï¼šå°† nginx Deployment æ‰©å®¹åˆ° 4 ä¸ªå‰¯æœ¬</h2><blockquote><p><strong>ä¿®æ”¹ nginx-deployment.yaml æ–‡ä»¶</strong></p><p>å°† replicas ä¿®æ”¹ä¸º 4</p></blockquote><p><img src="https://s1.ax1x.com/2020/05/04/YPGpLj.png" alt="YPGpLj.png"></p><ul><li><strong>æ‰§è¡Œå‘½ä»¤</strong></li></ul><pre class=" language-shell"><code class="language-shell">kubectl apply -f nginx-deployment.yaml</code></pre><ul><li><strong>æŸ¥çœ‹ç»“æœ</strong></li></ul><pre class=" language-shell"><code class="language-shell">watch kubectl get pods -o wide</code></pre><h1 id="5-æ‰§è¡Œæ»šåŠ¨æ›´æ–°"><a href="#5-æ‰§è¡Œæ»šåŠ¨æ›´æ–°" class="headerlink" title="5.æ‰§è¡Œæ»šåŠ¨æ›´æ–°"></a>5.æ‰§è¡Œæ»šåŠ¨æ›´æ–°</h1><h2 id="æ›´æ–°åº”ç”¨ç¨‹åº"><a href="#æ›´æ–°åº”ç”¨ç¨‹åº" class="headerlink" title="æ›´æ–°åº”ç”¨ç¨‹åº"></a>æ›´æ–°åº”ç”¨ç¨‹åº</h2><p>æˆ·æœŸæœ›åº”ç”¨ç¨‹åºå§‹ç»ˆå¯ç”¨ï¼Œä¸ºæ­¤å¼€å‘è€…/è¿ç»´è€…åœ¨æ›´æ–°åº”ç”¨ç¨‹åºæ—¶è¦åˆ†å¤šæ¬¡å®Œæˆã€‚åœ¨ Kubernetes ä¸­ï¼Œè¿™æ˜¯é€šè¿‡ Rolling Update æ»šåŠ¨æ›´æ–°å®Œæˆçš„ã€‚<strong>Rolling Updateæ»šåŠ¨æ›´æ–°</strong> é€šè¿‡ä½¿ç”¨æ–°ç‰ˆæœ¬çš„ Pod é€æ­¥æ›¿ä»£æ—§ç‰ˆæœ¬çš„ Pod æ¥å®ç° Deployment çš„æ›´æ–°ï¼Œä»è€Œå®ç°é›¶åœæœºã€‚æ–°çš„ Pod å°†åœ¨å…·æœ‰å¯ç”¨èµ„æºçš„ Nodeï¼ˆèŠ‚ç‚¹ï¼‰ä¸Šè¿›è¡Œè°ƒåº¦ã€‚</p><blockquote><p>Kubernetes æ›´æ–°å¤šå‰¯æœ¬çš„ Deployment çš„ç‰ˆæœ¬æ—¶ï¼Œä¼šé€æ­¥çš„åˆ›å»ºæ–°ç‰ˆæœ¬çš„ Podï¼Œé€æ­¥çš„åœæ­¢æ—§ç‰ˆæœ¬çš„ Podï¼Œä»¥ä¾¿ä½¿åº”ç”¨ä¸€ç›´å¤„äºå¯ç”¨çŠ¶æ€ã€‚è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼ŒService èƒ½å¤Ÿç›‘è§† Pod çš„çŠ¶æ€ï¼Œå°†æµé‡å§‹ç»ˆè½¬å‘åˆ°å¯ç”¨çš„ Pod ä¸Šã€‚</p></blockquote><p>åœ¨ä¸Šä¸€ä¸ªæ¨¡å—ä¸­ï¼Œæˆ‘ä»¬å­¦ä¹ äº†å°†åº”ç”¨ç¨‹åº Scale Upï¼ˆæ‰©å®¹ï¼‰ä¸ºå¤šä¸ªå®ä¾‹ï¼Œè¿™æ˜¯æ‰§è¡Œæ›´æ–°è€Œä¸å½±å“åº”ç”¨ç¨‹åºå¯ç”¨æ€§çš„å‰æï¼ˆå¦‚æœåªæœ‰ 1 ä¸ªå®ä¾‹é‚£è¿˜ç©å•¥ï¼‰ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œ<strong>Rolling Update æ»šåŠ¨æ›´æ–°</strong> è¿‡ç¨‹ä¸­ï¼ŒKubernetes é€ä¸ªä½¿ç”¨æ–°ç‰ˆæœ¬ Pod æ›¿æ¢æ—§ç‰ˆæœ¬ Podï¼ˆæœ€å¤§ä¸å¯ç”¨ Pod æ•°ä¸º 1ã€æœ€å¤§æ–°å»º Pod æ•°ä¹Ÿä¸º 1ï¼‰ã€‚è¿™ä¸¤ä¸ªå‚æ•°å¯ä»¥é…ç½®ä¸ºæ•°å­—æˆ–ç™¾åˆ†æ¯”ã€‚åœ¨Kubernetes ä¸­ï¼Œæ›´æ–°æ˜¯ç‰ˆæœ¬åŒ–çš„ï¼Œä»»ä½•éƒ¨ç½²æ›´æ–°éƒ½å¯ä»¥æ¢å¤ä¸ºä»¥å‰çš„ï¼ˆç¨³å®šï¼‰ç‰ˆæœ¬ã€‚</p><h2 id="æ»šåŠ¨æ›´æ–°æ¦‚è¿°"><a href="#æ»šåŠ¨æ›´æ–°æ¦‚è¿°" class="headerlink" title="æ»šåŠ¨æ›´æ–°æ¦‚è¿°"></a>æ»šåŠ¨æ›´æ–°æ¦‚è¿°</h2><ol><li><p>åŸæœ¬ Service A å°†æµé‡è´Ÿè½½å‡è¡¡åˆ° 4 ä¸ªæ—§ç‰ˆæœ¬çš„ Pod ï¼ˆå½“ä¸­çš„å®¹å™¨ä¸º ç»¿è‰²ï¼‰ä¸Š</p><p><img src="https://s1.ax1x.com/2020/05/04/YPGrff.png" alt="YPGrff.png"></p></li><li><p>æ›´æ–°å®Œ Deployment éƒ¨ç½²æ–‡ä»¶ä¸­çš„é•œåƒç‰ˆæœ¬åï¼Œmaster èŠ‚ç‚¹é€‰æ‹©äº†ä¸€ä¸ª worker èŠ‚ç‚¹ï¼Œå¹¶æ ¹æ®æ–°çš„é•œåƒç‰ˆæœ¬åˆ›å»º Podï¼ˆç´«è‰²å®¹å™¨ï¼‰ã€‚æ–° Pod æ‹¥æœ‰å”¯ä¸€çš„æ–°çš„ IPã€‚åŒæ—¶ï¼Œmaster èŠ‚ç‚¹é€‰æ‹©ä¸€ä¸ªæ—§ç‰ˆæœ¬çš„ Pod å°†å…¶ç§»é™¤ã€‚</p><p>æ­¤æ—¶ï¼ŒService A å°†æ–° Pod çº³å…¥åˆ°è´Ÿè½½å‡è¡¡ä¸­ï¼Œå°†æ—§Podç§»é™¤</p><p><img src="https://s1.ax1x.com/2020/05/04/YPGRmj.png" alt="YPGRmj.png"></p></li><li><p>åŒæ­¥éª¤2ï¼Œå†åˆ›å»ºä¸€ä¸ªæ–°çš„ Pod æ›¿æ¢ä¸€ä¸ªåŸæœ‰çš„ Pod</p><p><img src="https://s1.ax1x.com/2020/05/04/YPGIhV.png" alt="YPGIhV.png"></p></li><li><p>å¦‚æ­¤ Rolling Update æ»šåŠ¨æ›´æ–°ï¼Œç›´åˆ°æ‰€æœ‰æ—§ç‰ˆæœ¬ Pod å‡ç§»é™¤ï¼Œæ–°ç‰ˆæœ¬ Pod ä¹Ÿè¾¾åˆ° Deployment éƒ¨ç½²æ–‡ä»¶ä¸­å®šä¹‰çš„å‰¯æœ¬æ•°ï¼Œåˆ™æ»šåŠ¨æ›´æ–°å®Œæˆ</p></li></ol><p><img src="https://s1.ax1x.com/2020/05/04/YPGLnJ.png" alt="YPGLnJ.png"></p><p>æ»šåŠ¨æ›´æ–°å…è®¸ä»¥ä¸‹æ“ä½œï¼š</p><ul><li>å°†åº”ç”¨ç¨‹åºä»å‡†ä¸Šçº¿ç¯å¢ƒå‡çº§åˆ°ç”Ÿäº§ç¯å¢ƒï¼ˆé€šè¿‡æ›´æ–°å®¹å™¨é•œåƒï¼‰</li><li>å›æ»šåˆ°ä»¥å‰çš„ç‰ˆæœ¬</li><li>æŒç»­é›†æˆå’ŒæŒç»­äº¤ä»˜åº”ç”¨ç¨‹åºï¼Œæ— éœ€åœæœº</li></ul><h2 id="ç»ƒä¹ ï¼šæ›´æ–°-nginx-Deployment"><a href="#ç»ƒä¹ ï¼šæ›´æ–°-nginx-Deployment" class="headerlink" title="ç»ƒä¹ ï¼šæ›´æ–° nginx Deployment"></a>ç»ƒä¹ ï¼šæ›´æ–° nginx Deployment</h2><p><strong>ä¿®æ”¹ nginx-deployment.yaml æ–‡ä»¶</strong></p><p>ä¿®æ”¹æ–‡ä»¶ä¸­ image é•œåƒçš„æ ‡ç­¾ï¼Œå¦‚ä¸‹æ‰€ç¤º</p><p><img src="https://s1.ax1x.com/2020/05/04/YPJe4P.png" alt="YPJe4P.png"></p><ul><li><p><strong>æ‰§è¡Œå‘½ä»¤</strong></p><pre class=" language-shell"><code class="language-shell">kubectl apply -f nginx-deployment.yaml</code></pre></li><li><p><strong>æŸ¥çœ‹è¿‡ç¨‹åŠç»“æœ</strong></p></li></ul><p>æ‰§è¡Œå‘½ä»¤ï¼Œå¯è§‚å¯Ÿåˆ° pod é€ä¸ªè¢«æ›¿æ¢çš„è¿‡ç¨‹ã€‚</p><pre class=" language-shell"><code class="language-shell">watch kubectl get pods -l app=nginx</code></pre><h1 id="Kubernetesæ ¸å¿ƒæ¦‚å¿µ"><a href="#Kubernetesæ ¸å¿ƒæ¦‚å¿µ" class="headerlink" title="Kubernetesæ ¸å¿ƒæ¦‚å¿µ"></a>Kubernetesæ ¸å¿ƒæ¦‚å¿µ</h1><h2 id="ä»€ä¹ˆæ˜¯Kubernetesï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯Kubernetesï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯Kubernetesï¼Ÿ"></a>ä»€ä¹ˆæ˜¯Kubernetesï¼Ÿ</h2><p>Kubernetesï¼ˆk8sï¼‰æ˜¯è‡ªåŠ¨åŒ–å®¹å™¨æ“ä½œçš„å¼€æºå¹³å°ï¼Œè¿™äº›æ“ä½œåŒ…æ‹¬éƒ¨ç½²ï¼Œè°ƒåº¦å’ŒèŠ‚ç‚¹é›†ç¾¤é—´æ‰©å±•ã€‚å¦‚æœä½ æ›¾ç»ç”¨è¿‡Dockerå®¹å™¨æŠ€æœ¯éƒ¨ç½²å®¹å™¨ï¼Œé‚£ä¹ˆå¯ä»¥å°†Dockerçœ‹æˆKuberneteså†…éƒ¨ä½¿ç”¨çš„ä½çº§åˆ«ç»„ä»¶ã€‚Kubernetesä¸ä»…ä»…æ”¯æŒDockerï¼Œè¿˜æ”¯æŒRocketï¼Œè¿™æ˜¯å¦ä¸€ç§å®¹å™¨æŠ€æœ¯ã€‚ ä½¿ç”¨Kuberneteså¯ä»¥ï¼š</p><ul><li>è‡ªåŠ¨åŒ–å®¹å™¨çš„éƒ¨ç½²å’Œå¤åˆ¶</li><li>éšæ—¶æ‰©å±•æˆ–æ”¶ç¼©å®¹å™¨è§„æ¨¡</li><li>å°†å®¹å™¨ç»„ç»‡æˆç»„ï¼Œå¹¶ä¸”æä¾›å®¹å™¨é—´çš„è´Ÿè½½å‡è¡¡</li><li>å¾ˆå®¹æ˜“åœ°å‡çº§åº”ç”¨ç¨‹åºå®¹å™¨çš„æ–°ç‰ˆæœ¬</li><li>æä¾›å®¹å™¨å¼¹æ€§ï¼Œå¦‚æœå®¹å™¨å¤±æ•ˆå°±æ›¿æ¢å®ƒï¼Œç­‰ç­‰â€¦</li></ul><h2 id="é›†ç¾¤"><a href="#é›†ç¾¤" class="headerlink" title="é›†ç¾¤"></a>é›†ç¾¤</h2><p>é›†ç¾¤æ˜¯ä¸€ç»„èŠ‚ç‚¹ï¼Œè¿™äº›èŠ‚ç‚¹å¯ä»¥æ˜¯ç‰©ç†æœåŠ¡å™¨æˆ–è€…è™šæ‹Ÿæœºï¼Œä¹‹ä¸Šå®‰è£…äº†Kuberneteså¹³å°ã€‚ä¸‹å›¾å±•ç¤ºè¿™æ ·çš„é›†ç¾¤ã€‚æ³¨æ„è¯¥å›¾ä¸ºäº†å¼ºè°ƒæ ¸å¿ƒæ¦‚å¿µæœ‰æ‰€ç®€åŒ–ã€‚è¿™é‡Œå¯ä»¥çœ‹åˆ°ä¸€ä¸ªå…¸å‹çš„Kubernetesæ¶æ„å›¾ã€‚</p><p><img src="https://s1.ax1x.com/2020/05/04/YPJyU1.png" alt="YPJyU1.png"></p><p>ä¸Šå›¾å¯ä»¥çœ‹åˆ°å¦‚ä¸‹ç»„ä»¶ï¼Œä½¿ç”¨ç‰¹åˆ«çš„å›¾æ ‡è¡¨ç¤ºServiceå’ŒLabelï¼š</p><ul><li>PodContainerï¼ˆå®¹å™¨ï¼‰</li><li>Label(<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAhCAYAAAC4JqlRAAAKQWlDQ1BJQ0MgUHJvZmlsZQAASA2dlndUU9kWh8+9N73QEiIgJfQaegkg0jtIFQRRiUmAUAKGhCZ2RAVGFBEpVmRUwAFHhyJjRRQLg4Ji1wnyEFDGwVFEReXdjGsJ7601896a/cdZ39nnt9fZZ+9917oAUPyCBMJ0WAGANKFYFO7rwVwSE8vE9wIYEAEOWAHA4WZmBEf4RALU/L09mZmoSMaz9u4ugGS72yy/UCZz1v9/kSI3QyQGAApF1TY8fiYX5QKUU7PFGTL/BMr0lSkyhjEyFqEJoqwi48SvbPan5iu7yZiXJuShGlnOGbw0noy7UN6aJeGjjAShXJgl4GejfAdlvVRJmgDl9yjT0/icTAAwFJlfzOcmoWyJMkUUGe6J8gIACJTEObxyDov5OWieAHimZ+SKBIlJYqYR15hp5ejIZvrxs1P5YjErlMNN4Yh4TM/0tAyOMBeAr2+WRQElWW2ZaJHtrRzt7VnW5mj5v9nfHn5T/T3IevtV8Sbsz55BjJ5Z32zsrC+9FgD2JFqbHbO+lVUAtG0GQOXhrE/vIADyBQC03pzzHoZsXpLE4gwnC4vs7GxzAZ9rLivoN/ufgm/Kv4Y595nL7vtWO6YXP4EjSRUzZUXlpqemS0TMzAwOl89k/fcQ/+PAOWnNycMsnJ/AF/GF6FVR6JQJhIlou4U8gViQLmQKhH/V4X8YNicHGX6daxRodV8AfYU5ULhJB8hvPQBDIwMkbj96An3rWxAxCsi+vGitka9zjzJ6/uf6Hwtcim7hTEEiU+b2DI9kciWiLBmj34RswQISkAd0oAo0gS4wAixgDRyAM3AD3iAAhIBIEAOWAy5IAmlABLJBPtgACkEx2AF2g2pwANSBetAEToI2cAZcBFfADXALDIBHQAqGwUswAd6BaQiC8BAVokGqkBakD5lC1hAbWgh5Q0FQOBQDxUOJkBCSQPnQJqgYKoOqoUNQPfQjdBq6CF2D+qAH0CA0Bv0BfYQRmALTYQ3YALaA2bA7HAhHwsvgRHgVnAcXwNvhSrgWPg63whfhG/AALIVfwpMIQMgIA9FGWAgb8URCkFgkAREha5EipAKpRZqQDqQbuY1IkXHkAwaHoWGYGBbGGeOHWYzhYlZh1mJKMNWYY5hWTBfmNmYQM4H5gqVi1bGmWCesP3YJNhGbjS3EVmCPYFuwl7ED2GHsOxwOx8AZ4hxwfrgYXDJuNa4Etw/XjLuA68MN4SbxeLwq3hTvgg/Bc/BifCG+Cn8cfx7fjx/GvyeQCVoEa4IPIZYgJGwkVBAaCOcI/YQRwjRRgahPdCKGEHnEXGIpsY7YQbxJHCZOkxRJhiQXUiQpmbSBVElqIl0mPSa9IZPJOmRHchhZQF5PriSfIF8lD5I/UJQoJhRPShxFQtlOOUq5QHlAeUOlUg2obtRYqpi6nVpPvUR9Sn0vR5Mzl/OX48mtk6uRa5Xrl3slT5TXl3eXXy6fJ18hf0r+pvy4AlHBQMFTgaOwVqFG4bTCPYVJRZqilWKIYppiiWKD4jXFUSW8koGStxJPqUDpsNIlpSEaQtOledK4tE20Otpl2jAdRzek+9OT6cX0H+i99AllJWVb5SjlHOUa5bPKUgbCMGD4M1IZpYyTjLuMj/M05rnP48/bNq9pXv+8KZX5Km4qfJUilWaVAZWPqkxVb9UU1Z2qbapP1DBqJmphatlq+9Uuq43Pp893ns+dXzT/5PyH6rC6iXq4+mr1w+o96pMamhq+GhkaVRqXNMY1GZpumsma5ZrnNMe0aFoLtQRa5VrntV4wlZnuzFRmJbOLOaGtru2nLdE+pN2rPa1jqLNYZ6NOs84TXZIuWzdBt1y3U3dCT0svWC9fr1HvoT5Rn62fpL9Hv1t/ysDQINpgi0GbwaihiqG/YZ5ho+FjI6qRq9Eqo1qjO8Y4Y7ZxivE+41smsImdSZJJjclNU9jU3lRgus+0zwxr5mgmNKs1u8eisNxZWaxG1qA5wzzIfKN5m/krCz2LWIudFt0WXyztLFMt6ywfWSlZBVhttOqw+sPaxJprXWN9x4Zq42Ozzqbd5rWtqS3fdr/tfTuaXbDdFrtOu8/2DvYi+yb7MQc9h3iHvQ732HR2KLuEfdUR6+jhuM7xjOMHJ3snsdNJp9+dWc4pzg3OowsMF/AX1C0YctFx4bgccpEuZC6MX3hwodRV25XjWuv6zE3Xjed2xG3E3dg92f24+ysPSw+RR4vHlKeT5xrPC16Il69XkVevt5L3Yu9q76c+Oj6JPo0+E752vqt9L/hh/QL9dvrd89fw5/rX+08EOASsCegKpARGBFYHPgsyCRIFdQTDwQHBu4IfL9JfJFzUFgJC/EN2hTwJNQxdFfpzGC4sNKwm7Hm4VXh+eHcELWJFREPEu0iPyNLIR4uNFksWd0bJR8VF1UdNRXtFl0VLl1gsWbPkRoxajCCmPRYfGxV7JHZyqffS3UuH4+ziCuPuLjNclrPs2nK15anLz66QX8FZcSoeGx8d3xD/iRPCqeVMrvRfuXflBNeTu4f7kufGK+eN8V34ZfyRBJeEsoTRRJfEXYljSa5JFUnjAk9BteB1sl/ygeSplJCUoykzqdGpzWmEtPi000IlYYqwK10zPSe9L8M0ozBDuspp1e5VE6JA0ZFMKHNZZruYjv5M9UiMJJslg1kLs2qy3mdHZZ/KUcwR5vTkmuRuyx3J88n7fjVmNXd1Z752/ob8wTXuaw6thdauXNu5Tnddwbrh9b7rj20gbUjZ8MtGy41lG99uit7UUaBRsL5gaLPv5sZCuUJR4b0tzlsObMVsFWzt3WazrWrblyJe0fViy+KK4k8l3JLr31l9V/ndzPaE7b2l9qX7d+B2CHfc3em681iZYlle2dCu4F2t5czyovK3u1fsvlZhW3FgD2mPZI+0MqiyvUqvakfVp+qk6oEaj5rmvep7t+2d2sfb17/fbX/TAY0DxQc+HhQcvH/I91BrrUFtxWHc4azDz+ui6rq/Z39ff0TtSPGRz0eFR6XHwo911TvU1zeoN5Q2wo2SxrHjccdv/eD1Q3sTq+lQM6O5+AQ4ITnx4sf4H++eDDzZeYp9qukn/Z/2ttBailqh1tzWibakNml7THvf6YDTnR3OHS0/m/989Iz2mZqzymdLz5HOFZybOZ93fvJCxoXxi4kXhzpXdD66tOTSna6wrt7LgZevXvG5cqnbvfv8VZerZ645XTt9nX297Yb9jdYeu56WX+x+aem172296XCz/ZbjrY6+BX3n+l37L972un3ljv+dGwOLBvruLr57/17cPel93v3RB6kPXj/Mejj9aP1j7OOiJwpPKp6qP6391fjXZqm99Oyg12DPs4hnj4a4Qy//lfmvT8MFz6nPK0a0RupHrUfPjPmM3Xqx9MXwy4yX0+OFvyn+tveV0auffnf7vWdiycTwa9HrmT9K3qi+OfrW9m3nZOjk03dp76anit6rvj/2gf2h+2P0x5Hp7E/4T5WfjT93fAn88ngmbWbm3/eE8/syOll+AAAACXBIWXMAAAsTAAALEwEAmpwYAAAB1WlUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iWE1QIENvcmUgNS40LjAiPgogICA8cmRmOlJERiB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPgogICAgICA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIgogICAgICAgICAgICB4bWxuczp0aWZmPSJodHRwOi8vbnMuYWRvYmUuY29tL3RpZmYvMS4wLyI+CiAgICAgICAgIDx0aWZmOkNvbXByZXNzaW9uPjE8L3RpZmY6Q29tcHJlc3Npb24+CiAgICAgICAgIDx0aWZmOlBob3RvbWV0cmljSW50ZXJwcmV0YXRpb24+MjwvdGlmZjpQaG90b21ldHJpY0ludGVycHJldGF0aW9uPgogICAgICAgICA8dGlmZjpPcmllbnRhdGlvbj4xPC90aWZmOk9yaWVudGF0aW9uPgogICAgICA8L3JkZjpEZXNjcmlwdGlvbj4KICAgPC9yZGY6UkRGPgo8L3g6eG1wbWV0YT4KOXS2agAAAWdJREFUWAntk91NhUAUhC8WYB92YQEWYQhWYLQKW4AnOrAA+7AGn3khAXeu+ZIJOfws8mAim9x7dmfnzAy7cLmc4zyB/34CxdwBtG172/f9+3R/HMfPsiyfhDdN8zoMw12aflVV9TLlblmHAeq6fi6K4m1NIAW59qcgI1ww1mv1JiIk84cIn2IYuynYlDu3DgM4WeL8HGeO4d4QqwEwWqq/CXFIAIXbGyJ8CZPYR9K8l3Du4CoIpH6wSOuwE0AcYzcFg+M1DNB13aOTcucYbgkRXoEMEck1dz4BXAsM3mwAEbyRhtyKoWuBSSu8AkycCJZbMXathOklv47FAGJ440/Lsf+LV+BWPIljW+Y8gPeDqX9zAJFdROu1gZH3gdGbFUBNLoZIVDFyPpjzswOo2UVdjDlGzgODQ90VQM0ujpgqRr4P5jzmuwNIwE20xshxMO1HY/UzjJrAXNzn0T7YWc8TOE/gz53AN34Bn5aWTdpfAAAAAElFTkSuQmCC" alt="label">))ï¼ˆæ ‡ç­¾ï¼‰</li><li>Replication Controllerï¼ˆå¤åˆ¶æ§åˆ¶å™¨ï¼‰</li><li>Serviceï¼ˆ<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACYAAAAoCAYAAACSN4jeAAAKQWlDQ1BJQ0MgUHJvZmlsZQAASA2dlndUU9kWh8+9N73QEiIgJfQaegkg0jtIFQRRiUmAUAKGhCZ2RAVGFBEpVmRUwAFHhyJjRRQLg4Ji1wnyEFDGwVFEReXdjGsJ7601896a/cdZ39nnt9fZZ+9917oAUPyCBMJ0WAGANKFYFO7rwVwSE8vE9wIYEAEOWAHA4WZmBEf4RALU/L09mZmoSMaz9u4ugGS72yy/UCZz1v9/kSI3QyQGAApF1TY8fiYX5QKUU7PFGTL/BMr0lSkyhjEyFqEJoqwi48SvbPan5iu7yZiXJuShGlnOGbw0noy7UN6aJeGjjAShXJgl4GejfAdlvVRJmgDl9yjT0/icTAAwFJlfzOcmoWyJMkUUGe6J8gIACJTEObxyDov5OWieAHimZ+SKBIlJYqYR15hp5ejIZvrxs1P5YjErlMNN4Yh4TM/0tAyOMBeAr2+WRQElWW2ZaJHtrRzt7VnW5mj5v9nfHn5T/T3IevtV8Sbsz55BjJ5Z32zsrC+9FgD2JFqbHbO+lVUAtG0GQOXhrE/vIADyBQC03pzzHoZsXpLE4gwnC4vs7GxzAZ9rLivoN/ufgm/Kv4Y595nL7vtWO6YXP4EjSRUzZUXlpqemS0TMzAwOl89k/fcQ/+PAOWnNycMsnJ/AF/GF6FVR6JQJhIlou4U8gViQLmQKhH/V4X8YNicHGX6daxRodV8AfYU5ULhJB8hvPQBDIwMkbj96An3rWxAxCsi+vGitka9zjzJ6/uf6Hwtcim7hTEEiU+b2DI9kciWiLBmj34RswQISkAd0oAo0gS4wAixgDRyAM3AD3iAAhIBIEAOWAy5IAmlABLJBPtgACkEx2AF2g2pwANSBetAEToI2cAZcBFfADXALDIBHQAqGwUswAd6BaQiC8BAVokGqkBakD5lC1hAbWgh5Q0FQOBQDxUOJkBCSQPnQJqgYKoOqoUNQPfQjdBq6CF2D+qAH0CA0Bv0BfYQRmALTYQ3YALaA2bA7HAhHwsvgRHgVnAcXwNvhSrgWPg63whfhG/AALIVfwpMIQMgIA9FGWAgb8URCkFgkAREha5EipAKpRZqQDqQbuY1IkXHkAwaHoWGYGBbGGeOHWYzhYlZh1mJKMNWYY5hWTBfmNmYQM4H5gqVi1bGmWCesP3YJNhGbjS3EVmCPYFuwl7ED2GHsOxwOx8AZ4hxwfrgYXDJuNa4Etw/XjLuA68MN4SbxeLwq3hTvgg/Bc/BifCG+Cn8cfx7fjx/GvyeQCVoEa4IPIZYgJGwkVBAaCOcI/YQRwjRRgahPdCKGEHnEXGIpsY7YQbxJHCZOkxRJhiQXUiQpmbSBVElqIl0mPSa9IZPJOmRHchhZQF5PriSfIF8lD5I/UJQoJhRPShxFQtlOOUq5QHlAeUOlUg2obtRYqpi6nVpPvUR9Sn0vR5Mzl/OX48mtk6uRa5Xrl3slT5TXl3eXXy6fJ18hf0r+pvy4AlHBQMFTgaOwVqFG4bTCPYVJRZqilWKIYppiiWKD4jXFUSW8koGStxJPqUDpsNIlpSEaQtOledK4tE20Otpl2jAdRzek+9OT6cX0H+i99AllJWVb5SjlHOUa5bPKUgbCMGD4M1IZpYyTjLuMj/M05rnP48/bNq9pXv+8KZX5Km4qfJUilWaVAZWPqkxVb9UU1Z2qbapP1DBqJmphatlq+9Uuq43Pp893ns+dXzT/5PyH6rC6iXq4+mr1w+o96pMamhq+GhkaVRqXNMY1GZpumsma5ZrnNMe0aFoLtQRa5VrntV4wlZnuzFRmJbOLOaGtru2nLdE+pN2rPa1jqLNYZ6NOs84TXZIuWzdBt1y3U3dCT0svWC9fr1HvoT5Rn62fpL9Hv1t/ysDQINpgi0GbwaihiqG/YZ5ho+FjI6qRq9Eqo1qjO8Y4Y7ZxivE+41smsImdSZJJjclNU9jU3lRgus+0zwxr5mgmNKs1u8eisNxZWaxG1qA5wzzIfKN5m/krCz2LWIudFt0WXyztLFMt6ywfWSlZBVhttOqw+sPaxJprXWN9x4Zq42Ozzqbd5rWtqS3fdr/tfTuaXbDdFrtOu8/2DvYi+yb7MQc9h3iHvQ732HR2KLuEfdUR6+jhuM7xjOMHJ3snsdNJp9+dWc4pzg3OowsMF/AX1C0YctFx4bgccpEuZC6MX3hwodRV25XjWuv6zE3Xjed2xG3E3dg92f24+ysPSw+RR4vHlKeT5xrPC16Il69XkVevt5L3Yu9q76c+Oj6JPo0+E752vqt9L/hh/QL9dvrd89fw5/rX+08EOASsCegKpARGBFYHPgsyCRIFdQTDwQHBu4IfL9JfJFzUFgJC/EN2hTwJNQxdFfpzGC4sNKwm7Hm4VXh+eHcELWJFREPEu0iPyNLIR4uNFksWd0bJR8VF1UdNRXtFl0VLl1gsWbPkRoxajCCmPRYfGxV7JHZyqffS3UuH4+ziCuPuLjNclrPs2nK15anLz66QX8FZcSoeGx8d3xD/iRPCqeVMrvRfuXflBNeTu4f7kufGK+eN8V34ZfyRBJeEsoTRRJfEXYljSa5JFUnjAk9BteB1sl/ygeSplJCUoykzqdGpzWmEtPi000IlYYqwK10zPSe9L8M0ozBDuspp1e5VE6JA0ZFMKHNZZruYjv5M9UiMJJslg1kLs2qy3mdHZZ/KUcwR5vTkmuRuyx3J88n7fjVmNXd1Z752/ob8wTXuaw6thdauXNu5Tnddwbrh9b7rj20gbUjZ8MtGy41lG99uit7UUaBRsL5gaLPv5sZCuUJR4b0tzlsObMVsFWzt3WazrWrblyJe0fViy+KK4k8l3JLr31l9V/ndzPaE7b2l9qX7d+B2CHfc3em681iZYlle2dCu4F2t5czyovK3u1fsvlZhW3FgD2mPZI+0MqiyvUqvakfVp+qk6oEaj5rmvep7t+2d2sfb17/fbX/TAY0DxQc+HhQcvH/I91BrrUFtxWHc4azDz+ui6rq/Z39ff0TtSPGRz0eFR6XHwo911TvU1zeoN5Q2wo2SxrHjccdv/eD1Q3sTq+lQM6O5+AQ4ITnx4sf4H++eDDzZeYp9qukn/Z/2ttBailqh1tzWibakNml7THvf6YDTnR3OHS0/m/989Iz2mZqzymdLz5HOFZybOZ93fvJCxoXxi4kXhzpXdD66tOTSna6wrt7LgZevXvG5cqnbvfv8VZerZ645XTt9nX297Yb9jdYeu56WX+x+aem172296XCz/ZbjrY6+BX3n+l37L972un3ljv+dGwOLBvruLr57/17cPel93v3RB6kPXj/Mejj9aP1j7OOiJwpPKp6qP6391fjXZqm99Oyg12DPs4hnj4a4Qy//lfmvT8MFz6nPK0a0RupHrUfPjPmM3Xqx9MXwy4yX0+OFvyn+tveV0auffnf7vWdiycTwa9HrmT9K3qi+OfrW9m3nZOjk03dp76anit6rvj/2gf2h+2P0x5Hp7E/4T5WfjT93fAn88ngmbWbm3/eE8/syOll+AAAACXBIWXMAAAsTAAALEwEAmpwYAAAB1WlUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iWE1QIENvcmUgNS40LjAiPgogICA8cmRmOlJERiB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPgogICAgICA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIgogICAgICAgICAgICB4bWxuczp0aWZmPSJodHRwOi8vbnMuYWRvYmUuY29tL3RpZmYvMS4wLyI+CiAgICAgICAgIDx0aWZmOkNvbXByZXNzaW9uPjE8L3RpZmY6Q29tcHJlc3Npb24+CiAgICAgICAgIDx0aWZmOlBob3RvbWV0cmljSW50ZXJwcmV0YXRpb24+MjwvdGlmZjpQaG90b21ldHJpY0ludGVycHJldGF0aW9uPgogICAgICAgICA8dGlmZjpPcmllbnRhdGlvbj4xPC90aWZmOk9yaWVudGF0aW9uPgogICAgICA8L3JkZjpEZXNjcmlwdGlvbj4KICAgPC9yZGY6UkRGPgo8L3g6eG1wbWV0YT4KOXS2agAAAtlJREFUWAntV79rIkEUfv5qJKKW11hYCFdeI1hbeSCYJiFWQQwYFfO3qAlioSgSA4KFdQ61sbOKjUXAwFncdSpyBvx1Owsjs+7bvZ3du73jcEH2ve99897n25nZWYDTderAn+2AhaavVqsvm83mo+BbKWbW3Wq1bu12+5fr6+vPtKadGsL9w9nZmf3q6oqBzDGfnp6sq9XqE1vN9O6wxdXs/1tYr9eDQqEAs9lMrQlcMXaOcQ2k5Hw+T02o1+uifXd3d8D0GoYeZafTQetut1sU5wENCXt7e0Nr3d/fozgPaEgYTyFeriFhSnveX59jwsaINoJdEChBA6i7Y7Q46Q7tEGvTuAYNKEWXMFqUCjrOnM1mRYjyjuNafG5htFg6nVbMb7PZIJFIiPGHhwdFnlqAS1ixWBRzRSIRcDgcannB5XJBKBQC4cQCtVpNlYsFNQtrt9uw2+3A5/NBIBDAcsmwYDAIfr8f5vM5DAYDWVwNUBT2+voKpEPkH4/HY5hOp0Ae0fn5uVo+WSwajYLb7YbhcCjmWK/XQDbg0Wgk47IA+q6k84gQ2TlCJzWbQIstHADFlzzpOr263S6Qn9ICknVsMpnQsZL77e2txOd1crkcOuT5+RnFZcL6/T5KLJVKKK4VfHx8RKmLxQLFZcJQ1m8AhTM9VxaZsFgshiZQ27fIIZFc9DyGJbi8vMRg8Hg8KC4T5vV6UaLSvkUWyn6/F8eQEyy7cI4TWSyHj7JDKBwOH2zWQPtLV0qz2YR4PM7yJbaSiOVyCcIXl4RLHLoAWq0WXFxcyOIsIOsYG1QTxfKO7UqlcgxJ/F+JImRVYZJsJjuGhGUyGVQunQpoUCNoSBjZApxOp6RUMpmU+HoddPLzJLu5ueGha+Ya6pjmKjqI/6yww6MUzlp7Yf/ZNRqNHzr+oKEh7+/vTuFI9Z1NItmKy+XyVyG4YQlm2MKb41sqlQqZUetUw/QO/AQEcsyxO1XX/gAAAABJRU5ErkJggg==" alt="enter image description here">ï¼‰ï¼ˆæœåŠ¡ï¼‰</li><li>Nodeï¼ˆèŠ‚ç‚¹ï¼‰</li><li>Kubernetes Masterï¼ˆKubernetesä¸»èŠ‚ç‚¹ï¼‰</li></ul><h2 id="Pod"><a href="#Pod" class="headerlink" title="Pod"></a>Pod</h2><p><a href="https://kubernetes.io/docs/concepts/workloads/pods/pod-overview/" target="_blank" rel="noopener">Pod</a>ï¼ˆä¸Šå›¾ç»¿è‰²æ–¹æ¡†ï¼‰å®‰æ’åœ¨èŠ‚ç‚¹ä¸Šï¼ŒåŒ…å«ä¸€ç»„å®¹å™¨å’Œå·ã€‚åŒä¸€ä¸ªPodé‡Œçš„å®¹å™¨å…±äº«åŒä¸€ä¸ªç½‘ç»œå‘½åç©ºé—´ï¼Œå¯ä»¥ä½¿ç”¨localhostäº’ç›¸é€šä¿¡ã€‚Podæ˜¯çŸ­æš‚çš„ï¼Œä¸æ˜¯æŒç»­æ€§å®ä½“ã€‚ä½ å¯èƒ½ä¼šæœ‰è¿™äº›é—®é¢˜ï¼š</p><ul><li>å¦‚æœPodæ˜¯çŸ­æš‚çš„ï¼Œé‚£ä¹ˆæˆ‘æ€ä¹ˆæ‰èƒ½æŒä¹…åŒ–å®¹å™¨æ•°æ®ä½¿å…¶èƒ½å¤Ÿè·¨é‡å¯è€Œå­˜åœ¨å‘¢ï¼Ÿ æ˜¯çš„ï¼ŒKubernetesæ”¯æŒ <strong><em>å·</em></strong> çš„æ¦‚å¿µï¼Œå› æ­¤å¯ä»¥ä½¿ç”¨æŒä¹…åŒ–çš„å·ç±»å‹ã€‚</li><li>æ˜¯å¦æ‰‹åŠ¨åˆ›å»ºPodï¼Œå¦‚æœæƒ³è¦åˆ›å»ºåŒä¸€ä¸ªå®¹å™¨çš„å¤šä»½æ‹·è´ï¼Œéœ€è¦ä¸€ä¸ªä¸ªåˆ†åˆ«åˆ›å»ºå‡ºæ¥ä¹ˆï¼Ÿå¯ä»¥æ‰‹åŠ¨åˆ›å»ºå•ä¸ªPodï¼Œä½†æ˜¯ä¹Ÿå¯ä»¥ä½¿ç”¨Replication Controllerä½¿ç”¨Podæ¨¡æ¿åˆ›å»ºå‡ºå¤šä»½æ‹·è´ï¼Œä¸‹æ–‡ä¼šè¯¦ç»†ä»‹ç»ã€‚</li><li>å¦‚æœPodæ˜¯çŸ­æš‚çš„ï¼Œé‚£ä¹ˆé‡å¯æ—¶IPåœ°å€å¯èƒ½ä¼šæ”¹å˜ï¼Œé‚£ä¹ˆæ€ä¹ˆæ‰èƒ½ä»å‰ç«¯å®¹å™¨æ­£ç¡®å¯é åœ°æŒ‡å‘åå°å®¹å™¨å‘¢ï¼Ÿè¿™æ—¶å¯ä»¥ä½¿ç”¨Serviceï¼Œä¸‹æ–‡ä¼šè¯¦ç»†ä»‹ç»ã€‚</li></ul><h2 id="Label"><a href="#Label" class="headerlink" title="Label"></a>Label</h2><p>æ­£å¦‚å›¾æ‰€ç¤ºï¼Œä¸€äº›Podæœ‰Labelï¼ˆ<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAhCAYAAAC4JqlRAAAKQWlDQ1BJQ0MgUHJvZmlsZQAASA2dlndUU9kWh8+9N73QEiIgJfQaegkg0jtIFQRRiUmAUAKGhCZ2RAVGFBEpVmRUwAFHhyJjRRQLg4Ji1wnyEFDGwVFEReXdjGsJ7601896a/cdZ39nnt9fZZ+9917oAUPyCBMJ0WAGANKFYFO7rwVwSE8vE9wIYEAEOWAHA4WZmBEf4RALU/L09mZmoSMaz9u4ugGS72yy/UCZz1v9/kSI3QyQGAApF1TY8fiYX5QKUU7PFGTL/BMr0lSkyhjEyFqEJoqwi48SvbPan5iu7yZiXJuShGlnOGbw0noy7UN6aJeGjjAShXJgl4GejfAdlvVRJmgDl9yjT0/icTAAwFJlfzOcmoWyJMkUUGe6J8gIACJTEObxyDov5OWieAHimZ+SKBIlJYqYR15hp5ejIZvrxs1P5YjErlMNN4Yh4TM/0tAyOMBeAr2+WRQElWW2ZaJHtrRzt7VnW5mj5v9nfHn5T/T3IevtV8Sbsz55BjJ5Z32zsrC+9FgD2JFqbHbO+lVUAtG0GQOXhrE/vIADyBQC03pzzHoZsXpLE4gwnC4vs7GxzAZ9rLivoN/ufgm/Kv4Y595nL7vtWO6YXP4EjSRUzZUXlpqemS0TMzAwOl89k/fcQ/+PAOWnNycMsnJ/AF/GF6FVR6JQJhIlou4U8gViQLmQKhH/V4X8YNicHGX6daxRodV8AfYU5ULhJB8hvPQBDIwMkbj96An3rWxAxCsi+vGitka9zjzJ6/uf6Hwtcim7hTEEiU+b2DI9kciWiLBmj34RswQISkAd0oAo0gS4wAixgDRyAM3AD3iAAhIBIEAOWAy5IAmlABLJBPtgACkEx2AF2g2pwANSBetAEToI2cAZcBFfADXALDIBHQAqGwUswAd6BaQiC8BAVokGqkBakD5lC1hAbWgh5Q0FQOBQDxUOJkBCSQPnQJqgYKoOqoUNQPfQjdBq6CF2D+qAH0CA0Bv0BfYQRmALTYQ3YALaA2bA7HAhHwsvgRHgVnAcXwNvhSrgWPg63whfhG/AALIVfwpMIQMgIA9FGWAgb8URCkFgkAREha5EipAKpRZqQDqQbuY1IkXHkAwaHoWGYGBbGGeOHWYzhYlZh1mJKMNWYY5hWTBfmNmYQM4H5gqVi1bGmWCesP3YJNhGbjS3EVmCPYFuwl7ED2GHsOxwOx8AZ4hxwfrgYXDJuNa4Etw/XjLuA68MN4SbxeLwq3hTvgg/Bc/BifCG+Cn8cfx7fjx/GvyeQCVoEa4IPIZYgJGwkVBAaCOcI/YQRwjRRgahPdCKGEHnEXGIpsY7YQbxJHCZOkxRJhiQXUiQpmbSBVElqIl0mPSa9IZPJOmRHchhZQF5PriSfIF8lD5I/UJQoJhRPShxFQtlOOUq5QHlAeUOlUg2obtRYqpi6nVpPvUR9Sn0vR5Mzl/OX48mtk6uRa5Xrl3slT5TXl3eXXy6fJ18hf0r+pvy4AlHBQMFTgaOwVqFG4bTCPYVJRZqilWKIYppiiWKD4jXFUSW8koGStxJPqUDpsNIlpSEaQtOledK4tE20Otpl2jAdRzek+9OT6cX0H+i99AllJWVb5SjlHOUa5bPKUgbCMGD4M1IZpYyTjLuMj/M05rnP48/bNq9pXv+8KZX5Km4qfJUilWaVAZWPqkxVb9UU1Z2qbapP1DBqJmphatlq+9Uuq43Pp893ns+dXzT/5PyH6rC6iXq4+mr1w+o96pMamhq+GhkaVRqXNMY1GZpumsma5ZrnNMe0aFoLtQRa5VrntV4wlZnuzFRmJbOLOaGtru2nLdE+pN2rPa1jqLNYZ6NOs84TXZIuWzdBt1y3U3dCT0svWC9fr1HvoT5Rn62fpL9Hv1t/ysDQINpgi0GbwaihiqG/YZ5ho+FjI6qRq9Eqo1qjO8Y4Y7ZxivE+41smsImdSZJJjclNU9jU3lRgus+0zwxr5mgmNKs1u8eisNxZWaxG1qA5wzzIfKN5m/krCz2LWIudFt0WXyztLFMt6ywfWSlZBVhttOqw+sPaxJprXWN9x4Zq42Ozzqbd5rWtqS3fdr/tfTuaXbDdFrtOu8/2DvYi+yb7MQc9h3iHvQ732HR2KLuEfdUR6+jhuM7xjOMHJ3snsdNJp9+dWc4pzg3OowsMF/AX1C0YctFx4bgccpEuZC6MX3hwodRV25XjWuv6zE3Xjed2xG3E3dg92f24+ysPSw+RR4vHlKeT5xrPC16Il69XkVevt5L3Yu9q76c+Oj6JPo0+E752vqt9L/hh/QL9dvrd89fw5/rX+08EOASsCegKpARGBFYHPgsyCRIFdQTDwQHBu4IfL9JfJFzUFgJC/EN2hTwJNQxdFfpzGC4sNKwm7Hm4VXh+eHcELWJFREPEu0iPyNLIR4uNFksWd0bJR8VF1UdNRXtFl0VLl1gsWbPkRoxajCCmPRYfGxV7JHZyqffS3UuH4+ziCuPuLjNclrPs2nK15anLz66QX8FZcSoeGx8d3xD/iRPCqeVMrvRfuXflBNeTu4f7kufGK+eN8V34ZfyRBJeEsoTRRJfEXYljSa5JFUnjAk9BteB1sl/ygeSplJCUoykzqdGpzWmEtPi000IlYYqwK10zPSe9L8M0ozBDuspp1e5VE6JA0ZFMKHNZZruYjv5M9UiMJJslg1kLs2qy3mdHZZ/KUcwR5vTkmuRuyx3J88n7fjVmNXd1Z752/ob8wTXuaw6thdauXNu5Tnddwbrh9b7rj20gbUjZ8MtGy41lG99uit7UUaBRsL5gaLPv5sZCuUJR4b0tzlsObMVsFWzt3WazrWrblyJe0fViy+KK4k8l3JLr31l9V/ndzPaE7b2l9qX7d+B2CHfc3em681iZYlle2dCu4F2t5czyovK3u1fsvlZhW3FgD2mPZI+0MqiyvUqvakfVp+qk6oEaj5rmvep7t+2d2sfb17/fbX/TAY0DxQc+HhQcvH/I91BrrUFtxWHc4azDz+ui6rq/Z39ff0TtSPGRz0eFR6XHwo911TvU1zeoN5Q2wo2SxrHjccdv/eD1Q3sTq+lQM6O5+AQ4ITnx4sf4H++eDDzZeYp9qukn/Z/2ttBailqh1tzWibakNml7THvf6YDTnR3OHS0/m/989Iz2mZqzymdLz5HOFZybOZ93fvJCxoXxi4kXhzpXdD66tOTSna6wrt7LgZevXvG5cqnbvfv8VZerZ645XTt9nX297Yb9jdYeu56WX+x+aem172296XCz/ZbjrY6+BX3n+l37L972un3ljv+dGwOLBvruLr57/17cPel93v3RB6kPXj/Mejj9aP1j7OOiJwpPKp6qP6391fjXZqm99Oyg12DPs4hnj4a4Qy//lfmvT8MFz6nPK0a0RupHrUfPjPmM3Xqx9MXwy4yX0+OFvyn+tveV0auffnf7vWdiycTwa9HrmT9K3qi+OfrW9m3nZOjk03dp76anit6rvj/2gf2h+2P0x5Hp7E/4T5WfjT93fAn88ngmbWbm3/eE8/syOll+AAAACXBIWXMAAAsTAAALEwEAmpwYAAAB1WlUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iWE1QIENvcmUgNS40LjAiPgogICA8cmRmOlJERiB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPgogICAgICA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIgogICAgICAgICAgICB4bWxuczp0aWZmPSJodHRwOi8vbnMuYWRvYmUuY29tL3RpZmYvMS4wLyI+CiAgICAgICAgIDx0aWZmOkNvbXByZXNzaW9uPjE8L3RpZmY6Q29tcHJlc3Npb24+CiAgICAgICAgIDx0aWZmOlBob3RvbWV0cmljSW50ZXJwcmV0YXRpb24+MjwvdGlmZjpQaG90b21ldHJpY0ludGVycHJldGF0aW9uPgogICAgICAgICA8dGlmZjpPcmllbnRhdGlvbj4xPC90aWZmOk9yaWVudGF0aW9uPgogICAgICA8L3JkZjpEZXNjcmlwdGlvbj4KICAgPC9yZGY6UkRGPgo8L3g6eG1wbWV0YT4KOXS2agAAAWdJREFUWAntk91NhUAUhC8WYB92YQEWYQhWYLQKW4AnOrAA+7AGn3khAXeu+ZIJOfws8mAim9x7dmfnzAy7cLmc4zyB/34CxdwBtG172/f9+3R/HMfPsiyfhDdN8zoMw12aflVV9TLlblmHAeq6fi6K4m1NIAW59qcgI1ww1mv1JiIk84cIn2IYuynYlDu3DgM4WeL8HGeO4d4QqwEwWqq/CXFIAIXbGyJ8CZPYR9K8l3Du4CoIpH6wSOuwE0AcYzcFg+M1DNB13aOTcucYbgkRXoEMEck1dz4BXAsM3mwAEbyRhtyKoWuBSSu8AkycCJZbMXathOklv47FAGJ440/Lsf+LV+BWPIljW+Y8gPeDqX9zAJFdROu1gZH3gdGbFUBNLoZIVDFyPpjzswOo2UVdjDlGzgODQ90VQM0ujpgqRr4P5jzmuwNIwE20xshxMO1HY/UzjJrAXNzn0T7YWc8TOE/gz53AN34Bn5aWTdpfAAAAAElFTkSuQmCC" alt="enter image description here">ï¼‰ã€‚ä¸€ä¸ªLabelæ˜¯attachåˆ°Podçš„ä¸€å¯¹é”®/å€¼å¯¹ï¼Œç”¨æ¥ä¼ é€’ç”¨æˆ·å®šä¹‰çš„å±æ€§ã€‚æ¯”å¦‚ï¼Œä½ å¯èƒ½åˆ›å»ºäº†ä¸€ä¸ªâ€tierâ€å’Œâ€œappâ€æ ‡ç­¾ï¼Œé€šè¿‡Labelï¼ˆ<strong>tier=frontend, app=myapp</strong>ï¼‰æ¥æ ‡è®°å‰ç«¯Podå®¹å™¨ï¼Œä½¿ç”¨Labelï¼ˆ<strong>tier=backend, app=myapp</strong>ï¼‰æ ‡è®°åå°Podã€‚ç„¶åå¯ä»¥ä½¿ç”¨ <a href="https://kubernetes.io/docs/concepts/overview/working-with-objects/labels/" target="_blank" rel="noopener">Selectors</a> é€‰æ‹©å¸¦æœ‰ç‰¹å®šLabelçš„Podï¼Œå¹¶ä¸”å°†Serviceæˆ–è€…Replication Controlleråº”ç”¨åˆ°ä¸Šé¢ã€‚</p><h2 id="Replication-Controller"><a href="#Replication-Controller" class="headerlink" title="Replication Controller"></a>Replication Controller</h2><p><em>æ˜¯å¦æ‰‹åŠ¨åˆ›å»ºPodï¼Œå¦‚æœæƒ³è¦åˆ›å»ºåŒä¸€ä¸ªå®¹å™¨çš„å¤šä»½æ‹·è´ï¼Œéœ€è¦ä¸€ä¸ªä¸ªåˆ†åˆ«åˆ›å»ºå‡ºæ¥ä¹ˆï¼Œèƒ½å¦å°†Podsåˆ’åˆ°é€»è¾‘ç»„é‡Œï¼Ÿ</em></p><p>Replication Controllerç¡®ä¿ä»»æ„æ—¶é—´éƒ½æœ‰æŒ‡å®šæ•°é‡çš„Podâ€œå‰¯æœ¬â€åœ¨è¿è¡Œã€‚å¦‚æœä¸ºæŸä¸ªPodåˆ›å»ºäº†Replication Controllerå¹¶ä¸”æŒ‡å®š3ä¸ªå‰¯æœ¬ï¼Œå®ƒä¼šåˆ›å»º3ä¸ªPodï¼Œå¹¶ä¸”æŒç»­ç›‘æ§å®ƒä»¬ã€‚å¦‚æœæŸä¸ªPodä¸å“åº”ï¼Œé‚£ä¹ˆReplication Controllerä¼šæ›¿æ¢å®ƒï¼Œä¿æŒæ€»æ•°ä¸º3.å¦‚ä¸‹é¢çš„åŠ¨ç”»æ‰€ç¤ºï¼š</p><p><img src="https://s1.ax1x.com/2020/05/04/YPJoVA.png" alt="YPJoVA.png"></p><p>å¦‚æœä¹‹å‰ä¸å“åº”çš„Podæ¢å¤äº†ï¼Œç°åœ¨å°±æœ‰4ä¸ªPodäº†ï¼Œé‚£ä¹ˆReplication Controllerä¼šå°†å…¶ä¸­ä¸€ä¸ªç»ˆæ­¢ä¿æŒæ€»æ•°ä¸º3ã€‚å¦‚æœåœ¨è¿è¡Œä¸­å°†å‰¯æœ¬æ€»æ•°æ”¹ä¸º5ï¼ŒReplication Controllerä¼šç«‹åˆ»å¯åŠ¨2ä¸ªæ–°Podï¼Œä¿è¯æ€»æ•°ä¸º5ã€‚è¿˜å¯ä»¥æŒ‰ç…§è¿™æ ·çš„æ–¹å¼ç¼©å°Podï¼Œè¿™ä¸ªç‰¹æ€§åœ¨æ‰§è¡Œæ»šåŠ¨ <a href="https://kubernetes.io/docs/concepts/workloads/controllers/replicationcontroller/#rolling_updates" target="_blank" rel="noopener">å‡çº§</a> æ—¶å¾ˆæœ‰ç”¨ã€‚</p><p>å½“åˆ›å»ºReplication Controlleræ—¶ï¼Œéœ€è¦æŒ‡å®šä¸¤ä¸ªä¸œè¥¿ï¼š</p><ol><li>Podæ¨¡æ¿ï¼šç”¨æ¥åˆ›å»ºPodå‰¯æœ¬çš„æ¨¡æ¿</li><li>Labelï¼šReplication Controlleréœ€è¦ç›‘æ§çš„Podçš„æ ‡ç­¾ã€‚ç°åœ¨å·²ç»åˆ›å»ºäº†Podçš„ä¸€äº›å‰¯æœ¬ï¼Œé‚£ä¹ˆåœ¨è¿™äº›å‰¯æœ¬ä¸Šå¦‚ä½•å‡è¡¡è´Ÿè½½å‘¢ï¼Ÿæˆ‘ä»¬éœ€è¦çš„æ˜¯Serviceã€‚</li></ol><p>TIP</p><p>æœ€æ–° Kubernetes ç‰ˆæœ¬é‡Œï¼Œæ¨èä½¿ç”¨ Deployment</p><h2 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h2><p><em>å¦‚æœPodsæ˜¯çŸ­æš‚çš„ï¼Œé‚£ä¹ˆé‡å¯æ—¶IPåœ°å€å¯èƒ½ä¼šæ”¹å˜ï¼Œæ€ä¹ˆæ‰èƒ½ä»å‰ç«¯å®¹å™¨æ­£ç¡®å¯é åœ°æŒ‡å‘åå°å®¹å™¨å‘¢ï¼Ÿ</em> <a href="https://kubernetes.io/docs/concepts/services-networking/service/" target="_blank" rel="noopener">Service</a> <strong>æŠ½è±¡</strong> ç°åœ¨ï¼Œå‡å®šæœ‰2ä¸ªåå°Podï¼Œå¹¶ä¸”å®šä¹‰åå°Serviceçš„åç§°ä¸ºâ€˜backend-serviceâ€™ï¼Œlabelé€‰æ‹©å™¨ä¸º(tier=backend, app=myapp) çš„Serviceä¼šå®Œæˆå¦‚ä¸‹ä¸¤ä»¶é‡è¦çš„äº‹æƒ…ï¼š</p><ul><li>ä¼šä¸ºServiceåˆ›å»ºä¸€ä¸ªæœ¬åœ°é›†ç¾¤çš„DNSå…¥å£ï¼Œå› æ­¤å‰ç«¯Podåªéœ€è¦DNSæŸ¥æ‰¾ä¸»æœºåä¸º â€˜backend-serviceâ€™ï¼Œå°±èƒ½å¤Ÿè§£æå‡ºå‰ç«¯åº”ç”¨ç¨‹åºå¯ç”¨çš„IPåœ°å€ã€‚</li><li>ç°åœ¨å‰ç«¯å·²ç»å¾—åˆ°äº†åå°æœåŠ¡çš„IPåœ°å€ï¼Œä½†æ˜¯å®ƒåº”è¯¥è®¿é—®2ä¸ªåå°Podçš„å“ªä¸€ä¸ªå‘¢ï¼ŸServiceåœ¨è¿™2ä¸ªåå°Podä¹‹é—´æä¾›é€æ˜çš„è´Ÿè½½å‡è¡¡ï¼Œä¼šå°†è¯·æ±‚åˆ†å‘ç»™å…¶ä¸­çš„ä»»æ„ä¸€ä¸ªï¼ˆå¦‚ä¸‹é¢çš„åŠ¨ç”»æ‰€ç¤ºï¼‰ã€‚é€šè¿‡æ¯ä¸ªNodeä¸Šè¿è¡Œçš„ä»£ç†ï¼ˆkube-proxyï¼‰å®Œæˆã€‚</li></ul><p>ä¸‹è¿°åŠ¨ç”»å±•ç¤ºäº†Serviceçš„åŠŸèƒ½ã€‚æ³¨æ„è¯¥å›¾ä½œäº†å¾ˆå¤šç®€åŒ–ã€‚å¦‚æœä¸è¿›å…¥ç½‘ç»œé…ç½®ï¼Œé‚£ä¹ˆè¾¾åˆ°é€æ˜çš„è´Ÿè½½å‡è¡¡ç›®æ ‡æ‰€æ¶‰åŠçš„åº•å±‚ç½‘ç»œå’Œè·¯ç”±ç›¸å¯¹å…ˆè¿›ã€‚å¦‚æœæœ‰å…´è¶£ï¼Œæœ‰æ›´æ·±å…¥çš„ä»‹ç»ã€‚</p><p><img src="https://s1.ax1x.com/2020/05/04/YPJOxS.png" alt="YPJOxS.png"></p><p>æ¯ä¸ªèŠ‚ç‚¹éƒ½è¿è¡Œå¦‚ä¸‹Kuberneteså…³é”®ç»„ä»¶ï¼š</p><ul><li>Kubeletï¼šæ˜¯ä¸»èŠ‚ç‚¹ä»£ç†ã€‚</li><li>Kube-proxyï¼šServiceä½¿ç”¨å…¶å°†é“¾æ¥è·¯ç”±åˆ°Podï¼Œå¦‚ä¸Šæ–‡æ‰€è¿°ã€‚</li><li>Dockeræˆ–Rocketï¼šKubernetesä½¿ç”¨çš„å®¹å™¨æŠ€æœ¯æ¥åˆ›å»ºå®¹å™¨ã€‚</li></ul><h3 id="Kubernetes-Master"><a href="#Kubernetes-Master" class="headerlink" title="Kubernetes Master"></a>Kubernetes Master</h3><p>é›†ç¾¤æ‹¥æœ‰ä¸€ä¸ªKubernetes Masterï¼ˆç´«è‰²æ–¹æ¡†ï¼‰ã€‚Kubernetes Masteræä¾›é›†ç¾¤çš„ç‹¬ç‰¹è§†è§’ï¼Œå¹¶ä¸”æ‹¥æœ‰ä¸€ç³»åˆ—ç»„ä»¶ï¼Œæ¯”å¦‚Kubernetes API Serverã€‚API Serveræä¾›å¯ä»¥ç”¨æ¥å’Œé›†ç¾¤äº¤äº’çš„RESTç«¯ç‚¹ã€‚masterèŠ‚ç‚¹åŒ…æ‹¬ç”¨æ¥åˆ›å»ºå’Œå¤åˆ¶Podçš„Replication Controllerã€‚</p>]]></content>
      
      
      <categories>
          
          <category> å®¹å™¨ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Dockeræ•°æ®å…±äº«ä¸æŒä¹…åŒ–</title>
      <link href="2020/01/19/rong-qi/docker-shu-ju-gong-xiang-yu-chi-jiu-hua/"/>
      <url>2020/01/19/rong-qi/docker-shu-ju-gong-xiang-yu-chi-jiu-hua/</url>
      
        <content type="html"><![CDATA[<a id="more"></a>æœ¬æ–‡ä»‹ç»å¦‚ä½•åœ¨ Docker å†…éƒ¨ä»¥åŠå®¹å™¨ä¹‹é—´ç®¡ç†æ•°æ®ï¼Œåœ¨å®¹å™¨ä¸­ç®¡ç†æ•°æ®ä¸»è¦æœ‰ä¸¤ç§æ–¹å¼ï¼š<ul><li>æ•°æ®å·ï¼ˆData Volumesï¼‰</li><li>æŒ‚è½½ä¸»æœºç›®å½• (Bind mounts)</li></ul><h2 id="æ•°æ®å·"><a href="#æ•°æ®å·" class="headerlink" title="æ•°æ®å·"></a>æ•°æ®å·</h2><p><code>æ•°æ®å·</code>æ˜¯ä¸€ä¸ªå¯ä¾›ä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨ä½¿ç”¨çš„ç‰¹æ®Šç›®å½•ï¼Œå®ƒç»•è¿‡<code>UFS</code>ï¼Œå¯ä»¥æä¾›å¾ˆå¤šæœ‰ç”¨çš„ç‰¹æ€§ï¼š</p><ul><li>æ•°æ®å· å¯ä»¥åœ¨å®¹å™¨ä¹‹é—´å…±äº«å’Œé‡ç”¨</li><li>å¯¹ æ•°æ®å· çš„ä¿®æ”¹ä¼šç«‹é©¬ç”Ÿæ•ˆ</li><li>å¯¹ æ•°æ®å· çš„æ›´æ–°ï¼Œä¸ä¼šå½±å“é•œåƒ</li><li>æ•°æ®å· é»˜è®¤ä¼šä¸€ç›´å­˜åœ¨ï¼Œå³ä½¿å®¹å™¨è¢«åˆ é™¤</li></ul><blockquote><p>æ³¨æ„ï¼šæ•°æ®å· çš„ä½¿ç”¨ï¼Œç±»ä¼¼äº Linux ä¸‹å¯¹ç›®å½•æˆ–æ–‡ä»¶è¿›è¡Œ mountï¼Œé•œåƒä¸­çš„è¢«æŒ‡å®šä¸ºæŒ‚è½½ç‚¹çš„ç›®å½•ä¸­çš„æ–‡ä»¶ä¼šéšè—æ‰ï¼Œèƒ½æ˜¾ç¤ºçœ‹çš„æ˜¯æŒ‚è½½çš„ æ•°æ®å·ã€‚</p></blockquote><p>é€‰æ‹© -v è¿˜æ˜¯ -â€“mount å‚æ•°ï¼š Docker æ–°ç”¨æˆ·åº”è¯¥é€‰æ‹©<code>--mount</code>å‚æ•°ï¼Œç»éªŒä¸°å¯Œçš„ Docker ä½¿ç”¨è€…å¯¹<code>-v</code>æˆ–è€… <code>--volume</code>å·²ç»å¾ˆç†Ÿæ‚‰äº†ï¼Œä½†æ˜¯æ¨èä½¿ç”¨<code>--mount</code>å‚æ•°ã€‚</p><p>åˆ›å»ºä¸€ä¸ªæ•°æ®å·ï¼š</p><pre class=" language-shell"><code class="language-shell">$ docker volume create my-vol</code></pre><p>æŸ¥çœ‹æ‰€æœ‰çš„ æ•°æ®å·ï¼š</p><pre class=" language-shell"><code class="language-shell">$ docker volume lslocal               my-vol</code></pre><p>åœ¨ä¸»æœºé‡Œä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å¯ä»¥æŸ¥çœ‹æŒ‡å®š æ•°æ®å· çš„ä¿¡æ¯</p><pre class=" language-shell"><code class="language-shell">$ docker volume inspect my-vol[    {        "Driver": "local",        "Labels": {},        "Mountpoint": "/var/lib/docker/volumes/my-vol/_data",        "Name": "my-vol",        "Options": {},        "Scope": "local"    }]</code></pre><p>å¯åŠ¨ä¸€ä¸ªæŒ‚è½½æ•°æ®å·çš„å®¹å™¨ï¼šåœ¨ç”¨<code>docker run</code>å‘½ä»¤çš„æ—¶å€™ï¼Œä½¿ç”¨<code>--mount</code>æ ‡è®°æ¥å°† æ•°æ®å· æŒ‚è½½åˆ°å®¹å™¨é‡Œã€‚åœ¨ä¸€æ¬¡<code>docker run</code>ä¸­å¯ä»¥æŒ‚è½½å¤šä¸ª æ•°æ®å·ã€‚ä¸‹é¢åˆ›å»ºä¸€ä¸ªåä¸º web çš„å®¹å™¨ï¼Œå¹¶åŠ è½½ä¸€ä¸ª æ•°æ®å· åˆ°å®¹å™¨çš„ /webapp ç›®å½•ã€‚</p><pre class=" language-shell"><code class="language-shell">$ docker run -d -P \    --name web \    # -v my-vol:/wepapp \    --mount source=my-vol,target=/webapp \    training/webapp \    python app.py</code></pre><p>æŸ¥çœ‹æ•°æ®å·çš„å…·ä½“ä¿¡æ¯ï¼šåœ¨ä¸»æœºé‡Œä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å¯ä»¥æŸ¥çœ‹ web å®¹å™¨çš„ä¿¡æ¯</p><pre class=" language-shell"><code class="language-shell">$ docker inspect web..."Mounts": [    {        "Type": "volume",        "Name": "my-vol",        "Source": "/var/lib/docker/volumes/my-vol/_data",        "Destination": "/app",        "Driver": "local",        "Mode": "",        "RW": true,        "Propagation": ""    }],...</code></pre><p>åˆ é™¤æ•°æ®å·ï¼š</p><pre><code>$ docker volume rm my-vol</code></pre><p>æ•°æ®å· æ˜¯è¢«è®¾è®¡ç”¨æ¥æŒä¹…åŒ–æ•°æ®çš„ï¼Œå®ƒçš„ç”Ÿå‘½å‘¨æœŸç‹¬ç«‹äºå®¹å™¨ï¼ŒDocker ä¸ä¼šåœ¨å®¹å™¨è¢«åˆ é™¤åè‡ªåŠ¨åˆ é™¤ æ•°æ®å·ï¼Œå¹¶ä¸”ä¹Ÿä¸å­˜åœ¨åƒåœ¾å›æ”¶è¿™æ ·çš„æœºåˆ¶æ¥å¤„ç†æ²¡æœ‰ä»»ä½•å®¹å™¨å¼•ç”¨çš„ æ•°æ®å·ã€‚å¦‚æœéœ€è¦åœ¨åˆ é™¤å®¹å™¨çš„åŒæ—¶ç§»é™¤æ•°æ®å·ã€‚å¯ä»¥åœ¨åˆ é™¤å®¹å™¨çš„æ—¶å€™ä½¿ç”¨<code>docker rm -v</code>è¿™ä¸ªå‘½ä»¤ã€‚ æ— ä¸»çš„æ•°æ®å·å¯èƒ½ä¼šå æ®å¾ˆå¤šç©ºé—´ï¼Œè¦æ¸…ç†è¯·ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤</p><pre><code>$ docker volume prune</code></pre><h2 id="æŒ‚è½½ä¸»æœºç›®å½•"><a href="#æŒ‚è½½ä¸»æœºç›®å½•" class="headerlink" title="æŒ‚è½½ä¸»æœºç›®å½•"></a>æŒ‚è½½ä¸»æœºç›®å½•</h2><p>é€‰æ‹© -v è¿˜æ˜¯ -â€“mount å‚æ•°ï¼š Docker æ–°ç”¨æˆ·åº”è¯¥é€‰æ‹© â€“mount å‚æ•°ï¼Œç»éªŒä¸°å¯Œçš„ Docker ä½¿ç”¨è€…å¯¹ -v æˆ–è€… â€“volume å·²ç»å¾ˆç†Ÿæ‚‰äº†ï¼Œä½†æ˜¯æ¨èä½¿ç”¨ â€“mount å‚æ•°ã€‚</p><p>æŒ‚è½½ä¸€ä¸ªä¸»æœºç›®å½•ä½œä¸ºæ•°æ®å·ï¼šä½¿ç”¨ <code>--mount</code> æ ‡è®°å¯ä»¥æŒ‡å®šæŒ‚è½½ä¸€ä¸ªæœ¬åœ°ä¸»æœºçš„ç›®å½•åˆ°å®¹å™¨ä¸­å»ã€‚</p><pre class=" language-shell"><code class="language-shell">$ docker run -d -P \    --name web \    # -v /src/webapp:/opt/webapp \    --mount type=bind,source=/src/webapp,target=/opt/webapp \    training/webapp \    python app.py</code></pre><p>ä¸Šé¢çš„å‘½ä»¤åŠ è½½ä¸»æœºçš„ /src/webapp ç›®å½•åˆ°å®¹å™¨çš„ /opt/webappç›®å½•ã€‚è¿™ä¸ªåŠŸèƒ½åœ¨è¿›è¡Œæµ‹è¯•çš„æ—¶å€™ååˆ†æ–¹ä¾¿ï¼Œæ¯”å¦‚ç”¨æˆ·å¯ä»¥æ”¾ç½®ä¸€äº›ç¨‹åºåˆ°æœ¬åœ°ç›®å½•ä¸­ï¼Œæ¥æŸ¥çœ‹å®¹å™¨æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚æœ¬åœ°ç›®å½•çš„è·¯å¾„å¿…é¡»æ˜¯ç»å¯¹è·¯å¾„ï¼Œä»¥å‰ä½¿ç”¨ -v å‚æ•°æ—¶å¦‚æœæœ¬åœ°ç›®å½•ä¸å­˜åœ¨ Docker ä¼šè‡ªåŠ¨ä¸ºä½ åˆ›å»ºä¸€ä¸ªæ–‡ä»¶å¤¹ï¼Œç°åœ¨ä½¿ç”¨ â€“mount å‚æ•°æ—¶å¦‚æœæœ¬åœ°ç›®å½•ä¸å­˜åœ¨ï¼ŒDocker ä¼šæŠ¥é”™ã€‚</p><p>Docker æŒ‚è½½ä¸»æœºç›®å½•çš„é»˜è®¤æƒé™æ˜¯ è¯»å†™ï¼Œç”¨æˆ·ä¹Ÿå¯ä»¥é€šè¿‡å¢åŠ <code>readonly</code>æŒ‡å®šä¸º åªè¯»ã€‚</p><pre class=" language-shell"><code class="language-shell">$ docker run -d -P \    --name web \    # -v /src/webapp:/opt/webapp:ro \    --mount type=bind,source=/src/webapp,target=/opt/webapp,readonly \    training/webapp \    python app.py</code></pre><p>åŠ äº†<code>readonly</code>ä¹‹åï¼Œå°±æŒ‚è½½ä¸º åªè¯» äº†ã€‚å¦‚æœä½ åœ¨å®¹å™¨å†… /opt/webapp ç›®å½•æ–°å»ºæ–‡ä»¶ï¼Œä¼šæ˜¾ç¤ºå¦‚ä¸‹é”™è¯¯:</p><pre class=" language-shell"><code class="language-shell">/opt/webapp # touch new.txttouch: new.txt: Read-only file system</code></pre><p>æŸ¥çœ‹æ•°æ®å·çš„å…·ä½“ä¿¡æ¯ï¼šåœ¨ä¸»æœºé‡Œä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å¯ä»¥æŸ¥çœ‹ web å®¹å™¨çš„ä¿¡æ¯</p><pre class=" language-shell"><code class="language-shell">$ docker inspect web..."Mounts": [    {        "Type": "bind",        "Source": "/src/webapp",        "Destination": "/opt/webapp",        "Mode": "",        "RW": true,        "Propagation": "rprivate"    }],</code></pre><p>æŒ‚è½½ä¸€ä¸ªæœ¬åœ°ä¸»æœºæ–‡ä»¶ä½œä¸ºæ•°æ®å·ï¼š<code>--mount</code>æ ‡è®°ä¹Ÿå¯ä»¥ä»ä¸»æœºæŒ‚è½½å•ä¸ªæ–‡ä»¶åˆ°å®¹å™¨ä¸­</p><pre class=" language-shell"><code class="language-shell">$ docker run --rm -it \   # -v $HOME/.bash_history:/root/.bash_history \   --mount type=bind,source=$HOME/.bash_history,target=/root/.bash_history \   ubuntu:17.10 \   bashroot@2affd44b4667:/# history1  ls2  diskutil list</code></pre><p>è¿™æ ·å°±å¯ä»¥è®°å½•åœ¨å®¹å™¨è¾“å…¥è¿‡çš„å‘½ä»¤äº†ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> å®¹å™¨ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>zabbix-ç›‘æ§é¡¹</title>
      <link href="2020/01/05/jian-kong/zabbix/zabbix-jian-kong-xiang/"/>
      <url>2020/01/05/jian-kong/zabbix/zabbix-jian-kong-xiang/</url>
      
        <content type="html"><![CDATA[<h4 id="Zabbixç›‘æ§ä»€ä¹ˆï¼Ÿ"><a href="#Zabbixç›‘æ§ä»€ä¹ˆï¼Ÿ" class="headerlink" title="Zabbixç›‘æ§ä»€ä¹ˆï¼Ÿ"></a>Zabbixç›‘æ§ä»€ä¹ˆï¼Ÿ</h4><p><img src="http://p1.pstatp.com/large/pgc-image/1ee9df63b32b4108a8537cc27eb9252b" alt="Zabbix ç›‘æ§"></p><p>ç›‘æ§é¡¹</p><h4 id="Zabbixå¸¸ç”¨ç›‘æ§é¡¹"><a href="#Zabbixå¸¸ç”¨ç›‘æ§é¡¹" class="headerlink" title="Zabbixå¸¸ç”¨ç›‘æ§é¡¹"></a>Zabbixå¸¸ç”¨ç›‘æ§é¡¹</h4><p><strong>zabbixè‡ªå¸¦çš„å¸¸ç”¨ç›‘æ§é¡¹</strong></p><pre><code>agent.ping æ£€æµ‹å®¢æˆ·ç«¯å¯è¾¾æ€§ã€è¿”å›nothingè¡¨ç¤ºä¸å¯è¾¾ã€‚1è¡¨ç¤ºå¯è¾¾system.cpu.load --æ£€æµ‹cpuè´Ÿè½½ã€‚è¿”å›æµ®ç‚¹æ•°system.cpu.util -- æ£€æµ‹cpuä½¿ç”¨ç‡ã€‚è¿”å›æµ®ç‚¹æ•°vfs.dev.read -- æ£€æµ‹ç¡¬ç›˜è¯»å–æ•°æ®ï¼Œè¿”å›æ˜¯sps.ops.bpsæµ®ç‚¹ç±»å‹ï¼Œéœ€è¦å®šä¹‰1024å€vfs.dev.write -- æ£€æµ‹ç¡¬ç›˜å†™å…¥æ•°æ®ã€‚è¿”å›æ˜¯sps.ops.bpsæµ®ç‚¹ç±»å‹ï¼Œéœ€è¦å®šä¹‰1024å€net.if.out[br0] --æ£€æµ‹ç½‘å¡æµé€Ÿã€æµå‡ºæ–¹å‘ï¼Œæ—¶é—´é—´éš”ä¸º60Snet-if-in[br0] --æ£€æµ‹ç½‘å¡æµé€Ÿï¼Œæµå…¥æ–¹å‘ï¼ˆå•ä½ï¼šå­—èŠ‚ï¼‰ æ—¶é—´é—´éš”60Sproc.num[]  ç›®å‰ç³»ç»Ÿä¸­çš„è¿›ç¨‹æ€»æ•°ï¼Œæ—¶é—´é—´éš”60sproc.num[,,run] ç›®å‰æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹æ€»æ•°ï¼Œæ—¶é—´é—´éš”60S</code></pre><h5 id="å¤„ç†å™¨ä¿¡æ¯"><a href="#å¤„ç†å™¨ä¿¡æ¯" class="headerlink" title="å¤„ç†å™¨ä¿¡æ¯"></a>å¤„ç†å™¨ä¿¡æ¯</h5><pre><code>é€šè¿‡zabbix_get è·å–è´Ÿè½½å€¼åˆç†çš„æ§åˆ¶ç”¨æˆ·æ€ã€ç³»ç»Ÿæ€ã€IOç­‰å¾…æ—¶é—´å‰‹ä¿è¯è¿›ç¨‹é«˜æ•ˆç‡çš„è¿è¡Œç³»ç»Ÿæ€è¿è¡Œæ—¶é—´è¾ƒé«˜è¯´æ˜è¿›ç¨‹è¿›è¡Œç³»ç»Ÿè°ƒç”¨çš„æ¬¡æ•°æ¯”è¾ƒå¤šï¼Œä¸€èˆ¬çš„ç¨‹åºå¦‚æœç³»ç»Ÿæ€è¿è¡Œæ—¶é—´å ç”¨è¿‡é«˜å°±éœ€è¦ä¼˜åŒ–ç¨‹åºï¼Œå‡å°‘ç³»ç»Ÿè°ƒç”¨ioç­‰å¾…æ—¶é—´è¿‡é«˜åˆ™è¡¨æ˜ç¡¬ç›˜çš„ioæ€§èƒ½å·®ï¼Œå¦‚æœæ˜¯è¯»å†™æ–‡ä»¶æ¯”è¾ƒé¢‘ç¹ã€è¯»å†™æ•ˆç‡è¦æ±‚æ¯”è¾ƒé«˜ï¼Œå¯ä»¥è€ƒè™‘æ›´æ¢ç¡¬ç›˜ï¼Œæˆ–è€…ä½¿ç”¨å¤šç£ç›˜åšraidçš„æ–¹æ¡ˆsystem.cpu.swtiches --cpuçš„è¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå•ä½spsï¼Œè¡¨ç¤ºæ¯ç§’é‡‡æ ·æ¬¡æ•°ï¼Œapiä¸­å‚æ•°historyéœ€æŒ‡å®šä¸º3system.cpu.intr  --cpuä¸­æ–­æ•°é‡ã€apiä¸­å‚æ•°historyéœ€æŒ‡å®šä¸º3system.cpu.load[percpu,avg1]  --cpuæ¯åˆ†é’Ÿçš„è´Ÿè½½å€¼ï¼ŒæŒ‰ç…§æ ¸æ•°åšå¹³å‡å€¼(Processor load (1 min average per core))ï¼Œapiä¸­å‚æ•°historyéœ€æŒ‡å®šä¸º0system.cpu.load[percpu,avg5]  --cpuæ¯5åˆ†é’Ÿçš„è´Ÿè½½å€¼ï¼ŒæŒ‰ç…§æ ¸æ•°åšå¹³å‡å€¼(Processor load (5 min average per core))ï¼Œapiä¸­å‚æ•°historyéœ€æŒ‡å®šä¸º0system.cpu.load[percpu,avg15]  --cpuæ¯5åˆ†é’Ÿçš„è´Ÿè½½å€¼ï¼ŒæŒ‰ç…§æ ¸æ•°åšå¹³å‡å€¼(Processor load (15 min average per core))ï¼Œapiä¸­å‚æ•°historyéœ€æŒ‡å®šä¸º0</code></pre><h4 id="zabbixçš„è‡ªå®šä¹‰å¸¸ç”¨é¡¹"><a href="#zabbixçš„è‡ªå®šä¹‰å¸¸ç”¨é¡¹" class="headerlink" title="zabbixçš„è‡ªå®šä¹‰å¸¸ç”¨é¡¹"></a>zabbixçš„è‡ªå®šä¹‰å¸¸ç”¨é¡¹</h4><h5 id="å†…å­˜ç›¸å…³"><a href="#å†…å­˜ç›¸å…³" class="headerlink" title="å†…å­˜ç›¸å…³"></a>å†…å­˜ç›¸å…³</h5><pre><code>vim /usr/local/zabbix/etc/zabbix_agentd.conf.d/catcarm.confUserParameter=ram.info[*],/bin/cat  /proc/meminfo  |awk &#39;/^$1:{print $2}&#39;ram.info[Cached] --æ£€æµ‹å†…å­˜çš„ç¼“å­˜ä½¿ç”¨é‡ã€è¿”å›æ•´æ•°ï¼Œéœ€è¦å®šä¹‰1024å€ram.info[MemFree] --æ£€æµ‹å†…å­˜çš„ç©ºä½™é‡ï¼Œè¿”å›æ•´æ•°ï¼Œéœ€è¦å®šä¹‰1024å€ram.info[Buffers] --æ£€æµ‹å†…å­˜çš„ä½¿ç”¨é‡ï¼Œè¿”å›æ•´æ•°ï¼Œéœ€è¦å®šä¹‰1024å€</code></pre><h5 id="TCPç›¸å…³çš„è‡ªå®šä¹‰é¡¹"><a href="#TCPç›¸å…³çš„è‡ªå®šä¹‰é¡¹" class="headerlink" title="TCPç›¸å…³çš„è‡ªå®šä¹‰é¡¹"></a>TCPç›¸å…³çš„è‡ªå®šä¹‰é¡¹</h5><pre><code>vim /usr/local/zabbix/share/zabbix/alertscripts/tcp_connection.sh#!/bin/bashfunction ESTAB { /usr/sbin/ss -ant |awk &#39;{++s[$1]} END {for(k in s) print k,s[k]}&#39; | grep &#39;ESTAB&#39; | awk &#39;{print $2}&#39;}function TIMEWAIT {/usr/sbin/ss -ant | awk &#39;{++s[$1]} END {for(k in s) print k,s[k]}&#39; | grep &#39;TIME-WAIT&#39; | awk &#39;{print $2}&#39;}function LISTEN {/usr/sbin/ss -ant | awk &#39;{++s[$1]} END {for(k in s) print k,s[k]}&#39; | grep &#39;LISTEN&#39; | awk &#39;{print $2}&#39;}$1vim /usr/local/zabbix/etc/zabbix_agentd.conf.d/cattcp.confUserParameter=tcp[*],/usr/local/zabbix/share/zabbix/alertscripts/tcp_connection.sh $1tcp[TIMEWAIT] --æ£€æµ‹TCPçš„é©»ç•™æ•°ï¼Œè¿”å›æ•´æ•°tcp[ESTAB]  --æ£€æµ‹tcpçš„è¿æ¥æ•°ã€è¿”å›æ•´æ•°tcp[LISTEN] --æ£€æµ‹TCPçš„ç›‘å¬æ•°ï¼Œè¿”å›æ•´æ•°</code></pre><h5 id="nginxç›¸å…³çš„è‡ªå®šä¹‰é¡¹"><a href="#nginxç›¸å…³çš„è‡ªå®šä¹‰é¡¹" class="headerlink" title="nginxç›¸å…³çš„è‡ªå®šä¹‰é¡¹"></a>nginxç›¸å…³çš„è‡ªå®šä¹‰é¡¹</h5><pre><code>vim /etc/nginx/conf.d/default.conf    location /nginx-status    {        stub_status on;        access_log off;        allow 127.0.0.1;        deny all;    }vim /usr/local/zabbix/etc/zabbix_agentd.conf.d/nginx.confUserParameter=Nginx.active,/usr/bin/curl -s &quot;http://127.0.0.1:80/nginx-status&quot; | awk &#39;/Active/ {print $NF}&#39;UserParameter=Nginx.read,/usr/bin/curl -s &quot;http://127.0.0.1:80/nginx-status&quot; | grep &#39;Reading&#39; | cut -d&quot; &quot; -f2UserParameter=Nginx.wrie,/usr/bin/curl -s &quot;http://127.0.0.1:80/nginx-status&quot; | grep &#39;Writing&#39; | cut -d&quot; &quot; -f4UserParameter=Nginx.wait,/usr/bin/curl -s &quot;http://127.0.0.1:80/nginx-status&quot; | grep &#39;Waiting&#39; | cut -d&quot; &quot; -f6UserParameter=Nginx.accepted,/usr/bin/curl -s &quot;http://127.0.0.1:80/nginx-status&quot; | awk &#39;/^[ \t]+[0-9]+[ \t]+[0-9]+[ \t]+[0-9]+/ {print $1}&#39;UserParameter=Nginx.handled,/usr/bin/curl -s &quot;http://127.0.0.1:80/nginx-status&quot; | awk &#39;/^[ \t]+[0-9]+[ \t]+[0-9]+[ \t]+[0-9]+/ {print $2}&#39;UserParameter=Nginx.requests,/usr/bin/curl -s &quot;http://127.0.0.1:80/nginx-status&quot; | awk &#39;/^[ \t]+[0-9]+[ \t]+[0-9]+[ \t]+[0-9]+/ {print $3}&#39;PHP.listenqueue --æ£€æµ‹PHPé˜Ÿåˆ—æ•°ï¼Œè¿”å›æ•´æ•°PHP.idle --æ£€æµ‹PHPç©ºé—²è¿›ç¨‹æ•°ï¼Œè¿”å›æ•´æ•°PHP.active --æ£€æµ‹PHPæ´»åŠ¨è¿›ç¨‹æ•°ï¼Œè¿”å›æ•´æ•°PHP.conn --æ£€æµ‹PHPè¯·æ±‚æ•°,è¿”å›æ•´æ•°PHP.reached --æ£€æµ‹PHPè¾¾åˆ°é™åˆ¶æ¬¡æ•°ï¼Œè¿”å›æ•´æ•°PHP.requets --æ£€æµ‹PHPæ…¢è¯·æ±‚ä¹¦ï¼Œè¿”å›æ•´æ•°</code></pre><h5 id="redisç›¸å…³çš„è‡ªå®šä¹‰é¡¹"><a href="#redisç›¸å…³çš„è‡ªå®šä¹‰é¡¹" class="headerlink" title="redisç›¸å…³çš„è‡ªå®šä¹‰é¡¹"></a>redisç›¸å…³çš„è‡ªå®šä¹‰é¡¹</h5><pre><code>vim /usr/local/zabbix/etc/zabbix_agentd.conf.d/redis.confUserParameter=Redis.Status,/usr/local/redis/bin/redis-cli -h 127.0.0.1 -p 6379 ping |grep -c PONGUserParameter=Redis_conn[*],/usr/local/redis/bin/redis-cli -h $1 -p $2 info | grep -w &quot;connected_clients&quot; | awk -F&#39;:&#39; &#39;{print $2}&#39;UserParameter=Redis_rss_mem[*],/usr/local/redis/bin/redis-cli -h $1 -p $2 info | grep -w &quot;used_memory_rss&quot; | awk -F&#39;:&#39; &#39;{print $2}&#39;UserParameter=Redis_lua_mem[*],/usr/local/redis/bin/redis-cli -h $1 -p $2 info | grep -w &quot;used_memory_lua&quot; | awk -F&#39;:&#39; &#39;{print $2}&#39;UserParameter=Redis_cpu_sys[*],/usr/local/redis/bin/redis-cli -h $1 -p $2 info | grep -w &quot;used_cpu_sys&quot; | awk -F&#39;:&#39; &#39;{print $2}&#39;UserParameter=Redis_cpu_user[*],/usr/local/redis/bin/redis-cli -h $1 -p $2 info | grep -w &quot;used_cpu_user&quot; | awk -F&#39;:&#39; &#39;{print $2}&#39;UserParameter=Redis_cpu_sys_cline[*],/usr/local/redis/bin/redis-cli -h $1 -p $2 info | grep -w &quot;used_cpu_sys_children&quot; | awk -F&#39;:&#39; &#39;{print $2}&#39;UserParameter=Redis_cpu_user_cline[*],/usr/local/redis/bin/redis-cli -h $1 -p $2 info | grep -w &quot;used_cpu_user_children&quot; | awk -F&#39;:&#39; &#39;{print $2}&#39;UserParameter=Redis_keys_num[*],/usr/local/redis/bin/redis-cli -h $1 -p $2 info | grep -w &quot;$$1&quot; | grep -w &quot;keys&quot; | grep db$3 | awk -F&#39;=&#39; &#39;{print $2}&#39; | awk -F&#39;,&#39; &#39;{print $1}&#39;UserParameter=Redis_loading[*],/usr/local/redis/bin/redis-cli -h $1 -p $2 info | grep loading | awk -F&#39;:&#39; &#39;{print $$2}&#39;Redis.Status --æ£€æµ‹Redisè¿è¡ŒçŠ¶æ€ï¼Œ è¿”å›æ•´æ•°Redis_conn  --æ£€æµ‹RedisæˆåŠŸè¿æ¥æ•°ï¼Œè¿”å›æ•´æ•°Redis_rss_mem  --æ£€æµ‹Redisç³»ç»Ÿåˆ†é…å†…å­˜ï¼Œè¿”å›æ•´æ•°Redis_lua_mem  --æ£€æµ‹Rediså¼•æ“æ¶ˆè€—å†…å­˜ï¼Œè¿”å›æ•´æ•°Redis_cpu_sys --æ£€æµ‹Redisä¸»ç¨‹åºæ ¸å¿ƒCPUæ¶ˆè€—ç‡ï¼Œè¿”å›æ•´æ•°Redis_cpu_user --æ£€æµ‹Redisä¸»ç¨‹åºç”¨æˆ·CPUæ¶ˆè€—ç‡ï¼Œè¿”å›æ•´æ•°Redis_cpu_sys_cline --æ£€æµ‹Redisåå°æ ¸å¿ƒCPUæ¶ˆè€—ç‡ï¼Œè¿”å›æ•´æ•°Redis_cpu_user_cline --æ£€æµ‹Redisåå°ç”¨æˆ·CPUæ¶ˆè€—ç‡ï¼Œè¿”å›æ•´æ•°Redis_keys_num --æ£€æµ‹åº“é”®å€¼æ•°ï¼Œè¿”å›æ•´æ•°Redis_loding --æ£€æµ‹RedisæŒä¹…åŒ–æ–‡ä»¶çŠ¶æ€ï¼Œè¿”å›æ•´æ•°</code></pre><h5 id="MySQL"><a href="#MySQL" class="headerlink" title="MySQL:"></a>MySQL:</h5><pre><code>version:æ•°æ®åº“ç‰ˆæœ¬key_buffer_size:myisamçš„ç´¢å¼•bufferå¤§å°sort_buffer_size:ä¼šè¯çš„æ’åºç©ºé—´ï¼ˆæ¯ä¸ªçº¿ç¨‹ä¼šç”³è¯·ä¸€ä¸ªï¼‰join_buffer_size:è¿™æ˜¯ä¸ºé“¾æ¥æ“ä½œåˆ†é…çš„æœ€å°ç¼“å­˜å¤§å°ï¼Œè¿™äº›è¿æ¥ä½¿ç”¨æ™®é€šç´¢å¼•æ‰«æã€èŒƒå›´æ‰«æã€æˆ–è€…è¿æ¥ä¸é€‚ç”¨ç´¢å¼•max_connections:æœ€å¤§å…è®¸åŒæ—¶è¿æ¥çš„æ•°é‡max_connect_errorsï¼šå…è®¸ä¸€ä¸ªä¸»æœºæœ€å¤šçš„é”™è¯¯é“¾æ¥æ¬¡æ•°ï¼Œå¦‚æœè¶…è¿‡äº†å°±ä¼šæ‹’ç»ä¹‹åé“¾æ¥ï¼ˆé»˜è®¤100ï¼‰ã€‚å¯ä»¥ä½¿ç”¨flush hostså‘½ä»¤å»è§£é™¤æ‹’ç»open_files_limits:æ“ä½œç³»ç»Ÿå…è®¸mysqlæ‰“å¼€çš„æ–‡ä»¶æ•°é‡ï¼Œå¯ä»¥é€šè¿‡opened_tablesçŠ¶æ€ç¡®å®šæ˜¯å¦éœ€è¦å¢å¤§table_open_cache,å¦‚æœopened_tablesæ¯”è¾ƒå¤§ä¸”ä¸€ç›´è¿˜åœ¨å¢å¤§è¯´æ˜éœ€è¦å¢å¤§table_open_cachemax-heap_tables_size:å»ºç«‹çš„å†…å­˜è¡¨çš„æœ€å¤§å¤§å°ï¼ˆé»˜è®¤16Mï¼‰è¿™ä¸ªå‚æ•°å’Œtmp_table_sizeä¸€èµ·é™åˆ¶å†…éƒ¨ä¸´æ—¶è¡¨çš„æœ€å¤§å€¼(å–è¿™ä¸¤ä¸ªå‚æ•°çš„å°çš„ä¸€ä¸ªï¼‰ï¼Œå¦‚æœè¶…è¿‡é™åˆ¶ï¼Œåˆ™è¡¨ä¼šå˜ä¸ºinnodbæˆ–myisamå¼•æ“ï¼Œï¼ˆ5.7.5ä¹‹å‰æ˜¯é»˜è®¤æ˜¯myisamï¼Œ5.7.6å¼€å§‹æ˜¯innodbï¼Œå¯ä»¥é€šè¿‡internal_tmp_disk_storage_engineå‚æ•°è°ƒæ•´ï¼‰ã€‚max_allowed_packet:ä¸€ä¸ªåŒ…çš„æœ€å¤§å¤§å°##########GET INNODB INFO#INNODB variablesinnodb_version:innodb_buffer_pool_instancesï¼šå°†innodbç¼“å†²æ± åˆ†ä¸ºæŒ‡å®šçš„å¤šä¸ªï¼ˆé»˜è®¤ä¸º1ï¼‰innodb_buffer_pool_size:innodbç¼“å†²æ± å¤§å°ã€5.7.5å¼•å…¥äº†innodb_buffer_pool_chunk_size,innodb_doublewriteï¼šæ˜¯å¦å¼€å¯doublewriteï¼ˆé»˜è®¤å¼€å¯ï¼‰innodb_read_io_threads:IOè¯»çº¿ç¨‹çš„æ•°é‡innodb_write_io_threads:IOå†™çº¿ç¨‹çš„æ•°é‡########innodb statusinnodb_buffer_pool_pages_total:innodbç¼“å†²æ± é¡µçš„æ•°é‡ã€å¤§å°ç­‰äºinnodb_buffer_pool_size/(16*1024)innodb_buffer_pool_pages_data:innodbç¼“å†²æ± ä¸­åŒ…å«æ•°æ®çš„é¡µçš„æ•°é‡########## GET MYSQL HITRATE1ã€æŸ¥è¯¢ç¼“å­˜å‘½ä¸­ç‡å¦‚æœQcache_hits+Com_select&lt;&gt;0åˆ™ä¸º Qcache_hits/ï¼ˆQcache_hits+Com_selectï¼‰ï¼Œå¦åˆ™ä¸º02ã€çº¿ç¨‹ç¼“å­˜å‘½ä¸­ç‡å¦‚æœConnections&lt;&gt;0,åˆ™ä¸º1-Threads_created/Connectionsï¼Œå¦åˆ™ä¸º03ã€myisamé”®ç¼“å­˜å‘½ä¸­ç‡å¦‚æœKey_read_requests&lt;&gt;0,åˆ™ä¸º1-Key_reads/Key_read_requestsï¼Œå¦åˆ™ä¸º04ã€myisamé”®ç¼“å­˜å†™å‘½ä¸­ç‡å¦‚æœKey_write_requests&lt;&gt;0,åˆ™ä¸º1-Key_writes/Key_write_requestsï¼Œå¦åˆ™ä¸º05ã€é”®å—ä½¿ç”¨ç‡å¦‚æœKey_blocks_used+Key_blocks_unused&lt;&gt;0ï¼Œåˆ™Key_blocks_used/ï¼ˆKey_blocks_used+Key_blocks_unusedï¼‰ï¼Œå¦åˆ™ä¸º06ã€åˆ›å»ºç£ç›˜å­˜å‚¨çš„ä¸´æ—¶è¡¨æ¯”ç‡å¦‚æœCreated_tmp_disk_tables+Created_tmp_tables&lt;&gt;0,åˆ™Created_tmp_disk_tables/ï¼ˆCreated_tmp_disk_tables+Created_tmp_tablesï¼‰ï¼Œå¦åˆ™ä¸º07ã€è¿æ¥ä½¿ç”¨ç‡å¦‚æœmax_connections&lt;&gt;0ï¼Œåˆ™threads_connected/max_connectionsï¼Œå¦åˆ™ä¸º08ã€æ‰“å¼€æ–‡ä»¶æ¯”ç‡å¦‚æœopen_files_limit&lt;&gt;0ï¼Œåˆ™open_files/open_files_limitï¼Œå¦åˆ™ä¸º09ã€è¡¨ç¼“å­˜ä½¿ç”¨ç‡å¦‚æœtable_open_cache&lt;&gt;0ï¼Œåˆ™open_tables/table_open_cacheï¼Œå¦åˆ™ä¸º0</code></pre>]]></content>
      
      
      <categories>
          
          <category> ç›‘æ§ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> zabbix </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Go_å­¦ä¹ ä¹‹Dockeå®¹å™¨</title>
      <link href="2019/12/05/devops/golang/go-study/"/>
      <url>2019/12/05/devops/golang/go-study/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h3 id="mysqlå®¹å™¨"><a href="#mysqlå®¹å™¨" class="headerlink" title="mysqlå®¹å™¨"></a>mysqlå®¹å™¨</h3><pre><code>[mysqld]log-error=/mylog/error.logslow_query_log = onlong_query_time=2slow-query-log-file =/mylog/slow.logdocker run -it --rm --entrypoint=&quot;/bin/bash&quot; mysql:5.7 -c &quot;cat /etc/group &quot;å› ä¸ºå®¹å™¨é»˜è®¤ä½¿ç”¨çš„æ˜¯mysqlç”¨æˆ·ã€‚ å› æ­¤æˆ‘ä»¬éœ€è¦æŠŠæ˜ å°„çš„æ–‡ä»¶å¤¹ä¿®æ”¹ownerdocker run --name mysql -d   \-p 3306:3306  \-v /home/cyy/mysql/data:/data \-v  /home/cyy/mysql/conf/my.cnf:/etc/mysql/my.cnf  \-v /usr/share/zoneinfo/Asia/Shanghai:/etc/localtime \-v  /home/cyy/mysql/mylog:/mylog  \-e MYSQL_ROOT_PASSWORD=123456   \mysql:5.7</code></pre><h3 id="alpineå®¹å™¨"><a href="#alpineå®¹å™¨" class="headerlink" title="alpineå®¹å™¨"></a>alpineå®¹å™¨</h3><pre class=" language-shell"><code class="language-shell">docker pull alpine docker run --name goserver  -d \-v /home/cyy/web:/server  \-v /usr/share/zoneinfo/Asia/Shanghai:/etc/localtime \-w /server \alpine ./gin</code></pre><h3 id="nginxå®¹å™¨"><a href="#nginxå®¹å™¨" class="headerlink" title="nginxå®¹å™¨"></a>nginxå®¹å™¨</h3><pre class=" language-shell"><code class="language-shell">docker pull  nginx:alpine </code></pre><pre class=" language-nginx"><code class="language-nginx"><span class="token keyword">user</span>  nginx<span class="token punctuation">;</span><span class="token keyword">worker_processes</span>  auto<span class="token punctuation">;</span><span class="token keyword">error_log</span>  <span class="token operator">/</span>var<span class="token operator">/</span>log<span class="token operator">/</span>nginx<span class="token operator">/</span>error<span class="token punctuation">.</span>log warn<span class="token punctuation">;</span><span class="token keyword">pid</span>        <span class="token operator">/</span>var<span class="token operator">/</span>run<span class="token operator">/</span>nginx<span class="token punctuation">.</span><span class="token keyword">pid</span><span class="token punctuation">;</span><span class="token keyword">events</span> <span class="token punctuation">{</span>    <span class="token keyword">worker_connections</span>  <span class="token number">1024</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">http</span> <span class="token punctuation">{</span>    <span class="token keyword">include</span>       <span class="token operator">/</span>etc<span class="token operator">/</span>nginx<span class="token operator">/</span>mime<span class="token punctuation">.</span><span class="token keyword">types</span><span class="token punctuation">;</span>    <span class="token keyword">default_type</span>  application<span class="token operator">/</span>octet<span class="token operator">-</span>stream<span class="token punctuation">;</span>     <span class="token keyword">keepalive_timeout</span>  <span class="token number">65</span><span class="token punctuation">;</span><span class="token keyword">upstream</span> gin  <span class="token punctuation">{</span>    <span class="token keyword">server</span> <span class="token number">172.17</span><span class="token punctuation">.</span><span class="token number">0.4</span><span class="token punctuation">:</span><span class="token number">8080</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span> <span class="token keyword">server</span><span class="token punctuation">{</span>    <span class="token keyword">listen</span> <span class="token number">80</span><span class="token punctuation">;</span>    <span class="token keyword">location</span> <span class="token operator">/</span> <span class="token punctuation">{</span>        <span class="token keyword">proxy_pass</span>  <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>gin<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">#Proxy Settings</span>        <span class="token keyword">proxy_redirect</span>     off<span class="token punctuation">;</span>        <span class="token keyword">proxy_set_header</span>   Host             <span class="token variable">$host</span><span class="token punctuation">;</span>        <span class="token keyword">proxy_set_header</span>   X<span class="token operator">-</span>Real<span class="token operator">-</span>IP        <span class="token variable">$remote_addr</span><span class="token punctuation">;</span>        <span class="token keyword">proxy_set_header</span>   X<span class="token operator">-</span>Forwarded<span class="token operator">-</span>For  <span class="token variable">$proxy_add_x_forwarded_for</span><span class="token punctuation">;</span>   <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><pre class=" language-shell"><code class="language-shell">docker run -d --name ngx  \-v /home/cyy/ngx/nginx.conf:/etc/nginx/nginx.conf \-v /usr/share/zoneinfo/Asia/Shanghai:/etc/localtime \-p 80:80  \nginx:alpine</code></pre><h4 id="Redis-å®¹å™¨"><a href="#Redis-å®¹å™¨" class="headerlink" title="Redis å®¹å™¨"></a>Redis å®¹å™¨</h4><pre class=" language-shell"><code class="language-shell">docker run --name redis-d -v /usr/share/zoneinfo/Asia/Shanghai:/etc/localtime -p 6379:6379 redis:5-alpine redis-servver</code></pre>]]></content>
      
      
      <categories>
          
          <category> å®¹å™¨ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Oracleè®¾ç½®å¼€æœºè‡ªå¯</title>
      <link href="2019/11/27/sql/oracle-she-zhi-kai-ji-zi-qi/"/>
      <url>2019/11/27/sql/oracle-she-zhi-kai-ji-zi-qi/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><p><strong>æ­¥éª¤ï¼š</strong></p><h5 id="1ï¼šæŸ¥çœ‹ORACLE-HOMEæ˜¯å¦è®¾ç½®"><a href="#1ï¼šæŸ¥çœ‹ORACLE-HOMEæ˜¯å¦è®¾ç½®" class="headerlink" title="1ï¼šæŸ¥çœ‹ORACLE_HOMEæ˜¯å¦è®¾ç½®"></a><strong>1ï¼šæŸ¥çœ‹ORACLE_HOMEæ˜¯å¦è®¾ç½®</strong></h5><pre><code>$ echo $ORACLE_HOME/u01/app/oracle/product/11.2.0/db_1</code></pre><h5 id="2ï¼šæ‰§è¡Œdbstart-æ•°æ®åº“è‡ªå¸¦å¯åŠ¨è„šæœ¬"><a href="#2ï¼šæ‰§è¡Œdbstart-æ•°æ®åº“è‡ªå¸¦å¯åŠ¨è„šæœ¬" class="headerlink" title="2ï¼šæ‰§è¡Œdbstart æ•°æ®åº“è‡ªå¸¦å¯åŠ¨è„šæœ¬"></a><strong>2ï¼šæ‰§è¡Œdbstart æ•°æ®åº“è‡ªå¸¦å¯åŠ¨è„šæœ¬</strong></h5><pre><code>[oracle@njdzjkdb ~]$ cd $ORACLE_HOME[oracle@njdzjkdb dbhome_1]$ cd bin/[oracle@njdzjkdb bin]$ dbstartORACLE_HOME_LISTNER is not SET, unable to auto-start Oracle Net Listener Usage: /u01/app/oracle/product/11.2.0/db_1/bin/dbstart ORACLE_HOMEé”™è¯¯æç¤ºï¼šORACLE_HOME_LISTNER æ²¡æœ‰è®¾ç½®[oracle@njdzjkdb bin]$ ll | grep dbs-rwxr-x---. 1 oracle oinstall 6088 1æœˆ 1 2000 dbshut-rwxr-x---. 1 oracle oinstall 13892 12æœˆ 11 16:01 dbstartç¼–è¾‘ dbstartï¼Œå°†ORACLE_HOME_LISTNER=$1ä¿®æ”¹æˆ ORACLE_HOME_LISTNER=$ORACLE_HOME å‰ææ˜¯$ORACLE_HOMEç¯å¢ƒè®¾ç½®æ­£ç¡®[oracle@njdzjkdb bin]$ vi dbstart ORACLE_HOME_LISTNER=/u01/app/oracle/product/11.2.0/db_1</code></pre><h5 id="3ï¼šç¼–è¾‘-etc-oratabæ–‡ä»¶"><a href="#3ï¼šç¼–è¾‘-etc-oratabæ–‡ä»¶" class="headerlink" title="3ï¼šç¼–è¾‘/etc/oratabæ–‡ä»¶"></a><strong>3ï¼šç¼–è¾‘/etc/oratabæ–‡ä»¶</strong></h5><pre><code>dbcaå»ºåº“æ—¶éƒ½ä¼šè‡ªåŠ¨åˆ›å»º/etc/oratabæ–‡ä»¶å°†oracle:/u01/app/oracle/product/11.2.0/db_1:Nä¿®æ”¹æˆ oracle:/u01/app/oracle/product/11.2.0/db_1:Y</code></pre><h5 id="4ï¼šç¼–è¾‘-etc-rc-d-rc-localå¯åŠ¨æ–‡ä»¶ï¼Œæ·»åŠ æ•°æ®åº“å¯åŠ¨è„šæœ¬dbstart"><a href="#4ï¼šç¼–è¾‘-etc-rc-d-rc-localå¯åŠ¨æ–‡ä»¶ï¼Œæ·»åŠ æ•°æ®åº“å¯åŠ¨è„šæœ¬dbstart" class="headerlink" title="4ï¼šç¼–è¾‘/etc/rc.d/rc.localå¯åŠ¨æ–‡ä»¶ï¼Œæ·»åŠ æ•°æ®åº“å¯åŠ¨è„šæœ¬dbstart"></a><strong>4ï¼šç¼–è¾‘/etc/rc.d/rc.localå¯åŠ¨æ–‡ä»¶ï¼Œæ·»åŠ æ•°æ®åº“å¯åŠ¨è„šæœ¬dbstart</strong></h5><pre><code>[root@njdzjkdb ~]# vi /etc/rc.d/rc.local#!/bin/bash# THIS FILE IS ADDED FOR COMPATIBILITY PURPOSES## It is highly advisable to create own systemd services or udev rules# to run scripts during boot instead of using this file.## In contrast to previous versions due to parallel execution during boot# this script will NOT be run after all other services.## Please note that you must run &#39;chmod +x /etc/rc.d/rc.local&#39; to ensure# that this script will be executed during boot.touch /var/lock/subsys/localsu oracle -lc &quot;/u01/app/oracle/product/11.2.0/db_1/bin/lsnrctl start&quot;su oracle -lc /u01/app/oracle/product/11.2.0/db_1/bin/dbstart</code></pre><h5 id="5ï¼šé‡å¯ä¸»æœºï¼ŒæŸ¥çœ‹æ•°æ®åº“å’Œç›‘å¬æ˜¯è‡ªå¯åŠ¨"><a href="#5ï¼šé‡å¯ä¸»æœºï¼ŒæŸ¥çœ‹æ•°æ®åº“å’Œç›‘å¬æ˜¯è‡ªå¯åŠ¨" class="headerlink" title="5ï¼šé‡å¯ä¸»æœºï¼ŒæŸ¥çœ‹æ•°æ®åº“å’Œç›‘å¬æ˜¯è‡ªå¯åŠ¨"></a><strong>5ï¼šé‡å¯ä¸»æœºï¼ŒæŸ¥çœ‹æ•°æ®åº“å’Œç›‘å¬æ˜¯è‡ªå¯åŠ¨</strong></h5><pre><code>netstat -tunlp | grep 1521</code></pre><h5 id="6ï¼šæŸ¥çœ‹æ•°æ®åº“æ˜¯å¦å¤„äºopençŠ¶æ€"><a href="#6ï¼šæŸ¥çœ‹æ•°æ®åº“æ˜¯å¦å¤„äºopençŠ¶æ€" class="headerlink" title="6ï¼šæŸ¥çœ‹æ•°æ®åº“æ˜¯å¦å¤„äºopençŠ¶æ€"></a><strong>6ï¼šæŸ¥çœ‹æ•°æ®åº“æ˜¯å¦å¤„äºopençŠ¶æ€</strong></h5><pre><code>select status from v$instance</code></pre>]]></content>
      
      
      <categories>
          
          <category> SQL </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Oracle </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CentOS7é™é»˜å®‰è£…oracle11g</title>
      <link href="2019/11/27/sql/centos7-jing-mo-an-zhuang-oracle11g/"/>
      <url>2019/11/27/sql/centos7-jing-mo-an-zhuang-oracle11g/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h5 id="æ“ä½œç³»ç»Ÿï¼š"><a href="#æ“ä½œç³»ç»Ÿï¼š" class="headerlink" title="æ“ä½œç³»ç»Ÿï¼š"></a><strong>æ“ä½œç³»ç»Ÿï¼š</strong></h5><pre><code>[root@cyylog ~]# uname -mx86_64[root@cyylog ~]# cat /etc/redhat-release CentOS Linux release 7.2.1511 (Core) </code></pre><h1 id="å®‰è£…å‰çš„å‡†å¤‡ï¼š"><a href="#å®‰è£…å‰çš„å‡†å¤‡ï¼š" class="headerlink" title="å®‰è£…å‰çš„å‡†å¤‡ï¼š"></a><strong>å®‰è£…å‰çš„å‡†å¤‡ï¼š</strong></h1><h5 id="1-ä¿®æ”¹ä¸»æœºå"><a href="#1-ä¿®æ”¹ä¸»æœºå" class="headerlink" title="1. ä¿®æ”¹ä¸»æœºå"></a><strong>1. ä¿®æ”¹ä¸»æœºå</strong></h5><pre><code>#sed -i &quot;s/HOSTNAME=localhost.localdomain/HOSTNAME=oracledb/&quot; /etc/sysconfig/network</code></pre><h5 id="2-æ·»åŠ ä¸»æœºåä¸IPå¯¹åº”è®°å½•"><a href="#2-æ·»åŠ ä¸»æœºåä¸IPå¯¹åº”è®°å½•" class="headerlink" title="2.æ·»åŠ ä¸»æœºåä¸IPå¯¹åº”è®°å½•"></a><strong>2.æ·»åŠ ä¸»æœºåä¸IPå¯¹åº”è®°å½•</strong></h5><pre><code># vim /etc/hosts 192.168.0.9 oracledb</code></pre><h5 id="3-å…³é—­Selinux"><a href="#3-å…³é—­Selinux" class="headerlink" title="3.å…³é—­Selinux"></a><strong>3.å…³é—­Selinux</strong></h5><pre><code># sed -i &quot;s/SELINUX=enforcing/SELINUX=disabled/&quot; /etc/selinux/config # setenforce 0 </code></pre><h5 id="4-æ£€æŸ¥æ˜¯å¦æœ‰swapåˆ†åŒº"><a href="#4-æ£€æŸ¥æ˜¯å¦æœ‰swapåˆ†åŒº" class="headerlink" title="4.æ£€æŸ¥æ˜¯å¦æœ‰swapåˆ†åŒº."></a><strong>4.æ£€æŸ¥æ˜¯å¦æœ‰swapåˆ†åŒº.</strong></h5><p>(æˆ‘çš„æœºå™¨æ˜¯æ²¡æœ‰è¿™ä¸ª,æ‰€æœ‰åé¢æœ‰æŠ¥é”™) Linuxä¸€åˆ‡çš†æ–‡ä»¶,æ²¡æœ‰å°±è‡ªå·±é€ ä¸€ä¸ª</p><pre><code>1ã€æ£€æŸ¥ Swap ç©ºé—´åœ¨è®¾ç½® Swap æ–‡ä»¶ä¹‹å‰ï¼Œæœ‰å¿…è¦å…ˆæ£€æŸ¥ä¸€ä¸‹ç³»ç»Ÿé‡Œæœ‰æ²¡æœ‰æ—¢å­˜çš„ Swap æ–‡ä»¶ã€‚è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š# swapon -så¦‚æœè¿”å›çš„ä¿¡æ¯æ¦‚è¦æ˜¯ç©ºçš„ï¼Œåˆ™è¡¨ç¤º Swap æ–‡ä»¶ä¸å­˜åœ¨ã€‚2ã€æ£€æŸ¥æ–‡ä»¶ç³»ç»Ÿåœ¨è®¾ç½® Swap æ–‡ä»¶ä¹‹å‰ï¼ŒåŒæ ·æœ‰å¿…è¦æ£€æŸ¥ä¸€ä¸‹æ–‡ä»¶ç³»ç»Ÿï¼Œçœ‹çœ‹æ˜¯å¦æœ‰è¶³å¤Ÿçš„ç¡¬ç›˜ç©ºé—´æ¥è®¾ç½® Swap ã€‚è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š# df -hal3ã€åˆ›å»ºå¹¶å…è®¸ Swap æ–‡ä»¶ä¸‹é¢ä½¿ç”¨ dd å‘½ä»¤æ¥åˆ›å»º Swap æ–‡ä»¶ã€‚æ£€æŸ¥è¿”å›çš„ä¿¡æ¯ï¼Œè¿˜å‰©ä½™è¶³å¤Ÿçš„ç¡¬ç›˜ç©ºé—´å³å¯ã€‚# dd if=/dev/zero of=/swapfile bs=1024 count=512kå‚æ•°è§£è¯»ï¼šif=æ–‡ä»¶åï¼šè¾“å…¥æ–‡ä»¶åï¼Œç¼ºçœä¸ºæ ‡å‡†è¾“å…¥ã€‚å³æŒ‡å®šæºæ–‡ä»¶ã€‚&lt; if=input file &gt;of=æ–‡ä»¶åï¼šè¾“å‡ºæ–‡ä»¶åï¼Œç¼ºçœä¸ºæ ‡å‡†è¾“å‡ºã€‚å³æŒ‡å®šç›®çš„æ–‡ä»¶ã€‚&lt; of=output file &gt;bs=bytesï¼šåŒæ—¶è®¾ç½®è¯»å…¥/è¾“å‡ºçš„å—å¤§å°ä¸ºbytesä¸ªå­—èŠ‚count=blocksï¼šä»…æ‹·è´blocksä¸ªå—ï¼Œå—å¤§å°ç­‰äºbsæŒ‡å®šçš„å­—èŠ‚æ•°ã€‚4ã€æ ¼å¼åŒ–å¹¶æ¿€æ´» Swap æ–‡ä»¶ä¸Šé¢å·²ç»åˆ›å»ºå¥½ Swap æ–‡ä»¶ï¼Œè¿˜éœ€è¦æ ¼å¼åŒ–åæ‰èƒ½ä½¿ç”¨ã€‚è¿è¡Œå‘½ä»¤ï¼š# mkswap /swapfileæ¿€æ´» Swap ï¼Œè¿è¡Œå‘½ä»¤ï¼š# swapon /swapfileä»¥ä¸Šæ­¥éª¤åšå®Œï¼Œå†æ¬¡è¿è¡Œå‘½ä»¤ï¼š# swapon -sä½ ä¼šå‘ç°è¿”å›çš„ä¿¡æ¯æ¦‚è¦ï¼š1 Filename Type Size Used Priority2 /swapfile file 524284 0 -1å¦‚æœè¦æœºå™¨é‡å¯çš„æ—¶å€™è‡ªåŠ¨æŒ‚è½½ Swap ï¼Œé‚£ä¹ˆè¿˜éœ€è¦ä¿®æ”¹ fstab é…ç½®ã€‚ç”¨ vim æ‰“å¼€ /etc/fstab æ–‡ä»¶ï¼Œåœ¨å…¶æœ€åæ·»åŠ å¦‚ä¸‹ä¸€è¡Œï¼š/swapfile swap swap defaults 0 0æœ€åï¼Œèµ‹äºˆ Swap æ–‡ä»¶é€‚å½“çš„æƒé™ï¼š# chown root:root /swapfile # chmod 0600 /swapfile</code></pre><h5 id="5-å®‰è£…å¸¸ç”¨å·¥å…·-é…ç½®é˜¿é‡Œæº"><a href="#5-å®‰è£…å¸¸ç”¨å·¥å…·-é…ç½®é˜¿é‡Œæº" class="headerlink" title="5.å®‰è£…å¸¸ç”¨å·¥å…·,é…ç½®é˜¿é‡Œæº"></a><strong>5.å®‰è£…å¸¸ç”¨å·¥å…·,é…ç½®é˜¿é‡Œæº</strong></h5><p>(ä¸ªäººä¹ æƒ¯,åœ¨ä½¿ç”¨çš„ä¸»æœºä¸Šé¢é…ç½®è¿™äº›å¸¸ç”¨å·¥å…·)</p><pre><code># curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo# curl -o /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo# yum clean all# yum makecache fast# yum install -y wget ntpdate net-tools vim bash-completion ShellCheck# ntpdate -b ntp1.aliyun.com</code></pre><h4 id="å®‰è£…è½¯ä»¶åŒ…"><a href="#å®‰è£…è½¯ä»¶åŒ…" class="headerlink" title="å®‰è£…è½¯ä»¶åŒ…"></a>å®‰è£…è½¯ä»¶åŒ…</h4><p>å‚è€ƒå®˜æ–¹ï¼š<a href="http://docs.oracle.com/cd/E11882_01/install.112/e24326/toc.htm#BHCCADGD" target="_blank" rel="noopener">http://docs.oracle.com/cd/E11882_01/install.112/e24326/toc.htm#BHCCADGD</a></p><ul><li>The following or later version of packages for Oracle Linux 7, and Red Hat Enterprise Linux 7 must be installed:</li></ul><pre><code>binutils-2.23.52.0.1-12.el7.x86_64 compat-libcap1-1.10-3.el7.x86_64 compat-libstdc++-33-3.2.3-71.el7.i686compat-libstdc++-33-3.2.3-71.el7.x86_64gcc-4.8.2-3.el7.x86_64 gcc-c++-4.8.2-3.el7.x86_64 glibc-2.17-36.el7.i686 glibc-2.17-36.el7.x86_64 glibc-devel-2.17-36.el7.i686 glibc-devel-2.17-36.el7.x86_64 kshlibaio-0.3.109-9.el7.i686 libaio-0.3.109-9.el7.x86_64 libaio-devel-0.3.109-9.el7.i686 libaio-devel-0.3.109-9.el7.x86_64 libgcc-4.8.2-3.el7.i686 libgcc-4.8.2-3.el7.x86_64 libstdc++-4.8.2-3.el7.i686 libstdc++-4.8.2-3.el7.x86_64 libstdc++-devel-4.8.2-3.el7.i686 libstdc++-devel-4.8.2-3.el7.x86_64 libXi-1.7.2-1.el7.i686 libXi-1.7.2-1.el7.x86_64 libXtst-1.2.2-1.el7.i686 libXtst-1.2.2-1.el7.x86_64 make-3.82-19.el7.x86_64 sysstat-10.1.5-1.el7.x86_64unixODBC-2.3.1-6.el7.x86_64 or laterunixODBC-2.3.1-6.el7.i686 or laterunixODBC-devel-2.3.1-6.el7.x86_64 or laterunixODBC-devel-2.3.1-6.el7.i686 or later</code></pre><pre><code>binutils-2.23.52.0.1-12.el7.x86_64 compat-libcap1-1.10-3.el7.x86_64 compat-libstdc++-33-3.2.3-71.el7.i686compat-libstdc++-33-3.2.3-71.el7.x86_64gcc-4.8.2-3.el7.x86_64 gcc-c++-4.8.2-3.el7.x86_64 glibc-2.17-36.el7.i686 glibc-2.17-36.el7.x86_64 glibc-devel-2.17-36.el7.i686 glibc-devel-2.17-36.el7.x86_64 kshlibaio-0.3.109-9.el7.i686 libaio-0.3.109-9.el7.x86_64 libaio-devel-0.3.109-9.el7.i686 libaio-devel-0.3.109-9.el7.x86_64 libgcc-4.8.2-3.el7.i686 libgcc-4.8.2-3.el7.x86_64 libstdc++-4.8.2-3.el7.i686 libstdc++-4.8.2-3.el7.x86_64 libstdc++-devel-4.8.2-3.el7.i686 libstdc++-devel-4.8.2-3.el7.x86_64 libXi-1.7.2-1.el7.i686 libXi-1.7.2-1.el7.x86_64 libXtst-1.2.2-1.el7.i686 libXtst-1.2.2-1.el7.x86_64 make-3.82-19.el7.x86_64 sysstat-10.1.5-1.el7.x86_64unixODBC-2.3.1-6.el7.x86_64 or laterunixODBC-2.3.1-6.el7.i686 or laterunixODBC-devel-2.3.1-6.el7.x86_64 or laterunixODBC-devel-2.3.1-6.el7.i686 or later</code></pre><h5 id="ç”¨yumè¿›è¡Œå®‰è£…"><a href="#ç”¨yumè¿›è¡Œå®‰è£…" class="headerlink" title="ç”¨yumè¿›è¡Œå®‰è£…"></a><strong>ç”¨yumè¿›è¡Œå®‰è£…</strong></h5><pre><code>yum -y install binutils compat-libcap1 compat-libstdc++-33 compat-libstdc++-33*i686 compat-libstdc++-33*.devel compat-libstdc++-33 compat-libstdc++-33*.devel gcc gcc-c++ glibc glibc*.i686 glibc-devel glibc-devel*.i686 ksh libaio libaio*.i686 libaio-devel libaio-devel*.devel libgcc libgcc*.i686 libstdc++ libstdc++*.i686 libstdc++-devel libstdc++-devel*.devel libXi libXi*.i686 libXtst libXtst*.i686 make sysstat unixODBC unixODBC*.i686 unixODBC-devel unixODBC-devel*.i686</code></pre><h5 id="æ£€æµ‹æ˜¯å¦31ä¸ªåŒ…éƒ½æœ‰å®‰è£…"><a href="#æ£€æµ‹æ˜¯å¦31ä¸ªåŒ…éƒ½æœ‰å®‰è£…" class="headerlink" title="æ£€æµ‹æ˜¯å¦31ä¸ªåŒ…éƒ½æœ‰å®‰è£…"></a><strong>æ£€æµ‹æ˜¯å¦31ä¸ªåŒ…éƒ½æœ‰å®‰è£…</strong></h5><p>å¼€æ”¾æºç ç»¿è‰²è“è‰²æŒ‰é’®æ ·å¼</p><pre><code>[root@cyylog ~]# rpm -q binutils compat-libcap1 compat-libstdc++-33 gcc gcc-c++ glibc glibc-devel ksh libaio libaio-devel libgcc libstdc++ libstdc++-devel libXi libXtst make sysstat unixODBC unixODBC-develbinutils-2.23.52.0.1-55.el7.x86_64compat-libcap1-1.10-7.el7.x86_64compat-libstdc++-33-3.2.3-72.el7.x86_64compat-libstdc++-33-3.2.3-72.el7.i686gcc-4.8.5-4.el7.x86_64gcc-c++-4.8.5-4.el7.x86_64glibc-2.17-106.el7_2.8.x86_64glibc-2.17-106.el7_2.8.i686glibc-devel-2.17-106.el7_2.8.x86_64glibc-devel-2.17-106.el7_2.8.i686ksh-20120801-22.el7_1.3.x86_64libaio-0.3.109-13.el7.x86_64libaio-0.3.109-13.el7.i686libaio-devel-0.3.109-13.el7.x86_64libaio-devel-0.3.109-13.el7.i686libgcc-4.8.5-4.el7.x86_64libgcc-4.8.5-4.el7.i686libstdc++-4.8.5-4.el7.x86_64libstdc++-4.8.5-4.el7.i686libstdc++-devel-4.8.5-4.el7.x86_64libstdc++-devel-4.8.5-4.el7.i686libXi-1.7.2-2.1.el7.x86_64libXi-1.7.4-2.el7.i686libXtst-1.2.2-2.1.el7.x86_64libXtst-1.2.2-2.1.el7.i686make-3.82-21.el7.x86_64sysstat-10.1.5-7.el7.x86_64unixODBC-2.3.1-11.el7.x86_64unixODBC-2.3.1-11.el7.i686unixODBC-devel-2.3.1-11.el7.x86_64unixODBC-devel-2.3.1-11.el7.i686</code></pre><p>ç‰ˆæœ¬å·åªèƒ½å¤§äºè§„å®šçš„ç‰ˆæœ¬ï¼Œä¸èƒ½å°äºã€‚</p><p>åˆ›å»ºoinstallå’Œdbaç»„</p><pre><code># groupadd oinstall# groupadd dba</code></pre><p>åˆ›å»ºoracleç”¨æˆ·</p><pre><code># useradd -g oinstall -G dba oracle</code></pre><p>è®¾ç½®oracleç”¨æˆ·å¯†ç </p><pre><code># passwd oracle</code></pre><p>éªŒè¯åˆ›å»ºæ˜¯å¦æ­£ç¡®</p><pre><code>[root@cyylog ~]# id oracleuid=1000(oracle) gid=1000(oinstall) groups=1000(oinstall),1001(dba)</code></pre><h5 id="é…ç½®å†…æ ¸å‚æ•°"><a href="#é…ç½®å†…æ ¸å‚æ•°" class="headerlink" title="é…ç½®å†…æ ¸å‚æ•°"></a>é…ç½®å†…æ ¸å‚æ•°</h5><pre><code>[root@cyylog ~]# vim /etc/sysctl.conf # System default settings live in /usr/lib/sysctl.d/00-system.conf.# To override those settings, enter new settings here, or in an /etc/sysctl.d/&lt;name&gt;.conf file## For more information, see sysctl.conf(5) and sysctl.d(5).fs.aio-max-nr = 1048576fs.file-max = 6815744kernel.shmall = 2097152kernel.shmmax = 536870912 #æœ€ä½ï¼š536870912ï¼Œæœ€å¤§å€¼ï¼šæ¯”ç‰©ç†å†…å­˜å°1ä¸ªå­—èŠ‚çš„å€¼ï¼Œå»ºè®®è¶…è¿‡ç‰©ç†å†…å­˜çš„ä¸€åŠkernel.shmmni = 4096kernel.sem = 250 32000 100 128net.ipv4.ip_local_port_range = 9000 65500net.core.rmem_default = 262144net.core.rmem_max = 4194304net.core.wmem_default = 262144net.core.wmem_max = 1048576</code></pre><p>å‚æ•°çš„å€¼ä¸èƒ½å°äºä¸Šé¢çš„é…ç½®ï¼Œè¿™æ˜¯oracleå®˜æ–¹å»ºè®®çš„æœ€å°å€¼ï¼Œç”Ÿäº§ç¯å¢ƒå»ºè®®è°ƒæ•´è¿™äº›å‚æ•°ï¼Œä»¥ä¼˜åŒ–ç³»ç»Ÿæ€§èƒ½ã€‚</p><p>ä¿®æ”¹åä½¿ä¹‹ç”Ÿæ•ˆ</p><pre><code># sysctl -p</code></pre><p>ä¿®æ”¹ç”¨æˆ·é™åˆ¶</p><pre><code>vim /etc/security/limits.conf#åœ¨æœ«å°¾æ·»åŠ oracle soft nproc 2047oracle hard nproc 16384oracle soft nofile 1024oracle hard nofile 65536oracle soft stack 10240oracle hard stack 10240</code></pre><p>åœ¨/etc/pam.d/login æ–‡ä»¶ä¸­ï¼Œä½¿ç”¨æ–‡æœ¬ç¼–è¾‘å™¨æˆ–viå‘½ä»¤å¢åŠ æˆ–ä¿®æ”¹ä»¥ä¸‹å†…å®¹</p><pre><code>session required /lib64/security/pam_limits.sosession required pam_limits.so</code></pre><p>åœ¨/etc/profile æ–‡ä»¶ä¸­ï¼Œä½¿ç”¨æ–‡æœ¬ç¼–è¾‘å™¨æˆ–viå‘½ä»¤å¢åŠ æˆ–ä¿®æ”¹ä»¥ä¸‹å†…å®¹</p><pre><code>if [ $USER = &quot;oracle&quot; ]; then if [ $SHELL = &quot;/bin/ksh&quot; ]; then ulimit -p 16384 ulimit -n 65536 else ulimit -u 16384 -n 65536 fifi</code></pre><p>ä½¿ä¹‹ç”Ÿæ•ˆ</p><pre><code># source /etc/profile</code></pre><p>åˆ›å»ºå®‰è£…ç›®å½•</p><pre><code># mkdir -p /u01/app/# chown -R oracle:oinstall /u01/app/# chmod -R 775 /u01/app/</code></pre><p>é…ç½®ç¯å¢ƒå˜é‡</p><pre><code>[oracle@cyylog ~]$ vim ~/.bash_profile export ORACLE_BASE=/u01/app/oracleexport ORACLE_SID=dbsrv2</code></pre><p>ä½¿ä¹‹ç”Ÿæ•ˆ</p><pre><code>source ~/.bash_profile</code></pre><p>è§£å‹oracleè½¯ä»¶</p><pre><code>[root@cyylog src]# unzip linux.x64_11gR2_database_1of2.zip[root@cyylog src]# unzip linux.x64_11gR2_database_2of2.zip</code></pre><p>å¤åˆ¶å“åº”æ–‡ä»¶æ¨¡æ¿</p><pre><code>[oracle@cyylog ~]$ mkdir etc[oracle@cyylog ~]$ cp /usr/local/src/database/response/* /home/oracle/etc/[oracle@cyylog ~]$ ls etcdbca.rsp db_install.rsp netca.rsp</code></pre><p>è®¾ç½®å“åº”æ–‡ä»¶æƒé™</p><pre><code>[oracle@cyylog ~]$ su - root[root@cyylog ~]# chmod 700 /home/oracle/etc/*.rsp</code></pre><h1 id="é™é»˜å®‰è£…Oracleè½¯ä»¶"><a href="#é™é»˜å®‰è£…Oracleè½¯ä»¶" class="headerlink" title="é™é»˜å®‰è£…Oracleè½¯ä»¶"></a><strong>é™é»˜å®‰è£…Oracleè½¯ä»¶</strong></h1><p>su - oracle</p><p>ä¿®æ”¹å®‰è£…Oracleè½¯ä»¶çš„å“åº”æ–‡ä»¶/home/oracle/etc/db_install.rsp</p><pre><code>oracle.install.option=INSTALL_DB_SWONLY // å®‰è£…ç±»å‹ORACLE_HOSTNAME=oracledb // ä¸»æœºåç§°ï¼ˆhostnameæŸ¥è¯¢ï¼‰UNIX_GROUP_NAME=oinstall // å®‰è£…ç»„INVENTORY_LOCATION=/u01/app/oraInventory //INVENTORYç›®å½•ï¼ˆä¸å¡«å°±æ˜¯é»˜è®¤å€¼ï¼‰SELECTED_LANGUAGES=en,zh_CN,zh_TW // é€‰æ‹©è¯­è¨€ORACLE_HOME=/u01/app/oracle/product/11.2.0/db_1 //oracle_homeORACLE_BASE=/u01/app/oracle //oracle_baseoracle.install.db.InstallEdition=EE ã€€ã€€ã€€ã€€// oracleç‰ˆæœ¬oracle.install.db.isCustomInstall=false ã€€ã€€//è‡ªå®šä¹‰å®‰è£…ï¼Œå¦ï¼Œä½¿ç”¨é»˜è®¤ç»„ä»¶oracle.install.db.DBA_GROUP=dba /ã€€ã€€/ dbaç”¨æˆ·ç»„oracle.install.db.OPER_GROUP=oinstall // operç”¨æˆ·ç»„oracle.install.db.config.starterdb.type=GENERAL_PURPOSE //æ•°æ®åº“ç±»å‹oracle.install.db.config.starterdb.globalDBName=orcl //globalDBNameoracle.install.db.config.starterdb.SID=dbsrv2 //SIDoracle.install.db.config.starterdb.memoryLimit=81920 //è‡ªåŠ¨ç®¡ç†å†…å­˜çš„å†…å­˜(M)oracle.install.db.config.starterdb.password.ALL=oracle //è®¾å®šæ‰€æœ‰æ•°æ®åº“ç”¨æˆ·ä½¿ç”¨åŒä¸€ä¸ªå¯†ç SECURITY_UPDATES_VIA_MYORACLESUPPORT=false //ï¼ˆæ‰‹åŠ¨å†™äº†falseï¼‰DECLINE_SECURITY_UPDATES=true ã€€ã€€//è®¾ç½®å®‰å…¨æ›´æ–°ï¼ˆè²Œä¼¼æ˜¯æœ‰bugï¼Œè¿™ä¸ªä¸€å®šè¦é€‰trueï¼Œå¦åˆ™ä¼šæ— é™æé†’é‚®ä»¶åœ°å€æœ‰é—®é¢˜ï¼Œç»ˆæ­¢å®‰è£…ã€‚PSï¼šä¸ç®¡åœ°å€å¯¹ä¸å¯¹ï¼‰</code></pre><pre><code>oracle.install.option=INSTALL_DB_SWONLY // å®‰è£…ç±»å‹ORACLE_HOSTNAME=oracledb // ä¸»æœºåç§°ï¼ˆhostnameæŸ¥è¯¢ï¼‰UNIX_GROUP_NAME=oinstall // å®‰è£…ç»„INVENTORY_LOCATION=/u01/app/oraInventory //INVENTORYç›®å½•ï¼ˆä¸å¡«å°±æ˜¯é»˜è®¤å€¼ï¼‰SELECTED_LANGUAGES=en,zh_CN,zh_TW // é€‰æ‹©è¯­è¨€ORACLE_HOME=/u01/app/oracle/product/11.2.0/db_1 //oracle_homeORACLE_BASE=/u01/app/oracle //oracle_baseoracle.install.db.InstallEdition=EE ã€€ã€€ã€€ã€€// oracleç‰ˆæœ¬oracle.install.db.isCustomInstall=false ã€€ã€€//è‡ªå®šä¹‰å®‰è£…ï¼Œå¦ï¼Œä½¿ç”¨é»˜è®¤ç»„ä»¶oracle.install.db.DBA_GROUP=dba /ã€€ã€€/ dbaç”¨æˆ·ç»„oracle.install.db.OPER_GROUP=oinstall // operç”¨æˆ·ç»„oracle.install.db.config.starterdb.type=GENERAL_PURPOSE //æ•°æ®åº“ç±»å‹oracle.install.db.config.starterdb.globalDBName=orcl //globalDBNameoracle.install.db.config.starterdb.SID=dbsrv2 //SIDoracle.install.db.config.starterdb.memoryLimit=81920 //è‡ªåŠ¨ç®¡ç†å†…å­˜çš„å†…å­˜(M)oracle.install.db.config.starterdb.password.ALL=oracle //è®¾å®šæ‰€æœ‰æ•°æ®åº“ç”¨æˆ·ä½¿ç”¨åŒä¸€ä¸ªå¯†ç SECURITY_UPDATES_VIA_MYORACLESUPPORT=false //ï¼ˆæ‰‹åŠ¨å†™äº†falseï¼‰DECLINE_SECURITY_UPDATES=true ã€€ã€€//è®¾ç½®å®‰å…¨æ›´æ–°ï¼ˆè²Œä¼¼æ˜¯æœ‰bugï¼Œè¿™ä¸ªä¸€å®šè¦é€‰trueï¼Œå¦åˆ™ä¼šæ— é™æé†’é‚®ä»¶åœ°å€æœ‰é—®é¢˜ï¼Œç»ˆæ­¢å®‰è£…ã€‚PSï¼šä¸ç®¡åœ°å€å¯¹ä¸å¯¹ï¼‰</code></pre><p>å¼€å§‹é™é»˜å®‰è£…</p><pre><code>[oracle@cyylog database]$ ./runInstaller -silent -responseFile /home/oracle/etc/db_install.rsp</code></pre><p>æ–°å¼€ä¸€ä¸ªç»ˆç«¯ æŸ¥çœ‹å®‰è£…æ—¥å¿—</p><pre><code># tail -f /u01/app/oraInventory/logs/installActions2016-08-31_06-56-29PM.log</code></pre><p>å‡ºç°ç±»ä¼¼å¦‚ä¸‹æç¤ºè¡¨ç¤ºå®‰è£…å®Œæˆï¼š</p><p>-â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€“</p><p>The following configuration scripts need to be executed as the â€œrootâ€ user. #!/bin/sh #Root scripts to run</p><p>/u01/app/oraInventory/orainstRoot.sh /u01/app/oracle/product/11.2.0/db_1/root.sh To execute the configuration scripts:</p><ol><li>Open a terminal window</li><li>Log in as â€œrootâ€</li><li>Run the scripts</li><li>Return to this window and hit â€œEnterâ€ key to continue</li></ol><p>Successfully Setup Software.</p><p>-â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”-</p><p>ä½¿ç”¨rootç”¨æˆ·æ‰§è¡Œè„šæœ¬</p><pre><code>$ su - root# /u01/app/oraInventory/orainstRoot.sh# /u01/app/oracle/product/11.2.0/db_1/root.sh</code></pre><p>å¢åŠ æˆ–ä¿®æ”¹oracleçš„ç¯å¢ƒå˜é‡</p><pre><code># su - oracle# vim ~/.bash_profile</code></pre><pre><code>#for oracleexport ORACLE_BASE=/u01/app/oracleexport ORACLE_SID=dbsrv2export ROACLE_PID=ora11g#export NLS_LANG=AMERICAN_AMERICA.AL32UTF8export LD_LIBRARY_PATH=$ORACLE_HOME/lib:/usr/libexport ORACLE_HOME=/u01/app/oracle/product/11.2.0/db_1export PATH=$PATH:$ORACLE_HOME/binexport LANG=&quot;zh_CN.UTF-8&quot;export NLS_LANG=&quot;SIMPLIFIED CHINESE_CHINA.AL32UTF8&quot;export NLS_DATE_FORMAT=&#39;yyyy-mm-dd hh24:mi:ss&#39;åˆ·æ–°ç¯å¢ƒå˜é‡# source ~/.bash_profile</code></pre><p>é…ç½®ç›‘å¬ç¨‹åº</p><pre><code>[oracle@cyylog ~]$ netca /silent /responsefile /home/oracle/etc/netca.rspParsing command line arguments:Parameter &quot;silent&quot; = trueParameter &quot;responsefile&quot; = /home/oracle/etc/netca.rspDone parsing command line arguments.Oracle Net Services Configuration:Profile configuration complete.Oracle Net Listener Startup:Running Listener Control: /u01/app/oracle/product/11.2.0/db_1/bin/lsnrctl start LISTENERListener Control complete.Listener started successfully.Listener configuration complete.Oracle Net Services configuration successful. The exit code is 0</code></pre><p>å¯åŠ¨ç›‘æ§ç¨‹åº</p><pre><code>[oracle@cyylog ~]$ lsnrctl startLSNRCTL for Linux: Version 11.2.0.1.0 - Production on 01-SEP-2016 11:23:31Copyright (c) 1991, 2009, Oracle. All rights reserved.Starting /u01/app/oracle/product/11.2.0/db_1/bin/tnslsnr: please wait...TNSLSNR for Linux: Version 11.2.0.1.0 - ProductionSystem parameter file is /u01/app/oracle/product/11.2.0/db_1/network/admin/listener.oraLog messages written to /u01/app/oracle/diag/tnslsnr/cyylog/listener/alert/log.xmlListening on: (DESCRIPTION=(ADDRESS=(PROTOCOL=ipc)(KEY=EXTPROC1521)))Listening on: (DESCRIPTION=(ADDRESS=(PROTOCOL=tcp)(HOST=cyylog)(PORT=1521)))Connecting to (DESCRIPTION=(ADDRESS=(PROTOCOL=IPC)(KEY=EXTPROC1521)))STATUS of the LISTENER------------------------Alias LISTENERVersion TNSLSNR for Linux: Version 11.2.0.1.0 - ProductionStart Date 01-SEP-2016 11:23:31Uptime 0 days 0 hr. 0 min. 0 secTrace Level offSecurity ON: Local OS AuthenticationSNMP OFFListener Parameter File /u01/app/oracle/product/11.2.0/db_1/network/admin/listener.oraListener Log File /u01/app/oracle/diag/tnslsnr/cyylog/listener/alert/log.xmlListening Endpoints Summary... (DESCRIPTION=(ADDRESS=(PROTOCOL=ipc)(KEY=EXTPROC1521))) (DESCRIPTION=(ADDRESS=(PROTOCOL=tcp)(HOST=cyylog)(PORT=1521)))The listener supports no servicesThe command completed successfully</code></pre><p>é™é»˜dbcaå»ºåº“</p><p>ç¼–è¾‘åº”ç­”æ–‡ä»¶</p><pre><code>[oracle@cyylog ~]$ vi etc/dbca.rsp[GENERAL]RESPONSEFILE_VERSION = &quot;11.2.0&quot;OPERATION_TYPE = &quot;createDatabase&quot;[CREATEDATABASE]GDBNAME = &quot;dbsrv2&quot;SID = &quot;dbsrv2&quot;TEMPLATENAME = &quot;General_Purpose.dbc&quot;CHARACTERSET = &quot;AL32UTF8&quot;</code></pre><p><strong><em>å»ºåº“(æˆ‘çš„finashellä¼šé—ªå±,ä½†æ˜¯ä¸å½±å“ä½¿ç”¨ï¼Œå› ä¸ºè¿™ä¸ªæ˜¯å› ä¸ºæ— å›¾å½¢ç•Œé¢çš„æƒ…å†µ)</em></strong></p><pre><code>[oracle@cyylog ~]$ dbca -silent -responseFile etc/dbca.rspEnter SYS user password: Enter SYSTEM user password: sh: /bin/ksh: No such file or directorysh: /bin/ksh: No such file or directoryCopying database files1% complete3% complete11% complete18% complete26% complete37% completeCreating and starting Oracle instance40% complete45% complete50% complete55% complete56% complete57% complete60% complete62% completeCompleting Database Creation66% complete70% complete73% complete74% complete85% complete96% complete100% completeLook at the log file Look at the log file &quot;/u01/app/oracle/cfgtoollogs/dbca/orcl11g/orcl11g.log&quot; for further details.</code></pre><pre><code>[oracle@cyylog ~]$ dbca -silent -responseFile etc/dbca.rspEnter SYS user password: Enter SYSTEM user password: sh: /bin/ksh: No such file or directorysh: /bin/ksh: No such file or directoryCopying database files1% complete3% complete11% complete18% complete26% complete37% completeCreating and starting Oracle instance40% complete45% complete50% complete55% complete56% complete57% complete60% complete62% completeCompleting Database Creation66% complete70% complete73% complete74% complete85% complete96% complete100% completeLook at the log file Look at the log file &quot;/u01/app/oracle/cfgtoollogs/dbca/orcl11g/orcl11g.log&quot; for further details.</code></pre><p>æŸ¥çœ‹è¾“å‡ºæ—¥å¿—</p><pre><code>[oracle@cyylog ~]$ tailf /u01/app/oracle/cfgtoollogs/dbca/silent.logCopying database filesDBCA_PROGRESS : 1%DBCA_PROGRESS : 3%DBCA_PROGRESS : 11%DBCA_PROGRESS : 18%DBCA_PROGRESS : 26%DBCA_PROGRESS : 37%Creating and starting Oracle instanceDBCA_PROGRESS : 40%DBCA_PROGRESS : 45%DBCA_PROGRESS : 50%DBCA_PROGRESS : 55%DBCA_PROGRESS : 56%DBCA_PROGRESS : 60%DBCA_PROGRESS : 62%Completing Database CreationDBCA_PROGRESS : 66%DBCA_PROGRESS : 70%DBCA_PROGRESS : 73%DBCA_PROGRESS : 85%DBCA_PROGRESS : 96%DBCA_PROGRESS : 100%Database creation complete. For details check the logfiles at: /u01/app/oracle/cfgtoollogs/dbca/orcl11g.Database Information:Global Database Name:orcl11g.us.oracle.comSystem Identifier(SID):dbsrv2</code></pre><p><strong>è‡³æ­¤å®Œæˆæ•°æ®åº“å®ä¾‹çš„åˆ›å»ºã€‚</strong></p><p>-â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”-</p><p>-â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”-</p><p><strong>é™„ï¼š</strong></p><p>åˆ é™¤å®ä¾‹ï¼š</p><pre><code>[oracle@cyylog ~]$ dbca -silent -deleteDatabase -sourcedb dbsrv2</code></pre><p>æ–‡ç« æ¥æº:<a href="https://www.cnblogs.com/zydev/p/5827207.html" target="_blank" rel="noopener">https://www.cnblogs.com/zydev/p/5827207.html</a></p>]]></content>
      
      
      <categories>
          
          <category> SQL </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Oracle </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Docker_002</title>
      <link href="2019/11/19/rong-qi/dockerfilee-002/"/>
      <url>2019/11/19/rong-qi/dockerfilee-002/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h4 id="Dockerfile-redis-5-0"><a href="#Dockerfile-redis-5-0" class="headerlink" title="Dockerfile_redis_5.0"></a>Dockerfile_redis_5.0</h4><pre class=" language-dockerfile"><code class="language-dockerfile">FROM debian:buster-slim# add our user and group first to make sure their IDs get assigned consistently, regardless of whatever dependencies get addedRUN groupadd -r -g 999 redis && useradd -r -g redis -u 999 redis# grab gosu for easy step-down from root# https://github.com/tianon/gosu/releasesENV GOSU_VERSION 1.11RUN set -eux; \# save list of currently installed packages for later so we can clean up    savedAptMark="$(apt-mark showmanual)"; \    apt-get update; \    apt-get install -y --no-install-recommends \        ca-certificates \        dirmngr \        gnupg \        wget \    ; \    rm -rf /var/lib/apt/lists/*; \    \    dpkgArch="$(dpkg --print-architecture | awk -F- '{ print $NF }')"; \    wget -O /usr/local/bin/gosu "https://github.com/tianon/gosu/releases/download/$GOSU_VERSION/gosu-$dpkgArch"; \    wget -O /usr/local/bin/gosu.asc "https://github.com/tianon/gosu/releases/download/$GOSU_VERSION/gosu-$dpkgArch.asc"; \    \# verify the signature    export GNUPGHOME="$(mktemp -d)"; \    gpg --batch --keyserver hkps://keys.openpgp.org --recv-keys B42F6819007F00F88E364FD4036A9C25BF357DD4; \    gpg --batch --verify /usr/local/bin/gosu.asc /usr/local/bin/gosu; \    gpgconf --kill all; \    rm -rf "$GNUPGHOME" /usr/local/bin/gosu.asc; \    \# clean up fetch dependencies    apt-mark auto '.*' > /dev/null; \    [ -z "$savedAptMark" ] || apt-mark manual $savedAptMark > /dev/null; \    apt-get purge -y --auto-remove -o APT::AutoRemove::RecommendsImportant=false; \    \    chmod +x /usr/local/bin/gosu; \# verify that the binary works    gosu --version; \    gosu nobody trueENV REDIS_VERSION 5.0.8ENV REDIS_DOWNLOAD_URL http://download.redis.io/releases/redis-5.0.8.tar.gzENV REDIS_DOWNLOAD_SHA f3c7eac42f433326a8d981b50dba0169fdfaf46abb23fcda2f933a7552ee4ed7RUN set -eux; \    \    savedAptMark="$(apt-mark showmanual)"; \    apt-get update; \    apt-get install -y --no-install-recommends \        ca-certificates \        wget \        \        gcc \        libc6-dev \        make \    ; \    rm -rf /var/lib/apt/lists/*; \    \    wget -O redis.tar.gz "$REDIS_DOWNLOAD_URL"; \    echo "$REDIS_DOWNLOAD_SHA *redis.tar.gz" | sha256sum -c -; \    mkdir -p /usr/src/redis; \    tar -xzf redis.tar.gz -C /usr/src/redis --strip-components=1; \    rm redis.tar.gz; \    \# disable Redis protected mode [1] as it is unnecessary in context of Docker# (ports are not automatically exposed when running inside Docker, but rather explicitly by specifying -p / -P)# [1]: https://github.com/antirez/redis/commit/edd4d555df57dc84265fdfb4ef59a4678832f6da    grep -q '^#define CONFIG_DEFAULT_PROTECTED_MODE 1$' /usr/src/redis/src/server.h; \    sed -ri 's!^(#define CONFIG_DEFAULT_PROTECTED_MODE) 1$!\1 0!' /usr/src/redis/src/server.h; \    grep -q '^#define CONFIG_DEFAULT_PROTECTED_MODE 0$' /usr/src/redis/src/server.h; \# for future reference, we modify this directly in the source instead of just supplying a default configuration flag because apparently "if you specify any argument to redis-server, [it assumes] you are going to specify everything"# see also https://github.com/docker-library/redis/issues/4#issuecomment-50780840# (more exactly, this makes sure the default behavior of "save on SIGTERM" stays functional by default)    \    make -C /usr/src/redis -j "$(nproc)" all; \    make -C /usr/src/redis install; \    \# TODO https://github.com/antirez/redis/pull/3494 (deduplicate "redis-server" copies)    serverMd5="$(md5sum /usr/local/bin/redis-server | cut -d' ' -f1)"; export serverMd5; \    find /usr/local/bin/redis* -maxdepth 0 \        -type f -not -name redis-server \        -exec sh -eux -c ' \            md5="$(md5sum "$1" | cut -d" " -f1)"; \            test "$md5" = "$serverMd5"; \        ' -- '{}' ';' \        -exec ln -svfT 'redis-server' '{}' ';' \    ; \    \    rm -r /usr/src/redis; \    \    apt-mark auto '.*' > /dev/null; \    [ -z "$savedAptMark" ] || apt-mark manual $savedAptMark > /dev/null; \    find /usr/local -type f -executable -exec ldd '{}' ';' \        | awk '/=>/ { print $(NF-1) }' \        | sort -u \        | xargs -r dpkg-query --search \        | cut -d: -f1 \        | sort -u \        | xargs -r apt-mark manual \    ; \    apt-get purge -y --auto-remove -o APT::AutoRemove::RecommendsImportant=false; \    \    redis-cli --version; \    redis-server --versionRUN mkdir /data && chown redis:redis /dataVOLUME /dataWORKDIR /dataCOPY docker-entrypoint.sh /usr/local/bin/ENTRYPOINT ["docker-entrypoint.sh"]EXPOSE 6379CMD ["redis-server"]</code></pre><h4 id="Dockerfile-alpine-httpd-2-4"><a href="#Dockerfile-alpine-httpd-2-4" class="headerlink" title="Dockerfile_alpine_httpd_2.4"></a>Dockerfile_alpine_httpd_2.4</h4><pre class=" language-dockerfile"><code class="language-dockerfile">FROM alpine:3.11# ensure www-data user existsRUN set -x \    && addgroup -g 82 -S www-data \    && adduser -u 82 -D -S -G www-data www-data# 82 is the standard uid/gid for "www-data" in Alpine# https://git.alpinelinux.org/cgit/aports/tree/main/apache2/apache2.pre-install?h=v3.8.1# https://git.alpinelinux.org/cgit/aports/tree/main/lighttpd/lighttpd.pre-install?h=v3.8.1# https://git.alpinelinux.org/cgit/aports/tree/main/nginx/nginx.pre-install?h=v3.8.1ENV HTTPD_PREFIX /usr/local/apache2ENV PATH $HTTPD_PREFIX/bin:$PATHRUN mkdir -p "$HTTPD_PREFIX" \    && chown www-data:www-data "$HTTPD_PREFIX"WORKDIR $HTTPD_PREFIXENV HTTPD_VERSION 2.4.43ENV HTTPD_SHA256 a497652ab3fc81318cdc2a203090a999150d86461acff97c1065dc910fe10f43# https://httpd.apache.org/security/vulnerabilities_24.htmlENV HTTPD_PATCHES=""# see https://httpd.apache.org/docs/2.4/install.html#requirementsRUN set -eux; \    \    runDeps=' \        apr-dev \        apr-util-dbm_db \        apr-util-dev \        apr-util-ldap \        perl \    '; \    apk add --no-cache --virtual .build-deps \        $runDeps \        ca-certificates \        coreutils \        dpkg-dev dpkg \        gcc \        gnupg \        libc-dev \        # mod_md        curl-dev \        jansson-dev \        # mod_proxy_html mod_xml2enc        libxml2-dev \        # mod_lua        lua-dev \        make \        # mod_http2        nghttp2-dev \        # mod_session_crypto        openssl \        openssl-dev \        pcre-dev \        tar \        # mod_deflate        zlib-dev \        # mod_brotli        brotli-dev \    ; \    \    ddist() { \        local f="$1"; shift; \        local distFile="$1"; shift; \        local success=; \        local distUrl=; \        for distUrl in \# https://issues.apache.org/jira/browse/INFRA-8753?focusedCommentId=14735394#comment-14735394            'https://www.apache.org/dyn/closer.cgi?action=download&filename=' \# if the version is outdated (or we're grabbing the .asc file), we might have to pull from the dist/archive :/            https://www-us.apache.org/dist/ \            https://www.apache.org/dist/ \            https://archive.apache.org/dist/ \        ; do \            if wget -O "$f" "$distUrl$distFile" && [ -s "$f" ]; then \                success=1; \                break; \            fi; \        done; \        [ -n "$success" ]; \    }; \    \    ddist 'httpd.tar.bz2' "httpd/httpd-$HTTPD_VERSION.tar.bz2"; \    echo "$HTTPD_SHA256 *httpd.tar.bz2" | sha256sum -c -; \    \# see https://httpd.apache.org/download.cgi#verify    ddist 'httpd.tar.bz2.asc' "httpd/httpd-$HTTPD_VERSION.tar.bz2.asc"; \    export GNUPGHOME="$(mktemp -d)"; \    for key in \# gpg: key 791485A8: public key "Jim Jagielski (Release Signing Key) <jim@apache.org>" imported        A93D62ECC3C8EA12DB220EC934EA76E6791485A8 \# gpg: key 995E35221AD84DFF: public key "Daniel Ruggeri (https://home.apache.org/~druggeri/) <druggeri@apache.org>" imported        B9E8213AEFB861AF35A41F2C995E35221AD84DFF \    ; do \        gpg --batch --keyserver ha.pool.sks-keyservers.net --recv-keys "$key"; \    done; \    gpg --batch --verify httpd.tar.bz2.asc httpd.tar.bz2; \    command -v gpgconf && gpgconf --kill all || :; \    rm -rf "$GNUPGHOME" httpd.tar.bz2.asc; \    \    mkdir -p src; \    tar -xf httpd.tar.bz2 -C src --strip-components=1; \    rm httpd.tar.bz2; \    cd src; \    \    patches() { \        while [ "$#" -gt 0 ]; do \            local patchFile="$1"; shift; \            local patchSha256="$1"; shift; \            ddist "$patchFile" "httpd/patches/apply_to_$HTTPD_VERSION/$patchFile"; \            echo "$patchSha256 *$patchFile" | sha256sum -c -; \            patch -p0 < "$patchFile"; \            rm -f "$patchFile"; \        done; \    }; \    patches $HTTPD_PATCHES; \    \    gnuArch="$(dpkg-architecture --query DEB_BUILD_GNU_TYPE)"; \    ./configure \        --build="$gnuArch" \        --prefix="$HTTPD_PREFIX" \        --enable-mods-shared=reallyall \        --enable-mpms-shared=all \# PIE and hardening flags are unnecessary as Alpine enables them automatically (https://alpinelinux.org/about/)    ; \    make -j "$(nproc)"; \    make install; \    \    cd ..; \    rm -r src man manual; \    \    sed -ri \        -e 's!^(\s*CustomLog)\s+\S+!\1 /proc/self/fd/1!g' \        -e 's!^(\s*ErrorLog)\s+\S+!\1 /proc/self/fd/2!g' \        -e 's!^(\s*TransferLog)\s+\S+!\1 /proc/self/fd/1!g' \        "$HTTPD_PREFIX/conf/httpd.conf" \        "$HTTPD_PREFIX/conf/extra/httpd-ssl.conf" \    ; \    \    runDeps="$runDeps $( \        scanelf --needed --nobanner --format '%n#p' --recursive /usr/local \            | tr ',' '\n' \            | sort -u \            | awk 'system("[ -e /usr/local/lib/" $1 " ]") == 0 { next } { print "so:" $1 }' \    )"; \    apk add --no-network --virtual .httpd-rundeps $runDeps; \    apk del --no-network .build-deps; \    \# smoke test    httpd -v# https://httpd.apache.org/docs/2.4/stopping.html#gracefulstopSTOPSIGNAL SIGWINCHCOPY httpd-foreground /usr/local/bin/EXPOSE 80CMD ["httpd-foreground"]</code></pre>]]></content>
      
      
      <categories>
          
          <category> å®¹å™¨ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Docker_001</title>
      <link href="2019/11/17/rong-qi/dockerfilee-001/"/>
      <url>2019/11/17/rong-qi/dockerfilee-001/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h4 id="Docker-MySQL-5-7"><a href="#Docker-MySQL-5-7" class="headerlink" title="Docker_MySQL 5.7"></a>Docker_MySQL 5.7</h4><pre class=" language-dockerfile"><code class="language-dockerfile">FROM debian:buster-slim# add our user and group first to make sure their IDs get assigned consistently, regardless of whatever dependencies get addedRUN groupadd -r mysql && useradd -r -g mysql mysqlRUN apt-get update && apt-get install -y --no-install-recommends gnupg dirmngr && rm -rf /var/lib/apt/lists/*# add gosu for easy step-down from rootENV GOSU_VERSION 1.7RUN set -x \    && apt-get update && apt-get install -y --no-install-recommends ca-certificates wget && rm -rf /var/lib/apt/lists/* \    && wget -O /usr/local/bin/gosu "https://github.com/tianon/gosu/releases/download/$GOSU_VERSION/gosu-$(dpkg --print-architecture)" \    && wget -O /usr/local/bin/gosu.asc "https://github.com/tianon/gosu/releases/download/$GOSU_VERSION/gosu-$(dpkg --print-architecture).asc" \    && export GNUPGHOME="$(mktemp -d)" \    && gpg --batch --keyserver ha.pool.sks-keyservers.net --recv-keys B42F6819007F00F88E364FD4036A9C25BF357DD4 \    && gpg --batch --verify /usr/local/bin/gosu.asc /usr/local/bin/gosu \    && gpgconf --kill all \    && rm -rf "$GNUPGHOME" /usr/local/bin/gosu.asc \    && chmod +x /usr/local/bin/gosu \    && gosu nobody true \    && apt-get purge -y --auto-remove ca-certificates wgetRUN mkdir /docker-entrypoint-initdb.dRUN apt-get update && apt-get install -y --no-install-recommends \# for MYSQL_RANDOM_ROOT_PASSWORD        pwgen \# for mysql_ssl_rsa_setup        openssl \# FATAL ERROR: please install the following Perl modules before executing /usr/local/mysql/scripts/mysql_install_db:# File::Basename# File::Copy# Sys::Hostname# Data::Dumper        perl \# install "xz-utils" for .sql.xz docker-entrypoint-initdb.d files        xz-utils \    && rm -rf /var/lib/apt/lists/*RUN set -ex; \# gpg: key 5072E1F5: public key "MySQL Release Engineering <mysql-build@oss.oracle.com>" imported    key='A4A9406876FCBD3C456770C88C718D3B5072E1F5'; \    export GNUPGHOME="$(mktemp -d)"; \    gpg --batch --keyserver ha.pool.sks-keyservers.net --recv-keys "$key"; \    gpg --batch --export "$key" > /etc/apt/trusted.gpg.d/mysql.gpg; \    gpgconf --kill all; \    rm -rf "$GNUPGHOME"; \    apt-key list > /dev/nullENV MYSQL_MAJOR 5.7ENV MYSQL_VERSION 5.7.29-1debian10RUN echo "deb http://repo.mysql.com/apt/debian/ buster mysql-${MYSQL_MAJOR}" > /etc/apt/sources.list.d/mysql.list# the "/var/lib/mysql" stuff here is because the mysql-server postinst doesn't have an explicit way to disable the mysql_install_db codepath besides having a database already "configured" (ie, stuff in /var/lib/mysql/mysql)# also, we set debconf keys to make APT a little quieterRUN { \        echo mysql-community-server mysql-community-server/data-dir select ''; \        echo mysql-community-server mysql-community-server/root-pass password ''; \        echo mysql-community-server mysql-community-server/re-root-pass password ''; \        echo mysql-community-server mysql-community-server/remove-test-db select false; \    } | debconf-set-selections \    && apt-get update && apt-get install -y mysql-server="${MYSQL_VERSION}" && rm -rf /var/lib/apt/lists/* \    && rm -rf /var/lib/mysql && mkdir -p /var/lib/mysql /var/run/mysqld \    && chown -R mysql:mysql /var/lib/mysql /var/run/mysqld \# ensure that /var/run/mysqld (used for socket and lock files) is writable regardless of the UID our mysqld instance ends up having at runtime    && chmod 777 /var/run/mysqld \# comment out a few problematic configuration values    && find /etc/mysql/ -name '*.cnf' -print0 \        | xargs -0 grep -lZE '^(bind-address|log)' \        | xargs -rt -0 sed -Ei 's/^(bind-address|log)/#&/' \# don't reverse lookup hostnames, they are usually another container    && echo '[mysqld]\nskip-host-cache\nskip-name-resolve' > /etc/mysql/conf.d/docker.cnfVOLUME /var/lib/mysqlCOPY docker-entrypoint.sh /usr/local/bin/RUN ln -s usr/local/bin/docker-entrypoint.sh /entrypoint.sh # backwards compatENTRYPOINT ["docker-entrypoint.sh"]EXPOSE 3306 33060CMD ["mysqld"]</code></pre><h4 id="Docker-NGINX-1-17-9"><a href="#Docker-NGINX-1-17-9" class="headerlink" title="Docker_NGINX_1.17.9"></a>Docker_NGINX_1.17.9</h4><pre class=" language-dockerfile"><code class="language-dockerfile">FROM alpine:3.10LABEL maintainer="NGINX Docker Maintainers <docker-maint@nginx.com>"ENV NGINX_VERSION 1.17.9ENV NJS_VERSION   0.3.9ENV PKG_RELEASE   1RUN set -x \# create nginx user/group first, to be consistent throughout docker variants    && addgroup -g 101 -S nginx \    && adduser -S -D -H -u 101 -h /var/cache/nginx -s /sbin/nologin -G nginx -g nginx nginx \    && apkArch="$(cat /etc/apk/arch)" \    && nginxPackages=" \        nginx=${NGINX_VERSION}-r${PKG_RELEASE} \        nginx-module-xslt=${NGINX_VERSION}-r${PKG_RELEASE} \        nginx-module-geoip=${NGINX_VERSION}-r${PKG_RELEASE} \        nginx-module-image-filter=${NGINX_VERSION}-r${PKG_RELEASE} \        nginx-module-njs=${NGINX_VERSION}.${NJS_VERSION}-r${PKG_RELEASE} \    " \    && case "$apkArch" in \        x86_64) \# arches officially built by upstream            set -x \            && KEY_SHA512="e7fa8303923d9b95db37a77ad46c68fd4755ff935d0a534d26eba83de193c76166c68bfe7f65471bf8881004ef4aa6df3e34689c305662750c0172fca5d8552a *stdin" \            && apk add --no-cache --virtual .cert-deps \                openssl \            && wget -O /tmp/nginx_signing.rsa.pub https://nginx.org/keys/nginx_signing.rsa.pub \            && if [ "$(openssl rsa -pubin -in /tmp/nginx_signing.rsa.pub -text -noout | openssl sha512 -r)" = "$KEY_SHA512" ]; then \                echo "key verification succeeded!"; \                mv /tmp/nginx_signing.rsa.pub /etc/apk/keys/; \            else \                echo "key verification failed!"; \                exit 1; \            fi \            && apk del .cert-deps \            && apk add -X "https://nginx.org/packages/mainline/alpine/v$(egrep -o '^[0-9]+\.[0-9]+' /etc/alpine-release)/main" --no-cache $nginxPackages \            ;; \        *) \# we're on an architecture upstream doesn't officially build for# let's build binaries from the published packaging sources            set -x \            && tempDir="$(mktemp -d)" \            && chown nobody:nobody $tempDir \            && apk add --no-cache --virtual .build-deps \                gcc \                libc-dev \                make \                openssl-dev \                pcre-dev \                zlib-dev \                linux-headers \                libxslt-dev \                gd-dev \                geoip-dev \                perl-dev \                libedit-dev \                mercurial \                bash \                alpine-sdk \                findutils \            && su nobody -s /bin/sh -c " \                export HOME=${tempDir} \                && cd ${tempDir} \                && hg clone https://hg.nginx.org/pkg-oss \                && cd pkg-oss \                && hg up ${NGINX_VERSION}-${PKG_RELEASE} \                && cd alpine \                && make all \                && apk index -o ${tempDir}/packages/alpine/${apkArch}/APKINDEX.tar.gz ${tempDir}/packages/alpine/${apkArch}/*.apk \                && abuild-sign -k ${tempDir}/.abuild/abuild-key.rsa ${tempDir}/packages/alpine/${apkArch}/APKINDEX.tar.gz \                " \            && cp ${tempDir}/.abuild/abuild-key.rsa.pub /etc/apk/keys/ \            && apk del .build-deps \            && apk add -X ${tempDir}/packages/alpine/ --no-cache $nginxPackages \            ;; \    esac \# if we have leftovers from building, let's purge them (including extra, unnecessary build deps)    && if [ -n "$tempDir" ]; then rm -rf "$tempDir"; fi \    && if [ -n "/etc/apk/keys/abuild-key.rsa.pub" ]; then rm -f /etc/apk/keys/abuild-key.rsa.pub; fi \    && if [ -n "/etc/apk/keys/nginx_signing.rsa.pub" ]; then rm -f /etc/apk/keys/nginx_signing.rsa.pub; fi \# Bring in gettext so we can get `envsubst`, then throw# the rest away. To do this, we need to install `gettext`# then move `envsubst` out of the way so `gettext` can# be deleted completely, then move `envsubst` back.    && apk add --no-cache --virtual .gettext gettext \    && mv /usr/bin/envsubst /tmp/ \    \    && runDeps="$( \        scanelf --needed --nobanner /tmp/envsubst \            | awk '{ gsub(/,/, "\nso:", $2); print "so:" $2 }' \            | sort -u \            | xargs -r apk info --installed \            | sort -u \    )" \    && apk add --no-cache $runDeps \    && apk del .gettext \    && mv /tmp/envsubst /usr/local/bin/ \# Bring in tzdata so users could set the timezones through the environment# variables    && apk add --no-cache tzdata \# forward request and error logs to docker log collector    && ln -sf /dev/stdout /var/log/nginx/access.log \    && ln -sf /dev/stderr /var/log/nginx/error.logEXPOSE 80STOPSIGNAL SIGTERMCMD ["nginx", "-g", "daemon off;"]</code></pre>]]></content>
      
      
      <categories>
          
          <category> å®¹å™¨ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Docker_000</title>
      <link href="2019/11/15/rong-qi/dockerfilee-000/"/>
      <url>2019/11/15/rong-qi/dockerfilee-000/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h4 id="Dockerfileæ„å»ºé•œåƒ"><a href="#Dockerfileæ„å»ºé•œåƒ" class="headerlink" title="Dockerfileæ„å»ºé•œåƒ"></a>Dockerfileæ„å»ºé•œåƒ</h4><pre><code>é€šè¿‡Dockerfileåˆ›å»ºé•œåƒè™½ç„¶å¯ä»¥è‡ªå·±åˆ¶ä½œ rootfs(è§&#39;å®¹å™¨æ–‡ä»¶ç³»ç»Ÿé‚£äº›äº‹å„¿&#39;)ï¼Œä½†Docker æä¾›äº†ä¸€ç§æ›´ä¾¿æ·çš„æ–¹å¼ï¼Œå«ä½œ Dockerfiledocker buildå‘½ä»¤ç”¨äºæ ¹æ®ç»™å®šçš„Dockerfileå’Œä¸Šä¸‹æ–‡ä»¥æ„å»ºDockeré•œåƒã€‚docker buildè¯­æ³•ï¼š# docker build [OPTIONS] &lt;PATH | URL | -&gt;1. å¸¸ç”¨é€‰é¡¹è¯´æ˜--build-argï¼Œè®¾ç½®æ„å»ºæ—¶çš„å˜é‡--no-cacheï¼Œé»˜è®¤falseã€‚è®¾ç½®è¯¥é€‰é¡¹ï¼Œå°†ä¸ä½¿ç”¨Build Cacheæ„å»ºé•œåƒ--pullï¼Œé»˜è®¤falseã€‚è®¾ç½®è¯¥é€‰é¡¹ï¼Œæ€»æ˜¯å°è¯•pullé•œåƒçš„æœ€æ–°ç‰ˆæœ¬--compressï¼Œé»˜è®¤falseã€‚è®¾ç½®è¯¥é€‰é¡¹ï¼Œå°†ä½¿ç”¨gzipå‹ç¼©æ„å»ºçš„ä¸Šä¸‹æ–‡--disable-content-trustï¼Œé»˜è®¤trueã€‚è®¾ç½®è¯¥é€‰é¡¹ï¼Œå°†å¯¹é•œåƒè¿›è¡ŒéªŒè¯--file, -fï¼ŒDockerfileçš„å®Œæ•´è·¯å¾„ï¼Œé»˜è®¤å€¼ä¸ºâ€˜PATH/Dockerfileâ€™--isolationï¼Œé»˜è®¤--isolation=&quot;default&quot;ï¼Œå³Linuxå‘½åç©ºé—´ï¼›å…¶ä»–è¿˜æœ‰processæˆ–hyperv--labelï¼Œä¸ºç”Ÿæˆçš„é•œåƒè®¾ç½®metadata--squashï¼Œé»˜è®¤falseã€‚è®¾ç½®è¯¥é€‰é¡¹ï¼Œå°†æ–°æ„å»ºå‡ºçš„å¤šä¸ªå±‚å‹ç¼©ä¸ºä¸€ä¸ªæ–°å±‚ï¼Œä½†æ˜¯å°†æ— æ³•åœ¨å¤šä¸ªé•œåƒä¹‹é—´å…±äº«æ–°å±‚ï¼›è®¾ç½®è¯¥é€‰é¡¹ï¼Œå®é™…ä¸Šæ˜¯åˆ›å»ºäº†æ–°imageï¼ŒåŒæ—¶ä¿ç•™åŸæœ‰imageã€‚--tag, -tï¼Œé•œåƒçš„åå­—åŠtagï¼Œé€šå¸¸name:tagæˆ–è€…nameæ ¼å¼ï¼›å¯ä»¥åœ¨ä¸€æ¬¡æ„å»ºä¸­ä¸ºä¸€ä¸ªé•œåƒè®¾ç½®å¤šä¸ªtag--networkï¼Œé»˜è®¤defaultã€‚è®¾ç½®è¯¥é€‰é¡¹ï¼ŒSet the networking mode for the RUN instructions during build--quiet, -q ï¼Œé»˜è®¤falseã€‚è®¾ç½®è¯¥é€‰é¡¹ï¼ŒSuppress the build output and print image ID on success--force-rmï¼Œé»˜è®¤falseã€‚è®¾ç½®è¯¥é€‰é¡¹ï¼Œæ€»æ˜¯åˆ é™¤æ‰ä¸­é—´ç¯èŠ‚çš„å®¹å™¨--rmï¼Œé»˜è®¤--rm=trueï¼Œå³æ•´ä¸ªæ„å»ºè¿‡ç¨‹æˆåŠŸååˆ é™¤ä¸­é—´ç¯èŠ‚çš„å®¹å™¨2. PATH | URL | -è¯´æ˜ï¼šç»™å‡ºå‘½ä»¤æ‰§è¡Œçš„ä¸Šä¸‹æ–‡ã€‚ä¸Šä¸‹æ–‡å¯ä»¥æ˜¯æ„å»ºæ‰§è¡Œæ‰€åœ¨çš„æœ¬åœ°è·¯å¾„ï¼Œä¹Ÿå¯ä»¥æ˜¯è¿œç¨‹URLï¼Œå¦‚Gitåº“ã€tarballæˆ–æ–‡æœ¬æ–‡ä»¶ç­‰ã€‚å¦‚æœæ˜¯Gitåº“ï¼Œå¦‚https://github.com/docker/rootfs.git#container:dockerï¼Œåˆ™éšå«å…ˆæ‰§è¡Œgit clone --depth 1 --recursiveï¼Œåˆ°æœ¬åœ°ä¸´æ—¶ç›®å½•ï¼›ç„¶åå†å°†è¯¥ä¸´æ—¶ç›®å½•å‘é€ç»™æ„å»ºè¿›ç¨‹ã€‚æ„å»ºé•œåƒçš„è¿›ç¨‹ä¸­ï¼Œå¯ä»¥é€šè¿‡ADDå‘½ä»¤å°†ä¸Šä¸‹æ–‡ä¸­çš„ä»»ä½•æ–‡ä»¶ï¼ˆæ³¨æ„æ–‡ä»¶å¿…é¡»åœ¨ä¸Šä¸‹æ–‡ä¸­ï¼‰åŠ å…¥åˆ°é•œåƒä¸­ã€‚-è¡¨ç¤ºé€šè¿‡STDINç»™å‡ºDockerfileæˆ–ä¸Šä¸‹æ–‡ã€‚ç¤ºä¾‹ï¼š    docker build - &lt; Dockerfileè¯´æ˜ï¼šè¯¥æ„å»ºè¿‡ç¨‹åªæœ‰Dockerfileï¼Œæ²¡æœ‰ä¸Šä¸‹æ–‡    docker build - &lt; context.tar.gzè¯´æ˜ï¼šå…¶ä¸­Dockerfileä½äºcontext.tar.gzçš„æ ¹è·¯å¾„    docker build -t champagne/bbauto:latest -t champagne/bbauto:v2.1 .    docker build -f dockerfiles/Dockerfile.debug -t myapp_debug .2.1ã€ åˆ›å»ºé•œåƒæ‰€åœ¨çš„æ–‡ä»¶å¤¹å’ŒDockerfileæ–‡ä»¶           å‘½ä»¤ï¼š          1ã€mkdir sinatra          2ã€cd sinatra          3ã€touch Dockerfile 2.2ã€ åœ¨Dockerfileæ–‡ä»¶ä¸­å†™å…¥æŒ‡ä»¤ï¼Œæ¯ä¸€æ¡æŒ‡ä»¤éƒ½ä¼šæ›´æ–°é•œåƒçš„ä¿¡æ¯ä¾‹å¦‚ï¼š          # This is a comment          FROM ubuntu:14.04          MAINTAINER tiger tiger@localhost.localdomain         RUN apt-get update &amp;&amp; apt-get install -y ruby ruby-dev          RUN gem install sinatra           æ ¼å¼è¯´æ˜ï¼š           æ¯è¡Œå‘½ä»¤éƒ½æ˜¯ä»¥  INSTRUCTION statement å½¢å¼ï¼Œå°±æ˜¯å‘½ä»¤+ æ¸…å•çš„æ¨¡å¼ã€‚å‘½ä»¤è¦å¤§å†™ï¼Œ&quot;#&quot;æ˜¯æ³¨è§£ã€‚          FROM å‘½ä»¤æ˜¯å‘Šè¯‰docker æˆ‘ä»¬çš„é•œåƒä»€ä¹ˆã€‚          MAINTAINER æ˜¯æè¿° é•œåƒçš„åˆ›å»ºäººã€‚          RUN å‘½ä»¤æ˜¯åœ¨é•œåƒå†…éƒ¨æ‰§è¡Œã€‚å°±æ˜¯è¯´ä»–åé¢çš„å‘½ä»¤åº”è¯¥æ˜¯é’ˆå¯¹é•œåƒå¯ä»¥è¿è¡Œçš„å‘½ä»¤ã€‚  2.3ã€åˆ›å»ºé•œåƒ           å‘½ä»¤ï¼šdocker build -t tiger/sinatra:v2 .          docker build  æ˜¯dockeråˆ›å»ºé•œåƒçš„å‘½ä»¤          -t æ˜¯æ ‡è¯†æ–°å»ºçš„é•œåƒå±äº ouruserçš„           sinatraæ˜¯ä»“åº“çš„åç§°          ï¼šv2 æ˜¯tag           &quot;.&quot;æ˜¯ç”¨æ¥æŒ‡æ˜ æˆ‘ä»¬çš„ä½¿ç”¨çš„Dockerfileæ–‡ä»¶å½“å‰ç›®å½•çš„          è¯¦ç»†æ‰§è¡Œè¿‡ç¨‹ï¼š        [root@master sinatra]# docker build -t tiger/sinatra:v2 .         Sending build context to Docker daemon 2.048 kB        Step 1 : FROM daocloud.io/ubuntu:14.04        Trying to pull repository daocloud.io/ubuntu ...         14.04: Pulling from daocloud.io/ubuntu        f3ead5e8856b: Pull complete         Digest: sha256:ea2b82924b078d9c8b5d3f0db585297a5cd5b9c2f7b60258cdbf9d3b9181d828         ---&gt; 2ff3b426bbaa        Step 2 : MAINTAINER tiger tiger@localhost.localdomain         ---&gt; Running in 948396c9edaa         ---&gt; 227da301bad8        Removing intermediate container 948396c9edaa        Step 3 : RUN apt-get update &amp;&amp; apt-get install -y ruby ruby-dev         ...        Step 4 : RUN gem install sinatra        ---&gt; Running in 89234cb493d9 2.4ã€åˆ›å»ºå®Œæˆåï¼Œä»é•œåƒåˆ›å»ºå®¹å™¨          #docker run -t -i tiger/sinatra:v2 /bin/bash</code></pre><p>Dockerfileåˆ†ä¸ºå››ä¸ªéƒ¨åˆ†: åŸºç¡€é•œåƒä¿¡æ¯ã€ç»´æŠ¤è€…ä¿¡æ¯ã€é•œåƒæ“ä½œæŒ‡ä»¤å’Œå®¹å™¨å¯åŠ¨æŒ‡ä»¤ã€‚ å³FROMã€MAINTAINERã€RUNã€CMDå››ä¸ªéƒ¨åˆ†</p><h5 id="æŒ‡ä»¤è¯´æ˜"><a href="#æŒ‡ä»¤è¯´æ˜" class="headerlink" title="æŒ‡ä»¤è¯´æ˜"></a>æŒ‡ä»¤è¯´æ˜</h5><pre><code>FROM         æŒ‡å®šæ‰€åˆ›å»ºé•œåƒçš„åŸºç¡€é•œåƒMAINTAINER   åˆ¶å®šç»´æŠ¤è€…ä¿¡æ¯RUN          è¿è¡Œå‘½ä»¤CMD          å®¹å™¨å¯åŠ¨æ˜¯é»˜è®¤æ‰§è¡Œçš„å‘½ä»¤LABEL        æŒ‡å®šç”Ÿæˆé•œåƒçš„å…ƒæ•°æ®æ ‡ç­¾ä¿¡æ¯EXPOSE       å£°æ˜é•œåƒå†…æœåŠ¡æ‰€ç›‘å¬çš„ç«¯å£ENV          æŒ‡å®šç¯å¢ƒå˜é‡ADD          å¤åˆ¶æŒ‡å®šsrcè·¯å¾„çš„å†…å®¹åˆ°å®¹å™¨çš„destè·¯å¾„ä¸‹ï¼Œå¦‚æœsrcä¸ºtaræ–‡ä»¶ï¼Œåˆ™è‡ªåŠ¨è§£å‹åˆ°destè·¯å¾„ä¸‹copy         å¤åˆ¶æŒ‡å®šsrcè·¯å¾„çš„å†…å®¹åˆ°é•œåƒçš„destè·¯å¾„ä¸‹ENTERPOINT   æŒ‡å®šé•œåƒçš„é»˜è®¤å…¥å£VOLUME       åˆ›å»ºæ•°æ®å·æŒ‚è½½ç‚¹USER         æŒ‡å®šè¿è¡Œå®¹å™¨æ˜¯çš„ç”¨æˆ·åæˆ–UIDWORKDIR      é…ç½®å·¥ä½œç›®å½•ARG          æŒ‡å®šé•œåƒå†…ä½¿ç”¨çš„å‚æ•°ONBUILD      é…ç½®å½“æ‰€åˆ›å»ºçš„é•œåƒä½œä¸ºå…¶ä»–é•œåƒçš„åŸºç¡€é•œåƒæ—¶ï¼Œæ‰€æ‰§è¡Œåˆ›å»ºæ“ä½œæŒ‡ä»¤STOPSIGAL    å®¹å™¨é€€å‡ºä¿¡å·å€¼HEALTHCHECK  å¦‚ä½•è¿›è¡Œå¥åº·æ£€æŸ¥SHELL        æŒ‡å®šä½¿ç”¨shellçš„é»˜è®¤shellç±»å‹</code></pre><h5 id="nginx-dockerfileç¤ºä¾‹"><a href="#nginx-dockerfileç¤ºä¾‹" class="headerlink" title="nginx-dockerfileç¤ºä¾‹"></a>nginx-dockerfileç¤ºä¾‹</h5><p>vim Dockerfile</p><pre><code>FROM centos:7.2.1511ENV TZ=Asia/ShanghaiRUN yum -y install epel* \    yum -y install gcc openssl openssl-devel  pcre-devel zlib-develADD nginx-1.14.2.tar.gz /opt/WORKDIR /opt/nginx-1.14.2RUN ./configure --prefix=/opt/nginx  --http-log-path=/opt/nginx/logs/access.log --error-log-path=/opt/nginx/logs/error.log --http-client-body-temp-path=/opt/nginx/client/  --http-proxy-temp-path=/opt/nginx/proxy/  --with-http_stub_status_module --with-file-aio --with-http_flv_module --with-http_gzip_static_module --with-stream --with-threads --user=www --group=wwwRUN make &amp;&amp; make installRUN groupadd www &amp;&amp; useradd -g www wwwWORKDIR /opt/nginxRUN rm -rf /opt/nginx-1.14.2ENV NGINX_HOME=/opt/nginxENV PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/opt/nginx/sbinEXPOSE 80 443CMD [&quot;nginx&quot;, &quot;-g&quot;, &quot;daemon off;&quot;]</code></pre><p>éœ€è¦å…ˆä¸‹è½½nginx-1.14.2.tar.gzåœ¨DockerfileåŒçº§ç›®å½•ä¸‹ï¼Œç„¶åæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ docker build -t nginx_image ./Dockerfile</p><h5 id="tomcat-dockerfileç¤ºä¾‹"><a href="#tomcat-dockerfileç¤ºä¾‹" class="headerlink" title="tomcat-dockerfileç¤ºä¾‹"></a>tomcat-dockerfileç¤ºä¾‹</h5><pre><code>FROM centos:7.4.1708ADD jdk-8u171-linux-x64.tar.gz /usr/local/ADD apache-tomcat-7.0.88.tar.gz /usr/local/WORKDIR /usr/local/RUN mv jdk1.8.0_171 jdk &amp;&amp; mv apache-tomcat-7.0.88 tomcatENV JAVA_HOME=/usr/local/jdkENV CLASS_PATH=$JAVA_HOME/lib:$JAVA_HOME/jre/libENV PATH=$JAVA_HOME/bin:$PATHENV CATALINA_HOME /usr/local/tomcatEXPOSE 8080CMD /usr/local/tomcat/bin/catalina.sh run</code></pre><p>éœ€è¦å…ˆä¸‹è½½jdkå’Œtomcatåœ¨dockerfileçš„åŒçº§ç›®å½•ä¸‹ï¼Œç„¶åæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ docker build -t tomcat_image ./Dockerfile</p><h4 id="å®¹å™¨ç½‘ç»œ"><a href="#å®¹å™¨ç½‘ç»œ" class="headerlink" title="å®¹å™¨ç½‘ç»œ"></a>å®¹å™¨ç½‘ç»œ</h4><p><img src="https://i.loli.net/2019/06/10/5cfe19e2a618834176.jpg" alt=""></p><pre><code>å°è§„æ¨¡dockerç¯å¢ƒå¤§éƒ¨åˆ†è¿è¡Œåœ¨å•å°ä¸»æœºä¸Šï¼Œå¦‚æœå…¬å¸å¤§è§„æ¨¡é‡‡ç”¨dockerï¼Œé‚£ä¹ˆå¤šä¸ªå®¿ä¸»æœºä¸Šçš„dockerå¦‚ä½•äº’è”Dockeré»˜è®¤çš„å†…éƒ¨ipä¸º172.17.42.0ç½‘æ®µï¼Œæ‰€ä»¥å¿…é¡»è¦ä¿®æ”¹å…¶ä¸­ä¸€å°çš„é»˜è®¤ç½‘æ®µä»¥å…ipå†²çªã€‚#vim /etc/sysconfig/docker-networkDOCKER_NETWORK_OPTIONS= --bip=172.18.42.1/16#rebootdocker 130ä¸Šï¼š#route add -net 172.18.0.0/16 gw 192.168.18.128docker 128ä¸Šï¼š#route add -net 172.17.0.0/16 gw 192.168.18.130ç°åœ¨ä¸¤å°å®¿ä¸»æœºé‡Œçš„å®¹å™¨å°±å¯ä»¥é€šä¿¡äº†ã€‚</code></pre><h4 id="å®¹å™¨å›ºå®šIP"><a href="#å®¹å™¨å›ºå®šIP" class="headerlink" title="å®¹å™¨å›ºå®šIP"></a>å®¹å™¨å›ºå®šIP</h4><pre><code>dockerå®‰è£…åï¼Œé»˜è®¤ä¼šåˆ›å»ºä¸‰ç§ç½‘ç»œç±»å‹ï¼Œbridgeã€hostå’Œnoneæ˜¾ç¤ºå½“å‰ç½‘ç»œï¼š# docker network listNETWORK ID            NAME                DRIVER              SCOPE90b22f633d2f          bridge              bridge              locale0b365da7fd2          host                host                localda7b7a090837         none                null                localbridge:ç½‘ç»œæ¡¥æ¥é»˜è®¤æƒ…å†µä¸‹å¯åŠ¨ã€åˆ›å»ºå®¹å™¨éƒ½æ˜¯ç”¨è¯¥æ¨¡å¼ï¼Œæ‰€ä»¥æ¯æ¬¡dockerå®¹å™¨é‡å¯æ—¶ä¼šæŒ‰ç…§é¡ºåºè·å–å¯¹åº”ipåœ°å€ï¼Œè¿™å°±å¯¼è‡´å®¹å™¨æ¯æ¬¡é‡å¯ï¼Œipéƒ½å‘ç”Ÿå˜åŒ–noneï¼šæ— æŒ‡å®šç½‘ç»œå¯åŠ¨å®¹å™¨æ—¶ï¼Œå¯ä»¥é€šè¿‡â€“network=none,dockerå®¹å™¨ä¸ä¼šåˆ†é…å±€åŸŸç½‘iphostï¼šä¸»æœºç½‘ç»œdockerå®¹å™¨çš„ç½‘ç»œä¼šé™„å±åœ¨ä¸»æœºä¸Šï¼Œä¸¤è€…æ˜¯äº’é€šçš„ã€‚åˆ›å»ºå›ºå®šipå®¹å™¨1ã€åˆ›å»ºè‡ªå®šä¹‰ç½‘ç»œç±»å‹ï¼Œå¹¶ä¸”æŒ‡å®šç½‘æ®µ#docker network create --subnet=192.168.0.0/16 staticneté€šè¿‡docker network lså¯ä»¥æŸ¥çœ‹åˆ°ç½‘ç»œç±»å‹ä¸­å¤šäº†ä¸€ä¸ªstaticnet2ã€ä½¿ç”¨æ–°çš„ç½‘ç»œç±»å‹åˆ›å»ºå¹¶å¯åŠ¨å®¹å™¨#docker run -it --name userserver --net staticnet --ip 192.168.0.2 centos:6 /bin/bashé€šè¿‡docker inspectå¯ä»¥æŸ¥çœ‹å®¹å™¨ipä¸º192.168.0.2ï¼Œå…³é—­å®¹å™¨å¹¶é‡å¯ï¼Œå‘ç°å®¹å™¨ipå¹¶æœªå‘ç”Ÿæ”¹å˜</code></pre>]]></content>
      
      
      <categories>
          
          <category> å®¹å™¨ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>zabbix-å¾®ä¿¡æŠ¥è­¦è®¾ç½®</title>
      <link href="2019/11/05/jian-kong/zabbix/zabbix-pei-zhi-qi-ye-wei-xin-bao-jing/"/>
      <url>2019/11/05/jian-kong/zabbix/zabbix-pei-zhi-qi-ye-wei-xin-bao-jing/</url>
      
        <content type="html"><![CDATA[<h2 id="zabbix-å¾®ä¿¡æŠ¥è­¦è®¾ç½®"><a href="#zabbix-å¾®ä¿¡æŠ¥è­¦è®¾ç½®" class="headerlink" title="zabbix å¾®ä¿¡æŠ¥è­¦è®¾ç½®"></a>zabbix å¾®ä¿¡æŠ¥è­¦è®¾ç½®</h2><h4 id="ä¸€ã€ä¸»è¦è·å–ä¸‰ä¸ªå‚æ•°-ä¼ä¸šIDã€ç”¨æˆ·è´¦å·ã€AgentId-å’ŒSecretï¼š"><a href="#ä¸€ã€ä¸»è¦è·å–ä¸‰ä¸ªå‚æ•°-ä¼ä¸šIDã€ç”¨æˆ·è´¦å·ã€AgentId-å’ŒSecretï¼š" class="headerlink" title="ä¸€ã€ä¸»è¦è·å–ä¸‰ä¸ªå‚æ•°:ä¼ä¸šIDã€ç”¨æˆ·è´¦å·ã€AgentId,å’ŒSecretï¼š"></a>ä¸€ã€ä¸»è¦è·å–ä¸‰ä¸ªå‚æ•°:ä¼ä¸šIDã€ç”¨æˆ·è´¦å·ã€AgentId,å’ŒSecretï¼š</h4><h5 id="1-è·å–ä¼ä¸šID"><a href="#1-è·å–ä¼ä¸šID" class="headerlink" title="1.è·å–ä¼ä¸šID"></a>1.è·å–ä¼ä¸šID</h5><p><img src="https://s1.ax1x.com/2020/04/24/J0OeUI.png" alt="J0OeUI.png"></p><h5 id="2-è·å–AgentId-å’ŒSecret3"><a href="#2-è·å–AgentId-å’ŒSecret3" class="headerlink" title="2.è·å–AgentId,å’ŒSecret3"></a>2.è·å–AgentId,å’ŒSecret3</h5><p>è¿™é‡Œè¦å…ˆç‚¹é€šè®¯å½•åˆ›å»ºä¸€ä¸ªéƒ¨é—¨ï¼Œç„¶åå†ç‚¹åº”ç”¨å°ç¨‹åºåˆ›å»ºåº”ç”¨ï¼Œå¡«å†™logoã€åç§°ã€å’Œé€‰æ‹©éƒ¨é—¨å°±å¯ä»¥äº†</p><p><a href="https://imgchr.com/i/J0Om5t" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2020/04/24/J0Om5t.png" alt="J0Om5t.png"></a></p><h5 id="3-è·å–ç”¨æˆ·è´¦å·"><a href="#3-è·å–ç”¨æˆ·è´¦å·" class="headerlink" title="3.è·å–ç”¨æˆ·è´¦å·"></a>3.è·å–ç”¨æˆ·è´¦å·</h5><p><img src="https://s1.ax1x.com/2020/04/24/J0OYan.png" alt="J0OYan.png"></p><p><img src="https://s1.ax1x.com/2020/04/24/J0OaGV.png" alt="J0OaGV.png"></p><h5 id="4-æµ‹è¯•gentId-å’ŒSecret"><a href="#4-æµ‹è¯•gentId-å’ŒSecret" class="headerlink" title="4.æµ‹è¯•gentId,å’ŒSecret"></a>4.æµ‹è¯•gentId,å’ŒSecret</h5><p>è¿™ä¸ªæ˜¯æ¥å£è°ƒç”¨æµ‹è¯•gentId,å’ŒSecretçš„åœ°å€ï¼š<a href="https://work.weixin.qq.com/api/devtools/devtool.php" target="_blank" rel="noopener">https://work.weixin.qq.com/api/devtools/devtool.php</a></p><p>è¿™é‡Œçœ‹åˆ°æœ‰HTTP/1.1 200 OK å°±è¯´æ˜æ¥å£æœ‰æ•ˆäº†ï¼Œå…¶å®ƒçš„ä¸ç®¡ã€‚</p><p><img src="https://s1.ax1x.com/2020/04/24/J0OyZ9.png" alt="J0OyZ9.png"></p><p><img src="https://s1.ax1x.com/2020/04/24/J0O2Px.png" alt="J0O2Px.png"></p><h4 id="äºŒã€è°ƒç”¨çš„shellè„šæœ¬æ–¹å¼ï¼Œè„šæœ¬å¦‚ä¸‹ï¼š"><a href="#äºŒã€è°ƒç”¨çš„shellè„šæœ¬æ–¹å¼ï¼Œè„šæœ¬å¦‚ä¸‹ï¼š" class="headerlink" title="äºŒã€è°ƒç”¨çš„shellè„šæœ¬æ–¹å¼ï¼Œè„šæœ¬å¦‚ä¸‹ï¼š"></a>äºŒã€è°ƒç”¨çš„shellè„šæœ¬æ–¹å¼ï¼Œè„šæœ¬å¦‚ä¸‹ï¼š</h4><h6 id="è¿™é‡Œè¦æ³¨æ„çš„æ˜¯å¡«å†™æ­£ç¡®çš„é€šè®¯å½•-éƒ¨é—¨IDï¼Œå¯ä»¥ç‚¹é‚£ä¸ªä¸‹çº¿ä¸‰ä¸ªç‚¹é‚£é‡Œã€‚"><a href="#è¿™é‡Œè¦æ³¨æ„çš„æ˜¯å¡«å†™æ­£ç¡®çš„é€šè®¯å½•-éƒ¨é—¨IDï¼Œå¯ä»¥ç‚¹é‚£ä¸ªä¸‹çº¿ä¸‰ä¸ªç‚¹é‚£é‡Œã€‚" class="headerlink" title="è¿™é‡Œè¦æ³¨æ„çš„æ˜¯å¡«å†™æ­£ç¡®çš„é€šè®¯å½• éƒ¨é—¨IDï¼Œå¯ä»¥ç‚¹é‚£ä¸ªä¸‹çº¿ä¸‰ä¸ªç‚¹é‚£é‡Œã€‚"></a>è¿™é‡Œè¦æ³¨æ„çš„æ˜¯å¡«å†™æ­£ç¡®çš„é€šè®¯å½• éƒ¨é—¨IDï¼Œå¯ä»¥ç‚¹é‚£ä¸ªä¸‹çº¿ä¸‰ä¸ªç‚¹é‚£é‡Œã€‚</h6><p><img src="https://s1.ax1x.com/2020/04/24/J0O7dA.png" alt="J0O7dA.png"></p><pre class=" language-shell"><code class="language-shell">[root@cyy alertscripts]# vim wechat.sh#!/usr/bin/env bash#!/usr/bin/env bash## Author: cyylog# Email: cyylog@aliyun.com# Date: 2019/09/25# Github:    https://github.com/cyylog# Usage:    Wechat alert script for zabbix# if [ $# -eq 0 ] || [[ "$1" == "-h" || "$1" == "--help" ]];then        echo "Usage of $0:"        echo -e " --CorpID=string"        echo -e " --Secret=string"        echo -e " --AgentID=string"        echo -e " --UserID=string"        echo -e " --Msg=string"        exitfi#ops=(-c -s -a -u)#args=(CorpID Secret AgentID UserID)#while [ $# -gt 0 ];do#    [ "$1" == "-m" ] && Msg="$2" && shift 2#    for i in {0..3};do#        [ "$1" == "${ops[i]}" ] &&  eval ${args[i]}="$2"#    done#    shift 2#donefor i in "$@";do        echo $i|grep Msg &> /dev/null && msg=$(echo $i|sed 's/.*=//') && Msg="$msg" && continue        eval "$(echo $i|sed 's/--//')"done#echo $CorpID#echo $Secret#echo $UserID#echo $AgentID#echo $Msg#GURL="https://qyapi.weixin.qq.com/cgi-bin/gettoken?corpid=$CorpID&corpsecret=$Secret"Token=$(/usr/bin/curl -s -G $GURL |awk -F \" '{print $10}')PURL="https://qyapi.weixin.qq.com/cgi-bin/message/send?access_token=$Token"Info(){        printf '{\n'        printf '\t"touser": "'"$UserID"\"",\n"        printf '\t"msgtype": "text",\n'        printf '\t"agentid": "'"$AgentID"\"",\n"        printf '\t"text": {\n'        printf '\t\t"content": "'"$Msg"\""\n"        printf '\t},\n'        printf '\t"safe":"0"\n'        printf '}\n'}/usr/bin/curl --data-ascii "$(Info)" $PURLecho[root@cyy alertscripts]# chmod +x wechat.sh[root@cyy alertscripts]# ./wechat.sh  "è¿™é‡Œä¸€ä¸ªæµ‹è¯•"     //å¯ä»¥è¿™æ ·ç›´æ¥è°ƒè¯•ï¼Œç„¶åç™»é™†åˆ°ä¼ä¸šå¾®ä¿¡æŸ¥çœ‹è¯¥éƒ¨é—¨çš„ç¾¤æˆå‘˜æ˜¯å¦æ”¶åˆ°æ­¤ä¿¡æ¯è„šæœ¬æµ‹è¯•é€šè¿‡åå°±æ˜¯åœ¨zabbixæ§åˆ¶å°ä¸Šè®¾ç½®äº†</code></pre><h4 id="ä¸‰ã€zabbix-æ§åˆ¶å°æ·»åŠ æ–°åª’ä½“"><a href="#ä¸‰ã€zabbix-æ§åˆ¶å°æ·»åŠ æ–°åª’ä½“" class="headerlink" title="ä¸‰ã€zabbix æ§åˆ¶å°æ·»åŠ æ–°åª’ä½“"></a>ä¸‰ã€zabbix æ§åˆ¶å°æ·»åŠ æ–°åª’ä½“</h4><h5 id="1-ç‚¹ç®¡ç†-gt-æŠ¥è­¦åª’ä»‹ç±»å‹-gt-åˆ›å»ºåª’ä»‹ç±»å‹"><a href="#1-ç‚¹ç®¡ç†-gt-æŠ¥è­¦åª’ä»‹ç±»å‹-gt-åˆ›å»ºåª’ä»‹ç±»å‹" class="headerlink" title="1.ç‚¹ç®¡ç† -&gt; æŠ¥è­¦åª’ä»‹ç±»å‹ -&gt; åˆ›å»ºåª’ä»‹ç±»å‹"></a>1.ç‚¹ç®¡ç† -&gt; æŠ¥è­¦åª’ä»‹ç±»å‹ -&gt; åˆ›å»ºåª’ä»‹ç±»å‹</h5><p><a href="https://imgchr.com/i/J0X1W6" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2020/04/24/J0X1W6.png" alt="J0X1W6.png"></a></p><pre class=" language-shell"><code class="language-shell">--AgentID=1000002--CorpID=ww74c********56c    --Secret=-c-3Xw*****************j-Zj6cw--Msg={ALERT.MESSAGE}--UserID={ALERT.SENDTO}</code></pre><h5 id="2-ç„¶åå†è®¾ç½®ä¸Šç”¨æˆ·ï¼šç‚¹ç®¡ç†-â€”-gt-åˆ›å»ºç”¨æˆ·ï¼ˆå¾®ä¿¡æŠ¥è­¦çš„ç”¨æˆ·ï¼‰"><a href="#2-ç„¶åå†è®¾ç½®ä¸Šç”¨æˆ·ï¼šç‚¹ç®¡ç†-â€”-gt-åˆ›å»ºç”¨æˆ·ï¼ˆå¾®ä¿¡æŠ¥è­¦çš„ç”¨æˆ·ï¼‰" class="headerlink" title="2.ç„¶åå†è®¾ç½®ä¸Šç”¨æˆ·ï¼šç‚¹ç®¡ç† â€”&gt; åˆ›å»ºç”¨æˆ·ï¼ˆå¾®ä¿¡æŠ¥è­¦çš„ç”¨æˆ·ï¼‰"></a>2.ç„¶åå†è®¾ç½®ä¸Šç”¨æˆ·ï¼šç‚¹ç®¡ç† â€”&gt; åˆ›å»ºç”¨æˆ·ï¼ˆå¾®ä¿¡æŠ¥è­¦çš„ç”¨æˆ·ï¼‰</h5><p><img src="https://s1.ax1x.com/2020/04/24/J0XYOe.png" alt="J0XYOe.png"></p><h5 id="3-å†ç‚¹ç”¨æˆ·æ—è¾¹çš„-æŠ¥è­¦åª’ä»‹-è¿›è¡Œè®¾ç½®ï¼ˆæ”¶ä»¶äººè¦å¡«å†™ç”¨æˆ·çš„è´¦å·ï¼‰"><a href="#3-å†ç‚¹ç”¨æˆ·æ—è¾¹çš„-æŠ¥è­¦åª’ä»‹-è¿›è¡Œè®¾ç½®ï¼ˆæ”¶ä»¶äººè¦å¡«å†™ç”¨æˆ·çš„è´¦å·ï¼‰" class="headerlink" title="3.å†ç‚¹ç”¨æˆ·æ—è¾¹çš„ æŠ¥è­¦åª’ä»‹ è¿›è¡Œè®¾ç½®ï¼ˆæ”¶ä»¶äººè¦å¡«å†™ç”¨æˆ·çš„è´¦å·ï¼‰"></a>3.å†ç‚¹ç”¨æˆ·æ—è¾¹çš„ æŠ¥è­¦åª’ä»‹ è¿›è¡Œè®¾ç½®ï¼ˆæ”¶ä»¶äººè¦å¡«å†™ç”¨æˆ·çš„è´¦å·ï¼‰</h5><p><strong>ç¬¬ä¸€æ­¥çš„ç¬¬3ç‚¹è·å–çš„è´¦å·</strong></p><p><img src="https://s1.ax1x.com/2020/04/24/J0XaTA.png" alt="J0XaTA.png"></p><h6 id="åˆ°è¿™é‡Œå°±åŸºæœ¬éƒ½è®¾ç½®å®Œæˆäº†ï¼Œå¯ä»¥è®¾ç½®ä¸ªè§¦å‘å™¨å’ŒåŠ¨ä½œæ¥æµ‹è¯•è„šæœ¬ã€‚"><a href="#åˆ°è¿™é‡Œå°±åŸºæœ¬éƒ½è®¾ç½®å®Œæˆäº†ï¼Œå¯ä»¥è®¾ç½®ä¸ªè§¦å‘å™¨å’ŒåŠ¨ä½œæ¥æµ‹è¯•è„šæœ¬ã€‚" class="headerlink" title="åˆ°è¿™é‡Œå°±åŸºæœ¬éƒ½è®¾ç½®å®Œæˆäº†ï¼Œå¯ä»¥è®¾ç½®ä¸ªè§¦å‘å™¨å’ŒåŠ¨ä½œæ¥æµ‹è¯•è„šæœ¬ã€‚"></a>åˆ°è¿™é‡Œå°±åŸºæœ¬éƒ½è®¾ç½®å®Œæˆäº†ï¼Œå¯ä»¥è®¾ç½®ä¸ªè§¦å‘å™¨å’ŒåŠ¨ä½œæ¥æµ‹è¯•è„šæœ¬ã€‚</h6>]]></content>
      
      
      <categories>
          
          <category> ç›‘æ§ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> zabbix </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ­å»ºGitlab</title>
      <link href="2019/10/05/devops/da-jian-gitlab/"/>
      <url>2019/10/05/devops/da-jian-gitlab/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><p>Gitlab Server éƒ¨ç½²</p><h3 id="1ã€ç¯å¢ƒå‡†å¤‡"><a href="#1ã€ç¯å¢ƒå‡†å¤‡" class="headerlink" title="1ã€ç¯å¢ƒå‡†å¤‡"></a>1ã€ç¯å¢ƒå‡†å¤‡</h3><pre><code>1.ç³»ç»Ÿç‰ˆæœ¬ï¼šCentOS7.42.Gitlabç‰ˆæœ¬ï¼šgitlab-ee 11.0.13.åˆå§‹åŒ–ç³»ç»Ÿç¯å¢ƒ4.å…³é—­é˜²ç«å¢™[root@localhost ~]#  systemctl stop iptables firewalld[root@localhost ~]#  systemctl disable iptables firewalld5.å¼€å¯é‚®ä»¶æœåŠ¡[root@vm1 ~]# systemctl start postfix[root@vm1 ~]# systemctl enable postfix6.å…³é—­SELinux[root@localhost ~]#  sed -ri &#39;/SELINUX=/cSELINUX=disabled&#39; /etc/selinux/config[root@localhost ~]#  setenforce 0           # ä¸´æ—¶å…³é—­SELinux[root@localhost ~]#  reboot</code></pre><h3 id="2ã€éƒ¨ç½²Gitlab"><a href="#2ã€éƒ¨ç½²Gitlab" class="headerlink" title="2ã€éƒ¨ç½²Gitlab"></a>2ã€éƒ¨ç½²Gitlab</h3><pre><code>1.å®‰è£…Gitlabç¤¾åŒºç‰ˆ/ä¼ä¸šç‰ˆ2.å®‰è£…gitlabä¾èµ–åŒ…[root@localhost ~]# yum install -y curl openssh-server openssh-clients postfix cronie policycoreutils-python# gitlab-ce 10.x.xä»¥åçš„ç‰ˆæœ¬éœ€è¦ä¾èµ–policycoreutils-python3.å¼€å¯postfixï¼Œå¹¶è®¾ç½®å¼€æœºè‡ªå¯[root@localhost ~]# systemctl start postfix;systemctl enable postfix4.é€‰æ‹©æ·»åŠ yumæºå®‰è£…gitlab(æ ¹æ®éœ€æ±‚é…ç½®æº)ï¼ˆ1ï¼‰æ·»åŠ é˜¿é‡Œæº# vim /etc/yum.repos.d/gitlab-ce.repo[gitlab-ce]name=gitlab-cebaseurl=http://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el7Repo_gpgcheck=0Enabled=1Gpgkey=https://packages.gitlab.com/gpg.keyï¼ˆ2ï¼‰ æ·»åŠ æ¸…åæº# vim gitlab-ce.repo[gitlab-ce]name=Gitlab CE Repositorybaseurl=https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el$releasever/gpgcheck=0enabled=1# vim gitlab-ee.repo[gitlab-ee]name=Gitlab EE Repositorybaseurl=https://mirrors.tuna.tsinghua.edu.cn/gitlab-ee/yum/el$releasever/gpgcheck=0enabled=1# vim runner_gitlab-ci-multi-runner.repo[runner_gitlab-ci-multi-runner]name=runner_gitlab-ci-multi-runnerbaseurl=https://packages.gitlab.com/runner/gitlab-ci-multi-runner/el/7/$basearchrepo_gpgcheck=1gpgcheck=0enabled=1gpgkey=https://packages.gitlab.com/runner/gitlab-ci-multi-runner/gpgkeysslverify=1sslcacert=/etc/pki/tls/certs/ca-bundle.crtmetadata_expire=300[runner_gitlab-ci-multi-runner-source]name=runner_gitlab-ci-multi-runner-sourcebaseurl=https://packages.gitlab.com/runner/gitlab-ci-multi-runner/el/7/SRPMSrepo_gpgcheck=1gpgcheck=0enabled=1gpgkey=https://packages.gitlab.com/runner/gitlab-ci-multi-runner/gpgkeysslverify=1sslcacert=/etc/pki/tls/certs/ca-bundle.crtmetadata_expire=300(3) æ·»åŠ å®˜æ–¹æºcurl https://packages.gitlab.com/install/repositories/gitlab/gitlab-ee/script.rpm.sh | sudo bash5.å®‰è£…åŒ…ä¸‹è½½https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el7/https://mirrors.tuna.tsinghua.edu.cn/gitlab-ee/yum/el7/6.æ ¹æ®éœ€è¦é€‰æ‹©ce/ee[root@localhost ~]# yum -y install gitlab-ce                    # è‡ªåŠ¨å®‰è£…æœ€æ–°ç‰ˆ[root@localhost ~]# yum -y install gitlab-ce-x.x.x              # å®‰è£…æŒ‡å®šç‰ˆæœ¬Gitlab[root@localhost ~]# yum -y install gitlab-ce warning: gitlab-ce-10.7.2-ce.0.el7.x86_64.rpm: Header V4 RSA/SHA1 Signature, key ID f27eab47: NOKEYPreparing...                          ################################# [100%]Updating / installing...   1:gitlab-ce-10.7.2-ce.0.el7        ################################# [100%]It looks like GitLab has not been configured yet; skipping the upgrade script.       *.                  *.      ***                 ***     *****               *****    .******             *******    ********            ********   ,,,,,,,,,***********,,,,,,,,,  ,,,,,,,,,,,*********,,,,,,,,,,,  .,,,,,,,,,,,*******,,,,,,,,,,,,      ,,,,,,,,,*****,,,,,,,,,.         ,,,,,,,****,,,,,,            .,,,***,,,,                ,*,.     _______ __  __          __    / ____(_) /_/ /   ____ _/ /_   / / __/ / __/ /   / __ `/ __ \  / /_/ / / /_/ /___/ /_/ / /_/ /  \____/_/\__/_____/\__,_/_.___/Thank you for installing GitLab!GitLab was unable to detect a valid hostname for your instance.Please configure a URL for your GitLab instance by setting `external_url`configuration in /etc/gitlab/gitlab.rb file.Then, you can start your GitLab instance by running the following command:  sudo gitlab-ctl reconfigureFor a comprehensive list of configuration options please see the Omnibus GitLab readmehttps://gitlab.com/gitlab-org/omnibus-gitlab/blob/master/README.md</code></pre><p>###3ã€é…ç½® Gitlab</p><h4 id="1ã€æŸ¥çœ‹Gitlabç‰ˆæœ¬"><a href="#1ã€æŸ¥çœ‹Gitlabç‰ˆæœ¬" class="headerlink" title="1ã€æŸ¥çœ‹Gitlabç‰ˆæœ¬"></a>1ã€æŸ¥çœ‹Gitlabç‰ˆæœ¬</h4><pre><code>[root@localhost ~]# head -1 /opt/gitlab/version-manifest.txtgitlab-ce 10.1.1</code></pre><h4 id="2ã€Gitlab-é…ç½®æ–‡ç™»å½•é“¾æ¥"><a href="#2ã€Gitlab-é…ç½®æ–‡ç™»å½•é“¾æ¥" class="headerlink" title="2ã€Gitlab é…ç½®æ–‡ç™»å½•é“¾æ¥"></a>2ã€Gitlab é…ç½®æ–‡ç™»å½•é“¾æ¥</h4><pre><code>#è®¾ç½®ç™»å½•é“¾æ¥[root@localhost ~]# vim /etc/gitlab/gitlab.rb***## GitLab URL##! URL on which GitLab will be reachable.##! For more details on configuring external_url see:##! https://docs.gitlab.com/omnibus/settings/configuration.html#configuring-the-external-url-for-gitlab# æ²¡æœ‰åŸŸåï¼Œå¯ä»¥è®¾ç½®ä¸ºæœ¬æœºIPåœ°å€external_url &#39;http://172.17.0.61&#39;***[root@localhost ~]# grep &quot;^external_url&quot; /etc/gitlab/gitlab.rbexternal_url &#39;http://172.17.0.61&#39;     #ç»‘å®šç›‘å¬çš„åŸŸåæˆ–IP</code></pre><h4 id="3ã€åˆå§‹åŒ–-Gitlab-ç¬¬ä¸€æ¬¡ä½¿ç”¨é…ç½®æ—¶é—´è¾ƒé•¿"><a href="#3ã€åˆå§‹åŒ–-Gitlab-ç¬¬ä¸€æ¬¡ä½¿ç”¨é…ç½®æ—¶é—´è¾ƒé•¿" class="headerlink" title="3ã€åˆå§‹åŒ– Gitlab (ç¬¬ä¸€æ¬¡ä½¿ç”¨é…ç½®æ—¶é—´è¾ƒé•¿)"></a>3ã€åˆå§‹åŒ– Gitlab (ç¬¬ä¸€æ¬¡ä½¿ç”¨é…ç½®æ—¶é—´è¾ƒé•¿)</h4><pre><code> [root@localhost ~]# gitlab-ctl reconfigure   .....</code></pre><h4 id="4ã€å¯åŠ¨-Gitlab-æœåŠ¡"><a href="#4ã€å¯åŠ¨-Gitlab-æœåŠ¡" class="headerlink" title="4ã€å¯åŠ¨ Gitlab æœåŠ¡"></a>4ã€å¯åŠ¨ Gitlab æœåŠ¡</h4><pre><code>[root@vm1 ~]# gitlab-ctl startok: run: gitaly: (pid 22896) 2922sok: run: gitlab-monitor: (pid 22914) 2921sok: run: gitlab-workhorse: (pid 22882) 2922sok: run: logrotate: (pid 22517) 2987sok: run: nginx: (pid 22500) 2993sok: run: node-exporter: (pid 22584) 2974sok: run: postgres-exporter: (pid 22946) 2919sok: run: postgresql: (pid 22250) 3047sok: run: prometheus: (pid 22931) 2920sok: run: redis: (pid 22190) 3053sok: run: redis-exporter: (pid 22732) 2962sok: run: sidekiq: (pid 22472) 3005sok: run: unicorn: (pid 22433) 3011s[root@vm1 ~]# [root@vm1 ~]# lsof -i:80COMMAND   PID       USER   FD   TYPE DEVICE SIZE/OFF NODE NAMEnginx   22500       root    7u  IPv4  50923      0t0  TCP *:http (LISTEN)nginx   22501 gitlab-www    7u  IPv4  50923      0t0  TCP *:http (LISTEN)[root@vm1 ~]# </code></pre><h4 id="5ã€Gitlab-è®¾ç½®-HTTPS-æ–¹å¼"><a href="#5ã€Gitlab-è®¾ç½®-HTTPS-æ–¹å¼" class="headerlink" title="5ã€Gitlab è®¾ç½® HTTPS æ–¹å¼"></a>5ã€Gitlab è®¾ç½® HTTPS æ–¹å¼</h4><pre><code>å¦‚æœæƒ³è¦ä»¥ä¸Šçš„ https æ–¹å¼æ­£å¸¸ç”Ÿæ•ˆä½¿ç”¨ï¼Œåˆ™éœ€è¦æŠŠ letsencrypt è‡ªåŠ¨ç”Ÿæˆè¯ä¹¦çš„é…ç½®æ‰“å¼€ï¼Œè¿™æ ·åœ¨æ‰§è¡Œé‡æ–°è®©é…ç½®ç”Ÿæ•ˆå‘½ä»¤ (gitlab-ctl reconfigure) çš„æ—¶å€™ä¼šè‡ªåŠ¨ç»™åŸŸåç”Ÿæˆå…è´¹çš„è¯ä¹¦å¹¶è‡ªåŠ¨åœ¨ gitlab è‡ªå¸¦çš„ nginx ä¸­åŠ ä¸Šç›¸å…³çš„è·³è½¬é…ç½®ï¼Œéƒ½æ˜¯å…¨è‡ªåŠ¨çš„ï¼Œéå¸¸æ–¹ä¾¿ã€‚letsencrypt[&#39;enable&#39;] = true letsencrypt[&#39;contact_emails&#39;] = [&#39;caryyu@qq.com&#39;]     # è¿™åº”è¯¥æ˜¯ä¸€ç»„è¦æ·»åŠ ä¸ºè”ç³»äººçš„ç”µå­é‚®ä»¶åœ°å€</code></pre><h4 id="6ã€Gitlab-æ·»åŠ smtpé‚®ä»¶åŠŸèƒ½"><a href="#6ã€Gitlab-æ·»åŠ smtpé‚®ä»¶åŠŸèƒ½" class="headerlink" title="6ã€Gitlab æ·»åŠ smtpé‚®ä»¶åŠŸèƒ½"></a>6ã€Gitlab æ·»åŠ smtpé‚®ä»¶åŠŸèƒ½</h4><pre><code>[root@vm1 ~]# vim /etc/gitlab/gitlab.rbpostfix å¹¶éå¿…é¡»çš„ï¼›æ ¹æ®å…·ä½“æƒ…å†µé…ç½®ï¼Œä»¥ SMTP çš„ä¸ºä¾‹é…ç½®é‚®ä»¶æœåŠ¡å™¨æ¥å®ç°é€šçŸ¥ï¼›å‚è€ƒé…ç½®å¦‚ä¸‹ï¼š ### Email Settings  gitlab_rails[&#39;gitlab_email_enabled&#39;] = true  gitlab_rails[&#39;gitlab_email_from&#39;] = &#39;system.notice@qq.com&#39;  gitlab_rails[&#39;gitlab_email_display_name&#39;] = &#39;gitlab.notice&#39;  gitlab_rails[&#39;gitlab_email_reply_to&#39;] = &#39;system.notice@qq.com&#39;  gitlab_rails[&#39;gitlab_email_subject_suffix&#39;] = &#39;gitlab&#39;  ### GitLab email server settings ###! Docs: https://docs.gitlab.com/omnibus/settings/smtp.html ###! **Use smtp instead of sendmail/postfix.**   gitlab_rails[&#39;smtp_enable&#39;] = true  gitlab_rails[&#39;smtp_address&#39;] = &quot;smtp.qq.com&quot;  gitlab_rails[&#39;smtp_port&#39;] = 465  gitlab_rails[&#39;smtp_user_name&#39;] = &quot;system.notice@qq.com&quot;  gitlab_rails[&#39;smtp_password&#39;] = &quot;xxxxx&quot;  gitlab_rails[&#39;smtp_domain&#39;] = &quot;qq.com&quot;  gitlab_rails[&#39;smtp_authentication&#39;] = &quot;login&quot;  gitlab_rails[&#39;smtp_enable_starttls_auto&#39;] = true  gitlab_rails[&#39;smtp_tls&#39;] = true[root@vm1 ~]# grep -P &quot;^[^#].*smtp_|user_email|gitlab_email&quot; /etc/gitlab/gitlab.rbgitlab_rails[&#39;gitlab_email_enabled&#39;] = truegitlab_rails[&#39;gitlab_email_from&#39;] = &#39;username@domain.cn&#39;gitlab_rails[&#39;gitlab_email_display_name&#39;] = &#39;Admin&#39;gitlab_rails[&#39;gitlab_email_reply_to&#39;] = &#39;usernamei@domain.cn&#39;gitlab_rails[&#39;gitlab_email_subject_suffix&#39;] = &#39;[gitlab]&#39;gitlab_rails[&#39;smtp_enable&#39;] = truegitlab_rails[&#39;smtp_address&#39;] = &quot;smtp.exmail.qq.com&quot;gitlab_rails[&#39;smtp_port&#39;] = 25 gitlab_rails[&#39;smtp_user_name&#39;] = &quot;username@domain.cn&quot;gitlab_rails[&#39;smtp_password&#39;] = &quot;password&quot;gitlab_rails[&#39;smtp_domain&#39;] = &quot;domain.cn&quot;gitlab_rails[&#39;smtp_authentication&#39;] = &quot;login&quot;gitlab_rails[&#39;smtp_enable_starttls_auto&#39;] = truegitlab_rails[&#39;smtp_tls&#39;] = falseuser[&#39;git_user_email&#39;] = &quot;username@domain.cn&quot;[root@vm1 ~]# gitlab-ctl reconfigure  #ä¿®æ”¹é…ç½®åéœ€è¦åˆå§‹åŒ–é…ç½®......[root@vm1 ~]# gitlab-ctl stopok: down: gitaly: 0s, normally upok: down: gitlab-monitor: 1s, normally upok: down: gitlab-workhorse: 0s, normally upok: down: logrotate: 1s, normally upok: down: nginx: 0s, normally upok: down: node-exporter: 1s, normally upok: down: postgres-exporter: 0s, normally upok: down: postgresql: 0s, normally upok: down: prometheus: 0s, normally upok: down: redis: 0s, normally upok: down: redis-exporter: 1s, normally upok: down: sidekiq: 0s, normally upok: down: unicorn: 1s, normally up[root@vm1 ~]# gitlab-ctl startok: run: gitaly: (pid 37603) 0sok: run: gitlab-monitor: (pid 37613) 0sok: run: gitlab-workhorse: (pid 37625) 0sok: run: logrotate: (pid 37631) 0sok: run: nginx: (pid 37639) 1sok: run: node-exporter: (pid 37644) 0sok: run: postgres-exporter: (pid 37648) 1sok: run: postgresql: (pid 37652) 0sok: run: prometheus: (pid 37660) 1sok: run: redis: (pid 37668) 0sok: run: redis-exporter: (pid 37746) 0sok: run: sidekiq: (pid 37750) 1sok: run: unicorn: (pid 37757) 0s</code></pre><h4 id="7ã€Gitlab-å‘é€é‚®ä»¶æµ‹è¯•"><a href="#7ã€Gitlab-å‘é€é‚®ä»¶æµ‹è¯•" class="headerlink" title="7ã€Gitlab å‘é€é‚®ä»¶æµ‹è¯•"></a>7ã€Gitlab å‘é€é‚®ä»¶æµ‹è¯•</h4><pre><code>[root@vm1 ~]# gitlab-rails console Loading production environment (Rails 4.2.10)irb(main):001:0&gt;  Notify.test_email(&#39;user@destination.com&#39;, &#39;Message Subject&#39;, &#39;Message Body&#39;).deliver_nowNotify#test_email: processed outbound mail in 2219.5msSent mail to user@destination.com (2469.5ms)Date: Fri, 04 May 2018 15:50:10 +0800From: Admin &lt;username@domain.cn&gt;Reply-To: Admin &lt;username@domain.cn&gt;To: user@destination.comMessage-ID: &lt;5aec10b24cfaa_93933fee282db10c162d@vm1.mail&gt;Subject: Message SubjectMime-Version: 1.0Content-Type: text/html; charset=UTF-8Content-Transfer-Encoding: 7bitAuto-Submitted: auto-generatedX-Auto-Response-Suppress: All&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD HTML 4.0 Transitional//EN&quot; &quot;http://www.w3.org/TR/REC-html40/loose.dtd&quot;&gt;&lt;html&gt;&lt;body&gt;&lt;p&gt;Message Body&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;=&gt; #&lt;Mail::Message:70291731344240, Multipart: false, Headers: &lt;Date: Fri, 04 May 2018 15:50:10 +0800&gt;, &lt;From: Admin &lt;username@domain.cn&gt;&gt;, &lt;Reply-To: Admin &lt;username@domain.cn&gt;&gt;, &lt;To: user@destination.com&gt;, &lt;Message-ID: &lt;5aec10b24cfaa_93933fee282db10c162d@vm1.mail&gt;&gt;, &lt;Subject: Message Subject&gt;, &lt;Mime-Version: 1.0&gt;, &lt;Content-Type: text/html; charset=UTF-8&gt;, &lt;Content-Transfer-Encoding: 7bit&gt;, &lt;Auto-Submitted: auto-generated&gt;, &lt;X-Auto-Response-Suppress: All&gt;&gt;irb(main):002:0&gt;quit </code></pre><p>###3ã€<strong>gitlabçš„ä½¿ç”¨</strong> <strong>åœ¨æµè§ˆå™¨ä¸­è¾“å…¥ <a href="http://192.168.60.119/" target="_blank" rel="noopener">http://192.168.60.119/</a> ï¼Œç„¶å change password: ï¼Œå¹¶ä½¿ç”¨rootç”¨æˆ·ç™»å½• å³å¯ (åç»­åŠ¨ä½œæ ¹æ®æç¤ºæ“ä½œ)</strong></p><h4 id="1ã€gitlab-å‘½ä»¤è¡Œä¿®æ”¹å¯†ç "><a href="#1ã€gitlab-å‘½ä»¤è¡Œä¿®æ”¹å¯†ç " class="headerlink" title="1ã€gitlab å‘½ä»¤è¡Œä¿®æ”¹å¯†ç "></a>1ã€gitlab å‘½ä»¤è¡Œä¿®æ”¹å¯†ç </h4><pre><code>gitlab-rails console productionirb(main):001:0&gt; user = User.where(id: 1).first     # idä¸º1çš„æ˜¯è¶…çº§ç®¡ç†å‘˜irb(main):002:0&gt;user.password = &#39;yourpassword&#39;      # å¯†ç å¿…é¡»è‡³å°‘8ä¸ªå­—ç¬¦irb(main):003:0&gt;user.save!                          # å¦‚æ²¡æœ‰é—®é¢˜ è¿”å›trueexit                                                # é€€å‡º</code></pre><h4 id="2ã€gitlabæœåŠ¡ç®¡ç†"><a href="#2ã€gitlabæœåŠ¡ç®¡ç†" class="headerlink" title="2ã€gitlabæœåŠ¡ç®¡ç†"></a>2ã€gitlabæœåŠ¡ç®¡ç†</h4><pre><code>gitlab-ctl start                        # å¯åŠ¨æ‰€æœ‰ gitlab ç»„ä»¶ï¼›gitlab-ctl stop                         # åœæ­¢æ‰€æœ‰ gitlab ç»„ä»¶ï¼›gitlab-ctl restart                      # é‡å¯æ‰€æœ‰ gitlab ç»„ä»¶ï¼›gitlab-ctl status                       # æŸ¥çœ‹æœåŠ¡çŠ¶æ€ï¼›gitlab-ctl reconfigure                  # å¯åŠ¨æœåŠ¡ï¼›vim /etc/gitlab/gitlab.rb               # ä¿®æ”¹é»˜è®¤çš„é…ç½®æ–‡ä»¶ï¼›gitlab-ctl tail                         # æŸ¥çœ‹æ—¥å¿—ï¼›</code></pre><p>3ã€ç™»é™† Gitlab</p><p><img src="http://p3.pstatp.com/large/pgc-image/bab871f315204370a5a0fb7608617551" alt="Gitlab Server éƒ¨ç½²"></p><p><strong>å¦‚æœéœ€è¦æ‰‹å·¥ä¿®æ”¹nginxçš„port ï¼Œå¯ä»¥åœ¨gitlab.rbä¸­è®¾ç½® nginx[â€˜listen_portâ€™] = 8000 ï¼Œç„¶åå†æ¬¡ gitlab-ctl reconfigureå³å¯</strong></p><p><strong>ç™»å½• gitlab å¦‚ä¸‹æ‰€ç¤º(é¦–æ¬¡ç™»é™†è®¾ç½® root å¯†ç )ï¼š</strong></p><p><img src="http://p1.pstatp.com/large/pgc-image/8fbf9685623b4ca3a3db0db73eae8896" alt="Gitlab Server éƒ¨ç½²"></p><p><strong>åˆ›å»ºé¡¹ç›®ç»„ group ï¼Œç»„åä¸ºplat-sp ,å¦‚ä¸‹æ‰€ç¤º:</strong></p><p><img src="http://p1.pstatp.com/large/pgc-image/30b33c344c914b10b7efdc44cae76214" alt="Gitlab Server éƒ¨ç½²"></p><p><img src="http://p1.pstatp.com/large/pgc-image/cbd2fd9e30454e2c9514192f0706cb31" alt="Gitlab Server éƒ¨ç½²"></p><p><strong>å»æ‰ç”¨æˆ·çš„è‡ªåŠ¨æ³¨å†ŒåŠŸèƒ½ï¼ˆå®‰å…¨ï¼‰ï¼š</strong> admin are -&gt; settings -&gt; Sign-up Restrictions å»æ‰é’©é’©ï¼Œç„¶åæ‹‰åˆ°æœ€ä¸‹é¢ä¿å­˜ï¼Œé‡æ–°ç™»å½•</p><p><img src="http://p3.pstatp.com/large/pgc-image/6cefb48804534f60b67e16168a7717a0" alt="Gitlab Server éƒ¨ç½²"></p>]]></content>
      
      
      <categories>
          
          <category> DevOps </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Gitlab </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>linuxæœåŠ¡å™¨è¢«é»‘æ’æŸ¥æ€è·¯</title>
      <link href="2019/10/05/linux/fu-wu-qi-bei-hei-pai-cha-si-lu/"/>
      <url>2019/10/05/linux/fu-wu-qi-bei-hei-pai-cha-si-lu/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h3 id="è´¦æˆ·å’Œç™»å½•å®‰å…¨"><a href="#è´¦æˆ·å’Œç™»å½•å®‰å…¨" class="headerlink" title="è´¦æˆ·å’Œç™»å½•å®‰å…¨"></a>è´¦æˆ·å’Œç™»å½•å®‰å…¨</h3><p>è´¦æˆ·å®‰å…¨æ˜¯ç³»ç»Ÿå®‰å…¨çš„ç¬¬ä¸€é“å±éšœï¼Œä¹Ÿæ˜¯ç³»ç»Ÿå®‰å…¨çš„æ ¸å¿ƒï¼Œä¿éšœç™»å½•è´¦æˆ·çš„å®‰å…¨ï¼Œåœ¨ä¸€å®šç¨‹åº¦ä¸Šå¯ä»¥æé«˜æœåŠ¡å™¨çš„å®‰å…¨çº§åˆ«ï¼Œä¸‹é¢é‡ç‚¹ä»‹ç»ä¸‹ Linux ç³»ç»Ÿç™»å½•è´¦æˆ·çš„å®‰å…¨è®¾ç½®æ–¹æ³•ã€‚</p><h4 id="â‘ åˆ é™¤ç‰¹æ®Šçš„è´¦æˆ·å’Œè´¦æˆ·ç»„"><a href="#â‘ åˆ é™¤ç‰¹æ®Šçš„è´¦æˆ·å’Œè´¦æˆ·ç»„" class="headerlink" title="â‘ åˆ é™¤ç‰¹æ®Šçš„è´¦æˆ·å’Œè´¦æˆ·ç»„"></a><strong>â‘ åˆ é™¤ç‰¹æ®Šçš„è´¦æˆ·å’Œè´¦æˆ·ç»„</strong></h4><p>Linux æä¾›äº†å„ç§ä¸åŒè§’è‰²çš„ç³»ç»Ÿè´¦å·ï¼Œåœ¨ç³»ç»Ÿå®‰è£…å®Œæˆåï¼Œé»˜è®¤ä¼šå®‰è£…å¾ˆå¤šä¸å¿…è¦çš„ç”¨æˆ·å’Œç”¨æˆ·ç»„ã€‚</p><p>å¦‚æœä¸éœ€è¦æŸäº›ç”¨æˆ·æˆ–è€…ç»„ï¼Œå°±è¦ç«‹å³åˆ é™¤å®ƒï¼Œå› ä¸ºè´¦æˆ·è¶Šå¤šï¼Œç³»ç»Ÿå°±è¶Šä¸å®‰å…¨ï¼Œå¾ˆå¯èƒ½è¢«é»‘å®¢åˆ©ç”¨ï¼Œè¿›è€Œå¨èƒåˆ°æœåŠ¡å™¨çš„å®‰å…¨ã€‚</p><p>Linuxç³»ç»Ÿä¸­å¯ä»¥åˆ é™¤çš„é»˜è®¤ç”¨æˆ·å’Œç»„å¤§è‡´æœ‰å¦‚ä¸‹è¿™äº›ï¼š</p><p><strong>å¯åˆ é™¤çš„ç”¨æˆ·ï¼Œ</strong>å¦‚ admï¼Œlpï¼Œsyncï¼Œshutdownï¼Œhaltï¼Œnewsï¼Œuucpï¼Œoperatorï¼Œgamesï¼Œgopher ç­‰ã€‚</p><p><strong>å¯åˆ é™¤çš„ç»„ï¼Œ</strong>å¦‚ admï¼Œlpï¼Œnewsï¼Œuucpï¼Œgamesï¼Œdipï¼Œpppusersï¼Œpopusersï¼Œslipusers ç­‰ã€‚</p><h4 id="â‘¡å…³é—­ç³»ç»Ÿä¸éœ€è¦çš„æœåŠ¡"><a href="#â‘¡å…³é—­ç³»ç»Ÿä¸éœ€è¦çš„æœåŠ¡" class="headerlink" title="â‘¡å…³é—­ç³»ç»Ÿä¸éœ€è¦çš„æœåŠ¡"></a><strong>â‘¡å…³é—­ç³»ç»Ÿä¸éœ€è¦çš„æœåŠ¡</strong></h4><p>Linux åœ¨å®‰è£…å®Œæˆåï¼Œç»‘å®šäº†å¾ˆå¤šæ²¡ç”¨çš„æœåŠ¡ï¼Œè¿™äº›æœåŠ¡é»˜è®¤éƒ½æ˜¯è‡ªåŠ¨å¯åŠ¨çš„ã€‚</p><p>å¯¹äºæœåŠ¡å™¨æ¥è¯´ï¼Œè¿è¡Œçš„æœåŠ¡è¶Šå¤šï¼Œç³»ç»Ÿå°±è¶Šä¸å®‰å…¨ï¼Œè¶Šå°‘æœåŠ¡åœ¨è¿è¡Œï¼Œå®‰å…¨æ€§å°±è¶Šå¥½ï¼Œå› æ­¤å…³é—­ä¸€äº›ä¸éœ€è¦çš„æœåŠ¡ï¼Œå¯¹ç³»ç»Ÿå®‰å…¨æœ‰å¾ˆå¤§çš„å¸®åŠ©ã€‚</p><p>å…·ä½“å“ªäº›æœåŠ¡å¯ä»¥å…³é—­ï¼Œè¦æ ¹æ®æœåŠ¡å™¨çš„ç”¨é€”è€Œå®šï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œåªè¦ç³»ç»Ÿæœ¬èº«ç”¨ä¸åˆ°çš„æœåŠ¡éƒ½è®¤ä¸ºæ˜¯ä¸å¿…è¦çš„æœåŠ¡ã€‚</p><p>ä¾‹å¦‚ï¼šæŸå° Linux æœåŠ¡å™¨ç”¨äº www åº”ç”¨ï¼Œé‚£ä¹ˆé™¤äº† httpd æœåŠ¡å’Œç³»ç»Ÿè¿è¡Œæ˜¯å¿…é¡»çš„æœåŠ¡å¤–ï¼Œå…¶ä»–æœåŠ¡éƒ½å¯ä»¥å…³é—­ã€‚</p><p>ä¸‹é¢è¿™äº›æœåŠ¡ä¸€èˆ¬æƒ…å†µä¸‹æ˜¯ä¸éœ€è¦çš„ï¼Œå¯ä»¥é€‰æ‹©å…³é—­ï¼š</p><p>anacronã€auditdã€autofsã€avahi-daemonã€avahi-dnsconfdã€bluetoothã€cpuspeedã€firstbootã€gpmã€haldaemonã€hiddã€ip6tablesã€ipsecã€isdnã€lpdã€mcstransã€messagebusã€netfsã€nfsã€nfslockã€nscdã€pcscd portmapã€readahead_earlyã€restorecondã€rpcgssdã€rpcidmapdã€rstatdã€sendmailã€setroubleshootã€yppasswdd ypserv</p><h4 id="â‘¢å¯†ç å®‰å…¨ç­–ç•¥"><a href="#â‘¢å¯†ç å®‰å…¨ç­–ç•¥" class="headerlink" title="â‘¢å¯†ç å®‰å…¨ç­–ç•¥"></a><strong>â‘¢å¯†ç å®‰å…¨ç­–ç•¥</strong></h4><p>åœ¨ Linux ä¸‹ï¼Œè¿œç¨‹ç™»å½•ç³»ç»Ÿæœ‰ä¸¤ç§è®¤è¯æ–¹å¼ï¼š</p><ul><li><strong>å¯†ç è®¤è¯</strong></li><li><strong>å¯†é’¥è®¤è¯</strong></li></ul><p>å¯†ç è®¤è¯æ–¹å¼æ˜¯ä¼ ç»Ÿçš„å®‰å…¨ç­–ç•¥ï¼Œå¯¹äºå¯†ç çš„è®¾ç½®ï¼Œæ¯”è¾ƒæ™®éçš„è¯´æ³•æ˜¯ï¼šè‡³å°‘ 6 ä¸ªå­—ç¬¦ä»¥ä¸Šï¼Œå¯†ç è¦åŒ…å«æ•°å­—ã€å­—æ¯ã€ä¸‹åˆ’çº¿ã€ç‰¹æ®Šç¬¦å·ç­‰ã€‚</p><p>è®¾ç½®ä¸€ä¸ªç›¸å¯¹å¤æ‚çš„å¯†ç ï¼Œå¯¹ç³»ç»Ÿå®‰å…¨èƒ½èµ·åˆ°ä¸€å®šçš„é˜²æŠ¤ä½œç”¨ï¼Œä½†æ˜¯ä¹Ÿé¢ä¸´ä¸€äº›å…¶ä»–é—®é¢˜ï¼Œä¾‹å¦‚å¯†ç æš´åŠ›ç ´è§£ã€å¯†ç æ³„éœ²ã€å¯†ç ä¸¢å¤±ç­‰ï¼ŒåŒæ—¶è¿‡äºå¤æ‚çš„å¯†ç å¯¹è¿ç»´å·¥ä½œä¹Ÿä¼šé€ æˆä¸€å®šçš„è´Ÿæ‹…ã€‚</p><p>å¯†é’¥è®¤è¯æ˜¯ä¸€ç§æ–°å‹çš„è®¤è¯æ–¹å¼ï¼Œå…¬ç”¨å¯†é’¥å­˜å‚¨åœ¨è¿œç¨‹æœåŠ¡å™¨ä¸Šï¼Œä¸“ç”¨å¯†é’¥ä¿å­˜åœ¨æœ¬åœ°ï¼Œå½“éœ€è¦ç™»å½•ç³»ç»Ÿæ—¶ï¼Œé€šè¿‡æœ¬åœ°ä¸“ç”¨å¯†é’¥å’Œè¿œç¨‹æœåŠ¡å™¨çš„å…¬ç”¨å¯†é’¥è¿›è¡Œé…å¯¹è®¤è¯ï¼Œå¦‚æœè®¤è¯æˆåŠŸï¼Œå°±æˆåŠŸç™»å½•ç³»ç»Ÿã€‚</p><p>è¿™ç§è®¤è¯æ–¹å¼é¿å…äº†è¢«æš´åŠ›ç ´è§£çš„å±é™©ï¼ŒåŒæ—¶åªè¦ä¿å­˜åœ¨æœ¬åœ°çš„ä¸“ç”¨å¯†é’¥ä¸è¢«é»‘å®¢ç›—ç”¨ï¼Œæ”»å‡»è€…ä¸€èˆ¬æ— æ³•é€šè¿‡å¯†é’¥è®¤è¯çš„æ–¹å¼è¿›å…¥ç³»ç»Ÿã€‚</p><p>å› æ­¤ï¼Œåœ¨ Linux ä¸‹æ¨èç”¨å¯†é’¥è®¤è¯æ–¹å¼ç™»å½•ç³»ç»Ÿï¼Œè¿™æ ·å°±å¯ä»¥æŠ›å¼ƒå¯†ç è®¤è¯ç™»å½•ç³»ç»Ÿçš„å¼Šç«¯ã€‚</p><p>Linux æœåŠ¡å™¨ä¸€èˆ¬é€šè¿‡ SecureCRTã€Puttyã€Xshell ä¹‹ç±»çš„å·¥å…·è¿›è¡Œè¿œç¨‹ç»´æŠ¤å’Œç®¡ç†ï¼Œå¯†é’¥è®¤è¯æ–¹å¼çš„å®ç°å°±æ˜¯å€ŸåŠ©äº SecureCRT è½¯ä»¶å’Œ Linux ç³»ç»Ÿä¸­çš„ SSH æœåŠ¡å®ç°çš„ã€‚</p><h4 id="â‘£åˆç†ä½¿ç”¨-suã€sudo-å‘½ä»¤"><a href="#â‘£åˆç†ä½¿ç”¨-suã€sudo-å‘½ä»¤" class="headerlink" title="â‘£åˆç†ä½¿ç”¨ suã€sudo å‘½ä»¤"></a><strong>â‘£åˆç†ä½¿ç”¨ suã€sudo å‘½ä»¤</strong></h4><p><strong>su å‘½ä»¤ï¼š</strong>æ˜¯ä¸€ä¸ªåˆ‡æ¢ç”¨æˆ·çš„å·¥å…·ï¼Œç»å¸¸ç”¨äºå°†æ™®é€šç”¨æˆ·åˆ‡æ¢åˆ°è¶…çº§ç”¨æˆ·ä¸‹ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ä»è¶…çº§ç”¨æˆ·åˆ‡æ¢åˆ°æ™®é€šç”¨æˆ·ã€‚</p><p>ä¸ºäº†ä¿è¯æœåŠ¡å™¨çš„å®‰å…¨ï¼Œå‡ ä¹æ‰€æœ‰æœåŠ¡å™¨éƒ½ç¦æ­¢äº†è¶…çº§ç”¨æˆ·ç›´æ¥ç™»å½•ç³»ç»Ÿï¼Œè€Œæ˜¯é€šè¿‡æ™®é€šç”¨æˆ·ç™»å½•ç³»ç»Ÿï¼Œç„¶åå†é€šè¿‡ su å‘½ä»¤åˆ‡æ¢åˆ°è¶…çº§ç”¨æˆ·ä¸‹ï¼Œæ‰§è¡Œä¸€äº›éœ€è¦è¶…çº§æƒé™çš„å·¥ä½œã€‚</p><p>é€šè¿‡ su å‘½ä»¤èƒ½å¤Ÿç»™ç³»ç»Ÿç®¡ç†å¸¦æ¥ä¸€å®šçš„æ–¹ä¾¿ï¼Œä½†æ˜¯ä¹Ÿå­˜åœ¨ä¸å®‰å…¨çš„å› ç´ ï¼Œä¾‹å¦‚ï¼šç³»ç»Ÿæœ‰ 10 ä¸ªæ™®é€šç”¨æˆ·ï¼Œæ¯ä¸ªç”¨æˆ·éƒ½éœ€è¦æ‰§è¡Œä¸€äº›æœ‰è¶…çº§æƒé™çš„æ“ä½œï¼Œå°±å¿…é¡»æŠŠè¶…çº§ç”¨æˆ·çš„å¯†ç äº¤ç»™è¿™ 10 ä¸ªæ™®é€šç”¨æˆ·ã€‚</p><p>å¦‚æœè¿™ 10 ä¸ªç”¨æˆ·éƒ½æœ‰è¶…çº§æƒé™ï¼Œé€šè¿‡è¶…çº§æƒé™å¯ä»¥åšä»»ä½•äº‹ï¼Œé‚£ä¹ˆä¼šåœ¨ä¸€å®šç¨‹åº¦ä¸Šå¯¹ç³»ç»Ÿçš„å®‰å…¨é€ æˆäº†å¨åã€‚</p><p>å› æ­¤ su å‘½ä»¤åœ¨å¾ˆå¤šäººéƒ½éœ€è¦å‚ä¸çš„ç³»ç»Ÿç®¡ç†ä¸­ï¼Œå¹¶ä¸æ˜¯æœ€å¥½çš„é€‰æ‹©ï¼Œè¶…çº§ç”¨æˆ·å¯†ç åº”è¯¥æŒæ¡åœ¨å°‘æ•°äººæ‰‹ä¸­ï¼Œæ­¤æ—¶ sudo å‘½ä»¤å°±æ´¾ä¸Šç”¨åœºäº†ã€‚</p><p><strong>sudo å‘½ä»¤ï¼š</strong>å…è®¸ç³»ç»Ÿç®¡ç†å‘˜åˆ†é…ç»™æ™®é€šç”¨æˆ·ä¸€äº›åˆç†çš„â€œæƒåˆ©â€ï¼Œå¹¶ä¸”ä¸éœ€è¦æ™®é€šç”¨æˆ·çŸ¥é“è¶…çº§ç”¨æˆ·å¯†ç ï¼Œå°±èƒ½è®©ä»–ä»¬æ‰§è¡Œä¸€äº›åªæœ‰è¶…çº§ç”¨æˆ·æˆ–å…¶ä»–ç‰¹è®¸ç”¨æˆ·æ‰èƒ½å®Œæˆçš„ä»»åŠ¡ã€‚</p><p>æ¯”å¦‚ï¼šç³»ç»ŸæœåŠ¡é‡å¯ã€ç¼–è¾‘ç³»ç»Ÿé…ç½®æ–‡ä»¶ç­‰ï¼Œé€šè¿‡è¿™ç§æ–¹å¼ä¸ä½†èƒ½å‡å°‘è¶…çº§ç”¨æˆ·ç™»å½•æ¬¡æ•°å’Œç®¡ç†æ—¶é—´ï¼Œä¹Ÿæé«˜äº†ç³»ç»Ÿå®‰å…¨æ€§ã€‚</p><p>å› æ­¤ï¼Œsudo å‘½ä»¤ç›¸å¯¹äºæƒé™æ— é™åˆ¶æ€§çš„ su æ¥è¯´ï¼Œè¿˜æ˜¯æ¯”è¾ƒå®‰å…¨çš„ï¼Œæ‰€ä»¥ sudo ä¹Ÿè¢«ç§°ä¸ºå—é™åˆ¶çš„ suï¼Œå¦å¤– sudo ä¹Ÿæ˜¯éœ€è¦äº‹å…ˆè¿›è¡Œæˆæƒè®¤è¯çš„ï¼Œæ‰€ä»¥ä¹Ÿè¢«ç§°ä¸ºæˆæƒè®¤è¯çš„ suã€‚</p><p><strong>sudo æ‰§è¡Œå‘½ä»¤çš„æµç¨‹æ˜¯ï¼š</strong>å°†å½“å‰ç”¨æˆ·åˆ‡æ¢åˆ°è¶…çº§ç”¨æˆ·ä¸‹ï¼Œæˆ–åˆ‡æ¢åˆ°æŒ‡å®šçš„ç”¨æˆ·ä¸‹ï¼Œç„¶åä»¥è¶…çº§ç”¨æˆ·æˆ–å…¶æŒ‡å®šåˆ‡æ¢åˆ°çš„ç”¨æˆ·èº«ä»½æ‰§è¡Œå‘½ä»¤ã€‚</p><p>æ‰§è¡Œå®Œæˆåï¼Œç›´æ¥é€€å›åˆ°å½“å‰ç”¨æˆ·ï¼Œè€Œè¿™ä¸€åˆ‡çš„å®Œæˆè¦é€šè¿‡ sudo çš„é…ç½®æ–‡ä»¶ /etc/sudoers æ¥è¿›è¡Œæˆæƒã€‚</p><p><strong>sudo è®¾è®¡çš„å®—æ—¨æ˜¯ï¼š</strong>èµ‹äºˆç”¨æˆ·å°½å¯èƒ½å°‘çš„æƒé™ä½†ä»å…è®¸å®ƒä»¬å®Œæˆè‡ªå·±çš„å·¥ä½œï¼Œè¿™ç§è®¾è®¡å…¼é¡¾äº†å®‰å…¨æ€§å’Œæ˜“ç”¨æ€§ã€‚</p><p>å› æ­¤ï¼Œå¼ºçƒˆæ¨èé€šè¿‡ sudo æ¥ç®¡ç†ç³»ç»Ÿè´¦å·çš„å®‰å…¨ï¼Œåªå…è®¸æ™®é€šç”¨æˆ·ç™»å½•ç³»ç»Ÿï¼Œå¦‚æœè¿™äº›ç”¨æˆ·éœ€è¦ç‰¹æ®Šçš„æƒé™ï¼Œå°±é€šè¿‡é…ç½® /etc/sudoers æ¥å®Œæˆï¼Œè¿™ä¹Ÿæ˜¯å¤šç”¨æˆ·ç³»ç»Ÿä¸‹è´¦å·å®‰å…¨ç®¡ç†çš„åŸºæœ¬æ–¹å¼ã€‚</p><h4 id="â‘¤åˆ å‡ç³»ç»Ÿç™»å½•æ¬¢è¿ä¿¡æ¯"><a href="#â‘¤åˆ å‡ç³»ç»Ÿç™»å½•æ¬¢è¿ä¿¡æ¯" class="headerlink" title="â‘¤åˆ å‡ç³»ç»Ÿç™»å½•æ¬¢è¿ä¿¡æ¯"></a><strong>â‘¤åˆ å‡ç³»ç»Ÿç™»å½•æ¬¢è¿ä¿¡æ¯</strong></h4><p>ç³»ç»Ÿçš„ä¸€äº›æ¬¢è¿ä¿¡æ¯æˆ–ç‰ˆæœ¬ä¿¡æ¯ï¼Œè™½ç„¶èƒ½ç»™ç³»ç»Ÿç®¡ç†è€…å¸¦æ¥ä¸€å®šçš„æ–¹ä¾¿ï¼Œä½†æ˜¯è¿™äº›ä¿¡æ¯æœ‰æ—¶å€™å¯èƒ½è¢«é»‘å®¢åˆ©ç”¨ï¼Œæˆä¸ºæ”»å‡»æœåŠ¡å™¨çš„å¸®å‡¶ã€‚</p><p>ä¸ºäº†ä¿è¯ç³»ç»Ÿçš„å®‰å…¨ï¼Œå¯ä»¥ä¿®æ”¹æˆ–åˆ é™¤æŸäº›ç³»ç»Ÿæ–‡ä»¶ï¼Œéœ€è¦ä¿®æ”¹æˆ–åˆ é™¤çš„æ–‡ä»¶æœ‰å››ä¸ªï¼Œåˆ†åˆ«æ˜¯ï¼š</p><ul><li><strong>/etc/issue</strong></li><li><strong>/etc/issue.net</strong></li><li><strong>/etc/redhat-release</strong></li><li><strong>/etc/motd</strong></li></ul><p>/etc/issue å’Œ /etc/issue.net æ–‡ä»¶éƒ½è®°å½•äº†æ“ä½œç³»ç»Ÿçš„åç§°å’Œç‰ˆæœ¬å·ï¼Œå½“ç”¨æˆ·é€šè¿‡æœ¬åœ°ç»ˆç«¯æˆ–æœ¬åœ°è™šæ‹Ÿæ§åˆ¶å°ç­‰ç™»å½•ç³»ç»Ÿæ—¶ï¼Œ/etc/issue çš„æ–‡ä»¶å†…å®¹å°±ä¼šæ˜¾ç¤ºã€‚</p><p>å½“ç”¨æˆ·é€šè¿‡ ssh æˆ– telnet ç­‰è¿œç¨‹ç™»å½•ç³»ç»Ÿæ—¶ï¼Œ/etc/issue.net æ–‡ä»¶å†…å®¹å°±ä¼šåœ¨ç™»å½•åæ˜¾ç¤ºã€‚</p><p>åœ¨é»˜è®¤æƒ…å†µä¸‹ /etc/issue.net æ–‡ä»¶çš„å†…å®¹æ˜¯ä¸ä¼šåœ¨ ssh ç™»å½•åæ˜¾ç¤ºçš„ï¼Œè¦æ˜¾ç¤ºè¿™ä¸ªä¿¡æ¯å¯ä»¥ä¿®æ”¹ /etc/ssh/sshd_config æ–‡ä»¶ï¼Œåœ¨æ­¤æ–‡ä»¶ä¸­æ·»åŠ å¦‚ä¸‹å†…å®¹å³å¯ï¼šBanner /etc/issue.netã€‚</p><p>å…¶å®è¿™äº›ç™»å½•æç¤ºå¾ˆæ˜æ˜¾æ³„æ¼äº†ç³»ç»Ÿä¿¡æ¯ï¼Œä¸ºäº†å®‰å…¨èµ·è§ï¼Œå»ºè®®å°†æ­¤æ–‡ä»¶ä¸­çš„å†…å®¹åˆ é™¤æˆ–ä¿®æ”¹ã€‚</p><p>/etc/redhat-release æ–‡ä»¶ä¹Ÿè®°å½•äº†æ“ä½œç³»ç»Ÿçš„åç§°å’Œç‰ˆæœ¬å·ï¼Œä¸ºäº†å®‰å…¨èµ·è§ï¼Œå¯ä»¥å°†æ­¤æ–‡ä»¶ä¸­çš„å†…å®¹åˆ é™¤ã€‚</p><p>/etc/motd æ–‡ä»¶æ˜¯ç³»ç»Ÿçš„å…¬å‘Šä¿¡æ¯ã€‚æ¯æ¬¡ç”¨æˆ·ç™»å½•åï¼Œ/etc/motd æ–‡ä»¶çš„å†…å®¹å°±ä¼šæ˜¾ç¤ºåœ¨ç”¨æˆ·çš„ç»ˆç«¯ã€‚</p><p>é€šè¿‡è¿™ä¸ªæ–‡ä»¶ç³»ç»Ÿï¼Œç®¡ç†å‘˜å¯ä»¥å‘å¸ƒä¸€äº›è½¯ä»¶æˆ–ç¡¬ä»¶çš„å‡çº§ã€ç³»ç»Ÿç»´æŠ¤ç­‰é€šå‘Šä¿¡æ¯ï¼Œä½†æ˜¯æ­¤æ–‡ä»¶çš„æœ€å¤§ä½œç”¨å°±æ˜¯å¯ä»¥å‘å¸ƒä¸€äº›è­¦å‘Šä¿¡æ¯ï¼Œå½“é»‘å®¢ç™»å½•ç³»ç»Ÿåï¼Œä¼šå‘ç°è¿™äº›è­¦å‘Šä¿¡æ¯ï¼Œè¿›è€Œäº§ç”Ÿä¸€äº›éœ‡æ…‘ä½œç”¨ã€‚</p><p>çœ‹è¿‡å›½å¤–çš„ä¸€ä¸ªæŠ¥é“ï¼Œé»‘å®¢å…¥ä¾µäº†ä¸€ä¸ªæœåŠ¡å™¨ï¼Œè€Œè¿™ä¸ªæœåŠ¡å™¨å´ç»™å‡ºäº†æ¬¢è¿ç™»å½•çš„ä¿¡æ¯ï¼Œå› æ­¤æ³•é™¢ä¸åšä»»ä½•è£å†³ã€‚</p><h3 id="è¿œç¨‹è®¿é—®å’Œè®¤è¯å®‰å…¨"><a href="#è¿œç¨‹è®¿é—®å’Œè®¤è¯å®‰å…¨" class="headerlink" title="è¿œç¨‹è®¿é—®å’Œè®¤è¯å®‰å…¨"></a><strong>è¿œç¨‹è®¿é—®å’Œè®¤è¯å®‰å…¨</strong></h3><h4 id="â‘ è¿œç¨‹ç™»å½•å–æ¶ˆ-telnet-è€Œé‡‡ç”¨-SSH-æ–¹å¼"><a href="#â‘ è¿œç¨‹ç™»å½•å–æ¶ˆ-telnet-è€Œé‡‡ç”¨-SSH-æ–¹å¼" class="headerlink" title="â‘ è¿œç¨‹ç™»å½•å–æ¶ˆ telnet è€Œé‡‡ç”¨ SSH æ–¹å¼"></a><strong>â‘ è¿œç¨‹ç™»å½•å–æ¶ˆ telnet è€Œé‡‡ç”¨ SSH æ–¹å¼</strong></h4><p>telnet æ˜¯ä¸€ç§å¤è€çš„è¿œç¨‹ç™»å½•è®¤è¯æœåŠ¡ï¼Œå®ƒåœ¨ç½‘ç»œä¸Šç”¨æ˜æ–‡ä¼ é€å£ä»¤å’Œæ•°æ®ï¼Œå› æ­¤åˆ«æœ‰ç”¨å¿ƒçš„äººå°±ä¼šéå¸¸å®¹æ˜“æˆªè·è¿™äº›å£ä»¤å’Œæ•°æ®ã€‚</p><p>è€Œä¸”ï¼Œtelnet æœåŠ¡ç¨‹åºçš„å®‰å…¨éªŒè¯æ–¹å¼ä¹Ÿæå…¶è„†å¼±ï¼Œæ”»å‡»è€…å¯ä»¥è½»æ¾å°†è™šå‡ä¿¡æ¯ä¼ é€ç»™æœåŠ¡å™¨ã€‚</p><p>ç°åœ¨è¿œç¨‹ç™»å½•åŸºæœ¬æŠ›å¼ƒäº† telnet è¿™ç§æ–¹å¼ï¼Œè€Œå–è€Œä»£ä¹‹çš„æ˜¯é€šè¿‡ SSH æœåŠ¡è¿œç¨‹ç™»å½•æœåŠ¡å™¨ã€‚</p><h4 id="â‘¡åˆç†ä½¿ç”¨-Shell-å†å²å‘½ä»¤è®°å½•åŠŸèƒ½"><a href="#â‘¡åˆç†ä½¿ç”¨-Shell-å†å²å‘½ä»¤è®°å½•åŠŸèƒ½" class="headerlink" title="â‘¡åˆç†ä½¿ç”¨ Shell å†å²å‘½ä»¤è®°å½•åŠŸèƒ½"></a><strong>â‘¡åˆç†ä½¿ç”¨ Shell å†å²å‘½ä»¤è®°å½•åŠŸèƒ½</strong></h4><p>åœ¨ Linux ä¸‹å¯é€šè¿‡ history å‘½ä»¤æŸ¥çœ‹ç”¨æˆ·æ‰€æœ‰çš„å†å²æ“ä½œè®°å½•ï¼ŒåŒæ—¶ shell å‘½ä»¤æ“ä½œè®°å½•é»˜è®¤ä¿å­˜åœ¨ç”¨æˆ·ç›®å½•ä¸‹çš„ .bash_history æ–‡ä»¶ä¸­ã€‚</p><p>é€šè¿‡è¿™ä¸ªæ–‡ä»¶å¯ä»¥æŸ¥è¯¢ shell å‘½ä»¤çš„æ‰§è¡Œå†å²ï¼Œæœ‰åŠ©äºè¿ç»´äººå‘˜è¿›è¡Œç³»ç»Ÿå®¡è®¡å’Œé—®é¢˜æ’æŸ¥ã€‚</p><p>åŒæ—¶ï¼Œåœ¨æœåŠ¡å™¨é­å—é»‘å®¢æ”»å‡»åï¼Œä¹Ÿå¯ä»¥é€šè¿‡è¿™ä¸ªå‘½ä»¤æˆ–æ–‡ä»¶æŸ¥è¯¢é»‘å®¢ç™»å½•æœåŠ¡å™¨æ‰€æ‰§è¡Œçš„å†å²å‘½ä»¤æ“ä½œã€‚</p><p>ä½†æ˜¯æœ‰æ—¶å€™é»‘å®¢åœ¨å…¥ä¾µæœåŠ¡å™¨åä¸ºäº†æ¯ç­ç—•è¿¹ï¼Œå¯èƒ½ä¼šåˆ é™¤ .bash_history æ–‡ä»¶ï¼Œè¿™å°±éœ€è¦åˆç†çš„ä¿æŠ¤æˆ–å¤‡ä»½ .bash_history æ–‡ä»¶ã€‚</p><h4 id="â‘¢å¯ç”¨-Tcp-Wrappers-é˜²ç«å¢™"><a href="#â‘¢å¯ç”¨-Tcp-Wrappers-é˜²ç«å¢™" class="headerlink" title="â‘¢å¯ç”¨ Tcp_Wrappers é˜²ç«å¢™"></a><strong>â‘¢å¯ç”¨ Tcp_Wrappers é˜²ç«å¢™</strong></h4><p>Tcp_Wrappers æ˜¯ä¸€ä¸ªç”¨æ¥åˆ†æ TCP/IP å°åŒ…çš„è½¯ä»¶ï¼Œç±»ä¼¼çš„ IP å°åŒ…è½¯ä»¶è¿˜æœ‰ iptablesã€‚</p><p>Linux é»˜è®¤éƒ½å®‰è£…äº† Tcp_Wrappersã€‚ä½œä¸ºä¸€ä¸ªå®‰å…¨çš„ç³»ç»Ÿï¼ŒLinux æœ¬èº«æœ‰ä¸¤å±‚å®‰å…¨é˜²ç«å¢™ï¼Œé€šè¿‡ IP è¿‡æ»¤æœºåˆ¶çš„ iptables å®ç°ç¬¬ä¸€å±‚é˜²æŠ¤ã€‚</p><p>iptables é˜²ç«å¢™é€šè¿‡ç›´è§‚åœ°ç›‘è§†ç³»ç»Ÿçš„è¿è¡ŒçŠ¶å†µï¼Œé˜»æŒ¡ç½‘ç»œä¸­çš„ä¸€äº›æ¶æ„æ”»å‡»ï¼Œä¿æŠ¤æ•´ä¸ªç³»ç»Ÿæ­£å¸¸è¿è¡Œï¼Œå…é­æ”»å‡»å’Œç ´åã€‚</p><p>å¦‚æœé€šè¿‡äº†ç¬¬ä¸€å±‚é˜²æŠ¤ï¼Œé‚£ä¹ˆä¸‹ä¸€å±‚é˜²æŠ¤å°±æ˜¯ Tcp_Wrappers äº†ã€‚é€šè¿‡ Tcp_Wrappers å¯ä»¥å®ç°å¯¹ç³»ç»Ÿä¸­æä¾›çš„æŸäº›æœåŠ¡çš„å¼€æ”¾ä¸å…³é—­ã€å…è®¸å’Œç¦æ­¢ï¼Œä»è€Œæ›´æœ‰æ•ˆåœ°ä¿è¯ç³»ç»Ÿå®‰å…¨è¿è¡Œã€‚</p><h3 id="æ–‡ä»¶ç³»ç»Ÿå®‰å…¨"><a href="#æ–‡ä»¶ç³»ç»Ÿå®‰å…¨" class="headerlink" title="æ–‡ä»¶ç³»ç»Ÿå®‰å…¨"></a><strong>æ–‡ä»¶ç³»ç»Ÿå®‰å…¨</strong></h3><h4 id="â‘ é”å®šç³»ç»Ÿé‡è¦æ–‡ä»¶"><a href="#â‘ é”å®šç³»ç»Ÿé‡è¦æ–‡ä»¶" class="headerlink" title="â‘ é”å®šç³»ç»Ÿé‡è¦æ–‡ä»¶"></a><strong>â‘ é”å®šç³»ç»Ÿé‡è¦æ–‡ä»¶</strong></h4><p>ç³»ç»Ÿè¿ç»´äººå‘˜æœ‰æ—¶å€™å¯èƒ½ä¼šé‡åˆ°é€šè¿‡ Root ç”¨æˆ·éƒ½ä¸èƒ½ä¿®æ”¹æˆ–è€…åˆ é™¤æŸä¸ªæ–‡ä»¶çš„æƒ…å†µï¼Œäº§ç”Ÿè¿™ç§æƒ…å†µçš„å¤§éƒ¨åˆ†åŸå› å¯èƒ½æ˜¯è¿™ä¸ªæ–‡ä»¶è¢«é”å®šäº†ã€‚</p><p>åœ¨ Linux ä¸‹é”å®šæ–‡ä»¶çš„å‘½ä»¤æ˜¯ Chattrï¼Œé€šè¿‡è¿™ä¸ªå‘½ä»¤å¯ä»¥ä¿®æ”¹ ext2ã€ext3ã€ext4 æ–‡ä»¶ç³»ç»Ÿä¸‹æ–‡ä»¶å±æ€§ï¼Œä½†æ˜¯è¿™ä¸ªå‘½ä»¤å¿…é¡»æœ‰è¶…çº§ç”¨æˆ· Root æ¥æ‰§è¡Œã€‚å’Œè¿™ä¸ªå‘½ä»¤å¯¹åº”çš„å‘½ä»¤æ˜¯ lsattrï¼Œè¿™ä¸ªå‘½ä»¤ç”¨æ¥æŸ¥è¯¢æ–‡ä»¶å±æ€§ã€‚</p><p>å¯¹é‡è¦çš„æ–‡ä»¶è¿›è¡ŒåŠ é”ï¼Œè™½ç„¶èƒ½å¤Ÿæé«˜æœåŠ¡å™¨çš„å®‰å…¨æ€§ï¼Œä½†æ˜¯ä¹Ÿä¼šå¸¦æ¥ä¸€äº›ä¸ä¾¿ã€‚</p><p>ä¾‹å¦‚ï¼šåœ¨è½¯ä»¶çš„å®‰è£…ã€å‡çº§æ—¶å¯èƒ½éœ€è¦å»æ‰æœ‰å…³ç›®å½•å’Œæ–‡ä»¶çš„ immutable å±æ€§å’Œ append-only å±æ€§ï¼ŒåŒæ—¶ï¼Œå¯¹æ—¥å¿—æ–‡ä»¶è®¾ç½®äº† append-only å±æ€§ï¼Œå¯èƒ½ä¼šä½¿æ—¥å¿—è½®æ¢ï¼ˆlogrotateï¼‰æ— æ³•è¿›è¡Œã€‚</p><p>å› æ­¤ï¼Œåœ¨ä½¿ç”¨ Chattr å‘½ä»¤å‰ï¼Œéœ€è¦ç»“åˆæœåŠ¡å™¨çš„åº”ç”¨ç¯å¢ƒæ¥æƒè¡¡æ˜¯å¦éœ€è¦è®¾ç½® immutable å±æ€§å’Œ append-only å±æ€§ã€‚</p><p>å¦å¤–ï¼Œè™½ç„¶é€šè¿‡ Chattr å‘½ä»¤ä¿®æ”¹æ–‡ä»¶å±æ€§èƒ½å¤Ÿæé«˜æ–‡ä»¶ç³»ç»Ÿçš„å®‰å…¨æ€§ï¼Œä½†æ˜¯å®ƒå¹¶ä¸é€‚åˆæ‰€æœ‰çš„ç›®å½•ã€‚Chattr å‘½ä»¤ä¸èƒ½ä¿æŠ¤ /ã€/devã€/tmpã€/var ç­‰ç›®å½•ã€‚</p><p>æ ¹ç›®å½•ä¸èƒ½æœ‰ä¸å¯ä¿®æ”¹å±æ€§ï¼Œå› ä¸ºå¦‚æœæ ¹ç›®å½•å…·æœ‰ä¸å¯ä¿®æ”¹å±æ€§ï¼Œé‚£ä¹ˆç³»ç»Ÿæ ¹æœ¬æ— æ³•å·¥ä½œï¼š</p><ul><li>/dev åœ¨å¯åŠ¨æ—¶ï¼Œsyslog éœ€è¦åˆ é™¤å¹¶é‡æ–°å»ºç«‹ /dev/log å¥—æ¥å­—è®¾å¤‡ï¼Œå¦‚æœè®¾ç½®äº†ä¸å¯ä¿®æ”¹å±æ€§ï¼Œé‚£ä¹ˆå¯èƒ½å‡ºé—®é¢˜ã€‚</li><li>/tmp ç›®å½•ä¼šæœ‰å¾ˆå¤šåº”ç”¨ç¨‹åºå’Œç³»ç»Ÿç¨‹åºéœ€è¦åœ¨è¿™ä¸ªç›®å½•ä¸‹å»ºç«‹ä¸´æ—¶æ–‡ä»¶ï¼Œä¹Ÿä¸èƒ½è®¾ç½®ä¸å¯ä¿®æ”¹å±æ€§ã€‚</li><li>/var æ˜¯ç³»ç»Ÿå’Œç¨‹åºçš„æ—¥å¿—ç›®å½•ï¼Œå¦‚æœè®¾ç½®ä¸ºä¸å¯ä¿®æ”¹å±æ€§ï¼Œé‚£ä¹ˆç³»ç»Ÿå†™æ—¥å¿—å°†æ— æ³•è¿›è¡Œï¼Œæ‰€ä»¥ä¹Ÿä¸èƒ½é€šè¿‡ Chattr å‘½ä»¤ä¿æŠ¤ã€‚</li></ul><h4 id="â‘¡æ–‡ä»¶æƒé™æ£€æŸ¥å’Œä¿®æ”¹"><a href="#â‘¡æ–‡ä»¶æƒé™æ£€æŸ¥å’Œä¿®æ”¹" class="headerlink" title="â‘¡æ–‡ä»¶æƒé™æ£€æŸ¥å’Œä¿®æ”¹"></a><strong>â‘¡æ–‡ä»¶æƒé™æ£€æŸ¥å’Œä¿®æ”¹</strong></h4><p>ä¸æ­£ç¡®çš„æƒé™è®¾ç½®ç›´æ¥å¨èƒç€ç³»ç»Ÿçš„å®‰å…¨ï¼Œå› æ­¤è¿ç»´äººå‘˜åº”è¯¥èƒ½åŠæ—¶å‘ç°è¿™äº›ä¸æ­£ç¡®çš„æƒé™è®¾ç½®ï¼Œå¹¶ç«‹åˆ»ä¿®æ­£ï¼Œé˜²æ‚£äºæœªç„¶ã€‚ä¸‹é¢åˆ—ä¸¾å‡ ç§æŸ¥æ‰¾ç³»ç»Ÿä¸å®‰å…¨æƒé™çš„æ–¹æ³•ã€‚</p><p>æŸ¥æ‰¾ç³»ç»Ÿä¸­ä»»ä½•ç”¨æˆ·éƒ½æœ‰å†™æƒé™çš„æ–‡ä»¶æˆ–ç›®å½•ï¼š</p><pre><code>æŸ¥æ‰¾æ–‡ä»¶ï¼šfind / -type f -perm -2 -o -perm -20 |xargs ls -alæŸ¥æ‰¾ç›®å½•ï¼šfind / -type d -perm -2 -o -perm -20 |xargs ls â€“ld</code></pre><p>æŸ¥æ‰¾ç³»ç»Ÿä¸­æ‰€æœ‰å«â€œsâ€ä½çš„ç¨‹åºï¼š</p><pre><code>find / -type f -perm -4000 -o -perm -2000 -print | xargs ls â€“al</code></pre><p>å«æœ‰â€œsâ€ä½æƒé™çš„ç¨‹åºå¯¹ç³»ç»Ÿå®‰å…¨å¨èƒå¾ˆå¤§ï¼Œé€šè¿‡æŸ¥æ‰¾ç³»ç»Ÿä¸­æ‰€æœ‰å…·æœ‰â€œsâ€ä½æƒé™çš„ç¨‹åºï¼Œå¯ä»¥æŠŠæŸäº›ä¸å¿…è¦çš„â€œsâ€ä½ç¨‹åºå»æ‰ï¼Œè¿™æ ·å¯ä»¥é˜²æ­¢ç”¨æˆ·æ»¥ç”¨æƒé™æˆ–æå‡æƒé™çš„å¯èƒ½æ€§ã€‚</p><p>æ£€æŸ¥ç³»ç»Ÿä¸­æ‰€æœ‰ suid åŠ sgid æ–‡ä»¶ï¼š</p><pre><code>find / -user root -perm -2000 -print -exec md5sum {} ;find / -user root -perm -4000 -print -exec md5sum {} ;</code></pre><p>å°†æ£€æŸ¥çš„ç»“æœä¿å­˜åˆ°æ–‡ä»¶ä¸­ï¼Œå¯åœ¨ä»¥åçš„ç³»ç»Ÿæ£€æŸ¥ä¸­ä½œä¸ºå‚è€ƒã€‚</p><p>æ£€æŸ¥ç³»ç»Ÿä¸­æ²¡æœ‰å±ä¸»çš„æ–‡ä»¶ï¼š</p><pre><code>find / -nouser -o â€“nogroup</code></pre><p>æ²¡æœ‰å±ä¸»çš„å­¤å„¿æ–‡ä»¶æ¯”è¾ƒå±é™©ï¼Œå¾€å¾€æˆä¸ºé»‘å®¢åˆ©ç”¨çš„å·¥å…·ï¼Œå› æ­¤æ‰¾åˆ°è¿™äº›æ–‡ä»¶åï¼Œè¦ä¹ˆåˆ é™¤æ‰ï¼Œè¦ä¹ˆä¿®æ”¹æ–‡ä»¶çš„å±ä¸»ï¼Œä½¿å…¶å¤„äºå®‰å…¨çŠ¶æ€ã€‚</p><h4 id="â‘¢-tmpã€-var-tmpã€-dev-shm-å®‰å…¨è®¾å®š"><a href="#â‘¢-tmpã€-var-tmpã€-dev-shm-å®‰å…¨è®¾å®š" class="headerlink" title="â‘¢/tmpã€/var/tmpã€/dev/shm å®‰å…¨è®¾å®š"></a><strong>â‘¢/tmpã€/var/tmpã€/dev/shm å®‰å…¨è®¾å®š</strong></h4><p>åœ¨ Linux ç³»ç»Ÿä¸­ï¼Œä¸»è¦æœ‰ä¸¤ä¸ªç›®å½•æˆ–åˆ†åŒºç”¨æ¥å­˜æ”¾ä¸´æ—¶æ–‡ä»¶ï¼Œåˆ†åˆ«æ˜¯ /tmp å’Œ /var/tmpã€‚</p><p>å­˜å‚¨ä¸´æ—¶æ–‡ä»¶çš„ç›®å½•æˆ–åˆ†åŒºæœ‰ä¸ªå…±åŒç‚¹å°±æ˜¯æ‰€æœ‰ç”¨æˆ·å¯è¯»å†™ã€å¯æ‰§è¡Œï¼Œè¿™å°±ä¸ºç³»ç»Ÿç•™ä¸‹äº†å®‰å…¨éšæ‚£ã€‚</p><p>æ”»å‡»è€…å¯ä»¥å°†ç—…æ¯’æˆ–è€…æœ¨é©¬è„šæœ¬æ”¾åˆ°ä¸´æ—¶æ–‡ä»¶çš„ç›®å½•ä¸‹è¿›è¡Œä¿¡æ¯æ”¶é›†æˆ–ä¼ªè£…ï¼Œä¸¥é‡å½±å“æœåŠ¡å™¨çš„å®‰å…¨ã€‚</p><p>æ­¤æ—¶ï¼Œå¦‚æœä¿®æ”¹ä¸´æ—¶ç›®å½•çš„è¯»å†™æ‰§è¡Œæƒé™ï¼Œè¿˜æœ‰å¯èƒ½å½±å“ç³»ç»Ÿä¸Šåº”ç”¨ç¨‹åºçš„æ­£å¸¸è¿è¡Œï¼Œå› æ­¤ï¼Œå¦‚æœè¦å…¼é¡¾ä¸¤è€…ï¼Œå°±éœ€è¦å¯¹è¿™ä¸¤ä¸ªç›®å½•æˆ–åˆ†åŒºè¿›è¡Œç‰¹æ®Šçš„è®¾ç½®ã€‚</p><p>/dev/shm æ˜¯ Linux ä¸‹çš„ä¸€ä¸ªå…±äº«å†…å­˜è®¾å¤‡ï¼Œåœ¨ Linux å¯åŠ¨çš„æ—¶å€™ç³»ç»Ÿé»˜è®¤ä¼šåŠ è½½ /dev/shmï¼Œè¢«åŠ è½½çš„ /dev/shm ä½¿ç”¨çš„æ˜¯ tmpfs æ–‡ä»¶ç³»ç»Ÿï¼Œè€Œ tmpfs æ˜¯ä¸€ä¸ªå†…å­˜æ–‡ä»¶ç³»ç»Ÿï¼Œå­˜å‚¨åˆ° tmpfs æ–‡ä»¶ç³»ç»Ÿçš„æ•°æ®ä¼šå®Œå…¨é©»ç•™åœ¨ RAM ä¸­ã€‚</p><p>è¿™æ ·é€šè¿‡ /dev/shm å°±å¯ä»¥ç›´æ¥æ“æ§ç³»ç»Ÿå†…å­˜ï¼Œè¿™å°†éå¸¸å±é™©ï¼Œå› æ­¤å¦‚ä½•ä¿è¯ /dev/shm å®‰å…¨ä¹Ÿè‡³å…³é‡è¦ã€‚</p><p>å¯¹äº /tmp çš„å®‰å…¨è®¾ç½®ï¼Œéœ€è¦çœ‹ /tmp æ˜¯ä¸€ä¸ªç‹¬ç«‹ç£ç›˜åˆ†åŒºï¼Œè¿˜æ˜¯ä¸€ä¸ªæ ¹åˆ†åŒºä¸‹çš„æ–‡ä»¶å¤¹ã€‚</p><p>å¦‚æœ /tmp æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ç£ç›˜åˆ†åŒºï¼Œé‚£ä¹ˆè®¾ç½®éå¸¸ç®€å•ï¼Œä¿®æ”¹ /etc/fstab æ–‡ä»¶ä¸­ /tmp åˆ†åŒºå¯¹åº”çš„æŒ‚è½½å±æ€§ï¼ŒåŠ ä¸Š nosuidã€noexecã€nodev ä¸‰ä¸ªé€‰é¡¹å³å¯ã€‚</p><p>ä¿®æ”¹åçš„ /tmp åˆ†åŒºæŒ‚è½½å±æ€§ç±»ä¼¼å¦‚ä¸‹ï¼š</p><pre><code>LABEL=/tmp  /tmp ext3 rw,nosuid,noexec,nodev 0 0</code></pre><p>å…¶ä¸­ï¼Œnosuidã€noexecã€nodev é€‰é¡¹ï¼Œè¡¨ç¤ºä¸å…è®¸ä»»ä½• suid ç¨‹åºï¼Œå¹¶ä¸”åœ¨è¿™ä¸ªåˆ†åŒºä¸èƒ½æ‰§è¡Œä»»ä½•è„šæœ¬ç­‰ç¨‹åºï¼Œå¹¶ä¸”ä¸å­˜åœ¨è®¾å¤‡æ–‡ä»¶ã€‚</p><p>åœ¨æŒ‚è½½å±æ€§è®¾ç½®å®Œæˆåï¼Œé‡æ–°æŒ‚è½½ /tmp åˆ†åŒºï¼Œä¿è¯è®¾ç½®ç”Ÿæ•ˆã€‚</p><p>å¯¹äº /var/tmpï¼Œå¦‚æœæ˜¯ç‹¬ç«‹åˆ†åŒºï¼Œå®‰è£… /tmp çš„è®¾ç½®æ–¹æ³•æ˜¯ä¿®æ”¹ /etc/fstab æ–‡ä»¶å³å¯ã€‚</p><p>å¦‚æœæ˜¯ /var åˆ†åŒºä¸‹çš„ä¸€ä¸ªç›®å½•ï¼Œé‚£ä¹ˆå¯ä»¥å°† /var/tmp ç›®å½•ä¸‹æ‰€æœ‰æ•°æ®ç§»åŠ¨åˆ° /tmp åˆ†åŒºä¸‹ï¼Œç„¶ååœ¨ /var ä¸‹åšä¸€ä¸ªæŒ‡å‘ /tmp çš„è½¯è¿æ¥å³å¯ã€‚</p><p>ä¹Ÿå°±æ˜¯æ‰§è¡Œå¦‚ä¸‹æ“ä½œï¼š</p><pre><code>[root@server ~]# mv /var/tmp/* /tmp[root@server ~]# ln -s  /tmp /var/tmp</code></pre><p>å¦‚æœ /tmp æ˜¯æ ¹ç›®å½•ä¸‹çš„ä¸€ä¸ªç›®å½•ï¼Œé‚£ä¹ˆè®¾ç½®ç¨å¾®å¤æ‚ï¼Œå¯ä»¥é€šè¿‡åˆ›å»ºä¸€ä¸ª loopback æ–‡ä»¶ç³»ç»Ÿæ¥åˆ©ç”¨ Linux å†…æ ¸çš„ loopback ç‰¹æ€§å°†æ–‡ä»¶ç³»ç»ŸæŒ‚è½½åˆ° /tmp ä¸‹ï¼Œç„¶ååœ¨æŒ‚è½½æ—¶æŒ‡å®šé™åˆ¶åŠ è½½é€‰é¡¹å³å¯ã€‚</p><p>ä¸€ä¸ªç®€å•çš„æ“ä½œç¤ºä¾‹å¦‚ä¸‹ï¼š</p><pre><code>[root@server ~]# dd if=/dev/zero of=/dev/tmpfs bs=1M count=10000[root@server ~]# mke2fs -j /dev/tmpfs[root@server ~]# cp -av /tmp /tmp.old[root@server ~]# mount -o loop,noexec,nosuid,rw /dev/tmpfs /tmp[root@server ~]# chmod 1777 /tmp[root@server ~]# mv -f /tmp.old/* /tmp/[root@server ~]# rm -rf /tmp.old</code></pre><p>æœ€åï¼Œç¼–è¾‘ /etc/fstabï¼Œæ·»åŠ å¦‚ä¸‹å†…å®¹ï¼Œä»¥ä¾¿ç³»ç»Ÿåœ¨å¯åŠ¨æ—¶è‡ªåŠ¨åŠ è½½ loopback æ–‡ä»¶ç³»ç»Ÿï¼š</p><pre><code>/dev/tmpfs /tmp ext3 loop,nosuid,noexec,rw 0 0</code></pre><h3 id="Linux-åé—¨å…¥ä¾µæ£€æµ‹å·¥å…·"><a href="#Linux-åé—¨å…¥ä¾µæ£€æµ‹å·¥å…·" class="headerlink" title="Linux åé—¨å…¥ä¾µæ£€æµ‹å·¥å…·"></a><strong>Linux åé—¨å…¥ä¾µæ£€æµ‹å·¥å…·</strong></h3><p>Rootkit æ˜¯ Linux å¹³å°ä¸‹æœ€å¸¸è§çš„ä¸€ç§æœ¨é©¬åé—¨å·¥å…·ï¼Œå®ƒä¸»è¦é€šè¿‡æ›¿æ¢ç³»ç»Ÿæ–‡ä»¶æ¥è¾¾åˆ°å…¥ä¾µå’Œå’Œéšè”½çš„ç›®çš„ï¼Œè¿™ç§æœ¨é©¬æ¯”æ™®é€šæœ¨é©¬åé—¨æ›´åŠ å±é™©å’Œéšè”½ï¼Œæ™®é€šçš„æ£€æµ‹å·¥å…·å’Œæ£€æŸ¥æ‰‹æ®µå¾ˆéš¾å‘ç°è¿™ç§æœ¨é©¬ã€‚</p><p>Rootkit æ”»å‡»èƒ½åŠ›æå¼ºï¼Œå¯¹ç³»ç»Ÿçš„å±å®³å¾ˆå¤§ï¼Œå®ƒé€šè¿‡ä¸€å¥—å·¥å…·æ¥å»ºç«‹åé—¨å’Œéšè—è¡Œè¿¹ï¼Œä»è€Œè®©æ”»å‡»è€…ä¿ä½æƒé™ï¼Œä»¥ä½¿å®ƒåœ¨ä»»ä½•æ—¶å€™éƒ½å¯ä»¥ä½¿ç”¨ Root æƒé™ç™»å½•åˆ°ç³»ç»Ÿã€‚</p><p>Rootkit ä¸»è¦æœ‰ä¸¤ç§ç±»å‹ï¼šæ–‡ä»¶çº§åˆ«å’Œå†…æ ¸çº§åˆ«ï¼Œä¸‹é¢åˆ†åˆ«è¿›è¡Œç®€å•ä»‹ç»ã€‚</p><p>æ–‡ä»¶çº§åˆ«çš„ Rootkit ä¸€èˆ¬æ˜¯é€šè¿‡ç¨‹åºæ¼æ´æˆ–è€…ç³»ç»Ÿæ¼æ´è¿›å…¥ç³»ç»Ÿåï¼Œé€šè¿‡ä¿®æ”¹ç³»ç»Ÿçš„é‡è¦æ–‡ä»¶æ¥è¾¾åˆ°éšè—è‡ªå·±çš„ç›®çš„ã€‚</p><p>åœ¨ç³»ç»Ÿé­å— Rootkit æ”»å‡»åï¼Œåˆæ³•çš„æ–‡ä»¶è¢«æœ¨é©¬ç¨‹åºæ›¿ä»£ï¼Œå˜æˆäº†å¤–å£³ç¨‹åºï¼Œè€Œå…¶å†…éƒ¨æ˜¯éšè—ç€çš„åé—¨ç¨‹åºã€‚</p><p>é€šå¸¸å®¹æ˜“è¢« Rootkit æ›¿æ¢çš„ç³»ç»Ÿç¨‹åºæœ‰ loginã€lsã€psã€ifconfigã€duã€findã€netstat ç­‰ï¼Œå…¶ä¸­ login ç¨‹åºæ˜¯æœ€ç»å¸¸è¢«æ›¿æ¢çš„ã€‚</p><p>å› ä¸ºå½“è®¿é—® Linux æ—¶ï¼Œæ— è®ºæ˜¯é€šè¿‡æœ¬åœ°ç™»å½•è¿˜æ˜¯è¿œç¨‹ç™»å½•ï¼Œ/bin/login ç¨‹åºéƒ½ä¼šè¿è¡Œï¼Œç³»ç»Ÿå°†é€šè¿‡ /bin/login æ¥æ”¶é›†å¹¶æ ¸å¯¹ç”¨æˆ·çš„è´¦å·å’Œå¯†ç ã€‚</p><p>è€Œ Rootkit å°±æ˜¯åˆ©ç”¨è¿™ä¸ªç¨‹åºçš„ç‰¹ç‚¹ï¼Œä½¿ç”¨ä¸€ä¸ªå¸¦æœ‰æ ¹æƒé™åé—¨å¯†ç çš„ /bin/login æ¥æ›¿æ¢ç³»ç»Ÿçš„ /bin/loginï¼Œè¿™æ ·æ”»å‡»è€…é€šè¿‡è¾“å…¥è®¾å®šå¥½çš„å¯†ç å°±èƒ½è½»æ¾è¿›å…¥ç³»ç»Ÿã€‚</p><p>æ­¤æ—¶ï¼Œå³ä½¿ç³»ç»Ÿç®¡ç†å‘˜ä¿®æ”¹ Root å¯†ç æˆ–è€…æ¸…é™¤ Root å¯†ç ï¼Œæ”»å‡»è€…è¿˜æ˜¯ä¸€æ ·èƒ½é€šè¿‡ Root ç”¨æˆ·ç™»å½•ç³»ç»Ÿã€‚</p><p>æ”»å‡»è€…é€šå¸¸åœ¨è¿›å…¥ Linux ç³»ç»Ÿåï¼Œä¼šè¿›è¡Œä¸€ç³»åˆ—çš„æ”»å‡»åŠ¨ä½œï¼Œæœ€å¸¸è§çš„æ˜¯å®‰è£…å—…æ¢å™¨æ”¶é›†æœ¬æœºæˆ–è€…ç½‘ç»œä¸­å…¶ä»–æœåŠ¡å™¨çš„é‡è¦æ•°æ®ã€‚</p><p>åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼ŒLinux ä¸­ä¹Ÿæœ‰ä¸€äº›ç³»ç»Ÿæ–‡ä»¶ä¼šç›‘æ§è¿™äº›å·¥å…·åŠ¨ä½œï¼Œä¾‹å¦‚ ifconfig å‘½ä»¤ã€‚</p><p>æ‰€ä»¥ï¼Œæ”»å‡»è€…ä¸ºäº†é¿å…è¢«å‘ç°ï¼Œä¼šæƒ³æ–¹è®¾æ³•æ›¿æ¢å…¶ä»–ç³»ç»Ÿæ–‡ä»¶ï¼Œå¸¸è§çš„å°±æ˜¯ lsã€psã€ifconfigã€duã€findã€netstat ç­‰ã€‚</p><p>å¦‚æœè¿™äº›æ–‡ä»¶éƒ½è¢«æ›¿æ¢ï¼Œé‚£ä¹ˆåœ¨ç³»ç»Ÿå±‚é¢å°±å¾ˆéš¾å‘ç° Rootkit å·²ç»åœ¨ç³»ç»Ÿä¸­è¿è¡Œäº†ã€‚</p><p>è¿™å°±æ˜¯æ–‡ä»¶çº§åˆ«çš„ Rootkitï¼Œå¯¹ç³»ç»Ÿç»´æŠ¤å¾ˆå¤§ï¼Œç›®å‰æœ€æœ‰æ•ˆçš„é˜²å¾¡æ–¹æ³•æ˜¯å®šæœŸå¯¹ç³»ç»Ÿé‡è¦æ–‡ä»¶çš„å®Œæ•´æ€§è¿›è¡Œæ£€æŸ¥ã€‚</p><p>å¦‚æœå‘ç°æ–‡ä»¶è¢«ä¿®æ”¹æˆ–è€…è¢«æ›¿æ¢ï¼Œé‚£ä¹ˆå¾ˆå¯èƒ½ç³»ç»Ÿå·²ç»é­å—äº† Rootkit å…¥ä¾µã€‚</p><p>æ£€æŸ¥æ–‡ä»¶å®Œæ•´æ€§çš„å·¥å…·å¾ˆå¤šï¼Œå¸¸è§çš„æœ‰ Tripwireã€ aide ç­‰ï¼Œå¯ä»¥é€šè¿‡è¿™äº›å·¥å…·å®šæœŸæ£€æŸ¥æ–‡ä»¶ç³»ç»Ÿçš„å®Œæ•´æ€§ï¼Œä»¥æ£€æµ‹ç³»ç»Ÿæ˜¯å¦è¢« Rootkit å…¥ä¾µã€‚</p><p>å†…æ ¸çº§ Rootkit æ˜¯æ¯”æ–‡ä»¶çº§ Rootkit æ›´é«˜çº§çš„ä¸€ç§å…¥ä¾µæ–¹å¼ï¼Œå®ƒå¯ä»¥ä½¿æ”»å‡»è€…è·å¾—å¯¹ç³»ç»Ÿåº•å±‚çš„å®Œå…¨æ§åˆ¶æƒã€‚</p><p>æ­¤æ—¶æ”»å‡»è€…å¯ä»¥ä¿®æ”¹ç³»ç»Ÿå†…æ ¸ï¼Œè¿›è€Œæˆªè·è¿è¡Œç¨‹åºå‘å†…æ ¸æäº¤çš„å‘½ä»¤ï¼Œå¹¶å°†å…¶é‡å®šå‘åˆ°å…¥ä¾µè€…æ‰€é€‰æ‹©çš„ç¨‹åºå¹¶è¿è¡Œæ­¤ç¨‹åºã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“ç”¨æˆ·è¦è¿è¡Œç¨‹åº A æ—¶ï¼Œè¢«å…¥ä¾µè€…ä¿®æ”¹è¿‡çš„å†…æ ¸ä¼šå‡è£…æ‰§è¡Œ A ç¨‹åºï¼Œè€Œå®é™…ä¸Šå´æ‰§è¡Œäº†ç¨‹åº Bã€‚</p><p>å†…æ ¸çº§ Rootkit ä¸»è¦ä¾é™„åœ¨å†…æ ¸ä¸Šï¼Œå®ƒå¹¶ä¸å¯¹ç³»ç»Ÿæ–‡ä»¶åšä»»ä½•ä¿®æ”¹ï¼Œå› æ­¤ä¸€èˆ¬çš„æ£€æµ‹å·¥å…·å¾ˆéš¾æ£€æµ‹åˆ°å®ƒçš„å­˜åœ¨ï¼Œè¿™æ ·ä¸€æ—¦ç³»ç»Ÿå†…æ ¸è¢«æ¤å…¥ Rootkitï¼Œæ”»å‡»è€…å°±å¯ä»¥å¯¹ç³»ç»Ÿä¸ºæ‰€æ¬²ä¸ºè€Œä¸è¢«å‘ç°ã€‚</p><p>ç›®å‰å¯¹äºå†…æ ¸çº§çš„ Rootkit è¿˜æ²¡æœ‰å¾ˆå¥½çš„é˜²å¾¡å·¥å…·ï¼Œå› æ­¤ï¼Œåšå¥½ç³»ç»Ÿå®‰å…¨é˜²èŒƒå°±éå¸¸é‡è¦ï¼Œå°†ç³»ç»Ÿç»´æŒåœ¨æœ€å°æƒé™å†…å·¥ä½œï¼Œåªè¦æ”»å‡»è€…ä¸èƒ½è·å– Root æƒé™ï¼Œå°±æ— æ³•åœ¨å†…æ ¸ä¸­æ¤å…¥ Rootkitã€‚</p><h4 id="â‘ Rootkit-åé—¨æ£€æµ‹å·¥å…·-Chkrootkit"><a href="#â‘ Rootkit-åé—¨æ£€æµ‹å·¥å…·-Chkrootkit" class="headerlink" title="â‘ Rootkit åé—¨æ£€æµ‹å·¥å…· Chkrootkit"></a><strong>â‘ Rootkit åé—¨æ£€æµ‹å·¥å…· Chkrootkit</strong></h4><p>Chkrootkit æ˜¯ä¸€ä¸ª Linux ç³»ç»Ÿä¸‹æŸ¥æ‰¾å¹¶æ£€æµ‹ Rootkit åé—¨çš„å·¥å…·ï¼Œå®ƒçš„å®˜æ–¹åœ°å€ï¼š</p><pre><code>http://www.chkrootkit.org/</code></pre><p>Chkrootkit æ²¡æœ‰åŒ…å«åœ¨å®˜æ–¹çš„ CentOS æºä¸­ï¼Œå› æ­¤è¦é‡‡å–æ‰‹åŠ¨ç¼–è¯‘çš„æ–¹æ³•æ¥å®‰è£…ï¼Œä¸è¿‡è¿™ç§å®‰è£…æ–¹æ³•ä¹Ÿæ›´åŠ å®‰å…¨ã€‚</p><p>Chkrootkit çš„ä½¿ç”¨æ¯”è¾ƒç®€å•ï¼Œç›´æ¥æ‰§è¡Œ Chkrootkit å‘½ä»¤å³å¯è‡ªåŠ¨å¼€å§‹æ£€æµ‹ç³»ç»Ÿã€‚</p><p>ä¸‹é¢æ˜¯æŸä¸ªç³»ç»Ÿçš„æ£€æµ‹ç»“æœï¼š</p><pre><code>[root@server chkrootkit]# /usr/local/chkrootkit/chkrootkitChecking `ifconfig&#39;... INFECTEDChecking `ls&#39;... INFECTEDChecking `login&#39;... INFECTEDChecking `netstat&#39;... INFECTEDChecking `ps&#39;... INFECTEDChecking `top&#39;... INFECTEDChecking `sshd&#39;... not infectedChecking `syslogd&#39;... not tested</code></pre><p>ä»è¾“å‡ºå¯ä»¥çœ‹å‡ºï¼Œæ­¤ç³»ç»Ÿçš„ ifconfigã€lsã€loginã€netstatã€ps å’Œ top å‘½ä»¤å·²ç»è¢«æ„ŸæŸ“ã€‚</p><p>é’ˆå¯¹è¢«æ„ŸæŸ“ Rootkit çš„ç³»ç»Ÿï¼Œæœ€å®‰å…¨è€Œæœ‰æ•ˆçš„æ–¹æ³•å°±æ˜¯å¤‡ä»½æ•°æ®é‡æ–°å®‰è£…ç³»ç»Ÿã€‚</p><p>Chkrootkit åœ¨æ£€æŸ¥ Rootkit çš„è¿‡ç¨‹ä¸­ä½¿ç”¨äº†éƒ¨åˆ†ç³»ç»Ÿå‘½ä»¤ï¼Œå› æ­¤ï¼Œå¦‚æœæœåŠ¡å™¨è¢«é»‘å®¢å…¥ä¾µï¼Œé‚£ä¹ˆä¾èµ–çš„ç³»ç»Ÿå‘½ä»¤å¯èƒ½ä¹Ÿå·²ç»è¢«å…¥ä¾µè€…æ›¿æ¢ï¼Œæ­¤æ—¶ Chkrootkit çš„æ£€æµ‹ç»“æœå°†å˜å¾—å®Œå…¨ä¸å¯ä¿¡ã€‚</p><p>ä¸ºäº†é¿å… Chkrootkit çš„è¿™ä¸ªé—®é¢˜ï¼Œå¯ä»¥åœ¨æœåŠ¡å™¨å¯¹å¤–å¼€æ”¾å‰ï¼Œäº‹å…ˆå°† Chkrootkit ä½¿ç”¨çš„ç³»ç»Ÿå‘½ä»¤è¿›è¡Œå¤‡ä»½ï¼Œåœ¨éœ€è¦çš„æ—¶å€™ä½¿ç”¨å¤‡ä»½çš„åŸå§‹ç³»ç»Ÿå‘½ä»¤è®© Chkrootkit å¯¹ Rootkit è¿›è¡Œæ£€æµ‹ã€‚</p><h4 id="â‘¡Rootkit-åé—¨æ£€æµ‹å·¥å…·-RKHunter"><a href="#â‘¡Rootkit-åé—¨æ£€æµ‹å·¥å…·-RKHunter" class="headerlink" title="â‘¡Rootkit åé—¨æ£€æµ‹å·¥å…· RKHunter"></a><strong>â‘¡Rootkit åé—¨æ£€æµ‹å·¥å…· RKHunter</strong></h4><p>RKHunter æ˜¯ä¸€æ¬¾ä¸“ä¸šçš„æ£€æµ‹ç³»ç»Ÿæ˜¯å¦æ„ŸæŸ“ Rootkit çš„å·¥å…·ï¼Œå®ƒé€šè¿‡æ‰§è¡Œä¸€ç³»åˆ—çš„è„šæœ¬æ¥ç¡®è®¤æœåŠ¡å™¨æ˜¯å¦å·²ç»æ„ŸæŸ“ Rootkitã€‚</p><p>åœ¨å®˜æ–¹çš„èµ„æ–™ä¸­ï¼ŒRKHunter å¯ä»¥åšçš„äº‹æƒ…æœ‰ï¼š</p><pre><code>MD5æ ¡éªŒæµ‹è¯•ï¼Œæ£€æµ‹æ–‡ä»¶æ˜¯å¦æœ‰æ”¹åŠ¨ï¼Œæ¯”è¾ƒç³»ç»Ÿå‘½ä»¤çš„md5ï¼Œä»è€Œåˆ¤æ–­ç³»ç»Ÿå‘½ä»¤æ˜¯å¦è¢«ç¯¡æ”¹æ£€æµ‹rootkitä½¿ç”¨çš„äºŒè¿›åˆ¶å’Œç³»ç»Ÿå·¥å…·æ–‡ä»¶æ£€æµ‹ç‰¹æ´›ä¼Šæœ¨é©¬ç¨‹åºçš„ç‰¹å¾ç æ£€æµ‹å¸¸ç”¨ç¨‹åºçš„æ–‡ä»¶å±æ€§æ˜¯å¦å¼‚å¸¸æ£€æµ‹ç³»ç»Ÿç›¸å…³çš„æµ‹è¯•æ£€æµ‹éšè—æ–‡ä»¶æ£€æµ‹å¯ç–‘çš„æ ¸å¿ƒæ¨¡å—LKMæ£€æµ‹ç³»ç»Ÿå·²å¯åŠ¨çš„ç›‘å¬ç«¯å£</code></pre><p>åœ¨ Linux ç»ˆç«¯ä½¿ç”¨ RKHunter æ¥æ£€æµ‹ï¼Œæœ€å¤§çš„å¥½å¤„åœ¨äºæ¯é¡¹çš„æ£€æµ‹ç»“æœéƒ½æœ‰ä¸åŒçš„é¢œè‰²æ˜¾ç¤ºï¼Œå¦‚æœæ˜¯ç»¿è‰²çš„è¡¨ç¤ºæ²¡æœ‰é—®é¢˜ï¼Œå¦‚æœæ˜¯çº¢è‰²çš„ï¼Œé‚£å°±è¦å¼•èµ·å…³æ³¨äº†ã€‚</p><p>å¦å¤–ï¼Œåœ¨æ‰§è¡Œæ£€æµ‹çš„è¿‡ç¨‹ä¸­ï¼Œåœ¨æ¯ä¸ªéƒ¨åˆ†æ£€æµ‹å®Œæˆåï¼Œéœ€è¦ä»¥ Enter é”®æ¥ç»§ç»­ã€‚</p><p>å¦‚æœè¦è®©ç¨‹åºè‡ªåŠ¨è¿è¡Œï¼Œå¯ä»¥æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š</p><pre><code>[root@server ~]# /usr/local/bin/rkhunter --check --skip-keypress</code></pre><p>åŒæ—¶ï¼Œå¦‚æœæƒ³è®©æ£€æµ‹ç¨‹åºæ¯å¤©å®šæ—¶è¿è¡Œï¼Œé‚£ä¹ˆå¯ä»¥åœ¨ /etc/crontab ä¸­åŠ å…¥å¦‚ä¸‹å†…å®¹ï¼š</p><pre><code>30 09 * * * root /usr/local/bin/rkhunter --check --cronjob </code></pre><p>è¿™æ ·ï¼ŒRKHunter æ£€æµ‹ç¨‹åºå°±ä¼šåœ¨æ¯å¤©çš„ 9:30 åˆ†è¿è¡Œä¸€æ¬¡ã€‚</p><h3 id="æœåŠ¡å™¨é­å—æ”»å‡»åçš„å¤„ç†è¿‡ç¨‹"><a href="#æœåŠ¡å™¨é­å—æ”»å‡»åçš„å¤„ç†è¿‡ç¨‹" class="headerlink" title="æœåŠ¡å™¨é­å—æ”»å‡»åçš„å¤„ç†è¿‡ç¨‹"></a><strong>æœåŠ¡å™¨é­å—æ”»å‡»åçš„å¤„ç†è¿‡ç¨‹</strong></h3><p>å®‰å…¨æ€»æ˜¯ç›¸å¯¹çš„ï¼Œå†å®‰å…¨çš„æœåŠ¡å™¨ä¹Ÿæœ‰å¯èƒ½é­å—åˆ°æ”»å‡»ã€‚</p><p>ä½œä¸ºä¸€ä¸ªå®‰å…¨è¿ç»´äººå‘˜ï¼Œè¦æŠŠæ¡çš„åŸåˆ™æ˜¯ï¼šå°½é‡åšå¥½ç³»ç»Ÿå®‰å…¨é˜²æŠ¤ï¼Œä¿®å¤æ‰€æœ‰å·²çŸ¥çš„å±é™©è¡Œä¸ºï¼ŒåŒæ—¶ï¼Œåœ¨ç³»ç»Ÿé­å—æ”»å‡»åèƒ½å¤Ÿè¿…é€Ÿæœ‰æ•ˆåœ°å¤„ç†æ”»å‡»è¡Œä¸ºï¼Œæœ€å¤§é™åº¦åœ°é™ä½æ”»å‡»å¯¹ç³»ç»Ÿäº§ç”Ÿçš„å½±å“ã€‚</p><h4 id="â‘ å¤„ç†æœåŠ¡å™¨é­å—æ”»å‡»çš„ä¸€èˆ¬æ€è·¯"><a href="#â‘ å¤„ç†æœåŠ¡å™¨é­å—æ”»å‡»çš„ä¸€èˆ¬æ€è·¯" class="headerlink" title="â‘ å¤„ç†æœåŠ¡å™¨é­å—æ”»å‡»çš„ä¸€èˆ¬æ€è·¯"></a><strong>â‘ å¤„ç†æœåŠ¡å™¨é­å—æ”»å‡»çš„ä¸€èˆ¬æ€è·¯</strong></h4><p>ç³»ç»Ÿé­å—æ”»å‡»å¹¶ä¸å¯æ€•ï¼Œå¯æ€•çš„æ˜¯é¢å¯¹æ”»å‡»æŸæ‰‹æ— ç­–ï¼Œä¸‹é¢å°±è¯¦ç»†ä»‹ç»ä¸‹åœ¨æœåŠ¡å™¨é­å—æ”»å‡»åçš„ä¸€èˆ¬å¤„ç†æ€è·¯ã€‚</p><p><strong>åˆ‡æ–­ç½‘ç»œï¼š</strong>æ‰€æœ‰çš„æ”»å‡»éƒ½æ¥è‡ªäºç½‘ç»œï¼Œå› æ­¤ï¼Œåœ¨å¾—çŸ¥ç³»ç»Ÿæ­£é­å—é»‘å®¢çš„æ”»å‡»åï¼Œé¦–å…ˆè¦åšçš„å°±æ˜¯æ–­å¼€æœåŠ¡å™¨çš„ç½‘ç»œè¿æ¥ï¼Œè¿™æ ·é™¤äº†èƒ½åˆ‡æ–­æ”»å‡»æºä¹‹å¤–ï¼Œä¹Ÿèƒ½ä¿æŠ¤æœåŠ¡å™¨æ‰€åœ¨ç½‘ç»œçš„å…¶ä»–ä¸»æœºã€‚</p><p><strong>æŸ¥æ‰¾æ”»å‡»æºï¼š</strong>å¯ä»¥é€šè¿‡åˆ†æç³»ç»Ÿæ—¥å¿—æˆ–ç™»å½•æ—¥å¿—æ–‡ä»¶ï¼ŒæŸ¥çœ‹å¯ç–‘ä¿¡æ¯ï¼ŒåŒæ—¶ä¹Ÿè¦æŸ¥çœ‹ç³»ç»Ÿéƒ½æ‰“å¼€äº†å“ªäº›ç«¯å£ï¼Œè¿è¡Œå“ªäº›è¿›ç¨‹ï¼Œå¹¶é€šè¿‡è¿™äº›è¿›ç¨‹åˆ†æå“ªäº›æ˜¯å¯ç–‘çš„ç¨‹åºã€‚</p><p>è¿™ä¸ªè¿‡ç¨‹è¦æ ¹æ®ç»éªŒå’Œç»¼åˆåˆ¤æ–­èƒ½åŠ›è¿›è¡Œè¿½æŸ¥å’Œåˆ†æã€‚ä¸‹é¢ä¼šè¯¦ç»†ä»‹ç»è¿™ä¸ªè¿‡ç¨‹çš„å¤„ç†æ€è·¯ã€‚</p><p><strong>åˆ†æå…¥ä¾µåŸå› å’Œé€”å¾„ï¼š</strong>æ—¢ç„¶ç³»ç»Ÿé­åˆ°å…¥ä¾µï¼Œé‚£ä¹ˆåŸå› æ˜¯å¤šæ–¹é¢çš„ï¼Œå¯èƒ½æ˜¯ç³»ç»Ÿæ¼æ´ï¼Œä¹Ÿå¯èƒ½æ˜¯ç¨‹åºæ¼æ´ã€‚</p><p>ä¸€å®šè¦æŸ¥æ¸…æ¥šæ˜¯å“ªä¸ªåŸå› å¯¼è‡´çš„ï¼Œå¹¶ä¸”è¿˜è¦æŸ¥æ¸…æ¥šé­åˆ°æ”»å‡»çš„é€”å¾„ï¼Œæ‰¾åˆ°æ”»å‡»æºï¼Œå› ä¸ºåªæœ‰çŸ¥é“äº†é­å—æ”»å‡»çš„åŸå› å’Œé€”å¾„ï¼Œæ‰èƒ½åˆ é™¤æ”»å‡»æºåŒæ—¶è¿›è¡Œæ¼æ´çš„ä¿®å¤ã€‚</p><p><strong>å¤‡ä»½ç”¨æˆ·æ•°æ®ï¼š</strong>åœ¨æœåŠ¡å™¨é­å—æ”»å‡»åï¼Œéœ€è¦ç«‹åˆ»å¤‡ä»½æœåŠ¡å™¨ä¸Šçš„ç”¨æˆ·æ•°æ®ï¼ŒåŒæ—¶ä¹Ÿè¦æŸ¥çœ‹è¿™äº›æ•°æ®ä¸­æ˜¯å¦éšè—ç€æ”»å‡»æºã€‚</p><p>å¦‚æœæ”»å‡»æºåœ¨ç”¨æˆ·æ•°æ®ä¸­ï¼Œä¸€å®šè¦å½»åº•åˆ é™¤ï¼Œç„¶åå°†ç”¨æˆ·æ•°æ®å¤‡ä»½åˆ°ä¸€ä¸ªå®‰å…¨çš„åœ°æ–¹ã€‚</p><p><strong>é‡æ–°å®‰è£…ç³»ç»Ÿï¼š</strong>æ°¸è¿œä¸è¦è®¤ä¸ºè‡ªå·±èƒ½å½»åº•æ¸…é™¤æ”»å‡»æºï¼Œå› ä¸ºæ²¡æœ‰äººèƒ½æ¯”é»‘å®¢æ›´äº†è§£æ”»å‡»ç¨‹åºã€‚</p><p>åœ¨æœåŠ¡å™¨é­åˆ°æ”»å‡»åï¼Œæœ€å®‰å…¨ä¹Ÿæœ€ç®€å•çš„æ–¹æ³•å°±æ˜¯é‡æ–°å®‰è£…ç³»ç»Ÿï¼Œå› ä¸ºå¤§éƒ¨åˆ†æ”»å‡»ç¨‹åºéƒ½ä¼šä¾é™„åœ¨ç³»ç»Ÿæ–‡ä»¶æˆ–è€…å†…æ ¸ä¸­ï¼Œæ‰€ä»¥é‡æ–°å®‰è£…ç³»ç»Ÿæ‰èƒ½å½»åº•æ¸…é™¤æ”»å‡»æºã€‚</p><p><strong>ä¿®å¤ç¨‹åºæˆ–ç³»ç»Ÿæ¼æ´ï¼š</strong>åœ¨å‘ç°ç³»ç»Ÿæ¼æ´æˆ–è€…åº”ç”¨ç¨‹åºæ¼æ´åï¼Œé¦–å…ˆè¦åšçš„å°±æ˜¯ä¿®å¤ç³»ç»Ÿæ¼æ´æˆ–è€…æ›´æ”¹ç¨‹åº Bugï¼Œå› ä¸ºåªæœ‰å°†ç¨‹åºçš„æ¼æ´ä¿®å¤å®Œæ¯•æ‰èƒ½æ­£å¼åœ¨æœåŠ¡å™¨ä¸Šè¿è¡Œã€‚</p><p><strong>æ¢å¤æ•°æ®å’Œè¿æ¥ç½‘ç»œï¼š</strong>å°†å¤‡ä»½çš„æ•°æ®é‡æ–°å¤åˆ¶åˆ°æ–°å®‰è£…çš„æœåŠ¡å™¨ä¸Šï¼Œç„¶åå¼€å¯æœåŠ¡ï¼Œæœ€åå°†æœåŠ¡å™¨å¼€å¯ç½‘ç»œè¿æ¥ï¼Œå¯¹å¤–æä¾›æœåŠ¡ã€‚</p><h4 id="â‘¡æ£€æŸ¥å¹¶é”å®šå¯ç–‘ç”¨æˆ·"><a href="#â‘¡æ£€æŸ¥å¹¶é”å®šå¯ç–‘ç”¨æˆ·" class="headerlink" title="â‘¡æ£€æŸ¥å¹¶é”å®šå¯ç–‘ç”¨æˆ·"></a><strong>â‘¡æ£€æŸ¥å¹¶é”å®šå¯ç–‘ç”¨æˆ·</strong></h4><p>å½“å‘ç°æœåŠ¡å™¨é­å—æ”»å‡»åï¼Œé¦–å…ˆè¦åˆ‡æ–­ç½‘ç»œè¿æ¥ï¼Œä½†æ˜¯åœ¨æœ‰äº›æƒ…å†µä¸‹ï¼Œæ¯”å¦‚æ— æ³•é©¬ä¸Šåˆ‡æ–­ç½‘ç»œè¿æ¥æ—¶ï¼Œå°±å¿…é¡»ç™»å½•ç³»ç»ŸæŸ¥çœ‹æ˜¯å¦æœ‰å¯ç–‘ç”¨æˆ·ã€‚</p><p>å¦‚æœæœ‰å¯ç–‘ç”¨æˆ·ç™»å½•äº†ç³»ç»Ÿï¼Œé‚£ä¹ˆéœ€è¦é©¬ä¸Šå°†è¿™ä¸ªç”¨æˆ·é”å®šï¼Œç„¶åä¸­æ–­æ­¤ç”¨æˆ·çš„è¿œç¨‹è¿æ¥ã€‚</p><h4 id="â‘¢æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—"><a href="#â‘¢æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—" class="headerlink" title="â‘¢æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—"></a><strong>â‘¢æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—</strong></h4><p>æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—æ˜¯æŸ¥æ‰¾æ”»å‡»æºæœ€å¥½çš„æ–¹æ³•ï¼Œå¯æŸ¥çš„ç³»ç»Ÿæ—¥å¿—æœ‰ /var/log/messagesã€/var/log/secure ç­‰ã€‚</p><p>è¿™ä¸¤ä¸ªæ—¥å¿—æ–‡ä»¶å¯ä»¥è®°å½•è½¯ä»¶çš„è¿è¡ŒçŠ¶æ€ä»¥åŠè¿œç¨‹ç”¨æˆ·çš„ç™»å½•çŠ¶æ€ï¼Œè¿˜å¯ä»¥æŸ¥çœ‹æ¯ä¸ªç”¨æˆ·ç›®å½•ä¸‹çš„ .bash_history æ–‡ä»¶ã€‚</p><p>ç‰¹åˆ«æ˜¯ /root ç›®å½•ä¸‹çš„ .bash_history æ–‡ä»¶ï¼Œè¿™ä¸ªæ–‡ä»¶ä¸­è®°å½•ç€ç”¨æˆ·æ‰§è¡Œçš„æ‰€æœ‰å†å²å‘½ä»¤ã€‚</p><h4 id="â‘£æ£€æŸ¥å¹¶å…³é—­ç³»ç»Ÿå¯ç–‘è¿›ç¨‹"><a href="#â‘£æ£€æŸ¥å¹¶å…³é—­ç³»ç»Ÿå¯ç–‘è¿›ç¨‹" class="headerlink" title="â‘£æ£€æŸ¥å¹¶å…³é—­ç³»ç»Ÿå¯ç–‘è¿›ç¨‹"></a><strong>â‘£æ£€æŸ¥å¹¶å…³é—­ç³»ç»Ÿå¯ç–‘è¿›ç¨‹</strong></h4><p>æ£€æŸ¥å¯ç–‘è¿›ç¨‹çš„å‘½ä»¤å¾ˆå¤šï¼Œä¾‹å¦‚ psã€top ç­‰ï¼Œä½†æ˜¯æœ‰æ—¶å€™åªçŸ¥é“è¿›ç¨‹çš„åç§°æ— æ³•å¾—çŸ¥è·¯å¾„ï¼Œæ­¤æ—¶å¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤æŸ¥çœ‹ã€‚</p><p>é¦–å…ˆé€šè¿‡ pidof å‘½ä»¤å¯ä»¥æŸ¥æ‰¾æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹ PIDï¼Œä¾‹å¦‚è¦æŸ¥æ‰¾ sshd è¿›ç¨‹çš„ PIDã€‚</p><p><strong>æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š</strong></p><pre><code>[root@server ~]# pidof sshd13276 12942 4284</code></pre><p>ç„¶åè¿›å…¥å†…å­˜ç›®å½•ï¼ŒæŸ¥çœ‹å¯¹åº” PID ç›®å½•ä¸‹ exe æ–‡ä»¶çš„ä¿¡æ¯ï¼š</p><pre><code>[root@server ~]# ls -al /proc/13276/exe lrwxrwxrwx 1 root root 0 Oct  4 22:09 /proc/13276/exe -&gt; /usr/sbin/sshd</code></pre><p>è¿™æ ·å°±æ‰¾åˆ°äº†è¿›ç¨‹å¯¹åº”çš„å®Œæ•´æ‰§è¡Œè·¯å¾„ã€‚å¦‚æœè¿˜è¦æŸ¥çœ‹æ–‡ä»¶çš„å¥æŸ„ï¼Œå¯ä»¥æŸ¥çœ‹å¦‚ä¸‹ç›®å½•ï¼š</p><pre><code>[root@server ~]# ls -al /proc/13276/fd</code></pre><p>é€šè¿‡è¿™ç§æ–¹å¼åŸºæœ¬å¯ä»¥æ‰¾åˆ°ä»»ä½•è¿›ç¨‹çš„å®Œæ•´æ‰§è¡Œä¿¡æ¯ã€‚</p><h4 id="â‘¤æ£€æŸ¥æ–‡ä»¶ç³»ç»Ÿçš„å®Œå¥½æ€§"><a href="#â‘¤æ£€æŸ¥æ–‡ä»¶ç³»ç»Ÿçš„å®Œå¥½æ€§" class="headerlink" title="â‘¤æ£€æŸ¥æ–‡ä»¶ç³»ç»Ÿçš„å®Œå¥½æ€§"></a><strong>â‘¤æ£€æŸ¥æ–‡ä»¶ç³»ç»Ÿçš„å®Œå¥½æ€§</strong></h4><p>æ£€æŸ¥æ–‡ä»¶å±æ€§æ˜¯å¦å‘ç”Ÿå˜åŒ–æ˜¯éªŒè¯æ–‡ä»¶ç³»ç»Ÿå®Œå¥½æ€§æœ€ç®€å•ã€æœ€ç›´æ¥çš„æ–¹æ³•ï¼Œä¾‹å¦‚å¯ä»¥æ£€æŸ¥è¢«å…¥ä¾µæœåŠ¡å™¨ä¸Š /bin/ls æ–‡ä»¶çš„å¤§å°æ˜¯å¦ä¸æ­£å¸¸ç³»ç»Ÿä¸Šæ­¤æ–‡ä»¶çš„å¤§å°ç›¸åŒï¼Œä»¥éªŒè¯æ–‡ä»¶æ˜¯å¦è¢«æ›¿æ¢ï¼Œä½†æ˜¯è¿™ç§æ–¹æ³•æ¯”è¾ƒä½çº§ã€‚</p><p><strong>æ­¤æ—¶å¯ä»¥å€ŸåŠ©äº Linux ä¸‹ rpm è¿™ä¸ªå·¥å…·æ¥å®ŒæˆéªŒè¯ï¼Œæ“ä½œå¦‚ä¸‹ï¼š</strong></p><pre><code>[root@server ~]# rpm -Va....L...  c /etc/pam.d/system-authS.5.....  c /etc/security/limits.confS.5....T  c /etc/sysctl.confS.5....T    /etc/sgml/docbook-simple.catS.5....T  c /etc/login.defsS.5.....  c /etc/openldap/ldap.confS.5....T  c /etc/sudoers</code></pre><h4 id="â‘¥é‡æ–°å®‰è£…ç³»ç»Ÿæ¢å¤æ•°æ®"><a href="#â‘¥é‡æ–°å®‰è£…ç³»ç»Ÿæ¢å¤æ•°æ®" class="headerlink" title="â‘¥é‡æ–°å®‰è£…ç³»ç»Ÿæ¢å¤æ•°æ®"></a><strong>â‘¥é‡æ–°å®‰è£…ç³»ç»Ÿæ¢å¤æ•°æ®</strong></h4><p>å¾ˆå¤šæƒ…å†µä¸‹ï¼Œè¢«æ”»å‡»è¿‡çš„ç³»ç»Ÿå·²ç»ä¸å†å¯ä¿¡ä»»ï¼Œå› æ­¤ï¼Œæœ€å¥½çš„æ–¹æ³•æ˜¯å°†æœåŠ¡å™¨ä¸Šé¢æ•°æ®è¿›è¡Œå¤‡ä»½ï¼Œç„¶åé‡æ–°å®‰è£…ç³»ç»Ÿï¼Œæœ€åå†æ¢å¤æ•°æ®å³å¯ã€‚</p><p>æ•°æ®æ¢å¤å®Œæˆï¼Œé©¬ä¸Šå¯¹ç³»ç»Ÿåšä¸Šé¢ä»‹ç»çš„å®‰å…¨åŠ å›ºç­–ç•¥ï¼Œä¿è¯ç³»ç»Ÿå®‰å…¨ã€‚</p><blockquote><p>åŸæ–‡é“¾æ¥å¦‚ä¸‹ï¼š</p><p><a href="https://www.cnblogs.com/MYSQLZOUQI/p/5317916.html" target="_blank" rel="noopener">https://www.cnblogs.com/MYSQLZOUQI/p/5317916.html</a></p></blockquote>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>tmux-åˆæ¢</title>
      <link href="2019/09/05/linux/rang-ni-de-linux-ku-qi-lai-xiao-bai-ye-neng-wan-zhuan-tmux/"/>
      <url>2019/09/05/linux/rang-ni-de-linux-ku-qi-lai-xiao-bai-ye-neng-wan-zhuan-tmux/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h3 id="Linuxç»ˆç«¯å¤ç”¨ç¥å™¨-tmuxåˆæ¢"><a href="#Linuxç»ˆç«¯å¤ç”¨ç¥å™¨-tmuxåˆæ¢" class="headerlink" title="Linuxç»ˆç«¯å¤ç”¨ç¥å™¨-tmuxåˆæ¢"></a>Linuxç»ˆç«¯å¤ç”¨ç¥å™¨-tmuxåˆæ¢</h3><pre><code>Tmuxæ˜¯ä¸€ä¸ªä¼˜ç§€çš„ç»ˆç«¯å¤ç”¨è½¯ä»¶ï¼Œç±»ä¼¼GNU Screenï¼Œä½†æ¥è‡ªäºOpenBSDï¼Œé‡‡ç”¨BSDæˆæƒã€‚ä½¿ç”¨å®ƒæœ€ç›´è§‚çš„å¥½å¤„å°±æ˜¯ï¼Œé€šè¿‡ä¸€ä¸ªç»ˆç«¯ç™»å½•è¿œç¨‹ä¸»æœºå¹¶è¿è¡Œtmuxåï¼Œåœ¨å…¶ä¸­å¯ä»¥å¼€å¯å¤šä¸ªæ§åˆ¶å°è€Œæ— éœ€å†â€œæµªè´¹â€å¤šä½™çš„ç»ˆç«¯æ¥è¿æ¥è¿™å°è¿œç¨‹ä¸»æœºã€‚æ˜¯BSDå®ç°çš„Screenæ›¿ä»£å“ï¼Œç›¸å¯¹äºScreenï¼Œå®ƒæ›´åŠ å…ˆè¿›ï¼šæ”¯æŒå±å¹•åˆ‡åˆ†ï¼Œè€Œä¸”å…·å¤‡ä¸°å¯Œçš„å‘½ä»¤è¡Œå‚æ•°ï¼Œä½¿å…¶å¯ä»¥çµæ´»ã€åŠ¨æ€çš„è¿›è¡Œå„ç§å¸ƒå±€å’Œæ“ä½œã€‚</code></pre><p>åºŸè¯ä¸å¤šè¯´æ¥ä¸ªæ•ˆæœå›¾<br><img src="https://i.loli.net/2018/12/14/5c139f4ab6ad2.jpg" alt="tmux"></p><h3 id="Tmuxçš„ä½¿ç”¨åœºæ™¯"><a href="#Tmuxçš„ä½¿ç”¨åœºæ™¯" class="headerlink" title="Tmuxçš„ä½¿ç”¨åœºæ™¯"></a>Tmuxçš„ä½¿ç”¨åœºæ™¯</h3><pre><code>1ï¼‰å¯ä»¥æŸä¸ªç¨‹åºåœ¨æ‰§è¡Œæ—¶ä¸€ç›´æ˜¯è¾“å‡ºçŠ¶æ€ï¼Œéœ€è¦ç»“åˆnohupã€&amp;æ¥æ”¾åœ¨åå°æ‰§è¡Œï¼Œå¹¶ä¸”ctrl+cç»“æŸã€‚è¿™æ—¶å¯ä»¥æ‰“å¼€ä¸€ä¸ªTmuxçª—å£ï¼Œåœ¨è¯¥çª—å£é‡Œæ‰§è¡Œè¿™ä¸ªç¨‹åºï¼Œç”¨æ¥ä¿è¯è¯¥ç¨‹åºä¸€ç›´åœ¨æ‰§è¡Œä¸­ï¼Œåªè¦Tmuxè¿™ä¸ªçª—å£ä¸å…³é—­2ï¼‰å…¬å¸éœ€è¦å¤‡ä»½æ•°æ®åº“æ—¶ï¼Œæ•°æ®é‡å·¨å¤§ï¼Œå¤‡ä»½ä¸¤ä¸‰å¤©å¼„ä¸å®Œï¼Œè¿™æ—¶ä¸å°å¿ƒå…³é—­äº†ç»ˆç«¯çª—å£æˆ–è¯¯æ“ä½œå°±å‰åŠŸå°½å¼ƒäº†ï¼Œä½¿ç”¨Tmuxä¼šè¯è¿è¡Œå‘½ä»¤æˆ–ä»»åŠ¡ï¼Œå°±ä¸ç”¨æ‹…å¿ƒè¿™äº›é—®é¢˜ã€‚3ï¼‰ä¸‹ç­åï¼Œä½ éœ€è¦æ–­å¼€sshæˆ–å…³é—­ç”µè„‘ï¼Œå°†è¿è¡Œçš„å‘½ä»¤æˆ–ä»»åŠ¡æ”¾ç½®åå°è¿è¡Œã€‚4ï¼‰å…³é—­ç»ˆç«¯,å†æ¬¡æ‰“å¼€æ—¶åŸç»ˆç«¯é‡Œé¢çš„ä»»åŠ¡è¿›ç¨‹ä¾ç„¶ä¸ä¼šä¸­æ–­</code></pre><h3 id="TmuxåŠŸèƒ½ï¼š"><a href="#TmuxåŠŸèƒ½ï¼š" class="headerlink" title="TmuxåŠŸèƒ½ï¼š"></a>TmuxåŠŸèƒ½ï¼š</h3><pre><code>-  æä¾›äº†å¼ºåŠ²çš„ã€æ˜“äºä½¿ç”¨çš„å‘½ä»¤è¡Œç•Œé¢ã€‚-  å¯æ¨ªå‘å’Œçºµå‘åˆ†å‰²çª—å£ã€‚-  çª—æ ¼å¯ä»¥è‡ªç”±ç§»åŠ¨å’Œè°ƒæ•´å¤§å°ï¼Œæˆ–ç›´æ¥åˆ©ç”¨å››ä¸ªé¢„è®¾å¸ƒå±€ä¹‹ä¸€ã€‚-  æ”¯æŒ UTF-8 ç¼–ç åŠ 256 è‰²ç»ˆç«¯ã€‚-  å¯åœ¨å¤šä¸ªç¼“å†²åŒºè¿›è¡Œå¤åˆ¶å’Œç²˜è´´ã€‚-  å¯é€šè¿‡äº¤äº’å¼èœå•æ¥é€‰æ‹©çª—å£ã€ä¼šè¯åŠå®¢æˆ·ç«¯ã€‚-  æ”¯æŒè·¨çª—å£æœç´¢ã€‚-  æ”¯æŒè‡ªåŠ¨åŠæ‰‹åŠ¨é”å®šçª—å£ã€‚</code></pre><h3 id="Tmuxå®‰è£…"><a href="#Tmuxå®‰è£…" class="headerlink" title="Tmuxå®‰è£…"></a>Tmuxå®‰è£…</h3><pre><code>yum -y install tmux</code></pre><h3 id="Tmuxä¸ªæ€§åŒ–é…ç½®"><a href="#Tmuxä¸ªæ€§åŒ–é…ç½®" class="headerlink" title="Tmuxä¸ªæ€§åŒ–é…ç½®"></a>Tmuxä¸ªæ€§åŒ–é…ç½®</h3><pre><code>æ­¤ç±»é…ç½®å¯ä»¥åœ¨å‘½ä»¤è¡Œæ¨¡å¼ä¸­è¾“å…¥show-options -gæŸ¥è¯¢tmuxåŠ ä¸Šä¸‹åˆ—å‚æ•°,å®ç°ä¸ªæ€§åŒ–è®¾ç½®set-option -g base-index 1                        # çª—å£çš„åˆå§‹åºå·ï¼›é»˜è®¤ä¸º0ï¼Œè¿™é‡Œè®¾ç½®ä¸º1set-option -g display-time 5000                   # æç¤ºä¿¡æ¯çš„æŒç»­æ—¶é—´ï¼›è®¾ç½®è¶³å¤Ÿçš„æ—¶é—´ä»¥é¿å…çœ‹ä¸æ¸…æç¤ºï¼Œå•ä½ä¸ºæ¯«ç§’set-option -g repeat-time 1000                    # æ§åˆ¶å°æ¿€æ´»åçš„æŒç»­æ—¶é—´ï¼›è®¾ç½®åˆé€‚çš„æ—¶é—´ä»¥é¿å…æ¯æ¬¡æ“ä½œéƒ½è¦å…ˆæ¿€æ´»æ§åˆ¶å°ï¼Œå•ä½ä¸ºæ¯«ç§’set-option -g status-keys vi                      # æ“ä½œçŠ¶æ€æ æ—¶çš„é»˜è®¤é”®ç›˜å¸ƒå±€ï¼›å¯ä»¥è®¾ç½®ä¸ºviæˆ–emacsset-option -g status-utf8 on                      # å¼€å¯çŠ¶æ€æ çš„UTF-8æ”¯æŒ---set-option -g status-bg blueset-option -g status-fg &#39;#bbbbbb&#39;set-option -g status-left-fg greenset-option -g status-left-bg blueset-option -g status-right-fg greenset-option -g status-right-bg blueset-option -g status-left-length 10               # çŠ¶æ€æ å·¦æ–¹çš„å†…å®¹é•¿åº¦ï¼›set-option -g status-right-length 15              # çŠ¶æ€æ å³æ–¹çš„å†…å®¹é•¿åº¦ï¼›å»ºè®®æŠŠæ›´å¤šçš„ç©ºé—´ç•™ç»™çŠ¶æ€æ å·¦æ–¹ï¼ˆç”¨äºåˆ—å‡ºå½“å‰çª—å£ï¼‰set-option -g status-left &#39;[#(whoami)]&#39;           # çŠ¶æ€æ å·¦æ–¹çš„å†…å®¹set-option -g status-right &#39;[#(date +&quot; %m-%d %H:%M &quot;)]&#39;     # çŠ¶æ€æ å³æ–¹çš„å†…å®¹ï¼›è¿™é‡Œçš„è®¾ç½®å°†å¾—åˆ°ç±»ä¼¼23:59çš„æ˜¾ç¤ºset-option -g status-justify &quot;centre&quot;             # çª—å£åˆ—è¡¨å±…ä¸­æ˜¾ç¤ºset-option -g default-terminal &quot;screen-256color&quot;  # æ”¯æŒ256è‰²æ˜¾ç¤ºåˆ†å‰²çª—å£è¾¹ç•Œçš„é¢œè‰²set-option -g pane-active-border-fg &#39;#55ff55&#39;set-option -g pane-border-fg &#39;#555555&#39;---æ­¤ç±»è®¾ç½®å¯ä»¥åœ¨å‘½ä»¤è¡Œæ¨¡å¼ä¸­è¾“å…¥show-window-options -gæŸ¥è¯¢set-window-option -g mode-keys vi    # å¤åˆ¶æ¨¡å¼ä¸­çš„é»˜è®¤é”®ç›˜å¸ƒå±€ï¼›å¯ä»¥è®¾ç½®ä¸ºviæˆ–emacsset-window-option -g utf8 on         # å¼€å¯çª—å£çš„UTF-8æ”¯æŒset-window-option -g mode-mouse on   # çª—å£åˆ‡æ¢åè®©äººå¯ä»¥ç”¨é¼ æ ‡ä¸Šä¸‹æ»‘åŠ¨æ˜¾ç¤ºå†å²è¾“å‡º---çª—å£åˆ‡åˆ†å¿«æ·é”®(æ²¡è®¾ç½®æˆåŠŸ)bind \ split-window -h                      # ä½¿ç”¨ \ å°†çª—å£ç«–åˆ‡bind - split-window -v                      # ä½¿ç”¨ - å°†çª—å£æ¨ªåˆ‡bind K confirm-before -p &quot;kill-window #W? (y/n)&quot; kill-window    # ä½¿ç”¨å¤§å†™ K æ¥å…³é—­çª—å£bind &#39;&quot;&#39; choose-window                      # åŒå¼•å·é€‰æ‹©çª—å£---Paneä¹‹é—´åˆ‡æ¢çš„å¿«æ·é”®bind h select-pane -L                       # å®šä½åˆ°å·¦è¾¹çª—å£çš„å¿«æ·é”®bind j select-pane -D                       # å®šä½åˆ°ä¸Šè¾¹çª—å£çš„å¿«æ·é”®bind k select-pane -U                       # å®šä½åˆ°ä¸‹æ–¹çª—å£çš„å¿«æ·é”®bind l select-pane -R                       # å®šä½åˆ°å³è¾¹çª—å£çš„å¿«æ·é”®---è®¾ç½®windowå±æ€§setw -g window-status-current-bg redsetw -g window-status-current-fg whitesetw -g window-status-current-attr brightsetw -g window-status-attr brightset-option -g window-status-format &#39;#I #W&#39;set-option -g window-status-current-format &#39; #I #W &#39;setw -g window-status-current-bg bluesetw -g window-status-current-fg greenä¸ä½¿ç”¨prefixé”®ï¼Œä½¿ç”¨Ctrlå’Œå·¦å³æ–¹å‘é”®æ–¹ä¾¿åˆ‡æ¢çª—å£bind-key -n &quot;C-Left&quot; select-window -t :-bind-key -n &quot;C-Right&quot; select-window -t :+</code></pre><h3 id="tmux-session-ä½¿ç”¨ä»‹ç»"><a href="#tmux-session-ä½¿ç”¨ä»‹ç»" class="headerlink" title="tmux session ä½¿ç”¨ä»‹ç»"></a>tmux session ä½¿ç”¨ä»‹ç»</h3><pre><code>è¿è¡Œtmuxå¹¶å¼€å¯ä¸€ä¸ªæ–°çš„ä¼šè¯tmuxæ˜¾ç¤ºæ‰€æœ‰ä¼šè¯tmux lsæ–°å»ºä¼šè¯å¹¶æŒ‡å®šä¼šè¯åç§°ï¼ˆå»ºè®®åˆ¶å®šä¼šè¯åç§°ï¼Œä»¥ä¾¿äº†è§£è¯¥ä¼šè¯ç”¨é€”ï¼‰tmux new -s &lt;session-name&gt;æ–°å»ºä¼šè¯ï¼ˆä¸æŒ‡å®šä¼šè¯åç§°ï¼‰tmux newæ¥å…¥ä¸Šä¸€ä¸ªä¼šè¯tmux aæ¥å…¥æŒ‡å®šåç§°çš„ä¼šè¯tmux a -t &lt;session-name&gt;æ–­å¼€å½“å‰ä¼šè¯ï¼ˆè¿˜å¯ä»¥ä½¿ç”¨å¿«æ·é”®ï¼šcontrol+bï¼Œå†æŒ‰dï¼‰tmux detachå…³é—­æŒ‡å®šä¼šè¯tmux kill-session -t session-nameå…³é—­é™¤æŒ‡å®šä¼šè¯å¤–çš„æ‰€æœ‰ä¼šè¯tmux kill-session -a -t session-nameåœ¨ä¼šè¯ä¸­åˆ‡æ¢control+bï¼Œå†æŒ‰s æ˜¾ç¤ºä¼šè¯åˆ—è¡¨ï¼Œå†è¿›è¡Œä¼šè¯åˆ‡æ¢é”€æ¯æ‰€æœ‰ä¼šè¯å¹¶åœæ­¢tmuxtmux kill-serverGå¤åˆ¶ç²˜è´´Ctrl+b   [          //è¿›å…¥å¤åˆ¶æ¨¡å¼ç©ºæ ¼+æ–¹å‘é”®      //é€‰æ‹©å›è½¦                  //  ç¡®è®¤Ctrl+b  [           //ç²˜è´´</code></pre><h3 id="éœ€è¦æ³¨æ„çš„å‡ ç‚¹"><a href="#éœ€è¦æ³¨æ„çš„å‡ ç‚¹" class="headerlink" title="éœ€è¦æ³¨æ„çš„å‡ ç‚¹"></a>éœ€è¦æ³¨æ„çš„å‡ ç‚¹</h3><pre><code>1ï¼‰è¿›å…¥tmuxé¢æ¿åï¼Œä¸€å®šè¦å…ˆæŒ‰ctrl+bï¼Œç„¶åæ¾å¼€ï¼Œå†æŒ‰å…¶ä»–çš„ç»„åˆé”®æ‰ç”Ÿæ•ˆã€‚2ï¼‰å¸¸ç”¨åˆ°çš„å‡ ä¸ªç»„åˆé”®ï¼šctrl+b ?            æ˜¾ç¤ºå¿«æ·é”®å¸®åŠ©ctrl+b ç©ºæ ¼é”®       é‡‡ç”¨ä¸‹ä¸€ä¸ªå†…ç½®å¸ƒå±€ï¼Œè¿™ä¸ªå¾ˆæœ‰æ„æ€ï¼Œåœ¨å¤šå±æ—¶ï¼Œç”¨è¿™ä¸ªå°±ä¼šå°†å¤šæœ‰å±å¹•ç«–ç€å±•ç¤ºctrl+b !            æŠŠå½“å‰çª—å£å˜ä¸ºæ–°çª—å£ctrl+b  &quot;           æ¨¡å‘åˆ†éš”çª—å£ctrl+b %            çºµå‘åˆ†éš”çª—å£ctrl+b q            æ˜¾ç¤ºåˆ†éš”çª—å£çš„ç¼–å·ctrl+b o            è·³åˆ°ä¸‹ä¸€ä¸ªåˆ†éš”çª—å£ã€‚å¤šå±ä¹‹é—´çš„åˆ‡æ¢ctrl+b ä¸Šä¸‹é”®      ä¸Šä¸€ä¸ªåŠä¸‹ä¸€ä¸ªåˆ†éš”çª—å£ctrl+b C-æ–¹å‘é”®    è°ƒæ•´åˆ†éš”çª—å£å¤§å°ctrl+b &amp;           ç¡®è®¤åé€€å‡ºå½“å‰tmuxctrl+b [           å¤åˆ¶æ¨¡å¼ï¼Œå³å°†å½“å‰å±å¹•ç§»åˆ°ä¸Šä¸€ä¸ªçš„ä½ç½®ä¸Šï¼Œå…¶ä»–æ‰€æœ‰çª—å£éƒ½å‘å‰ç§»åŠ¨ä¸€ä¸ªã€‚ctrl+b c           åˆ›å»ºæ–°çª—å£ctrl+b n           é€‰æ‹©ä¸‹ä¸€ä¸ªçª—å£ctrl+b l           æœ€åä½¿ç”¨çš„çª—å£ctrl+b p           é€‰æ‹©å‰ä¸€ä¸ªçª—å£ctrl+b w           ä»¥èœå•æ–¹å¼æ˜¾ç¤ºåŠé€‰æ‹©çª—å£ctrl+b s           ä»¥èœå•æ–¹å¼æ˜¾ç¤ºå’Œé€‰æ‹©ä¼šè¯ã€‚è¿™ä¸ªå¸¸ç”¨åˆ°ï¼Œå¯ä»¥é€‰æ‹©è¿›å…¥å“ªä¸ªtmuxctrl+b t           æ˜¾ç¤ºæ—¶é’Ÿã€‚ç„¶åæŒ‰enteré”®åå°±ä¼šæ¢å¤åˆ°shellç»ˆç«¯çŠ¶æ€ctrl+b d           è„±ç¦»å½“å‰ä¼šè¯ï¼›è¿™æ ·å¯ä»¥æš‚æ—¶è¿”å›Shellç•Œé¢ï¼Œè¾“å…¥tmux attachèƒ½å¤Ÿé‡æ–°è¿›å…¥ä¹‹å‰çš„ä¼šè¯</code></pre><h3 id="tmuxçš„å¸¸è§„è¿ç»´å‘½ä»¤"><a href="#tmuxçš„å¸¸è§„è¿ç»´å‘½ä»¤" class="headerlink" title="tmuxçš„å¸¸è§„è¿ç»´å‘½ä»¤"></a>tmuxçš„å¸¸è§„è¿ç»´å‘½ä»¤</h3><pre><code>1ï¼‰å®‰è£…å‘½ä»¤ï¼šã€€[root@---title: tmux-åˆæ¢date: 2018-12-07 13:59:25tags:  - tmux  - éªšæ“ä½œ---### Linuxç»ˆç«¯å¤ç”¨ç¥å™¨-tmuxåˆæ¢â€‹```Tmuxæ˜¯ä¸€ä¸ªä¼˜ç§€çš„ç»ˆç«¯å¤ç”¨è½¯ä»¶ï¼Œç±»ä¼¼GNU Screenï¼Œä½†æ¥è‡ªäºOpenBSDï¼Œé‡‡ç”¨BSDæˆæƒã€‚ä½¿ç”¨å®ƒæœ€ç›´è§‚çš„å¥½å¤„å°±æ˜¯ï¼Œé€šè¿‡ä¸€ä¸ªç»ˆç«¯ç™»å½•è¿œç¨‹ä¸»æœºå¹¶è¿è¡Œtmuxåï¼Œåœ¨å…¶ä¸­å¯ä»¥å¼€å¯å¤šä¸ªæ§åˆ¶å°è€Œæ— éœ€å†â€œæµªè´¹â€å¤šä½™çš„ç»ˆç«¯æ¥è¿æ¥è¿™å°è¿œç¨‹ä¸»æœºã€‚æ˜¯BSDå®ç°çš„Screenæ›¿ä»£å“ï¼Œç›¸å¯¹äºScreenï¼Œå®ƒæ›´åŠ å…ˆè¿›ï¼šæ”¯æŒå±å¹•åˆ‡åˆ†ï¼Œè€Œä¸”å…·å¤‡ä¸°å¯Œçš„å‘½ä»¤è¡Œå‚æ•°ï¼Œä½¿å…¶å¯ä»¥çµæ´»ã€åŠ¨æ€çš„è¿›è¡Œå„ç§å¸ƒå±€å’Œæ“ä½œã€‚â€‹```åºŸè¯ä¸å¤šè¯´æ¥ä¸ªæ•ˆæœå›¾![tmux](https://i.loli.net/2018/12/14/5c139f4ab6ad2.jpg)### Tmuxçš„ä½¿ç”¨åœºæ™¯â€‹```1ï¼‰å¯ä»¥æŸä¸ªç¨‹åºåœ¨æ‰§è¡Œæ—¶ä¸€ç›´æ˜¯è¾“å‡ºçŠ¶æ€ï¼Œéœ€è¦ç»“åˆnohupã€&amp;æ¥æ”¾åœ¨åå°æ‰§è¡Œï¼Œå¹¶ä¸”ctrl+cç»“æŸã€‚è¿™æ—¶å¯ä»¥æ‰“å¼€ä¸€ä¸ªTmuxçª—å£ï¼Œåœ¨è¯¥çª—å£é‡Œæ‰§è¡Œè¿™ä¸ªç¨‹åºï¼Œç”¨æ¥ä¿è¯è¯¥ç¨‹åºä¸€ç›´åœ¨æ‰§è¡Œä¸­ï¼Œåªè¦Tmuxè¿™ä¸ªçª—å£ä¸å…³é—­2ï¼‰å…¬å¸éœ€è¦å¤‡ä»½æ•°æ®åº“æ—¶ï¼Œæ•°æ®é‡å·¨å¤§ï¼Œå¤‡ä»½ä¸¤ä¸‰å¤©å¼„ä¸å®Œï¼Œè¿™æ—¶ä¸å°å¿ƒå…³é—­äº†ç»ˆç«¯çª—å£æˆ–è¯¯æ“ä½œå°±å‰åŠŸå°½å¼ƒäº†ï¼Œä½¿ç”¨Tmuxä¼šè¯è¿è¡Œå‘½ä»¤æˆ–ä»»åŠ¡ï¼Œå°±ä¸ç”¨æ‹…å¿ƒè¿™äº›é—®é¢˜ã€‚3ï¼‰ä¸‹ç­åï¼Œä½ éœ€è¦æ–­å¼€sshæˆ–å…³é—­ç”µè„‘ï¼Œå°†è¿è¡Œçš„å‘½ä»¤æˆ–ä»»åŠ¡æ”¾ç½®åå°è¿è¡Œã€‚4ï¼‰å…³é—­ç»ˆç«¯,å†æ¬¡æ‰“å¼€æ—¶åŸç»ˆç«¯é‡Œé¢çš„ä»»åŠ¡è¿›ç¨‹ä¾ç„¶ä¸ä¼šä¸­æ–­â€‹```&lt;!--more--&gt;### TmuxåŠŸèƒ½ï¼šâ€‹```-  æä¾›äº†å¼ºåŠ²çš„ã€æ˜“äºä½¿ç”¨çš„å‘½ä»¤è¡Œç•Œé¢ã€‚-  å¯æ¨ªå‘å’Œçºµå‘åˆ†å‰²çª—å£ã€‚-  çª—æ ¼å¯ä»¥è‡ªç”±ç§»åŠ¨å’Œè°ƒæ•´å¤§å°ï¼Œæˆ–ç›´æ¥åˆ©ç”¨å››ä¸ªé¢„è®¾å¸ƒå±€ä¹‹ä¸€ã€‚-  æ”¯æŒ UTF-8 ç¼–ç åŠ 256 è‰²ç»ˆç«¯ã€‚-  å¯åœ¨å¤šä¸ªç¼“å†²åŒºè¿›è¡Œå¤åˆ¶å’Œç²˜è´´ã€‚-  å¯é€šè¿‡äº¤äº’å¼èœå•æ¥é€‰æ‹©çª—å£ã€ä¼šè¯åŠå®¢æˆ·ç«¯ã€‚-  æ”¯æŒè·¨çª—å£æœç´¢ã€‚-  æ”¯æŒè‡ªåŠ¨åŠæ‰‹åŠ¨é”å®šçª—å£ã€‚â€‹```### Tmuxå®‰è£…â€‹```yum -y install tmuxâ€‹```### Tmuxä¸ªæ€§åŒ–é…ç½®â€‹```æ­¤ç±»é…ç½®å¯ä»¥åœ¨å‘½ä»¤è¡Œæ¨¡å¼ä¸­è¾“å…¥show-options -gæŸ¥è¯¢tmuxåŠ ä¸Šä¸‹åˆ—å‚æ•°,å®ç°ä¸ªæ€§åŒ–è®¾ç½®set-option -g base-index 1                        # çª—å£çš„åˆå§‹åºå·ï¼›é»˜è®¤ä¸º0ï¼Œè¿™é‡Œè®¾ç½®ä¸º1set-option -g display-time 5000                   # æç¤ºä¿¡æ¯çš„æŒç»­æ—¶é—´ï¼›è®¾ç½®è¶³å¤Ÿçš„æ—¶é—´ä»¥é¿å…çœ‹ä¸æ¸…æç¤ºï¼Œå•ä½ä¸ºæ¯«ç§’set-option -g repeat-time 1000                    # æ§åˆ¶å°æ¿€æ´»åçš„æŒç»­æ—¶é—´ï¼›è®¾ç½®åˆé€‚çš„æ—¶é—´ä»¥é¿å…æ¯æ¬¡æ“ä½œéƒ½è¦å…ˆæ¿€æ´»æ§åˆ¶å°ï¼Œå•ä½ä¸ºæ¯«ç§’set-option -g status-keys vi                      # æ“ä½œçŠ¶æ€æ æ—¶çš„é»˜è®¤é”®ç›˜å¸ƒå±€ï¼›å¯ä»¥è®¾ç½®ä¸ºviæˆ–emacsset-option -g status-utf8 on                      # å¼€å¯çŠ¶æ€æ çš„UTF-8æ”¯æŒ---set-option -g status-bg blueset-option -g status-fg &#39;#bbbbbb&#39;set-option -g status-left-fg greenset-option -g status-left-bg blueset-option -g status-right-fg greenset-option -g status-right-bg blueset-option -g status-left-length 10               # çŠ¶æ€æ å·¦æ–¹çš„å†…å®¹é•¿åº¦ï¼›set-option -g status-right-length 15              # çŠ¶æ€æ å³æ–¹çš„å†…å®¹é•¿åº¦ï¼›å»ºè®®æŠŠæ›´å¤šçš„ç©ºé—´ç•™ç»™çŠ¶æ€æ å·¦æ–¹ï¼ˆç”¨äºåˆ—å‡ºå½“å‰çª—å£ï¼‰set-option -g status-left &#39;[#(whoami)]&#39;           # çŠ¶æ€æ å·¦æ–¹çš„å†…å®¹set-option -g status-right &#39;[#(date +&quot; %m-%d %H:%M &quot;)]&#39;     # çŠ¶æ€æ å³æ–¹çš„å†…å®¹ï¼›è¿™é‡Œçš„è®¾ç½®å°†å¾—åˆ°ç±»ä¼¼23:59çš„æ˜¾ç¤ºset-option -g status-justify &quot;centre&quot;             # çª—å£åˆ—è¡¨å±…ä¸­æ˜¾ç¤ºset-option -g default-terminal &quot;screen-256color&quot;  # æ”¯æŒ256è‰²æ˜¾ç¤ºåˆ†å‰²çª—å£è¾¹ç•Œçš„é¢œè‰²set-option -g pane-active-border-fg &#39;#55ff55&#39;set-option -g pane-border-fg &#39;#555555&#39;---æ­¤ç±»è®¾ç½®å¯ä»¥åœ¨å‘½ä»¤è¡Œæ¨¡å¼ä¸­è¾“å…¥show-window-options -gæŸ¥è¯¢set-window-option -g mode-keys vi    # å¤åˆ¶æ¨¡å¼ä¸­çš„é»˜è®¤é”®ç›˜å¸ƒå±€ï¼›å¯ä»¥è®¾ç½®ä¸ºviæˆ–emacsset-window-option -g utf8 on         # å¼€å¯çª—å£çš„UTF-8æ”¯æŒset-window-option -g mode-mouse on   # çª—å£åˆ‡æ¢åè®©äººå¯ä»¥ç”¨é¼ æ ‡ä¸Šä¸‹æ»‘åŠ¨æ˜¾ç¤ºå†å²è¾“å‡º---çª—å£åˆ‡åˆ†å¿«æ·é”®(æ²¡è®¾ç½®æˆåŠŸ)bind \ split-window -h                      # ä½¿ç”¨ \ å°†çª—å£ç«–åˆ‡bind - split-window -v                      # ä½¿ç”¨ - å°†çª—å£æ¨ªåˆ‡bind K confirm-before -p &quot;kill-window #W? (y/n)&quot; kill-window    # ä½¿ç”¨å¤§å†™ K æ¥å…³é—­çª—å£bind &#39;&quot;&#39; choose-window                      # åŒå¼•å·é€‰æ‹©çª—å£---Paneä¹‹é—´åˆ‡æ¢çš„å¿«æ·é”®bind h select-pane -L                       # å®šä½åˆ°å·¦è¾¹çª—å£çš„å¿«æ·é”®bind j select-pane -D                       # å®šä½åˆ°ä¸Šè¾¹çª—å£çš„å¿«æ·é”®bind k select-pane -U                       # å®šä½åˆ°ä¸‹æ–¹çª—å£çš„å¿«æ·é”®bind l select-pane -R                       # å®šä½åˆ°å³è¾¹çª—å£çš„å¿«æ·é”®---è®¾ç½®windowå±æ€§setw -g window-status-current-bg redsetw -g window-status-current-fg whitesetw -g window-status-current-attr brightsetw -g window-status-attr brightset-option -g window-status-format &#39;#I #W&#39;set-option -g window-status-current-format &#39; #I #W &#39;setw -g window-status-current-bg bluesetw -g window-status-current-fg greenä¸ä½¿ç”¨prefixé”®ï¼Œä½¿ç”¨Ctrlå’Œå·¦å³æ–¹å‘é”®æ–¹ä¾¿åˆ‡æ¢çª—å£bind-key -n &quot;C-Left&quot; select-window -t :-bind-key -n &quot;C-Right&quot; select-window -t :+â€‹```### tmux session ä½¿ç”¨ä»‹ç»â€‹```è¿è¡Œtmuxå¹¶å¼€å¯ä¸€ä¸ªæ–°çš„ä¼šè¯tmuxæ˜¾ç¤ºæ‰€æœ‰ä¼šè¯tmux lsæ–°å»ºä¼šè¯å¹¶æŒ‡å®šä¼šè¯åç§°ï¼ˆå»ºè®®åˆ¶å®šä¼šè¯åç§°ï¼Œä»¥ä¾¿äº†è§£è¯¥ä¼šè¯ç”¨é€”ï¼‰tmux new -s &lt;session-name&gt;æ–°å»ºä¼šè¯ï¼ˆä¸æŒ‡å®šä¼šè¯åç§°ï¼‰tmux newæ¥å…¥ä¸Šä¸€ä¸ªä¼šè¯tmux aæ¥å…¥æŒ‡å®šåç§°çš„ä¼šè¯tmux a -t &lt;session-name&gt;æ–­å¼€å½“å‰ä¼šè¯ï¼ˆè¿˜å¯ä»¥ä½¿ç”¨å¿«æ·é”®ï¼šcontrol+bï¼Œå†æŒ‰dï¼‰tmux detachå…³é—­æŒ‡å®šä¼šè¯tmux kill-session -t session-nameå…³é—­é™¤æŒ‡å®šä¼šè¯å¤–çš„æ‰€æœ‰ä¼šè¯tmux kill-session -a -t session-nameåœ¨ä¼šè¯ä¸­åˆ‡æ¢control+bï¼Œå†æŒ‰s æ˜¾ç¤ºä¼šè¯åˆ—è¡¨ï¼Œå†è¿›è¡Œä¼šè¯åˆ‡æ¢é”€æ¯æ‰€æœ‰ä¼šè¯å¹¶åœæ­¢tmuxtmux kill-serverGå¤åˆ¶ç²˜è´´Ctrl+b   [          //è¿›å…¥å¤åˆ¶æ¨¡å¼ç©ºæ ¼+æ–¹å‘é”®      //é€‰æ‹©å›è½¦                  //  ç¡®è®¤Ctrl+b  [           //ç²˜è´´â€‹```### éœ€è¦æ³¨æ„çš„å‡ ç‚¹â€‹```1ï¼‰è¿›å…¥tmuxé¢æ¿åï¼Œä¸€å®šè¦å…ˆæŒ‰ctrl+bï¼Œç„¶åæ¾å¼€ï¼Œå†æŒ‰å…¶ä»–çš„ç»„åˆé”®æ‰ç”Ÿæ•ˆã€‚2ï¼‰å¸¸ç”¨åˆ°çš„å‡ ä¸ªç»„åˆé”®ï¼šctrl+b ?            æ˜¾ç¤ºå¿«æ·é”®å¸®åŠ©ctrl+b ç©ºæ ¼é”®       é‡‡ç”¨ä¸‹ä¸€ä¸ªå†…ç½®å¸ƒå±€ï¼Œè¿™ä¸ªå¾ˆæœ‰æ„æ€ï¼Œåœ¨å¤šå±æ—¶ï¼Œç”¨è¿™ä¸ªå°±ä¼šå°†å¤šæœ‰å±å¹•ç«–ç€å±•ç¤ºctrl+b !            æŠŠå½“å‰çª—å£å˜ä¸ºæ–°çª—å£ctrl+b  &quot;           æ¨¡å‘åˆ†éš”çª—å£ctrl+b %            çºµå‘åˆ†éš”çª—å£ctrl+b q            æ˜¾ç¤ºåˆ†éš”çª—å£çš„ç¼–å·ctrl+b o            è·³åˆ°ä¸‹ä¸€ä¸ªåˆ†éš”çª—å£ã€‚å¤šå±ä¹‹é—´çš„åˆ‡æ¢ctrl+b ä¸Šä¸‹é”®      ä¸Šä¸€ä¸ªåŠä¸‹ä¸€ä¸ªåˆ†éš”çª—å£ctrl+b C-æ–¹å‘é”®    è°ƒæ•´åˆ†éš”çª—å£å¤§å°ctrl+b &amp;           ç¡®è®¤åé€€å‡ºå½“å‰tmuxctrl+b [           å¤åˆ¶æ¨¡å¼ï¼Œå³å°†å½“å‰å±å¹•ç§»åˆ°ä¸Šä¸€ä¸ªçš„ä½ç½®ä¸Šï¼Œå…¶ä»–æ‰€æœ‰çª—å£éƒ½å‘å‰ç§»åŠ¨ä¸€ä¸ªã€‚ctrl+b c           åˆ›å»ºæ–°çª—å£ctrl+b n           é€‰æ‹©ä¸‹ä¸€ä¸ªçª—å£ctrl+b l           æœ€åä½¿ç”¨çš„çª—å£ctrl+b p           é€‰æ‹©å‰ä¸€ä¸ªçª—å£ctrl+b w           ä»¥èœå•æ–¹å¼æ˜¾ç¤ºåŠé€‰æ‹©çª—å£ctrl+b s           ä»¥èœå•æ–¹å¼æ˜¾ç¤ºå’Œé€‰æ‹©ä¼šè¯ã€‚è¿™ä¸ªå¸¸ç”¨åˆ°ï¼Œå¯ä»¥é€‰æ‹©è¿›å…¥å“ªä¸ªtmuxctrl+b t           æ˜¾ç¤ºæ—¶é’Ÿã€‚ç„¶åæŒ‰enteré”®åå°±ä¼šæ¢å¤åˆ°shellç»ˆç«¯çŠ¶æ€ctrl+b d           è„±ç¦»å½“å‰ä¼šè¯ï¼›è¿™æ ·å¯ä»¥æš‚æ—¶è¿”å›Shellç•Œé¢ï¼Œè¾“å…¥tmux attachèƒ½å¤Ÿé‡æ–°è¿›å…¥ä¹‹å‰çš„ä¼šè¯â€‹```### tmuxçš„å¸¸è§„è¿ç»´å‘½ä»¤â€‹```1ï¼‰å®‰è£…å‘½ä»¤ï¼šã€€[root@Centos6 ~]# yum -y install tmuxã€€ã€€2ï¼‰é»˜è®¤åˆ›å»ºä¸€ä¸ªä¼šè¯ï¼Œä»¥æ•°å­—å‘½åã€‚ï¼ˆä¸æ¨èï¼‰[root@Centos6 ~]# tmuxã€€ã€€3ï¼‰æ–°å»ºä¼šè¯ï¼Œæ¯”å¦‚æ–°åˆ›å»ºä¸€ä¸ªä¼šè¯ä»¥&quot;ccc&quot;å‘½å[root@Centos6 ~]# tmux new -s cccåŠ ä¸Šå‚æ•°-dï¼Œè¡¨ç¤ºåœ¨åå°æ–°å»ºä¼šè¯root@bobo:~# tmux new -s shibo -droot@bobo:~# tmux lsshibo: 1 windows (created Tue Oct  2 19:22:32 2018) [135x35]4ï¼‰æŸ¥çœ‹åˆ›å»ºå¾—æ‰€æœ‰ä¼šè¯[root@Centos6 ~]# tmux ls0: 1 windows (created Wed Aug 30 17:58:20 2017) [112x22](attached)    #è¿™é‡Œçš„attachedè¡¨ç¤ºè¯¥ä¼šè¯æ˜¯å½“å‰ä¼šè¯aaa: 2 windows (created Wed Aug 30 16:54:33 2017) [112x22]ccc: 1 windows (created Wed Aug 30 17:01:05 2017) [112x22]5ï¼‰ç™»å½•ä¸€ä¸ªå·²çŸ¥ä¼šè¯ã€‚å³ä»ç»ˆç«¯ç¯å¢ƒè¿›å…¥ä¼šè¯ã€‚ç¬¬ä¸€ä¸ªå‚æ•°aä¹Ÿå¯ä»¥å†™æˆattachã€‚åé¢çš„aaaæ˜¯ä¼šè¯åç§°ã€‚[root@Centos6 ~]# tmux a -t aaa ã€€ã€€6ï¼‰é€€å‡ºä¼šè¯ä¸æ˜¯å…³é—­ï¼šç™»åˆ°æŸä¸€ä¸ªä¼šè¯åï¼Œä¾æ¬¡æŒ‰é”®ctrl-b + dï¼Œè¿™æ ·å°±ä¼šé€€åŒ–è¯¥ä¼šè¯ï¼Œä½†ä¸ä¼šå…³é—­ä¼šè¯ã€‚å¦‚æœç›´æ¥ctrl + dï¼Œå°±ä¼šåœ¨é€€å‡ºä¼šè¯çš„é€šè¯ä¹Ÿå…³é—­äº†è¯¥ä¼šè¯ï¼7ï¼‰å…³é—­ä¼šè¯ï¼ˆé”€æ¯ä¼šè¯ï¼‰[root@Centos6 ~]# tmux lsaaa: 2 windows (created Wed Aug 30 16:54:33 2017) [112x22]bbb: 1 windows (created Wed Aug 30 19:02:09 2017) [112x22][root@Centos6 ~]# tmux kill-session -t bbb[root@Centos6 ~]# tmux lsaaa: 2 windows (created Wed Aug 30 16:54:33 2017) [112x22]8ï¼‰é‡å‘½åä¼šè¯[root@Centos6 ~]# tmux ls  wangshibo: 1 windows (created Sun Sep 30 10:17:00 2018) [136x29] (attached)[root@Centos6 ~]# tmux rename -t wangshibo kevin[root@Centos6 ~]# tmux lskevin: 1 windows (created Sun Sep 30 10:17:00 2018) [136x29] (attached)â€‹```---title: tmux-åˆæ¢date: 2018-12-07 13:59:25tags:  - tmux  - éªšæ“ä½œ---### Linuxç»ˆç«¯å¤ç”¨ç¥å™¨-tmuxåˆæ¢â€‹```Tmuxæ˜¯ä¸€ä¸ªä¼˜ç§€çš„ç»ˆç«¯å¤ç”¨è½¯ä»¶ï¼Œç±»ä¼¼GNU Screenï¼Œä½†æ¥è‡ªäºOpenBSDï¼Œé‡‡ç”¨BSDæˆæƒã€‚ä½¿ç”¨å®ƒæœ€ç›´è§‚çš„å¥½å¤„å°±æ˜¯ï¼Œé€šè¿‡ä¸€ä¸ªç»ˆç«¯ç™»å½•è¿œç¨‹ä¸»æœºå¹¶è¿è¡Œtmuxåï¼Œåœ¨å…¶ä¸­å¯ä»¥å¼€å¯å¤šä¸ªæ§åˆ¶å°è€Œæ— éœ€å†â€œæµªè´¹â€å¤šä½™çš„ç»ˆç«¯æ¥è¿æ¥è¿™å°è¿œç¨‹ä¸»æœºã€‚æ˜¯BSDå®ç°çš„Screenæ›¿ä»£å“ï¼Œç›¸å¯¹äºScreenï¼Œå®ƒæ›´åŠ å…ˆè¿›ï¼šæ”¯æŒå±å¹•åˆ‡åˆ†ï¼Œè€Œä¸”å…·å¤‡ä¸°å¯Œçš„å‘½ä»¤è¡Œå‚æ•°ï¼Œä½¿å…¶å¯ä»¥çµæ´»ã€åŠ¨æ€çš„è¿›è¡Œå„ç§å¸ƒå±€å’Œæ“ä½œã€‚â€‹```åºŸè¯ä¸å¤šè¯´æ¥ä¸ªæ•ˆæœå›¾![tmux](https://i.loli.net/2018/12/14/5c139f4ab6ad2.jpg)### Tmuxçš„ä½¿ç”¨åœºæ™¯â€‹```1ï¼‰å¯ä»¥æŸä¸ªç¨‹åºåœ¨æ‰§è¡Œæ—¶ä¸€ç›´æ˜¯è¾“å‡ºçŠ¶æ€ï¼Œéœ€è¦ç»“åˆnohupã€&amp;æ¥æ”¾åœ¨åå°æ‰§è¡Œï¼Œå¹¶ä¸”ctrl+cç»“æŸã€‚è¿™æ—¶å¯ä»¥æ‰“å¼€ä¸€ä¸ªTmuxçª—å£ï¼Œåœ¨è¯¥çª—å£é‡Œæ‰§è¡Œè¿™ä¸ªç¨‹åºï¼Œç”¨æ¥ä¿è¯è¯¥ç¨‹åºä¸€ç›´åœ¨æ‰§è¡Œä¸­ï¼Œåªè¦Tmuxè¿™ä¸ªçª—å£ä¸å…³é—­2ï¼‰å…¬å¸éœ€è¦å¤‡ä»½æ•°æ®åº“æ—¶ï¼Œæ•°æ®é‡å·¨å¤§ï¼Œå¤‡ä»½ä¸¤ä¸‰å¤©å¼„ä¸å®Œï¼Œè¿™æ—¶ä¸å°å¿ƒå…³é—­äº†ç»ˆç«¯çª—å£æˆ–è¯¯æ“ä½œå°±å‰åŠŸå°½å¼ƒäº†ï¼Œä½¿ç”¨Tmuxä¼šè¯è¿è¡Œå‘½ä»¤æˆ–ä»»åŠ¡ï¼Œå°±ä¸ç”¨æ‹…å¿ƒè¿™äº›é—®é¢˜ã€‚3ï¼‰ä¸‹ç­åï¼Œä½ éœ€è¦æ–­å¼€sshæˆ–å…³é—­ç”µè„‘ï¼Œå°†è¿è¡Œçš„å‘½ä»¤æˆ–ä»»åŠ¡æ”¾ç½®åå°è¿è¡Œã€‚4ï¼‰å…³é—­ç»ˆç«¯,å†æ¬¡æ‰“å¼€æ—¶åŸç»ˆç«¯é‡Œé¢çš„ä»»åŠ¡è¿›ç¨‹ä¾ç„¶ä¸ä¼šä¸­æ–­â€‹```&lt;!--more--&gt;### TmuxåŠŸèƒ½ï¼šâ€‹```-  æä¾›äº†å¼ºåŠ²çš„ã€æ˜“äºä½¿ç”¨çš„å‘½ä»¤è¡Œç•Œé¢ã€‚-  å¯æ¨ªå‘å’Œçºµå‘åˆ†å‰²çª—å£ã€‚-  çª—æ ¼å¯ä»¥è‡ªç”±ç§»åŠ¨å’Œè°ƒæ•´å¤§å°ï¼Œæˆ–ç›´æ¥åˆ©ç”¨å››ä¸ªé¢„è®¾å¸ƒå±€ä¹‹ä¸€ã€‚-  æ”¯æŒ UTF-8 ç¼–ç åŠ 256 è‰²ç»ˆç«¯ã€‚-  å¯åœ¨å¤šä¸ªç¼“å†²åŒºè¿›è¡Œå¤åˆ¶å’Œç²˜è´´ã€‚-  å¯é€šè¿‡äº¤äº’å¼èœå•æ¥é€‰æ‹©çª—å£ã€ä¼šè¯åŠå®¢æˆ·ç«¯ã€‚-  æ”¯æŒè·¨çª—å£æœç´¢ã€‚-  æ”¯æŒè‡ªåŠ¨åŠæ‰‹åŠ¨é”å®šçª—å£ã€‚â€‹```### Tmuxå®‰è£…â€‹```yum -y install tmuxâ€‹```### Tmuxä¸ªæ€§åŒ–é…ç½®â€‹```æ­¤ç±»é…ç½®å¯ä»¥åœ¨å‘½ä»¤è¡Œæ¨¡å¼ä¸­è¾“å…¥show-options -gæŸ¥è¯¢tmuxåŠ ä¸Šä¸‹åˆ—å‚æ•°,å®ç°ä¸ªæ€§åŒ–è®¾ç½®set-option -g base-index 1                        # çª—å£çš„åˆå§‹åºå·ï¼›é»˜è®¤ä¸º0ï¼Œè¿™é‡Œè®¾ç½®ä¸º1set-option -g display-time 5000                   # æç¤ºä¿¡æ¯çš„æŒç»­æ—¶é—´ï¼›è®¾ç½®è¶³å¤Ÿçš„æ—¶é—´ä»¥é¿å…çœ‹ä¸æ¸…æç¤ºï¼Œå•ä½ä¸ºæ¯«ç§’set-option -g repeat-time 1000                    # æ§åˆ¶å°æ¿€æ´»åçš„æŒç»­æ—¶é—´ï¼›è®¾ç½®åˆé€‚çš„æ—¶é—´ä»¥é¿å…æ¯æ¬¡æ“ä½œéƒ½è¦å…ˆæ¿€æ´»æ§åˆ¶å°ï¼Œå•ä½ä¸ºæ¯«ç§’set-option -g status-keys vi                      # æ“ä½œçŠ¶æ€æ æ—¶çš„é»˜è®¤é”®ç›˜å¸ƒå±€ï¼›å¯ä»¥è®¾ç½®ä¸ºviæˆ–emacsset-option -g status-utf8 on                      # å¼€å¯çŠ¶æ€æ çš„UTF-8æ”¯æŒ---set-option -g status-bg blueset-option -g status-fg &#39;#bbbbbb&#39;set-option -g status-left-fg greenset-option -g status-left-bg blueset-option -g status-right-fg greenset-option -g status-right-bg blueset-option -g status-left-length 10               # çŠ¶æ€æ å·¦æ–¹çš„å†…å®¹é•¿åº¦ï¼›set-option -g status-right-length 15              # çŠ¶æ€æ å³æ–¹çš„å†…å®¹é•¿åº¦ï¼›å»ºè®®æŠŠæ›´å¤šçš„ç©ºé—´ç•™ç»™çŠ¶æ€æ å·¦æ–¹ï¼ˆç”¨äºåˆ—å‡ºå½“å‰çª—å£ï¼‰set-option -g status-left &#39;[#(whoami)]&#39;           # çŠ¶æ€æ å·¦æ–¹çš„å†…å®¹set-option -g status-right &#39;[#(date +&quot; %m-%d %H:%M &quot;)]&#39;     # çŠ¶æ€æ å³æ–¹çš„å†…å®¹ï¼›è¿™é‡Œçš„è®¾ç½®å°†å¾—åˆ°ç±»ä¼¼23:59çš„æ˜¾ç¤ºset-option -g status-justify &quot;centre&quot;             # çª—å£åˆ—è¡¨å±…ä¸­æ˜¾ç¤ºset-option -g default-terminal &quot;screen-256color&quot;  # æ”¯æŒ256è‰²æ˜¾ç¤ºåˆ†å‰²çª—å£è¾¹ç•Œçš„é¢œè‰²set-option -g pane-active-border-fg &#39;#55ff55&#39;set-option -g pane-border-fg &#39;#555555&#39;---æ­¤ç±»è®¾ç½®å¯ä»¥åœ¨å‘½ä»¤è¡Œæ¨¡å¼ä¸­è¾“å…¥show-window-options -gæŸ¥è¯¢set-window-option -g mode-keys vi    # å¤åˆ¶æ¨¡å¼ä¸­çš„é»˜è®¤é”®ç›˜å¸ƒå±€ï¼›å¯ä»¥è®¾ç½®ä¸ºviæˆ–emacsset-window-option -g utf8 on         # å¼€å¯çª—å£çš„UTF-8æ”¯æŒset-window-option -g mode-mouse on   # çª—å£åˆ‡æ¢åè®©äººå¯ä»¥ç”¨é¼ æ ‡ä¸Šä¸‹æ»‘åŠ¨æ˜¾ç¤ºå†å²è¾“å‡º---çª—å£åˆ‡åˆ†å¿«æ·é”®(æ²¡è®¾ç½®æˆåŠŸ)bind \ split-window -h                      # ä½¿ç”¨ \ å°†çª—å£ç«–åˆ‡bind - split-window -v                      # ä½¿ç”¨ - å°†çª—å£æ¨ªåˆ‡bind K confirm-before -p &quot;kill-window #W? (y/n)&quot; kill-window    # ä½¿ç”¨å¤§å†™ K æ¥å…³é—­çª—å£bind &#39;&quot;&#39; choose-window                      # åŒå¼•å·é€‰æ‹©çª—å£---Paneä¹‹é—´åˆ‡æ¢çš„å¿«æ·é”®bind h select-pane -L                       # å®šä½åˆ°å·¦è¾¹çª—å£çš„å¿«æ·é”®bind j select-pane -D                       # å®šä½åˆ°ä¸Šè¾¹çª—å£çš„å¿«æ·é”®bind k select-pane -U                       # å®šä½åˆ°ä¸‹æ–¹çª—å£çš„å¿«æ·é”®bind l select-pane -R                       # å®šä½åˆ°å³è¾¹çª—å£çš„å¿«æ·é”®---è®¾ç½®windowå±æ€§setw -g window-status-current-bg redsetw -g window-status-current-fg whitesetw -g window-status-current-attr brightsetw -g window-status-attr brightset-option -g window-status-format &#39;#I #W&#39;set-option -g window-status-current-format &#39; #I #W &#39;setw -g window-status-current-bg bluesetw -g window-status-current-fg greenä¸ä½¿ç”¨prefixé”®ï¼Œä½¿ç”¨Ctrlå’Œå·¦å³æ–¹å‘é”®æ–¹ä¾¿åˆ‡æ¢çª—å£bind-key -n &quot;C-Left&quot; select-window -t :-bind-key -n &quot;C-Right&quot; select-window -t :+â€‹```### tmux session ä½¿ç”¨ä»‹ç»â€‹```è¿è¡Œtmuxå¹¶å¼€å¯ä¸€ä¸ªæ–°çš„ä¼šè¯tmuxæ˜¾ç¤ºæ‰€æœ‰ä¼šè¯tmux lsæ–°å»ºä¼šè¯å¹¶æŒ‡å®šä¼šè¯åç§°ï¼ˆå»ºè®®åˆ¶å®šä¼šè¯åç§°ï¼Œä»¥ä¾¿äº†è§£è¯¥ä¼šè¯ç”¨é€”ï¼‰tmux new -s &lt;session-name&gt;æ–°å»ºä¼šè¯ï¼ˆä¸æŒ‡å®šä¼šè¯åç§°ï¼‰tmux newæ¥å…¥ä¸Šä¸€ä¸ªä¼šè¯tmux aæ¥å…¥æŒ‡å®šåç§°çš„ä¼šè¯tmux a -t &lt;session-name&gt;æ–­å¼€å½“å‰ä¼šè¯ï¼ˆè¿˜å¯ä»¥ä½¿ç”¨å¿«æ·é”®ï¼šcontrol+bï¼Œå†æŒ‰dï¼‰tmux detachå…³é—­æŒ‡å®šä¼šè¯tmux kill-session -t session-nameå…³é—­é™¤æŒ‡å®šä¼šè¯å¤–çš„æ‰€æœ‰ä¼šè¯tmux kill-session -a -t session-nameåœ¨ä¼šè¯ä¸­åˆ‡æ¢control+bï¼Œå†æŒ‰s æ˜¾ç¤ºä¼šè¯åˆ—è¡¨ï¼Œå†è¿›è¡Œä¼šè¯åˆ‡æ¢é”€æ¯æ‰€æœ‰ä¼šè¯å¹¶åœæ­¢tmuxtmux kill-serverGå¤åˆ¶ç²˜è´´Ctrl+b   [          //è¿›å…¥å¤åˆ¶æ¨¡å¼ç©ºæ ¼+æ–¹å‘é”®      //é€‰æ‹©å›è½¦                  //  ç¡®è®¤Ctrl+b  [           //ç²˜è´´â€‹```### éœ€è¦æ³¨æ„çš„å‡ ç‚¹â€‹```1ï¼‰è¿›å…¥tmuxé¢æ¿åï¼Œä¸€å®šè¦å…ˆæŒ‰ctrl+bï¼Œç„¶åæ¾å¼€ï¼Œå†æŒ‰å…¶ä»–çš„ç»„åˆé”®æ‰ç”Ÿæ•ˆã€‚2ï¼‰å¸¸ç”¨åˆ°çš„å‡ ä¸ªç»„åˆé”®ï¼šctrl+b ?            æ˜¾ç¤ºå¿«æ·é”®å¸®åŠ©ctrl+b ç©ºæ ¼é”®       é‡‡ç”¨ä¸‹ä¸€ä¸ªå†…ç½®å¸ƒå±€ï¼Œè¿™ä¸ªå¾ˆæœ‰æ„æ€ï¼Œåœ¨å¤šå±æ—¶ï¼Œç”¨è¿™ä¸ªå°±ä¼šå°†å¤šæœ‰å±å¹•ç«–ç€å±•ç¤ºctrl+b !            æŠŠå½“å‰çª—å£å˜ä¸ºæ–°çª—å£ctrl+b  &quot;           æ¨¡å‘åˆ†éš”çª—å£ctrl+b %            çºµå‘åˆ†éš”çª—å£ctrl+b q            æ˜¾ç¤ºåˆ†éš”çª—å£çš„ç¼–å·ctrl+b o            è·³åˆ°ä¸‹ä¸€ä¸ªåˆ†éš”çª—å£ã€‚å¤šå±ä¹‹é—´çš„åˆ‡æ¢ctrl+b ä¸Šä¸‹é”®      ä¸Šä¸€ä¸ªåŠä¸‹ä¸€ä¸ªåˆ†éš”çª—å£ctrl+b C-æ–¹å‘é”®    è°ƒæ•´åˆ†éš”çª—å£å¤§å°ctrl+b &amp;           ç¡®è®¤åé€€å‡ºå½“å‰tmuxctrl+b [           å¤åˆ¶æ¨¡å¼ï¼Œå³å°†å½“å‰å±å¹•ç§»åˆ°ä¸Šä¸€ä¸ªçš„ä½ç½®ä¸Šï¼Œå…¶ä»–æ‰€æœ‰çª—å£éƒ½å‘å‰ç§»åŠ¨ä¸€ä¸ªã€‚ctrl+b c           åˆ›å»ºæ–°çª—å£ctrl+b n           é€‰æ‹©ä¸‹ä¸€ä¸ªçª—å£ctrl+b l           æœ€åä½¿ç”¨çš„çª—å£ctrl+b p           é€‰æ‹©å‰ä¸€ä¸ªçª—å£ctrl+b w           ä»¥èœå•æ–¹å¼æ˜¾ç¤ºåŠé€‰æ‹©çª—å£ctrl+b s           ä»¥èœå•æ–¹å¼æ˜¾ç¤ºå’Œé€‰æ‹©ä¼šè¯ã€‚è¿™ä¸ªå¸¸ç”¨åˆ°ï¼Œå¯ä»¥é€‰æ‹©è¿›å…¥å“ªä¸ªtmuxctrl+b t           æ˜¾ç¤ºæ—¶é’Ÿã€‚ç„¶åæŒ‰enteré”®åå°±ä¼šæ¢å¤åˆ°shellç»ˆç«¯çŠ¶æ€ctrl+b d           è„±ç¦»å½“å‰ä¼šè¯ï¼›è¿™æ ·å¯ä»¥æš‚æ—¶è¿”å›Shellç•Œé¢ï¼Œè¾“å…¥tmux attachèƒ½å¤Ÿé‡æ–°è¿›å…¥ä¹‹å‰çš„ä¼šè¯â€‹```### tmuxçš„å¸¸è§„è¿ç»´å‘½ä»¤â€‹```1ï¼‰å®‰è£…å‘½ä»¤ï¼šã€€[root@---title: tmux-åˆæ¢date: 2018-12-07 13:59:25tags:  - tmux  - éªšæ“ä½œ---### Linuxç»ˆç«¯å¤ç”¨ç¥å™¨-tmuxåˆæ¢â€‹```Tmuxæ˜¯ä¸€ä¸ªä¼˜ç§€çš„ç»ˆç«¯å¤ç”¨è½¯ä»¶ï¼Œç±»ä¼¼GNU Screenï¼Œä½†æ¥è‡ªäºOpenBSDï¼Œé‡‡ç”¨BSDæˆæƒã€‚ä½¿ç”¨å®ƒæœ€ç›´è§‚çš„å¥½å¤„å°±æ˜¯ï¼Œé€šè¿‡ä¸€ä¸ªç»ˆç«¯ç™»å½•è¿œç¨‹ä¸»æœºå¹¶è¿è¡Œtmuxåï¼Œåœ¨å…¶ä¸­å¯ä»¥å¼€å¯å¤šä¸ªæ§åˆ¶å°è€Œæ— éœ€å†â€œæµªè´¹â€å¤šä½™çš„ç»ˆç«¯æ¥è¿æ¥è¿™å°è¿œç¨‹ä¸»æœºã€‚æ˜¯BSDå®ç°çš„Screenæ›¿ä»£å“ï¼Œç›¸å¯¹äºScreenï¼Œå®ƒæ›´åŠ å…ˆè¿›ï¼šæ”¯æŒå±å¹•åˆ‡åˆ†ï¼Œè€Œä¸”å…·å¤‡ä¸°å¯Œçš„å‘½ä»¤è¡Œå‚æ•°ï¼Œä½¿å…¶å¯ä»¥çµæ´»ã€åŠ¨æ€çš„è¿›è¡Œå„ç§å¸ƒå±€å’Œæ“ä½œã€‚â€‹```åºŸè¯ä¸å¤šè¯´æ¥ä¸ªæ•ˆæœå›¾![tmux](https://i.loli.net/2018/12/14/5c139f4ab6ad2.jpg)### Tmuxçš„ä½¿ç”¨åœºæ™¯â€‹```1ï¼‰å¯ä»¥æŸä¸ªç¨‹åºåœ¨æ‰§è¡Œæ—¶ä¸€ç›´æ˜¯è¾“å‡ºçŠ¶æ€ï¼Œéœ€è¦ç»“åˆnohupã€&amp;æ¥æ”¾åœ¨åå°æ‰§è¡Œï¼Œå¹¶ä¸”ctrl+cç»“æŸã€‚è¿™æ—¶å¯ä»¥æ‰“å¼€ä¸€ä¸ªTmuxçª—å£ï¼Œåœ¨è¯¥çª—å£é‡Œæ‰§è¡Œè¿™ä¸ªç¨‹åºï¼Œç”¨æ¥ä¿è¯è¯¥ç¨‹åºä¸€ç›´åœ¨æ‰§è¡Œä¸­ï¼Œåªè¦Tmuxè¿™ä¸ªçª—å£ä¸å…³é—­2ï¼‰å…¬å¸éœ€è¦å¤‡ä»½æ•°æ®åº“æ—¶ï¼Œæ•°æ®é‡å·¨å¤§ï¼Œå¤‡ä»½ä¸¤ä¸‰å¤©å¼„ä¸å®Œï¼Œè¿™æ—¶ä¸å°å¿ƒå…³é—­äº†ç»ˆç«¯çª—å£æˆ–è¯¯æ“ä½œå°±å‰åŠŸå°½å¼ƒäº†ï¼Œä½¿ç”¨Tmuxä¼šè¯è¿è¡Œå‘½ä»¤æˆ–ä»»åŠ¡ï¼Œå°±ä¸ç”¨æ‹…å¿ƒè¿™äº›é—®é¢˜ã€‚3ï¼‰ä¸‹ç­åï¼Œä½ éœ€è¦æ–­å¼€sshæˆ–å…³é—­ç”µè„‘ï¼Œå°†è¿è¡Œçš„å‘½ä»¤æˆ–ä»»åŠ¡æ”¾ç½®åå°è¿è¡Œã€‚4ï¼‰å…³é—­ç»ˆç«¯,å†æ¬¡æ‰“å¼€æ—¶åŸç»ˆç«¯é‡Œé¢çš„ä»»åŠ¡è¿›ç¨‹ä¾ç„¶ä¸ä¼šä¸­æ–­â€‹```&lt;!--more--&gt;### TmuxåŠŸèƒ½ï¼šâ€‹```-  æä¾›äº†å¼ºåŠ²çš„ã€æ˜“äºä½¿ç”¨çš„å‘½ä»¤è¡Œç•Œé¢ã€‚-  å¯æ¨ªå‘å’Œçºµå‘åˆ†å‰²çª—å£ã€‚-  çª—æ ¼å¯ä»¥è‡ªç”±ç§»åŠ¨å’Œè°ƒæ•´å¤§å°ï¼Œæˆ–ç›´æ¥åˆ©ç”¨å››ä¸ªé¢„è®¾å¸ƒå±€ä¹‹ä¸€ã€‚-  æ”¯æŒ UTF-8 ç¼–ç åŠ 256 è‰²ç»ˆç«¯ã€‚-  å¯åœ¨å¤šä¸ªç¼“å†²åŒºè¿›è¡Œå¤åˆ¶å’Œç²˜è´´ã€‚-  å¯é€šè¿‡äº¤äº’å¼èœå•æ¥é€‰æ‹©çª—å£ã€ä¼šè¯åŠå®¢æˆ·ç«¯ã€‚-  æ”¯æŒè·¨çª—å£æœç´¢ã€‚-  æ”¯æŒè‡ªåŠ¨åŠæ‰‹åŠ¨é”å®šçª—å£ã€‚â€‹```### Tmuxå®‰è£…â€‹```yum -y install tmuxâ€‹```### Tmuxä¸ªæ€§åŒ–é…ç½®â€‹```æ­¤ç±»é…ç½®å¯ä»¥åœ¨å‘½ä»¤è¡Œæ¨¡å¼ä¸­è¾“å…¥show-options -gæŸ¥è¯¢tmuxåŠ ä¸Šä¸‹åˆ—å‚æ•°,å®ç°ä¸ªæ€§åŒ–è®¾ç½®set-option -g base-index 1                        # çª—å£çš„åˆå§‹åºå·ï¼›é»˜è®¤ä¸º0ï¼Œè¿™é‡Œè®¾ç½®ä¸º1set-option -g display-time 5000                   # æç¤ºä¿¡æ¯çš„æŒç»­æ—¶é—´ï¼›è®¾ç½®è¶³å¤Ÿçš„æ—¶é—´ä»¥é¿å…çœ‹ä¸æ¸…æç¤ºï¼Œå•ä½ä¸ºæ¯«ç§’set-option -g repeat-time 1000                    # æ§åˆ¶å°æ¿€æ´»åçš„æŒç»­æ—¶é—´ï¼›è®¾ç½®åˆé€‚çš„æ—¶é—´ä»¥é¿å…æ¯æ¬¡æ“ä½œéƒ½è¦å…ˆæ¿€æ´»æ§åˆ¶å°ï¼Œå•ä½ä¸ºæ¯«ç§’set-option -g status-keys vi                      # æ“ä½œçŠ¶æ€æ æ—¶çš„é»˜è®¤é”®ç›˜å¸ƒå±€ï¼›å¯ä»¥è®¾ç½®ä¸ºviæˆ–emacsset-option -g status-utf8 on                      # å¼€å¯çŠ¶æ€æ çš„UTF-8æ”¯æŒ---set-option -g status-bg blueset-option -g status-fg &#39;#bbbbbb&#39;set-option -g status-left-fg greenset-option -g status-left-bg blueset-option -g status-right-fg greenset-option -g status-right-bg blueset-option -g status-left-length 10               # çŠ¶æ€æ å·¦æ–¹çš„å†…å®¹é•¿åº¦ï¼›set-option -g status-right-length 15              # çŠ¶æ€æ å³æ–¹çš„å†…å®¹é•¿åº¦ï¼›å»ºè®®æŠŠæ›´å¤šçš„ç©ºé—´ç•™ç»™çŠ¶æ€æ å·¦æ–¹ï¼ˆç”¨äºåˆ—å‡ºå½“å‰çª—å£ï¼‰set-option -g status-left &#39;[#(whoami)]&#39;           # çŠ¶æ€æ å·¦æ–¹çš„å†…å®¹set-option -g status-right &#39;[#(date +&quot; %m-%d %H:%M &quot;)]&#39;     # çŠ¶æ€æ å³æ–¹çš„å†…å®¹ï¼›è¿™é‡Œçš„è®¾ç½®å°†å¾—åˆ°ç±»ä¼¼23:59çš„æ˜¾ç¤ºset-option -g status-justify &quot;centre&quot;             # çª—å£åˆ—è¡¨å±…ä¸­æ˜¾ç¤ºset-option -g default-terminal &quot;screen-256color&quot;  # æ”¯æŒ256è‰²æ˜¾ç¤ºåˆ†å‰²çª—å£è¾¹ç•Œçš„é¢œè‰²set-option -g pane-active-border-fg &#39;#55ff55&#39;set-option -g pane-border-fg &#39;#555555&#39;---æ­¤ç±»è®¾ç½®å¯ä»¥åœ¨å‘½ä»¤è¡Œæ¨¡å¼ä¸­è¾“å…¥show-window-options -gæŸ¥è¯¢set-window-option -g mode-keys vi    # å¤åˆ¶æ¨¡å¼ä¸­çš„é»˜è®¤é”®ç›˜å¸ƒå±€ï¼›å¯ä»¥è®¾ç½®ä¸ºviæˆ–emacsset-window-option -g utf8 on         # å¼€å¯çª—å£çš„UTF-8æ”¯æŒset-window-option -g mode-mouse on   # çª—å£åˆ‡æ¢åè®©äººå¯ä»¥ç”¨é¼ æ ‡ä¸Šä¸‹æ»‘åŠ¨æ˜¾ç¤ºå†å²è¾“å‡º---çª—å£åˆ‡åˆ†å¿«æ·é”®(æ²¡è®¾ç½®æˆåŠŸ)bind \ split-window -h                      # ä½¿ç”¨ \ å°†çª—å£ç«–åˆ‡bind - split-window -v                      # ä½¿ç”¨ - å°†çª—å£æ¨ªåˆ‡bind K confirm-before -p &quot;kill-window #W? (y/n)&quot; kill-window    # ä½¿ç”¨å¤§å†™ K æ¥å…³é—­çª—å£bind &#39;&quot;&#39; choose-window                      # åŒå¼•å·é€‰æ‹©çª—å£---Paneä¹‹é—´åˆ‡æ¢çš„å¿«æ·é”®bind h select-pane -L                       # å®šä½åˆ°å·¦è¾¹çª—å£çš„å¿«æ·é”®bind j select-pane -D                       # å®šä½åˆ°ä¸Šè¾¹çª—å£çš„å¿«æ·é”®bind k select-pane -U                       # å®šä½åˆ°ä¸‹æ–¹çª—å£çš„å¿«æ·é”®bind l select-pane -R                       # å®šä½åˆ°å³è¾¹çª—å£çš„å¿«æ·é”®---è®¾ç½®windowå±æ€§setw -g window-status-current-bg redsetw -g window-status-current-fg whitesetw -g window-status-current-attr brightsetw -g window-status-attr brightset-option -g window-status-format &#39;#I #W&#39;set-option -g window-status-current-format &#39; #I #W &#39;setw -g window-status-current-bg bluesetw -g window-status-current-fg greenä¸ä½¿ç”¨prefixé”®ï¼Œä½¿ç”¨Ctrlå’Œå·¦å³æ–¹å‘é”®æ–¹ä¾¿åˆ‡æ¢çª—å£bind-key -n &quot;C-Left&quot; select-window -t :-bind-key -n &quot;C-Right&quot; select-window -t :+â€‹```### tmux session ä½¿ç”¨ä»‹ç»â€‹```è¿è¡Œtmuxå¹¶å¼€å¯ä¸€ä¸ªæ–°çš„ä¼šè¯tmuxæ˜¾ç¤ºæ‰€æœ‰ä¼šè¯tmux lsæ–°å»ºä¼šè¯å¹¶æŒ‡å®šä¼šè¯åç§°ï¼ˆå»ºè®®åˆ¶å®šä¼šè¯åç§°ï¼Œä»¥ä¾¿äº†è§£è¯¥ä¼šè¯ç”¨é€”ï¼‰tmux new -s &lt;session-name&gt;æ–°å»ºä¼šè¯ï¼ˆä¸æŒ‡å®šä¼šè¯åç§°ï¼‰tmux newæ¥å…¥ä¸Šä¸€ä¸ªä¼šè¯tmux aæ¥å…¥æŒ‡å®šåç§°çš„ä¼šè¯tmux a -t &lt;session-name&gt;æ–­å¼€å½“å‰ä¼šè¯ï¼ˆè¿˜å¯ä»¥ä½¿ç”¨å¿«æ·é”®ï¼šcontrol+bï¼Œå†æŒ‰dï¼‰tmux detachå…³é—­æŒ‡å®šä¼šè¯tmux kill-session -t session-nameå…³é—­é™¤æŒ‡å®šä¼šè¯å¤–çš„æ‰€æœ‰ä¼šè¯tmux kill-session -a -t session-nameåœ¨ä¼šè¯ä¸­åˆ‡æ¢control+bï¼Œå†æŒ‰s æ˜¾ç¤ºä¼šè¯åˆ—è¡¨ï¼Œå†è¿›è¡Œä¼šè¯åˆ‡æ¢é”€æ¯æ‰€æœ‰ä¼šè¯å¹¶åœæ­¢tmuxtmux kill-serverGå¤åˆ¶ç²˜è´´Ctrl+b   [          //è¿›å…¥å¤åˆ¶æ¨¡å¼ç©ºæ ¼+æ–¹å‘é”®      //é€‰æ‹©å›è½¦                  //  ç¡®è®¤Ctrl+b  [           //ç²˜è´´â€‹```### éœ€è¦æ³¨æ„çš„å‡ ç‚¹â€‹```1ï¼‰è¿›å…¥tmuxé¢æ¿åï¼Œä¸€å®šè¦å…ˆæŒ‰ctrl+bï¼Œç„¶åæ¾å¼€ï¼Œå†æŒ‰å…¶ä»–çš„ç»„åˆé”®æ‰ç”Ÿæ•ˆã€‚2ï¼‰å¸¸ç”¨åˆ°çš„å‡ ä¸ªç»„åˆé”®ï¼šctrl+b ?            æ˜¾ç¤ºå¿«æ·é”®å¸®åŠ©ctrl+b ç©ºæ ¼é”®       é‡‡ç”¨ä¸‹ä¸€ä¸ªå†…ç½®å¸ƒå±€ï¼Œè¿™ä¸ªå¾ˆæœ‰æ„æ€ï¼Œåœ¨å¤šå±æ—¶ï¼Œç”¨è¿™ä¸ªå°±ä¼šå°†å¤šæœ‰å±å¹•ç«–ç€å±•ç¤ºctrl+b !            æŠŠå½“å‰çª—å£å˜ä¸ºæ–°çª—å£ctrl+b  &quot;           æ¨¡å‘åˆ†éš”çª—å£ctrl+b %            çºµå‘åˆ†éš”çª—å£ctrl+b q            æ˜¾ç¤ºåˆ†éš”çª—å£çš„ç¼–å·ctrl+b o            è·³åˆ°ä¸‹ä¸€ä¸ªåˆ†éš”çª—å£ã€‚å¤šå±ä¹‹é—´çš„åˆ‡æ¢ctrl+b ä¸Šä¸‹é”®      ä¸Šä¸€ä¸ªåŠä¸‹ä¸€ä¸ªåˆ†éš”çª—å£ctrl+b C-æ–¹å‘é”®    è°ƒæ•´åˆ†éš”çª—å£å¤§å°ctrl+b &amp;           ç¡®è®¤åé€€å‡ºå½“å‰tmuxctrl+b [           å¤åˆ¶æ¨¡å¼ï¼Œå³å°†å½“å‰å±å¹•ç§»åˆ°ä¸Šä¸€ä¸ªçš„ä½ç½®ä¸Šï¼Œå…¶ä»–æ‰€æœ‰çª—å£éƒ½å‘å‰ç§»åŠ¨ä¸€ä¸ªã€‚ctrl+b c           åˆ›å»ºæ–°çª—å£ctrl+b n           é€‰æ‹©ä¸‹ä¸€ä¸ªçª—å£ctrl+b l           æœ€åä½¿ç”¨çš„çª—å£ctrl+b p           é€‰æ‹©å‰ä¸€ä¸ªçª—å£ctrl+b w           ä»¥èœå•æ–¹å¼æ˜¾ç¤ºåŠé€‰æ‹©çª—å£ctrl+b s           ä»¥èœå•æ–¹å¼æ˜¾ç¤ºå’Œé€‰æ‹©ä¼šè¯ã€‚è¿™ä¸ªå¸¸ç”¨åˆ°ï¼Œå¯ä»¥é€‰æ‹©è¿›å…¥å“ªä¸ªtmuxctrl+b t           æ˜¾ç¤ºæ—¶é’Ÿã€‚ç„¶åæŒ‰enteré”®åå°±ä¼šæ¢å¤åˆ°shellç»ˆç«¯çŠ¶æ€ctrl+b d           è„±ç¦»å½“å‰ä¼šè¯ï¼›è¿™æ ·å¯ä»¥æš‚æ—¶è¿”å›Shellç•Œé¢ï¼Œè¾“å…¥tmux attachèƒ½å¤Ÿé‡æ–°è¿›å…¥ä¹‹å‰çš„ä¼šè¯â€‹```### tmuxçš„å¸¸è§„è¿ç»´å‘½ä»¤â€‹```1ï¼‰å®‰è£…å‘½ä»¤ï¼šã€€[root@1000phone ~]# yum -y install tmuxã€€ã€€2ï¼‰é»˜è®¤åˆ›å»ºä¸€ä¸ªä¼šè¯ï¼Œä»¥æ•°å­—å‘½åã€‚ï¼ˆä¸æ¨èï¼‰[root@1000phone ~]# tmuxã€€ã€€3ï¼‰æ–°å»ºä¼šè¯ï¼Œæ¯”å¦‚æ–°åˆ›å»ºä¸€ä¸ªä¼šè¯ä»¥&quot;ccc&quot;å‘½å[root@1000phone ~]# tmux new -s cccåŠ ä¸Šå‚æ•°-dï¼Œè¡¨ç¤ºåœ¨åå°æ–°å»ºä¼šè¯root@1000phone:~# tmux new -s 1000phone -droot@1000phone:~# tmux ls1000phone: 1 windows (created Tue Oct  2 19:22:32 2018) [135x35]4ï¼‰æŸ¥çœ‹åˆ›å»ºå¾—æ‰€æœ‰ä¼šè¯[root@1000phone ~]# tmux ls0: 1 windows (created Wed Aug 30 17:58:20 2017) [112x22](attached)    #è¿™é‡Œçš„attachedè¡¨ç¤ºè¯¥ä¼šè¯æ˜¯å½“å‰ä¼šè¯1000phone: 2 windows (created Wed Aug 30 16:54:33 2017) [112x22]ccc: 1 windows (created Wed Aug 30 17:01:05 2017) [112x22]5ï¼‰ç™»å½•ä¸€ä¸ªå·²çŸ¥ä¼šè¯ã€‚å³ä»ç»ˆç«¯ç¯å¢ƒè¿›å…¥ä¼šè¯ã€‚ç¬¬ä¸€ä¸ªå‚æ•°aä¹Ÿå¯ä»¥å†™æˆattachã€‚åé¢çš„aaaæ˜¯ä¼šè¯åç§°ã€‚[root@1000phone ~]# tmux a -t 1000phone ã€€ã€€6ï¼‰é€€å‡ºä¼šè¯ä¸æ˜¯å…³é—­ï¼šç™»åˆ°æŸä¸€ä¸ªä¼šè¯åï¼Œä¾æ¬¡æŒ‰é”®ctrl-b + dï¼Œè¿™æ ·å°±ä¼šé€€åŒ–è¯¥ä¼šè¯ï¼Œä½†ä¸ä¼šå…³é—­ä¼šè¯ã€‚å¦‚æœç›´æ¥ctrl + dï¼Œå°±ä¼šåœ¨é€€å‡ºä¼šè¯çš„é€šè¯ä¹Ÿå…³é—­äº†è¯¥ä¼šè¯ï¼7ï¼‰å…³é—­ä¼šè¯ï¼ˆé”€æ¯ä¼šè¯ï¼‰[root@1000phone ~]# tmux ls1000phone: 2 windows (created Wed Aug 30 16:54:33 2017) [112x22]bbb: 1 windows (created Wed Aug 30 19:02:09 2017) [112x22][root@1000phone ~]# tmux kill-session -t bbb[root@1000phone ~]# tmux ls1000phone: 2 windows (created Wed Aug 30 16:54:33 2017) [112x22]8ï¼‰é‡å‘½åä¼šè¯[root@1000phone ~]# tmux ls  tigerfive: 1 windows (created Sun Sep 30 10:17:00 2018) [136x29] (attached)[root@1000phone ~]# tmux rename -t tigerfive 1000phone[root@Centos6 ~]# tmux ls1000phone: 1 windows (created Sun Sep 30 10:17:00 2018) [136x29] (attached)â€‹``` ~]# yum -y install tmuxã€€ã€€2ï¼‰é»˜è®¤åˆ›å»ºä¸€ä¸ªä¼šè¯ï¼Œä»¥æ•°å­—å‘½åã€‚ï¼ˆä¸æ¨èï¼‰[root@1000phone ~]# tmuxã€€ã€€3ï¼‰æ–°å»ºä¼šè¯ï¼Œæ¯”å¦‚æ–°åˆ›å»ºä¸€ä¸ªä¼šè¯ä»¥&quot;ccc&quot;å‘½å[root@1000phone ~]# tmux new -s cccåŠ ä¸Šå‚æ•°-dï¼Œè¡¨ç¤ºåœ¨åå°æ–°å»ºä¼šè¯root@1000phone:~# tmux new -s 1000phone -droot@1000phone:~# tmux ls1000phone: 1 windows (created Tue Oct  2 19:22:32 2018) [135x35]4ï¼‰æŸ¥çœ‹åˆ›å»ºå¾—æ‰€æœ‰ä¼šè¯[root@1000phone ~]# tmux ls0: 1 windows (created Wed Aug 30 17:58:20 2017) [112x22](attached)    #è¿™é‡Œçš„attachedè¡¨ç¤ºè¯¥ä¼šè¯æ˜¯å½“å‰ä¼šè¯aaa: 2 windows (created Wed Aug 30 16:54:33 2017) [112x22]ccc: 1 windows (created Wed Aug 30 17:01:05 2017) [112x22]5ï¼‰ç™»å½•ä¸€ä¸ªå·²çŸ¥ä¼šè¯ã€‚å³ä»ç»ˆç«¯ç¯å¢ƒè¿›å…¥ä¼šè¯ã€‚ç¬¬ä¸€ä¸ªå‚æ•°aä¹Ÿå¯ä»¥å†™æˆattachã€‚åé¢çš„aaaæ˜¯ä¼šè¯åç§°ã€‚[root@1000phone ~]# tmux a -t aaa ã€€ã€€6ï¼‰é€€å‡ºä¼šè¯ä¸æ˜¯å…³é—­ï¼šç™»åˆ°æŸä¸€ä¸ªä¼šè¯åï¼Œä¾æ¬¡æŒ‰é”®ctrl-b + dï¼Œè¿™æ ·å°±ä¼šé€€åŒ–è¯¥ä¼šè¯ï¼Œä½†ä¸ä¼šå…³é—­ä¼šè¯ã€‚å¦‚æœç›´æ¥ctrl + dï¼Œå°±ä¼šåœ¨é€€å‡ºä¼šè¯çš„é€šè¯ä¹Ÿå…³é—­äº†è¯¥ä¼šè¯ï¼7ï¼‰å…³é—­ä¼šè¯ï¼ˆé”€æ¯ä¼šè¯ï¼‰[root@1000phone ~]# tmux lsaaa: 2 windows (created Wed Aug 30 16:54:33 2017) [112x22]bbb: 1 windows (created Wed Aug 30 19:02:09 2017) [112x22][root@1000phone ~]# tmux kill-session -t bbb[root@1000phone ~]# tmux lsaaa: 2 windows (created Wed Aug 30 16:54:33 2017) [112x22]8ï¼‰é‡å‘½åä¼šè¯[root@1000phone ~]# tmux ls  wangshibo: 1 windows (created Sun Sep 30 10:17:00 2018) [136x29] (attached)[root@1000phone ~]# tmux rename -t wangshibo kevin[root@1000phone ~]# tmux lskevin: 1 windows (created Sun Sep 30 10:17:00 2018) [136x29] (attached)â€‹```</code></pre>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Tools </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Nginxæ€§èƒ½ä¼˜åŒ–</title>
      <link href="2019/08/05/linux/nginx/nginx-xing-neng-you-hua/"/>
      <url>2019/08/05/linux/nginx/nginx-xing-neng-you-hua/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><p><img src="https://p6-tt.byteimg.com/large/pgc-image/95d788eda3ed45b58b6e982192a7a650" alt="img"></p><p>å½“æˆ‘éœ€è¦è¿›è¡Œæ€§èƒ½ä¼˜åŒ–æ—¶ï¼Œè¯´æ˜æˆ‘ä»¬æœåŠ¡å™¨æ— æ³•æ»¡è¶³æ—¥ç›Šå¢é•¿çš„ä¸šåŠ¡ã€‚æ€§èƒ½ä¼˜åŒ–æ˜¯ä¸€ä¸ªæ¯”è¾ƒå¤§çš„è¯¾é¢˜ï¼Œéœ€è¦ä»ä»¥ä¸‹å‡ ä¸ªæ–¹é¢è¿›è¡Œæ¢è®¨</p><ul><li>å½“å‰ç³»ç»Ÿç»“æ„ç“¶é¢ˆ</li><li>äº†è§£ä¸šåŠ¡æ¨¡å¼</li><li>æ€§èƒ½ä¸å®‰å…¨</li></ul><h4 id="1ã€å½“å‰ç³»ç»Ÿç»“æ„ç“¶é¢ˆ"><a href="#1ã€å½“å‰ç³»ç»Ÿç»“æ„ç“¶é¢ˆ" class="headerlink" title="1ã€å½“å‰ç³»ç»Ÿç»“æ„ç“¶é¢ˆ"></a>1ã€å½“å‰ç³»ç»Ÿç»“æ„ç“¶é¢ˆ</h4><p>é¦–å…ˆéœ€è¦äº†è§£çš„æ˜¯å½“å‰ç³»ç»Ÿç“¶é¢ˆï¼Œç”¨çš„æ˜¯ä»€ä¹ˆï¼Œè·‘çš„æ˜¯ä»€ä¹ˆä¸šåŠ¡ã€‚é‡Œé¢çš„æœåŠ¡æ˜¯ä»€ä¹ˆæ ·å­ï¼Œæ¯ä¸ªæœåŠ¡æœ€å¤§æ”¯æŒå¤šå°‘å¹¶å‘ã€‚æ¯”å¦‚é’ˆå¯¹nginxè€Œè¨€ï¼Œæˆ‘ä»¬å¤„ç†é™æ€èµ„æºæ•ˆç‡æœ€é«˜çš„ç“¶é¢ˆæ˜¯å¤šå¤§ï¼Ÿèƒ½æ”¯æŒå¤šå°‘qpsè®¿é—®è¯·æ±‚ï¼Ÿæ€ä¹ˆå¾—å‡ºç³»ç»Ÿå½“å‰çš„ç»“æ„ç“¶é¢ˆï¼Ÿ</p><p>å¯ä»¥é€šè¿‡æŸ¥çœ‹å½“å‰cpuè´Ÿè·ï¼Œå†…å­˜ä½¿ç”¨ç‡ï¼Œè¿›ç¨‹ä½¿ç”¨ç‡æ¥åšç®€å•åˆ¤æ–­ã€‚è¿˜å¯ä»¥é€šè¿‡æ“ä½œç³»ç»Ÿçš„ä¸€äº›å·¥å…·æ¥åˆ¤æ–­å½“å‰ç³»ç»Ÿæ€§èƒ½ç“¶é¢ˆï¼Œå¦‚åˆ†æå¯¹åº”çš„æ—¥å¿—ï¼ŒæŸ¥çœ‹è¯·æ±‚æ•°é‡ã€‚ä¹Ÿå¯ä»¥é€šè¿‡nginx http_stub_status_moduleæ¨¡å—æ¥æŸ¥çœ‹å¯¹åº”çš„è¿æ¥æ•°ï¼Œæ€»æ¡æ‰‹æ¬¡æ•°ï¼Œæ€»è¯·æ±‚æ•°ã€‚ä¹Ÿå¯ä»¥å¯¹çº¿ä¸Šè¿›è¡Œå‹åŠ›æµ‹è¯•ï¼Œæ¥äº†è§£å½“å‰çš„ç³»ç»Ÿèƒ½æ€§èƒ½ï¼Œå¹¶å‘æ•°ï¼Œåšå¥½æ€§èƒ½è¯„ä¼°ã€‚</p><h4 id="2ã€äº†è§£ä¸šåŠ¡æ¨¡å¼"><a href="#2ã€äº†è§£ä¸šåŠ¡æ¨¡å¼" class="headerlink" title="2ã€äº†è§£ä¸šåŠ¡æ¨¡å¼"></a>2ã€äº†è§£ä¸šåŠ¡æ¨¡å¼</h4><p>è™½ç„¶æˆ‘ä»¬æ˜¯åœ¨åšæ€§èƒ½ä¼˜åŒ–ï¼Œä½†è¿˜æ˜¯è¦ç†Ÿæ‚‰ä¸šåŠ¡ï¼Œæœ€ç»ˆç›®çš„éƒ½æ˜¯ä¸ºä¸šåŠ¡æœåŠ¡çš„ã€‚æˆ‘ä»¬è¦äº†è§£æ¯ä¸€ä¸ªæ¥å£ä¸šåŠ¡ç±»å‹æ˜¯ä»€ä¹ˆæ ·çš„ä¸šåŠ¡ï¼Œæ¯”å¦‚ç”µå­å•†åŠ¡æŠ¢è´­æ¨¡å¼ï¼Œè¿™ç§æƒ…å†µå¹³æ—¶æµé‡ä¼šå¾ˆå°ï¼Œä½†æ˜¯åˆ°äº†æŠ¢è´­æ—¶é—´ï¼Œæµé‡ä¸€ä¸‹å­å°±ä¼šçŒ›æ¶¨ã€‚ä¹Ÿè¦äº†è§£ç³»ç»Ÿå±‚çº§ç»“æ„ï¼Œæ¯ä¸€å±‚åœ¨ä¸­é—´å±‚åšçš„æ˜¯ä»£ç†è¿˜æ˜¯åŠ¨é™åˆ†ç¦»ï¼Œè¿˜æ˜¯åå°è¿›è¡Œç›´æ¥æœåŠ¡ã€‚éœ€è¦æˆ‘ä»¬å¯¹ä¸šåŠ¡æ¥å…¥å±‚å’Œç³»ç»Ÿå±‚æ¬¡è¦æœ‰ä¸€ä¸ªæ¢³ç†</p><h4 id="3ã€æ€§èƒ½ä¸å®‰å…¨"><a href="#3ã€æ€§èƒ½ä¸å®‰å…¨" class="headerlink" title="3ã€æ€§èƒ½ä¸å®‰å…¨"></a>3ã€æ€§èƒ½ä¸å®‰å…¨</h4><p>æ€§èƒ½ä¸å®‰å…¨ä¹Ÿæ˜¯ä¸€ä¸ªéœ€è¦è€ƒè™‘çš„å› ç´ ï¼Œå¾€å¾€å¤§å®¶æ³¨é‡æ€§èƒ½å¿½ç•¥å®‰å…¨æˆ–æ³¨é‡å®‰å…¨åˆå¿½ç•¥æ€§èƒ½ã€‚æ¯”å¦‚è¯´æˆ‘ä»¬åœ¨è®¾è®¡é˜²ç«å¢™æ—¶ï¼Œå¦‚æœè§„åˆ™è¿‡äºå…¨é¢è‚¯å®šä¼šå¯¹æ€§èƒ½æ–¹é¢æœ‰å½±å“ã€‚å¦‚æœå¯¹æ€§èƒ½è¿‡äºæ³¨é‡åœ¨å®‰å…¨æ–¹é¢è‚¯å®šä¼šç•™ä¸‹å¾ˆå¤§éšæ‚£ã€‚æ‰€ä»¥å¤§å®¶è¦è¯„ä¼°å¥½ä¸¤è€…çš„å…³ç³»ï¼ŒæŠŠæ¡å¥½ä¸¤è€…çš„å­°é‡å­°è½»ï¼Œä»¥åŠæ•´ä½“çš„ç›¸å…³æ€§ã€‚æƒè¡¡å¥½å¯¹åº”çš„ç‚¹ã€‚</p><h4 id="4ã€ç³»ç»Ÿä¸nginxæ€§èƒ½ä¼˜åŒ–"><a href="#4ã€ç³»ç»Ÿä¸nginxæ€§èƒ½ä¼˜åŒ–" class="headerlink" title="4ã€ç³»ç»Ÿä¸nginxæ€§èƒ½ä¼˜åŒ–"></a>4ã€ç³»ç»Ÿä¸nginxæ€§èƒ½ä¼˜åŒ–</h4><p>å¤§å®¶å¯¹ç›¸å…³çš„ç³»ç»Ÿç“¶é¢ˆåŠç°çŠ¶æœ‰äº†ä¸€å®šçš„äº†è§£ä¹‹åï¼Œå°±å¯ä»¥æ ¹æ®å½±å“æ€§èƒ½æ–¹é¢åšä¸€ä¸ªå…¨ä½“çš„è¯„ä¼°å’Œä¼˜åŒ–ã€‚</p><ul><li>ç½‘ç»œï¼ˆç½‘ç»œæµé‡ã€æ˜¯å¦æœ‰ä¸¢åŒ…ï¼Œç½‘ç»œçš„ç¨³å®šæ€§éƒ½ä¼šå½±å“ç”¨æˆ·è¯·æ±‚ï¼‰</li><li>ç³»ç»Ÿï¼ˆç³»ç»Ÿè´Ÿè½½ã€é¥±å’Œã€å†…å­˜ä½¿ç”¨ç‡ã€ç³»ç»Ÿçš„ç¨³å®šæ€§ã€ç¡¬ä»¶ç£ç›˜æ˜¯å¦æœ‰æŸåï¼‰</li><li>æœåŠ¡ï¼ˆè¿æ¥ä¼˜åŒ–ã€å†…æ ¸æ€§èƒ½ä¼˜åŒ–ã€httpæœåŠ¡è¯·æ±‚ä¼˜åŒ–éƒ½å¯ä»¥åœ¨nginxä¸­æ ¹æ®ä¸šåŠ¡æ¥è¿›è¡Œè®¾ç½®ï¼‰</li><li>ç¨‹åºï¼ˆæ¥å£æ€§èƒ½ã€å¤„ç†è¯·æ±‚é€Ÿåº¦ã€æ¯ä¸ªç¨‹åºçš„æ‰§è¡Œæ•ˆç‡ï¼‰</li><li>æ•°æ®åº“ã€åº•å±‚æœåŠ¡</li></ul><p>ä¸Šé¢åˆ—ä¸¾å‡ºæ¥æ¯ä¸€çº§éƒ½ä¼šæœ‰å…³è”ï¼Œä¹Ÿä¼šå½±å“æ•´ä½“æ€§èƒ½ï¼Œè¿™é‡Œä¸»è¦å…³æ³¨çš„æ˜¯nginxæœåŠ¡è¿™ä¸€å±‚ã€‚</p><h5 id="1ã€æ–‡ä»¶å¥æŸ„"><a href="#1ã€æ–‡ä»¶å¥æŸ„" class="headerlink" title="1ã€æ–‡ä»¶å¥æŸ„"></a>1ã€æ–‡ä»¶å¥æŸ„</h5><p>åœ¨linux/unixæ“ä½œç³»ç»Ÿä¸­ä¸€åˆ‡çš†æ–‡ä»¶ï¼Œæˆ‘ä»¬çš„è®¾å¤‡æ˜¯æ–‡ä»¶ï¼Œæ–‡ä»¶æ˜¯æ–‡ä»¶ï¼Œæ–‡ä»¶å¤¹ä¹Ÿæ˜¯æ–‡ä»¶ã€‚å½“æˆ‘ä»¬ç”¨æˆ·æ¯å‘èµ·ä¸€æ¬¡è¯·æ±‚ï¼Œå°±ä¼šäº§ç”Ÿä¸€ä¸ªæ–‡ä»¶å¥æŸ„ã€‚æ–‡ä»¶å¥æŸ„å¯ä»¥ç®€å•çš„ç†è§£ä¸ºæ–‡ä»¶å¥æŸ„å°±æ˜¯ä¸€ä¸ªç´¢å¼•ã€‚æ–‡ä»¶å¥æŸ„å°±ä¼šéšç€è¯·æ±‚é‡çš„å¢å¤š,è¿›ç¨‹è°ƒç”¨é¢‘ç¹å¢åŠ ï¼Œé‚£ä¹ˆäº§ç”Ÿçš„æ–‡ä»¶å¥æŸ„ä¹Ÿå°±ä¼šè¶Šå¤šã€‚</p><p>ç³»ç»Ÿé»˜è®¤å¯¹æ–‡ä»¶å¥æŸ„æ˜¯æœ‰é™åˆ¶çš„ï¼Œä¸å¯èƒ½ä¼šè®©ä¸€ä¸ªè¿›ç¨‹æ— é™åˆ¶çš„è°ƒç”¨å¥æŸ„ã€‚å› ä¸ºç³»ç»Ÿèµ„æºæ˜¯æœ‰é™çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦é™åˆ¶æ¯ä¸€ä¸ªæœåŠ¡èƒ½å¤Ÿä½¿ç”¨å¤šå¤§çš„æ–‡ä»¶å¥æŸ„ã€‚æ“ä½œç³»ç»Ÿé»˜è®¤ä½¿ç”¨çš„æ–‡ä»¶å¥æŸ„æ˜¯1024ä¸ªå¥æŸ„ã€‚</p><h5 id="2ã€è®¾ç½®æ–¹å¼"><a href="#2ã€è®¾ç½®æ–¹å¼" class="headerlink" title="2ã€è®¾ç½®æ–¹å¼"></a>2ã€è®¾ç½®æ–¹å¼</h5><ul><li>ç³»ç»Ÿå…¨å±€æ€§ä¿®æ”¹</li><li>ç”¨æˆ·å±€éƒ¨æ€§ä¿®æ”¹</li><li>è¿›ç¨‹å±€éƒ¨æ€§ä¿®æ”¹</li></ul><h5 id="3ã€ç³»ç»Ÿå…¨å±€æ€§ä¿®è¯¥å’Œç”¨æˆ·å±€éƒ¨æ€§ä¿®æ”¹"><a href="#3ã€ç³»ç»Ÿå…¨å±€æ€§ä¿®è¯¥å’Œç”¨æˆ·å±€éƒ¨æ€§ä¿®æ”¹" class="headerlink" title="3ã€ç³»ç»Ÿå…¨å±€æ€§ä¿®è¯¥å’Œç”¨æˆ·å±€éƒ¨æ€§ä¿®æ”¹"></a>3ã€ç³»ç»Ÿå…¨å±€æ€§ä¿®è¯¥å’Œç”¨æˆ·å±€éƒ¨æ€§ä¿®æ”¹</h5><pre><code>[root@server ~]#vim /etc/security/limits.conf</code></pre><p>åœ¨æ–‡ä»¶æœ€ä¸‹é¢æ‰¾åˆ°</p><pre><code>#*               soft    core            0#*               hard    rss             10000#@student        hard    nproc           20#@faculty        soft    nproc           20#@faculty        hard    nproc           50#ftp             hard    nproc           0#@student        -       maxlogins       4#rootåªæ˜¯é’ˆå¯¹rootè¿™ä¸ªç”¨æˆ·æ¥é™åˆ¶ï¼Œsoftåªæ˜¯å‘æé†’ï¼Œæ“ä½œç³»ç»Ÿä¸ä¼šå¼ºåˆ¶é™åˆ¶,ä¸€èˆ¬çš„ç«™ç‚¹è®¾ç½®ä¸ºä¸€ä¸‡å·¦å³å°±okäº†root soft nofile 65535root hard nofile 65535# *ä»£è¡¨é€šé…ç¬¦ æ‰€æœ‰çš„ç”¨æˆ·*    soft nofile 25535*    hard nofile 25535</code></pre><p>å¯ä»¥çœ‹åˆ°rootå’Œ<em>ï¼Œrootä»£è¡¨æ˜¯rootç”¨æˆ·ï¼Œ</em>ä»£è¡¨çš„æ˜¯æ‰€æœ‰ç”¨æˆ·ï¼Œåé¢çš„æ•°å­—å°±æ˜¯æ–‡ä»¶å¥æŸ„å¤§å°ã€‚å¤§å®¶å¯ä»¥æ ¹æ®ä¸ªäººä¸šåŠ¡æ¥è¿›è¡Œè®¾ç½®ã€‚</p><h5 id="4ã€è¿›ç¨‹å±€éƒ¨æ€§ä¿®æ”¹"><a href="#4ã€è¿›ç¨‹å±€éƒ¨æ€§ä¿®æ”¹" class="headerlink" title="4ã€è¿›ç¨‹å±€éƒ¨æ€§ä¿®æ”¹"></a>4ã€è¿›ç¨‹å±€éƒ¨æ€§ä¿®æ”¹</h5><pre><code>[root@server ~]#vim /etc/nginx/nginx.confuser  nginx;worker_processes  1;  error_log  /var/log/nginx/error.log warn;pid        /var/run/nginx.pid;worker_rlimit_nofile 65535; #è¿›ç¨‹é™åˆ¶events {    worker_connections  1024;}http {    include       /etc/nginx/mime.types;    default_type  application/octet-stream;    log_format  main  &#39;$http_user_agent&#39; &#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39;                      &#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;                      &#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot; &#39;                      &#39;&quot;$args&quot; &quot;$request_uri&quot;&#39;;    access_log  /var/log/nginx/access.log  main;    sendfile        on;     #tcp_nopush     on;     keepalive_timeout  65;     #gzip  on;     include /etc/nginx/conf.d/*.conf;}</code></pre><p>worker_rlimit_nofile æ˜¯åœ¨è¿›ç¨‹ä¸Šé¢è¿›è¡Œé™åˆ¶ã€‚</p><h5 id="5ã€cpuçš„äº²å’Œé…ç½®"><a href="#5ã€cpuçš„äº²å’Œé…ç½®" class="headerlink" title="5ã€cpuçš„äº²å’Œé…ç½®"></a>5ã€cpuçš„äº²å’Œé…ç½®</h5><p>cpuçš„äº²å’Œèƒ½å¤Ÿä½¿nginxå¯¹äºä¸åŒçš„workå·¥ä½œè¿›ç¨‹ç»‘å®šåˆ°ä¸åŒçš„cpuä¸Šé¢å»ã€‚å°±èƒ½å¤Ÿå‡å°‘åœ¨worké—´ä¸æ–­åˆ‡æ¢cpuï¼ŒæŠŠè¿›ç¨‹é€šå¸¸ä¸ä¼šåœ¨å¤„ç†å™¨ä¹‹é—´é¢‘ç¹è¿ç§»ï¼Œè¿›ç¨‹è¿ç§»çš„é¢‘ç‡å°ï¼Œæ¥å‡å°‘æ€§èƒ½æŸè€—ã€‚nginx äº²å’Œé…ç½®</p><p>æŸ¥çœ‹ç‰©ç†cpu</p><pre><code>[root@server ~]#cat /proc/cpuinfo|grep &quot;physical id&quot;|sort |uniq|wc -l</code></pre><p>æŸ¥çœ‹cpuæ ¸å¿ƒæ•°</p><pre><code>[root@server ~]#cat /proc/cpuinfo|grep &quot;cpu cores&quot;|uniq</code></pre><p>æŸ¥çœ‹cpuä½¿ç”¨ç‡</p><pre><code>[root@server ~]#top  å›è½¦åæŒ‰ 1</code></pre><h5 id="6ã€é…ç½®worker-processes"><a href="#6ã€é…ç½®worker-processes" class="headerlink" title="6ã€é…ç½®worker_processes"></a>6ã€é…ç½®worker_processes</h5><pre><code>[root@server ~]#vim /etc/nginx/nginx.conf</code></pre><p>å°†åˆšæ‰æŸ¥çœ‹åˆ°è‡ªå·±cpu * cpuæ ¸å¿ƒå°±æ˜¯worker_processes</p><pre><code>worker_processes 2; #æ ¹æ®è‡ªå·±cpuæ ¸å¿ƒæ•°é…ç½®</code></pre><h5 id="7ã€cpuäº²å’Œé…ç½®"><a href="#7ã€cpuäº²å’Œé…ç½®" class="headerlink" title="7ã€cpuäº²å’Œé…ç½®"></a>7ã€cpuäº²å’Œé…ç½®</h5><p>å‡å¦‚å°èœçš„é…ç½®æ˜¯2cpuï¼Œæ¯ä¸ªcpuæ˜¯8æ ¸ã€‚é…ç½®å¦‚ä¸‹</p><pre><code>worker_processes 16;worker_cpu_affinity 1010101010101010 0101010101010101;</code></pre><p>é…ç½®å®Œæˆåå¯ä»¥é€šè¿‡ä¸‹é¢å‘½ä»¤æŸ¥çœ‹nginxè¿›ç¨‹é…ç½®åœ¨å“ªä¸ªæ ¸ä¸Š</p><pre><code>[root@server ~]#ps -eo pid,args,psr |grep [n]ginx</code></pre><p>åœ¨nginx 1.9ç‰ˆæœ¬ä¹‹åï¼Œå°±å¸®æˆ‘ä»¬è‡ªåŠ¨ç»‘å®šäº†cpu;</p><pre><code>worker_cpu_affinity auto;</code></pre><h4 id="5ã€nginxé€šç”¨é…ç½®ä¼˜åŒ–"><a href="#5ã€nginxé€šç”¨é…ç½®ä¼˜åŒ–" class="headerlink" title="5ã€nginxé€šç”¨é…ç½®ä¼˜åŒ–"></a>5ã€nginxé€šç”¨é…ç½®ä¼˜åŒ–</h4><pre><code>[root@server ~]#vim /etc/nginx/nginx.conf#å°†nginxè¿›ç¨‹è®¾ç½®ä¸ºæ™®é€šç”¨æˆ·ï¼Œä¸ºäº†å®‰å…¨è€ƒè™‘user nginx; #å½“å‰å¯åŠ¨çš„workerè¿›ç¨‹ï¼Œå®˜æ–¹å»ºè®®æ˜¯ä¸ç³»ç»Ÿæ ¸å¿ƒæ•°ä¸€ç›´worker_processes 2;#æ–¹å¼ä¸€ï¼Œ ç¬¬ä¸€ä¸ªworkè¿›ç¨‹ç»‘å®šç¬¬ä¸€ä¸ªcpuæ ¸å¿ƒï¼Œç¬¬äºŒä¸ªworkè¿›ç¨‹ç»‘å®šåˆ°ç¬¬äºŒä¸ªcpuæ ¸å¿ƒï¼Œä¾æ¬¡å†…æ¨ ç›´åˆ°å¼Ÿ16ä¸ª#wokrer_cpu_affinity 0000000000000000 0000000000000001 0000000000000010 0000000000000100 ... 1000000000000000#æ–¹å¼äºŒï¼Œå½“ worker_processes 2 æ—¶ï¼Œè¡¨æ˜ ç¬¬ä¸€workè¿›ç¨‹å¯ä»¥ç»‘å®šç¬¬ 2 4 6 8 10 12 14 16 æ ¸å¿ƒï¼Œé‚£ä¹ˆç¬¬äºŒworkè¿›ç¨‹å°±ç»‘å®š å¥‡æ•°æ ¸å¿ƒ#worker_cpu_affinity 1010101010101010 0101010101010101;#æ–¹å¼ä¸‰ï¼Œå°±æ˜¯è‡ªåŠ¨åˆ†é…ç»‘å®šworker_cpu_affinity auto;#æ—¥å¿—é…ç½®æˆwarnerror_log /var/log/nginx/error.log warn; pid /var/run/nginx.pid;#é’ˆå¯¹ nginx å¥æŸ„çš„æ–‡ä»¶é™åˆ¶worker_rlimit_nofile 35535;#äº‹ä»¶æ¨¡å‹events {    #ä½¿ç”¨epollå†…æ ¸æ¨¡å‹    user epoll;    #æ¯ä¸€ä¸ªè¿›ç¨‹å¯ä»¥å¤„ç†å¤šå°‘ä¸ªè¿æ¥ï¼Œå¦‚æœæ˜¯å¤šæ ¸å¯ä»¥å°†è¿æ¥æ•°è°ƒé«˜ worker_processes * 1024    worker_connections 10240;}http {    include       /etc/nginx/mime.types;    default_type  application/octet-stream;    charset utf-8;  #è®¾ç½®å­—ç¬¦é›†    #è®¾ç½®æ—¥å¿—è¾“å‡ºæ ¼å¼ï¼Œæ ¹æ®è‡ªå·±çš„æƒ…å†µè®¾ç½®    log_format  main  &#39;$http_user_agent&#39; &#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39;                      &#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;                      &#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot; &#39;                      &#39;&quot;$args&quot; &quot;$request_uri&quot;&#39;;    access_log  /var/log/nginx/access.log  main;    sendfile        on;   #å¯¹é™æ€èµ„æºçš„å¤„ç†æ¯”è¾ƒæœ‰æ•ˆ    #tcp_nopush     on;   #å¦‚æœåšé™æ€èµ„æºæœåŠ¡å™¨å¯ä»¥æ‰“å¼€    #tcp_nodeny     on;   #å½“nginxåšåŠ¨æ€çš„æœåŠ¡æ—¶å¯ä»¥é€‰æ‹©æ‰“å¼€    keepalive_timeout  65;     ########    #Gzip module    gzip  on;    #æ–‡ä»¶å‹ç¼©é»˜è®¤å¯ä»¥æ‰“å¼€    gzip_disable &quot;MSIE [1-6]\.&quot;; #å¯¹äºæœ‰äº›æµè§ˆå™¨ä¸èƒ½è¯†åˆ«å‹ç¼©ï¼Œéœ€è¦è¿‡æ»¤å¦‚ie6    gzip_http_version 1.1;    include /etc/nginx/conf.d/*.conf;}#æŸ¥çœ‹ æ ¸å¿ƒç»‘å®šçš„nginx workè¿›ç¨‹[root@server ~]#ps -eo pid,args,psr | grep [n]ginx</code></pre><h4 id="6ã€abæ¥å£å‹åŠ›æµ‹è¯•å·¥å…·"><a href="#6ã€abæ¥å£å‹åŠ›æµ‹è¯•å·¥å…·" class="headerlink" title="6ã€abæ¥å£å‹åŠ›æµ‹è¯•å·¥å…·"></a>6ã€abæ¥å£å‹åŠ›æµ‹è¯•å·¥å…·</h4><p>abæ˜¯Apacheè¶…æ–‡æœ¬ä¼ è¾“åè®®(HTTP)çš„æ€§èƒ½æµ‹è¯•å·¥å…·ã€‚å…¶è®¾è®¡æ„å›¾æ˜¯æç»˜å½“å‰æ‰€å®‰è£…çš„Apacheçš„æ‰§è¡Œæ€§èƒ½ï¼Œä¸»è¦æ˜¯æ˜¾ç¤ºä½ å®‰è£…çš„Apacheæ¯ç§’å¯ä»¥å¤„ç†å¤šå°‘ä¸ªè¯·æ±‚ã€‚</p><pre><code># å®‰è£…å·¥å…·[root@server ~]#yum install httpd-tools# ä½¿ç”¨[root@server ~]#ab -n 2000 -c 2 http://127.0.0.1/index.html-n æ€»çš„è¯·æ±‚æ•°-c å¹¶å‘æ•°-k æ˜¯å¦å¼€å¯é•¿è¿æ¥</code></pre><h5 id="1ã€å‚æ•°é€‰é¡¹"><a href="#1ã€å‚æ•°é€‰é¡¹" class="headerlink" title="1ã€å‚æ•°é€‰é¡¹"></a>1ã€å‚æ•°é€‰é¡¹</h5><pre><code>-nï¼šå³requestsï¼Œç”¨äºæŒ‡å®šå‹åŠ›æµ‹è¯•æ€»å…±çš„æ‰§è¡Œæ¬¡æ•°-cï¼šå³concurrencyï¼Œç”¨äºæŒ‡å®šçš„å¹¶å‘æ•°-tï¼šå³timelimitï¼Œç­‰å¾…å“åº”çš„æœ€å¤§æ—¶é—´(å•ä½ï¼šç§’)-bï¼šå³windowsizeï¼ŒTCPå‘é€/æ¥æ”¶çš„ç¼“å†²å¤§å°(å•ä½ï¼šå­—èŠ‚)-pï¼šå³postfileï¼Œå‘é€POSTè¯·æ±‚æ—¶éœ€è¦ä¸Šä¼ çš„æ–‡ä»¶ï¼Œæ­¤å¤–è¿˜å¿…é¡»è®¾ç½®-Tå‚æ•°-uï¼šå³putfileï¼Œå‘é€PUTè¯·æ±‚æ—¶éœ€è¦ä¸Šä¼ çš„æ–‡ä»¶ï¼Œæ­¤å¤–è¿˜å¿…é¡»è®¾ç½®-Tå‚æ•°-Tï¼šå³content-typeï¼Œç”¨äºè®¾ç½®Content-Typeè¯·æ±‚å¤´ä¿¡æ¯ï¼Œä¾‹å¦‚ï¼šapplication/x-www-form-urlencodedï¼Œé»˜è®¤å€¼ä¸ºtext/plain-vï¼šå³verbosityï¼ŒæŒ‡å®šæ‰“å°å¸®åŠ©ä¿¡æ¯çš„å†—ä½™çº§åˆ«-wï¼šä»¥HTMLè¡¨æ ¼å½¢å¼æ‰“å°ç»“æœ-iï¼šä½¿ç”¨HEADè¯·æ±‚ä»£æ›¿GETè¯·æ±‚-xï¼šæ’å…¥å­—ç¬¦ä¸²ä½œä¸ºtableæ ‡ç­¾çš„å±æ€§-yï¼šæ’å…¥å­—ç¬¦ä¸²ä½œä¸ºtræ ‡ç­¾çš„å±æ€§-zï¼šæ’å…¥å­—ç¬¦ä¸²ä½œä¸ºtdæ ‡ç­¾çš„å±æ€§-Cï¼šæ·»åŠ cookieä¿¡æ¯ï¼Œä¾‹å¦‚ï¼š&quot;Apache=1234&quot;(å¯ä»¥é‡å¤è¯¥å‚æ•°é€‰é¡¹ä»¥æ·»åŠ å¤šä¸ª)-Hï¼šæ·»åŠ ä»»æ„çš„è¯·æ±‚å¤´ï¼Œä¾‹å¦‚ï¼š&quot;Accept-Encoding: gzip&quot;ï¼Œè¯·æ±‚å¤´å°†ä¼šæ·»åŠ åœ¨ç°æœ‰çš„å¤šä¸ªè¯·æ±‚å¤´ä¹‹å(å¯ä»¥é‡å¤è¯¥å‚æ•°é€‰é¡¹ä»¥æ·»åŠ å¤šä¸ª)-Aï¼šæ·»åŠ ä¸€ä¸ªåŸºæœ¬çš„ç½‘ç»œè®¤è¯ä¿¡æ¯ï¼Œç”¨æˆ·åå’Œå¯†ç ä¹‹é—´ç”¨è‹±æ–‡å†’å·éš”å¼€-Pï¼šæ·»åŠ ä¸€ä¸ªåŸºæœ¬çš„ä»£ç†è®¤è¯ä¿¡æ¯ï¼Œç”¨æˆ·åå’Œå¯†ç ä¹‹é—´ç”¨è‹±æ–‡å†’å·éš”å¼€-Xï¼šæŒ‡å®šä½¿ç”¨çš„å’Œç«¯å£å·ï¼Œä¾‹å¦‚:&quot;126.10.10.3:88&quot;-Vï¼šæ‰“å°ç‰ˆæœ¬å·å¹¶é€€å‡º-kï¼šä½¿ç”¨HTTPçš„KeepAliveç‰¹æ€§-dï¼šä¸æ˜¾ç¤ºç™¾åˆ†æ¯”-Sï¼šä¸æ˜¾ç¤ºé¢„ä¼°å’Œè­¦å‘Šä¿¡æ¯-gï¼šè¾“å‡ºç»“æœä¿¡æ¯åˆ°gnuplotæ ¼å¼çš„æ–‡ä»¶ä¸­-eï¼šè¾“å‡ºç»“æœä¿¡æ¯åˆ°CSVæ ¼å¼çš„æ–‡ä»¶ä¸­-rï¼šæŒ‡å®šæ¥æ”¶åˆ°é”™è¯¯ä¿¡æ¯æ—¶ä¸é€€å‡ºç¨‹åº-Hï¼šæ˜¾ç¤ºç”¨æ³•ä¿¡æ¯ï¼Œå…¶å®å°±æ˜¯ab -help</code></pre><h5 id="2ã€å†…å®¹è§£é‡Š"><a href="#2ã€å†…å®¹è§£é‡Š" class="headerlink" title="2ã€å†…å®¹è§£é‡Š"></a>2ã€å†…å®¹è§£é‡Š</h5><pre><code>Server Software:        nginx/1.10.2 (æœåŠ¡å™¨è½¯ä»¶åç§°åŠç‰ˆæœ¬ä¿¡æ¯)Server Hostname:        192.168.1.106(æœåŠ¡å™¨ä¸»æœºå)Server Port:            80 (æœåŠ¡å™¨ç«¯å£)Document Path:          /index1.html. (ä¾›æµ‹è¯•çš„URLè·¯å¾„)Document Length:        3721 bytes (ä¾›æµ‹è¯•çš„URLè¿”å›çš„æ–‡æ¡£å¤§å°)Concurrency Level:      1000 (å¹¶å‘æ•°)Time taken for tests:   2.327 seconds (å‹åŠ›æµ‹è¯•æ¶ˆè€—çš„æ€»æ—¶é—´)Complete requests:      5000 (çš„æ€»æ¬¡æ•°)Failed requests:        688 (å¤±è´¥çš„è¯·æ±‚æ•°)Write errors:           0 (ç½‘ç»œè¿æ¥å†™å…¥é”™è¯¯æ•°)Total transferred:      17402975 bytes (ä¼ è¾“çš„æ€»æ•°æ®é‡)HTML transferred:       16275725 bytes (HTMLæ–‡æ¡£çš„æ€»æ•°æ®é‡)Requests per second:    2148.98 [#/sec] (mean) (å¹³å‡æ¯ç§’çš„è¯·æ±‚æ•°) è¿™ä¸ªæ˜¯éå¸¸é‡è¦çš„å‚æ•°æ•°å€¼ï¼ŒæœåŠ¡å™¨çš„ååé‡ Time per request:       465.338 [ms] (mean) (æ‰€æœ‰å¹¶å‘ç”¨æˆ·(è¿™é‡Œæ˜¯1000)éƒ½è¯·æ±‚ä¸€æ¬¡çš„å¹³å‡æ—¶é—´)Time  request:          0.247 [ms] (mean, across all concurrent requests) (å•ä¸ªç”¨æˆ·è¯·æ±‚ä¸€æ¬¡çš„å¹³å‡æ—¶é—´)Transfer rate:          7304.41 [Kbytes/sec] received æ¯ç§’è·å–çš„æ•°æ®é•¿åº¦ (ä¼ è¾“é€Ÿç‡ï¼Œå•ä½ï¼šKB/s)...Percentage of the requests served within a certain time (ms)  50%    347  ## 50%çš„è¯·æ±‚åœ¨347mså†…è¿”å›   66%    401  ## 60%çš„è¯·æ±‚åœ¨401mså†…è¿”å›   75%    431  80%    516  90%    600  95%    846  98%   1571  99%   1593 100%   1619 (longest request)</code></pre><h5 id="3ã€ç¤ºä¾‹æ¼”ç¤º"><a href="#3ã€ç¤ºä¾‹æ¼”ç¤º" class="headerlink" title="3ã€ç¤ºä¾‹æ¼”ç¤º"></a>3ã€ç¤ºä¾‹æ¼”ç¤º</h5><pre><code>[root@server ~]#ab -n 50 -c 20 http://walidream.com/sub_module</code></pre><p>è¾“å‡ºå†…å®¹</p><pre><code>Server Software:        nginx/1.14.1Server Hostname:        walidream.comServer Port:            80Document Path:          /sub_moduleDocument Length:        169 bytesConcurrency Level:      20Time taken for tests:   0.005 secondsComplete requests:      50Failed requests:        0Write errors:           0Non-2xx responses:      50Total transferred:      14900 bytesHTML transferred:       8450 bytesRequests per second:    9746.59 [#/sec] (mean)Time per request:       2.052 [ms] (mean)Time per request:       0.103 [ms] (mean, across all concurrent requests)Transfer rate:          2836.41 [Kbytes/sec] receivedConnection Times (ms)              min  mean[+/-sd] median   maxConnect:        0    0   0.1      0       1Processing:     1    1   0.3      1       2Waiting:        0    1   0.2      1       1Total:          1    2   0.3      2       2Percentage of the requests served within a certain time (ms)  50%      2  66%      2  75%      2  80%      2  90%      2  95%      2  98%      2  99%      2 100%      2 (longest request)</code></pre><h5 id="5ã€æ³¨æ„äº‹é¡¹"><a href="#5ã€æ³¨æ„äº‹é¡¹" class="headerlink" title="5ã€æ³¨æ„äº‹é¡¹"></a>5ã€æ³¨æ„äº‹é¡¹</h5><p>â— æµ‹è¯•æœºä¸è¢«æµ‹è¯•æœºè¦åˆ†å¼€</p><p>â— ä¸è¦å¯¹çº¿ä¸Šçš„æœåŠ¡å™¨åšå‹åŠ›æµ‹è¯•</p><p>â— è§‚å¯Ÿæµ‹è¯•å·¥å…·abæ‰€åœ¨æœºå™¨ï¼Œä»¥åŠè¢«æµ‹è¯•çš„å‰ç«¯æœºçš„CPUã€å†…å­˜ã€ç½‘ç»œç­‰éƒ½ä¸è¶…è¿‡æœ€é«˜é™åº¦çš„75%</p><h5 id="6ã€abæ€§èƒ½æŒ‡æ ‡"><a href="#6ã€abæ€§èƒ½æŒ‡æ ‡" class="headerlink" title="6ã€abæ€§èƒ½æŒ‡æ ‡"></a>6ã€abæ€§èƒ½æŒ‡æ ‡</h5><h6 id="1ã€ååç‡ï¼ˆRequests-per-secondï¼‰"><a href="#1ã€ååç‡ï¼ˆRequests-per-secondï¼‰" class="headerlink" title="1ã€ååç‡ï¼ˆRequests per secondï¼‰"></a>1ã€ååç‡ï¼ˆRequests per secondï¼‰</h6><p>æœåŠ¡å™¨å¹¶å‘å¤„ç†èƒ½åŠ›çš„é‡åŒ–æè¿°ï¼Œå•ä½æ˜¯reqs/sï¼ŒæŒ‡çš„æ˜¯åœ¨æŸä¸ªå¹¶å‘ç”¨æˆ·æ•°ä¸‹å•ä½æ—¶é—´å†…å¤„ç†çš„è¯·æ±‚æ•°ã€‚æŸä¸ªå¹¶å‘ç”¨æˆ·æ•°ä¸‹å•ä½æ—¶é—´å†…èƒ½å¤„ç†çš„æœ€å¤§è¯·æ±‚æ•°ï¼Œç§°ä¹‹ä¸ºæœ€å¤§ååç‡ã€‚è®°ä½ï¼šååç‡æ˜¯åŸºäºå¹¶å‘ç”¨æˆ·æ•°çš„ã€‚è¿™å¥è¯ä»£è¡¨äº†ä¸¤ä¸ªå«ä¹‰ï¼š</p><pre><code>â— ååç‡å’Œå¹¶å‘ç”¨æˆ·æ•°ç›¸å…³â— ä¸åŒçš„å¹¶å‘ç”¨æˆ·æ•°ä¸‹ï¼Œååç‡ä¸€èˆ¬æ˜¯ä¸åŒçš„</code></pre><p>è®¡ç®—å…¬å¼ï¼šæ€»è¯·æ±‚æ•°/å¤„ç†å®Œæˆè¿™äº›è¯·æ±‚æ•°æ‰€èŠ±è´¹çš„æ—¶é—´ï¼Œå³</p><pre><code>Request per second=Complete requests/Time taken for tests</code></pre><p>å¿…é¡»è¦è¯´æ˜çš„æ˜¯ï¼Œè¿™ä¸ªæ•°å€¼è¡¨ç¤ºå½“å‰æœºå™¨çš„æ•´ä½“æ€§èƒ½ï¼Œå€¼è¶Šå¤§è¶Šå¥½</p><h6 id="2ã€å¹¶å‘è¿æ¥æ•°ï¼ˆThe-number-of-concurrent-connectionsï¼‰"><a href="#2ã€å¹¶å‘è¿æ¥æ•°ï¼ˆThe-number-of-concurrent-connectionsï¼‰" class="headerlink" title="2ã€å¹¶å‘è¿æ¥æ•°ï¼ˆThe number of concurrent connectionsï¼‰"></a>2ã€å¹¶å‘è¿æ¥æ•°ï¼ˆThe number of concurrent connectionsï¼‰</h6><p>å¹¶å‘è¿æ¥æ•°æŒ‡çš„æ˜¯æŸä¸ªæ—¶åˆ»æœåŠ¡å™¨æ‰€æ¥å—çš„è¯·æ±‚æ•°ç›®ï¼Œç®€å•çš„è®²ï¼Œå°±æ˜¯ä¸€ä¸ªä¼šè¯ã€‚</p><h6 id="3ã€å¹¶å‘ç”¨æˆ·æ•°ï¼ˆConcurrency-Levelï¼‰"><a href="#3ã€å¹¶å‘ç”¨æˆ·æ•°ï¼ˆConcurrency-Levelï¼‰" class="headerlink" title="3ã€å¹¶å‘ç”¨æˆ·æ•°ï¼ˆConcurrency Levelï¼‰"></a>3ã€å¹¶å‘ç”¨æˆ·æ•°ï¼ˆConcurrency Levelï¼‰</h6><p>è¦æ³¨æ„åŒºåˆ†è¿™ä¸ªæ¦‚å¿µå’Œå¹¶å‘è¿æ¥æ•°ä¹‹é—´çš„åŒºåˆ«ï¼Œä¸€ä¸ªç”¨æˆ·å¯èƒ½åŒæ—¶ä¼šäº§ç”Ÿå¤šä¸ªä¼šè¯ï¼Œä¹Ÿå³è¿æ¥æ•°ã€‚åœ¨HTTP/1.1ä¸‹ï¼ŒIE7æ”¯æŒä¸¤ä¸ªå¹¶å‘è¿æ¥ï¼ŒIE8æ”¯æŒ6ä¸ªå¹¶å‘è¿æ¥ï¼ŒFireFox3æ”¯æŒ4ä¸ªå¹¶å‘è¿æ¥ï¼Œæ‰€ä»¥ç›¸åº”çš„ï¼Œæˆ‘ä»¬çš„å¹¶å‘ç”¨æˆ·æ•°å°±å¾—é™¤ä»¥è¿™ä¸ªåŸºæ•°ã€‚</p><h6 id="4-ç”¨æˆ·å¹³å‡è¯·æ±‚ç­‰å¾…æ—¶é—´ï¼ˆTime-per-requestï¼‰"><a href="#4-ç”¨æˆ·å¹³å‡è¯·æ±‚ç­‰å¾…æ—¶é—´ï¼ˆTime-per-requestï¼‰" class="headerlink" title="4.ç”¨æˆ·å¹³å‡è¯·æ±‚ç­‰å¾…æ—¶é—´ï¼ˆTime per requestï¼‰"></a>4.ç”¨æˆ·å¹³å‡è¯·æ±‚ç­‰å¾…æ—¶é—´ï¼ˆTime per requestï¼‰</h6><p>è®¡ç®—å…¬å¼ï¼šå¤„ç†å®Œæˆæ‰€æœ‰è¯·æ±‚æ•°æ‰€èŠ±è´¹çš„æ—¶é—´/ï¼ˆæ€»è¯·æ±‚æ•°/å¹¶å‘ç”¨æˆ·æ•°ï¼‰ï¼Œå³ï¼š</p><pre><code>Time per request=Time taken for tests/ï¼ˆComplete requests/Concurrency Levelï¼‰</code></pre><h6 id="5-æœåŠ¡å™¨å¹³å‡è¯·æ±‚ç­‰å¾…æ—¶é—´ï¼ˆTime-per-request-across-all-concurrent-requestsï¼‰"><a href="#5-æœåŠ¡å™¨å¹³å‡è¯·æ±‚ç­‰å¾…æ—¶é—´ï¼ˆTime-per-request-across-all-concurrent-requestsï¼‰" class="headerlink" title="5.æœåŠ¡å™¨å¹³å‡è¯·æ±‚ç­‰å¾…æ—¶é—´ï¼ˆTime per request:across all concurrent requestsï¼‰"></a>5.æœåŠ¡å™¨å¹³å‡è¯·æ±‚ç­‰å¾…æ—¶é—´ï¼ˆTime per request:across all concurrent requestsï¼‰</h6><p>è®¡ç®—å…¬å¼ï¼šå¤„ç†å®Œæˆæ‰€æœ‰è¯·æ±‚æ•°æ‰€èŠ±è´¹çš„æ—¶é—´/æ€»è¯·æ±‚æ•°ï¼Œå³ï¼š</p><pre><code>Time taken for/testsComplete requests</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œå®ƒæ˜¯ååç‡çš„å€’æ•°ã€‚åŒæ—¶ï¼Œå®ƒä¹Ÿç­‰äºç”¨æˆ·å¹³å‡è¯·æ±‚ç­‰å¾…æ—¶é—´/å¹¶å‘ç”¨æˆ·æ•°ï¼Œå³</p><pre><code>Time per request/Concurrency Level</code></pre>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Nginx </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Zabbix-æºç å®‰è£…</title>
      <link href="2019/08/05/jian-kong/zabbix/zabbix-yuan-ma-an-zhuang/"/>
      <url>2019/08/05/jian-kong/zabbix/zabbix-yuan-ma-an-zhuang/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h3 id="Zabbixæºç å®‰è£…"><a href="#Zabbixæºç å®‰è£…" class="headerlink" title="Zabbixæºç å®‰è£…"></a>Zabbixæºç å®‰è£…</h3><h4 id="1-å‰æœŸå‡†å¤‡"><a href="#1-å‰æœŸå‡†å¤‡" class="headerlink" title="1:å‰æœŸå‡†å¤‡"></a>1:å‰æœŸå‡†å¤‡</h4><p> æ³¨æ„å®‰è£…zabbixéœ€è¦lnmpç¯å¢ƒå¯ä»¥ä½¿ç”¨è„šæœ¬å®‰è£…lnmp</p><p>è¿™é‡Œæˆ‘è¿›è¡Œæºç å®‰è£…ä¸€æ­¥æ­¥çš„æ“ä½œ</p><p>å»ºè®®ä½¿ç”¨è„šæœ¬è¿›è¡Œ ç”¨æºç å®‰è£…æ¯”è¾ƒæ…¢</p><h5 id="1-å…³é—­é˜²ç«å¢™å’Œselinux-å»ºè®®å¯ä»¥å®è¡Œæ”¾è¡Œç­–ç•¥"><a href="#1-å…³é—­é˜²ç«å¢™å’Œselinux-å»ºè®®å¯ä»¥å®è¡Œæ”¾è¡Œç­–ç•¥" class="headerlink" title="(1) å…³é—­é˜²ç«å¢™å’Œselinux å»ºè®®å¯ä»¥å®è¡Œæ”¾è¡Œç­–ç•¥"></a>(1) å…³é—­é˜²ç«å¢™å’Œselinux å»ºè®®å¯ä»¥å®è¡Œæ”¾è¡Œç­–ç•¥</h5><h5 id="2-åˆ›å»ºå®‰è£…ç›®å½•"><a href="#2-åˆ›å»ºå®‰è£…ç›®å½•" class="headerlink" title="(2)åˆ›å»ºå®‰è£…ç›®å½•"></a>(2)åˆ›å»ºå®‰è£…ç›®å½•</h5><pre class=" language-shell"><code class="language-shell">   mkdir -pv /cyylog/{mysql-5.7,nginx-1.16,php-7.2,zabbix-4.4}   mkdir -pv /cyylog/mysql-5.7/data   ln -s /cyylog/mysql-5.7 /cyylog/mysql   ln -s /cyylog/nginx-1.16 /cyylog/nginx   ln -s /cyylog/php-7.2 /cyylog/php   ln -s /cyylog/zabbix-4.4 /cyylog/zabbix</code></pre><h5 id="3-åˆ›å»ºç”¨æˆ·"><a href="#3-åˆ›å»ºç”¨æˆ·" class="headerlink" title="(3)åˆ›å»ºç”¨æˆ·"></a>(3)åˆ›å»ºç”¨æˆ·</h5><pre class=" language-shell"><code class="language-shell">   useradd -s /sbin/nologin mysql   useradd -s /sbin/nologin nginx   useradd -s /sbin/nologin zabbix</code></pre><p>ä¹Ÿå¯æ‰§è¡Œè„šæœ¬</p><h4 id="2-å®‰è£…mysql"><a href="#2-å®‰è£…mysql" class="headerlink" title="2:å®‰è£…mysql"></a>2:å®‰è£…mysql</h4><h5 id="1-ä¸‹è½½mysqlæºç åŒ…"><a href="#1-ä¸‹è½½mysqlæºç åŒ…" class="headerlink" title="(1)ä¸‹è½½mysqlæºç åŒ…"></a>(1)ä¸‹è½½mysqlæºç åŒ…</h5><pre class=" language-shell"><code class="language-shell">wget https://dev.mysql.com/get/Downloads/MySQL-5.7/mysql-5.7.29.tar.gzwget https://dev.mysql.com/get/Downloads/MySQL-5.7/mysql-boost-5.7.29.tar.gz</code></pre><h5 id="2-ä½¿ç”¨yumå®‰è£…ä¾èµ–åŒ…"><a href="#2-ä½¿ç”¨yumå®‰è£…ä¾èµ–åŒ…" class="headerlink" title="(2) ä½¿ç”¨yumå®‰è£…ä¾èµ–åŒ…"></a><strong>(2)</strong> ä½¿ç”¨yumå®‰è£…ä¾èµ–åŒ…</h5><pre class=" language-shell"><code class="language-shell">yum install -y cmake gcc gcc-c++ openssl-devel ncurses-devel</code></pre><h5 id="3-è§£å‹å¹¶è¿›å…¥è¿›è¡Œå®‰è£…"><a href="#3-è§£å‹å¹¶è¿›å…¥è¿›è¡Œå®‰è£…" class="headerlink" title="(3) è§£å‹å¹¶è¿›å…¥è¿›è¡Œå®‰è£…"></a><strong>(3)</strong> è§£å‹å¹¶è¿›å…¥è¿›è¡Œå®‰è£…</h5><pre class=" language-shell"><code class="language-shell">tar xvf mysql-5.7.29.tar.gztar xvf mysql-boost-5.7.29.tar.gz -C /cyylog/é…ç½®cmake \-DCMAKE_INSTALL_PREFIX=/cyylog/mysql-5.7 \-DMYSQL_DATADIR=/cyylog/mysql-5.7/data \-DDEFAULT_CHARSET=utf8 \-DDEFAULT_COLLATION=utf8_unicode_ci \-DWITH_READLINE=1 \-DWITH_SSL=system \-DWITH_EMBEDDED_SERVER=1 \-DENABLED_LOCAL_INFILE=1 \-DDEFAULT_COLLATION=utf8_general_ci \-DWITH_MYISAM_STORAGE_ENGINE=1 \-DWITH_INNOBASE_STORAGE_ENGINE=1 \-DWITH_DEBUG=0 \-DWITH_BOOST=/cyylog/mysql-5.7.29/boost/boost_1_59_0ç¼–è¯‘ä¸”å®‰è£… make & make install</code></pre><h5 id="4-åˆ›å»ºéœ€è¦çš„æ–‡ä»¶åŠæ›´æ”¹å±ä¸»å’Œå±ç»„"><a href="#4-åˆ›å»ºéœ€è¦çš„æ–‡ä»¶åŠæ›´æ”¹å±ä¸»å’Œå±ç»„" class="headerlink" title="(4) åˆ›å»ºéœ€è¦çš„æ–‡ä»¶åŠæ›´æ”¹å±ä¸»å’Œå±ç»„"></a><strong>(4)</strong> åˆ›å»ºéœ€è¦çš„æ–‡ä»¶åŠæ›´æ”¹å±ä¸»å’Œå±ç»„</h5><pre class=" language-shell"><code class="language-shell">mkdir -pv /cyylog/mysql/logtouch /cyylog/mysql/log/mariadb.logtouch /cyylog/mysql/log/mariadb.pidchown -R /cyylog/{mysql-5.7,mysql-5.7.29,mysql}</code></pre><h5 id="5-åˆå§‹åŒ–æ•°æ®"><a href="#5-åˆå§‹åŒ–æ•°æ®" class="headerlink" title="(5) åˆå§‹åŒ–æ•°æ®"></a><strong>(5)</strong> åˆå§‹åŒ–æ•°æ®</h5><pre class=" language-shell"><code class="language-shell">ä¿®æ”¹é…ç½®æ–‡ä»¶ vim /etc/my.cnf[mysqld]datadir=/cyylog/mysql/data #æ•°æ®å­˜å‚¨çš„åœ°æ–¹socket=/cyylog/mysql/mysql.sock #sockæ–‡ä»¶çš„è·¯å¾„skip-grant-tables #è·³è¿‡ç™»å½•è®¤è¯user=mysqlexplicit_defaults_for_timestamp=true[mysqld_safe]log-error=/cyylog/mysql/log/mariadb.log #é”™è¯¯æ—¥å¿—å­˜æ”¾çš„åœ°æ–¹pid-file=/cyylog/mysql/log/mariadb.pid</code></pre><h5 id="6-æ·»åŠ è‡³ç¯å¢ƒå˜é‡"><a href="#6-æ·»åŠ è‡³ç¯å¢ƒå˜é‡" class="headerlink" title="(6) æ·»åŠ è‡³ç¯å¢ƒå˜é‡"></a><strong>(6)</strong> æ·»åŠ è‡³ç¯å¢ƒå˜é‡</h5><pre class=" language-shell"><code class="language-shell">vim /etc/profile ä¿®æ”¹æœ«å°¾æ·»åŠ ä¸¤è¡Œexport PATH=$PATH:/cyylog/mysql/support-filesexport PATH=$PATH:/cyylog/mysql/binä¿å­˜é€€å‡ºåˆ·æ–°ç¯å¢ƒå˜é‡ source /etc/profile/</code></pre><h5 id="7-åˆå§‹åŒ–å¯åŠ¨mysql"><a href="#7-åˆå§‹åŒ–å¯åŠ¨mysql" class="headerlink" title="(7) åˆå§‹åŒ–å¯åŠ¨mysql"></a><strong>(7)</strong> åˆå§‹åŒ–å¯åŠ¨mysql</h5><pre class=" language-shell"><code class="language-shell">mysqld --initialize --user=mysql --basedir=/cyylog/mysql --datadir=/cyylog/mysql/datamysql.server startln -s /cyylog/mysql/mysql.sock /tmp/</code></pre><h5 id="8-ä¸‹è½½zabbixæºç åŒ…å¹¶è¿›è¡Œè§£å‹"><a href="#8-ä¸‹è½½zabbixæºç åŒ…å¹¶è¿›è¡Œè§£å‹" class="headerlink" title="(8) ä¸‹è½½zabbixæºç åŒ…å¹¶è¿›è¡Œè§£å‹"></a><strong>(8)</strong> ä¸‹è½½zabbixæºç åŒ…å¹¶è¿›è¡Œè§£å‹</h5><pre class=" language-shell"><code class="language-shell">wget https://sourceforge.net/projects/zabbix/files/ZABBIX%20Latest%20Stable/4.4.5/zabbix-4.4.5.tar.gztar xvf zabbix-4.4.5.tar.gzcd zabbix-4.4.5/database/mysqlç™»å½•mysql   å‘½ä»¤ä¸º mysql -u root è¿›å…¥åæ‰§è¡Œä»¥ä¸‹å‘½ä»¤use mysql;create database zabbix default character set utf8;update mysql.user set authentication_string=password('ä¿®æ”¹çš„å¯†ç ') where user='root';use zabbix;source schema.sql;source images.sql;source data.sql;quit;   æœ€åæ¢å¤å¯†ç ç™»å½•mysql ä¿®æ”¹æ–‡ä»¶vim /etc/my.cnfå»æ‰ skip-grant-tablesä¿å­˜é€€å‡ºé‡å¯mysqlæœåŠ¡ mysql.sercer restartæ·»åŠ libæ–‡ä»¶echo â€œ/cyylog/mysql/libâ€ > /etc/ld.so.conf.d/mysql.confldconfig -v</code></pre><h4 id="3-å®‰è£…nginx"><a href="#3-å®‰è£…nginx" class="headerlink" title="3:å®‰è£…nginx"></a>3:å®‰è£…nginx</h4><h5 id="1-ä¸‹è½½-nginx-å¹¶è§£å‹"><a href="#1-ä¸‹è½½-nginx-å¹¶è§£å‹" class="headerlink" title="(1) ä¸‹è½½ nginx  å¹¶è§£å‹"></a>(1) ä¸‹è½½ nginx  å¹¶è§£å‹</h5><pre class=" language-shell"><code class="language-shell">wget http://nginx.org/download/nginx-1.16.1.tar.gztar xvf nginx-1.16.1.tar.gz</code></pre><h5 id="2-ç¼–è¯‘å®‰è£…å¹¶æ·»åŠ ç¯å¢ƒå˜é‡"><a href="#2-ç¼–è¯‘å®‰è£…å¹¶æ·»åŠ ç¯å¢ƒå˜é‡" class="headerlink" title="(2) ç¼–è¯‘å®‰è£…å¹¶æ·»åŠ ç¯å¢ƒå˜é‡"></a><strong>(2)</strong> ç¼–è¯‘å®‰è£…å¹¶æ·»åŠ ç¯å¢ƒå˜é‡</h5><pre class=" language-shell"><code class="language-shell">cd nginx-1.16.1./configure --prefix=/cyylog/nginx-1.16 --user=nginx --group=nginx --without-select_module --without-poll_module --with-http_ssl_module --with-pcre --with-debugmake make install æ·»åŠ å˜é‡vim /etc/profile è¿½åŠ ä¸€è¡Œexport PATH=$PATH://cyylog/nginx/sbinä¿å­˜é€€å‡ºåˆ·æ–°å˜é‡source /etc/profile</code></pre><h5 id="3-æ›´æ”¹-nginx-çš„å±ä¸»å’Œå±ç»„ä»¥åŠä¿®æ”¹é…ç½®æ–‡ä»¶"><a href="#3-æ›´æ”¹-nginx-çš„å±ä¸»å’Œå±ç»„ä»¥åŠä¿®æ”¹é…ç½®æ–‡ä»¶" class="headerlink" title="(3)æ›´æ”¹ nginx çš„å±ä¸»å’Œå±ç»„ä»¥åŠä¿®æ”¹é…ç½®æ–‡ä»¶"></a><strong>(3)</strong>æ›´æ”¹ nginx çš„å±ä¸»å’Œå±ç»„ä»¥åŠä¿®æ”¹é…ç½®æ–‡ä»¶</h5><pre class=" language-shell"><code class="language-shell">chown nginx:nginx -R /cyylog/nginx-1.16ä¿®æ”¹é…ç½®æ–‡ä»¶vim /cyylog/nginx/conf/nginx.confä¿®æ”¹å¯åŠ¨ç”¨æˆ· user nginx;å¯åŠ¨nginx  nginx</code></pre><h4 id="4-å®‰è£…php"><a href="#4-å®‰è£…php" class="headerlink" title="4:å®‰è£…php"></a>4:å®‰è£…php</h4><h5 id="1-ä¸‹è½½phpæºç å¹¶äº•è¿›è¡Œè§£å‹"><a href="#1-ä¸‹è½½phpæºç å¹¶äº•è¿›è¡Œè§£å‹" class="headerlink" title="(1) ä¸‹è½½phpæºç å¹¶äº•è¿›è¡Œè§£å‹"></a><strong>(1)</strong> <strong>ä¸‹è½½phpæºç å¹¶äº•è¿›è¡Œè§£å‹</strong></h5><pre class=" language-shell"><code class="language-shell">wget https://www.php.net/distributions/php-7.2.27.tar.gztar xvf php-7.2.27.tar.gz</code></pre><p><strong>(2)</strong> <strong>å®‰è£…åŠè§£å†³ä¾èµ–</strong></p><pre class=" language-shell"><code class="language-shell">yum install -y libxml2-devel openssl-devel net-snmp net-snmp-devel libcurl-devel libjpeg-devel libpng-devel libicu-devel openldap-devel bzip2 bzip2-devel freetype-devel gmp-devel readline-devel libxslt-devel fontconfigcd php-7.2.27./configure --prefix=/cyylog/php-7.2 --with-mysqli=/cyylog/mysql/bin/mysql_config --enable-inline-optimization --enable-fpm --enable-soap --enable-pcntl --enable-xml --with-libxml-dir --with-xmlrpc --with-openssl --with-mhash --with-pcre-regex --with-sqlite3 --with-zlib --enable-bcmath --with-iconv --with-bz2 --enable-calendar --with-curl --with-cdb --enable-dom --enable-exif --enable-fileinfo --enable-filter --with-pcre-dir --enable-ftp --with-gd --with-openssl-dir --with-jpeg-dir --with-png-dir --with-freetype-dir --with-gettext --with-gmp --with-mhash --enable-json --enable-mbstring --disable-mbregex --disable-mbregex-backtrack --with-libmbfl --with-onig --enable-pdo --with-pdo-mysql --with-zlib-dir --with-pdo-sqlite --with-readline --enable-session --enable-shmop --enable-simplexml --enable-sockets --enable-sysvmsg --enable-sysvsem --enable-sysvshm --enable-wddx --with-libxml-dir --with-xsl --enable-zip --enable-mysqlnd-compression-support --with-pear --without-pear make make install</code></pre><h5 id="3-æ‹·è´æœåŠ¡å’Œé…ç½®æ–‡ä»¶åŠå±ä¸»å’Œå±ç»„"><a href="#3-æ‹·è´æœåŠ¡å’Œé…ç½®æ–‡ä»¶åŠå±ä¸»å’Œå±ç»„" class="headerlink" title="(3) æ‹·è´æœåŠ¡å’Œé…ç½®æ–‡ä»¶åŠå±ä¸»å’Œå±ç»„"></a><strong>(3)</strong> æ‹·è´æœåŠ¡å’Œé…ç½®æ–‡ä»¶åŠå±ä¸»å’Œå±ç»„</h5><pre class=" language-shell"><code class="language-shell">cp /root/php-7.2.27/sapi/fpm/php-fpm.service /usr/lib/systemd/system/php-fpm.servicecp /cyylog/php-7.2/etc/{php-fpm.conf.default,php-fpm.conf}cp /cyylog/php-7.2/etc/php-fpm.d/www.conf{.default,}cp php.ini-production /cyylog/php-7.2/lib/php.inichown nginx:nginx -R /cyylog/php-7.2</code></pre><p><strong>(4)</strong> <strong>ä¿®æ”¹é…ç½®æ–‡ä»¶å¹¶å¯åŠ¨</strong></p><pre class=" language-shell"><code class="language-shell">#### ä¿®æ”¹php.inié…ç½®æ–‡ä»¶vim /cyylog/php/lib/php.ini ä¿®æ”¹å››è¡Œpost_max_size = 16Mmax_execution_time = 300max_input_time = 300date.timezone = PRC#### å¯åŠ¨phpæœåŠ¡systemctl start php-fpm.service && systemctl enable php-fpm.service#### ä¿®æ”¹nginx.confæ–‡ä»¶æ˜¯nginxæ”¯æŒphpvim /cyylog/nginx/conf/nginx.conf ä¿®æ”¹å¦‚ä¸‹ location ~ \.php$ {            root           /cyylog/nginx/html;            fastcgi_pass   127.0.0.1:9000;            fastcgi_index  index.php;            fastcgi_param  SCRIPT_FILENAME  /cyylog/nginx/html$fastcgi_script_name;            include        fastcgi_params;        }#### ç¼–å†™æµ‹è¯•phpæ–‡ä»¶ vim /cyylog/nginx/html/index.php          <?php phpinfo(); ?>#### é‡å¯nginxæœåŠ¡ nginx -s reload    é‡å¯nginxæœåŠ¡ nginx -s reload</code></pre><h4 id="5-å®‰è£…zabbix"><a href="#5-å®‰è£…zabbix" class="headerlink" title="5:å®‰è£…zabbix"></a>5:å®‰è£…zabbix</h4><h5 id="1-å®‰è£…ä¾èµ–ä»¥åŠç¼–è¯‘å®‰è£…"><a href="#1-å®‰è£…ä¾èµ–ä»¥åŠç¼–è¯‘å®‰è£…" class="headerlink" title="(1) å®‰è£…ä¾èµ–ä»¥åŠç¼–è¯‘å®‰è£…"></a><strong>(1)</strong> å®‰è£…ä¾èµ–ä»¥åŠç¼–è¯‘å®‰è£…</h5><pre class=" language-shell"><code class="language-shell">yum localinstall -y libevent-devel-2.0.21-4.el7.x86_64.rpmyum install unixODBC-devel mysql-devel net-snmp-devel libxml2-devel libcurl-devel libevent-devel -yé…ç½®cd zabbix-4.4.5./configure --prefix=/cyylog/zabbix-4.4 --enable-server --enable-agent --with-mysql=/cyylog/mysql/bin/mysql_config --enable-ipv6 --with-netsnmp --with-libcurl --with-libxml2make make install</code></pre><p>(2) é…ç½®ç¯å¢ƒå˜é‡</p><pre class=" language-shell"><code class="language-shell">vim /etc/profile è¿½åŠ ä¸€è¡Œexport PATH=$PATH://cyylog/zabbix/sbin#### ä¿å­˜é€€å‡º åˆ·æ–° source /etc/profile</code></pre><p>(3) ä¿®æ”¹é…ç½®æ–‡ä»¶</p><pre class=" language-shell"><code class="language-shell">vim /cyylog/zabbix/etc/zabbix_server.conf  ##ä¿®æ”¹å¦‚ä¸‹DBUser=rootDBPassword=beimi123æ‹·è´zabbixè‡³nginxçš„ç›®å½•ä¸‹cp -R frontends/php/* /cyylog/nginx/html/é‡å¯nginxæœåŠ¡  nginx -s reload</code></pre><p>è®¿é—®é¡µé¢okå°±è¡Œ</p><p>æ³¨æ„è¿æ¥æ•°æ®åº“é‚£ä¸ªæ­¥éª¤éœ€è¦å°†æœåŠ¡å™¨ipæ”¹ä¸º127.0.0.1 ä¸èƒ½ä½¿ç”¨localhost</p><p>å¦åˆ™ä¼šæŠ¥é”™</p><p>æ¥ä¸‹ä¼šæœ‰ä¸ªé…ç½®æ–‡ä»¶æ— æ³•å®‰è£…éœ€æ‰‹åŠ¨ä¸‹è½½ä¸‹æ¥ä¼ åˆ°nginç›®å½•ä¸‹</p><p>æœ€åå®Œæˆ</p><p>ç™»å½•è´¦æˆ·ä¸º admin å¯†ç zabbix</p><p>ç™»å½•åç•Œé¢ä¸º</p><p><img src="C:%5CUsers%5CCyy%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20200523132054294.png" alt="image-20200523132054294"></p>]]></content>
      
      
      <categories>
          
          <category> ç›‘æ§ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> zabbix </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>zabbix-é‚®ç®±æŠ¥è­¦è®¾ç½®</title>
      <link href="2019/07/05/jian-kong/zabbix/zabbix-you-jian-bao-jing/"/>
      <url>2019/07/05/jian-kong/zabbix/zabbix-you-jian-bao-jing/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h3 id="Zabbix-é‚®ä»¶æŠ¥è­¦"><a href="#Zabbix-é‚®ä»¶æŠ¥è­¦" class="headerlink" title="Zabbix é‚®ä»¶æŠ¥è­¦"></a>Zabbix é‚®ä»¶æŠ¥è­¦</h3><h4 id="å‰æœŸå‡†å¤‡å·¥ä½œï¼š"><a href="#å‰æœŸå‡†å¤‡å·¥ä½œï¼š" class="headerlink" title="å‰æœŸå‡†å¤‡å·¥ä½œï¼š"></a>å‰æœŸå‡†å¤‡å·¥ä½œï¼š</h4><p>ç”µè„‘ç™»å½•ç½‘æ˜“é‚®ç®±é…ç½®ï¼ŒæŠŠè‡ªå·±çš„æˆæƒç çœ‹ä¸€ä¸‹ï¼Œå¹¶å†™å…¥é…ç½®æ–‡ä»¶</p><h5 id="serverç«¯å®‰è£…é…ç½®é‚®ä»¶æœåŠ¡å™¨"><a href="#serverç«¯å®‰è£…é…ç½®é‚®ä»¶æœåŠ¡å™¨" class="headerlink" title="serverç«¯å®‰è£…é…ç½®é‚®ä»¶æœåŠ¡å™¨"></a><strong>serverç«¯å®‰è£…é…ç½®é‚®ä»¶æœåŠ¡å™¨</strong></h5><pre class=" language-shell"><code class="language-shell">[root@master ~]# yum -y install mailx[root@master ~]# mailx -V12.5 7/5/10</code></pre><h5 id="é…ç½®å…¬ç½‘é‚®ç®±ä¿¡æ¯ï¼šå‘é‚®ä»¶ï¼š"><a href="#é…ç½®å…¬ç½‘é‚®ç®±ä¿¡æ¯ï¼šå‘é‚®ä»¶ï¼š" class="headerlink" title="é…ç½®å…¬ç½‘é‚®ç®±ä¿¡æ¯ï¼šå‘é‚®ä»¶ï¼š"></a><strong>é…ç½®å…¬ç½‘é‚®ç®±ä¿¡æ¯</strong>ï¼šå‘é‚®ä»¶ï¼š</h5><pre class=" language-shell"><code class="language-shell">[root@master ~]#  vim /etc/mail.rc    #è¿½åŠ ä»¥ä¸‹å†…å®¹set from=cyylog@163.com    #ï¼ˆé‚®ç®±åœ°å€ï¼‰ set smtp=smtp.163.com    #smtpæœåŠ¡å™¨ï¼‰ å‘é‚®ä»¶æœåŠ¡å™¨ ---163é»˜è®¤set smtp-auth-user=cyylog@163.com    #(ç”¨æˆ·å) set smtp-auth-password=Password    #ï¼ˆé‚®ç®±å¯†ç ï¼‰æˆæƒä¹‹åçš„å¯†ç set smtp-auth=login            #é»˜è®¤######    æµ‹è¯•[root@master ~]# echo "test mail from zabbix.server.com" |mail -s "test mail" cyylog@163.com</code></pre><h6 id="ç„¶å163é‚®ç®±å°±ä¼šæ”¶åˆ°ä¿¡æ¯"><a href="#ç„¶å163é‚®ç®±å°±ä¼šæ”¶åˆ°ä¿¡æ¯" class="headerlink" title="ç„¶å163é‚®ç®±å°±ä¼šæ”¶åˆ°ä¿¡æ¯"></a>ç„¶å163é‚®ç®±å°±ä¼šæ”¶åˆ°ä¿¡æ¯</h6><p><img src="https://s1.ax1x.com/2020/05/23/Yv2C6g.png" alt="Yv2C6g.png"></p><h4 id="æŠ¥è­¦åª’ä½“çš„é…ç½®"><a href="#æŠ¥è­¦åª’ä½“çš„é…ç½®" class="headerlink" title="æŠ¥è­¦åª’ä½“çš„é…ç½®:"></a>æŠ¥è­¦åª’ä½“çš„é…ç½®:</h4><p>é¦–å…ˆéœ€è¦é…ç½® Zabbix çš„é‚®ä»¶åŠŸèƒ½ã€‚<br>ç‚¹å‡» ç®¡ç†-&gt;æŠ¥è­¦åª’ä»‹ç±»å‹-&gt;åˆ›å»ºåª’ä½“ç±»å‹</p><p><img src="https://s1.ax1x.com/2020/05/23/YvWEWV.png" alt="YvWEWV.png"></p><p><strong>ç„¶ååœ¨é¡µé¢ä¸­å¡«å…¥ä½ çš„æŠ¥è­¦åª’ä»‹ç±»å‹ä¿¡æ¯,ä¾‹å¦‚ä¸‹å›¾æ‰€ç¤º:</strong><br><strong>æ³¨ï¼šè„šæœ¬åç§°ä»»æ„ï¼Œå­˜æ”¾äº<code>/usr/lib/zabbix/alertscripts</code> (ç”Ÿäº§ä¸Šçš„æµ‹è¯•æœæ”¾è¿™ï¼š<code>s /usr/local/zabbix/share/zabbix/alertscriptsï¼‰</code></strong> </p><p>åç§°ï¼šsendmail //åç§°ä»»æ„<br>ç±»å‹ï¼šè„šæœ¬<br>è„šæœ¬åç§°ï¼šsendmail.sh<br>è„šæœ¬å‚æ•°ï¼š //ä¸€å®šè¦å†™ï¼Œå¦åˆ™å¯èƒ½å‘é€ä¸æˆåŠŸ<br>{ALERT.SENDTO} //ç…§å¡«ï¼Œæ”¶ä»¶äººå˜é‡<br>{ALERT.SUBJECT} //ç…§å¡«ï¼Œé‚®ä»¶ä¸»é¢˜å˜é‡ï¼Œå˜é‡å€¼æ¥æºäºâ€˜åŠ¨ä½œâ€™ä¸­çš„â€˜é»˜è®¤æ¥æ”¶äººâ€™<br>{ALERT.MESSAGE} //ç…§å¡«ï¼Œé‚®ä»¶æ­£æ–‡å˜é‡ï¼Œå˜é‡å€¼æ¥æºäºâ€˜åŠ¨ä½œâ€™ä¸­çš„â€˜é»˜è®¤ä¿¡æ¯â€™</p><p><strong>é…ç½®å®Œæˆå,ä¸è¦å¿˜è®°ç‚¹å‡»å­˜æ¡£,ä¿å­˜ä½ çš„é…ç½®ã€‚</strong></p><p><img src="https://s1.ax1x.com/2020/05/23/YvWRmQ.png" alt="YvWRmQ.png"></p><h6 id="ä¿®æ”¹zabbixæœåŠ¡ç«¯é…ç½®æ–‡ä»¶ï¼†ç¼–å†™è„šæœ¬ï¼š"><a href="#ä¿®æ”¹zabbixæœåŠ¡ç«¯é…ç½®æ–‡ä»¶ï¼†ç¼–å†™è„šæœ¬ï¼š" class="headerlink" title="ä¿®æ”¹zabbixæœåŠ¡ç«¯é…ç½®æ–‡ä»¶ï¼†ç¼–å†™è„šæœ¬ï¼š"></a>ä¿®æ”¹zabbixæœåŠ¡ç«¯é…ç½®æ–‡ä»¶ï¼†ç¼–å†™è„šæœ¬ï¼š</h6><pre class=" language-shell"><code class="language-shell"># æŸ¥çœ‹æŒ‡å®šè„šæœ¬çš„å­˜å‚¨è·¯å¾„:[root@master ~]# vim /etc/zabbix/zabbix_server.confAlertScriptsPath=/usr/lib/zabbix/alertscriptsç¼–å†™é‚®ä»¶è„šæœ¬:[root@master alertscripts]# cd /usr/lib/zabbix/alertscripts[root@master alertscripts]# vim sendmail.sh #!/bin/sh #export.UTF-8 -----å­—ç¬¦é›†å¯ä»¥åˆ é™¤æ‰#send mailmessages=echo $3 | tr '\r\n' '\n'subject=echo $2 | tr '\r\n' '\n'echo "${messages}" | mail -s "${subject}" $1 >>/tmp/mailx.log 2>&1ä¿®æ”¹æƒé™ï¼š[root@master alertscripts]# chmod u+x sendmail.sh && chown zabbix.zabbix sendmail.sh</code></pre><p>åˆ›å»ºçš„è„šæœ¬åç§°è¦å’Œå®šä¹‰çš„è„šæœ¬åç§°ä¸€æ ·</p><p><strong>ä¿®æ”¹adminç”¨æˆ·çš„æŠ¥è­¦åª’ä»‹ï¼š</strong><br>ç”¨æˆ·é»˜è®¤æ˜¯æ²¡æœ‰è®¾ç½®æŠ¥è­¦åª’ä»‹çš„ï¼Œè®¾ç½®åå°±å¯ä»¥æ¥æ”¶æŠ¥è­¦æ¶ˆæ¯äº†ã€‚</p><p><img src="https://s1.ax1x.com/2020/05/23/YvIrM6.png" alt="YvIrM6.png"></p><p><img src="https://s1.ax1x.com/2020/05/23/YvoeQx.png" alt="YvoeQx.png"></p><h6 id="è§¦å‘å™¨çš„é…ç½®"><a href="#è§¦å‘å™¨çš„é…ç½®" class="headerlink" title="è§¦å‘å™¨çš„é…ç½®:"></a><strong>è§¦å‘å™¨çš„é…ç½®:</strong></h6><p>æ¥ä¸‹æ¥,ç‚¹å‡»é…ç½®-&gt;ä¸»æœº</p><p>æˆ‘ä»¬ç»™ agent-19 è¿™å°ä¸»æœºå¢åŠ ä¸€ä¸ªè§¦å‘å™¨ã€‚ç‚¹å‡» agent-19 è¿™ä¸€è¡Œä¸­çš„â€œè§¦å‘å™¨â€,ç„¶åå†ç‚¹å‡»åˆ›å»ºè§¦å‘å™¨ã€‚<br>è¯¥é¡µå„é…ç½®é¡¹å«ä¹‰å¦‚ä¸‹:<br>åç§°:å¡«å…¥è§¦å‘å™¨çš„åå­—<br>è¡¨è¾¾å¼:ç”¨äºé…ç½®è§¦å‘å™¨çš„è§¦å‘æ¡ä»¶,ç‚¹å‡»æ·»åŠ æŒ‰é’®æœ‰æ¡ä»¶é€‰é¡¹ã€‚ â€”-é”®å€¼<br>å¤šé‡äº‹ä»¶äº§ç”Ÿ:å¦‚æœé€‰ä¸­,åˆ™é—®é¢˜å¦‚æœæŒç»­å¤šé‡çš„å‘ç”Ÿåˆ™æ¯æ¬¡éƒ½è§¦å‘,å¦åˆ™åªè§¦å‘ä¸€æ¬¡<br>ç‚¹å‡»è¡¨è¾¾å¼å³ä¾§çš„æ·»åŠ æŒ‰é’®:</p><p><img src="https://s1.ax1x.com/2020/05/23/YvT75Q.png" alt="YvT75Q.png"></p><p>å†ç‚¹å‡»é¡¹ç›®å³ä¾§çš„é€‰æ‹©,é€‰æ‹©æˆ‘ä»¬ä¹‹å‰é…ç½®è¿‡çš„â€œweb.server.online.monitorâ€,å¹¶è®¾ç½®è§¦å‘çš„é˜€å€¼,å¦‚ä¸‹å›¾æ‰€ç¤º</p><p><img src="https://s1.ax1x.com/2020/05/23/YvTL2n.png" alt="YvTL2n.png"></p><p>Zabbix ä¼šè‡ªåŠ¨ç”Ÿæˆè¡¨è¾¾å¼ã€‚æ¥ä¸‹æ¥æ ¹æ®æƒ…å†µé€‰æ‹©äº‹ä»¶çš„ä¸¥é‡æ€§ã€‚é…ç½®å®Œæ¯•å,ç‚¹å‡»å­˜æ¡£ä¿å­˜ã€‚</p><p><img src="https://s1.ax1x.com/2020/05/23/YvTxbT.png" alt="YvTxbT.png"></p><p><strong>åŠ¨ä½œçš„é…ç½®</strong>:<br>ç‚¹å‡»:é…ç½®-&gt;åŠ¨ä½œ-&gt;äº‹ä»¶æºä¸‹æ‹‰èœå•ä¸­é€‰æ‹©è§¦å‘å™¨-&gt;åˆ›å»ºåŠ¨ä½œ<br>å¯ä»¥åœ¨å†…å®¹ä¸­ä½¿ç”¨ Zabbix å†…ç½®å®,é‚®ä»¶å‘å‡ºæ—¶ä¼šè‡ªåŠ¨å°†å®æ›¿æ¢æˆå¯¹åº”çš„å€¼ã€‚ </p><p>åç§°ï¼š<br>ä»»æ„å†™</p><p>é»˜è®¤æ¥æ”¶äººï¼š</p><pre><code>æ•…éšœçº§åˆ«ï¼š{TRIGGER.STATUS}ã€‚æœåŠ¡å™¨ï¼šã€{HOSTNAME1} ã€‘ å‘ç”Ÿï¼š{TRIGGER.NAME} æ•…éšœï¼ æ³¨ï¼šé»˜è®¤æ¥æ”¶äººï¼šç›¸å½“äºé‚®ä»¶çš„ä¸»é¢˜é»˜è®¤ä¿¡æ¯ï¼šé‚®ä»¶çš„ä¸»é¢˜å‘Šè­¦ä¸»æœºï¼š{HOSTNAME1} å‘Šè­¦æ—¶é—´ï¼š{EVENT.DATE} {EVENT.TIME}å‘Šè­¦ç­‰çº§ï¼š{TRIGGER.SEVERITY} å‘Šè­¦ä¿¡æ¯ï¼š{TRIGGER.NAME}å‘Šè­¦é¡¹ç›®ï¼š{TRIGGER.KEY1} é—®é¢˜è¯¦æƒ…ï¼š{ITEM.NAME}ï¼š{ITEM.VALUE}å½“å‰çŠ¶æ€ï¼š{TRIGGER.STATUS}ï¼š{ITEM.VALUE1} äº‹ä»¶IDï¼š{EVENT.ID}</code></pre><p>æ¢å¤é‚®ä»¶ï¼š<br>æ¢å¤ä¸»é¢˜ï¼š</p><pre><code>æœåŠ¡å™¨ï¼šã€{HOSTNAME1}ã€‘æ•…éšœå·²æ¢å¤ã€‚æ•…éšœåŸå› ï¼š{TRIGGER.NAME} æ¢å¤ä¿¡æ¯ï¼šæ¢å¤é‚®ä»¶çš„æ­£æ–‡ã€‚å½“æ•…éšœæ¢å¤æ­£å¸¸åä¹Ÿå‘é‚®ä»¶é€šçŸ¥ä¸€ä¸‹ã€‚ </code></pre><p><img src="https://s1.ax1x.com/2020/05/23/Yv7iG9.png" alt="Yv7iG9.png"></p><p>ç‚¹å‡»:æ“ä½œ-&gt;ç¼–è¾‘ï¼š</p><p><img src="https://s1.ax1x.com/2020/05/23/Yv7kx1.png" alt="Yv7kx1.png"></p><p>å‘é€é—´éš”ï¼š60ç§’<br>æ­¥éª¤ï¼šå‘é€10æ¬¡å‘é€åˆ°ï¼šadminç”¨æˆ·<br>ä»…ä½¿ç”¨ï¼šsendmailæ–¹å¼å‘é€ â€”-è„šæœ¬ã€‚ æ–¹å¼å¯ä»¥è‡ªè¡Œè®¾ç½®ï¼Œæ ¹æ®å®é™…å·¥ä½œè¦æ±‚</p><p><img src="https://s1.ax1x.com/2020/05/23/Yv7QGd.png" alt="Yv7QGd.png"></p><p>éœ€è¦ç‰¹åˆ«è§£é‡Šä¸€ä¸‹çš„æ˜¯â€œæ­¥éª¤â€éƒ¨åˆ†çš„é…ç½®ã€‚æ‰€è°“æ­¥éª¤æ˜¯æŒ‡æŠ¥è­¦å¯ä»¥æœ‰å¤šä¸ªæ­¥éª¤,åšä¸åŒçš„æŠ¥è­¦ã€‚ä¾‹å¦‚,è‡ªä» 1 åˆ° 3,å°±æ˜¯æŒ‡æŠ¥è­¦çš„æ­¥éª¤æœ‰ä¸‰ä¸ªã€‚æ­¥éª¤æŒç»­æ—¶é—´å°±æ˜¯ä¸€å®šæ—¶é—´åå¦‚æœç›‘æ§äººå‘˜ä»æœªå“åº”æŠ¥è­¦å°±è¿›å…¥ä¸‹ä¸€ä¸ªæŠ¥è­¦æ­¥éª¤ã€‚<br>ä¾‹å¦‚,å‘é‚®ä»¶ç»™ä½ æŠ¥è­¦,å¦‚æœ60 ç§’åä½ æ²¡å“åº”,é‚£å°±å‘ jabber ä¿¡æ¯æé†’ä½ ã€‚å¦‚æœ 60 ç§’åè¿˜æ²¡å“åº”,é‚£å°±å‘çŸ­ä¿¡ç»™ä½ ã€‚è¦æ˜¯è¿˜æ²¡å“åº”,å°±æ²¡æœ‰ç„¶åäº†ã€‚ä½ å¯ä»¥å½¢è±¡çš„æŠŠå®ƒç†è§£ä¸º Zabbix çš„ä¸€å“­äºŒé—¹ä¸‰ä¸ŠåŠã€‚<br>åˆ°æ­¤,ä¸€ä¸ªé‚®ä»¶æŠ¥è­¦åŠŸèƒ½å°±é…ç½®å®Œæ¯•äº†ã€‚å¦‚æœä½ æƒ³ç«‹å³çœ‹åˆ°ç»“æœ,å¯ä»¥ä¿®æ”¹è§¦å‘å™¨çš„æ¡ä»¶,å°†æ¡ä»¶çš„é˜€å€¼è®¾ç½®ä¸º N&gt;0.0003ã€‚ä½ é©¬ä¸Šå°±ä¼šæ”¶åˆ° Zabbix å‘æ¥çš„æŠ¥è­¦é‚®ä»¶äº†ã€‚</p><h4 id="è¡¥å……ï¼šé‚®ä»¶ç¾åŒ–"><a href="#è¡¥å……ï¼šé‚®ä»¶ç¾åŒ–" class="headerlink" title="è¡¥å……ï¼šé‚®ä»¶ç¾åŒ–"></a>è¡¥å……ï¼šé‚®ä»¶ç¾åŒ–</h4><p>ï¼ˆä¿®æ”¹é»˜è®¤ä¿¡æ¯ï¼‰</p><pre class=" language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>table</span> <span class="token attr-name">border</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span>  <span class="token attr-name">bordercolor</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>black<span class="token punctuation">"</span></span> <span class="token attr-name">cellspacing</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>0px<span class="token punctuation">"</span></span> <span class="token attr-name">cellpadding</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>4px<span class="token punctuation">"</span></span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span> <span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">></span></span>å‘Šè­¦ä¸»æœº<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span> <span class="token attr-name">bgcolor</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>#FF3333<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>{HOSTNAME1}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">></span></span>å‘Šè­¦æ—¶é—´<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">></span></span>{EVENT.DATE} {EVENT.TIME}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">></span></span>å‘Šè­¦ç­‰çº§<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">></span></span>{TRIGGER.SEVERITY}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">></span></span>å‘Šè­¦ä¿¡æ¯<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">></span></span>{TRIGGER.NAME}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">></span></span>å‘Šè­¦é¡¹ç›®<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">></span></span>{TRIGGER.KEY1}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span> <span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">></span></span>é—®é¢˜è¯¦æƒ…<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span> <span class="token attr-name">bgcolor</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>#FF3333<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>{ITEM.NAME}:<span class="token entity" title="&nbsp;">&amp;nbsp;</span>{ITEM.VALUE}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">></span></span>å½“å‰çŠ¶æ€<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">></span></span>{TRIGGER.STATUS}:<span class="token entity" title="&nbsp;">&amp;nbsp;</span>{ITEM.VALUE1}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">></span></span>äº‹ä»¶ID<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">></span></span>{EVENT.ID}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>table</span><span class="token punctuation">></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> ç›‘æ§ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> zabbix </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MySQLéƒ¨ç½²ä¹‹æºç å®‰è£…</title>
      <link href="2019/05/27/sql/mysql-bu-shu-zhi-yuan-ma-an-zhuang/"/>
      <url>2019/05/27/sql/mysql-bu-shu-zhi-yuan-ma-an-zhuang/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h4 id="æ‰€éœ€è¦çš„ä¾èµ–åŠå®‰è£…MySQLçš„åŒ…"><a href="#æ‰€éœ€è¦çš„ä¾èµ–åŠå®‰è£…MySQLçš„åŒ…" class="headerlink" title="æ‰€éœ€è¦çš„ä¾èµ–åŠå®‰è£…MySQLçš„åŒ…"></a>æ‰€éœ€è¦çš„ä¾èµ–åŠå®‰è£…MySQLçš„åŒ…</h4><pre class=" language-shell"><code class="language-shell"># yum -y update# yum -y groupinstall "Development Tools"# yum -y install gcc gcc-c++ ncurses ncurses-devel bison libgcrypt perl make cmake# wget https://dev.mysql.com/get/Downloads/MySQL-5.7/mysql-boost-5.7.24.tar.gz</code></pre><h4 id="åœ¨ç³»ç»Ÿä¸­æ·»åŠ è¿è¡Œmysqldè¿›ç¨‹çš„ç”¨æˆ·mysql"><a href="#åœ¨ç³»ç»Ÿä¸­æ·»åŠ è¿è¡Œmysqldè¿›ç¨‹çš„ç”¨æˆ·mysql" class="headerlink" title="åœ¨ç³»ç»Ÿä¸­æ·»åŠ è¿è¡Œmysqldè¿›ç¨‹çš„ç”¨æˆ·mysql"></a>åœ¨ç³»ç»Ÿä¸­æ·»åŠ è¿è¡Œmysqldè¿›ç¨‹çš„ç”¨æˆ·mysql</h4><pre class=" language-shell"><code class="language-shell">[root@mysql_source ~]# groupadd mysql[root@mysql_source ~]# useradd -M -g mysql -s /sbin/nologin mysql</code></pre><h4 id="åœ¨ç³»ç»Ÿä¸­æ·»åŠ è‡ªå®šä¹‰MySQLæ•°æ®åº“ç›®å½•åŠå…¶ä»–å¿…è¦ç›®å½•"><a href="#åœ¨ç³»ç»Ÿä¸­æ·»åŠ è‡ªå®šä¹‰MySQLæ•°æ®åº“ç›®å½•åŠå…¶ä»–å¿…è¦ç›®å½•" class="headerlink" title="åœ¨ç³»ç»Ÿä¸­æ·»åŠ è‡ªå®šä¹‰MySQLæ•°æ®åº“ç›®å½•åŠå…¶ä»–å¿…è¦ç›®å½•"></a>åœ¨ç³»ç»Ÿä¸­æ·»åŠ è‡ªå®šä¹‰MySQLæ•°æ®åº“ç›®å½•åŠå…¶ä»–å¿…è¦ç›®å½•</h4><pre class=" language-shell"><code class="language-shell">[root@mysql_source ~]# mkdir -p /usr/local/mysqld/{data,mysql,log,tmp}[root@mysql_source ~]# chown -R mysql:mysql /usr/local/mysqld/*</code></pre><h4 id="å°†mysql-boost-5-7-24-tar-gzè§£å‹åˆ°å½“å‰ç›®å½•-å¹¶æ‰§è¡Œéƒ¨ç½²æ“ä½œ"><a href="#å°†mysql-boost-5-7-24-tar-gzè§£å‹åˆ°å½“å‰ç›®å½•-å¹¶æ‰§è¡Œéƒ¨ç½²æ“ä½œ" class="headerlink" title="å°†mysql-boost-5.7.24.tar.gzè§£å‹åˆ°å½“å‰ç›®å½•,å¹¶æ‰§è¡Œéƒ¨ç½²æ“ä½œ"></a>å°†mysql-boost-5.7.24.tar.gzè§£å‹åˆ°å½“å‰ç›®å½•,å¹¶æ‰§è¡Œéƒ¨ç½²æ“ä½œ</h4><pre class=" language-shell"><code class="language-shell">[root@mysql_source ~]# tar xf mysql-boost-5.7.24.tar.gz[root@mysql_source ~]# cd mysql-5.7.24[root@mysql_source mysql-5.7.24]# $ cmake . -DCMAKE_INSTALL_PREFIX=/usr/local/mysqld/mysql \-DMYSQL_DATADIR=/usr/local/mysqld/data \-DWITH_BOOST=/root/mysql-5.7.24/boost \-DDEFAULT_CHARSET=utf8......-- Configuring done-- Generating done-- Build files have been written to: /root/mysql-5.7.24[root@mysql_source mysql-5.7.24]# echo $?0[root@mysql_source mysql-5.7.24]# make -j `lscpu | awk 'NR==4{ print $2 }'`......[100%] Built target udf_example[root@mysql_source mysql-5.7.24]# echo $?0[root@mysql_source mysql-5.7.24]# make install......-- Installing: /usr/local/mysqld/mysql/support-files/mysql.server[root@mysql_source mysql-5.7.24]# echo $?0[root@mysql_source mysql-5.7.24]#Congratulations Complete!</code></pre><h4 id="åˆå§‹åŒ–MySQLå®‰è£…é…ç½®"><a href="#åˆå§‹åŒ–MySQLå®‰è£…é…ç½®" class="headerlink" title="åˆå§‹åŒ–MySQLå®‰è£…é…ç½®"></a>åˆå§‹åŒ–MySQLå®‰è£…é…ç½®</h4><h5 id="1-æå‡MySQLå‘½ä»¤ä¸ºç³»ç»Ÿçº§åˆ«å‘½ä»¤"><a href="#1-æå‡MySQLå‘½ä»¤ä¸ºç³»ç»Ÿçº§åˆ«å‘½ä»¤" class="headerlink" title="1.æå‡MySQLå‘½ä»¤ä¸ºç³»ç»Ÿçº§åˆ«å‘½ä»¤"></a>1.æå‡MySQLå‘½ä»¤ä¸ºç³»ç»Ÿçº§åˆ«å‘½ä»¤</h5><pre class=" language-shell"><code class="language-shell">[root@mysql_source ~]# echo "export PATH=$PATH:/usr/local/mysqld/mysql/bin" >>/etc/profile[root@mysql_source ~]# source /etc/profile</code></pre><h5 id="2-æ‹·è´é»˜è®¤é…ç½®æ–‡ä»¶è‡³-etc-my-cnfä¸­"><a href="#2-æ‹·è´é»˜è®¤é…ç½®æ–‡ä»¶è‡³-etc-my-cnfä¸­" class="headerlink" title="2.æ‹·è´é»˜è®¤é…ç½®æ–‡ä»¶è‡³/etc/my.cnfä¸­"></a>2.æ‹·è´é»˜è®¤é…ç½®æ–‡ä»¶è‡³/etc/my.cnfä¸­</h5><pre class=" language-shell"><code class="language-shell">[root@mysql_source mysql]# chown -R mysql.mysql /usr/local/mysqld/*[root@mysql_source ~]# cd /usr/local/mysqld/mysql/mysql-test/include[root@mysql_source include]# cp /etc/{my.cnf,my.cnf.bak}[root@mysql_source include]# cp default_mysqld.cnf /etc/my.cnfcpï¼šæ˜¯å¦è¦†ç›–"/etc/my.cnf"ï¼Ÿ y[root@mysql_source include]# vim /etc/my.cnf[mysqld]basedir = /usr/local/mysqld/mysqldatadir = /usr/local/mysqld/datatmpdir = /usr/local/mysqld/tmpsocket = /usr/local/mysqld/tmp/mysql.sockpid_file = /usr/local/mysqld/tmp/mysqld.pidlog_error = /usr/local/mysqld/log/mysql_error.logslow_query_log_file = /usr/local/mysqld/log/slow_warn.logserver_id = 11user = mysqlport = 3306bind-address = 0.0.0.0character-set-server = utf8default_storage_engine = InnoDB</code></pre><h5 id="3-æ‰§è¡Œæ•°æ®åº“æœåŠ¡åˆå§‹åŒ–æ“ä½œ"><a href="#3-æ‰§è¡Œæ•°æ®åº“æœåŠ¡åˆå§‹åŒ–æ“ä½œ" class="headerlink" title="3.æ‰§è¡Œæ•°æ®åº“æœåŠ¡åˆå§‹åŒ–æ“ä½œ"></a>3.æ‰§è¡Œæ•°æ®åº“æœåŠ¡åˆå§‹åŒ–æ“ä½œ</h5><pre class=" language-shell"><code class="language-shell">[root@mysql_source mysql]# mysqld --defaults-file=/etc/my.cnf --initialize --user='mysql'[root@mysql_source mysql]#</code></pre><h5 id="4-å¯åŠ¨mysqldæœåŠ¡"><a href="#4-å¯åŠ¨mysqldæœåŠ¡" class="headerlink" title="4.å¯åŠ¨mysqldæœåŠ¡"></a>4.å¯åŠ¨mysqldæœåŠ¡</h5><pre class=" language-shell"><code class="language-shell">[root@mysql_source mysql]# mysqld_safe --defaults-file=/etc/my.cnf &[1] 257052018-12-28T09:19:35.334751Z mysqld_safe Logging to '/usr/local/mysqld/log/mysql_error.log'.2018-12-28T09:19:35.379829Z mysqld_safe Starting mysqld daemon with databases from /usr/local/mysqld/data</code></pre><h5 id="5-è®¾ç½®mysql-socketè½¯é“¾æ¥åˆ°mysqlå‘½ä»¤æŒ‡å®šçš„ç›®å½•ä¸­"><a href="#5-è®¾ç½®mysql-socketè½¯é“¾æ¥åˆ°mysqlå‘½ä»¤æŒ‡å®šçš„ç›®å½•ä¸­" class="headerlink" title="5.è®¾ç½®mysql.socketè½¯é“¾æ¥åˆ°mysqlå‘½ä»¤æŒ‡å®šçš„ç›®å½•ä¸­"></a>5.è®¾ç½®mysql.socketè½¯é“¾æ¥åˆ°mysqlå‘½ä»¤æŒ‡å®šçš„ç›®å½•ä¸­</h5><pre class=" language-shell"><code class="language-shell">[root@mysql_source ï½]# ln -s /usr/local/mysqld/tmp/mysql.sock /tmp/mysql.sock</code></pre><p>6.é…ç½®mysqldæœåŠ¡çš„ç®¡ç†å·¥å…·</p><pre class=" language-shell"><code class="language-shell">[root@mysql_source support-files]# cd /usr/local/mysqld/mysql/support-files[root@mysql_source support-files]# cp mysql.server /etc/init.d/mysqld[root@mysql_source support-files]# chkconfig --add mysqld[root@mysql_source support-files]# chkconfig mysqld on</code></pre><h4 id="ç™»å½•æ•°æ®åº“å¹¶è¿›è¡Œæ›´æ”¹å¯†ç "><a href="#ç™»å½•æ•°æ®åº“å¹¶è¿›è¡Œæ›´æ”¹å¯†ç " class="headerlink" title="ç™»å½•æ•°æ®åº“å¹¶è¿›è¡Œæ›´æ”¹å¯†ç "></a>ç™»å½•æ•°æ®åº“å¹¶è¿›è¡Œæ›´æ”¹å¯†ç </h4><pre class=" language-shell"><code class="language-shell">[root@mysql_source mysql]# grep "password" /usr/local/mysqld/log/mysql_error.log2018-12-28T09:18:34.214401Z 1 [Note] A temporary password is generated for root@localhost: ejhszb2:m3wJ[root@mysql_source tmp]# mysql -uroot -p"ejhszb2:m3wJ"mysql: [Warning] Using a password on the command line interface can be insecure.Welcome to the MySQL monitor.  Commands end with ; or \g.Your MySQL connection id is 2Server version: 5.7.24-logCopyright (c) 2000, 2018, Oracle and/or its affiliates. All rights reserved.Oracle is a registered trademark of Oracle Corporation and/or itsaffiliates. Other names may be trademarks of their respectiveowners.Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.mysql> alter user 'root'@'localhost' identified by "(Cyylog..1228)";å¹³å¸¸ä¸­å¸¸ç”¨çš„MySQLéƒ¨ç½²å‚æ•°:<å‚è€ƒä½¿ç”¨>    -DCMAKE_INSTALL_PREFIX=/usr/local/mysqld/mysql \    -DMYSQL_DATADIR=/usr/local/mysqld/data \    -DDOWNLOAD_BOOST=1 \    -DWITH_BOOST=/root/mysql-5.7.24/boost \    -DSYSCONFDIR=/etc \    -DWITH_INNOBASE_STORAGE_ENGINE=1 \    -DWITH_PARTITION_STORAGE_ENGINE=1 \    -DWITH_FEDERATED_STORAGE_ENGINE=1 \    -DWITH_BLACKHOLE_STORAGE_ENGINE=1 \    -DWITH_MYISAM_STORAGE_ENGINE=1 \    -DENABLED_LOCAL_INFILE=1 \    -DENABLE_DTRACE=0 \    -DDEFAULT_CHARSET=utf8 \    -DDEFAULT_COLLATION=utf8_general_ci \    -DWITH_EMBEDDED_SERVER=1</code></pre><h4 id="ç»•è¿‡éªŒè¯å¯†ç ç™»å½•-ä¿®æ”¹å¯†ç "><a href="#ç»•è¿‡éªŒè¯å¯†ç ç™»å½•-ä¿®æ”¹å¯†ç " class="headerlink" title="ç»•è¿‡éªŒè¯å¯†ç ç™»å½• ä¿®æ”¹å¯†ç "></a>ç»•è¿‡éªŒè¯å¯†ç ç™»å½• ä¿®æ”¹å¯†ç </h4><pre class=" language-shell"><code class="language-shell">[root@mysql ~]# vim /etc/my.cnf[mysqld]skip-grant-tables=1[root@mysql ~]# systemctl restart mysqld[root@mysql ~]# mysql -urootWelcome to the MySQL monitor.  Commands end with ; or \g.Your MySQL connection id is 2Server version: 5.7.24 MySQL Community Server (GPL)Copyright (c) 2000, 2018, Oracle and/or its affiliates. All rights reserved.Oracle is a registered trademark of Oracle Corporation and/or itsaffiliates. Other names may be trademarks of their respectiveowners.Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.mysql> alter user 'root'@'localhost' identified by "(Cyylog..1229)";ERROR 1290 (HY000): The MySQL server is running with the --skip-grant-tables option so it cannot execute this statementmysql> show databases;+--------------------+| Database           |+--------------------+| information_schema || mysql              || performance_schema || sys                |+--------------------+4 rows in set (0.00 sec)mysql> use mysql;Reading table information for completion of table and column namesYou can turn off this feature to get a quicker startup with -ADatabase changedmysql> show tables;..................| user                      |+---------------------------+31 rows in set (0.00 sec)mysql> select User,Host,authentication_string from user;+---------------+-----------+-------------------------------------------+| User          | Host      | authentication_string                     |+---------------+-----------+-------------------------------------------+| root          | localhost | *C4571A0C807D96143700250EC4BA41780025A97F || mysql.session | localhost | *THISISNOTAVALIDPASSWORDTHATCANBEUSEDHERE || mysql.sys     | localhost | *THISISNOTAVALIDPASSWORDTHATCANBEUSEDHERE |+---------------+-----------+-------------------------------------------+3 rows in set (0.00 sec)mysql> update user set authentication_string=password('(Cyylog@@1229)') where user='root';Query OK, 1 row affected, 1 warning (0.00 sec)Rows matched: 1  Changed: 1  Warnings: 1[root@mysql ~]# vim /etc/my.cnf[mysqld]#skip-grant-tables=1[root@mysql ~]# systemctl restart mysqld[root@mysql ~]# mysql -uroot -p"(Cyylog@@1229)"mysql: [Warning] Using a password on the command line interface can be insecure.Welcome to the MySQL monitor.  Commands end with ; or \g.Your MySQL connection id is 2Server version: 5.7.24 MySQL Community Server (GPL)Copyright (c) 2000, 2018, Oracle and/or its affiliates. All rights reserved.Oracle is a registered trademark of Oracle Corporation and/or itsaffiliates. Other names may be trademarks of their respectiveowners.Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.mysql></code></pre>]]></content>
      
      
      <categories>
          
          <category> SQL </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MySQL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Nginxå¹³æ»‘å‡çº§</title>
      <link href="2019/04/27/linux/nginx/nginx-ping-hua-sheng-ji/"/>
      <url>2019/04/27/linux/nginx/nginx-ping-hua-sheng-ji/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h5 id="Nginx-å¹³æ»‘å‡çº§"><a href="#Nginx-å¹³æ»‘å‡çº§" class="headerlink" title="Nginx å¹³æ»‘å‡çº§"></a>Nginx å¹³æ»‘å‡çº§</h5><h6 id="1ã€æŸ¥çœ‹ç°æœ‰çš„-nginx-ç¼–è¯‘å‚æ•°"><a href="#1ã€æŸ¥çœ‹ç°æœ‰çš„-nginx-ç¼–è¯‘å‚æ•°" class="headerlink" title="1ã€æŸ¥çœ‹ç°æœ‰çš„ nginx ç¼–è¯‘å‚æ•°"></a>1ã€æŸ¥çœ‹ç°æœ‰çš„ nginx ç¼–è¯‘å‚æ•°</h6><pre class=" language-shell"><code class="language-shell">[root@web ~]#/usr/local/nginx/sbin/nginx -V</code></pre><p>æŒ‰ç…§åŸæ¥çš„ç¼–è¯‘å‚æ•°å®‰è£… nginx çš„æ–¹æ³•è¿›è¡Œå®‰è£…ï¼Œ<strong>åªéœ€è¦åˆ° makeï¼Œåƒä¸‡ä¸è¦ make install</strong></p><h6 id="2ã€ç¼–è¯‘æ–°çš„-nginx-æºç åŒ…"><a href="#2ã€ç¼–è¯‘æ–°çš„-nginx-æºç åŒ…" class="headerlink" title="2ã€ç¼–è¯‘æ–°çš„ nginx æºç åŒ…"></a>2ã€ç¼–è¯‘æ–°çš„ nginx æºç åŒ…</h6><p>ç¼–è¯‘æ–°Nginxæºç ï¼Œå®‰è£…è·¯å¾„éœ€ä¸æ—§ç‰ˆä¸€è‡´ (è¯¦ç»†è¿‡ç¨‹å¯å‚è§ï¼šNginxç¼–è¯‘å®‰è£…ä¸é…ç½®ä½¿ç”¨)</p><pre class=" language-shell"><code class="language-shell">[root@web ~]#./configure --prefix=/usr/local/nginx-1.14.0 --user=www --group=www --with-http_ssl_module --with-openssl=/path/to/openssl_src[root@web ~]#make</code></pre><h6 id="3ã€å¤‡ä»½åŸ-nginx-äºŒè¿›åˆ¶æ–‡ä»¶"><a href="#3ã€å¤‡ä»½åŸ-nginx-äºŒè¿›åˆ¶æ–‡ä»¶" class="headerlink" title="3ã€å¤‡ä»½åŸ nginx äºŒè¿›åˆ¶æ–‡ä»¶"></a>3ã€å¤‡ä»½åŸ nginx äºŒè¿›åˆ¶æ–‡ä»¶</h6><p>å¤‡ä»½äºŒè¿›åˆ¶æ–‡ä»¶å’Œ nginx çš„é…ç½®æ–‡ä»¶ï¼ˆæœŸé—´nginxä¸ä¼šåœæ­¢æœåŠ¡ï¼‰</p><pre class=" language-shell"><code class="language-shell">[root@web ~]#mv /usr/local/nginx/sbin/nginx /usr/local/nginx/sbin/nginx_$(date +%F)</code></pre><p>4ã€å¤åˆ¶æ–°çš„nginxäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œè¿›å…¥æ–°çš„nginxæºç åŒ…</p><pre class=" language-shell"><code class="language-shell">[root@web ~]#cp /usr/local/nginx-1.14.0/objs/nginx /usr/local/nginx/sbin/</code></pre><p>5ã€æµ‹è¯•æ–°ç‰ˆæœ¬çš„nginxæ˜¯å¦æ­£å¸¸</p><pre class=" language-shell"><code class="language-shell">[root@web ~]#/usr/local/nginx/sbin/nginx -t</code></pre><p>6ã€ç»™nginxå‘é€å¹³æ»‘è¿ç§»ä¿¡å·ï¼ˆè‹¥ä¸æ¸…æ¥špidè·¯å¾„ï¼Œè¯·æŸ¥çœ‹nginxé…ç½®æ–‡ä»¶ï¼‰</p><pre class=" language-shell"><code class="language-shell">[root@web ~]#kill -USR2 cat /var/run/nginx.pid</code></pre><p>7ã€æŸ¥çœ‹nginx pidï¼Œä¼šå‡ºç°ä¸€ä¸ªnginx.pid.oldbin</p><pre class=" language-shell"><code class="language-shell">[root@web ~]#ll /var/run/nginx.pid*</code></pre><p>8ã€ä»å®¹å…³é—­æ—§çš„Nginxè¿›ç¨‹</p><pre class=" language-shell"><code class="language-shell">[root@web ~]#kill -WINCH cat /var/run/nginx.pid.oldbin</code></pre><p>9ã€æ­¤æ—¶ä¸é‡è½½é…ç½®å¯åŠ¨æ—§çš„å·¥ä½œè¿›ç¨‹</p><pre class=" language-shell"><code class="language-shell">[root@web ~]#kill -HUP cat /var/run/nginx.pid.oldbin</code></pre><p>10ã€ç»“æŸå·¥ä½œè¿›ç¨‹ï¼Œå®Œæˆæ­¤æ¬¡å‡çº§</p><pre class=" language-shell"><code class="language-shell">[root@web ~]#kill -QUIT cat /var/run/nginx.pid.oldbin</code></pre><p>11ã€éªŒè¯Nginxæ˜¯å¦å‡çº§æˆåŠŸ</p><pre class=" language-shell"><code class="language-shell">[root@web ~]#usr/local/nginx/sbin/nginx -V</code></pre><h5 id="å‡çº§å®æˆ˜"><a href="#å‡çº§å®æˆ˜" class="headerlink" title="å‡çº§å®æˆ˜"></a>å‡çº§å®æˆ˜</h5><h6 id="1ã€å®‰è£…é…ç½®1-6ç‰ˆæœ¬çš„-nginx"><a href="#1ã€å®‰è£…é…ç½®1-6ç‰ˆæœ¬çš„-nginx" class="headerlink" title="1ã€å®‰è£…é…ç½®1.6ç‰ˆæœ¬çš„ nginx"></a>1ã€å®‰è£…é…ç½®1.6ç‰ˆæœ¬çš„ nginx</h6><pre class=" language-shell"><code class="language-shell">[root@web ~]# yum install -y gcc gcc-c++ pcre-devel openssl-devel zlib-devel[root@web ~]# tar zxvf nginx-1.6.0.tar.gz -C /usr/src/[root@web ~]# cd /usr/src/nginx-1.6.0/[root@web nginx-1.6.0]# ./configure --prefix=/usr/local/nginx --user=nginx --group=nginx --with-http_stub_status_module[root@web nginx-1.6.0]# make [root@web nginx-1.6.0]# make install[root@web nginx-1.6.0]# ln -s /usr/local/nginx/sbin/* /usr/sbin/[root@web nginx-1.6.0]# useradd -M -s /sbin/nologin nginx [root@web nginx-1.6.0]# nginx [root@web nginx-1.6.0]# netstat -anput | grep nginx tcp 0 0 0.0.0.0:80 0.0.0.0:* LISTEN 19008/nginx: master</code></pre><h6 id="2ã€æŸ¥çœ‹-nginx-ç‰ˆæœ¬"><a href="#2ã€æŸ¥çœ‹-nginx-ç‰ˆæœ¬" class="headerlink" title="2ã€æŸ¥çœ‹ nginx ç‰ˆæœ¬"></a>2ã€æŸ¥çœ‹ nginx ç‰ˆæœ¬</h6><pre class=" language-shell"><code class="language-shell">[root@web nginx-1.6.0]# nginx -vnginx version: nginx/1.6.0</code></pre><h6 id="3ã€æŸ¥çœ‹-nginx-ç°æœ‰å®‰è£…çš„æ¨¡å—"><a href="#3ã€æŸ¥çœ‹-nginx-ç°æœ‰å®‰è£…çš„æ¨¡å—" class="headerlink" title="3ã€æŸ¥çœ‹ nginx ç°æœ‰å®‰è£…çš„æ¨¡å—"></a>3ã€æŸ¥çœ‹ nginx ç°æœ‰å®‰è£…çš„æ¨¡å—</h6><pre class=" language-shell"><code class="language-shell">[root@web nginx-1.6.0]# nginx -Vnginx version: nginx/1.6.0built by gcc 4.8.5 20150623 (Red Hat 4.8.5-11) (GCC) configure arguments: --prefix=/usr/local/nginx --user=nginx --group=nginx --with-http_stub_status_module</code></pre><h6 id="4ã€è®¿é—®éªŒè¯"><a href="#4ã€è®¿é—®éªŒè¯" class="headerlink" title="4ã€è®¿é—®éªŒè¯"></a>4ã€è®¿é—®éªŒè¯</h6><pre class=" language-shell"><code class="language-shell">[root@web nginx-1.6.0]# echo "nginx1.6.0" > /usr/local/nginx/html/index.html[root@web nginx-1.6.0]# elinks 192.168.20.167</code></pre><p><a href="https://imgchr.com/i/GFh7KH" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2020/03/28/GFh7KH.md.png" alt="GFh7KH.md.png"></a></p><h6 id="5ã€å‡çº§-nginx"><a href="#5ã€å‡çº§-nginx" class="headerlink" title="5ã€å‡çº§ nginx"></a>5ã€å‡çº§ nginx</h6><p>å°† nginx ç‰ˆæœ¬è¿›è¡Œå‡çº§ å¹¶åœ¨ä¸å½±å“ä¸šåŠ¡çš„æƒ…å†µä¸‹æ·»åŠ  SSL å’Œ pcre æ¨¡å—</p><pre class=" language-shell"><code class="language-shell">[root@web ~]# tar zxvf nginx-1.11.2.tar.gz -C /usr/src/[root@web ~]# cd /usr/src/nginx-1.11.2/[root@web nginx-1.11.2]# ./configure --prefix=/usr/local/nginx --user=nginx --group=ngiinx --with-http_stub_status_module --with-http_ssl_module --with-pcre[root@web nginx-1.11.2]# make[root@web nginx-1.11.2]# cd[root@web ~]# mv /usr/local/nginx/sbin/nginx /usr/local/nginx/sbin/nginx_old [root@web ~]# cp /usr/src/nginx-1.11.2/objs/nginx /usr/local/nginx/sbin/[root@web ~]# mv /usr/local/nginx/conf/nginx.conf /usr/local/nginx/conf/nginx.conf.old[root@Centos ~]# cp /usr/src/nginx-1.11.2/conf/nginx.conf /usr/local/nginx/conf/nginx.conf[root@web ~]# kill -USR2 `cat /usr/local/nginx/logs/nginx.pid`[root@web ~]# ls /usr/local/nginx/logs/access.log error.log nginx.pid[root@web ~]# ps aux | grep nginx root 19008 0.0 0.0 24324 944 ? Ss 14:07 0:00 nginx: master process nginxnginx 19009 0.0 0.1 26832 1744 ? S 14:07 0:00 nginx: worker processroot 53194 0.0 0.0 112660 976 pts/0 R+ 14:36 0:00 grep --color=auto ngin</code></pre><h6 id="6ã€éªŒè¯-nginx-æ˜¯å¦å‡çº§æˆåŠŸ"><a href="#6ã€éªŒè¯-nginx-æ˜¯å¦å‡çº§æˆåŠŸ" class="headerlink" title="6ã€éªŒè¯ nginx æ˜¯å¦å‡çº§æˆåŠŸ"></a>6ã€éªŒè¯ nginx æ˜¯å¦å‡çº§æˆåŠŸ</h6><p><img src="https://s1.ax1x.com/2020/03/28/GFhgbR.png" alt="GFhgbR.png"></p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Nginx </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>kafkaå…¥é—¨</title>
      <link href="2019/04/26/sql/kafka-ru-men/"/>
      <url>2019/04/26/sql/kafka-ru-men/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h1 id="KAFKA-æ¶ˆæ¯ä¸­é—´ä»¶"><a href="#KAFKA-æ¶ˆæ¯ä¸­é—´ä»¶" class="headerlink" title="KAFKA æ¶ˆæ¯ä¸­é—´ä»¶"></a>KAFKA æ¶ˆæ¯ä¸­é—´ä»¶</h1><h2 id="1ã€è®¤è¯†kafka"><a href="#1ã€è®¤è¯†kafka" class="headerlink" title="1ã€è®¤è¯†kafka"></a><strong>1ã€è®¤è¯†kafka</strong></h2><h3 id="1-1-kafkaç®€ä»‹"><a href="#1-1-kafkaç®€ä»‹" class="headerlink" title="1.1 kafkaç®€ä»‹"></a><strong>1.1 kafkaç®€ä»‹</strong></h3><p>Kafka æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼æµåª’ä½“å¹³å°</p><p>kafkaå®˜ç½‘ï¼š<a href="http://kafka.apache.org/" target="_blank" rel="noopener">http://kafka.apache.org/</a></p><p>ï¼ˆ1ï¼‰æµåª’ä½“å¹³å°æœ‰ä¸‰ä¸ªå…³é”®åŠŸèƒ½ï¼š</p><ul><li><strong>å‘å¸ƒå’Œè®¢é˜…è®°å½•æµ</strong>ï¼Œç±»ä¼¼äºæ¶ˆæ¯é˜Ÿåˆ—æˆ–ä¼ä¸šæ¶ˆæ¯ä¼ é€’ç³»ç»Ÿã€‚</li><li>ä»¥<strong>å®¹é”™çš„æŒä¹…æ–¹å¼å­˜å‚¨è®°å½•æµ</strong>ã€‚</li><li>è®°å½•å‘ç”Ÿæ—¶å¤„ç†æµã€‚</li></ul><p>ï¼ˆ2ï¼‰Kafkaé€šå¸¸ç”¨äºä¸¤å¤§ç±»åº”ç”¨ï¼š</p><ul><li>æ„å»ºå¯åœ¨<strong>ç³»ç»Ÿæˆ–åº”ç”¨ç¨‹åºä¹‹é—´</strong>å¯é è·å–æ•°æ®çš„å®æ—¶æµæ•°æ®ç®¡é“</li><li>æ„å»ºè½¬æ¢æˆ–å“åº”æ•°æ®æµçš„å®æ—¶æµåº”ç”¨ç¨‹åº</li></ul><p>è¦äº†è§£Kafkaå¦‚ä½•åšè¿™äº›äº‹æƒ…ï¼Œè®©æˆ‘ä»¬æ·±å…¥æ¢è®¨Kafkaçš„èƒ½åŠ›ã€‚</p><p>ï¼ˆ3ï¼‰é¦–å…ˆæ˜¯å‡ ä¸ªæ¦‚å¿µï¼š</p><ul><li>Kafkaä½œä¸ºä¸€ä¸ªé›†ç¾¤è¿è¡Œåœ¨ä¸€ä¸ªæˆ–å¤šä¸ªå¯è·¨å¤šä¸ª<strong>æ•°æ®ä¸­å¿ƒçš„æœåŠ¡å™¨</strong>ä¸Šã€‚</li><li>Kafkaé›†ç¾¤ä»¥ç§°ä¸º <strong>topicsä¸»é¢˜</strong> çš„ç±»åˆ«å­˜å‚¨è®°å½•æµã€‚</li><li>æ¯æ¡è®°å½•éƒ½åŒ…å«<strong>ä¸€ä¸ªé”®ï¼Œä¸€ä¸ªå€¼å’Œä¸€ä¸ªæ—¶é—´æˆ³</strong>ã€‚</li></ul><p>ï¼ˆ4ï¼‰Kafkaæœ‰å››ä¸ªæ ¸å¿ƒAPIï¼š</p><ul><li><strong>Producer APIï¼ˆç”Ÿäº§è€…APIï¼‰</strong>å…è®¸åº”ç”¨ç¨‹åº<strong>å‘å¸ƒ</strong>è®°å½•æµè‡³ä¸€ä¸ªæˆ–å¤šä¸ªkafkaçš„<strong>topicsï¼ˆä¸»é¢˜ï¼‰</strong>ã€‚</li><li><strong>Consumer APIï¼ˆæ¶ˆè´¹è€…APIï¼‰</strong>å…è®¸åº”ç”¨ç¨‹åº<strong>è®¢é˜…ä¸€ä¸ªæˆ–å¤šä¸ªtopicsï¼ˆä¸»é¢˜ï¼‰</strong>ï¼Œå¹¶å¤„ç†æ‰€äº§ç”Ÿçš„å¯¹ä»–ä»¬è®°å½•çš„æ•°æ®æµã€‚</li><li><strong>Streams APIï¼ˆæµAPIï¼‰</strong>å…è®¸åº”ç”¨ç¨‹åºå……å½“<strong>æµå¤„ç†å™¨</strong>ï¼Œä»ä¸€ä¸ªæˆ–å¤šä¸ª<strong>topicsï¼ˆä¸»é¢˜ï¼‰</strong>æ¶ˆè€—çš„è¾“å…¥æµï¼Œå¹¶äº§ç”Ÿä¸€ä¸ªè¾“å‡ºæµè‡³ä¸€ä¸ªæˆ–å¤šä¸ªè¾“å‡ºçš„topicsï¼ˆä¸»é¢˜ï¼‰ï¼Œ<strong>æœ‰æ•ˆåœ°å˜æ¢æ‰€è¿°è¾“å…¥æµï¼Œä»¥è¾“å‡ºæµ</strong>ã€‚</li><li><strong>Connector APIï¼ˆè¿æ¥å™¨APIï¼‰</strong>å…è®¸æ„å»ºå’Œè¿è¡Œkafka <strong>topicsï¼ˆä¸»é¢˜ï¼‰è¿æ¥åˆ°ç°æœ‰çš„åº”ç”¨ç¨‹åºæˆ–æ•°æ®ç³»ç»Ÿä¸­é‡ç”¨ç”Ÿäº§è€…æˆ–æ¶ˆè´¹è€…</strong>ã€‚ä¾‹å¦‚ï¼Œå…³ç³»æ•°æ®åº“çš„è¿æ¥å™¨å¯èƒ½æ•è·å¯¹è¡¨çš„æ¯ä¸ªæ›´æ”¹ã€‚</li></ul><p><img src="https://s1.ax1x.com/2020/04/26/J632xH.png" alt="J632xH.png"></p><p>ã€€ã€€åœ¨Kafkaä¸­ï¼Œ<strong>å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´çš„é€šä¿¡</strong>æ˜¯é€šè¿‡ç®€å•ï¼Œé«˜æ€§èƒ½ï¼Œè¯­è¨€æ— å…³çš„<strong>TCPåè®®</strong>å®Œæˆçš„ã€‚æ­¤åè®®å·²ç‰ˆæœ¬åŒ–å¹¶ä¿æŒä¸æ—§ç‰ˆæœ¬çš„å‘åå…¼å®¹æ€§ã€‚Kafkaæä¾›Javaå®¢æˆ·ç«¯ï¼Œä½†å®¢æˆ·ç«¯æœ‰å¤šç§è¯­è¨€ç‰ˆæœ¬ã€‚</p><h3 id="1-2-Topicsä¸»é¢˜-å’Œ-partitionsåˆ†åŒº"><a href="#1-2-Topicsä¸»é¢˜-å’Œ-partitionsåˆ†åŒº" class="headerlink" title="1.2 Topicsä¸»é¢˜ å’Œ partitionsåˆ†åŒº"></a><strong>1.2 Topicsä¸»é¢˜ å’Œ partitionsåˆ†åŒº</strong></h3><p>æˆ‘ä»¬é¦–å…ˆæ·±å…¥äº†è§£ Kafka ä¸ºè®°å½•æµæä¾›çš„æ ¸å¿ƒæŠ½è±¡ - ä¸»é¢˜topics</p><p>ã€€ã€€<strong>ä¸€ä¸ªTopicå¯ä»¥è®¤ä¸ºæ˜¯ä¸€ç±»æ¶ˆæ¯ï¼Œæ¯ä¸ªtopicå°†è¢«åˆ†æˆå¤šä¸ªpartition(åŒº)</strong>,æ¯ä¸ªpartitionåœ¨å­˜å‚¨å±‚é¢æ˜¯append logæ–‡ä»¶</p><p>ã€€ã€€<strong>ä¸»é¢˜æ˜¯å‘å¸ƒè®°å½•çš„ç±»åˆ«æˆ–è®¢é˜…æºåç§°</strong>ã€‚Kafkaçš„ä¸»é¢˜æ€»æ˜¯å¤šç”¨æˆ·; ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€ä¸ªä¸»é¢˜å¯ä»¥æœ‰é›¶ä¸ªï¼Œä¸€ä¸ªæˆ–å¤šä¸ªæ¶ˆè´¹è€…è®¢é˜…å†™å…¥å®ƒçš„æ•°æ®ã€‚</p><p>ã€€ã€€å¯¹äº<strong>æ¯ä¸ªä¸»é¢˜</strong>ï¼ŒKafkaç¾¤é›†éƒ½ç»´æŠ¤ä¸€ä¸ªå¦‚ä¸‹æ‰€ç¤ºçš„<strong>åˆ†åŒº</strong>æ—¥å¿—ï¼š</p><p><img src="https://s1.ax1x.com/2020/04/26/J63fsA.png" alt="J63fsA.png"></p><p>ã€€ã€€<strong>æ¯ä¸ªåˆ†åŒºéƒ½æ˜¯ä¸€ä¸ªæœ‰åºçš„ï¼Œä¸å¯å˜çš„è®°å½•åºåˆ—</strong>ï¼Œä¸æ–­é™„åŠ åˆ°ç»“æ„åŒ–çš„æäº¤æ—¥å¿—ä¸­ã€‚åˆ†åŒºä¸­çš„è®°å½•æ¯ä¸ªéƒ½åˆ†é…äº†<strong>ä¸€ä¸ªç§°ä¸ºåç§»çš„é¡ºåºIDå·</strong>ï¼Œå®ƒå”¯ä¸€åœ°æ ‡è¯†åˆ†åŒºä¸­çš„æ¯ä¸ªè®°å½•ã€‚</p><p>ã€€ã€€<strong>Kafkaé›†ç¾¤æŒä¹…ä¿å­˜æ‰€æœ‰å·²å‘å¸ƒçš„è®°å½• - æ— è®ºæ˜¯å¦å·²ä½¿ç”¨ - ä½¿ç”¨å¯é…ç½®çš„ä¿ç•™æœŸ</strong>ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä¿ç•™ç­–ç•¥è®¾ç½®ä¸ºä¸¤å¤©ï¼Œåˆ™åœ¨å‘å¸ƒè®°å½•åçš„ä¸¤å¤©å†…ï¼Œå®ƒå¯ä¾›ä½¿ç”¨ï¼Œä¹‹åå°†è¢«ä¸¢å¼ƒä»¥é‡Šæ”¾ç©ºé—´ã€‚<strong>Kafkaçš„æ€§èƒ½åœ¨æ•°æ®å¤§å°æ–¹é¢å®é™…ä¸Šæ˜¯æ’å®šçš„ï¼Œå› æ­¤é•¿æ—¶é—´å­˜å‚¨æ•°æ®ä¸æ˜¯é—®é¢˜ã€‚</strong></p><p><img src="https://s1.ax1x.com/2020/04/26/J63IdP.png" alt="J63IdP.png"></p><p>ã€€ã€€å®é™…ä¸Šï¼ŒåŸº<strong>äºæ¯ä¸ªæ¶ˆè´¹è€…ä¿ç•™çš„å”¯ä¸€å…ƒæ•°æ®æ˜¯è¯¥æ¶ˆè´¹è€…åœ¨æ—¥å¿—ä¸­çš„åç§»æˆ–ä½ç½®</strong>ã€‚è¿™ç§åç§»ç”±æ¶ˆè´¹è€…æ§åˆ¶ï¼šé€šå¸¸æ¶ˆè´¹è€…åœ¨è¯»å–è®°å½•æ—¶ä¼šçº¿æ€§åœ°æé«˜å…¶åç§»é‡ï¼Œä½†äº‹å®ä¸Šï¼Œç”±äºè¯¥ä½ç½®ç”±æ¶ˆè´¹è€…æ§åˆ¶ï¼Œå› æ­¤å®ƒå¯ä»¥æŒ‰ç…§è‡ªå·±å–œæ¬¢çš„ä»»ä½•é¡ºåºæ¶ˆè´¹è®°å½•ã€‚ä¾‹å¦‚ï¼Œæ¶ˆè´¹è€…å¯ä»¥é‡ç½®ä¸ºè¾ƒæ—§çš„åç§»é‡æ¥é‡æ–°å¤„ç†è¿‡å»çš„æ•°æ®ï¼Œæˆ–è€…è·³åˆ°æœ€è¿‘çš„è®°å½•å¹¶ä»â€œç°åœ¨â€å¼€å§‹æ¶ˆè´¹ã€‚</p><p>ã€€ã€€è¿™äº›åŠŸèƒ½ç»„åˆæ„å‘³ç€Kafka æ¶ˆè´¹è€…consumers éå¸¸cheap - ä»–ä»¬å¯ä»¥æ¥æ¥å¾€å¾€å¯¹é›†ç¾¤æˆ–å…¶ä»–æ¶ˆè´¹è€…æ²¡æœ‰å¤ªå¤§å½±å“ã€‚ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨æˆ‘ä»¬çš„å‘½ä»¤è¡Œå·¥å…·â€œtailâ€ä»»ä½•ä¸»é¢˜çš„å†…å®¹ï¼Œè€Œæ— éœ€æ›´æ”¹ä»»ä½•ç°æœ‰ä½¿ç”¨è€…æ‰€æ¶ˆè€—çš„å†…å®¹ã€‚</p><p>ã€€ã€€<strong>æ—¥å¿—ä¸­çš„åˆ†åŒºæœ‰å¤šç§ç”¨é€”</strong>ã€‚é¦–å…ˆï¼Œå®ƒä»¬å…è®¸æ—¥å¿—æ‰©å±•åˆ°è¶…å‡ºé€‚åˆå•ä¸ªæœåŠ¡å™¨çš„å¤§å°ã€‚æ¯ä¸ªå•ç‹¬çš„åˆ†åŒºå¿…é¡»é€‚åˆæ‰˜ç®¡å®ƒçš„æœåŠ¡å™¨ï¼Œä½†<strong>ä¸»é¢˜å¯èƒ½æœ‰è®¸å¤šåˆ†åŒº</strong>ï¼Œå› æ­¤å®ƒå¯ä»¥å¤„ç†ä»»æ„æ•°é‡çš„æ•°æ®ã€‚å…¶æ¬¡ï¼Œå®ƒä»¬å……å½“äº†å¹¶è¡Œæ€§çš„å•ä½ - æ›´å¤šçš„æ˜¯å®ƒã€‚</p><h3 id="1-3-Distribution-åˆ†é…"><a href="#1-3-Distribution-åˆ†é…" class="headerlink" title="1.3 Distribution åˆ†é…"></a><strong>1.3 Distribution</strong> <strong>åˆ†é…</strong></h3><p>ã€€ã€€ä¸€ä¸ªTopicçš„å¤šä¸ªpartitions,è¢«åˆ†å¸ƒåœ¨kafkaé›†ç¾¤ä¸­çš„å¤šä¸ªserverä¸Š;æ¯ä¸ªserver(kafkaå®ä¾‹)è´Ÿè´£partitionsä¸­æ¶ˆæ¯çš„è¯»å†™æ“ä½œ;æ­¤å¤–kafkaè¿˜å¯ä»¥é…ç½®partitionséœ€è¦å¤‡ä»½çš„ä¸ªæ•°(replicas),æ¯ä¸ªpartitionå°†ä¼šè¢«å¤‡ä»½åˆ°å¤šå°æœºå™¨ä¸Š,ä»¥æé«˜å¯ç”¨æ€§.</p><p>ã€€ã€€åŸºäºreplicatedæ–¹æ¡ˆ,é‚£ä¹ˆå°±æ„å‘³ç€éœ€è¦å¯¹å¤šä¸ªå¤‡ä»½è¿›è¡Œè°ƒåº¦;æ¯ä¸ªpartitionéƒ½æœ‰ä¸€ä¸ªserverä¸ºâ€leaderâ€;leaderè´Ÿè´£æ‰€æœ‰çš„è¯»å†™æ“ä½œ,å¦‚æœleaderå¤±æ•ˆ,é‚£ä¹ˆå°†ä¼šæœ‰å…¶ä»–followeræ¥æ¥ç®¡(æˆä¸ºæ–°çš„leader);followeråªæ˜¯å•è°ƒçš„å’Œleaderè·Ÿè¿›,åŒæ­¥æ¶ˆæ¯å³å¯..ç”±æ­¤å¯è§ä½œä¸ºleaderçš„serveræ‰¿è½½äº†å…¨éƒ¨çš„è¯·æ±‚å‹åŠ›,å› æ­¤ä»é›†ç¾¤çš„æ•´ä½“è€ƒè™‘,æœ‰å¤šå°‘ä¸ªpartitionså°±æ„å‘³ç€æœ‰å¤šå°‘ä¸ªâ€leaderâ€,kafkaä¼šå°†â€leaderâ€å‡è¡¡çš„åˆ†æ•£åœ¨æ¯ä¸ªå®ä¾‹ä¸Š,æ¥ç¡®ä¿æ•´ä½“çš„æ€§èƒ½ç¨³å®šã€‚</p><h3 id="1-4-Producersç”Ÿäº§è€…-å’Œ-Consumersæ¶ˆè´¹è€…"><a href="#1-4-Producersç”Ÿäº§è€…-å’Œ-Consumersæ¶ˆè´¹è€…" class="headerlink" title="1.4 Producersç”Ÿäº§è€… å’Œ Consumersæ¶ˆè´¹è€…"></a><strong>1.4 Producersç”Ÿäº§è€… å’Œ Consumersæ¶ˆè´¹è€…</strong></h3><h4 id="1-4-1-Producersç”Ÿäº§è€…"><a href="#1-4-1-Producersç”Ÿäº§è€…" class="headerlink" title="1.4.1 Producersç”Ÿäº§è€…"></a><strong>1.4.1 Producersç”Ÿäº§è€…</strong></h4><p>ã€€ã€€Producers å°†æ•°æ®<strong>å‘å¸ƒåˆ°æŒ‡å®šçš„topics ä¸»é¢˜</strong>ã€‚åŒæ—¶Producer ä¹Ÿèƒ½å†³å®šå°†æ­¤æ¶ˆæ¯å½’å±äºå“ªä¸ªpartition;æ¯”å¦‚åŸºäºâ€round-robinâ€æ–¹å¼æˆ–è€…é€šè¿‡å…¶ä»–çš„ä¸€äº›ç®—æ³•ç­‰ã€‚</p><h4 id="1-4-2-Consumers"><a href="#1-4-2-Consumers" class="headerlink" title="1.4.2 Consumers"></a><strong>1.4.2</strong> <strong>Consumers</strong></h4><ul><li>æœ¬è´¨ä¸Škafkaåªæ”¯æŒTopic.<strong>æ¯ä¸ªconsumerå±äºä¸€ä¸ªconsumer group</strong>;åè¿‡æ¥è¯´,æ¯ä¸ªgroupä¸­å¯ä»¥æœ‰å¤šä¸ªconsumer.å‘é€åˆ°Topicçš„æ¶ˆæ¯,åªä¼š<strong>è¢«è®¢é˜…æ­¤Topicçš„æ¯ä¸ªgroupä¸­çš„ä¸€ä¸ªconsumeræ¶ˆè´¹</strong>ã€‚</li><li>å¦‚æœæ‰€æœ‰ä½¿ç”¨è€…å®ä¾‹å…·æœ‰ç›¸åŒçš„ä½¿ç”¨è€…ç»„ï¼Œåˆ™è®°å½•å°†æœ‰æ•ˆåœ°åœ¨ä½¿ç”¨è€…å®ä¾‹ä¸Šè¿›è¡Œ<strong>è´Ÿè½½å¹³è¡¡</strong>ã€‚</li><li>å¦‚æœæ‰€æœ‰æ¶ˆè´¹è€…å®ä¾‹å…·æœ‰ä¸åŒçš„æ¶ˆè´¹è€…ç»„ï¼Œåˆ™æ¯ä¸ªè®°å½•å°†<strong>å¹¿æ’­åˆ°æ‰€æœ‰æ¶ˆè´¹è€…è¿›ç¨‹</strong>ã€‚</li></ul><p><img src="https://s1.ax1x.com/2020/04/26/J63oIf.png" alt="J63oIf.png"></p><p>ã€€ã€€åˆ†æï¼šä¸¤ä¸ªæœåŠ¡å™¨Kafkaç¾¤é›†ï¼Œæ‰˜ç®¡å››ä¸ªåˆ†åŒºï¼ˆP0-P3ï¼‰ï¼ŒåŒ…å«ä¸¤ä¸ªä½¿ç”¨è€…ç»„ã€‚æ¶ˆè´¹è€…ç»„Aæœ‰ä¸¤ä¸ªæ¶ˆè´¹è€…å®ä¾‹ï¼ŒBç»„æœ‰å››ä¸ªæ¶ˆè´¹è€…å®ä¾‹ã€‚</p><p>ã€€ã€€åœ¨Kafkaä¸­å®ç°æ¶ˆè´¹consumption çš„æ–¹å¼æ˜¯é€šè¿‡åœ¨æ¶ˆè´¹è€…å®ä¾‹ä¸Šåˆ’åˆ†æ—¥å¿—ä¸­çš„<strong>åˆ†åŒº</strong>ï¼Œä»¥ä¾¿æ¯ä¸ªå®ä¾‹åœ¨ä»»ä½•æ—¶é—´ç‚¹éƒ½æ˜¯åˆ†é…çš„â€œå…¬å¹³ä»½é¢â€çš„ç‹¬å æ¶ˆè´¹è€…ã€‚ç»´æŠ¤ç»„ä¸­æˆå‘˜èµ„æ ¼çš„è¿‡ç¨‹ç”±Kafkaåè®®åŠ¨æ€å¤„ç†ã€‚å¦‚æœæ–°å®ä¾‹åŠ å…¥è¯¥ç»„ï¼Œä»–ä»¬å°†ä»è¯¥ç»„çš„å…¶ä»–æˆå‘˜æ¥ç®¡ä¸€äº›åˆ†åŒº; å¦‚æœå®ä¾‹æ­»äº¡ï¼Œå…¶åˆ†åŒºå°†åˆ†å‘ç»™å…¶ä½™å®ä¾‹ã€‚</p><p>ã€€ã€€<strong>Kafkaä»…æä¾›åˆ†åŒºå†…è®°å½•çš„æ€»è®¢å•</strong>ï¼Œè€Œä¸æ˜¯ä¸»é¢˜ä¸­ä¸åŒåˆ†åŒºä¹‹é—´çš„è®°å½•ã€‚å¯¹äºå¤§å¤šæ•°åº”ç”¨ç¨‹åºè€Œè¨€ï¼ŒæŒ‰åˆ†åŒºæ’åºä¸æŒ‰é”®åˆ†åŒºæ•°æ®çš„èƒ½åŠ›ç›¸ç»“åˆå°±è¶³å¤Ÿäº†ã€‚ä½†æ˜¯ï¼Œå¦‚æœæ‚¨éœ€è¦å¯¹è®°å½•è¿›è¡Œæ€»è®¢å•ï¼Œåˆ™å¯ä»¥ä½¿ç”¨ä»…åŒ…å«ä¸€ä¸ªåˆ†åŒºçš„ä¸»é¢˜æ¥å®ç°ï¼Œä½†è¿™å°†æ„å‘³ç€æ¯ä¸ªä½¿ç”¨è€…ç»„åªæœ‰ä¸€ä¸ªä½¿ç”¨è€…è¿›ç¨‹ã€‚</p><h3 id="1-5-Consumers-kafkaç¡®ä¿"><a href="#1-5-Consumers-kafkaç¡®ä¿" class="headerlink" title="1.5 Consumers kafkaç¡®ä¿"></a><strong>1.5 Consumers kafkaç¡®ä¿</strong></h3><ul><li><strong>å‘é€åˆ°partitionsä¸­çš„æ¶ˆæ¯å°†ä¼šæŒ‰ç…§å®ƒæ¥æ”¶çš„é¡ºåºè¿½åŠ åˆ°æ—¥å¿—ä¸­</strong>ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœè®°å½•M1ç”±ä¸è®°å½•M2ç›¸åŒçš„ç”Ÿæˆè€…å‘é€ï¼Œå¹¶ä¸”é¦–å…ˆå‘é€M1ï¼Œåˆ™M1å°†å…·æœ‰æ¯”M2æ›´ä½çš„åç§»å¹¶ä¸”åœ¨æ—¥å¿—ä¸­æ›´æ—©å‡ºç°ã€‚</li><li>æ¶ˆè´¹è€…å®ä¾‹æŒ‰ç…§å®ƒä»¬å­˜å‚¨åœ¨æ—¥å¿—ä¸­çš„é¡ºåºæŸ¥çœ‹è®°å½•ã€‚å¯¹äºæ¶ˆè´¹è€…è€Œè¨€,<strong>å®ƒä»¬æ¶ˆè´¹æ¶ˆæ¯çš„é¡ºåºå’Œæ—¥å¿—ä¸­æ¶ˆæ¯é¡ºåºä¸€è‡´</strong>ã€‚</li><li>å¦‚æœTopicçš„â€replicationfactorâ€ä¸ºN,é‚£ä¹ˆå…è®¸N-1ä¸ªkafkaå®ä¾‹å¤±æ•ˆï¼Œæˆ‘ä»¬å°†å®¹å¿æœ€å¤šN-1ä¸ªæœåŠ¡å™¨æ•…éšœï¼Œè€Œä¸ä¼šä¸¢å¤±ä»»ä½•æäº¤åˆ°æ—¥å¿—çš„è®°å½•ã€‚</li></ul><h3 id="1-6-kafka-ä½œä¸ºæ¶ˆæ¯ç³»ç»Ÿ"><a href="#1-6-kafka-ä½œä¸ºæ¶ˆæ¯ç³»ç»Ÿ" class="headerlink" title="1.6 kafka**ä½œä¸ºæ¶ˆæ¯ç³»ç»Ÿ**"></a><strong>1.6 kafka**</strong>ä½œä¸ºæ¶ˆæ¯ç³»ç»Ÿ**</h3><p>Kafkaçš„æµæ¦‚å¿µä¸ä¼ ç»Ÿçš„ä¼ä¸šé‚®ä»¶ç³»ç»Ÿç›¸æ¯”å¦‚ä½•ï¼Ÿ</p><p>ï¼ˆ1ï¼‰ä¼ ç»Ÿæ¶ˆæ¯ç³»ç»Ÿ</p><p>ã€€ã€€æ¶ˆæ¯ä¼ ç»Ÿä¸Šæœ‰ä¸¤ç§æ¨¡å‹ï¼šqueuingæ’é˜Ÿ and publish-subscribeå‘å¸ƒ - è®¢é˜…ã€‚åœ¨é˜Ÿåˆ—ä¸­ï¼Œæ¶ˆè´¹è€…æ± å¯ä»¥ä»æœåŠ¡å™¨è¯»å–å¹¶ä¸”æ¯ä¸ªè®°å½•è½¬åˆ°å…¶ä¸­ä¸€ä¸ª; åœ¨å‘å¸ƒ - è®¢é˜…ä¸­ï¼Œè®°å½•è¢«å¹¿æ’­ç»™æ‰€æœ‰æ¶ˆè´¹è€…ã€‚è¿™ä¸¤ç§æ¨¡å‹ä¸­çš„æ¯ä¸€ç§éƒ½æœ‰ä¼˜ç‚¹å’Œç¼ºç‚¹ã€‚æ’é˜Ÿçš„ä¼˜åŠ¿åœ¨äºå®ƒå…è®¸æ‚¨åœ¨å¤šä¸ªæ¶ˆè´¹è€…å®ä¾‹ä¸Šåˆ’åˆ†æ•°æ®å¤„ç†ï¼Œä»è€Œå¯ä»¥æ‰©å±•æ‚¨çš„å¤„ç†ã€‚ä¸å¹¸çš„æ˜¯ï¼Œä¸€æ—¦ä¸€ä¸ªè¿›ç¨‹è¯»å–å®ƒå·²ç»æ¶ˆå¤±çš„æ•°æ®ï¼Œé˜Ÿåˆ—å°±ä¸æ˜¯å¤šç”¨æˆ·ã€‚å‘å¸ƒ - è®¢é˜…å…è®¸æ‚¨å°†æ•°æ®å¹¿æ’­åˆ°å¤šä¸ªè¿›ç¨‹ï¼Œä½†ç”±äºæ¯æ¡æ¶ˆæ¯éƒ½å‘é€ç»™æ¯ä¸ªè®¢é˜…è€…ï¼Œå› æ­¤æ— æ³•è¿›è¡Œæ‰©å±•å¤„ç†ã€‚</p><p>kafkaçš„æ¶ˆè´¹è€…ç¾¤ä½“æ¦‚å¿µæ¦‚æ‹¬äº†è¿™ä¸¤ä¸ªæ¦‚å¿µã€‚ä¸é˜Ÿåˆ—ä¸€æ ·ï¼Œä½¿ç”¨è€…ç»„å…è®¸æ‚¨å°†å¤„ç†åˆ’åˆ†ä¸ºä¸€ç»„è¿›ç¨‹ï¼ˆä½¿ç”¨è€…ç»„çš„æˆå‘˜ï¼‰ã€‚ä¸å‘å¸ƒ - è®¢é˜…ä¸€æ ·ï¼ŒKafkaå…è®¸æ‚¨å‘å¤šä¸ªæ¶ˆè´¹è€…ç»„å¹¿æ’­æ¶ˆæ¯ã€‚</p><p>ï¼ˆ2ï¼‰kafka çš„ä¼˜åŠ¿</p><p>ã€€ã€€<strong>Kafkaæ¨¡å‹çš„ä¼˜åŠ¿åœ¨äºæ¯ä¸ªä¸»é¢˜éƒ½å…·æœ‰è¿™äº›å±æ€§</strong> - å®ƒå¯ä»¥æ‰©å±•å¤„ç†å¹¶ä¸”ä¹Ÿæ˜¯å¤šç”¨æˆ· - ä¸éœ€è¦é€‰æ‹©å…¶ä¸­ä¸€ä¸ªã€‚</p><p>ã€€ã€€ä¸ä¼ ç»Ÿçš„æ¶ˆæ¯ç³»ç»Ÿç›¸æ¯”ï¼ŒKafkaå…·æœ‰<strong>æ›´å¼ºçš„è®¢è´­ä¿è¯</strong>ã€‚</p><p>ã€€ã€€ä¼ ç»Ÿé˜Ÿåˆ—åœ¨æœåŠ¡å™¨ä¸ŠæŒ‰é¡ºåºä¿ç•™è®°å½•ï¼Œå¦‚æœå¤šä¸ªæ¶ˆè´¹è€…ä»é˜Ÿåˆ—ä¸­æ¶ˆè€—ï¼Œåˆ™æœåŠ¡å™¨æŒ‰ç…§å­˜å‚¨é¡ºåºåˆ†å‘è®°å½•ã€‚ä½†æ˜¯ï¼Œè™½ç„¶æœåŠ¡å™¨æŒ‰é¡ºåºåˆ†å‘è®°å½•ï¼Œä½†æ˜¯è®°å½•æ˜¯å¼‚æ­¥ä¼ é€’ç»™æ¶ˆè´¹è€…çš„ï¼Œå› æ­¤å®ƒä»¬å¯èƒ½ä¼šåœ¨ä¸åŒçš„æ¶ˆè´¹è€…å¤„å‡ºç°æ•…éšœã€‚è¿™å®é™…ä¸Šæ„å‘³ç€åœ¨å­˜åœ¨å¹¶è¡Œæ¶ˆè€—çš„æƒ…å†µä¸‹ä¸¢å¤±è®°å½•çš„é¡ºåºã€‚æ¶ˆæ¯ä¼ é€’ç³»ç»Ÿé€šå¸¸é€šè¿‡å…·æœ‰â€œç‹¬å æ¶ˆè´¹è€…â€æ¦‚å¿µæ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œè¯¥æ¦‚å¿µåªå…è®¸ä¸€ä¸ªè¿›ç¨‹ä»é˜Ÿåˆ—ä¸­æ¶ˆè€—ï¼Œä½†å½“ç„¶è¿™æ„å‘³ç€å¤„ç†ä¸­æ²¡æœ‰å¹¶è¡Œæ€§ã€‚</p><p>ã€€ã€€<strong>kafkaåšå¾—æ›´å¥½ã€‚é€šè¿‡åœ¨ä¸»é¢˜ä¸­å…·æœ‰å¹¶è¡Œæ€§æ¦‚å¿µ - åˆ†åŒº - ï¼ŒKafkaèƒ½å¤Ÿåœ¨æ¶ˆè´¹è€…æµç¨‹æ± ä¸­æä¾›è®¢è´­ä¿è¯å’Œè´Ÿè½½å¹³è¡¡</strong>ã€‚è¿™æ˜¯é€šè¿‡å°†ä¸»é¢˜ä¸­çš„åˆ†åŒºåˆ†é…ç»™ä½¿ç”¨è€…ç»„ä¸­çš„ä½¿ç”¨è€…æ¥å®ç°çš„ï¼Œä»¥ä¾¿æ¯ä¸ªåˆ†åŒºä»…ç”±è¯¥ç»„ä¸­çš„ä¸€ä¸ªä½¿ç”¨è€…ä½¿ç”¨ã€‚é€šè¿‡è¿™æ ·åšï¼Œæˆ‘ä»¬ç¡®ä¿ä½¿ç”¨è€…æ˜¯è¯¥åˆ†åŒºçš„å”¯ä¸€è¯»è€…å¹¶æŒ‰é¡ºåºä½¿ç”¨æ•°æ®ã€‚ç”±äºæœ‰è®¸å¤šåˆ†åŒºï¼Œè¿™ä»ç„¶å¯ä»¥å¹³è¡¡è®¸å¤šæ¶ˆè´¹è€…å®ä¾‹çš„è´Ÿè½½ã€‚ä½†è¯·æ³¨æ„ï¼Œæ¶ˆè´¹è€…ç»„ä¸­çš„æ¶ˆè´¹è€…å®ä¾‹ä¸èƒ½è¶…è¿‡åˆ†åŒºã€‚</p><h3 id="1-7-kafkaä½œä¸ºå­˜å‚¨ç³»ç»Ÿ"><a href="#1-7-kafkaä½œä¸ºå­˜å‚¨ç³»ç»Ÿ" class="headerlink" title="1.7 kafkaä½œä¸ºå­˜å‚¨ç³»ç»Ÿ"></a><strong>1.7 kafkaä½œä¸ºå­˜å‚¨ç³»ç»Ÿ</strong></h3><ul><li>ä»»ä½•å…è®¸å‘å¸ƒä¸æ¶ˆè´¹æ¶ˆæ¯åˆ†ç¦»çš„æ¶ˆæ¯çš„æ¶ˆæ¯é˜Ÿåˆ—å®é™…ä¸Šå……å½“äº†æ­£åœ¨è¿›è¡Œçš„æ¶ˆæ¯çš„å­˜å‚¨ç³»ç»Ÿã€‚Kafkaçš„ä¸åŒä¹‹å¤„åœ¨äºå®ƒæ˜¯<strong>ä¸€ä¸ªéå¸¸å¥½çš„å­˜å‚¨ç³»ç»Ÿ</strong>ã€‚</li><li><strong>å†™å…¥Kafkaçš„æ•°æ®å°†å†™å…¥ç£ç›˜å¹¶è¿›è¡Œå¤åˆ¶ä»¥å®ç°å®¹é”™</strong>ã€‚Kafkaå…è®¸ç”Ÿäº§è€…ç­‰å¾…ç¡®è®¤ï¼Œä»¥ä¾¿åœ¨å®Œå…¨å¤åˆ¶ä¹‹å‰å†™å…¥ä¸è¢«è®¤ä¸ºæ˜¯å®Œæ•´çš„ï¼Œå¹¶ä¸”å³ä½¿å†™å…¥çš„æœåŠ¡å™¨å¤±è´¥ä¹Ÿä¿è¯å†™å…¥ä»ç„¶å­˜åœ¨ã€‚</li><li><strong>ç£ç›˜ç»“æ„Kafkaå¾ˆå¥½åœ°ä½¿ç”¨äº†è§„æ¨¡</strong> - æ— è®ºæœåŠ¡å™¨ä¸Šæœ‰50 KBè¿˜æ˜¯50 TBçš„æŒä¹…æ•°æ®ï¼ŒKafkaéƒ½ä¼šæ‰§è¡Œç›¸åŒçš„æ“ä½œã€‚</li><li>ç”±äºè®¤çœŸå¯¹å¾…å­˜å‚¨å¹¶å…è®¸å®¢æˆ·ç«¯æ§åˆ¶å…¶è¯»å–ä½ç½®ï¼Œæ‚¨å¯ä»¥å°†<strong>Kafkaè§†ä¸ºä¸€ç§ä¸“ç”¨äºé«˜æ€§èƒ½ï¼Œä½å»¶è¿Ÿæäº¤æ—¥å¿—å­˜å‚¨ï¼Œå¤åˆ¶å’Œä¼ æ’­çš„ä¸“ç”¨åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿ</strong>ã€‚</li><li>æœ‰å…³Kafkaçš„æäº¤æ—¥å¿—å­˜å‚¨å’Œå¤åˆ¶è®¾è®¡çš„è¯¦ç»†ä¿¡æ¯ï¼Œè¯·é˜…è¯»<a href="https://kafka.apache.org/documentation/#design" target="_blank" rel="noopener">æ­¤</a>é¡µé¢ã€‚</li></ul><h3 id="1-8-kafkaç”¨äºæµå¤„ç†"><a href="#1-8-kafkaç”¨äºæµå¤„ç†" class="headerlink" title="1.8 kafkaç”¨äºæµå¤„ç†"></a><strong>1.8 kafkaç”¨äºæµå¤„ç†</strong></h3><ul><li>ä»…ä»…è¯»å–ï¼Œå†™å…¥å’Œå­˜å‚¨æ•°æ®æµæ˜¯ä¸å¤Ÿçš„ï¼Œç›®çš„æ˜¯å®ç°<strong>æµçš„å®æ—¶å¤„ç†</strong>ã€‚</li><li>åœ¨Kafkaä¸­ï¼Œæµå¤„ç†å™¨æ˜¯æŒ‡<strong>ä»è¾“å…¥ä¸»é¢˜è·å–è¿ç»­æ•°æ®æµï¼Œå¯¹æ­¤è¾“å…¥æ‰§è¡ŒæŸäº›å¤„ç†ä»¥åŠç”Ÿæˆè¿ç»­æ•°æ®æµä»¥è¾“å‡ºä¸»é¢˜çš„ä»»ä½•å†…å®¹</strong>ã€‚</li><li>ä¾‹å¦‚ï¼Œé›¶å”®åº”ç”¨ç¨‹åºå¯èƒ½ä¼šæ¥æ”¶é”€å”®å’Œå‘è´§çš„è¾“å…¥æµï¼Œå¹¶è¾“å‡ºé‡æ–°æ’åºæµå’Œæ ¹æ®æ­¤æ•°æ®è®¡ç®—çš„ä»·æ ¼è°ƒæ•´ã€‚</li><li>å¯ä»¥ä½¿ç”¨ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…APIç›´æ¥è¿›è¡Œç®€å•å¤„ç†ã€‚ä½†æ˜¯ï¼Œå¯¹äºæ›´å¤æ‚çš„è½¬æ¢ï¼ŒKafkaæä¾›äº†å®Œå…¨é›†æˆçš„Streams APIã€‚è¿™å…è®¸æ„å»ºæ‰§è¡Œéå¹³å‡¡å¤„ç†çš„åº”ç”¨ç¨‹åºï¼Œè¿™äº›åº”ç”¨ç¨‹åºå¯ä»¥è®¡ç®—æµçš„èšåˆæˆ–å°†æµè¿æ¥åœ¨ä¸€èµ·ã€‚</li><li>æ­¤å·¥å…·æœ‰åŠ©äºè§£å†³æ­¤ç±»åº”ç”¨ç¨‹åºé¢ä¸´çš„éš¾é¢˜ï¼šå¤„ç†æ— åºæ•°æ®ï¼Œåœ¨ä»£ç æ›´æ”¹æ—¶é‡æ–°å¤„ç†è¾“å…¥ï¼Œæ‰§è¡Œæœ‰çŠ¶æ€è®¡ç®—ç­‰ã€‚</li><li>æµAPIæ„å»ºåœ¨Kafkaæä¾›çš„æ ¸å¿ƒåŸè¯­ä¸Šï¼šå®ƒä½¿ç”¨ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…APIè¿›è¡Œè¾“å…¥ï¼Œä½¿ç”¨Kafkaè¿›è¡Œæœ‰çŠ¶æ€å­˜å‚¨ï¼Œå¹¶åœ¨æµå¤„ç†å™¨å®ä¾‹ä¹‹é—´ä½¿ç”¨ç›¸åŒçš„ç»„æœºåˆ¶æ¥å®ç°å®¹é”™ã€‚</li></ul><h2 id="2ã€kafkaä½¿ç”¨åœºæ™¯"><a href="#2ã€kafkaä½¿ç”¨åœºæ™¯" class="headerlink" title="2ã€kafkaä½¿ç”¨åœºæ™¯"></a><strong>2ã€kafkaä½¿ç”¨åœºæ™¯</strong></h2><h3 id="2-1-æ¶ˆæ¯Messaging"><a href="#2-1-æ¶ˆæ¯Messaging" class="headerlink" title="2.1 æ¶ˆæ¯Messaging"></a><strong>2.1 æ¶ˆæ¯Messaging</strong></h3><p>ã€€ã€€<strong>Kafkaå¯ä»¥æ›¿ä»£æ›´ä¼ ç»Ÿçš„æ¶ˆæ¯ä»£ç†</strong>ã€‚æ¶ˆæ¯ä»£ç†çš„ä½¿ç”¨æœ‰å¤šç§åŸå› ï¼ˆå°†å¤„ç†ä¸æ•°æ®ç”Ÿæˆå™¨åˆ†ç¦»ï¼Œç¼“å†²æœªå¤„ç†çš„æ¶ˆæ¯ç­‰ï¼‰ã€‚<strong>ä¸å¤§å¤šæ•°æ¶ˆæ¯ä¼ é€’ç³»ç»Ÿç›¸æ¯”ï¼ŒKafkaå…·æœ‰æ›´å¥½çš„ååé‡ï¼Œå†…ç½®åˆ†åŒºï¼Œå¤åˆ¶å’Œå®¹é”™åŠŸèƒ½</strong>ï¼Œè¿™ä½¿å…¶æˆä¸ºå¤§è§„æ¨¡æ¶ˆæ¯å¤„ç†åº”ç”¨ç¨‹åºçš„ç†æƒ³è§£å†³æ–¹æ¡ˆã€‚</p><p>ã€€ã€€æ ¹æ®ç»éªŒï¼Œæ¶ˆæ¯ä¼ é€’çš„ä½¿ç”¨é€šå¸¸ç›¸å¯¹è¾ƒä½ï¼Œä½†å¯èƒ½éœ€è¦è¾ƒä½çš„ç«¯åˆ°ç«¯å»¶è¿Ÿï¼Œå¹¶ä¸”é€šå¸¸å–å†³äºKafkaæä¾›çš„å¼ºå¤§çš„è€ç”¨æ€§ä¿è¯ã€‚</p><p>ã€€ã€€åœ¨è¿™ä¸ªé¢†åŸŸï¼ŒKafkaå¯ä¸ä¼ ç»Ÿçš„æ¶ˆæ¯ä¼ é€’ç³»ç»Ÿï¼ˆå¦‚<a href="http://activemq.apache.org/" target="_blank" rel="noopener">ActiveMQ</a>æˆ– <a href="https://www.rabbitmq.com/" target="_blank" rel="noopener">RabbitMQ</a>ï¼‰ç›¸åª²ç¾ã€‚</p><h3 id="2-2-ç½‘ç«™æ´»åŠ¨è·Ÿè¸ª"><a href="#2-2-ç½‘ç«™æ´»åŠ¨è·Ÿè¸ª" class="headerlink" title="2.2 ç½‘ç«™æ´»åŠ¨è·Ÿè¸ª"></a><strong>2.2 ç½‘ç«™æ´»åŠ¨è·Ÿè¸ª</strong></h3><p>ã€€ã€€Kafkaçš„åŸå§‹ç”¨ä¾‹æ˜¯èƒ½å¤Ÿå°†ç”¨æˆ·æ´»åŠ¨è·Ÿè¸ªç®¡é“é‡å»ºä¸ºä¸€ç»„å®æ—¶å‘å¸ƒ - è®¢é˜…æºã€‚è¿™æ„å‘³ç€ç«™ç‚¹æ´»åŠ¨ï¼ˆé¡µé¢æŸ¥çœ‹ï¼Œæœç´¢æˆ–ç”¨æˆ·å¯èƒ½é‡‡å–çš„å…¶ä»–æ“ä½œï¼‰å°†å‘å¸ƒåˆ°ä¸­å¿ƒä¸»é¢˜ï¼Œæ¯ä¸ªæ´»åŠ¨ç±»å‹åŒ…å«ä¸€ä¸ªä¸»é¢˜ã€‚è¿™äº›æºå¯ç”¨äºè®¢è´­ä¸€ç³»åˆ—ç”¨ä¾‹ï¼Œ<strong>åŒ…æ‹¬å®æ—¶å¤„ç†ï¼Œå®æ—¶ç›‘æ§ä»¥åŠåŠ è½½åˆ°Hadoopæˆ–ç¦»çº¿æ•°æ®ä»“åº“ç³»ç»Ÿä»¥è¿›è¡Œè„±æœºå¤„ç†å’ŒæŠ¥å‘Š</strong>ã€‚</p><p>ã€€ã€€æ´»åŠ¨è·Ÿè¸ªé€šå¸¸éå¸¸é«˜ï¼Œå› ä¸ºä¸ºæ¯ä¸ªç”¨æˆ·é¡µé¢è§†å›¾ç”Ÿæˆäº†è®¸å¤šæ´»åŠ¨æ¶ˆæ¯ã€‚</p><h3 id="2-3-åº¦é‡Metrics"><a href="#2-3-åº¦é‡Metrics" class="headerlink" title="2.3 åº¦é‡Metrics"></a><strong>2.3 åº¦é‡Metrics</strong></h3><p>ã€€ã€€<strong>Kafkaé€šå¸¸ç”¨äºè¿è¥ç›‘æ§æ•°æ®</strong>ã€‚è¿™æ¶‰åŠä»åˆ†å¸ƒå¼åº”ç”¨ç¨‹åºèšåˆç»Ÿè®¡ä¿¡æ¯ä»¥ç”Ÿæˆæ“ä½œæ•°æ®çš„é›†ä¸­å¼æè¦ã€‚</p><h3 id="2-4-æ—¥å¿—èšåˆ"><a href="#2-4-æ—¥å¿—èšåˆ" class="headerlink" title="2.4 æ—¥å¿—èšåˆ"></a><strong>2.4 æ—¥å¿—èšåˆ</strong></h3><p>ã€€ã€€è®¸å¤šäººä½¿ç”¨Kafkaä½œä¸ºæ—¥å¿—èšåˆè§£å†³æ–¹æ¡ˆçš„æ›¿ä»£å“ã€‚æ—¥å¿—èšåˆé€šå¸¸ä»æœåŠ¡å™¨æ”¶é›†ç‰©ç†æ—¥å¿—æ–‡ä»¶ï¼Œå¹¶å°†å®ƒä»¬æ”¾åœ¨ä¸­å¤®ä½ç½®ï¼ˆå¯èƒ½æ˜¯æ–‡ä»¶æœåŠ¡å™¨æˆ–HDFSï¼‰è¿›è¡Œå¤„ç†ã€‚<strong>KafkaæŠ½è±¡å‡ºæ–‡ä»¶çš„ç»†èŠ‚ï¼Œå¹¶å°†æ—¥å¿—æˆ–äº‹ä»¶æ•°æ®ä½œä¸ºæ¶ˆæ¯æµæ›´æ¸…æ™°åœ°æŠ½è±¡å‡ºæ¥</strong>ã€‚è¿™å…è®¸æ›´ä½å»¶è¿Ÿçš„å¤„ç†å¹¶æ›´å®¹æ˜“æ”¯æŒå¤šä¸ªæ•°æ®æºå’Œåˆ†å¸ƒå¼æ•°æ®æ¶ˆè€—ã€‚ä¸Scribeæˆ–Flumeç­‰ä»¥æ—¥å¿—ä¸ºä¸­å¿ƒçš„ç³»ç»Ÿç›¸æ¯”ï¼Œ<strong>Kafkaæä¾›äº†åŒæ ·å‡ºè‰²çš„æ€§èƒ½ï¼Œç”±äºå¤åˆ¶è€Œå…·æœ‰æ›´å¼ºçš„è€ç”¨æ€§ä¿è¯ï¼Œä»¥åŠæ›´ä½çš„ç«¯åˆ°ç«¯å»¶è¿Ÿã€‚</strong></p><h3 id="2-5-æµå¤„ç†"><a href="#2-5-æµå¤„ç†" class="headerlink" title="2.5 æµå¤„ç†"></a><strong>2.5 æµå¤„ç†</strong></h3><p>ã€€ã€€è®¸å¤šKafkaç”¨æˆ·åœ¨å¤„ç†ç”±å¤šä¸ªé˜¶æ®µç»„æˆçš„ç®¡é“æ—¶å¤„ç†æ•°æ®ï¼Œ<strong>å…¶ä¸­åŸå§‹è¾“å…¥æ•°æ®ä»Kafkaä¸»é¢˜ä¸­æ¶ˆè´¹ï¼Œç„¶åèšåˆï¼Œä¸°å¯Œæˆ–ä»¥å…¶ä»–æ–¹å¼è½¬æ¢ä¸ºæ–°ä¸»é¢˜ä»¥ä¾›è¿›ä¸€æ­¥æ¶ˆè´¹æˆ–åç»­å¤„ç†</strong>ã€‚</p><p>ã€€ã€€ä¾‹å¦‚ï¼Œç”¨äºæ¨èæ–°é—»æ–‡ç« çš„å¤„ç†ç®¡é“å¯ä»¥ä»RSSè®¢é˜…æºæŠ“å–æ–‡ç« å†…å®¹å¹¶å°†å…¶å‘å¸ƒåˆ°â€œæ–‡ç« â€ä¸»é¢˜; è¿›ä¸€æ­¥å¤„ç†å¯èƒ½ä¼šå¯¹æ­¤å†…å®¹è¿›è¡Œè§„èŒƒåŒ–æˆ–é‡å¤æ•°æ®åˆ é™¤ï¼Œå¹¶å°†å·²æ¸…ç†çš„æ–‡ç« å†…å®¹å‘å¸ƒåˆ°æ–°ä¸»é¢˜; æœ€ç»ˆå¤„ç†é˜¶æ®µå¯èƒ½ä¼šå°è¯•å‘ç”¨æˆ·æ¨èæ­¤å†…å®¹ã€‚æ­¤ç±»å¤„ç†ç®¡é“åŸºäºå„ä¸ªä¸»é¢˜åˆ›å»ºå®æ—¶æ•°æ®æµçš„å›¾å½¢ã€‚ä»0.10.0.0å¼€å§‹ï¼Œè¿™æ˜¯ä¸€ä¸ªè½»é‡çº§ä½†åŠŸèƒ½å¼ºå¤§çš„æµå¤„ç†åº“ï¼Œåä¸º<a href="http://kafka.apache.org/documentation/streams" target="_blank" rel="noopener">Kafka Streams</a> åœ¨Apache Kafkaä¸­å¯ç”¨äºæ‰§è¡Œå¦‚ä¸Šæ‰€è¿°çš„æ­¤ç±»æ•°æ®å¤„ç†ã€‚é™¤äº†Kafka Streamsä¹‹å¤–ï¼Œå…¶ä»–å¼€æºæµå¤„ç†å·¥å…·åŒ…æ‹¬<a href="https://storm.apache.org/" target="_blank" rel="noopener">Apache Storm</a>å’Œ <a href="http://samza.apache.org/" target="_blank" rel="noopener">Apache Samza</a>ã€‚</p><h3 id="2-6-Event-Sourcing"><a href="#2-6-Event-Sourcing" class="headerlink" title="2.6 Event Sourcing"></a><strong>2.6 Event Sourcing</strong></h3><p>ã€€ã€€Event Sourcingæ˜¯ä¸€ç§åº”ç”¨ç¨‹åºè®¾è®¡é£æ ¼ï¼Œå…¶ä¸­çŠ¶æ€æ›´æ”¹è®°å½•ä¸ºæŒ‰æ—¶é—´æ’åºçš„è®°å½•åºåˆ—ã€‚Kafkaå¯¹éå¸¸å¤§çš„å­˜å‚¨æ—¥å¿—æ•°æ®çš„æ”¯æŒä½¿å…¶æˆä¸ºä»¥è¿™ç§é£æ ¼æ„å»ºçš„åº”ç”¨ç¨‹åºçš„å‡ºè‰²åç«¯ã€‚</p><h3 id="2-7-æäº¤æ—¥å¿—"><a href="#2-7-æäº¤æ—¥å¿—" class="headerlink" title="2.7 æäº¤æ—¥å¿—"></a><strong>2.7 æäº¤æ—¥å¿—</strong></h3><p>ã€€ã€€<strong>Kafkaå¯ä»¥ä½œä¸ºåˆ†å¸ƒå¼ç³»ç»Ÿçš„ä¸€ç§å¤–éƒ¨æäº¤æ—¥å¿—</strong>ã€‚è¯¥æ—¥å¿—æœ‰åŠ©äºåœ¨èŠ‚ç‚¹ä¹‹é—´å¤åˆ¶æ•°æ®ï¼Œå¹¶å……å½“æ•…éšœèŠ‚ç‚¹æ¢å¤å…¶æ•°æ®çš„é‡æ–°åŒæ­¥æœºåˆ¶ã€‚Kafkaä¸­çš„æ—¥å¿—å‹ç¼©åŠŸèƒ½æœ‰åŠ©äºæ”¯æŒæ­¤ç”¨æ³•ã€‚åœ¨è¿™ç§ç”¨æ³•ä¸­ï¼ŒKafkaç±»ä¼¼äº<a href="https://bookkeeper.apache.org/" target="_blank" rel="noopener">Apache BookKeeper</a>é¡¹ç›®ã€‚</p><h2 id="3ã€kafkaå®‰è£…"><a href="#3ã€kafkaå®‰è£…" class="headerlink" title="3ã€kafkaå®‰è£…"></a><strong>3ã€kafkaå®‰è£…</strong></h2><h3 id="3-1-ä¸‹è½½å®‰è£…"><a href="#3-1-ä¸‹è½½å®‰è£…" class="headerlink" title="3.1 ä¸‹è½½å®‰è£…"></a><strong>3.1 ä¸‹è½½å®‰è£…</strong></h3><p>åˆ°å®˜ç½‘<a href="http://kafka.apache.org/downloads.html" target="_blank" rel="noopener">http://kafka.apache.org/downloads.html</a>ä¸‹è½½æƒ³è¦çš„ç‰ˆæœ¬ï¼›æˆ‘è¿™é‡Œä¸‹è½½çš„æœ€æ–°ç¨³å®šç‰ˆ2.1.0</p><p>æ³¨ï¼šç”±äºKafkaæ§åˆ¶å°è„šæœ¬å¯¹äºåŸºäºUnixå’ŒWindowsçš„å¹³å°æ˜¯ä¸åŒçš„ï¼Œå› æ­¤åœ¨Windowså¹³å°ä¸Šä½¿ç”¨bin\windows\ è€Œä¸æ˜¯bin/ å°†è„šæœ¬æ‰©å±•åæ›´æ”¹ä¸º.batã€‚</p><pre><code>[root@along ~]# wget http://mirrors.shu.edu.cn/apache/kafka/2.1.0/kafka_2.11-2.1.0.tgz[root@along ~]# tar -C /data/ -xvf kafka_2.11-2.1.0.tgz[root@along ~]# cd /data/kafka_2.11-2.1.0/</code></pre><p>ã€€ã€€</p><h3 id="3-2-é…ç½®å¯åŠ¨zookeeper"><a href="#3-2-é…ç½®å¯åŠ¨zookeeper" class="headerlink" title="3.2 é…ç½®å¯åŠ¨zookeeper"></a><strong>3.2 é…ç½®å¯åŠ¨zookeeper</strong></h3><p>ã€€ã€€kafkaæ­£å¸¸è¿è¡Œï¼Œå¿…é¡»é…ç½®zookeeperï¼Œå¦åˆ™æ— è®ºæ˜¯kafkaé›†ç¾¤è¿˜æ˜¯å®¢æˆ·ç«¯çš„ç”Ÿå­˜è€…å’Œæ¶ˆè´¹è€…éƒ½æ— æ³•æ­£å¸¸çš„å·¥ä½œçš„ï¼›æ‰€ä»¥éœ€è¦é…ç½®å¯åŠ¨zookeeperæœåŠ¡ã€‚</p><p>ï¼ˆ1ï¼‰zookeeperéœ€è¦javaç¯å¢ƒ</p><pre><code>[root@along ~]# yum -y install java-1.8.0</code></pre><p>ï¼ˆ2ï¼‰è¿™é‡Œkafkaä¸‹è½½åŒ…å·²ç»åŒ…æ‹¬zookeeperæœåŠ¡ï¼Œæ‰€ä»¥åªéœ€ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œå¯åŠ¨å³å¯ã€‚</p><p>å¦‚æœéœ€è¦ä¸‹è½½æŒ‡å®šzookeeperç‰ˆæœ¬ï¼›å¯ä»¥å•ç‹¬å»zookeeperå®˜ç½‘<a href="http://mirrors.shu.edu.cn/apache/zookeeper/" target="_blank" rel="noopener">http://mirrors.shu.edu.cn/apache/zookeeper/</a>ä¸‹è½½æŒ‡å®šç‰ˆæœ¬ã€‚</p><pre><code>[root@along ~]# cd /data/kafka_2.11-2.1.0/[root@along kafka_2.11-2.1.0]# grep &quot;^[^#]&quot; config/zookeeper.properties dataDir=/tmp/zookeeper        #æ•°æ®å­˜å‚¨ç›®å½•clientPort=2181               #zookeeperç«¯å£maxClientCnxns=0</code></pre><p>æ³¨ï¼šå¯è‡ªè¡Œæ·»åŠ ä¿®æ”¹zookeeperé…ç½®</p><h3 id="3-3-é…ç½®kafka"><a href="#3-3-é…ç½®kafka" class="headerlink" title="3.3 é…ç½®kafka"></a><strong>3.3 é…ç½®kafka</strong></h3><p>ï¼ˆ1ï¼‰ä¿®æ”¹é…ç½®æ–‡ä»¶</p><pre><code>[root@along kafka_2.11-2.1.0]# grep &quot;^[^#]&quot; config/server.properties broker.id=0 listeners=PLAINTEXT://localhost:9092num.network.threads=3 num.io.threads=8socket.send.buffer.bytes=102400socket.receive.buffer.bytes=102400socket.request.max.bytes=104857600log.dirs=/tmp/kafka-logsnum.partitions=1num.recovery.threads.per.data.dir=1offsets.topic.replication.factor=1transaction.state.log.replication.factor=1transaction.state.log.min.isr=1log.retention.hours=168log.segment.bytes=1073741824log.retention.check.interval.ms=300000zookeeper.connect=localhost:2181zookeeper.connection.timeout.ms=6000group.initial.rebalance.delay.ms=0</code></pre><p>æ³¨ï¼šå¯æ ¹æ®è‡ªå·±éœ€æ±‚ä¿®æ”¹é…ç½®æ–‡ä»¶</p><ul><li>broker.idï¼šå”¯ä¸€æ ‡è¯†ID</li><li>listeners=PLAINTEXT://localhost:9092ï¼škafkaæœåŠ¡ç›‘å¬åœ°å€å’Œç«¯å£</li><li>log.dirsï¼šæ—¥å¿—å­˜å‚¨ç›®å½•</li><li>zookeeper.connectï¼šæŒ‡å®šzookeeperæœåŠ¡</li></ul><p>ï¼ˆ2ï¼‰é…ç½®ç¯å¢ƒå˜é‡</p><pre><code>[root@along ~]# vim /etc/profile.d/kafka.shexport KAFKA_HOME=&quot;/data/kafka_2.11-2.1.0&quot;export PATH=&quot;${KAFKA_HOME}/bin:$PATH&quot;[root@along ~]# source /etc/profile.d/kafka.sh</code></pre><p>ã€€ã€€</p><p>ï¼ˆ3ï¼‰é…ç½®æœåŠ¡å¯åŠ¨è„šæœ¬</p><pre class=" language-shell"><code class="language-shell">[root@along ~]# vim /etc/init.d/kafka#!/bin/sh## chkconfig: 345 99 01# description: Kafka## File : Kafka## Description: Starts and stops the Kafka server# source /etc/rc.d/init.d/functions KAFKA_HOME=/data/kafka_2.11-2.1.0KAFKA_USER=rootexport LOG_DIR=/tmp/kafka-logs [ -e /etc/sysconfig/kafka ] && . /etc/sysconfig/kafka # See how we were called.case "$1" in  start)    echo -n "Starting Kafka:"    /sbin/runuser -s /bin/sh $KAFKA_USER -c "nohup $KAFKA_HOME/bin/kafka-server-start.sh $KAFKA_HOME/config/server.properties > $LOG_DIR/server.out 2> $LOG_DIR/server.err &"    echo " done."    exit 0    ;;  stop)    echo -n "Stopping Kafka: "    /sbin/runuser -s /bin/sh $KAFKA_USER  -c "ps -ef | grep kafka.Kafka | grep -v grep | awk '{print \$2}' | xargs kill"    echo " done."    exit 0    ;;  hardstop)    echo -n "Stopping (hard) Kafka: "    /sbin/runuser -s /bin/sh $KAFKA_USER  -c "ps -ef | grep kafka.Kafka | grep -v grep | awk '{print \$2}' | xargs kill -9"    echo " done."    exit 0    ;;  status)    c_pid=`ps -ef | grep kafka.Kafka | grep -v grep | awk '{print $2}'`    if [ "$c_pid" = "" ] ; then      echo "Stopped"      exit 3    else      echo "Running $c_pid"      exit 0    fi    ;;  restart)    stop    start    ;;  *)    echo "Usage: kafka {start|stop|hardstop|status|restart}"    exit 1    ;;esac</code></pre><p>ã€€chmod +x kafka </p><p>â€‹    chkconfig â€“add kafka  æ·»åŠ åˆ°æœåŠ¡å™¨ä¸­</p><p>â€‹    chkconfig kafka on è®¾ç½®å¼€æœºè‡ªåŠ¨å¯åŠ¨ã€€</p><h3 id="3-4-å¯åŠ¨kafkaæœåŠ¡"><a href="#3-4-å¯åŠ¨kafkaæœåŠ¡" class="headerlink" title="3.4 å¯åŠ¨kafkaæœåŠ¡"></a><strong>3.4 å¯åŠ¨kafkaæœåŠ¡</strong></h3><p>ï¼ˆ1ï¼‰åå°å¯åŠ¨zookeeperæœåŠ¡</p><pre class=" language-shell"><code class="language-shell">[root@along ~]# nohup zookeeper-server-start.sh /data/kafka_2.11-2.1.0/config/zookeeper.properties &</code></pre><p>ï¼ˆ2ï¼‰å¯åŠ¨kafkaæœåŠ¡</p><pre class=" language-shell"><code class="language-shell">[root@along ~]# service kafka startStarting kafka (via systemctl):                            [  OK  ][root@along ~]# service kafka statusRunning 86018[root@along ~]# ss -nutlNetid State      Recv-Q Send-Q     Local Address:Port                    Peer Address:Port                              tcp   LISTEN     0      50                    :::9092                              :::*                 tcp   LISTEN     0      50                    :::2181                              :::*</code></pre><p>ã€€ã€€</p><h2 id="4ã€kafkaä½¿ç”¨ç®€å•å…¥é—¨"><a href="#4ã€kafkaä½¿ç”¨ç®€å•å…¥é—¨" class="headerlink" title="4ã€kafkaä½¿ç”¨ç®€å•å…¥é—¨"></a><strong>4ã€kafkaä½¿ç”¨ç®€å•å…¥é—¨</strong></h2><h3 id="4-1-åˆ›å»ºä¸»é¢˜topics"><a href="#4-1-åˆ›å»ºä¸»é¢˜topics" class="headerlink" title="4.1 åˆ›å»ºä¸»é¢˜topics"></a><strong>4.1 åˆ›å»ºä¸»é¢˜topics</strong></h3><p>åˆ›å»ºä¸€ä¸ªåä¸ºâ€œalongâ€çš„ä¸»é¢˜ï¼Œå®ƒåªåŒ…å«ä¸€ä¸ªåˆ†åŒºï¼Œåªæœ‰ä¸€ä¸ªå‰¯æœ¬ï¼š</p><pre class=" language-shell"><code class="language-shell">[root@along ~]# kafka-topics.sh --create --zookeeper localhost:2181 --replication-factor 1 --partitions 1 --topic along Created topic "along".</code></pre><p>å¦‚æœæˆ‘ä»¬è¿è¡Œlist topicå‘½ä»¤ï¼Œæˆ‘ä»¬ç°åœ¨å¯ä»¥çœ‹åˆ°è¯¥ä¸»é¢˜ï¼š</p><pre class=" language-shell"><code class="language-shell">[root@along ~]# kafka-topics.sh --list --zookeeper localhost:2181 along</code></pre><p>ã€€ã€€</p><h3 id="4-2-å‘é€ä¸€äº›æ¶ˆæ¯"><a href="#4-2-å‘é€ä¸€äº›æ¶ˆæ¯" class="headerlink" title="4.2 å‘é€ä¸€äº›æ¶ˆæ¯"></a><strong>4.2 å‘é€ä¸€äº›æ¶ˆæ¯</strong></h3><p>Kafkaé™„å¸¦ä¸€ä¸ªå‘½ä»¤è¡Œå®¢æˆ·ç«¯ï¼Œå®ƒå°†ä»æ–‡ä»¶æˆ–æ ‡å‡†è¾“å…¥ä¸­è·å–è¾“å…¥ï¼Œå¹¶å°†å…¶ä½œä¸ºæ¶ˆæ¯å‘é€åˆ°Kafkaé›†ç¾¤ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œæ¯è¡Œå°†ä½œä¸ºå•ç‹¬çš„æ¶ˆæ¯å‘é€ã€‚</p><p>è¿è¡Œç”Ÿäº§è€…ï¼Œç„¶ååœ¨æ§åˆ¶å°ä¸­é”®å…¥ä¸€äº›æ¶ˆæ¯ä»¥å‘é€åˆ°æœåŠ¡å™¨ã€‚</p><pre><code>[root@along ~]# kafka-console-producer.sh --broker-list localhost:9092 --topic along&gt;This is a message&gt;This is another message</code></pre><p>ã€€ã€€</p><h3 id="4-3-å¯åŠ¨æ¶ˆè´¹è€…"><a href="#4-3-å¯åŠ¨æ¶ˆè´¹è€…" class="headerlink" title="4.3 å¯åŠ¨æ¶ˆè´¹è€…"></a><strong>4.3 å¯åŠ¨æ¶ˆè´¹è€…</strong></h3><p>Kafkaè¿˜æœ‰ä¸€ä¸ªå‘½ä»¤è¡Œä½¿ç”¨è€…ï¼Œå®ƒä¼šå°†æ¶ˆæ¯è½¬å‚¨åˆ°æ ‡å‡†è¾“å‡ºã€‚</p><pre><code>[root@along ~]# kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic along --from-beginning This is a message This is another message</code></pre><p>æ‰€æœ‰å‘½ä»¤è¡Œå·¥å…·éƒ½æœ‰å…¶ä»–é€‰é¡¹; è¿è¡Œä¸å¸¦å‚æ•°çš„å‘½ä»¤å°†æ˜¾ç¤ºæ›´è¯¦ç»†åœ°è®°å½•å®ƒä»¬çš„ä½¿ç”¨ä¿¡æ¯ã€‚</p><h2 id="5ã€è®¾ç½®å¤šä»£ç†kafkaç¾¤é›†"><a href="#5ã€è®¾ç½®å¤šä»£ç†kafkaç¾¤é›†" class="headerlink" title="5ã€è®¾ç½®å¤šä»£ç†kafkaç¾¤é›†"></a><strong>5ã€è®¾ç½®å¤šä»£ç†kafkaç¾¤é›†</strong></h2><p>ã€€ã€€åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬ä¸€ç›´åœ¨ä¸ä¸€ä¸ªbrokerè¿è¡Œï¼Œä½†è¿™å¹¶ä¸å¥½ç©ã€‚å¯¹äºKafkaï¼Œå•ä¸ªä»£ç†åªæ˜¯ä¸€ä¸ªå¤§å°ä¸º1çš„é›†ç¾¤ï¼Œå› æ­¤é™¤äº†å¯åŠ¨ä¸€äº›ä»£ç†å®ä¾‹ä¹‹å¤–æ²¡æœ‰å¤ªå¤šå˜åŒ–ã€‚ä½†æ˜¯ä¸ºäº†æ„Ÿå—å®ƒï¼Œè®©æˆ‘ä»¬å°†æˆ‘ä»¬çš„é›†ç¾¤æ‰©å±•åˆ°ä¸‰ä¸ªèŠ‚ç‚¹ï¼ˆä»ç„¶åœ¨æˆ‘ä»¬çš„æœ¬åœ°æœºå™¨ä¸Šï¼‰ã€‚</p><h3 id="5-1-å‡†å¤‡é…ç½®æ–‡ä»¶"><a href="#5-1-å‡†å¤‡é…ç½®æ–‡ä»¶" class="headerlink" title="5.1 å‡†å¤‡é…ç½®æ–‡ä»¶"></a><strong>5.1 å‡†å¤‡é…ç½®æ–‡ä»¶</strong></h3><pre class=" language-shell"><code class="language-shell">[root@along kafka_2.11-2.1.0]# cd /data/kafka_2.11-2.1.0/[root@along kafka_2.11-2.1.0]# cp config/server.properties config/server-1.properties[root@along kafka_2.11-2.1.0]# cp config/server.properties config/server-2.properties[root@along kafka_2.11-2.1.0]# vim config/server-1.properties    broker.id=1    listeners=PLAINTEXT://:9093log.dirs=/tmp/kafka-logs-1[root@along kafka_2.11-2.1.0]# vim config/server-2.propertiesbroker.id=2listeners=PLAINTEXT://:9094log.dirs=/tmp/kafka-logs-2</code></pre><p>æ³¨ï¼šè¯¥<strong>broker.id</strong> å±æ€§æ˜¯ç¾¤é›†ä¸­æ¯ä¸ªèŠ‚ç‚¹çš„<strong>å”¯ä¸€</strong>ä¸”æ°¸ä¹…çš„åç§°ã€‚æˆ‘ä»¬å¿…é¡»è¦†ç›–ç«¯å£å’Œæ—¥å¿—ç›®å½•ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨åŒä¸€å°æœºå™¨ä¸Šè¿è¡Œè¿™äº›ï¼Œå¹¶ä¸”æˆ‘ä»¬å¸Œæœ›è®©æ‰€æœ‰ä»£ç†å°è¯•åœ¨åŒä¸€ç«¯å£ä¸Šæ³¨å†Œæˆ–è¦†ç›–å½¼æ­¤çš„æ•°æ®ã€‚</p><h3 id="5-2-å¼€å¯é›†ç¾¤å¦2ä¸ªkafkaæœåŠ¡"><a href="#5-2-å¼€å¯é›†ç¾¤å¦2ä¸ªkafkaæœåŠ¡" class="headerlink" title="5.2 å¼€å¯é›†ç¾¤å¦2ä¸ªkafkaæœåŠ¡"></a><strong>5.2 å¼€å¯é›†ç¾¤å¦2ä¸ªkafkaæœåŠ¡</strong></h3><pre><code>[root@along ~]# nohup kafka-server-start.sh /data/kafka_2.11-2.1.0/config/server-1.properties &amp;[root@along ~]# nohup kafka-server-start.sh /data/kafka_2.11-2.1.0/config/server-2.properties &amp;[root@along ~]# ss -nutlNetid State      Recv-Q Send-Q     Local Address:Port                    Peer Address:Port                          tcp   LISTEN     0      50      ::ffff:127.0.0.1:9092                              :::*                 tcp   LISTEN     0      50      ::ffff:127.0.0.1:9093                              :::*                                tcp   LISTEN     0      50      ::ffff:127.0.0.1:9094                              :::*</code></pre><p>ã€€ã€€</p><h3 id="5-3-åœ¨é›†ç¾¤ä¸­è¿›è¡Œæ“ä½œ"><a href="#5-3-åœ¨é›†ç¾¤ä¸­è¿›è¡Œæ“ä½œ" class="headerlink" title="5.3 åœ¨é›†ç¾¤ä¸­è¿›è¡Œæ“ä½œ"></a><strong>5.3 åœ¨é›†ç¾¤ä¸­è¿›è¡Œæ“ä½œ</strong></h3><p>ï¼ˆ1ï¼‰ç°åœ¨åˆ›å»ºä¸€ä¸ªå¤åˆ¶å› å­ä¸º3çš„æ–°ä¸»é¢˜my-replicated-topic</p><pre><code>[root@along ~]# kafka-topics.sh --create --zookeeper localhost:2181 --replication-factor 3 --partitions 1 --topic my-replicated-topic Created topic &quot;my-replicated-topic&quot;.</code></pre><p>ã€€ã€€</p><p>ï¼ˆ2ï¼‰åœ¨ä¸€ä¸ªé›†ç¾¤ä¸­ï¼Œè¿è¡Œâ€œdescribe topicsâ€å‘½ä»¤æŸ¥çœ‹å“ªä¸ªbrokeræ­£åœ¨åšä»€ä¹ˆ</p><pre><code>[root@along ~]# kafka-topics.sh --describe --zookeeper localhost:2181 --topic my-replicated-topic Topic:my-replicated-topic   PartitionCount:1    ReplicationFactor:3 Configs:Topic: my-replicated-topic  Partition: 0    Leader: 2   Replicas: 2,0,1 Isr: 2,0,1</code></pre><p>æ³¨é‡Šï¼šç¬¬ä¸€è¡Œç»™å‡ºäº†æ‰€æœ‰åˆ†åŒºçš„æ‘˜è¦ï¼Œæ¯ä¸ªé™„åŠ è¡Œæä¾›æœ‰å…³ä¸€ä¸ªåˆ†åŒºçš„ä¿¡æ¯ã€‚ç”±äºæˆ‘ä»¬åªæœ‰ä¸€ä¸ªåˆ†åŒºç”¨äºæ­¤ä¸»é¢˜ï¼Œå› æ­¤åªæœ‰ä¸€è¡Œã€‚</p><ul><li>â€œleaderâ€æ˜¯è´Ÿè´£ç»™å®šåˆ†åŒºçš„æ‰€æœ‰è¯»å–å’Œå†™å…¥çš„èŠ‚ç‚¹ã€‚æ¯ä¸ªèŠ‚ç‚¹å°†æˆä¸ºéšæœºé€‰æ‹©çš„åˆ†åŒºéƒ¨åˆ†çš„é¢†å¯¼è€…ã€‚</li><li>â€œreplicasâ€æ˜¯å¤åˆ¶æ­¤åˆ†åŒºæ—¥å¿—çš„èŠ‚ç‚¹åˆ—è¡¨ï¼Œæ— è®ºå®ƒä»¬æ˜¯å¦ä¸ºé¢†å¯¼è€…ï¼Œæˆ–è€…å³ä½¿å®ƒä»¬å½“å‰å¤„äºæ´»åŠ¨çŠ¶æ€ã€‚</li><li>â€œisrâ€æ˜¯â€œåŒæ­¥â€å¤åˆ¶å“çš„é›†åˆã€‚è¿™æ˜¯å‰¯æœ¬åˆ—è¡¨çš„å­é›†ï¼Œè¯¥åˆ—è¡¨å½“å‰å¤„äºæ´»è·ƒçŠ¶æ€å¹¶ä¸”å·²ç»è¢«é¢†å¯¼è€…æ•è·ã€‚</li></ul><p>è¯·æ³¨æ„ï¼ŒLeader: 2ï¼Œåœ¨æˆ‘çš„ç¤ºä¾‹ä¸­ï¼ŒèŠ‚ç‚¹2 æ˜¯è¯¥ä¸»é¢˜çš„å”¯ä¸€åˆ†åŒºçš„Leaderã€‚</p><p>ï¼ˆ3ï¼‰å¯ä»¥åœ¨æˆ‘ä»¬åˆ›å»ºçš„åŸå§‹ä¸»é¢˜ä¸Šè¿è¡Œç›¸åŒçš„å‘½ä»¤ï¼Œä»¥æŸ¥çœ‹å®ƒçš„ä½ç½®</p><pre><code>[root@along ~]# kafka-topics.sh --describe --zookeeper localhost:2181 --topic along Topic:along PartitionCount:1    ReplicationFactor:1 Configs:   Topic: along    Partition: 0    Leader: 0   Replicas: 0 Isr: 0</code></pre><p>ã€€ã€€</p><p>ï¼ˆ4ï¼‰å‘æˆ‘ä»¬çš„æ–°ä¸»é¢˜å‘å¸ƒä¸€äº›æ¶ˆæ¯ï¼š</p><pre><code>[root@along ~]# kafka-console-producer.sh --broker-list localhost:9092 --topic my-replicated-topic&gt;my test message 1&gt;my test message 2&gt;^C</code></pre><p>ã€€ã€€</p><p>ï¼ˆ5ï¼‰ç°åœ¨è®©æˆ‘ä»¬ä½¿ç”¨è¿™äº›æ¶ˆæ¯ï¼š</p><pre><code>[root@along ~]# kafka-console-consumer.sh --bootstrap-server localhost:9092 --from-beginning --topic my-replicated-topicmy test message 1my test message 2</code></pre><p>ã€€ã€€</p><h3 id="5-4-æµ‹è¯•é›†ç¾¤çš„å®¹é”™æ€§"><a href="#5-4-æµ‹è¯•é›†ç¾¤çš„å®¹é”™æ€§" class="headerlink" title="5.4 æµ‹è¯•é›†ç¾¤çš„å®¹é”™æ€§"></a><strong>5.4 æµ‹è¯•é›†ç¾¤çš„å®¹é”™æ€§</strong></h3><p>ï¼ˆ1ï¼‰ç°åœ¨è®©æˆ‘ä»¬æµ‹è¯•ä¸€ä¸‹å®¹é”™æ€§ã€‚Broker 2 å……å½“leader æ‰€ä»¥è®©æˆ‘ä»¬æ€äº†å®ƒï¼š</p><pre><code>[root@along ~]# ps aux | grep server-2.properties |awk &#39;{print $2}&#39;106737[root@along ~]# kill -9 106737[root@along ~]# ss -nutltcp   LISTEN     0      50      ::ffff:127.0.0.1:9092                              :::*                       tcp   LISTEN     0      50      ::ffff:127.0.0.1:9093                              :::*</code></pre><p>ã€€ã€€</p><p>ï¼ˆ2ï¼‰leader å·²åˆ‡æ¢åˆ°å…¶ä¸­ä¸€ä¸ªä»å±èŠ‚ç‚¹ï¼ŒèŠ‚ç‚¹2ä¸å†ä½äºåŒæ­¥å‰¯æœ¬é›†ä¸­ï¼š</p><pre><code>[root@along ~]# kafka-topics.sh --describe --zookeeper localhost:2181 --topic my-replicated-topic Topic:my-replicated-topic   PartitionCount:1    ReplicationFactor:3 Configs:    Topic: my-replicated-topic  Partition: 0    Leader: 0   Replicas: 2,0,1 Isr: 0,1</code></pre><p>ã€€ã€€</p><p>ï¼ˆ3ï¼‰å³ä½¿æœ€åˆæ¥å—å†™å…¥çš„leader å·²ç»å¤±è´¥ï¼Œè¿™äº›æ¶ˆæ¯ä»å¯ä¾›æ¶ˆè´¹ï¼š</p><pre><code>[root@along ~]# kafka-console-consumer.sh --bootstrap-server localhost:9092 --from-beginning --topic my-replicated-topicmy test message 1my test message 2</code></pre><p>ã€€ã€€</p><h2 id="6ã€-ä½¿ç”¨Kafka-Connectå¯¼å…¥-å¯¼å‡ºæ•°æ®"><a href="#6ã€-ä½¿ç”¨Kafka-Connectå¯¼å…¥-å¯¼å‡ºæ•°æ®" class="headerlink" title="6ã€**ä½¿ç”¨Kafka Connectå¯¼å…¥/å¯¼å‡ºæ•°æ®**"></a><strong>6ã€**</strong>ä½¿ç”¨Kafka Connectå¯¼å…¥/å¯¼å‡ºæ•°æ®**</h2><p>ã€€ã€€ä»æ§åˆ¶å°å†™å…¥æ•°æ®å¹¶å°†å…¶å†™å›æ§åˆ¶å°æ˜¯ä¸€ä¸ªæ–¹ä¾¿çš„èµ·ç‚¹ï¼Œä½†æœ‰æ—¶å€™å¯èƒ½å¸Œæœ›ä½¿ç”¨<strong>å…¶ä»–æ¥æºçš„æ•°æ®æˆ–å°†æ•°æ®ä»Kafkaå¯¼å‡ºåˆ°å…¶ä»–ç³»ç»Ÿ</strong>ã€‚å¯¹äºè®¸å¤šç³»ç»Ÿï¼Œæ‚¨å¯ä»¥<strong>ä½¿ç”¨Kafka Connectå¯¼å…¥æˆ–å¯¼å‡ºæ•°æ®</strong>ï¼Œè€Œä¸æ˜¯ç¼–å†™è‡ªå®šä¹‰é›†æˆä»£ç ã€‚</p><p>ã€€ã€€<strong>Kafka Connectæ˜¯Kafkaé™„å¸¦çš„å·¥å…·ï¼Œç”¨äºå‘Kafkaå¯¼å…¥å’Œå¯¼å‡ºæ•°æ®</strong>ã€‚å®ƒæ˜¯ä¸€ä¸ªå¯æ‰©å±•çš„å·¥å…·ï¼Œè¿è¡Œè¿æ¥å™¨ï¼Œå®ç°ä¸å¤–éƒ¨ç³»ç»Ÿäº¤äº’çš„è‡ªå®šä¹‰é€»è¾‘ã€‚åœ¨æœ¬å¿«é€Ÿå…¥é—¨ä¸­ï¼Œæˆ‘ä»¬å°†äº†è§£å¦‚ä½•ä½¿ç”¨ç®€å•çš„è¿æ¥å™¨è¿è¡ŒKafka Connectï¼Œè¿™äº›è¿æ¥å™¨å°†æ•°æ®ä»æ–‡ä»¶å¯¼å…¥Kafkaä¸»é¢˜å¹¶å°†æ•°æ®ä»Kafkaä¸»é¢˜å¯¼å‡ºåˆ°æ–‡ä»¶ã€‚</p><p>ï¼ˆ1ï¼‰é¦–å…ˆåˆ›å»ºä¸€äº›ç§å­æ•°æ®è¿›è¡Œæµ‹è¯•ï¼š</p><pre><code>[root@along ~]# echo -e &quot;foo\nbar&quot; &gt; test.txt</code></pre><p>æˆ–è€…åœ¨Windowsä¸Šï¼š</p><pre><code>&gt; echo foo&gt; test.txt&gt; echo bar&gt;&gt; test.txt</code></pre><p>ã€€ã€€</p><p>ï¼ˆ2ï¼‰æ¥ä¸‹æ¥ï¼Œ<strong>å¯åŠ¨ä¸¤ä¸ªä»¥ç‹¬ç«‹æ¨¡å¼è¿è¡Œçš„è¿æ¥å™¨</strong>ï¼Œè¿™æ„å‘³ç€å®ƒä»¬åœ¨å•ä¸ªæœ¬åœ°ä¸“ç”¨è¿›ç¨‹ä¸­è¿è¡Œã€‚æä¾›ä¸‰ä¸ªé…ç½®æ–‡ä»¶ä½œä¸ºå‚æ•°ã€‚</p><ul><li>ç¬¬ä¸€ä¸ªå§‹ç»ˆæ˜¯Kafka Connectæµç¨‹çš„é…ç½®ï¼ŒåŒ…å«å¸¸è§é…ç½®ï¼Œä¾‹å¦‚è¦è¿æ¥çš„Kafkaä»£ç†å’Œæ•°æ®çš„åºåˆ—åŒ–æ ¼å¼ã€‚</li><li>å…¶ä½™é…ç½®æ–‡ä»¶å‡æŒ‡å®šè¦åˆ›å»ºçš„è¿æ¥å™¨ã€‚è¿™äº›æ–‡ä»¶åŒ…æ‹¬å”¯ä¸€çš„è¿æ¥å™¨åç§°ï¼Œè¦å®ä¾‹åŒ–çš„è¿æ¥å™¨ç±»ä»¥åŠè¿æ¥å™¨æ‰€éœ€çš„ä»»ä½•å…¶ä»–é…ç½®ã€‚</li></ul><pre><code>[root@along ~]# connect-standalone.sh config/connect-standalone.properties config/connect-file-source.properties config/connect-file-sink.properties[2019-01-16 16:16:31,884] INFO Kafka Connect standalone worker initializing ... (org.apache.kafka.connect.cli.ConnectStandalone:67)[2019-01-16 16:16:31,903] INFO WorkerInfo values:... ...</code></pre><p>ã€€ã€€æ³¨ï¼šKafkaé™„å¸¦çš„è¿™äº›ç¤ºä¾‹é…ç½®æ–‡ä»¶ä½¿ç”¨æ‚¨ä¹‹å‰å¯åŠ¨çš„é»˜è®¤æœ¬åœ°ç¾¤é›†é…ç½®å¹¶åˆ›å»ºä¸¤ä¸ªè¿æ¥å™¨ï¼šç¬¬ä¸€ä¸ªæ˜¯æºè¿æ¥å™¨ï¼Œå®ƒä»è¾“å…¥æ–‡ä»¶è¯»å–è¡Œå¹¶ç”Ÿæˆæ¯ä¸ªKafkaä¸»é¢˜ï¼Œç¬¬äºŒä¸ªæ˜¯å®¿è¿æ¥å™¨ä»Kafkaä¸»é¢˜è¯»å–æ¶ˆæ¯å¹¶å°†æ¯ä¸ªæ¶ˆæ¯ç”Ÿæˆä¸ºè¾“å‡ºæ–‡ä»¶ä¸­çš„ä¸€è¡Œã€‚</p><p>ï¼ˆ3ï¼‰éªŒè¯æ˜¯å¦å¯¼å…¥æˆåŠŸï¼ˆå¦èµ·ç»ˆç«¯ï¼‰</p><p>åœ¨å¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œæ‚¨å°†çœ‹åˆ°è®¸å¤šæ—¥å¿—æ¶ˆæ¯ï¼ŒåŒ…æ‹¬ä¸€äº›æŒ‡ç¤ºæ­£åœ¨å®ä¾‹åŒ–è¿æ¥å™¨çš„æ—¥å¿—æ¶ˆæ¯ã€‚</p><p>â‘  ä¸€æ—¦Kafka Connectè¿›ç¨‹å¯åŠ¨ï¼Œæºè¿æ¥å™¨åº”è¯¥å¼€å§‹ä»test.txtä¸»é¢˜è¯»å–è¡Œå¹¶å°†å…¶ç”Ÿæˆåˆ°ä¸»é¢˜connect-testï¼Œå¹¶ä¸”æ¥æ”¶å™¨è¿æ¥å™¨åº”è¯¥å¼€å§‹ä»ä¸»é¢˜è¯»å–æ¶ˆæ¯connect-test å¹¶å°†å®ƒä»¬å†™å…¥æ–‡ä»¶test.sink.txtã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡æ£€æŸ¥è¾“å‡ºæ–‡ä»¶çš„å†…å®¹æ¥éªŒè¯æ•°æ®æ˜¯å¦å·²é€šè¿‡æ•´ä¸ªç®¡é“ä¼ é€’ï¼š</p><pre><code>[root@along ~]# cat test.sink.txtfoobar</code></pre><p>ã€€ã€€</p><p>â‘¡ è¯·æ³¨æ„ï¼Œæ•°æ®å­˜å‚¨åœ¨Kafkaä¸»é¢˜ä¸­connect-testï¼Œå› æ­¤æˆ‘ä»¬è¿˜å¯ä»¥è¿è¡Œæ§åˆ¶å°ä½¿ç”¨è€…æ¥æŸ¥çœ‹ä¸»é¢˜ä¸­çš„æ•°æ®ï¼ˆæˆ–ä½¿ç”¨è‡ªå®šä¹‰ä½¿ç”¨è€…ä»£ç æ¥å¤„ç†å®ƒï¼‰ï¼š</p><pre><code>[root@along ~]# kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic connect-test --from-beginning{&quot;schema&quot;:{&quot;type&quot;:&quot;string&quot;,&quot;optional&quot;:false},&quot;payload&quot;:&quot;foo&quot;}{&quot;schema&quot;:{&quot;type&quot;:&quot;string&quot;,&quot;optional&quot;:false},&quot;payload&quot;:&quot;bar&quot;}</code></pre><p>ã€€ã€€</p><p>ï¼ˆ4ï¼‰ç»§ç»­è¿½åŠ æ•°æ®ï¼ŒéªŒè¯</p><pre><code>[root@along ~]# echo Another line&gt;&gt; test.txt   [root@along ~]# cat test.sink.txtfoobarAnother line[root@along ~]# kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic connect-test --from-beginning{&quot;schema&quot;:{&quot;type&quot;:&quot;string&quot;,&quot;optional&quot;:false},&quot;payload&quot;:&quot;foo&quot;}{&quot;schema&quot;:{&quot;type&quot;:&quot;string&quot;,&quot;optional&quot;:false},&quot;payload&quot;:&quot;bar&quot;}{&quot;schema&quot;:{&quot;type&quot;:&quot;string&quot;,&quot;optional&quot;:false},&quot;payload&quot;:&quot;Another line&quot;}</code></pre>]]></content>
      
      
      <categories>
          
          <category> SQL </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kafka </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>kafkaé›†ç¾¤æ­å»º</title>
      <link href="2019/04/26/sql/kafka-ji-qun-da-jian/"/>
      <url>2019/04/26/sql/kafka-ji-qun-da-jian/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h3 id="å¸¸ç”¨Message-Queueå¯¹æ¯”"><a href="#å¸¸ç”¨Message-Queueå¯¹æ¯”" class="headerlink" title="å¸¸ç”¨Message Queueå¯¹æ¯”"></a>å¸¸ç”¨Message Queueå¯¹æ¯”</h3><p><strong>RabbitMQ</strong></p><pre><code>RabbitMQæ˜¯ä½¿ç”¨Erlangç¼–å†™çš„ä¸€ä¸ªå¼€æºçš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæœ¬èº«æ”¯æŒå¾ˆå¤šçš„åè®®ï¼šAMQPï¼ŒXMPP, SMTP, STOMPï¼Œä¹Ÿæ­£å› å¦‚æ­¤ï¼Œå®ƒéå¸¸é‡é‡çº§ï¼Œæ›´é€‚åˆäºä¼ä¸šçº§çš„å¼€å‘ã€‚åŒæ—¶å®ç°äº†Brokeræ„æ¶ï¼Œè¿™æ„å‘³ç€æ¶ˆæ¯åœ¨å‘é€ç»™å®¢æˆ·ç«¯æ—¶å…ˆåœ¨ä¸­å¿ƒé˜Ÿåˆ—æ’é˜Ÿã€‚å¯¹è·¯ç”±ï¼Œè´Ÿè½½å‡è¡¡æˆ–è€…æ•°æ®æŒä¹…åŒ–éƒ½æœ‰å¾ˆå¥½çš„æ”¯æŒã€‚</code></pre><p><strong>Redis</strong></p><pre><code>Redisæ˜¯ä¸€ä¸ªåŸºäºKey-Valueå¯¹çš„NoSQLæ•°æ®åº“ï¼Œå¼€å‘ç»´æŠ¤å¾ˆæ´»è·ƒã€‚è™½ç„¶å®ƒæ˜¯ä¸€ä¸ªKey-Valueæ•°æ®åº“å­˜å‚¨ç³»ç»Ÿï¼Œä½†å®ƒæœ¬èº«æ”¯æŒMQåŠŸèƒ½ï¼Œæ‰€ä»¥å®Œå…¨å¯ä»¥å½“åšä¸€ä¸ªè½»é‡çº§çš„é˜Ÿåˆ—æœåŠ¡æ¥ä½¿ç”¨ã€‚å¯¹äºRabbitMQå’ŒRedisçš„å…¥é˜Ÿå’Œå‡ºé˜Ÿæ“ä½œï¼Œå„æ‰§è¡Œ100ä¸‡æ¬¡ï¼Œæ¯10ä¸‡æ¬¡è®°å½•ä¸€æ¬¡æ‰§è¡Œæ—¶é—´ã€‚æµ‹è¯•æ•°æ®åˆ†ä¸º128Bytesã€512Bytesã€1Kå’Œ10Kå››ä¸ªä¸åŒå¤§å°çš„æ•°æ®ã€‚å®éªŒè¡¨æ˜ï¼šå…¥é˜Ÿæ—¶ï¼Œå½“æ•°æ®æ¯”è¾ƒå°æ—¶Redisçš„æ€§èƒ½è¦é«˜äºRabbitMQï¼Œè€Œå¦‚æœæ•°æ®å¤§å°è¶…è¿‡äº†10Kï¼ŒRedisåˆ™æ…¢çš„æ— æ³•å¿å—ï¼›å‡ºé˜Ÿæ—¶ï¼Œæ— è®ºæ•°æ®å¤§å°ï¼ŒRediséƒ½è¡¨ç°å‡ºéå¸¸å¥½çš„æ€§èƒ½ï¼Œè€ŒRabbitMQçš„å‡ºé˜Ÿæ€§èƒ½åˆ™è¿œä½äºRedisã€‚</code></pre><p><strong>ZeroMQ</strong></p><pre><code>ZeroMQå·ç§°æœ€å¿«çš„æ¶ˆæ¯é˜Ÿåˆ—ç³»ç»Ÿï¼Œå°¤å…¶é’ˆå¯¹å¤§ååé‡çš„éœ€æ±‚åœºæ™¯ã€‚ZeroMQèƒ½å¤Ÿå®ç°RabbitMQä¸æ“…é•¿çš„é«˜çº§/å¤æ‚çš„é˜Ÿåˆ—ï¼Œä½†æ˜¯å¼€å‘äººå‘˜éœ€è¦è‡ªå·±ç»„åˆå¤šç§æŠ€æœ¯æ¡†æ¶ï¼ŒæŠ€æœ¯ä¸Šçš„å¤æ‚åº¦æ˜¯å¯¹è¿™MQèƒ½å¤Ÿåº”ç”¨æˆåŠŸçš„æŒ‘æˆ˜ã€‚ZeroMQå…·æœ‰ä¸€ä¸ªç‹¬ç‰¹çš„éä¸­é—´ä»¶çš„æ¨¡å¼ï¼Œä½ ä¸éœ€è¦å®‰è£…å’Œè¿è¡Œä¸€ä¸ªæ¶ˆæ¯æœåŠ¡å™¨æˆ–ä¸­é—´ä»¶ï¼Œå› ä¸ºä½ çš„åº”ç”¨ç¨‹åºå°†æ‰®æ¼”è¿™ä¸ªæœåŠ¡å™¨è§’è‰²ã€‚ä½ åªéœ€è¦ç®€å•çš„å¼•ç”¨ZeroMQç¨‹åºåº“ï¼Œå¯ä»¥ä½¿ç”¨NuGetå®‰è£…ï¼Œç„¶åä½ å°±å¯ä»¥æ„‰å¿«çš„åœ¨åº”ç”¨ç¨‹åºä¹‹é—´å‘é€æ¶ˆæ¯äº†ã€‚ä½†æ˜¯ZeroMQä»…æä¾›éæŒä¹…æ€§çš„é˜Ÿåˆ—ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœå®•æœºï¼Œæ•°æ®å°†ä¼šä¸¢å¤±ã€‚å…¶ä¸­ï¼ŒTwitterçš„Storm 0.9.0ä»¥å‰çš„ç‰ˆæœ¬ä¸­é»˜è®¤ä½¿ç”¨ZeroMQä½œä¸ºæ•°æ®æµçš„ä¼ è¾“ï¼ˆStormä»0.9ç‰ˆæœ¬å¼€å§‹åŒæ—¶æ”¯æŒZeroMQå’ŒNettyä½œä¸ºä¼ è¾“æ¨¡å—ï¼‰ã€‚</code></pre><p><strong>ActiveMQ</strong></p><pre><code>ActiveMQæ˜¯Apacheä¸‹çš„ä¸€ä¸ªå­é¡¹ç›®ã€‚ ç±»ä¼¼äºZeroMQï¼Œå®ƒèƒ½å¤Ÿä»¥ä»£ç†äººå’Œç‚¹å¯¹ç‚¹çš„æŠ€æœ¯å®ç°é˜Ÿåˆ—ã€‚åŒæ—¶ç±»ä¼¼äºRabbitMQï¼Œå®ƒå°‘é‡ä»£ç å°±å¯ä»¥é«˜æ•ˆåœ°å®ç°é«˜çº§åº”ç”¨åœºæ™¯ã€‚</code></pre><p><strong>Kafka/Jafka</strong></p><pre><code>Kafkaæ˜¯Apacheä¸‹çš„ä¸€ä¸ªå­é¡¹ç›®ï¼Œæ˜¯ä¸€ä¸ªé«˜æ€§èƒ½è·¨è¯­è¨€åˆ†å¸ƒå¼å‘å¸ƒ/è®¢é˜…æ¶ˆæ¯é˜Ÿåˆ—ç³»ç»Ÿï¼Œè€ŒJafkaæ˜¯åœ¨Kafkaä¹‹ä¸Šå­µåŒ–è€Œæ¥çš„ï¼Œå³Kafkaçš„ä¸€ä¸ªå‡çº§ç‰ˆã€‚å…·æœ‰ä»¥ä¸‹ç‰¹æ€§ï¼šå¿«é€ŸæŒä¹…åŒ–ï¼Œå¯ä»¥åœ¨O(1)çš„ç³»ç»Ÿå¼€é”€ä¸‹è¿›è¡Œæ¶ˆæ¯æŒä¹…åŒ–ï¼›é«˜ååï¼Œåœ¨ä¸€å°æ™®é€šçš„æœåŠ¡å™¨ä¸Šæ—¢å¯ä»¥è¾¾åˆ°10W/sçš„ååé€Ÿç‡ï¼›å®Œå…¨çš„åˆ†å¸ƒå¼ç³»ç»Ÿï¼ŒBrokerã€Producerã€Consumeréƒ½åŸç”Ÿè‡ªåŠ¨æ”¯æŒåˆ†å¸ƒå¼ï¼Œè‡ªåŠ¨å®ç°è´Ÿè½½å‡è¡¡ï¼›æ”¯æŒHadoopæ•°æ®å¹¶è¡ŒåŠ è½½ï¼Œå¯¹äºåƒHadoopçš„ä¸€æ ·çš„æ—¥å¿—æ•°æ®å’Œç¦»çº¿åˆ†æç³»ç»Ÿï¼Œä½†åˆè¦æ±‚å®æ—¶å¤„ç†çš„é™åˆ¶ï¼Œè¿™æ˜¯ä¸€ä¸ªå¯è¡Œçš„è§£å†³æ–¹æ¡ˆã€‚Kafkaé€šè¿‡Hadoopçš„å¹¶è¡ŒåŠ è½½æœºåˆ¶ç»Ÿä¸€äº†åœ¨çº¿å’Œç¦»çº¿çš„æ¶ˆæ¯å¤„ç†ã€‚Apache Kafkaç›¸å¯¹äºActiveMQæ˜¯ä¸€ä¸ªéå¸¸è½»é‡çº§çš„æ¶ˆæ¯ç³»ç»Ÿï¼Œé™¤äº†æ€§èƒ½éå¸¸å¥½ä¹‹å¤–ï¼Œè¿˜æ˜¯ä¸€ä¸ªå·¥ä½œè‰¯å¥½çš„åˆ†å¸ƒå¼ç³»ç»Ÿ</code></pre><h3 id="ç›¸å…³æ¦‚å¿µ"><a href="#ç›¸å…³æ¦‚å¿µ" class="headerlink" title="ç›¸å…³æ¦‚å¿µ"></a>ç›¸å…³æ¦‚å¿µ</h3><p>producerï¼š æ¶ˆæ¯ç”Ÿäº§è€…ï¼Œå‘å¸ƒæ¶ˆæ¯åˆ° kafka é›†ç¾¤çš„ç»ˆç«¯æˆ–æœåŠ¡ã€‚<br>brokerï¼š kafka é›†ç¾¤ä¸­åŒ…å«çš„æœåŠ¡å™¨ã€‚<br>topicï¼šæ¯æ¡å‘å¸ƒåˆ° kafka é›†ç¾¤çš„æ¶ˆæ¯å±äºçš„ç±»åˆ«ï¼Œå³ kafka æ˜¯é¢å‘ topic çš„ã€‚<br>partitionï¼š partition æ˜¯ç‰©ç†ä¸Šçš„æ¦‚å¿µï¼Œæ¯ä¸ª topic åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ª partitionã€‚kafka åˆ†é…çš„å•ä½æ˜¯ partitionã€‚<br>consumerï¼š ä» kafka é›†ç¾¤ä¸­æ¶ˆè´¹æ¶ˆæ¯çš„ç»ˆç«¯æˆ–æœåŠ¡ã€‚<br>Consumer groupï¼š high-level consumer API ä¸­ï¼Œæ¯ä¸ª consumer éƒ½å±äºä¸€ä¸ª consumer groupï¼Œæ¯æ¡æ¶ˆæ¯åªèƒ½è¢« consumer group ä¸­çš„ä¸€ä¸ª Consumer æ¶ˆè´¹ï¼Œä½†å¯ä»¥è¢«å¤šä¸ª consumer group æ¶ˆè´¹ã€‚<br>replicaï¼š partition çš„å‰¯æœ¬ï¼Œä¿éšœ partition çš„é«˜å¯ç”¨ã€‚<br>leaderï¼š replica ä¸­çš„ä¸€ä¸ªè§’è‰²ï¼Œ producer å’Œ consumer åªè·Ÿ leader äº¤äº’ã€‚<br>followerï¼š replica ä¸­çš„ä¸€ä¸ªè§’è‰²ï¼Œä» leader ä¸­å¤åˆ¶æ•°æ®ã€‚<br>controllerï¼š kafka é›†ç¾¤ä¸­çš„å…¶ä¸­ä¸€ä¸ªæœåŠ¡å™¨ï¼Œç”¨æ¥è¿›è¡Œ leader election ä»¥åŠ å„ç§ failoverã€‚<br>zookeeperï¼š kafka é€šè¿‡ zookeeper æ¥å­˜å‚¨é›†ç¾¤çš„ meta ä¿¡æ¯</p><h3 id="å•å®ä¾‹Kafka"><a href="#å•å®ä¾‹Kafka" class="headerlink" title="å•å®ä¾‹Kafka"></a>å•å®ä¾‹Kafka</h3><p>å‰ææ¡ä»¶ï¼šå®‰è£…JDKã€è®¾ç½®JAVA_HOMEã€PATHç¯å¢ƒå˜é‡ã€‚</p><p>wget <a href="http://mirrors.hust.edu.cn/apache/kafka/1.1.0/kafka_2.12-1.1.0.tgz" target="_blank" rel="noopener">http://mirrors.hust.edu.cn/apache/kafka/1.1.0/kafka_2.12-1.1.0.tgz</a></p><h4 id="1-Terminal-A"><a href="#1-Terminal-A" class="headerlink" title="(1) Terminal A"></a>(1) Terminal A</h4><pre class=" language-shell"><code class="language-shell">[root@sdopenswan-jp ~]# lsconfigserver.sh  kafka_2.12-0.10.2.1.tgz[root@sdopenswan-jp ~]# tar xfz kafka_2.12-0.10.2.1.tgz[root@sdopenswan-jp ~]# lsconfigserver.sh  kafka_2.12-0.10.2.1  kafka_2.12-0.10.2.1.tgz[root@sdopenswan-jp ~]# cd kafka_2.12-0.10.2.1[root@sdopenswan-jp kafka_2.12-0.10.2.1]# vim config/zookeeper.properties[root@sdopenswan-jp kafka_2.12-0.10.2.1]# grep -Pv "^#" config/zookeeper.propertiesdataDir=zkdata1clientPort=2181maxClientCnxns=0[root@sdopenswan-jp kafka_2.12-0.10.2.1]# bin/zookeeper-server-start.sh config/zookeeper.properties &      #å¯åŠ¨zookeeper[root@sdopenswan-jp kafka_2.12-0.10.2.1]# lsbin  config  libs  LICENSE  logs  NOTICE  site-docs  zkdata1[root@sdopenswan-jp kafka_2.12-0.10.2.1]# ls zkdata1/version-2[root@sdopenswan-jp kafka_2.12-0.10.2.1]# vim config/server.properties[root@sdopenswan-jp kafka_2.12-0.10.2.1]# grep -Pv "^($|#)" config/server.propertiesbroker.id=0listeners=PLAINTEXT://:9092num.network.threads=3num.io.threads=8socket.send.buffer.bytes=102400socket.receive.buffer.bytes=102400socket.request.max.bytes=104857600log.dirs=kfkdata1num.partitions=1num.recovery.threads.per.data.dir=1log.retention.hours=168log.segment.bytes=1073741824log.retention.check.interval.ms=300000zookeeper.connect=localhost:2181zookeeper.connection.timeout.ms=6000[root@sdopenswan-jp kafka_2.12-0.10.2.1]# bin/kafka-server-start.sh config/server.properties[root@sdopenswan-jp kafka_2.12-0.10.2.1]# lsbin  config  kfkdata1  libs  LICENSE  logs  NOTICE  site-docs  zkdata1[root@sdopenswan-jp kafka_2.12-0.10.2.1]# ls kfkdata1/cleaner-offset-checkpoint  meta.properties  recovery-point-offset-checkpoint  replication-offset-checkpoint[root@sdopenswan-jp kafka_2.12-0.10.2.1]# jps3538 Jps2964 QuorumPeerMain3214 Kafka[root@sdopenswan-jp kafka_2.12-0.10.2.1]#</code></pre><p>Kafka å tcp 9092 ç«¯å£ï¼Œè€Œzookeeperå  tcp 2181ç«¯å£</p><h4 id="2-Terminal-B-åˆ›å»º-ä¸€ä¸ªtopic"><a href="#2-Terminal-B-åˆ›å»º-ä¸€ä¸ªtopic" class="headerlink" title="(2) Terminal B   åˆ›å»º ä¸€ä¸ªtopic"></a>(2) Terminal B   åˆ›å»º ä¸€ä¸ªtopic</h4><pre class=" language-shell"><code class="language-shell">[root@sdopenswan-jp kafka_2.12-0.10.2.1]# bin/kafka-topics.sh --create --zookeeper localhost:2181 --replication-factor 1 --partition 1 --topic myfirst-topicWARNING: Due to limitations in metric names, topics with a period ('.') or underscore ('_') could collide. To avoid issues it is best to use either, but not both.Created topic "myfirst_topic".[root@sdopenswan-jp kafka_2.12-0.10.2.1]# ls kfkdata1/cleaner-offset-checkpoint  meta.properties  myfirst_topic-0  recovery-point-offset-checkpoint  replication-offset-checkpoint[root@sdopenswan-jp kafka_2.12-0.10.2.1]# ls kfkdata1/myfirst-topic-0/00000000000000000000.index  00000000000000000000.log  00000000000000000000.timeindex[root@sdopenswan-jp kafka_2.12-0.10.2.1]#[root@sdopenswan-jp kafka_2.12-0.10.2.1]# bin/kafka-topics.sh --list --zookeeper localhost:2181myfirst-topic[root@sdopenswan-jp kafka_2.12-0.10.2.1]# bin/kafka-console-producer.sh --topic myfirst-topic --broker-list localhost:9092hello world !hello kafka myfirst_topic </code></pre><h4 id="3-Terminal-C-consumerç«¯è¿æ¥åˆ°zookeeper-è¯»å–ä¿¡æ¯"><a href="#3-Terminal-C-consumerç«¯è¿æ¥åˆ°zookeeper-è¯»å–ä¿¡æ¯" class="headerlink" title="(3) Terminal C  # consumerç«¯è¿æ¥åˆ°zookeeper è¯»å–ä¿¡æ¯"></a>(3) Terminal C  # consumerç«¯è¿æ¥åˆ°zookeeper è¯»å–ä¿¡æ¯</h4><pre class=" language-shell"><code class="language-shell">[root@sdopenswan-jp kafka_2.12-0.10.2.1]# bin/kafka-console-consumer.sh --zookeeper localhost:2181 --topic myfirst_topic --from-beginningUsing the ConsoleConsumer with old consumer is deprecated and will be removed in a future major release. Consider using the new consumer by passing [bootstrap-server] instead of [zookeeper].hello world !hello kafka myfirst_topic</code></pre><h3 id="é…ç½®æ–‡ä»¶è¯´æ˜"><a href="#é…ç½®æ–‡ä»¶è¯´æ˜" class="headerlink" title="é…ç½®æ–‡ä»¶è¯´æ˜"></a>é…ç½®æ–‡ä»¶è¯´æ˜</h3><h4 id="Zookeeperé…ç½®"><a href="#Zookeeperé…ç½®" class="headerlink" title="Zookeeperé…ç½®"></a>Zookeeperé…ç½®</h4><p>1)  åœ¨zoo.cfgä¸­è¿½åŠ ä»¥ä¸‹å†…å®¹ï¼š</p><pre class=" language-shell"><code class="language-shell">server.n=ip:portA:portB#næ˜¯æœåŠ¡å™¨æ ‡è¯†å·ï¼ˆ1~255ï¼‰#ipæ˜¯æœåŠ¡å™¨ipåœ°å€#portAæ˜¯ä¸leaderè¿›è¡Œä¿¡æ¯äº¤æ¢çš„ç«¯å£#portBæ˜¯åœ¨leaderå®•æœºåï¼Œè¿›è¡Œleaderé€‰ä¸¾æ‰€ç”¨çš„ç«¯å£ä¾‹ï¼šserver.1=200.31.157.116:20881:30881server.2=200.31.157.116:20882:30882server.3=200.31.157.117:20881:30881tickTimeï¼šæ¯«ç§’çº§çš„åŸºæœ¬æ—¶é—´å•ä½ï¼Œå…¶ä»–æ—¶é—´å¦‚å¿ƒè·³/è¶…æ—¶ç­‰éƒ½ä¸ºè¯¥å•ä½æ—¶é—´çš„æ•´æ•°å€ã€‚initLimitï¼štickTimeçš„å€æ•°ï¼Œè¡¨ç¤ºleaderé€‰ä¸¾ç»“æŸåï¼Œfollowersä¸leaderåŒæ­¥éœ€è¦çš„æ—¶é—´ï¼Œleaderçš„æ•°æ®éå¸¸å¤šæˆ–followersæ¯”è¾ƒå¤šæ—¶ï¼Œè¯¥å€¼åº”é€‚å½“å¤§ä¸€äº›ã€‚syncLimitï¼štickTimeçš„å€æ•°ï¼Œè¡¨ç¤ºfollowerå’Œobserverä¸leaderäº¤äº’æ—¶çš„æœ€å¤§ç­‰å¾…æ—¶é—´ï¼Œæ˜¯åœ¨ä¸leaderåŒæ­¥å®Œæ¯•ä¹‹åï¼Œæ­£å¸¸è¯·æ±‚è½¬å‘æˆ–pingç­‰æ¶ˆæ¯äº¤äº’æ—¶çš„è¶…æ—¶æ—¶é—´ã€‚clientPortï¼šç›‘å¬å®¢æˆ·ç«¯è¿æ¥çš„æœåŠ¡ç«¯å£ï¼Œè‹¥ä¸€å°æœåŠ¡å™¨ä¸Šå®‰è£…å¤šä¸ªZooKeeper serverï¼Œåˆ™éœ€è¦è®¾ç½®ä¸åŒçš„ç«¯å£å·ã€‚dataDirï¼šå†…å­˜æ•°æ®åº“å¿«ç…§åœ°å€ï¼Œäº‹åŠ¡æ—¥å¿—åœ°å€ï¼ˆé™¤éç”±dataLogDirå¦è¡ŒæŒ‡å®šï¼‰ã€‚</code></pre><p>2)  åœ¨$dataDirä¸‹æ–°å»ºæ–‡ä»¶myidï¼Œå¹¶å†™å…¥æœåŠ¡å™¨æ ‡è¯†å·</p><pre class=" language-shell"><code class="language-shell">#/tmp/zookeeperä¸ºdataDircd /tmp/zookeeper/vim myid#åœ¨myidä¸­æ·»åŠ æœåŠ¡å™¨æ ‡è¯†å·</code></pre><h4 id="Kafkaé…ç½®"><a href="#Kafkaé…ç½®" class="headerlink" title="Kafkaé…ç½®"></a>Kafkaé…ç½®</h4><p>åœ¨é…ç½®æ–‡ä»¶server.propertiesä¿®æ”¹å¦‚ä¸‹å†…å®¹ï¼š</p><pre class=" language-shell"><code class="language-shell">#broker.idæ˜¯brokerçš„æ ‡è¯†ï¼Œå…·æœ‰å”¯ä¸€æ€§broker.id=0#ç«¯å£å·é»˜è®¤ä¸º9092port=9092#host.nameä½kafkaæ‰€åœ¨æœºå™¨çš„iphost.name=10.18.42.251#è®¾ç½®zookeeperï¼Œå¯è¿æ¥å¤šä¸ªzookeeperæœåŠ¡å™¨zookeeper.connect=200.31.157.116:2182,200.31.157.116:2183,200.31.157.117:2182</code></pre><h3 id="å¤šå®ä¾‹Kafka"><a href="#å¤šå®ä¾‹Kafka" class="headerlink" title="å¤šå®ä¾‹Kafka"></a>å¤šå®ä¾‹Kafka</h3><h4 id="1-é…ç½®å¹¶å¯åŠ¨zookeeper"><a href="#1-é…ç½®å¹¶å¯åŠ¨zookeeper" class="headerlink" title="(1)é…ç½®å¹¶å¯åŠ¨zookeeper"></a>(1)é…ç½®å¹¶å¯åŠ¨zookeeper</h4><pre class=" language-shell"><code class="language-shell">[root@sdopenswan-jp kafka_2.12-0.10.2.1]# vim config/zookeeper.properties[root@sdopenswan-jp kafka_2.12-0.10.2.1]# grep -Pv "^#" config/zookeeper.propertiesdataDir=zkdata1clientPort=2181maxClientCnxns=0tickTime=2000initLimit=5syncLimit=2server.0=172.16.1.16:2888:3888server.1=172.16.2.59:2888:3888server.2=172.16.0.198:2888:3888[root@sdopenswan-jp kafka_2.12-0.10.2.1]# echo 0 > zkdata1/myid[root@sdredis01-jp kafka_2.12-0.10.2.1]# vim config/zookeeper.properties[root@sdredis01-jp kafka_2.12-0.10.2.1]# grep -Pv "^#" config/zookeeper.propertiesdataDir=zkdata1clientPort=2181maxClientCnxns=0tickTime=2000initLimit=5syncLimit=2server.0=172.16.1.16:2888:3888server.1=172.16.2.59:2888:3888server.2=172.16.0.198:2888:3888[root@sdredis01-jp kafka_2.12-0.10.2.1]# lsbin  config  libs  LICENSE  NOTICE  site-docs[root@sdredis01-jp kafka_2.12-0.10.2.1]# mkdir zkdata1[root@sdredis01-jp kafka_2.12-0.10.2.1]# echo 1 >  zkdata1/myid[root@sdredis01-jp kafka_2.12-0.10.2.1]#[root@sdredis02-jp kafka_2.12-0.10.2.1]# vim config/zookeeper.properties[root@sdredis02-jp kafka_2.12-0.10.2.1]# grep -Pv "^#" config/zookeeper.propertiesdataDir=zkdata1clientPort=2181maxClientCnxns=0tickTime=2000initLimit=5syncLimit=2server.0=172.16.1.16:2888:3888server.1=172.16.2.59:2888:3888server.2=172.16.0.198:2888:3888[root@sdredis02-jp kafka_2.12-0.10.2.1]# mkdir zkdata1[root@sdredis02-jp kafka_2.12-0.10.2.1]# echo 2 > zkdata1/myid[root@sdredis02-jp kafka_2.12-0.10.2.1]#[root@sdopenswan-jp kafka_2.12-0.10.2.1]#  bin/zookeeper-server-start.sh config/zookeeper.properties &[root@sdredis01-jp kafka_2.12-0.10.2.1]# bin/zookeeper-server-start.sh config/zookeeper.properties &[root@sdredis02-jp kafka_2.12-0.10.2.1]# bin/zookeeper-server-start.sh config/zookeeper.properties &</code></pre><h4 id="2-é…ç½®å¹¶å¯åŠ¨kafka"><a href="#2-é…ç½®å¹¶å¯åŠ¨kafka" class="headerlink" title="(2)é…ç½®å¹¶å¯åŠ¨kafka"></a>(2)é…ç½®å¹¶å¯åŠ¨kafka</h4><pre class=" language-shell"><code class="language-shell">[root@sdopenswan-jp kafka_2.12-0.10.2.1]# vim config/server.properties[root@sdopenswan-jp kafka_2.12-0.10.2.1]# grep -Pv "^($|#)" config/server.propertiesbroker.id=0listeners=PLAINTEXT://:9092num.network.threads=3num.io.threads=8socket.send.buffer.bytes=102400socket.receive.buffer.bytes=102400socket.request.max.bytes=104857600log.dirs=kfklognum.partitions=3num.recovery.threads.per.data.dir=1log.retention.hours=168log.segment.bytes=1073741824log.retention.check.interval.ms=300000zookeeper.connect=172.16.1.16:2181,172.16.2.59:2181,172.16.0.198:2181zookeeper.connection.timeout.ms=6000[root@sdopenswan-jp kafka_2.12-0.10.2.1]# vim config/consumer.properties[root@sdopenswan-jp kafka_2.12-0.10.2.1]# grep -Pv "^($|#)" config/consumer.propertieszookeeper.connect=172.16.1.16:2181,172.16.2.59:2181,172.16.0.198:2181zookeeper.connection.timeout.ms=6000group.id=test-consumer-group[root@sdopenswan-jp kafka_2.12-0.10.2.1]# vim config/producer.properties[root@sdopenswan-jp kafka_2.12-0.10.2.1]# grep -Pv "^($|#)" config/producer.propertiesbootstrap.servers=172.16.1.16:9092,172.16.2.59:9092,172.16.0.198:9092compression.type=none[root@sdopenswan-jp kafka_2.12-0.10.2.1]#[root@sdredis01-jp kafka_2.12-0.10.2.1]# vim config/server.properties[root@sdredis01-jp kafka_2.12-0.10.2.1]# grep -Pv "^($|#)" config/server.propertiesbroker.id=1listeners=PLAINTEXT://:9092num.network.threads=3num.io.threads=8socket.send.buffer.bytes=102400socket.receive.buffer.bytes=102400socket.request.max.bytes=104857600log.dirs=kfklognum.partitions=3num.recovery.threads.per.data.dir=1log.retention.hours=168log.segment.bytes=1073741824log.retention.check.interval.ms=300000zookeeper.connect=172.16.1.16:2181,172.16.2.59:2181,172.16.0.198:2181zookeeper.connection.timeout.ms=6000[root@sdredis01-jp kafka_2.12-0.10.2.1]# vim config/consumer.properties[root@sdredis01-jp kafka_2.12-0.10.2.1]# grep -Pv "^($|#)" config/consumer.propertieszookeeper.connect=172.16.1.16:2181,172.16.2.59:2181,172.16.0.198:2181zookeeper.connection.timeout.ms=6000group.id=test-consumer-group[root@sdredis01-jp kafka_2.12-0.10.2.1]# vim config/producer.properties[root@sdredis01-jp kafka_2.12-0.10.2.1]# grep -Pv "^($|#)" config/producer.propertiesbootstrap.servers=172.16.1.16:9092,172.16.2.59:9092,172.16.0.198:9092compression.type=none[root@sdredis01-jp kafka_2.12-0.10.2.1]#[root@sdredis02-jp kafka_2.12-0.10.2.1]# vim config/server.properties[root@sdredis02-jp kafka_2.12-0.10.2.1]# grep -Pv "^($|#)" config/server.propertiesbroker.id=2listeners=PLAINTEXT://:9092num.network.threads=3num.io.threads=8socket.send.buffer.bytes=102400socket.receive.buffer.bytes=102400socket.request.max.bytes=104857600log.dirs=kfklognum.partitions=3num.recovery.threads.per.data.dir=1log.retention.hours=168log.segment.bytes=1073741824log.retention.check.interval.ms=300000zookeeper.connect=172.16.1.16:2181,172.16.2.59:2181,172.16.0.198:2181zookeeper.connection.timeout.ms=6000[root@sdredis02-jp kafka_2.12-0.10.2.1]# vim config/consumer.properties[root@sdredis02-jp kafka_2.12-0.10.2.1]# grep -Pv "^($|#)" config/consumer.propertieszookeeper.connect=172.16.1.16:2181,172.16.2.59:2181,172.16.0.198:2181zookeeper.connection.timeout.ms=6000group.id=test-consumer-group[root@sdredis02-jp kafka_2.12-0.10.2.1]# vim config/producer.properties[root@sdredis02-jp kafka_2.12-0.10.2.1]# grep -Pv "^($|#)" config/producer.propertiesbootstrap.servers=172.16.1.16:9092,172.16.2.59:9092,172.16.0.198:9092compression.type=none[root@sdredis02-jp kafka_2.12-0.10.2.1]#</code></pre><p>ä¸‰å°æœºå™¨åˆ†åˆ«å¯åŠ¨  bin/kafka-server-start.sh config/server.properties &amp;</p><h4 id="3-æµ‹è¯•"><a href="#3-æµ‹è¯•" class="headerlink" title="(3)æµ‹è¯•"></a>(3)æµ‹è¯•</h4><pre class=" language-shell"><code class="language-shell">[root@sdredis02-jp kafka_2.12-0.10.2.1]# bin/kafka-topics.sh --create --zookeeper 172.16.0.198:2181  --replication-factor 3 --partitions 1 --topic yc01_topicWARNING: Due to limitations in metric names, topics with a period ('.') or underscore ('_') could collide. To avoid issues it is best to use either, but not both.Created topic "yc01_topic".[root@sdredis02-jp kafka_2.12-0.10.2.1]# bin/kafka-topics.sh --list --zookeeper 172.16.0.198:2181myfirst_topicyc01_topic[root@sdredis02-jp kafka_2.12-0.10.2.1]# bin/kafka-topics.sh --describe --zookeeper 172.16.0.198:2181Topic:myfirst_topic    PartitionCount:1    ReplicationFactor:1    Configs:    Topic: myfirst_topic    Partition: 0    Leader: 0    Replicas: 0    Isr: 0Topic:yc01_topic    PartitionCount:1    ReplicationFactor:3    Configs:    Topic: yc01_topic    Partition: 0    Leader: 1    Replicas: 1,2,0    Isr: 1,2,0[root@sdredis02-jp kafka_2.12-0.10.2.1]#[root@sdredis01-jp kafka_2.12-0.10.2.1]# bin/kafka-console-producer.sh --broker-list 172.16.1.16:9092,172.16.2.59:9092,172.16.0.198:9092 --topic yc01_topichello multi instance kafka[root@sdredis02-jp kafka_2.12-0.10.2.1]# bin/kafka-console-consumer.sh --zookeeper localhost:2181 --topic yc01_topic --from-beginningUsing the ConsoleConsumer with old consumer is deprecated and will be removed in a future major release. Consider using the new consumer by passing [bootstrap-server] instead of [zookeeper].hello multi instance kafka</code></pre><h4 id="4-æŸ¥çœ‹zookeeperçŠ¶æ€"><a href="#4-æŸ¥çœ‹zookeeperçŠ¶æ€" class="headerlink" title="(4)æŸ¥çœ‹zookeeperçŠ¶æ€"></a>(4)æŸ¥çœ‹zookeeperçŠ¶æ€</h4><pre class=" language-shell"><code class="language-shell">[root@sdopenswan-jp kafka_2.12-0.10.2.1]# echo stat|nc 127.0.0.1 2181Zookeeper version: 3.4.9-1757313, built on 08/23/2016 06:50 GMTClients: /127.0.0.1:46010[0](queued=0,recved=1,sent=0) /172.16.0.198:53940[1](queued=0,recved=875,sent=875)Latency min/avg/max: 0/0/4Received: 890Sent: 889Connections: 2Outstanding: 0Zxid: 0x100000060Mode: leaderNode count: 33[root@sdopenswan-jp kafka_2.12-0.10.2.1]#[root@sdredis01-jp kafka_2.12-0.10.2.1]# echo stat|nc 127.0.0.1 2181Zookeeper version: 3.4.9-1757313, built on 08/23/2016 06:50 GMTClients: /127.0.0.1:53466[0](queued=0,recved=1,sent=0)Latency min/avg/max: 0/0/0Received: 2Sent: 1Connections: 1Outstanding: 0Zxid: 0x10000005dMode: followerNode count: 33[root@sdredis02-jp kafka_2.12-0.10.2.1]# echo stat|nc 127.0.0.1 2181Zookeeper version: 3.4.9-1757313, built on 08/23/2016 06:50 GMTClients: /172.16.2.59:53354[1](queued=0,recved=952,sent=952) /172.16.1.16:53038[1](queued=0,recved=1018,sent=1023) /127.0.0.1:49478[0](queued=0,recved=1,sent=0)Latency min/avg/max: 0/0/15Received: 2566Sent: 2572Connections: 3Outstanding: 0Zxid: 0x100000060Mode: followerNode count: 33[root@sdredis02-jp kafka_2.12-0.10.2.1]#</code></pre><h4 id="5-å¸¸ç”¨å‘½ä»¤æ€»ç»“"><a href="#5-å¸¸ç”¨å‘½ä»¤æ€»ç»“" class="headerlink" title="(5)å¸¸ç”¨å‘½ä»¤æ€»ç»“"></a>(5)å¸¸ç”¨å‘½ä»¤æ€»ç»“</h4><pre class=" language-shell"><code class="language-shell">bin/kafka-topics.sh --create --zookeeper localhost:2181 --replication-factor 2 --partitions 4 --topic testbin/kafka-topics.sh --describe --zookeeper bin/kafka-console-producer.sh --broker-list localhost:9092 --topic testbin/kafka-console-consumer.sh --zookeeper localhost:2181 --topic testbin/kafka-console-producer.sh --broker-list localhost:9092 --topic test --producer.config config/producer.propertiesbin/kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic test --new-consumer --from-beginning --consumer.config config/consumer.propertiesbin/kafka-consumer-groups.sh --new-consumer --bootstrap-server localhost:9092 --listbin/kafka-run-class.sh kafka.tools.ConsumerOffsetChecker --zkconnect localhost:2181 --group testbin/kafka-consumer-groups.sh --new-consumer --bootstrap-server localhost:9092 --describe --group test-consumer-groupbin/kafka-preferred-replica-election.sh --zookeeper zk_host:port/chrootbin/kafka-producer-perf-test.sh --topic test --num-records 100 --record-size 1 --throughput 100  --producer-props bootstrap.servers=localhost:9092</code></pre><p>ç”¨æˆ·åœ¨å®¢æˆ·ç«¯å¯ä»¥é€šè¿‡ telnet æˆ– nc å‘ ZooKeeper æäº¤ç›¸åº”çš„å‘½ä»¤</p><ol><li>å¯ä»¥é€šè¿‡å‘½ä»¤ï¼šecho stat|nc 127.0.0.1 2181 æ¥æŸ¥çœ‹å“ªä¸ªèŠ‚ç‚¹è¢«é€‰æ‹©ä½œä¸ºfolloweræˆ–è€…leader</li><li>ä½¿ç”¨echo ruok|nc 127.0.0.1 2181 æµ‹è¯•æ˜¯å¦å¯åŠ¨äº†è¯¥Serverï¼Œè‹¥å›å¤imokè¡¨ç¤ºå·²ç»å¯åŠ¨ã€‚</li><li>echo dump| nc 127.0.0.1 2181 ,åˆ—å‡ºæœªç»å¤„ç†çš„ä¼šè¯å’Œä¸´æ—¶èŠ‚ç‚¹ã€‚</li><li>echo kill | nc 127.0.0.1 2181 ,å…³æ‰server</li><li>echo conf | nc 127.0.0.1 2181 ,è¾“å‡ºç›¸å…³æœåŠ¡é…ç½®çš„è¯¦ç»†ä¿¡æ¯ã€‚</li><li>echo cons | nc 127.0.0.1 2181 ,åˆ—å‡ºæ‰€æœ‰è¿æ¥åˆ°æœåŠ¡å™¨çš„å®¢æˆ·ç«¯çš„å®Œå…¨çš„è¿æ¥ / ä¼šè¯çš„è¯¦ç»†ä¿¡æ¯ã€‚</li><li>echo envi |nc 127.0.0.1 2181 ,è¾“å‡ºå…³äºæœåŠ¡ç¯å¢ƒçš„è¯¦ç»†ä¿¡æ¯ï¼ˆåŒºåˆ«äº conf å‘½ä»¤ï¼‰ã€‚</li><li>echo reqs | nc 127.0.0.1 2181 ,åˆ—å‡ºæœªç»å¤„ç†çš„è¯·æ±‚ã€‚</li><li>echo wchs | nc 127.0.0.1 2181 ,åˆ—å‡ºæœåŠ¡å™¨ watch çš„è¯¦ç»†ä¿¡æ¯ã€‚</li><li>echo wchc | nc 127.0.0.1 2181 ,é€šè¿‡ session åˆ—å‡ºæœåŠ¡å™¨ watch çš„è¯¦ç»†ä¿¡æ¯ï¼Œå®ƒçš„è¾“å‡ºæ˜¯ä¸€ä¸ªä¸ watch ç›¸å…³çš„ä¼šè¯çš„åˆ—è¡¨ã€‚</li><li>echo wchp | nc 127.0.0.1 2181 ,é€šè¿‡è·¯å¾„åˆ—å‡ºæœåŠ¡å™¨ watch çš„è¯¦ç»†ä¿¡æ¯ã€‚å®ƒè¾“å‡ºä¸€ä¸ªä¸ session ç›¸å…³çš„è·¯å¾„</li></ol><h3 id="è¡¥å……æ–°å®éªŒè¿‡ç¨‹-å‚è€ƒ"><a href="#è¡¥å……æ–°å®éªŒè¿‡ç¨‹-å‚è€ƒ" class="headerlink" title="è¡¥å……æ–°å®éªŒè¿‡ç¨‹(å‚è€ƒ)"></a>è¡¥å……æ–°å®éªŒè¿‡ç¨‹(å‚è€ƒ)</h3><p>teacheré…ç½®å¦‚ä¸‹ï¼š</p><pre class=" language-shell"><code class="language-shell">[root@teacher ~]# vim /etc/profile[root@teacher ~]# source /etc/profile[root@teacher ~]# echo $JAVA_HOME/usr/java/latest[root@teacher ~]# which java/usr/java/latest/bin/java[root@teacher ~]# java -versionjava version "1.8.0_162"Java(TM) SE Runtime Environment (build 1.8.0_162-b12)Java HotSpot(TM) 64-Bit Server VM (build 25.162-b12, mixed mode)[root@teacher ~]#[root@teacher ~]# scp /etc/profile node2:/etc/profile                                                                                100% 1859   549.7KB/s   00:00    [root@teacher ~]# scp /etc/profile node3:/etc/profile                                                                                100% 1859   448.7KB/s   00:00    [root@teacher ~]#[root@teacher ~]# tar xf kafka_2.12-1.1.0.tgz  -C /usr/local/[root@teacher opt]# cd /usr/local/[root@teacher local]# ln -s kafka_2.12-1.1.0/ kafka[root@teacher local]# lsbin  etc  games  include  kafka  kafka_2.12-1.1.0  lib  lib64  libexec  logstash  php  sbin  share  src  zabbix[root@teacher local]# cd kafka[root@teacher kafka]# mkdir zkdata[root@teacher kafka]# mkdir kfklog[root@teacher kafka]# echo 0 > zkdata/myid[root@teacher kafka]# vim config/zookeeper.properties [root@teacher kafka]# grep -Pv "^(#|$)" config/zookeeper.propertiesdataDir=zkdataclientPort=2181maxClientCnxns=0tickTime=2000initLimit=5syncLimit=2server.0=192.168.233.102:2888:3888server.1=192.168.233.103:2888:3888server.2=192.168.233.104:2888:3888[root@teacher kafka]# vim config/server.properties [root@teacher kafka]# grep -Pv "^(#|$)" config/server.properties broker.id=0listeners=PLAINTEXT://:9092advertised.listeners=PLAINTEXT://192.168.233.102:9092num.network.threads=3num.io.threads=8socket.send.buffer.bytes=102400socket.receive.buffer.bytes=102400socket.request.max.bytes=104857600log.dirs=kfklognum.partitions=3num.recovery.threads.per.data.dir=1offsets.topic.replication.factor=1transaction.state.log.replication.factor=1transaction.state.log.min.isr=1log.retention.hours=168log.segment.bytes=1073741824log.retention.check.interval.ms=300000zookeeper.connect=192.168.233.102:2181,192.168.233.103:2181,192.168.233.104:2181zookeeper.connection.timeout.ms=6000group.initial.rebalance.delay.ms=0[root@teacher kafka]# vim config/consumer.properties [root@teacher kafka]# grep -Pv "^(#|$)" config/consumer.properties bootstrap.servers=192.168.233.102:9092,192.168.233.103:9092,192.168.233.104:9092zookeeper.connect=192.168.233.102:2181,192.168.233.103:2181,192.168.233.104:2181group.id=test-consumer-group[root@teacher kafka]# vim config/producer.properties [root@teacher kafka]# grep -Pv "^(#|$)" config/producer.properties bootstrap.servers=192.168.233.102:9092,192.168.233.103:9092,192.168.233.104:9092compression.type=none[root@teacher ~]# cd /usr/local/[root@teacher local]# scp -r kafkakafka/             kafka_2.12-1.1.0/  [root@teacher local]# scp -r kafka_2.12-1.1.0 node2:/usr/local/</code></pre><p>node2é…ç½®å¦‚ä¸‹ï¼š</p><pre class=" language-shell"><code class="language-shell">[root@node2 ~]# java -version java version "1.8.0_162"Java(TM) SE Runtime Environment (build 1.8.0_162-b12)Java HotSpot(TM) 64-Bit Server VM (build 25.162-b12, mixed mode)[root@node2 ~]# source /etc/profile[root@node2 ~]# echo $JAVA_HOME/usr/java/latest[root@node2 ~]# which java/usr/java/latest/bin/java[root@node2 ~]# tail -3  /etc/hosts192.168.233.102 teacher192.168.233.103 node2192.168.233.104 node3[root@node2 ~]# cd /usr/local/[root@node2 local]# ln -s kafka_2.12-1.1.0 kafka[root@node2 local]# cd kafka[root@node2 kafka]# echo 1 > zkdata/myid [root@node2 kafka]# vim config/server.properties [root@node2 kafka]# vim config/consumer.properties [root@node2 kafka]# vim config/producer.properties [root@node2 kafka]# grep -Pv "^(#|$)" config/zookeeper.properties dataDir=zkdataclientPort=2181maxClientCnxns=0tickTime=2000initLimit=5syncLimit=2server.0=192.168.233.102:2888:3888server.1=192.168.233.103:2888:3888server.2=192.168.233.104:2888:3888[root@node2 kafka]# grep -Pv "^(#|$)" config/server.properties broker.id=1listeners=PLAINTEXT://:9092advertised.listeners=PLAINTEXT://192.168.233.103:9092num.network.threads=3num.io.threads=8socket.send.buffer.bytes=102400socket.receive.buffer.bytes=102400socket.request.max.bytes=104857600log.dirs=kfklognum.partitions=3num.recovery.threads.per.data.dir=1offsets.topic.replication.factor=1transaction.state.log.replication.factor=1transaction.state.log.min.isr=1log.retention.hours=168log.segment.bytes=1073741824log.retention.check.interval.ms=300000zookeeper.connect=192.168.233.102:2181,192.168.233.103:2181,192.168.233.104:2181zookeeper.connection.timeout.ms=6000group.initial.rebalance.delay.ms=0[root@node2 kafka]# grep -Pv "^(#|$)" config/consumer.properties bootstrap.servers=192.168.233.102:9092,192.168.233.103:9092,192.168.233.104:9092zookeeper.connect=192.168.233.102:2181,192.168.233.103:2181,192.168.233.104:2181group.id=test-consumer-group[root@node2 kafka]# grep -Pv "^(#|$)" config/producer.properties bootstrap.servers=192.168.233.102:9092,192.168.233.103:9092,192.168.233.104:9092compression.type=none[root@node2 kafka]#</code></pre><p>node3é…ç½®å¦‚ä¸‹ï¼š</p><pre class=" language-shell"><code class="language-shell">[root@node3 ~]# cd /usr/local/[root@node3 local]# ln -s kafka_2.12-1.1.0 kafka[root@node3 local]# lsbin  etc  games  include  kafka  kafka_2.12-1.1.0  lib  lib64  libexec  sbin  share  src[root@node3 local]# cd kafka[root@node3 kafka]# lsbin  config  kfklog  libs  LICENSE  NOTICE  site-docs  zkdata[root@node3 kafka]# echo 2 > zkdata/myid [root@node3 kafka]# vim config/server.properties [root@node3 kafka]# grep -Pv "^(#|$)" config/zookeeper.properties dataDir=zkdataclientPort=2181maxClientCnxns=0tickTime=2000initLimit=5syncLimit=2server.0=192.168.233.102:2888:3888server.1=192.168.233.103:2888:3888server.2=192.168.233.104:2888:3888[root@node3 kafka]# grep -Pv "^(#|$)" config/server.properties broker.id=2listeners=PLAINTEXT://:9092advertised.listeners=PLAINTEXT://192.168.233.104:9092num.network.threads=3num.io.threads=8socket.send.buffer.bytes=102400socket.receive.buffer.bytes=102400socket.request.max.bytes=104857600log.dirs=kfklognum.partitions=3num.recovery.threads.per.data.dir=1offsets.topic.replication.factor=1transaction.state.log.replication.factor=1transaction.state.log.min.isr=1log.retention.hours=168log.segment.bytes=1073741824log.retention.check.interval.ms=300000zookeeper.connect=192.168.233.102:2181,192.168.233.103:2181,192.168.233.104:2181zookeeper.connection.timeout.ms=6000group.initial.rebalance.delay.ms=0[root@node3 kafka]# grep -Pv "^(#|$)" config/consumer.properties bootstrap.servers=192.168.233.102:9092,192.168.233.103:9092,192.168.233.104:9092zookeeper.connect=192.168.233.102:2181,192.168.233.103:2181,192.168.233.104:2181group.id=test-consumer-group[root@node3 kafka]# grep -Pv "^(#|$)" config/producer.properties bootstrap.servers=192.168.233.102:9092,192.168.233.103:9092,192.168.233.104:9092compression.type=none[root@node3 kafka]# </code></pre><p>å¯åŠ¨zookeeper</p><pre class=" language-shell"><code class="language-shell">[root@teacher kafka]# bin/zookeeper-server-start.sh config/zookeeper.properties & [root@node2 kafka]# bin/zookeeper-server-start.sh config/zookeeper.properties &[root@node3 kafka]# bin/zookeeper-server-start.sh config/zookeeper.properties &</code></pre><p>å¯åŠ¨kafka</p><pre class=" language-shell"><code class="language-shell">[root@teacher kafka]# bin/kafka-server-start.sh config/server.properties &[root@node2 kafka]#  bin/kafka-server-start.sh config/server.properties &[root@node3 kafka]#  bin/kafka-server-start.sh config/server.properties &</code></pre>]]></content>
      
      
      <categories>
          
          <category> SQL </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kafka </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ansible-roles</title>
      <link href="2019/04/18/linux/ansible-roles/"/>
      <url>2019/04/18/linux/ansible-roles/</url>
      
        <content type="html"><![CDATA[<h2 id="ansible-roles"><a href="#ansible-roles" class="headerlink" title="ansible-roles"></a>ansible-roles</h2><h3 id="1-ç®€ä»‹"><a href="#1-ç®€ä»‹" class="headerlink" title="1.ç®€ä»‹"></a>1.ç®€ä»‹</h3><p>rolesåˆ™æ˜¯åœ¨ansibleä¸­ï¼Œplaybooksçš„ç›®å½•ç»„ç»‡ç»“æ„ã€‚<br>è€Œæ¨¡å—åŒ–ä¹‹åï¼Œæˆä¸ºrolesçš„ç»„ç»‡ç»“æ„ï¼Œæ˜“è¯»ï¼Œä»£ç å¯é‡ç”¨ï¼Œå±‚æ¬¡æ¸…æ™°ã€‚</p><h3 id="2-ç›®æ ‡"><a href="#2-ç›®æ ‡" class="headerlink" title="2.ç›®æ ‡"></a>2.ç›®æ ‡</h3><p>é€šè¿‡roleè¿œç¨‹éƒ¨ç½²nginxå¹¶é…ç½®</p><h3 id="3-ç›®å½•ç»“æ„"><a href="#3-ç›®å½•ç»“æ„" class="headerlink" title="3.ç›®å½•ç»“æ„"></a>3.ç›®å½•ç»“æ„</h3><p>[<img src="https://s1.ax1x.com/2020/09/28/0VbuwT.md.png" alt="0VbuwT.md.png"></p><pre><code>files/ï¼šå­˜å‚¨ç”±copyæˆ–scriptç­‰æ¨¡å—è°ƒç”¨çš„æ–‡ä»¶ï¼›tasks/ï¼šæ­¤ç›®å½•ä¸­è‡³å°‘åº”è¯¥æœ‰ä¸€ä¸ªåä¸ºmain.ymlçš„æ–‡ä»¶ï¼Œç”¨äºå®šä¹‰å„taskï¼›å…¶å®ƒçš„æ–‡ä»¶éœ€è¦ç”±main.ymlè¿›è¡Œâ€œåŒ…å«â€è°ƒç”¨ï¼›handlers/ï¼šæ­¤ç›®å½•ä¸­è‡³å°‘åº”è¯¥æœ‰ä¸€ä¸ªåä¸ºmain.ymlçš„æ–‡ä»¶ï¼Œç”¨äºå®šä¹‰å„handlerï¼›å…¶å®ƒçš„æ–‡ä»¶éœ€è¦ç”±main.ymlè¿›è¡Œâ€œåŒ…å«â€è°ƒç”¨ï¼›vars/ï¼šæ­¤ç›®å½•ä¸­è‡³å°‘åº”è¯¥æœ‰ä¸€ä¸ªåä¸ºmain.ymlçš„æ–‡ä»¶ï¼Œç”¨äºå®šä¹‰å„variableï¼›å…¶å®ƒçš„æ–‡ä»¶éœ€è¦ç”±main.ymlè¿›è¡Œâ€œåŒ…å«â€è°ƒç”¨ï¼›templates/ï¼šå­˜å‚¨ç”±templateæ¨¡å—è°ƒç”¨çš„æ¨¡æ¿æ–‡æœ¬ï¼›meta/ï¼šæ­¤ç›®å½•ä¸­è‡³å°‘åº”è¯¥æœ‰ä¸€ä¸ªåä¸ºmain.ymlçš„æ–‡ä»¶ï¼Œå®šä¹‰å½“å‰è§’è‰²çš„ç‰¹æ®Šè®¾å®šåŠå…¶ä¾èµ–å…³ç³»ï¼›å…¶å®ƒçš„æ–‡ä»¶éœ€è¦ç”±main.ymlè¿›è¡Œâ€œåŒ…å«â€è°ƒç”¨ï¼›default/ï¼šæ­¤ç›®å½•ä¸­è‡³å°‘åº”è¯¥æœ‰ä¸€ä¸ªåä¸ºmain.ymlçš„æ–‡ä»¶ï¼Œç”¨äºè®¾å®šé»˜è®¤å˜é‡ï¼›</code></pre><p>å‡†å¤‡ç›®å½•ç»“æ„</p><pre><code>mkdir roles/nginx/{files,handlers,tasks,templates,vars} -ptouch roles/site.yaml roles/nginx/{handlers,tasks,vars}/main.yamlecho tiger &gt; roles/nginx/files/index.htmlyum install -y nginx &amp;&amp; cp /etc/nginx/nginx.conf roles/nginx/templates/nginx.conf.j2</code></pre><h3 id="4-ç¼–å†™ä»»åŠ¡"><a href="#4-ç¼–å†™ä»»åŠ¡" class="headerlink" title="4.ç¼–å†™ä»»åŠ¡"></a>4.ç¼–å†™ä»»åŠ¡</h3><pre><code>vim roles/nginx/tasks/main.yaml---- name: install nginx packge  yum: name={{ item }} state=latest  with_items:  - epel-release  - nginx- name: copy index.html  copy: src=index.html dest=/usr/share/nginx/html/index.html- name: copy nginx.conf template  template: src=nginx.conf.j2 dest=/etc/nginx/nginx.conf  notify: restart nginx- name: make sure nginx service running  service: name=nginx state=started enabled=yes</code></pre><h3 id="5-å‡†å¤‡é…ç½®æ–‡ä»¶"><a href="#5-å‡†å¤‡é…ç½®æ–‡ä»¶" class="headerlink" title="5.å‡†å¤‡é…ç½®æ–‡ä»¶"></a>5.å‡†å¤‡é…ç½®æ–‡ä»¶</h3><pre><code>vim roles/nginx/templates/nginx.conf.j2worker_processes  {{ ansible_processor_cores }};   //è°ƒç”¨å†…éƒ¨å·²çŸ¥å˜é‡worker_connections {{ worker_connections }};    //è‡ªå®šä¹‰å˜é‡</code></pre><h3 id="6-ç¼–å†™å˜é‡"><a href="#6-ç¼–å†™å˜é‡" class="headerlink" title="6.ç¼–å†™å˜é‡"></a>6.ç¼–å†™å˜é‡</h3><pre><code>vim roles/nginx/vars/main.yamlworker_connections: 10240</code></pre><h3 id="7-ç¼–å†™å¤„ç†ç¨‹åº"><a href="#7-ç¼–å†™å¤„ç†ç¨‹åº" class="headerlink" title="7.ç¼–å†™å¤„ç†ç¨‹åº"></a>7.ç¼–å†™å¤„ç†ç¨‹åº</h3><pre><code>vim roles/nginx/handlers/main.yaml---- name: restart nginx  service: name=nginx state=restarted</code></pre><h3 id="8-ç¼–å†™å‰§æœ¬"><a href="#8-ç¼–å†™å‰§æœ¬" class="headerlink" title="8.ç¼–å†™å‰§æœ¬"></a>8.ç¼–å†™å‰§æœ¬</h3><pre><code>vim roles/site.yaml- hosts: host4  roles:  - nginx</code></pre><h3 id="9-å®æ–½"><a href="#9-å®æ–½" class="headerlink" title="9.å®æ–½"></a>9.å®æ–½</h3><pre><code>ansible-playbook site.yaml --syntax-check  //æµ‹è¯•ansible-playbook site.yaml    //å®æ–½å‰§æœ¬</code></pre><p>éªŒè¯hosts</p><p><a href="https://imgchr.com/i/0VbwkD" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2020/09/28/0VbwkD.png" alt="0VbwkD.png"></a></p><p>å¼•ç”¨å˜é‡æ¡ˆä¾‹ï¼š</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># tree </span><span class="token keyword">.</span>â”œâ”€â”€ site.ymlâ”œâ”€â”€ templatesâ”‚   â””â”€â”€ order.j2â””â”€â”€ vars    â””â”€â”€ main.yml2 directories, 3 files</code></pre><p>æ€»è°ƒåº¦ymlæ–‡ä»¶ï¼š</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># cat site.yml </span>---- hosts: 192.168.19.154  user: root  vars:  - PROJECT: <span class="token string">"JAVA"</span>    SWITCH: <span class="token string">"ON"</span>    DBPORT: <span class="token string">"8080"</span>  tasks:  - name: create<span class="token punctuation">{</span><span class="token punctuation">{</span> PROJECT <span class="token punctuation">}</span><span class="token punctuation">}</span>directory    file: path<span class="token operator">=</span>/data/<span class="token punctuation">{</span><span class="token punctuation">{</span> PROJECT <span class="token punctuation">}</span><span class="token punctuation">}</span> state<span class="token operator">=</span>directory  - name: template transfor java    template: src<span class="token operator">=</span>order.j2 dest<span class="token operator">=</span>/data/<span class="token punctuation">{</span><span class="token punctuation">{</span> PROJECT <span class="token punctuation">}</span><span class="token punctuation">}</span>/order.conf</code></pre><p>æ³¨æ„:è¿™é‡Œ - role: template å’Œ - template æ˜¯ä¸€æ ·çš„ï¼</p><p>å…¶ä»–ymlæ–‡ä»¶ï¼Œå¦‚ä¸‹ï¼š</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># cat templates/order.j2 </span>project: <span class="token punctuation">{</span><span class="token punctuation">{</span> PROJECT <span class="token punctuation">}</span><span class="token punctuation">}</span>switch: <span class="token punctuation">{</span><span class="token punctuation">{</span> SWITCH <span class="token punctuation">}</span><span class="token punctuation">}</span>dbport: <span class="token punctuation">{</span><span class="token punctuation">{</span> DBPORT <span class="token punctuation">}</span><span class="token punctuation">}</span>æµ‹è¯•ï¼š<span class="token comment" spellcheck="true"># ansible-playbook templates.yml --syntax-check</span>playbook: templates.ymlæ‰§è¡Œï¼šPLAY <span class="token punctuation">[</span>192.168.19.154<span class="token punctuation">]</span> **********************************************************TASK <span class="token punctuation">[</span>Gathering Facts<span class="token punctuation">]</span> *********************************************************ok: <span class="token punctuation">[</span>192.168.19.154<span class="token punctuation">]</span>TASK <span class="token punctuation">[</span>createJAVAdirectory<span class="token punctuation">]</span> *****************************************************changed: <span class="token punctuation">[</span>192.168.19.154<span class="token punctuation">]</span>TASK <span class="token punctuation">[</span>template transfor java<span class="token punctuation">]</span> **************************************************changed: <span class="token punctuation">[</span>192.168.19.154<span class="token punctuation">]</span>PLAY RECAP *********************************************************************192.168.19.154             <span class="token keyword">:</span> ok<span class="token operator">=</span>3    changed<span class="token operator">=</span>2    unreachable<span class="token operator">=</span>0    failed<span class="token operator">=</span>0 <span class="token comment" spellcheck="true">#cat /data/JAVA/order.conf</span>project: JAVAswitch: ONdbport: 8080</code></pre>]]></content>
      
      
      <categories>
          
          <category> Tools </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Ansible </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ansible</title>
      <link href="2019/04/16/linux/ansible/"/>
      <url>2019/04/16/linux/ansible/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h1 id="è‡ªåŠ¨åŒ–è¿ç»´å·¥å…·â€”ansibleè¯¦è§£"><a href="#è‡ªåŠ¨åŒ–è¿ç»´å·¥å…·â€”ansibleè¯¦è§£" class="headerlink" title="è‡ªåŠ¨åŒ–è¿ç»´å·¥å…·â€”ansibleè¯¦è§£"></a>è‡ªåŠ¨åŒ–è¿ç»´å·¥å…·â€”ansibleè¯¦è§£</h1><h2 id="ä¸€ã€ansible-ç®€ä»‹"><a href="#ä¸€ã€ansible-ç®€ä»‹" class="headerlink" title="ä¸€ã€ansible ç®€ä»‹"></a>ä¸€ã€ansible ç®€ä»‹</h2><h3 id="1ã€ansible-æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#1ã€ansible-æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="1ã€ansible æ˜¯ä»€ä¹ˆï¼Ÿ"></a>1ã€ansible æ˜¯ä»€ä¹ˆï¼Ÿ</h3><p>ã€€ã€€ansibleæ˜¯ç›®å‰æœ€å—è¿ç»´æ¬¢è¿çš„è‡ªåŠ¨åŒ–è¿ç»´å·¥å…·ï¼ŒåŸºäºPythonå¼€å‘ï¼Œé›†åˆäº†ä¼—å¤šè¿ç»´å·¥å…·ï¼ˆSaltStack puppetã€chefã€funcã€fabricï¼‰çš„ä¼˜ç‚¹ï¼Œå®ç°äº†æ‰¹é‡ç³»ç»Ÿé…ç½®ã€æ‰¹é‡ç¨‹åºéƒ¨ç½²ã€æ‰¹é‡è¿è¡Œå‘½ä»¤ç­‰åŠŸèƒ½ã€‚<br> ã€€ã€€ansibleæ˜¯åŸºäº paramiko å¼€å‘çš„,å¹¶ä¸”åŸºäºæ¨¡å—åŒ–å·¥ä½œï¼Œæœ¬èº«æ²¡æœ‰æ‰¹é‡éƒ¨ç½²çš„èƒ½åŠ›ã€‚çœŸæ­£å…·æœ‰æ‰¹é‡éƒ¨ç½²çš„æ˜¯ansibleæ‰€è¿è¡Œçš„æ¨¡å—ï¼Œansibleåªæ˜¯æä¾›ä¸€ç§æ¡†æ¶ã€‚ansibleä¸éœ€è¦åœ¨è¿œç¨‹ä¸»æœºä¸Šå®‰è£…client/agentsï¼Œå› ä¸ºå®ƒä»¬æ˜¯åŸºäºsshæ¥å’Œè¿œç¨‹ä¸»æœºé€šè®¯çš„ã€‚ansibleç›®å‰å·²ç»å·²ç»è¢«çº¢å¸½å®˜æ–¹æ”¶è´­ï¼Œæ˜¯è‡ªåŠ¨åŒ–è¿ç»´å·¥å…·ä¸­å¤§å®¶è®¤å¯åº¦æœ€é«˜çš„ï¼Œå¹¶ä¸”ä¸Šæ‰‹å®¹æ˜“ï¼Œå­¦ä¹ ç®€å•ã€‚æ˜¯æ¯ä½è¿ç»´å·¥ç¨‹å¸ˆå¿…é¡»æŒæ¡çš„æŠ€èƒ½ä¹‹ä¸€ã€‚</p><h3 id="2ã€ansible-ç‰¹ç‚¹"><a href="#2ã€ansible-ç‰¹ç‚¹" class="headerlink" title="2ã€ansible ç‰¹ç‚¹"></a>2ã€ansible ç‰¹ç‚¹</h3><ol><li>éƒ¨ç½²ç®€å•ï¼Œåªéœ€åœ¨ä¸»æ§ç«¯éƒ¨ç½²Ansibleç¯å¢ƒï¼Œè¢«æ§ç«¯æ— éœ€åšä»»ä½•æ“ä½œï¼›</li><li>é»˜è®¤ä½¿ç”¨SSHåè®®å¯¹è®¾å¤‡è¿›è¡Œç®¡ç†ï¼›</li><li>æœ‰å¤§é‡å¸¸è§„è¿ç»´æ“ä½œæ¨¡å—ï¼Œå¯å®ç°æ—¥å¸¸ç»å¤§éƒ¨åˆ†æ“ä½œï¼›</li><li>é…ç½®ç®€å•ã€åŠŸèƒ½å¼ºå¤§ã€æ‰©å±•æ€§å¼ºï¼›</li><li>æ”¯æŒAPIåŠè‡ªå®šä¹‰æ¨¡å—ï¼Œå¯é€šè¿‡Pythonè½»æ¾æ‰©å±•ï¼›</li><li>é€šè¿‡Playbooksæ¥å®šåˆ¶å¼ºå¤§çš„é…ç½®ã€çŠ¶æ€ç®¡ç†ï¼›</li><li>è½»é‡çº§ï¼Œæ— éœ€åœ¨å®¢æˆ·ç«¯å®‰è£…agentï¼Œæ›´æ–°æ—¶ï¼Œåªéœ€åœ¨æ“ä½œæœºä¸Šè¿›è¡Œä¸€æ¬¡æ›´æ–°å³å¯ï¼›</li><li>æä¾›ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§ã€æ“ä½œæ€§å¼ºçš„Webç®¡ç†ç•Œé¢å’ŒREST APIæ¥å£â€”â€”AWXå¹³å°ã€‚</li></ol><h3 id="3ã€ansible-æ¶æ„å›¾"><a href="#3ã€ansible-æ¶æ„å›¾" class="headerlink" title="3ã€ansible æ¶æ„å›¾"></a>3ã€ansible æ¶æ„å›¾</h3><p><img src="https://s1.ax1x.com/2020/04/17/JEZyQO.png" alt="JEZyQO.png"></p><blockquote><p><code>Ansible</code>ï¼šAnsibleæ ¸å¿ƒç¨‹åºã€‚<br><code>HostInventory</code>ï¼šè®°å½•ç”±Ansibleç®¡ç†çš„ä¸»æœºä¿¡æ¯ï¼ŒåŒ…æ‹¬ç«¯å£ã€å¯†ç ã€ipç­‰ã€‚<br><code>Playbooks</code>ï¼šâ€œå‰§æœ¬â€YAMLæ ¼å¼æ–‡ä»¶ï¼Œå¤šä¸ªä»»åŠ¡å®šä¹‰åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œå®šä¹‰ä¸»æœºéœ€è¦è°ƒç”¨å“ªäº›æ¨¡å—æ¥å®Œæˆçš„åŠŸèƒ½ã€‚<br><code>CoreModules</code>ï¼š<strong>æ ¸å¿ƒæ¨¡å—</strong>ï¼Œä¸»è¦æ“ä½œæ˜¯é€šè¿‡è°ƒç”¨æ ¸å¿ƒæ¨¡å—æ¥å®Œæˆç®¡ç†ä»»åŠ¡ã€‚<br><code>CustomModules</code>ï¼šè‡ªå®šä¹‰æ¨¡å—ï¼Œå®Œæˆæ ¸å¿ƒæ¨¡å—æ— æ³•å®Œæˆçš„åŠŸèƒ½ï¼Œæ”¯æŒå¤šç§è¯­è¨€ã€‚<br><code>ConnectionPlugins</code>ï¼šè¿æ¥æ’ä»¶ï¼ŒAnsibleå’ŒHosté€šä¿¡ä½¿ç”¨</p></blockquote><h2 id="äºŒã€ansible-ä»»åŠ¡æ‰§è¡Œ"><a href="#äºŒã€ansible-ä»»åŠ¡æ‰§è¡Œ" class="headerlink" title="äºŒã€ansible ä»»åŠ¡æ‰§è¡Œ"></a>äºŒã€ansible ä»»åŠ¡æ‰§è¡Œ</h2><h3 id="1ã€ansible-ä»»åŠ¡æ‰§è¡Œæ¨¡å¼"><a href="#1ã€ansible-ä»»åŠ¡æ‰§è¡Œæ¨¡å¼" class="headerlink" title="1ã€ansible ä»»åŠ¡æ‰§è¡Œæ¨¡å¼"></a>1ã€ansible ä»»åŠ¡æ‰§è¡Œæ¨¡å¼</h3><p>ã€€ã€€Ansible ç³»ç»Ÿç”±æ§åˆ¶ä¸»æœºå¯¹è¢«ç®¡èŠ‚ç‚¹çš„æ“ä½œæ–¹å¼å¯åˆ†ä¸ºä¸¤ç±»ï¼Œå³<code>ad-hoc</code>å’Œ<code>playbook</code>ï¼š</p><ul><li>ad-hocæ¨¡å¼(ç‚¹å¯¹ç‚¹æ¨¡å¼)<br>ä½¿ç”¨å•ä¸ªæ¨¡å—ï¼Œæ”¯æŒæ‰¹é‡æ‰§è¡Œå•æ¡å‘½ä»¤ã€‚ad-hoc å‘½ä»¤æ˜¯ä¸€ç§å¯ä»¥å¿«é€Ÿè¾“å…¥çš„å‘½ä»¤ï¼Œè€Œä¸”ä¸éœ€è¦ä¿å­˜èµ·æ¥çš„å‘½ä»¤ã€‚<strong>å°±ç›¸å½“äºbashä¸­çš„ä¸€å¥è¯shellã€‚</strong></li><li>playbookæ¨¡å¼(å‰§æœ¬æ¨¡å¼)<br>æ˜¯Ansibleä¸»è¦ç®¡ç†æ–¹å¼ï¼Œä¹Ÿæ˜¯AnsibleåŠŸèƒ½å¼ºå¤§çš„å…³é”®æ‰€åœ¨ã€‚<strong>playbooké€šè¿‡å¤šä¸ªtaské›†åˆå®Œæˆä¸€ç±»åŠŸèƒ½</strong>ï¼Œå¦‚WebæœåŠ¡çš„å®‰è£…éƒ¨ç½²ã€æ•°æ®åº“æœåŠ¡å™¨çš„æ‰¹é‡å¤‡ä»½ç­‰ã€‚å¯ä»¥ç®€å•åœ°æŠŠplaybookç†è§£ä¸ºé€šè¿‡ç»„åˆå¤šæ¡ad-hocæ“ä½œçš„é…ç½®æ–‡ä»¶ã€‚</li></ul><h3 id="2ã€ansible-æ‰§è¡Œæµç¨‹"><a href="#2ã€ansible-æ‰§è¡Œæµç¨‹" class="headerlink" title="2ã€ansible æ‰§è¡Œæµç¨‹"></a>2ã€ansible æ‰§è¡Œæµç¨‹</h3><p> ã€€ã€€ç®€å•ç†è§£å°±æ˜¯Ansibleåœ¨è¿è¡Œæ—¶ï¼Œ é¦–å…ˆè¯»å–<code>ansible.cfg</code>ä¸­çš„é…ç½®ï¼Œ æ ¹æ®è§„åˆ™è·å–<code>Inventory</code>ä¸­çš„ç®¡ç†ä¸»æœºåˆ—è¡¨ï¼Œ å¹¶è¡Œçš„åœ¨è¿™äº›ä¸»æœºä¸­æ‰§è¡Œé…ç½®çš„ä»»åŠ¡ï¼Œ æœ€åç­‰å¾…æ‰§è¡Œè¿”å›çš„ç»“æœã€‚</p><h3 id="3ã€ansible-å‘½ä»¤æ‰§è¡Œè¿‡ç¨‹"><a href="#3ã€ansible-å‘½ä»¤æ‰§è¡Œè¿‡ç¨‹" class="headerlink" title="3ã€ansible å‘½ä»¤æ‰§è¡Œè¿‡ç¨‹"></a>3ã€ansible å‘½ä»¤æ‰§è¡Œè¿‡ç¨‹</h3><p><img src="https://s1.ax1x.com/2020/04/17/JEZ2eH.png" alt="JEZ2eH.png"></p><ol><li>åŠ è½½è‡ªå·±çš„é…ç½®æ–‡ä»¶ï¼Œé»˜è®¤<code>/etc/ansible/ansible.cfg</code>ï¼›</li><li>æŸ¥æ‰¾å¯¹åº”çš„ä¸»æœºé…ç½®æ–‡ä»¶ï¼Œæ‰¾åˆ°è¦æ‰§è¡Œçš„ä¸»æœºæˆ–è€…ç»„ï¼›</li><li>åŠ è½½è‡ªå·±å¯¹åº”çš„æ¨¡å—æ–‡ä»¶ï¼Œå¦‚ commandï¼›</li><li>é€šè¿‡ansibleå°†æ¨¡å—æˆ–å‘½ä»¤ç”Ÿæˆå¯¹åº”çš„ä¸´æ—¶pyæ–‡ä»¶(pythonè„šæœ¬)ï¼Œ å¹¶å°†è¯¥æ–‡ä»¶ä¼ è¾“è‡³è¿œç¨‹æœåŠ¡å™¨ï¼›</li><li>å¯¹åº”æ‰§è¡Œç”¨æˆ·çš„å®¶ç›®å½•çš„<code>.ansible/tmp/XXX/XXX.PY</code>æ–‡ä»¶ï¼›</li><li>ç»™æ–‡ä»¶ +x æ‰§è¡Œæƒé™ï¼›</li><li>æ‰§è¡Œå¹¶è¿”å›ç»“æœï¼›</li><li>åˆ é™¤ä¸´æ—¶pyæ–‡ä»¶ï¼Œ<code>sleep 0</code>é€€å‡ºï¼›</li></ol><h2 id="ä¸‰ã€ansible-é…ç½®è¯¦è§£"><a href="#ä¸‰ã€ansible-é…ç½®è¯¦è§£" class="headerlink" title="ä¸‰ã€ansible é…ç½®è¯¦è§£"></a>ä¸‰ã€ansible é…ç½®è¯¦è§£</h2><h3 id="1ã€ansible-å®‰è£…æ–¹å¼"><a href="#1ã€ansible-å®‰è£…æ–¹å¼" class="headerlink" title="1ã€ansible å®‰è£…æ–¹å¼"></a>1ã€ansible å®‰è£…æ–¹å¼</h3><p>ã€€ã€€ansibleå®‰è£…å¸¸ç”¨ä¸¤ç§æ–¹å¼ï¼Œ<code>yum å®‰è£…</code> å’Œ <code>pip ç¨‹åºå®‰è£…</code>ã€‚ä¸‹é¢æˆ‘ä»¬æ¥è¯¦ç»†ä»‹ç»ä¸€ä¸‹è¿™ä¸¤ç§å®‰è£…æ–¹å¼ã€‚</p><h3 id="2ã€ä½¿ç”¨-pipï¼ˆpythonçš„åŒ…ç®¡ç†æ¨¡å—ï¼‰å®‰è£…"><a href="#2ã€ä½¿ç”¨-pipï¼ˆpythonçš„åŒ…ç®¡ç†æ¨¡å—ï¼‰å®‰è£…" class="headerlink" title="2ã€ä½¿ç”¨ pipï¼ˆpythonçš„åŒ…ç®¡ç†æ¨¡å—ï¼‰å®‰è£…"></a>2ã€ä½¿ç”¨ pipï¼ˆpythonçš„åŒ…ç®¡ç†æ¨¡å—ï¼‰å®‰è£…</h3><p>ã€€ã€€é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦å®‰è£…ä¸€ä¸ª<code>python-pip</code>åŒ…ï¼Œå®‰è£…å®Œæˆä»¥åï¼Œåˆ™ç›´æ¥ä½¿ç”¨<code>pip</code>å‘½ä»¤æ¥å®‰è£…æˆ‘ä»¬çš„åŒ…ï¼Œå…·ä½“æ“ä½œè¿‡ç¨‹å¦‚ä¸‹ï¼š</p><pre><code>    yum install python-pip    pip install ansible</code></pre><h3 id="4ã€ä½¿ç”¨-yum-å®‰è£…"><a href="#4ã€ä½¿ç”¨-yum-å®‰è£…" class="headerlink" title="4ã€ä½¿ç”¨ yum å®‰è£…"></a>4ã€ä½¿ç”¨ yum å®‰è£…</h3><p>ã€€ã€€yum å®‰è£…æ˜¯æˆ‘ä»¬å¾ˆç†Ÿæ‚‰çš„å®‰è£…æ–¹å¼äº†ã€‚æˆ‘ä»¬éœ€è¦å…ˆå®‰è£…ä¸€ä¸ª<code>epel-release</code>åŒ…ï¼Œç„¶åå†å®‰è£…æˆ‘ä»¬çš„ ansible å³å¯ã€‚</p><pre><code>    yum install epel-release -y    yum install ansible â€“y</code></pre><h3 id="5ã€ansible-ç¨‹åºç»“æ„"><a href="#5ã€ansible-ç¨‹åºç»“æ„" class="headerlink" title="5ã€ansible ç¨‹åºç»“æ„"></a>5ã€ansible ç¨‹åºç»“æ„</h3><p>å®‰è£…ç›®å½•å¦‚ä¸‹(yumå®‰è£…)ï¼š<br> ã€€   é…ç½®æ–‡ä»¶ç›®å½•ï¼š/etc/ansible/<br>ã€€ã€€æ‰§è¡Œæ–‡ä»¶ç›®å½•ï¼š/usr/bin/<br>ã€€ã€€Libåº“ä¾èµ–ç›®å½•ï¼š/usr/lib/pythonX.X/site-packages/ansible/<br>ã€€ã€€Helpæ–‡æ¡£ç›®å½•ï¼š/usr/share/doc/ansible-X.X.X/<br>ã€€ã€€Manæ–‡æ¡£ç›®å½•ï¼š/usr/share/man/man1/</p><h3 id="6ã€ansibleé…ç½®æ–‡ä»¶æŸ¥æ‰¾é¡ºåº"><a href="#6ã€ansibleé…ç½®æ–‡ä»¶æŸ¥æ‰¾é¡ºåº" class="headerlink" title="6ã€ansibleé…ç½®æ–‡ä»¶æŸ¥æ‰¾é¡ºåº"></a>6ã€ansibleé…ç½®æ–‡ä»¶æŸ¥æ‰¾é¡ºåº</h3><p>ã€€ã€€ansibleä¸æˆ‘ä»¬å…¶ä»–çš„æœåŠ¡åœ¨è¿™ä¸€ç‚¹ä¸Šæœ‰å¾ˆå¤§ä¸åŒï¼Œè¿™é‡Œçš„é…ç½®æ–‡ä»¶æŸ¥æ‰¾æ˜¯ä»å¤šä¸ªåœ°æ–¹æ‰¾çš„ï¼Œé¡ºåºå¦‚ä¸‹ï¼š</p><ol><li>æ£€æŸ¥ç¯å¢ƒå˜é‡<code>ANSIBLE_CONFIG</code>æŒ‡å‘çš„è·¯å¾„æ–‡ä»¶(export ANSIBLE_CONFIG=/etc/ansible.cfg)ï¼›</li><li><code>~/.ansible.cfg</code>ï¼Œæ£€æŸ¥å½“å‰ç›®å½•ä¸‹çš„ansible.cfgé…ç½®æ–‡ä»¶ï¼›</li><li><code>/etc/ansible.cfg</code>æ£€æŸ¥etcç›®å½•çš„é…ç½®æ–‡ä»¶ã€‚</li></ol><h3 id="7ã€ansibleé…ç½®æ–‡ä»¶"><a href="#7ã€ansibleé…ç½®æ–‡ä»¶" class="headerlink" title="7ã€ansibleé…ç½®æ–‡ä»¶"></a>7ã€ansibleé…ç½®æ–‡ä»¶</h3><p>ã€€ã€€ansible çš„é…ç½®æ–‡ä»¶ä¸º<code>/etc/ansible/ansible.cfg</code>ï¼Œansible æœ‰è®¸å¤šå‚æ•°ï¼Œä¸‹é¢æˆ‘ä»¬åˆ—å‡ºä¸€äº›å¸¸è§çš„å‚æ•°ï¼š</p><pre><code>    inventory = /etc/ansible/hosts #è¿™ä¸ªå‚æ•°è¡¨ç¤ºèµ„æºæ¸…å•inventoryæ–‡ä»¶çš„ä½ç½®    library = /usr/share/ansible   #æŒ‡å‘å­˜æ”¾Ansibleæ¨¡å—çš„ç›®å½•ï¼Œæ”¯æŒå¤šä¸ªç›®å½•æ–¹å¼ï¼Œåªè¦ç”¨å†’å·ï¼ˆï¼šï¼‰éš”å¼€å°±å¯ä»¥    forks = 5       #å¹¶å‘è¿æ¥æ•°ï¼Œé»˜è®¤ä¸º5    sudo_user = root        #è®¾ç½®é»˜è®¤æ‰§è¡Œå‘½ä»¤çš„ç”¨æˆ·    remote_port = 22        #æŒ‡å®šè¿æ¥è¢«ç®¡èŠ‚ç‚¹çš„ç®¡ç†ç«¯å£ï¼Œé»˜è®¤ä¸º22ç«¯å£ï¼Œå»ºè®®ä¿®æ”¹ï¼Œèƒ½å¤Ÿæ›´åŠ å®‰å…¨    host_key_checking = False #è®¾ç½®æ˜¯å¦æ£€æŸ¥SSHä¸»æœºçš„å¯†é’¥ï¼Œå€¼ä¸ºTrue/Falseã€‚å…³é—­åç¬¬ä¸€æ¬¡è¿æ¥ä¸ä¼šæç¤ºé…ç½®å®ä¾‹    timeout = 60        #è®¾ç½®SSHè¿æ¥çš„è¶…æ—¶æ—¶é—´ï¼Œå•ä½ä¸ºç§’    log_path = /var/log/ansible.log     #æŒ‡å®šä¸€ä¸ªå­˜å‚¨ansibleæ—¥å¿—çš„æ–‡ä»¶ï¼ˆé»˜è®¤ä¸è®°å½•æ—¥å¿—ï¼‰</code></pre><h3 id="8ã€ansubleä¸»æœºæ¸…å•"><a href="#8ã€ansubleä¸»æœºæ¸…å•" class="headerlink" title="8ã€ansubleä¸»æœºæ¸…å•"></a>8ã€ansubleä¸»æœºæ¸…å•</h3><p>ã€€ã€€åœ¨é…ç½®æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬æåˆ°äº†èµ„æºæ¸…å•ï¼Œè¿™ä¸ªæ¸…å•å°±æ˜¯æˆ‘ä»¬çš„ä¸»æœºæ¸…å•ï¼Œé‡Œé¢ä¿å­˜çš„æ˜¯ä¸€äº› ansible éœ€è¦è¿æ¥ç®¡ç†çš„ä¸»æœºåˆ—è¡¨ã€‚æˆ‘ä»¬å¯ä»¥æ¥çœ‹çœ‹ä»–çš„å®šä¹‰æ–¹å¼ï¼š</p><pre><code>1ã€ ç›´æ¥æŒ‡æ˜ä¸»æœºåœ°å€æˆ–ä¸»æœºåï¼š    # green.example.com    # blue.example.com    # 192.168.100.1    # 192.168.100.102ã€ å®šä¹‰ä¸€ä¸ªä¸»æœºç»„[ç»„å]æŠŠåœ°å€æˆ–ä¸»æœºååŠ è¿›å»    [mysql_test]    192.168.253.159    192.168.253.160    192.168.253.153</code></pre><p>ã€€ã€€éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œçš„ç»„æˆå‘˜å¯ä»¥ä½¿ç”¨é€šé…ç¬¦æ¥åŒ¹é…ï¼Œè¿™æ ·å¯¹äºä¸€äº›æ ‡å‡†åŒ–çš„ç®¡ç†æ¥è¯´å°±å¾ˆè½»æ¾æ–¹ä¾¿äº†ã€‚<br> ã€€ã€€æˆ‘ä»¬å¯ä»¥æ ¹æ®å®é™…æƒ…å†µæ¥é…ç½®æˆ‘ä»¬çš„ä¸»æœºåˆ—è¡¨ï¼Œå…·ä½“æ“ä½œå¦‚ä¸‹ï¼š</p><pre><code>[root@server ~]# vim /etc/ansible/hosts    [web]    192.168.37.122    192.168.37.133</code></pre><h2 id="å››ã€ansible-å¸¸ç”¨å‘½ä»¤"><a href="#å››ã€ansible-å¸¸ç”¨å‘½ä»¤" class="headerlink" title="å››ã€ansible å¸¸ç”¨å‘½ä»¤"></a>å››ã€ansible å¸¸ç”¨å‘½ä»¤</h2><h3 id="1ã€ansible-å‘½ä»¤é›†"><a href="#1ã€ansible-å‘½ä»¤é›†" class="headerlink" title="1ã€ansible å‘½ä»¤é›†"></a>1ã€ansible å‘½ä»¤é›†</h3><blockquote><p><code>/usr/bin/ansible</code>ã€€ã€€Ansibe AD-Hoc ä¸´æ—¶å‘½ä»¤æ‰§è¡Œå·¥å…·ï¼Œå¸¸ç”¨äºä¸´æ—¶å‘½ä»¤çš„æ‰§è¡Œ<br><code>/usr/bin/ansible-doc</code> ã€€ã€€Ansible æ¨¡å—åŠŸèƒ½æŸ¥çœ‹å·¥å…·<br><code>/usr/bin/ansible-galaxy</code>ã€€ã€€ä¸‹è½½/ä¸Šä¼ ä¼˜ç§€ä»£ç æˆ–Rolesæ¨¡å— çš„å®˜ç½‘å¹³å°ï¼ŒåŸºäºç½‘ç»œçš„<br><code>/usr/bin/ansible-playbook</code>ã€€ã€€Ansible å®šåˆ¶è‡ªåŠ¨åŒ–çš„ä»»åŠ¡é›†ç¼–æ’å·¥å…·<br><code>/usr/bin/ansible-pull</code>ã€€ã€€Ansibleè¿œç¨‹æ‰§è¡Œå‘½ä»¤çš„å·¥å…·ï¼Œæ‹‰å–é…ç½®è€Œéæ¨é€é…ç½®ï¼ˆä½¿ç”¨è¾ƒå°‘ï¼Œæµ·é‡æœºå™¨æ—¶ä½¿ç”¨ï¼Œå¯¹è¿ç»´çš„æ¶æ„èƒ½åŠ›è¦æ±‚è¾ƒé«˜ï¼‰<br><code>/usr/bin/ansible-vault</code>ã€€ã€€    Ansible æ–‡ä»¶åŠ å¯†å·¥å…·<br><code>/usr/bin/ansible-console</code>ã€€ã€€AnsibleåŸºäºLinux Consobleç•Œé¢å¯ä¸ç”¨æˆ·äº¤äº’çš„å‘½ä»¤æ‰§è¡Œå·¥å…·</p></blockquote><p>ã€€ã€€å…¶ä¸­ï¼Œæˆ‘ä»¬æ¯”è¾ƒå¸¸ç”¨çš„æ˜¯<code>/usr/bin/ansible</code>å’Œ<code>/usr/bin/ansible-playbook</code>ã€‚</p><h3 id="2ã€ansible-doc-å‘½ä»¤"><a href="#2ã€ansible-doc-å‘½ä»¤" class="headerlink" title="2ã€ansible-doc å‘½ä»¤"></a>2ã€ansible-doc å‘½ä»¤</h3><p>ã€€ã€€ansible-doc å‘½ä»¤å¸¸ç”¨äºè·å–æ¨¡å—ä¿¡æ¯åŠå…¶ä½¿ç”¨å¸®åŠ©ï¼Œä¸€èˆ¬ç”¨æ³•å¦‚ä¸‹ï¼š</p><pre><code>    ansible-doc -l              #è·å–å…¨éƒ¨æ¨¡å—çš„ä¿¡æ¯    ansible-doc -s MOD_NAME     #è·å–æŒ‡å®šæ¨¡å—çš„ä½¿ç”¨å¸®åŠ©</code></pre><p>ã€€ã€€æˆ‘ä»¬ä¹Ÿå¯ä»¥æŸ¥çœ‹ä¸€ä¸‹ansible-docçš„å…¨éƒ¨ç”¨æ³•ï¼š</p><pre><code>[root@server ~]# ansible-docUsage: ansible-doc [options] [module...]Options:  -h, --help            show this help message and exitã€€ã€€# æ˜¾ç¤ºå‘½ä»¤å‚æ•°APIæ–‡æ¡£  -l, --list            List available modulesã€€ã€€#åˆ—å‡ºå¯ç”¨çš„æ¨¡å—  -M MODULE_PATH, --module-path=MODULE_PATHã€€ã€€#æŒ‡å®šæ¨¡å—çš„è·¯å¾„                        specify path(s) to module library (default=None)  -s, --snippet         Show playbook snippet for specified module(s)ã€€ã€€#æ˜¾ç¤ºplaybookåˆ¶å®šæ¨¡å—çš„ç”¨æ³•  -v, --verbose         verbose mode (-vvv for more, -vvvv to enableã€€ã€€# æ˜¾ç¤ºansible-docçš„ç‰ˆæœ¬å·æŸ¥çœ‹æ¨¡å—åˆ—è¡¨ï¼š                        connection debugging)  --version             show program&#39;s version number and exit</code></pre><p>ã€€ã€€æˆ‘ä»¬å¯ä»¥æ¥çœ‹ä¸€ä¸‹ï¼Œä»¥mysqlç›¸å…³çš„ä¸ºä¾‹ï¼š</p><pre><code>[root@server ~]# ansible-doc -l |grep mysqlmysql_db                           Add or remove MySQL databases from a remote...mysql_replication                  Manage MySQL replication                   mysql_user                         Adds or removes a user from a MySQL databas...mysql_variables                    Manage MySQL global variables      [root@server ~]# ansible-doc -s mysql_user</code></pre><h3 id="2ã€ansible-å‘½ä»¤è¯¦è§£"><a href="#2ã€ansible-å‘½ä»¤è¯¦è§£" class="headerlink" title="2ã€ansible å‘½ä»¤è¯¦è§£"></a>2ã€ansible å‘½ä»¤è¯¦è§£</h3><p>ã€€ã€€å‘½ä»¤çš„å…·ä½“æ ¼å¼å¦‚ä¸‹ï¼š</p><pre><code>ansible &lt;host-pattern&gt; [-f forks] [-m module_name] [-a args]</code></pre><p>ã€€ã€€ä¹Ÿå¯ä»¥é€šè¿‡<code>ansible -h</code>æ¥æŸ¥çœ‹å¸®åŠ©ï¼Œä¸‹é¢æˆ‘ä»¬åˆ—å‡ºä¸€äº›æ¯”è¾ƒå¸¸ç”¨çš„é€‰é¡¹ï¼Œå¹¶è§£é‡Šå…¶å«ä¹‰ï¼š</p><blockquote><p><code>-a MODULE_ARGS</code> #æ¨¡å—çš„å‚æ•°ï¼Œå¦‚æœæ‰§è¡Œé»˜è®¤COMMANDçš„æ¨¡å—ï¼Œå³æ˜¯å‘½ä»¤å‚æ•°ï¼Œå¦‚ï¼š â€œdateâ€ï¼Œâ€œpwdâ€ç­‰ç­‰<br><code>-k</code>ï¼Œ<code>--ask-pass</code> #ask for SSH passwordã€‚ç™»å½•å¯†ç ï¼Œæç¤ºè¾“å…¥SSHå¯†ç è€Œä¸æ˜¯å‡è®¾åŸºäºå¯†é’¥çš„éªŒè¯<br><code>--ask-su-pass</code> #ask for su passwordã€‚suåˆ‡æ¢å¯†ç <br><code>-K</code>ï¼Œ<code>--ask-sudo-pass</code> #ask for sudo passwordã€‚æç¤ºå¯†ç ä½¿ç”¨sudoï¼Œsudoè¡¨ç¤ºææƒæ“ä½œ<br><code>--ask-vault-pass</code> #ask for vault passwordã€‚å‡è®¾æˆ‘ä»¬è®¾å®šäº†åŠ å¯†çš„å¯†ç ï¼Œåˆ™ç”¨è¯¥é€‰é¡¹è¿›è¡Œè®¿é—®<br><code>-B SECONDS</code> #åå°è¿è¡Œè¶…æ—¶æ—¶é—´<br><code>-C</code> #æ¨¡æ‹Ÿè¿è¡Œç¯å¢ƒå¹¶è¿›è¡Œé¢„è¿è¡Œï¼Œå¯ä»¥è¿›è¡ŒæŸ¥é”™æµ‹è¯•<br><code>-c CONNECTION</code> #è¿æ¥ç±»å‹ä½¿ç”¨<br><code>-f FORKS</code> #å¹¶è¡Œä»»åŠ¡æ•°ï¼Œé»˜è®¤ä¸º5<br><code>-i INVENTORY</code> #æŒ‡å®šä¸»æœºæ¸…å•çš„è·¯å¾„ï¼Œé»˜è®¤ä¸º<code>/etc/ansible/hosts</code><br><code>--list-hosts</code> #æŸ¥çœ‹æœ‰å“ªäº›ä¸»æœºç»„<br><code>-m MODULE_NAME</code> #æ‰§è¡Œæ¨¡å—çš„åå­—ï¼Œé»˜è®¤ä½¿ç”¨ command æ¨¡å—ï¼Œæ‰€ä»¥å¦‚æœæ˜¯åªæ‰§è¡Œå•ä¸€å‘½ä»¤å¯ä»¥ä¸ç”¨ -må‚æ•°<br><code>-o</code> #å‹ç¼©è¾“å‡ºï¼Œå°è¯•å°†æ‰€æœ‰ç»“æœåœ¨ä¸€è¡Œè¾“å‡ºï¼Œä¸€èˆ¬é’ˆå¯¹æ”¶é›†å·¥å…·ä½¿ç”¨<br><code>-S</code> #ç”¨ su å‘½ä»¤<br><code>-R SU_USER</code> #æŒ‡å®š su çš„ç”¨æˆ·ï¼Œé»˜è®¤ä¸º root ç”¨æˆ·<br><code>-s</code> #ç”¨ sudo å‘½ä»¤<br><code>-U SUDO_USER</code> #æŒ‡å®š sudo åˆ°å“ªä¸ªç”¨æˆ·ï¼Œé»˜è®¤ä¸º root ç”¨æˆ·<br><code>-T TIMEOUT</code> #æŒ‡å®š ssh é»˜è®¤è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤ä¸º10sï¼Œä¹Ÿå¯åœ¨é…ç½®æ–‡ä»¶ä¸­ä¿®æ”¹<br><code>-u REMOTE_USER</code> #è¿œç¨‹ç”¨æˆ·ï¼Œé»˜è®¤ä¸º root ç”¨æˆ·<br><code>-v</code> #æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯ï¼ŒåŒæ—¶æ”¯æŒ<code>-vvv</code>ï¼Œ<code>-vvvv</code>å¯æŸ¥çœ‹æ›´è¯¦ç»†ä¿¡æ¯</p></blockquote><h3 id="3ã€ansible-é…ç½®å…¬ç§é’¥"><a href="#3ã€ansible-é…ç½®å…¬ç§é’¥" class="headerlink" title="3ã€ansible é…ç½®å…¬ç§é’¥"></a>3ã€ansible é…ç½®å…¬ç§é’¥</h3><p>ã€€ã€€ä¸Šé¢æˆ‘ä»¬å·²ç»æåˆ°è¿‡ ansible æ˜¯åŸºäº ssh åè®®å®ç°çš„ï¼Œæ‰€ä»¥å…¶é…ç½®å…¬ç§é’¥çš„æ–¹å¼ä¸ ssh åè®®çš„æ–¹å¼ç›¸åŒï¼Œå…·ä½“æ“ä½œæ­¥éª¤å¦‚ä¸‹ï¼š</p><pre><code>#1.ç”Ÿæˆç§é’¥[root@server ~]# ssh-keygen #2.å‘ä¸»æœºåˆ†å‘ç§é’¥[root@server ~]# ssh-copy-id root@192.168.37.122[root@server ~]# ssh-copy-id root@192.168.37.133</code></pre><p>ã€€ã€€è¿™æ ·çš„è¯ï¼Œå°±å¯ä»¥å®ç°æ— å¯†ç ç™»å½•ï¼Œæˆ‘ä»¬çš„å®éªŒè¿‡ç¨‹ä¹Ÿä¼šé¡ºç•…å¾ˆå¤šã€‚<br> ã€€ã€€æ³¨æ„ï¼Œå¦‚æœå‡ºç°äº†ä¸€ä¸‹æŠ¥é”™ï¼š</p><pre><code>    -bash: ssh-copy-id: command not found</code></pre><p>ã€€ã€€é‚£ä¹ˆå°±è¯æ˜æˆ‘ä»¬éœ€è¦å®‰è£…ä¸€ä¸ªåŒ…ï¼š</p><pre><code>    yum -y install openssh-clientsansible</code></pre><p>ã€€ã€€æŠŠåŒ…å®‰è£…ä¸Šå³å¯ã€‚</p><h2 id="äº”ã€ansible-å¸¸ç”¨æ¨¡å—"><a href="#äº”ã€ansible-å¸¸ç”¨æ¨¡å—" class="headerlink" title="äº”ã€ansible å¸¸ç”¨æ¨¡å—"></a>äº”ã€ansible å¸¸ç”¨æ¨¡å—</h2><h3 id="1ã€ä¸»æœºè¿é€šæ€§æµ‹è¯•"><a href="#1ã€ä¸»æœºè¿é€šæ€§æµ‹è¯•" class="headerlink" title="1ã€ä¸»æœºè¿é€šæ€§æµ‹è¯•"></a>1ã€ä¸»æœºè¿é€šæ€§æµ‹è¯•</h3><p>ã€€ã€€æˆ‘ä»¬ä½¿ç”¨<code>ansible web -m ping</code>å‘½ä»¤æ¥è¿›è¡Œä¸»æœºè¿é€šæ€§æµ‹è¯•ï¼Œæ•ˆæœå¦‚ä¸‹ï¼š</p><pre><code>[root@server ~]# ansible web -m ping192.168.37.122 | SUCCESS =&gt; {    &quot;changed&quot;: false,     &quot;ping&quot;: &quot;pong&quot;}192.168.37.133 | SUCCESS =&gt; {    &quot;changed&quot;: false,     &quot;ping&quot;: &quot;pong&quot;}</code></pre><p>ã€€ã€€è¿™æ ·å°±è¯´æ˜æˆ‘ä»¬çš„ä¸»æœºæ˜¯è¿é€šçŠ¶æ€çš„ã€‚æ¥ä¸‹æ¥çš„æ“ä½œæ‰å¯ä»¥æ­£å¸¸è¿›è¡Œã€‚</p><h3 id="2ã€command-æ¨¡å—"><a href="#2ã€command-æ¨¡å—" class="headerlink" title="2ã€command æ¨¡å—"></a>2ã€command æ¨¡å—</h3><p>ã€€ã€€è¿™ä¸ªæ¨¡å—å¯ä»¥ç›´æ¥åœ¨è¿œç¨‹ä¸»æœºä¸Šæ‰§è¡Œå‘½ä»¤ï¼Œå¹¶å°†ç»“æœè¿”å›æœ¬ä¸»æœºã€‚<br> ã€€ã€€ä¸¾ä¾‹å¦‚ä¸‹ï¼š</p><pre><code>[root@server ~]# ansible web -m command -a &#39;ss -ntl&#39;192.168.37.122 | SUCCESS | rc=0 &gt;&gt;State      Recv-Q Send-Q Local Address:Port               Peer Address:Port              LISTEN     0      128          *:111                      *:*                  LISTEN     0      5      192.168.122.1:53                       *:*                  LISTEN     0      128          *:22                       *:*                  LISTEN     0      128    127.0.0.1:631                      *:*                  LISTEN     0      128          *:23000                    *:*                  LISTEN     0      100    127.0.0.1:25                       *:*                  LISTEN     0      128         :::111                     :::*                  LISTEN     0      128         :::22                      :::*                  LISTEN     0      128        ::1:631                     :::*                  LISTEN     0      100        ::1:25                      :::*                  192.168.37.133 | SUCCESS | rc=0 &gt;&gt;State      Recv-Q Send-Q Local Address:Port               Peer Address:Port              LISTEN     0      128          *:111                      *:*                  LISTEN     0      128          *:22                       *:*                  LISTEN     0      128    127.0.0.1:631                      *:*                  LISTEN     0      128          *:23000                    *:*                  LISTEN     0      100    127.0.0.1:25                       *:*                  LISTEN     0      128         :::111                     :::*                  LISTEN     0      128         :::22                      :::*                  LISTEN     0      128        ::1:631                     :::*                  LISTEN     0      100        ::1:25                      :::*  </code></pre><p>ã€€ã€€å‘½ä»¤æ¨¡å—æ¥å—å‘½ä»¤åç§°ï¼Œåé¢æ˜¯ç©ºæ ¼åˆ†éš”çš„åˆ—è¡¨å‚æ•°ã€‚ç»™å®šçš„å‘½ä»¤å°†åœ¨æ‰€æœ‰é€‰å®šçš„èŠ‚ç‚¹ä¸Šæ‰§è¡Œã€‚å®ƒä¸ä¼šé€šè¿‡shellè¿›è¡Œå¤„ç†ï¼Œæ¯”å¦‚$HOMEå’Œæ“ä½œå¦‚â€&lt;â€ï¼Œâ€&gt;â€ï¼Œâ€|â€ï¼Œâ€;â€ï¼Œâ€&amp;â€ å·¥ä½œï¼ˆéœ€è¦ä½¿ç”¨ï¼ˆshellï¼‰æ¨¡å—å®ç°è¿™äº›åŠŸèƒ½ï¼‰ã€‚æ³¨æ„ï¼Œè¯¥å‘½ä»¤ä¸æ”¯æŒ<code>| ç®¡é“å‘½ä»¤</code>ã€‚<br> ã€€ã€€ä¸‹é¢æ¥çœ‹ä¸€çœ‹è¯¥æ¨¡å—ä¸‹å¸¸ç”¨çš„å‡ ä¸ªå‘½ä»¤ï¼š</p><blockquote><p>chdirã€€ã€€ã€€   # åœ¨æ‰§è¡Œå‘½ä»¤ä¹‹å‰ï¼Œå…ˆåˆ‡æ¢åˆ°è¯¥ç›®å½•<br>executable    # åˆ‡æ¢shellæ¥æ‰§è¡Œå‘½ä»¤ï¼Œéœ€è¦ä½¿ç”¨å‘½ä»¤çš„ç»å¯¹è·¯å¾„<br>free_form ã€€ # è¦æ‰§è¡Œçš„LinuxæŒ‡ä»¤ï¼Œä¸€èˆ¬ä½¿ç”¨Ansibleçš„-aå‚æ•°ä»£æ›¿ã€‚<br>creates ã€€      # ä¸€ä¸ªæ–‡ä»¶åï¼Œå½“è¿™ä¸ªæ–‡ä»¶å­˜åœ¨ï¼Œåˆ™è¯¥å‘½ä»¤ä¸æ‰§è¡Œ,å¯ä»¥ç”¨æ¥åšåˆ¤æ–­<br>removes        # ä¸€ä¸ªæ–‡ä»¶åï¼Œè¿™ä¸ªæ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™è¯¥å‘½ä»¤ä¸æ‰§è¡Œ</p></blockquote><p>ã€€ã€€ä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹è¿™äº›å‘½ä»¤çš„æ‰§è¡Œæ•ˆæœï¼š</p><pre><code>[root@server ~]# ansible web -m command -a &#39;chdir=/data/ ls&#39;  #å…ˆåˆ‡æ¢åˆ°/data/ ç›®å½•ï¼Œå†æ‰§è¡Œâ€œlsâ€å‘½ä»¤192.168.37.122 | SUCCESS | rc=0 &gt;&gt;aaa.jpgfastdfsmogdatatmpwebwKgleloeYoCAMLtZAAAWEekAtkc497.jpg192.168.37.133 | SUCCESS | rc=0 &gt;&gt;aaa.jpgfastdfsmogdatatmpwebwKgleloeYoCAMLtZAAAWEekAtkc497.jpg[root@server ~]# ansible web -m command -a &#39;creates=/data/aaa.jpg ls&#39;  #å¦‚æœ/data/aaa.jpgå­˜åœ¨ï¼Œåˆ™ä¸æ‰§è¡Œâ€œlsâ€å‘½ä»¤192.168.37.122 | SUCCESS | rc=0 &gt;&gt;skipped, since /data/aaa.jpg exists192.168.37.133 | SUCCESS | rc=0 &gt;&gt;skipped, since /data/aaa.jpg exists[root@server ~]# ansible web -m command -a &#39;removes=/data/aaa.jpg cat /data/a&#39; #å¦‚æœ/data/aaa.jpgå­˜åœ¨ï¼Œåˆ™æ‰§è¡Œâ€œcat /data/aâ€å‘½ä»¤192.168.37.122 | SUCCESS | rc=0 &gt;&gt;hello192.168.37.133 | SUCCESS | rc=0 &gt;&gt;hello</code></pre><h3 id="3ã€shell-æ¨¡å—"><a href="#3ã€shell-æ¨¡å—" class="headerlink" title="3ã€shell æ¨¡å—"></a>3ã€shell æ¨¡å—</h3><p>ã€€ã€€shellæ¨¡å—å¯ä»¥åœ¨è¿œç¨‹ä¸»æœºä¸Šè°ƒç”¨shellè§£é‡Šå™¨è¿è¡Œå‘½ä»¤ï¼Œæ”¯æŒshellçš„å„ç§åŠŸèƒ½ï¼Œä¾‹å¦‚ç®¡é“ç­‰ã€‚</p><pre><code>[root@server ~]# ansible web -m shell -a &#39;cat /etc/passwd |grep &quot;keer&quot;&#39;192.168.37.122 | SUCCESS | rc=0 &gt;&gt;keer:x:10001:1000:keer:/home/keer:/bin/sh192.168.37.133 | SUCCESS | rc=0 &gt;&gt;keer:x:10001:10001::/home/keer:/bin/sh</code></pre><p>ã€€ã€€åªè¦æ˜¯æˆ‘ä»¬çš„shellå‘½ä»¤ï¼Œéƒ½å¯ä»¥é€šè¿‡è¿™ä¸ªæ¨¡å—åœ¨è¿œç¨‹ä¸»æœºä¸Šè¿è¡Œï¼Œè¿™é‡Œå°±ä¸ä¸€ä¸€ä¸¾ä¾‹äº†ã€‚</p><h3 id="4ã€copy-æ¨¡å—"><a href="#4ã€copy-æ¨¡å—" class="headerlink" title="4ã€copy æ¨¡å—"></a>4ã€copy æ¨¡å—</h3><p>ã€€ã€€è¿™ä¸ªæ¨¡å—ç”¨äºå°†æ–‡ä»¶å¤åˆ¶åˆ°è¿œç¨‹ä¸»æœºï¼ŒåŒæ—¶æ”¯æŒç»™å®šå†…å®¹ç”Ÿæˆæ–‡ä»¶å’Œä¿®æ”¹æƒé™ç­‰ã€‚<br> ã€€ã€€å…¶ç›¸å…³é€‰é¡¹å¦‚ä¸‹ï¼š</p><blockquote><p><code>src</code>ã€€ã€€ã€€ã€€ #è¢«å¤åˆ¶åˆ°è¿œç¨‹ä¸»æœºçš„æœ¬åœ°æ–‡ä»¶ã€‚å¯ä»¥æ˜¯ç»å¯¹è·¯å¾„ï¼Œä¹Ÿå¯ä»¥æ˜¯ç›¸å¯¹è·¯å¾„ã€‚å¦‚æœè·¯å¾„æ˜¯ä¸€ä¸ªç›®å½•ï¼Œåˆ™ä¼šé€’å½’å¤åˆ¶ï¼Œç”¨æ³•ç±»ä¼¼äºâ€rsyncâ€<br><code>content</code>ã€€ã€€#ç”¨äºæ›¿æ¢â€srcâ€ï¼Œå¯ä»¥ç›´æ¥æŒ‡å®šæ–‡ä»¶çš„å€¼<br><code>dest</code>ã€€ã€€ã€€   #å¿…é€‰é¡¹ï¼Œå°†æºæ–‡ä»¶å¤åˆ¶åˆ°çš„è¿œç¨‹ä¸»æœºçš„<strong>ç»å¯¹è·¯å¾„</strong><br><code>backup</code>ã€€ã€€ã€€#å½“æ–‡ä»¶å†…å®¹å‘ç”Ÿæ”¹å˜åï¼Œåœ¨è¦†ç›–ä¹‹å‰æŠŠæºæ–‡ä»¶å¤‡ä»½ï¼Œå¤‡ä»½æ–‡ä»¶åŒ…å«æ—¶é—´ä¿¡æ¯<br><code>directory_mode</code>ã€€ã€€ã€€ã€€#é€’å½’è®¾å®šç›®å½•çš„æƒé™ï¼Œé»˜è®¤ä¸ºç³»ç»Ÿé»˜è®¤æƒé™<br><code>force</code>ã€€ã€€ã€€ã€€#å½“ç›®æ ‡ä¸»æœºåŒ…å«è¯¥æ–‡ä»¶ï¼Œä½†å†…å®¹ä¸åŒæ—¶ï¼Œè®¾ä¸ºâ€yesâ€ï¼Œè¡¨ç¤ºå¼ºåˆ¶è¦†ç›–ï¼›è®¾ä¸ºâ€noâ€ï¼Œè¡¨ç¤ºç›®æ ‡ä¸»æœºçš„ç›®æ ‡ä½ç½®ä¸å­˜åœ¨è¯¥æ–‡ä»¶æ‰å¤åˆ¶ã€‚é»˜è®¤ä¸ºâ€yesâ€<br><code>others</code>ã€€ã€€ã€€ã€€#æ‰€æœ‰çš„ file æ¨¡å—ä¸­çš„é€‰é¡¹å¯ä»¥åœ¨è¿™é‡Œä½¿ç”¨</p></blockquote><p>ç”¨æ³•ä¸¾ä¾‹å¦‚ä¸‹ï¼š<br><strong>â‘  å¤åˆ¶æ–‡ä»¶ï¼š</strong></p><pre><code>[root@server ~]# ansible web -m copy -a &#39;src=~/hello dest=/data/hello&#39; 192.168.37.122 | SUCCESS =&gt; {    &quot;changed&quot;: true,     &quot;checksum&quot;: &quot;22596363b3de40b06f981fb85d82312e8c0ed511&quot;,     &quot;dest&quot;: &quot;/data/hello&quot;,     &quot;gid&quot;: 0,     &quot;group&quot;: &quot;root&quot;,     &quot;md5sum&quot;: &quot;6f5902ac237024bdd0c176cb93063dc4&quot;,     &quot;mode&quot;: &quot;0644&quot;,     &quot;owner&quot;: &quot;root&quot;,     &quot;size&quot;: 12,     &quot;src&quot;: &quot;/root/.ansible/tmp/ansible-tmp-1512437093.55-228281064292921/source&quot;,     &quot;state&quot;: &quot;file&quot;,     &quot;uid&quot;: 0}192.168.37.133 | SUCCESS =&gt; {    &quot;changed&quot;: true,     &quot;checksum&quot;: &quot;22596363b3de40b06f981fb85d82312e8c0ed511&quot;,     &quot;dest&quot;: &quot;/data/hello&quot;,     &quot;gid&quot;: 0,     &quot;group&quot;: &quot;root&quot;,     &quot;md5sum&quot;: &quot;6f5902ac237024bdd0c176cb93063dc4&quot;,     &quot;mode&quot;: &quot;0644&quot;,     &quot;owner&quot;: &quot;root&quot;,     &quot;size&quot;: 12,     &quot;src&quot;: &quot;/root/.ansible/tmp/ansible-tmp-1512437093.74-44694985235189/source&quot;,     &quot;state&quot;: &quot;file&quot;,     &quot;uid&quot;: 0}</code></pre><p><strong>â‘¡ ç»™å®šå†…å®¹ç”Ÿæˆæ–‡ä»¶ï¼Œå¹¶åˆ¶å®šæƒé™</strong></p><pre><code>[root@server ~]# ansible web -m copy -a &#39;content=&quot;I am keer\n&quot; dest=/data/name mode=666&#39;192.168.37.122 | SUCCESS =&gt; {    &quot;changed&quot;: true,     &quot;checksum&quot;: &quot;0421570938940ea784f9d8598dab87f07685b968&quot;,     &quot;dest&quot;: &quot;/data/name&quot;,     &quot;gid&quot;: 0,     &quot;group&quot;: &quot;root&quot;,     &quot;md5sum&quot;: &quot;497fa8386590a5fc89090725b07f175c&quot;,     &quot;mode&quot;: &quot;0666&quot;,     &quot;owner&quot;: &quot;root&quot;,     &quot;size&quot;: 10,     &quot;src&quot;: &quot;/root/.ansible/tmp/ansible-tmp-1512437327.37-199512601767687/source&quot;,     &quot;state&quot;: &quot;file&quot;,     &quot;uid&quot;: 0}192.168.37.133 | SUCCESS =&gt; {    &quot;changed&quot;: true,     &quot;checksum&quot;: &quot;0421570938940ea784f9d8598dab87f07685b968&quot;,     &quot;dest&quot;: &quot;/data/name&quot;,     &quot;gid&quot;: 0,     &quot;group&quot;: &quot;root&quot;,     &quot;md5sum&quot;: &quot;497fa8386590a5fc89090725b07f175c&quot;,     &quot;mode&quot;: &quot;0666&quot;,     &quot;owner&quot;: &quot;root&quot;,     &quot;size&quot;: 10,         &quot;src&quot;: &quot;/root/.ansible/tmp/ansible-tmp-1512437327.55-218104039503110/source&quot;,     &quot;state&quot;: &quot;file&quot;,     &quot;uid&quot;: 0}</code></pre><p>ã€€ã€€æˆ‘ä»¬ç°åœ¨å¯ä»¥å»æŸ¥çœ‹ä¸€ä¸‹æˆ‘ä»¬ç”Ÿæˆçš„æ–‡ä»¶åŠå…¶æƒé™ï¼š</p><pre><code>[root@server ~]# ansible web -m shell -a &#39;ls -l /data/&#39;192.168.37.122 | SUCCESS | rc=0 &gt;&gt;total 28-rw-rw-rw-   1 root root   12 Dec  6 09:45 name192.168.37.133 | SUCCESS | rc=0 &gt;&gt;total 40-rw-rw-rw- 1 root     root       12 Dec  5 09:45 name</code></pre><p>ã€€ã€€å¯ä»¥çœ‹å‡ºæˆ‘ä»¬çš„nameæ–‡ä»¶å·²ç»ç”Ÿæˆï¼Œå¹¶ä¸”æƒé™ä¸º666ã€‚<br><strong>â‘¢ å…³äºè¦†ç›–</strong><br> ã€€ã€€æˆ‘ä»¬æŠŠæ–‡ä»¶çš„å†…å®¹ä¿®æ”¹ä¸€ä¸‹ï¼Œç„¶åé€‰æ‹©è¦†ç›–å¤‡ä»½ï¼š</p><pre><code>[root@server ~]# ansible web -m copy -a &#39;content=&quot;I am keerya\n&quot; backup=yes dest=/data/name mode=666&#39;192.168.37.122 | SUCCESS =&gt; {    &quot;backup_file&quot;: &quot;/data/name.4394.2017-12-06@09:46:25~&quot;,     &quot;changed&quot;: true,     &quot;checksum&quot;: &quot;064a68908ab9971ee85dbc08ea038387598e3778&quot;,     &quot;dest&quot;: &quot;/data/name&quot;,     &quot;gid&quot;: 0,     &quot;group&quot;: &quot;root&quot;,     &quot;md5sum&quot;: &quot;8ca7c11385856155af52e560f608891c&quot;,     &quot;mode&quot;: &quot;0666&quot;,     &quot;owner&quot;: &quot;root&quot;,     &quot;size&quot;: 12,     &quot;src&quot;: &quot;/root/.ansible/tmp/ansible-tmp-1512438383.78-228128616784888/source&quot;,     &quot;state&quot;: &quot;file&quot;,     &quot;uid&quot;: 0}192.168.37.133 | SUCCESS =&gt; {    &quot;backup_file&quot;: &quot;/data/name.5962.2017-12-05@09:46:24~&quot;,     &quot;changed&quot;: true,     &quot;checksum&quot;: &quot;064a68908ab9971ee85dbc08ea038387598e3778&quot;,     &quot;dest&quot;: &quot;/data/name&quot;,     &quot;gid&quot;: 0,     &quot;group&quot;: &quot;root&quot;,     &quot;md5sum&quot;: &quot;8ca7c11385856155af52e560f608891c&quot;,     &quot;mode&quot;: &quot;0666&quot;,     &quot;owner&quot;: &quot;root&quot;,     &quot;size&quot;: 12,     &quot;src&quot;: &quot;/root/.ansible/tmp/ansible-tmp-1512438384.0-170718946740009/source&quot;,     &quot;state&quot;: &quot;file&quot;,     &quot;uid&quot;: 0}</code></pre><p>ã€€ã€€ç°åœ¨æˆ‘ä»¬å¯ä»¥å»æŸ¥çœ‹ä¸€ä¸‹ï¼š</p><pre><code>[root@server ~]# ansible web -m shell -a &#39;ls -l /data/&#39;192.168.37.122 | SUCCESS | rc=0 &gt;&gt;total 28-rw-rw-rw-   1 root root   12 Dec  6 09:46 name-rw-rw-rw-   1 root root   10 Dec  6 09:45 name.4394.2017-12-06@09:46:25~192.168.37.133 | SUCCESS | rc=0 &gt;&gt;total 40-rw-rw-rw- 1 root     root       12 Dec  5 09:46 name-rw-rw-rw- 1 root     root       10 Dec  5 09:45 name.5962.2017-12-05@09:46:24~</code></pre><p>ã€€ã€€å¯ä»¥çœ‹å‡ºï¼Œæˆ‘ä»¬çš„æºæ–‡ä»¶å·²ç»è¢«å¤‡ä»½ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥æŸ¥çœ‹ä¸€ä¸‹<code>name</code>æ–‡ä»¶çš„å†…å®¹ï¼š</p><pre><code>[root@server ~]# ansible web -m shell -a &#39;cat /data/name&#39;192.168.37.122 | SUCCESS | rc=0 &gt;&gt;I am keerya192.168.37.133 | SUCCESS | rc=0 &gt;&gt;I am keerya</code></pre><p>ã€€ã€€è¯æ˜ï¼Œè¿™æ­£æ˜¯æˆ‘ä»¬æ–°å¯¼å…¥çš„æ–‡ä»¶çš„å†…å®¹ã€‚</p><h3 id="5ã€file-æ¨¡å—"><a href="#5ã€file-æ¨¡å—" class="headerlink" title="5ã€file æ¨¡å—"></a>5ã€file æ¨¡å—</h3><p>ã€€ã€€è¯¥æ¨¡å—ä¸»è¦ç”¨äºè®¾ç½®æ–‡ä»¶çš„å±æ€§ï¼Œæ¯”å¦‚åˆ›å»ºæ–‡ä»¶ã€åˆ›å»ºé“¾æ¥æ–‡ä»¶ã€åˆ é™¤æ–‡ä»¶ç­‰ã€‚<br> ã€€ã€€ä¸‹é¢æ˜¯ä¸€äº›å¸¸è§çš„å‘½ä»¤ï¼š</p><blockquote><p><code>force</code>ã€€ã€€#éœ€è¦åœ¨ä¸¤ç§æƒ…å†µä¸‹å¼ºåˆ¶åˆ›å»ºè½¯é“¾æ¥ï¼Œä¸€ç§æ˜¯æºæ–‡ä»¶ä¸å­˜åœ¨ï¼Œä½†ä¹‹åä¼šå»ºç«‹çš„æƒ…å†µä¸‹ï¼›å¦ä¸€ç§æ˜¯ç›®æ ‡è½¯é“¾æ¥å·²å­˜åœ¨ï¼Œéœ€è¦å…ˆå–æ¶ˆä¹‹å‰çš„è½¯é“¾ï¼Œç„¶ååˆ›å»ºæ–°çš„è½¯é“¾ï¼Œæœ‰ä¸¤ä¸ªé€‰é¡¹ï¼šyes|no<br><code>group</code>ã€€ã€€#å®šä¹‰æ–‡ä»¶/ç›®å½•çš„å±ç»„ã€‚åé¢å¯ä»¥åŠ ä¸Š<code>mode</code>ï¼šå®šä¹‰æ–‡ä»¶/ç›®å½•çš„æƒé™<br><code>owner</code>ã€€ã€€#å®šä¹‰æ–‡ä»¶/ç›®å½•çš„å±ä¸»ã€‚åé¢å¿…é¡»è·Ÿä¸Š<code>path</code>ï¼šå®šä¹‰æ–‡ä»¶/ç›®å½•çš„è·¯å¾„<br><code>recurse</code>ã€€ã€€#é€’å½’è®¾ç½®æ–‡ä»¶çš„å±æ€§ï¼Œåªå¯¹ç›®å½•æœ‰æ•ˆï¼Œåé¢è·Ÿä¸Š<code>src</code>ï¼šè¢«é“¾æ¥çš„æºæ–‡ä»¶è·¯å¾„ï¼Œåªåº”ç”¨äº<code>state=link</code>çš„æƒ…å†µ<br><code>dest</code>ã€€ã€€#è¢«é“¾æ¥åˆ°çš„è·¯å¾„ï¼Œåªåº”ç”¨äº<code>state=link</code>çš„æƒ…å†µ<br><code>state</code>ã€€ã€€#çŠ¶æ€ï¼Œæœ‰ä»¥ä¸‹é€‰é¡¹ï¼š</p><p><code>directory</code>ï¼šå¦‚æœç›®å½•ä¸å­˜åœ¨ï¼Œå°±åˆ›å»ºç›®å½•<br><code>file</code>ï¼šå³ä½¿æ–‡ä»¶ä¸å­˜åœ¨ï¼Œä¹Ÿä¸ä¼šè¢«åˆ›å»º<br><code>link</code>ï¼šåˆ›å»ºè½¯é“¾æ¥<br><code>hard</code>ï¼šåˆ›å»ºç¡¬é“¾æ¥<br><code>touch</code>ï¼šå¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„æ–‡ä»¶ï¼Œå¦‚æœæ–‡ä»¶æˆ–ç›®å½•å·²å­˜åœ¨ï¼Œåˆ™æ›´æ–°å…¶æœ€åä¿®æ”¹æ—¶é—´<br><code>absent</code>ï¼šåˆ é™¤ç›®å½•ã€æ–‡ä»¶æˆ–è€…å–æ¶ˆé“¾æ¥æ–‡ä»¶</p></blockquote><p>ã€€ã€€ç”¨æ³•ä¸¾ä¾‹å¦‚ä¸‹ï¼š<br><strong>â‘  åˆ›å»ºç›®å½•ï¼š</strong></p><pre><code>[root@server ~]# ansible web -m file -a &#39;path=/data/app state=directory&#39;192.168.37.122 | SUCCESS =&gt; {    &quot;changed&quot;: true,     &quot;gid&quot;: 0,     &quot;group&quot;: &quot;root&quot;,     &quot;mode&quot;: &quot;0755&quot;,     &quot;owner&quot;: &quot;root&quot;,     &quot;path&quot;: &quot;/data/app&quot;,     &quot;size&quot;: 6,     &quot;state&quot;: &quot;directory&quot;,     &quot;uid&quot;: 0}192.168.37.133 | SUCCESS =&gt; {    &quot;changed&quot;: true,     &quot;gid&quot;: 0,     &quot;group&quot;: &quot;root&quot;,     &quot;mode&quot;: &quot;0755&quot;,     &quot;owner&quot;: &quot;root&quot;,     &quot;path&quot;: &quot;/data/app&quot;,     &quot;size&quot;: 4096,     &quot;state&quot;: &quot;directory&quot;,     &quot;uid&quot;: 0}</code></pre><p>ã€€ã€€æˆ‘ä»¬å¯ä»¥æŸ¥çœ‹ä¸€ä¸‹ï¼š</p><pre><code>[root@server ~]# ansible web -m shell -a &#39;ls -l /data&#39;192.168.37.122 | SUCCESS | rc=0 &gt;&gt;total 28drwxr-xr-x   2 root root    6 Dec  6 10:21 app192.168.37.133 | SUCCESS | rc=0 &gt;&gt;total 44drwxr-xr-x 2 root     root     4096 Dec  5 10:21 app</code></pre><p>ã€€ã€€å¯ä»¥çœ‹å‡ºï¼Œæˆ‘ä»¬çš„ç›®å½•å·²ç»åˆ›å»ºå®Œæˆã€‚<br><strong>â‘¡ åˆ›å»ºé“¾æ¥æ–‡ä»¶</strong></p><pre><code>[root@server ~]# ansible web -m file -a &#39;path=/data/bbb.jpg src=aaa.jpg state=link&#39;192.168.37.122 | SUCCESS =&gt; {    &quot;changed&quot;: true,     &quot;dest&quot;: &quot;/data/bbb.jpg&quot;,     &quot;gid&quot;: 0,     &quot;group&quot;: &quot;root&quot;,     &quot;mode&quot;: &quot;0777&quot;,     &quot;owner&quot;: &quot;root&quot;,     &quot;size&quot;: 7,     &quot;src&quot;: &quot;aaa.jpg&quot;,     &quot;state&quot;: &quot;link&quot;,     &quot;uid&quot;: 0}192.168.37.133 | SUCCESS =&gt; {    &quot;changed&quot;: true,     &quot;dest&quot;: &quot;/data/bbb.jpg&quot;,     &quot;gid&quot;: 0,     &quot;group&quot;: &quot;root&quot;,     &quot;mode&quot;: &quot;0777&quot;,     &quot;owner&quot;: &quot;root&quot;,     &quot;size&quot;: 7,     &quot;src&quot;: &quot;aaa.jpg&quot;,     &quot;state&quot;: &quot;link&quot;,     &quot;uid&quot;: 0}</code></pre><p>ã€€ã€€æˆ‘ä»¬å¯ä»¥å»æŸ¥çœ‹ä¸€ä¸‹ï¼š</p><pre><code>[root@server ~]# ansible web -m shell -a &#39;ls -l /data&#39;192.168.37.122 | SUCCESS | rc=0 &gt;&gt;total 28-rw-r--r--   1 root root 5649 Dec  5 13:49 aaa.jpglrwxrwxrwx   1 root root    7 Dec  6 10:25 bbb.jpg -&gt; aaa.jpg192.168.37.133 | SUCCESS | rc=0 &gt;&gt;total 44-rw-r--r-- 1 root     root     5649 Dec  4 14:44 aaa.jpglrwxrwxrwx 1 root     root        7 Dec  5 10:25 bbb.jpg -&gt; aaa.jpg</code></pre><p>ã€€ã€€æˆ‘ä»¬çš„é“¾æ¥æ–‡ä»¶å·²ç»åˆ›å»ºæˆåŠŸã€‚<br><strong>â‘¢ åˆ é™¤æ–‡ä»¶</strong></p><pre><code>[root@server ~]# ansible web -m file -a &#39;path=/data/a state=absent&#39;192.168.37.122 | SUCCESS =&gt; {    &quot;changed&quot;: true,     &quot;path&quot;: &quot;/data/a&quot;,     &quot;state&quot;: &quot;absent&quot;}192.168.37.133 | SUCCESS =&gt; {    &quot;changed&quot;: true,     &quot;path&quot;: &quot;/data/a&quot;,     &quot;state&quot;: &quot;absent&quot;}</code></pre><p>ã€€ã€€æˆ‘ä»¬å¯ä»¥æŸ¥çœ‹ä¸€ä¸‹ï¼š</p><pre><code>[root@server ~]# ansible web -m shell -a &#39;ls /data/a&#39;192.168.37.122 | FAILED | rc=2 &gt;&gt;ls: cannot access /data/a: No such file or directory192.168.37.133 | FAILED | rc=2 &gt;&gt;ls: cannot access /data/a: No such file or directory</code></pre><p>ã€€ã€€å‘ç°å·²ç»æ²¡æœ‰è¿™ä¸ªæ–‡ä»¶äº†ã€‚</p><h3 id="6ã€fetch-æ¨¡å—"><a href="#6ã€fetch-æ¨¡å—" class="headerlink" title="6ã€fetch æ¨¡å—"></a>6ã€fetch æ¨¡å—</h3><p>ã€€ã€€è¯¥æ¨¡å—ç”¨äºä»è¿œç¨‹æŸä¸»æœºè·å–ï¼ˆå¤åˆ¶ï¼‰æ–‡ä»¶åˆ°æœ¬åœ°ã€‚<br> ã€€ã€€æœ‰ä¸¤ä¸ªé€‰é¡¹ï¼š</p><blockquote><p><code>dest</code>ï¼šç”¨æ¥å­˜æ”¾æ–‡ä»¶çš„ç›®å½•<br><code>src</code>ï¼šåœ¨è¿œç¨‹æ‹‰å–çš„æ–‡ä»¶ï¼Œå¹¶ä¸”å¿…é¡»æ˜¯ä¸€ä¸ª<strong>file</strong>ï¼Œä¸èƒ½æ˜¯<strong>ç›®å½•</strong></p></blockquote><p>ã€€ã€€å…·ä½“ä¸¾ä¾‹å¦‚ä¸‹ï¼š</p><pre><code>[root@server ~]# ansible web -m fetch -a &#39;src=/data/hello dest=/data&#39;  192.168.37.122 | SUCCESS =&gt; {    &quot;changed&quot;: true,     &quot;checksum&quot;: &quot;22596363b3de40b06f981fb85d82312e8c0ed511&quot;,     &quot;dest&quot;: &quot;/data/192.168.37.122/data/hello&quot;,     &quot;md5sum&quot;: &quot;6f5902ac237024bdd0c176cb93063dc4&quot;,     &quot;remote_checksum&quot;: &quot;22596363b3de40b06f981fb85d82312e8c0ed511&quot;,     &quot;remote_md5sum&quot;: null}192.168.37.133 | SUCCESS =&gt; {    &quot;changed&quot;: true,     &quot;checksum&quot;: &quot;22596363b3de40b06f981fb85d82312e8c0ed511&quot;,     &quot;dest&quot;: &quot;/data/192.168.37.133/data/hello&quot;,     &quot;md5sum&quot;: &quot;6f5902ac237024bdd0c176cb93063dc4&quot;,     &quot;remote_checksum&quot;: &quot;22596363b3de40b06f981fb85d82312e8c0ed511&quot;,     &quot;remote_md5sum&quot;: null}</code></pre><p>ã€€ã€€æˆ‘ä»¬å¯ä»¥åœ¨æœ¬æœºä¸ŠæŸ¥çœ‹ä¸€ä¸‹æ–‡ä»¶æ˜¯å¦å¤åˆ¶æˆåŠŸã€‚è¦æ³¨æ„ï¼Œæ–‡ä»¶ä¿å­˜çš„è·¯å¾„æ˜¯æˆ‘ä»¬è®¾ç½®çš„æ¥æ”¶ç›®å½•ä¸‹çš„<code>è¢«ç®¡åˆ¶ä¸»æœºip</code>ç›®å½•ä¸‹ï¼š</p><pre><code>[root@server ~]# cd /data/[root@server data]# ls1  192.168.37.122  192.168.37.133  fastdfs  web[root@server data]# cd 192.168.37.122[root@server 192.168.37.122]# lsdata[root@server 192.168.37.122]# cd data/[root@server data]# lshello[root@server data]# pwd/data/192.168.37.122/data</code></pre><h3 id="7ã€cron-æ¨¡å—"><a href="#7ã€cron-æ¨¡å—" class="headerlink" title="7ã€cron æ¨¡å—"></a>7ã€cron æ¨¡å—</h3><p>ã€€ã€€è¯¥æ¨¡å—é€‚ç”¨äºç®¡ç†<code>cron</code>è®¡åˆ’ä»»åŠ¡çš„ã€‚<br> ã€€ã€€å…¶ä½¿ç”¨çš„è¯­æ³•è·Ÿæˆ‘ä»¬çš„<code>crontab</code>æ–‡ä»¶ä¸­çš„è¯­æ³•ä¸€è‡´ï¼ŒåŒæ—¶ï¼Œå¯ä»¥æŒ‡å®šä»¥ä¸‹é€‰é¡¹ï¼š</p><blockquote><p><code>day=</code>           #æ—¥åº”è¯¥è¿è¡Œçš„å·¥ä½œ( 1-31, <em>,</em> /2, )<br><code>hour=</code>         # å°æ—¶ ( 0-23, <em>,</em> /2, )<br><code>minute=</code>     #åˆ†é’Ÿ( 0-59, <em>,</em> /2, )<br><code>month=</code>       # æœˆ( 1-12, *, /2, )<br><code>weekday=</code>       # å‘¨ ( 0-6 for Sunday-Saturday,, )<br><code>job=</code>           #æŒ‡æ˜è¿è¡Œçš„å‘½ä»¤æ˜¯ä»€ä¹ˆ<br><code>name=</code>        #å®šæ—¶ä»»åŠ¡æè¿°<br><code>reboot</code>      # ä»»åŠ¡åœ¨é‡å¯æ—¶è¿è¡Œï¼Œä¸å»ºè®®ä½¿ç”¨ï¼Œå»ºè®®ä½¿ç”¨special_time<br><code>special_time</code> #ç‰¹æ®Šçš„æ—¶é—´èŒƒå›´ï¼Œå‚æ•°ï¼šrebootï¼ˆé‡å¯æ—¶ï¼‰ï¼Œannuallyï¼ˆæ¯å¹´ï¼‰ï¼Œmonthlyï¼ˆæ¯æœˆï¼‰ï¼Œweeklyï¼ˆæ¯å‘¨ï¼‰ï¼Œdailyï¼ˆæ¯å¤©ï¼‰ï¼Œhourlyï¼ˆæ¯å°æ—¶ï¼‰<br><code>state</code>        #æŒ‡å®šçŠ¶æ€ï¼Œpresentè¡¨ç¤ºæ·»åŠ å®šæ—¶ä»»åŠ¡ï¼Œä¹Ÿæ˜¯é»˜è®¤è®¾ç½®ï¼Œabsentè¡¨ç¤ºåˆ é™¤å®šæ—¶ä»»åŠ¡<br><code>user</code>          # ä»¥å“ªä¸ªç”¨æˆ·çš„èº«ä»½æ‰§è¡Œ</p></blockquote><p>ã€€ã€€ä¸¾ä¾‹å¦‚ä¸‹ï¼š<br><strong>â‘  æ·»åŠ è®¡åˆ’ä»»åŠ¡</strong></p><pre><code>[root@server ~]# ansible web -m cron -a &#39;name=&quot;ntp update every 5 min&quot; minute=*/5 job=&quot;/sbin/ntpdate 172.17.0.1 &amp;&gt; /dev/null&quot;&#39;192.168.37.122 | SUCCESS =&gt; {    &quot;changed&quot;: true,     &quot;envs&quot;: [],     &quot;jobs&quot;: [        &quot;ntp update every 5 min&quot;    ]}192.168.37.133 | SUCCESS =&gt; {    &quot;changed&quot;: true,     &quot;envs&quot;: [],     &quot;jobs&quot;: [        &quot;ntp update every 5 min&quot;    ]}</code></pre><p>ã€€ã€€æˆ‘ä»¬å¯ä»¥å»æŸ¥çœ‹ä¸€ä¸‹ï¼š</p><pre><code>[root@server ~]# ansible web -m shell -a &#39;crontab -l&#39;192.168.37.122 | SUCCESS | rc=0 &gt;&gt;#Ansible: ntp update every 5 min*/5 * * * * /sbin/ntpdate 172.17.0.1 &amp;&gt; /dev/null192.168.37.133 | SUCCESS | rc=0 &gt;&gt;#Ansible: ntp update every 5 min*/5 * * * * /sbin/ntpdate 172.17.0.1 &amp;&gt; /dev/null</code></pre><p>ã€€ã€€å¯ä»¥çœ‹å‡ºï¼Œæˆ‘ä»¬çš„è®¡åˆ’ä»»åŠ¡å·²ç»è®¾ç½®æˆåŠŸäº†ã€‚<br><strong>â‘¡ åˆ é™¤è®¡åˆ’ä»»åŠ¡</strong><br> ã€€ã€€å¦‚æœæˆ‘ä»¬çš„è®¡åˆ’ä»»åŠ¡æ·»åŠ é”™è¯¯ï¼Œæƒ³è¦åˆ é™¤çš„è¯ï¼Œåˆ™æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š<br> ã€€ã€€é¦–å…ˆæˆ‘ä»¬æŸ¥çœ‹ä¸€ä¸‹ç°æœ‰çš„è®¡åˆ’ä»»åŠ¡ï¼š</p><pre><code>[root@server ~]# ansible web -m shell -a &#39;crontab -l&#39;192.168.37.122 | SUCCESS | rc=0 &gt;&gt;#Ansible: ntp update every 5 min*/5 * * * * /sbin/ntpdate 172.17.0.1 &amp;&gt; /dev/null#Ansible: df everyday* 15 * * * df -lh &gt;&gt; /tmp/disk_total &amp;&gt; /dev/null192.168.37.133 | SUCCESS | rc=0 &gt;&gt;#Ansible: ntp update every 5 min*/5 * * * * /sbin/ntpdate 172.17.0.1 &amp;&gt; /dev/null#Ansible: df everyday* 15 * * * df -lh &gt;&gt; /tmp/disk_total &amp;&gt; /dev/null</code></pre><p>ã€€ã€€ç„¶åæ‰§è¡Œåˆ é™¤æ“ä½œï¼š</p><pre><code>[root@server ~]# ansible web -m cron -a &#39;name=&quot;df everyday&quot; hour=15 job=&quot;df -lh &gt;&gt; /tmp/disk_total &amp;&gt; /dev/null&quot; state=absent&#39;192.168.37.122 | SUCCESS =&gt; {    &quot;changed&quot;: true,     &quot;envs&quot;: [],     &quot;jobs&quot;: [        &quot;ntp update every 5 min&quot;    ]}192.168.37.133 | SUCCESS =&gt; {    &quot;changed&quot;: true,     &quot;envs&quot;: [],     &quot;jobs&quot;: [        &quot;ntp update every 5 min&quot;    ]}</code></pre><p>ã€€ã€€åˆ é™¤å®Œæˆåï¼Œæˆ‘ä»¬å†æŸ¥çœ‹ä¸€ä¸‹ç°æœ‰çš„è®¡åˆ’ä»»åŠ¡ç¡®è®¤ä¸€ä¸‹ï¼š</p><pre><code>[root@server ~]# ansible web -m shell -a &#39;crontab -l&#39;192.168.37.122 | SUCCESS | rc=0 &gt;&gt;#Ansible: ntp update every 5 min*/5 * * * * /sbin/ntpdate 172.17.0.1 &amp;&gt; /dev/null192.168.37.133 | SUCCESS | rc=0 &gt;&gt;#Ansible: ntp update every 5 min*/5 * * * * /sbin/ntpdate 172.17.0.1 &amp;&gt; /dev/null</code></pre><p>ã€€ã€€æˆ‘ä»¬çš„åˆ é™¤æ“ä½œå·²ç»æˆåŠŸã€‚</p><h3 id="8ã€yum-æ¨¡å—"><a href="#8ã€yum-æ¨¡å—" class="headerlink" title="8ã€yum æ¨¡å—"></a>8ã€yum æ¨¡å—</h3><p>ã€€ã€€é¡¾åæ€ä¹‰ï¼Œè¯¥æ¨¡å—ä¸»è¦ç”¨äºè½¯ä»¶çš„å®‰è£…ã€‚<br> ã€€ã€€å…¶é€‰é¡¹å¦‚ä¸‹ï¼š</p><blockquote><p><code>name=</code>ã€€ã€€  #æ‰€å®‰è£…çš„åŒ…çš„åç§°<br><code>state=</code>ã€€ã€€#<code>present</code>â€”&gt;å®‰è£…ï¼Œ <code>latest</code>â€”&gt;å®‰è£…æœ€æ–°çš„, <code>absent</code>â€”&gt; å¸è½½è½¯ä»¶ã€‚<br><code>update_cache</code>ã€€ã€€#å¼ºåˆ¶æ›´æ–°yumçš„ç¼“å­˜<br><code>conf_file</code>ã€€ã€€#æŒ‡å®šè¿œç¨‹yumå®‰è£…æ—¶æ‰€ä¾èµ–çš„é…ç½®æ–‡ä»¶ï¼ˆå®‰è£…æœ¬åœ°å·²æœ‰çš„åŒ…ï¼‰ã€‚<br><code>disable_pgp_check</code>ã€€ã€€#æ˜¯å¦ç¦æ­¢GPG checkingï¼Œåªç”¨äº<code>present</code>or <code>latest</code>ã€‚<br><code>disablerepo</code>ã€€ã€€#ä¸´æ—¶ç¦æ­¢ä½¿ç”¨yumåº“ã€‚ åªç”¨äºå®‰è£…æˆ–æ›´æ–°æ—¶ã€‚<br><code>enablerepo</code>ã€€ã€€ #ä¸´æ—¶ä½¿ç”¨çš„yumåº“ã€‚åªç”¨äºå®‰è£…æˆ–æ›´æ–°æ—¶ã€‚</p></blockquote><p>ã€€ã€€ä¸‹é¢æˆ‘ä»¬å°±æ¥å®‰è£…ä¸€ä¸ªåŒ…è¯•è¯•çœ‹ï¼š</p><pre><code>[root@server ~]# ansible web -m yum -a &#39;name=htop state=present&#39;192.168.37.122 | SUCCESS =&gt; {    &quot;changed&quot;: true,     &quot;msg&quot;: &quot;&quot;,     &quot;rc&quot;: 0,     &quot;results&quot;: [        &quot;Loaded plugins: fastestmirror, langpacks\nLoading mirror speeds from cached hostfile\nResolving Dependencies\n--&gt; Running transaction check\n---&gt; Package htop.x86_64 0:2.0.2-1.el7 will be installed\n--&gt; Finished Dependency Resolution\n\nDependencies Resolved\n\n================================================================================\n Package         Arch              Version                Repository       Size\n================================================================================\nInstalling:\n htop            x86_64            2.0.2-1.el7            epel             98 k\n\nTransaction Summary\n================================================================================\nInstall  1 Package\n\nTotal download size: 98 k\nInstalled size: 207 k\nDownloading packages:\nRunning transaction check\nRunning transaction test\nTransaction test succeeded\nRunning transaction\n  Installing : htop-2.0.2-1.el7.x86_64                                      1/1 \n  Verifying  : htop-2.0.2-1.el7.x86_64                                      1/1 \n\nInstalled:\n  htop.x86_64 0:2.0.2-1.el7                                                     \n\nComplete!\n&quot;    ]}192.168.37.133 | SUCCESS =&gt; {    &quot;changed&quot;: true,     &quot;msg&quot;: &quot;Warning: RPMDB altered outside of yum.\n** Found 3 pre-existing rpmdb problem(s), &#39;yum check&#39; output follows:\nipa-client-4.4.0-12.el7.centos.x86_64 has installed conflicts freeipa-client: ipa-client-4.4.0-12.el7.centos.x86_64\nipa-client-common-4.4.0-12.el7.centos.noarch has installed conflicts freeipa-client-common: ipa-client-common-4.4.0-12.el7.centos.noarch\nipa-common-4.4.0-12.el7.centos.noarch has installed conflicts freeipa-common: ipa-common-4.4.0-12.el7.centos.noarch\n&quot;,     &quot;rc&quot;: 0,     &quot;results&quot;: [        &quot;Loaded plugins: fastestmirror, langpacks\nLoading mirror speeds from cached hostfile\nResolving Dependencies\n--&gt; Running transaction check\n---&gt; Package htop.x86_64 0:2.0.2-1.el7 will be installed\n--&gt; Finished Dependency Resolution\n\nDependencies Resolved\n\n================================================================================\n Package         Arch              Version                Repository       Size\n================================================================================\nInstalling:\n htop            x86_64            2.0.2-1.el7            epel             98 k\n\nTransaction Summary\n================================================================================\nInstall  1 Package\n\nTotal download size: 98 k\nInstalled size: 207 k\nDownloading packages:\nRunning transaction check\nRunning transaction test\nTransaction test succeeded\nRunning transaction\n  Installing : htop-2.0.2-1.el7.x86_64                                      1/1 \n  Verifying  : htop-2.0.2-1.el7.x86_64                                      1/1 \n\nInstalled:\n  htop.x86_64 0:2.0.2-1.el7                                                     \n\nComplete!\n&quot;    ]}</code></pre><p>ã€€ã€€å®‰è£…æˆåŠŸã€‚</p><h3 id="9ã€service-æ¨¡å—"><a href="#9ã€service-æ¨¡å—" class="headerlink" title="9ã€service æ¨¡å—"></a>9ã€service æ¨¡å—</h3><p>ã€€ã€€è¯¥æ¨¡å—ç”¨äºæœåŠ¡ç¨‹åºçš„ç®¡ç†ã€‚<br> ã€€ã€€å…¶ä¸»è¦é€‰é¡¹å¦‚ä¸‹ï¼š</p><blockquote><p><code>arguments</code> #å‘½ä»¤è¡Œæä¾›é¢å¤–çš„å‚æ•°<br><code>enabled</code>     #è®¾ç½®å¼€æœºå¯åŠ¨ã€‚<br><code>name=</code> #æœåŠ¡åç§°<br><code>runlevel</code> #å¼€æœºå¯åŠ¨çš„çº§åˆ«ï¼Œä¸€èˆ¬ä¸ç”¨æŒ‡å®šã€‚<br><code>sleep</code> #åœ¨é‡å¯æœåŠ¡çš„è¿‡ç¨‹ä¸­ï¼Œæ˜¯å¦ç­‰å¾…ã€‚å¦‚åœ¨æœåŠ¡å…³é—­ä»¥åç­‰å¾…2ç§’å†å¯åŠ¨ã€‚(å®šä¹‰åœ¨å‰§æœ¬ä¸­ã€‚)<br><code>state</code> #æœ‰å››ç§çŠ¶æ€ï¼Œåˆ†åˆ«ä¸ºï¼š<code>started</code>â€”&gt;å¯åŠ¨æœåŠ¡ï¼Œ <code>stopped</code>â€”&gt;åœæ­¢æœåŠ¡ï¼Œ <code>restarted</code>â€”&gt;é‡å¯æœåŠ¡ï¼Œ <code>reloaded</code>â€”&gt;é‡è½½é…ç½®</p></blockquote><p>ã€€ã€€ä¸‹é¢æ˜¯ä¸€äº›ä¾‹å­ï¼š<br><strong>â‘  å¼€å¯æœåŠ¡å¹¶è®¾ç½®è‡ªå¯åŠ¨</strong></p><pre><code>[root@server ~]# ansible web -m service -a &#39;name=nginx state=started enabled=true&#39; 192.168.37.122 | SUCCESS =&gt; {    &quot;changed&quot;: true,     &quot;enabled&quot;: true,     &quot;name&quot;: &quot;nginx&quot;,     &quot;state&quot;: &quot;started&quot;,     â€¦â€¦}192.168.37.133 | SUCCESS =&gt; {    &quot;changed&quot;: true,     &quot;enabled&quot;: true,     &quot;name&quot;: &quot;nginx&quot;,     &quot;state&quot;: &quot;started&quot;,     â€¦â€¦}</code></pre><p>ã€€ã€€æˆ‘ä»¬å¯ä»¥å»æŸ¥çœ‹ä¸€ä¸‹ç«¯å£æ˜¯å¦æ‰“å¼€ï¼š</p><pre><code>[root@server ~]# ansible web -m shell -a &#39;ss -ntl&#39;192.168.37.122 | SUCCESS | rc=0 &gt;&gt;State      Recv-Q Send-Q Local Address:Port               Peer Address:Port              LISTEN     0      128          *:80                       *:*                                  192.168.37.133 | SUCCESS | rc=0 &gt;&gt;State      Recv-Q Send-Q Local Address:Port               Peer Address:Port                    LISTEN     0      128          *:80                       *:*                  </code></pre><p>ã€€ã€€å¯ä»¥çœ‹å‡ºæˆ‘ä»¬çš„80ç«¯å£å·²ç»æ‰“å¼€ã€‚<br><strong>â‘¡ å…³é—­æœåŠ¡</strong><br> ã€€ã€€æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡è¯¥æ¨¡å—æ¥å…³é—­æˆ‘ä»¬çš„æœåŠ¡ï¼š</p><pre><code>[root@server ~]# ansible web -m service -a &#39;name=nginx state=stopped&#39;192.168.37.122 | SUCCESS =&gt; {    &quot;changed&quot;: true,     &quot;name&quot;: &quot;nginx&quot;,     &quot;state&quot;: &quot;stopped&quot;,     â€¦â€¦}192.168.37.133 | SUCCESS =&gt; {    &quot;changed&quot;: true,     &quot;name&quot;: &quot;nginx&quot;,     &quot;state&quot;: &quot;stopped&quot;,     â€¦â€¦}</code></pre><p>ã€€ã€€ä¸€æ ·çš„ï¼Œæˆ‘ä»¬æ¥æŸ¥çœ‹ä¸€ä¸‹ç«¯å£ï¼š</p><pre><code>[root@server ~]# ansible web -m shell -a &#39;ss -ntl | grep 80&#39;192.168.37.122 | FAILED | rc=1 &gt;&gt;192.168.37.133 | FAILED | rc=1 &gt;&gt;</code></pre><p>ã€€ã€€å¯ä»¥çœ‹å‡ºï¼Œæˆ‘ä»¬å·²ç»æ²¡æœ‰80ç«¯å£äº†ï¼Œè¯´æ˜æˆ‘ä»¬çš„nginxæœåŠ¡å·²ç»å…³é—­äº†ã€‚</p><h3 id="10ã€user-æ¨¡å—"><a href="#10ã€user-æ¨¡å—" class="headerlink" title="10ã€user æ¨¡å—"></a>10ã€user æ¨¡å—</h3><p>ã€€ã€€è¯¥æ¨¡å—ä¸»è¦æ˜¯ç”¨æ¥ç®¡ç†ç”¨æˆ·è´¦å·ã€‚<br> ã€€ã€€å…¶ä¸»è¦é€‰é¡¹å¦‚ä¸‹ï¼š</p><blockquote><p><code>comment</code>ã€€ã€€# ç”¨æˆ·çš„æè¿°ä¿¡æ¯<br><code>createhome</code>ã€€ã€€# æ˜¯å¦åˆ›å»ºå®¶ç›®å½•<br><code>force</code>ã€€ã€€# åœ¨ä½¿ç”¨state=absentæ—¶, è¡Œä¸ºä¸userdel â€“forceä¸€è‡´.<br><code>group</code>ã€€ã€€# æŒ‡å®šåŸºæœ¬ç»„<br><code>groups</code>ã€€ã€€# æŒ‡å®šé™„åŠ ç»„ï¼Œå¦‚æœæŒ‡å®šä¸º(groups=)è¡¨ç¤ºåˆ é™¤æ‰€æœ‰ç»„<br><code>home</code>ã€€ã€€    # æŒ‡å®šç”¨æˆ·å®¶ç›®å½•<br><code>move_home</code>ã€€ã€€# å¦‚æœè®¾ç½®ä¸ºhome=æ—¶, è¯•å›¾å°†ç”¨æˆ·ä¸»ç›®å½•ç§»åŠ¨åˆ°æŒ‡å®šçš„ç›®å½•<br><code>name</code>ã€€ã€€# æŒ‡å®šç”¨æˆ·å<br><code>non_unique</code>ã€€ã€€# è¯¥é€‰é¡¹å…è®¸æ”¹å˜éå”¯ä¸€çš„ç”¨æˆ·IDå€¼<br><code>password</code>ã€€ã€€# æŒ‡å®šç”¨æˆ·å¯†ç <br><code>remove</code>ã€€ã€€# åœ¨ä½¿ç”¨state=absentæ—¶, è¡Œä¸ºæ˜¯ä¸userdel â€“removeä¸€è‡´<br><code>shell</code>ã€€ã€€# æŒ‡å®šé»˜è®¤shell<br><code>state</code>ã€€ã€€# è®¾ç½®å¸å·çŠ¶æ€ï¼Œä¸æŒ‡å®šä¸ºåˆ›å»ºï¼ŒæŒ‡å®šå€¼ä¸ºabsentè¡¨ç¤ºåˆ é™¤<br><code>system</code>ã€€ã€€# å½“åˆ›å»ºä¸€ä¸ªç”¨æˆ·ï¼Œè®¾ç½®è¿™ä¸ªç”¨æˆ·æ˜¯ç³»ç»Ÿç”¨æˆ·ã€‚è¿™ä¸ªè®¾ç½®ä¸èƒ½æ›´æ”¹ç°æœ‰ç”¨æˆ·<br><code>uid</code>ã€€ã€€# æŒ‡å®šç”¨æˆ·çš„uid</p></blockquote><p>ã€€ã€€ä¸¾ä¾‹å¦‚ä¸‹ï¼š<br><strong>â‘  æ·»åŠ ä¸€ä¸ªç”¨æˆ·å¹¶æŒ‡å®šå…¶ uid</strong></p><pre><code>[root@server ~]# ansible web -m user -a &#39;name=keer uid=11111&#39;192.168.37.122 | SUCCESS =&gt; {    &quot;changed&quot;: true,     &quot;comment&quot;: &quot;&quot;,     &quot;createhome&quot;: true,     &quot;group&quot;: 11111,     &quot;home&quot;: &quot;/home/keer&quot;,     &quot;name&quot;: &quot;keer&quot;,     &quot;shell&quot;: &quot;/bin/bash&quot;,     &quot;state&quot;: &quot;present&quot;,     &quot;stderr&quot;: &quot;useradd: warning: the home directory already exists.\nNot copying any file from skel directory into it.\nCreating mailbox file: File exists\n&quot;,     &quot;system&quot;: false,     &quot;uid&quot;: 11111}192.168.37.133 | SUCCESS =&gt; {    &quot;changed&quot;: true,     &quot;comment&quot;: &quot;&quot;,     &quot;createhome&quot;: true,     &quot;group&quot;: 11111,     &quot;home&quot;: &quot;/home/keer&quot;,     &quot;name&quot;: &quot;keer&quot;,     &quot;shell&quot;: &quot;/bin/bash&quot;,     &quot;state&quot;: &quot;present&quot;,     &quot;stderr&quot;: &quot;useradd: warning: the home directory already exists.\nNot copying any file from skel directory into it.\nCreating mailbox file: File exists\n&quot;,     &quot;system&quot;: false,     &quot;uid&quot;: 11111}</code></pre><p>ã€€ã€€æ·»åŠ å®Œæˆï¼Œæˆ‘ä»¬å¯ä»¥å»æŸ¥çœ‹ä¸€ä¸‹ï¼š</p><pre><code>[root@server ~]# ansible web -m shell -a &#39;cat /etc/passwd |grep keer&#39;192.168.37.122 | SUCCESS | rc=0 &gt;&gt;keer:x:11111:11111::/home/keer:/bin/bash192.168.37.133 | SUCCESS | rc=0 &gt;&gt;keer:x:11111:11111::/home/keer:/bin/bash</code></pre><p><strong>â‘¡ åˆ é™¤ç”¨æˆ·</strong></p><pre><code>[root@server ~]# ansible web -m user -a &#39;name=keer state=absent&#39;192.168.37.122 | SUCCESS =&gt; {    &quot;changed&quot;: true,     &quot;force&quot;: false,     &quot;name&quot;: &quot;keer&quot;,     &quot;remove&quot;: false,     &quot;state&quot;: &quot;absent&quot;}192.168.37.133 | SUCCESS =&gt; {    &quot;changed&quot;: true,     &quot;force&quot;: false,     &quot;name&quot;: &quot;keer&quot;,     &quot;remove&quot;: false,     &quot;state&quot;: &quot;absent&quot;}</code></pre><p>ã€€ã€€ä¸€æ ·çš„ï¼Œåˆ é™¤ä¹‹åï¼Œæˆ‘ä»¬å»çœ‹ä¸€ä¸‹ï¼š</p><pre><code>[root@server ~]# ansible web -m shell -a &#39;cat /etc/passwd |grep keer&#39;192.168.37.122 | FAILED | rc=1 &gt;&gt;192.168.37.133 | FAILED | rc=1 &gt;&gt;</code></pre><p>ã€€ã€€å‘ç°å·²ç»æ²¡æœ‰è¿™ä¸ªç”¨æˆ·äº†ã€‚</p><h3 id="11ã€group-æ¨¡å—"><a href="#11ã€group-æ¨¡å—" class="headerlink" title="11ã€group æ¨¡å—"></a>11ã€group æ¨¡å—</h3><p>ã€€ã€€è¯¥æ¨¡å—ä¸»è¦ç”¨äºæ·»åŠ æˆ–åˆ é™¤ç»„ã€‚<br> ã€€ã€€å¸¸ç”¨çš„é€‰é¡¹å¦‚ä¸‹ï¼š</p><blockquote><p><code>gid=</code>ã€€ã€€#è®¾ç½®ç»„çš„GIDå·<br><code>name=</code>ã€€ã€€#æŒ‡å®šç»„çš„åç§°<br><code>state=</code>ã€€ã€€#æŒ‡å®šç»„çš„çŠ¶æ€ï¼Œé»˜è®¤ä¸ºåˆ›å»ºï¼Œè®¾ç½®å€¼ä¸º<code>absent</code>ä¸ºåˆ é™¤<br><code>system=</code>ã€€ã€€#è®¾ç½®å€¼ä¸º<code>yes</code>ï¼Œè¡¨ç¤ºåˆ›å»ºä¸ºç³»ç»Ÿç»„</p></blockquote><p>ã€€ã€€ä¸¾ä¾‹å¦‚ä¸‹ï¼š<br><strong>â‘  åˆ›å»ºç»„</strong></p><pre><code>[root@server ~]# ansible web -m group -a &#39;name=sanguo gid=12222&#39;192.168.37.122 | SUCCESS =&gt; {    &quot;changed&quot;: true,     &quot;gid&quot;: 12222,     &quot;name&quot;: &quot;sanguo&quot;,     &quot;state&quot;: &quot;present&quot;,     &quot;system&quot;: false}192.168.37.133 | SUCCESS =&gt; {    &quot;changed&quot;: true,     &quot;gid&quot;: 12222,     &quot;name&quot;: &quot;sanguo&quot;,     &quot;state&quot;: &quot;present&quot;,     &quot;system&quot;: false}</code></pre><p>ã€€ã€€åˆ›å»ºè¿‡åï¼Œæˆ‘ä»¬æ¥æŸ¥çœ‹ä¸€ä¸‹ï¼š</p><pre><code>[root@server ~]# ansible web -m shell -a &#39;cat /etc/group | grep 12222&#39; 192.168.37.122 | SUCCESS | rc=0 &gt;&gt;sanguo:x:12222:192.168.37.133 | SUCCESS | rc=0 &gt;&gt;sanguo:x:12222:</code></pre><p>ã€€ã€€å¯ä»¥çœ‹å‡ºï¼Œæˆ‘ä»¬çš„ç»„å·²ç»åˆ›å»ºæˆåŠŸäº†ã€‚<br><strong>â‘¡ åˆ é™¤ç»„</strong></p><pre><code>[root@server ~]# ansible web -m group -a &#39;name=sanguo state=absent&#39;192.168.37.122 | SUCCESS =&gt; {    &quot;changed&quot;: true,     &quot;name&quot;: &quot;sanguo&quot;,     &quot;state&quot;: &quot;absent&quot;}192.168.37.133 | SUCCESS =&gt; {    &quot;changed&quot;: true,     &quot;name&quot;: &quot;sanguo&quot;,     &quot;state&quot;: &quot;absent&quot;}</code></pre><p>ã€€ã€€ç…§ä¾‹æŸ¥çœ‹ä¸€ä¸‹ï¼š</p><pre><code>[root@server ~]# ansible web -m shell -a &#39;cat /etc/group | grep 12222&#39; 192.168.37.122 | FAILED | rc=1 &gt;&gt;192.168.37.133 | FAILED | rc=1 &gt;&gt;</code></pre><p>ã€€ã€€å·²ç»æ²¡æœ‰è¿™ä¸ªç»„çš„ç›¸å…³ä¿¡æ¯äº†ã€‚</p><h3 id="12ã€script-æ¨¡å—"><a href="#12ã€script-æ¨¡å—" class="headerlink" title="12ã€script æ¨¡å—"></a>12ã€script æ¨¡å—</h3><p>ã€€ã€€è¯¥æ¨¡å—ç”¨äºå°†æœ¬æœºçš„è„šæœ¬åœ¨è¢«ç®¡ç†ç«¯çš„æœºå™¨ä¸Šè¿è¡Œã€‚<br> ã€€ã€€è¯¥æ¨¡å—ç›´æ¥æŒ‡å®šè„šæœ¬çš„è·¯å¾„å³å¯ï¼Œæˆ‘ä»¬é€šè¿‡ä¾‹å­æ¥çœ‹ä¸€çœ‹åˆ°åº•å¦‚ä½•ä½¿ç”¨çš„ï¼š<br> ã€€ã€€é¦–å…ˆï¼Œæˆ‘ä»¬å†™ä¸€ä¸ªè„šæœ¬ï¼Œå¹¶ç»™å…¶åŠ ä¸Šæ‰§è¡Œæƒé™ï¼š</p><pre><code>[root@server ~]# vim /tmp/df.sh    #!/bin/bash    date &gt;&gt; /tmp/disk_total.log    df -lh &gt;&gt; /tmp/disk_total.log [root@server ~]# chmod +x /tmp/df.sh </code></pre><p>ã€€ã€€ç„¶åï¼Œæˆ‘ä»¬ç›´æ¥è¿è¡Œå‘½ä»¤æ¥å®ç°åœ¨è¢«ç®¡ç†ç«¯æ‰§è¡Œè¯¥è„šæœ¬ï¼š</p><pre><code>[root@server ~]# ansible web -m script -a &#39;/tmp/df.sh&#39;192.168.37.122 | SUCCESS =&gt; {    &quot;changed&quot;: true,     &quot;rc&quot;: 0,     &quot;stderr&quot;: &quot;Shared connection to 192.168.37.122 closed.\r\n&quot;,     &quot;stdout&quot;: &quot;&quot;,     &quot;stdout_lines&quot;: []}192.168.37.133 | SUCCESS =&gt; {    &quot;changed&quot;: true,     &quot;rc&quot;: 0,     &quot;stderr&quot;: &quot;Shared connection to 192.168.37.133 closed.\r\n&quot;,     &quot;stdout&quot;: &quot;&quot;,     &quot;stdout_lines&quot;: []}</code></pre><p>ã€€ã€€ç…§ä¾‹æŸ¥çœ‹ä¸€ä¸‹æ–‡ä»¶å†…å®¹ï¼š</p><pre class=" language-repl"><code class="language-repl">[root@server ~]# ansible web -m shell -a 'cat /tmp/disk_total.log'192.168.37.122 | SUCCESS | rc=0 >>Tue Dec  5 15:58:21 CST 2017Filesystem      Size  Used Avail Use% Mounted on/dev/sda2        47G  4.4G   43G  10% /devtmpfs        978M     0  978M   0% /devtmpfs           993M   84K  993M   1% /dev/shmtmpfs           993M  9.1M  984M   1% /runtmpfs           993M     0  993M   0% /sys/fs/cgroup/dev/sda3        47G   33M   47G   1% /app/dev/sda1       950M  153M  798M  17% /boottmpfs           199M   16K  199M   1% /run/user/42tmpfs           199M     0  199M   0% /run/user/0192.168.37.133 | SUCCESS | rc=0 >>Tue Dec  5 15:58:21 CST 2017Filesystem      Size  Used Avail Use% Mounted on/dev/sda2        46G  4.1G   40G  10% /devtmpfs        898M     0  898M   0% /devtmpfs           912M   84K  912M   1% /dev/shmtmpfs           912M  9.0M  903M   1% /runtmpfs           912M     0  912M   0% /sys/fs/cgroup/dev/sda3       3.7G   15M  3.4G   1% /app/dev/sda1       1.9G  141M  1.6G   9% /boottmpfs           183M   16K  183M   1% /run/user/42tmpfs           183M     0  183M   0% /run/user/0</code></pre><p>ã€€ã€€å¯ä»¥çœ‹å‡ºå·²ç»æ‰§è¡ŒæˆåŠŸäº†ã€‚</p><h3 id="13ã€setup-æ¨¡å—"><a href="#13ã€setup-æ¨¡å—" class="headerlink" title="13ã€setup æ¨¡å—"></a>13ã€setup æ¨¡å—</h3><p>ã€€ã€€è¯¥æ¨¡å—ä¸»è¦ç”¨äºæ”¶é›†ä¿¡æ¯ï¼Œæ˜¯é€šè¿‡è°ƒç”¨factsç»„ä»¶æ¥å®ç°çš„ã€‚<br> ã€€ã€€factsç»„ä»¶æ˜¯Ansibleç”¨äºé‡‡é›†è¢«ç®¡æœºå™¨è®¾å¤‡ä¿¡æ¯çš„ä¸€ä¸ªåŠŸèƒ½ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨setupæ¨¡å—æŸ¥æœºå™¨çš„æ‰€æœ‰factsä¿¡æ¯ï¼Œå¯ä»¥ä½¿ç”¨filteræ¥æŸ¥çœ‹æŒ‡å®šä¿¡æ¯ã€‚æ•´ä¸ªfactsä¿¡æ¯è¢«åŒ…è£…åœ¨ä¸€ä¸ªJSONæ ¼å¼çš„æ•°æ®ç»“æ„ä¸­ï¼Œansible_factsæ˜¯æœ€ä¸Šå±‚çš„å€¼ã€‚<br> ã€€ã€€factså°±æ˜¯å˜é‡ï¼Œå†…å»ºå˜é‡ ã€‚æ¯ä¸ªä¸»æœºçš„å„ç§ä¿¡æ¯ï¼Œcpué¢—æ•°ã€å†…å­˜å¤§å°ç­‰ã€‚ä¼šå­˜åœ¨factsä¸­çš„æŸä¸ªå˜é‡ä¸­ã€‚è°ƒç”¨åè¿”å›å¾ˆå¤šå¯¹åº”ä¸»æœºçš„ä¿¡æ¯ï¼Œåœ¨åé¢çš„æ“ä½œä¸­å¯ä»¥æ ¹æ®ä¸åŒçš„ä¿¡æ¯æ¥åšä¸åŒçš„æ“ä½œã€‚å¦‚redhatç³»åˆ—ç”¨yumå®‰è£…ï¼Œè€Œdebianç³»åˆ—ç”¨aptæ¥å®‰è£…è½¯ä»¶ã€‚<br><strong>â‘  æŸ¥çœ‹ä¿¡æ¯</strong><br> ã€€ã€€æˆ‘ä»¬å¯ä»¥ç›´æ¥ç”¨å‘½ä»¤è·å–åˆ°å˜é‡çš„å€¼ï¼Œå…·ä½“æˆ‘ä»¬æ¥çœ‹çœ‹ä¾‹å­ï¼š</p><pre><code>[root@server ~]# ansible web -m setup -a &#39;filter=&quot;*mem*&quot;&#39;   #æŸ¥çœ‹å†…å­˜192.168.37.122 | SUCCESS =&gt; {    &quot;ansible_facts&quot;: {        &quot;ansible_memfree_mb&quot;: 1116,         &quot;ansible_memory_mb&quot;: {            &quot;nocache&quot;: {                &quot;free&quot;: 1397,                 &quot;used&quot;: 587            },             &quot;real&quot;: {                &quot;free&quot;: 1116,                 &quot;total&quot;: 1984,                 &quot;used&quot;: 868            },             &quot;swap&quot;: {                &quot;cached&quot;: 0,                 &quot;free&quot;: 3813,                 &quot;total&quot;: 3813,                 &quot;used&quot;: 0            }        },         &quot;ansible_memtotal_mb&quot;: 1984    },     &quot;changed&quot;: false}192.168.37.133 | SUCCESS =&gt; {    &quot;ansible_facts&quot;: {        &quot;ansible_memfree_mb&quot;: 1203,         &quot;ansible_memory_mb&quot;: {            &quot;nocache&quot;: {                &quot;free&quot;: 1470,                 &quot;used&quot;: 353            },             &quot;real&quot;: {                &quot;free&quot;: 1203,                 &quot;total&quot;: 1823,                 &quot;used&quot;: 620            },             &quot;swap&quot;: {                &quot;cached&quot;: 0,                 &quot;free&quot;: 3813,                 &quot;total&quot;: 3813,                 &quot;used&quot;: 0            }        },         &quot;ansible_memtotal_mb&quot;: 1823    },     &quot;changed&quot;: false}</code></pre><p>ã€€ã€€æˆ‘ä»¬å¯ä»¥é€šè¿‡å‘½ä»¤æŸ¥çœ‹ä¸€ä¸‹å†…å­˜çš„å¤§å°ä»¥ç¡®è®¤ä¸€ä¸‹æ˜¯å¦ä¸€è‡´ï¼š</p><pre><code>[root@server ~]# ansible web -m shell -a &#39;free -m&#39;192.168.37.122 | SUCCESS | rc=0 &gt;&gt;              total        used        free      shared  buff/cache   availableMem:           1984         404        1122           9         457        1346Swap:          3813           0        3813192.168.37.133 | SUCCESS | rc=0 &gt;&gt;              total        used        free      shared  buff/cache   availableMem:           1823         292        1207           9         323        1351Swap:          3813           0        3813</code></pre><p>ã€€ã€€å¯ä»¥çœ‹å‡ºä¿¡æ¯æ˜¯ä¸€è‡´çš„ã€‚<br><strong>â‘¡ ä¿å­˜ä¿¡æ¯</strong><br> ã€€ã€€æˆ‘ä»¬çš„setupæ¨¡å—è¿˜æœ‰ä¸€ä¸ªå¾ˆå¥½ç”¨çš„åŠŸèƒ½å°±æ˜¯å¯ä»¥ä¿å­˜æˆ‘ä»¬æ‰€ç­›é€‰çš„ä¿¡æ¯è‡³æˆ‘ä»¬çš„ä¸»æœºä¸Šï¼ŒåŒæ—¶ï¼Œæ–‡ä»¶åä¸ºæˆ‘ä»¬è¢«ç®¡åˆ¶çš„ä¸»æœºçš„IPï¼Œè¿™æ ·æ–¹ä¾¿æˆ‘ä»¬çŸ¥é“æ˜¯å“ªå°æœºå™¨å‡ºçš„é—®é¢˜ã€‚<br> ã€€ã€€æˆ‘ä»¬å¯ä»¥çœ‹ä¸€çœ‹ä¾‹å­ï¼š</p><pre><code>[root@server tmp]# ansible web -m setup -a &#39;filter=&quot;*mem*&quot;&#39; --tree /tmp/facts192.168.37.122 | SUCCESS =&gt; {    &quot;ansible_facts&quot;: {        &quot;ansible_memfree_mb&quot;: 1115,         &quot;ansible_memory_mb&quot;: {            &quot;nocache&quot;: {                &quot;free&quot;: 1396,                 &quot;used&quot;: 588            },             &quot;real&quot;: {                &quot;free&quot;: 1115,                 &quot;total&quot;: 1984,                 &quot;used&quot;: 869            },             &quot;swap&quot;: {                &quot;cached&quot;: 0,                 &quot;free&quot;: 3813,                 &quot;total&quot;: 3813,                 &quot;used&quot;: 0            }        },         &quot;ansible_memtotal_mb&quot;: 1984    },     &quot;changed&quot;: false}192.168.37.133 | SUCCESS =&gt; {    &quot;ansible_facts&quot;: {        &quot;ansible_memfree_mb&quot;: 1199,         &quot;ansible_memory_mb&quot;: {            &quot;nocache&quot;: {                &quot;free&quot;: 1467,                 &quot;used&quot;: 356            },             &quot;real&quot;: {                &quot;free&quot;: 1199,                 &quot;total&quot;: 1823,                 &quot;used&quot;: 624            },             &quot;swap&quot;: {                &quot;cached&quot;: 0,                 &quot;free&quot;: 3813,                 &quot;total&quot;: 3813,                 &quot;used&quot;: 0            }        },         &quot;ansible_memtotal_mb&quot;: 1823    },     &quot;changed&quot;: false}</code></pre><p>ã€€ã€€ç„¶åæˆ‘ä»¬å¯ä»¥å»æŸ¥çœ‹ä¸€ä¸‹ï¼š</p><pre><code>[root@server ~]# cd /tmp/facts/[root@server facts]# ls192.168.37.122  192.168.37.133[root@server facts]# cat 192.168.37.122 {&quot;ansible_facts&quot;: {&quot;ansible_memfree_mb&quot;: 1115, &quot;ansible_memory_mb&quot;: {&quot;nocache&quot;: {&quot;free&quot;: 1396, &quot;used&quot;: 588}, &quot;real&quot;: {&quot;free&quot;: 1115, &quot;total&quot;: 1984, &quot;used&quot;: 869}, &quot;swap&quot;: {&quot;cached&quot;: 0, &quot;free&quot;: 3813, &quot;total&quot;: 3813, &quot;used&quot;: 0}}, &quot;ansible_memtotal_mb&quot;: 1984}, &quot;changed&quot;: false}</code></pre><h2 id="å…­ã€Ansible-playbook-ç®€ä»‹"><a href="#å…­ã€Ansible-playbook-ç®€ä»‹" class="headerlink" title="å…­ã€Ansible playbook ç®€ä»‹"></a>å…­ã€Ansible playbook ç®€ä»‹</h2><p>ã€€ã€€<strong>playbook æ˜¯ ansible ç”¨äºé…ç½®ï¼Œéƒ¨ç½²ï¼Œå’Œç®¡ç†è¢«æ§èŠ‚ç‚¹çš„å‰§æœ¬ã€‚</strong><br>ã€€ã€€é€šè¿‡ playbook çš„è¯¦ç»†æè¿°ï¼Œæ‰§è¡Œå…¶ä¸­çš„ä¸€ç³»åˆ— tasks ï¼Œå¯ä»¥è®©è¿œç«¯ä¸»æœºè¾¾åˆ°é¢„æœŸçš„çŠ¶æ€ã€‚playbook å°±åƒ Ansible æ§åˆ¶å™¨ç»™è¢«æ§èŠ‚ç‚¹åˆ—å‡ºçš„çš„ä¸€ç³»åˆ— to-do-list ï¼Œè€Œè¢«æ§èŠ‚ç‚¹å¿…é¡»è¦å®Œæˆã€‚<br>ã€€ã€€ä¹Ÿå¯ä»¥è¿™ä¹ˆç†è§£ï¼Œplaybook å­—é¢æ„æ€ï¼Œå³å‰§æœ¬ï¼Œç°å®ä¸­ç”±æ¼”å‘˜æŒ‰ç…§å‰§æœ¬è¡¨æ¼”ï¼Œåœ¨Ansibleä¸­ï¼Œè¿™æ¬¡ç”±è®¡ç®—æœºè¿›è¡Œè¡¨æ¼”ï¼Œç”±è®¡ç®—æœºå®‰è£…ï¼Œéƒ¨ç½²åº”ç”¨ï¼Œæä¾›å¯¹å¤–æœåŠ¡ï¼Œä»¥åŠç»„ç»‡è®¡ç®—æœºå¤„ç†å„ç§å„æ ·çš„äº‹æƒ…ã€‚</p><h2 id="ä¸ƒã€Ansible-playbookä½¿ç”¨åœºæ™¯"><a href="#ä¸ƒã€Ansible-playbookä½¿ç”¨åœºæ™¯" class="headerlink" title="ä¸ƒã€Ansible playbookä½¿ç”¨åœºæ™¯"></a>ä¸ƒã€Ansible playbookä½¿ç”¨åœºæ™¯</h2><p>ã€€ã€€æ‰§è¡Œä¸€äº›ç®€å•çš„ä»»åŠ¡ï¼Œä½¿ç”¨ad-hocå‘½ä»¤å¯ä»¥æ–¹ä¾¿çš„è§£å†³é—®é¢˜ï¼Œä½†æ˜¯æœ‰æ—¶ä¸€ä¸ªè®¾æ–½è¿‡äºå¤æ‚ï¼Œéœ€è¦å¤§é‡çš„æ“ä½œæ—¶å€™ï¼Œæ‰§è¡Œçš„ad-hocå‘½ä»¤æ˜¯ä¸é€‚åˆçš„ï¼Œè¿™æ—¶æœ€å¥½ä½¿ç”¨playbookã€‚<br>ã€€ã€€å°±åƒæ‰§è¡Œshellå‘½ä»¤ä¸å†™shellè„šæœ¬ä¸€æ ·ï¼Œä¹Ÿå¯ä»¥ç†è§£ä¸ºæ‰¹å¤„ç†ä»»åŠ¡ï¼Œä¸è¿‡playbookæœ‰è‡ªå·±çš„è¯­æ³•æ ¼å¼ã€‚<br>ã€€ã€€ä½¿ç”¨playbookä½ å¯ä»¥æ–¹ä¾¿çš„é‡ç”¨è¿™äº›ä»£ç ï¼Œå¯ä»¥ç§»æ¤åˆ°ä¸åŒçš„æœºå™¨ä¸Šé¢ï¼Œåƒå‡½æ•°ä¸€æ ·ï¼Œæœ€å¤§åŒ–çš„åˆ©ç”¨ä»£ç ã€‚åœ¨ä½ ä½¿ç”¨Ansibleçš„è¿‡ç¨‹ä¸­ï¼Œä½ ä¹Ÿä¼šå‘ç°ï¼Œä½ æ‰€å¤„ç†çš„å¤§éƒ¨åˆ†æ“ä½œéƒ½æ˜¯ç¼–å†™playbookã€‚å¯ä»¥æŠŠå¸¸è§çš„åº”ç”¨éƒ½ç¼–å†™æˆplaybookï¼Œä¹‹åç®¡ç†æœåŠ¡å™¨ä¼šå˜å¾—ååˆ†ç®€å•ã€‚</p><h2 id="å…«ã€Ansible-playbookæ ¼å¼"><a href="#å…«ã€Ansible-playbookæ ¼å¼" class="headerlink" title="å…«ã€Ansible playbookæ ¼å¼"></a>å…«ã€Ansible playbookæ ¼å¼</h2><h3 id="1ã€æ ¼å¼ç®€ä»‹"><a href="#1ã€æ ¼å¼ç®€ä»‹" class="headerlink" title="1ã€æ ¼å¼ç®€ä»‹"></a>1ã€æ ¼å¼ç®€ä»‹</h3><p>ã€€ã€€<strong>playbookç”±YMALè¯­è¨€ç¼–å†™ã€‚</strong>YAML( /ËˆjÃ¦mÉ™l/ )å‚è€ƒäº†å…¶ä»–å¤šç§è¯­è¨€ï¼ŒåŒ…æ‹¬ï¼šXMLã€Cè¯­è¨€ã€Pythonã€Perlä»¥åŠç”µå­é‚®ä»¶æ ¼å¼RFC2822ï¼ŒClark Evansåœ¨2001å¹´5æœˆåœ¨é¦–æ¬¡å‘è¡¨äº†è¿™ç§è¯­è¨€ï¼Œå¦å¤–Ingy dÃ¶t Netä¸OrenBen-Kikiä¹Ÿæ˜¯è¿™è¯­è¨€çš„å…±åŒè®¾è®¡è€…ã€‚<br>ã€€ã€€YMALæ ¼å¼æ˜¯ç±»ä¼¼äºJSONçš„æ–‡ä»¶æ ¼å¼ï¼Œä¾¿äºäººç†è§£å’Œé˜…è¯»ï¼ŒåŒæ—¶ä¾¿äºä¹¦å†™ã€‚é¦–å…ˆå­¦ä¹ äº†è§£ä¸€ä¸‹YMALçš„æ ¼å¼ï¼Œå¯¹æˆ‘ä»¬åé¢ä¹¦å†™playbookå¾ˆæœ‰å¸®åŠ©ã€‚ä»¥ä¸‹ä¸ºplaybookå¸¸ç”¨åˆ°çš„YMALæ ¼å¼ï¼š<br>ã€€ã€€1ã€æ–‡ä»¶çš„ç¬¬ä¸€è¡Œåº”è¯¥ä»¥ â€œâ€”â€œ (ä¸‰ä¸ªè¿å­—ç¬¦)å¼€å§‹ï¼Œè¡¨æ˜YMALæ–‡ä»¶çš„å¼€å§‹ã€‚<br>ã€€ã€€2ã€åœ¨åŒä¸€è¡Œä¸­ï¼Œ#ä¹‹åçš„å†…å®¹è¡¨ç¤ºæ³¨é‡Šï¼Œç±»ä¼¼äºshellï¼Œpythonå’Œrubyã€‚<br>ã€€ã€€3ã€YMALä¸­çš„åˆ—è¡¨å…ƒç´ ä»¥â€-â€å¼€å¤´ç„¶åç´§è·Ÿç€ä¸€ä¸ªç©ºæ ¼ï¼Œåé¢ä¸ºå…ƒç´ å†…å®¹ã€‚<br>ã€€ã€€4ã€åŒä¸€ä¸ªåˆ—è¡¨ä¸­çš„å…ƒç´ åº”è¯¥ä¿æŒç›¸åŒçš„ç¼©è¿›ã€‚å¦åˆ™ä¼šè¢«å½“åšé”™è¯¯å¤„ç†ã€‚<br>ã€€ã€€5ã€playä¸­hostsï¼Œvariablesï¼Œrolesï¼Œtasksç­‰å¯¹è±¡çš„è¡¨ç¤ºæ–¹æ³•éƒ½æ˜¯é”®å€¼ä¸­é—´ä»¥â€:â€åˆ†éš”è¡¨ç¤ºï¼Œâ€:â€åé¢è¿˜è¦å¢åŠ ä¸€ä¸ªç©ºæ ¼ã€‚<br>ã€€ã€€ä¸‹é¢æ˜¯ä¸€ä¸ªä¸¾ä¾‹ï¼š</p><pre><code>---#å®‰è£…ä¸è¿è¡ŒmysqlæœåŠ¡- hosts: node1  remote_user: root  tasks:      - name: install mysql-server package      yum: name=mysql-server state=present    - name: starting mysqld service      service: name=mysql state=started</code></pre><p>ã€€ã€€æˆ‘ä»¬çš„æ–‡ä»¶åç§°åº”è¯¥ä»¥<code>.yml</code>ç»“å°¾ï¼Œåƒæˆ‘ä»¬ä¸Šé¢çš„ä¾‹å­å°±æ˜¯<code>mysql.yml</code>ã€‚å…¶ä¸­ï¼Œæœ‰ä¸‰ä¸ªéƒ¨åˆ†ç»„æˆï¼š</p><blockquote><p><code>hostéƒ¨åˆ†</code>ï¼šä½¿ç”¨ hosts æŒ‡ç¤ºä½¿ç”¨å“ªä¸ªä¸»æœºæˆ–ä¸»æœºç»„æ¥è¿è¡Œä¸‹é¢çš„ tasks ï¼Œæ¯ä¸ª playbook éƒ½å¿…é¡»æŒ‡å®š hosts ï¼Œhostsä¹Ÿ<strong>å¯ä»¥ä½¿ç”¨é€šé…ç¬¦æ ¼å¼</strong>ã€‚ä¸»æœºæˆ–ä¸»æœºç»„åœ¨ inventory æ¸…å•ä¸­æŒ‡å®šï¼Œå¯ä»¥ä½¿ç”¨ç³»ç»Ÿé»˜è®¤çš„<code>/etc/ansible/hosts</code>ï¼Œä¹Ÿå¯ä»¥è‡ªå·±ç¼–è¾‘ï¼Œåœ¨è¿è¡Œçš„æ—¶å€™åŠ ä¸Š<code>-i</code>é€‰é¡¹ï¼ŒæŒ‡å®šæ¸…å•çš„ä½ç½®å³å¯ã€‚åœ¨è¿è¡Œæ¸…å•æ–‡ä»¶çš„æ—¶å€™ï¼Œ<code>â€“list-hosts</code>é€‰é¡¹ä¼šæ˜¾ç¤ºé‚£äº›ä¸»æœºå°†ä¼šå‚ä¸æ‰§è¡Œ task çš„è¿‡ç¨‹ä¸­ã€‚<br><code>remote_user</code>ï¼šæŒ‡å®šè¿œç«¯ä¸»æœºä¸­çš„å“ªä¸ªç”¨æˆ·æ¥ç™»å½•è¿œç«¯ç³»ç»Ÿï¼Œåœ¨è¿œç«¯ç³»ç»Ÿæ‰§è¡Œ task çš„ç”¨æˆ·ï¼Œå¯ä»¥ä»»æ„æŒ‡å®šï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ sudoï¼Œä½†æ˜¯ç”¨æˆ·å¿…é¡»è¦æœ‰æ‰§è¡Œç›¸åº” task çš„æƒé™ã€‚<br><code>tasks</code>ï¼šæŒ‡å®šè¿œç«¯ä¸»æœºå°†è¦æ‰§è¡Œçš„ä¸€ç³»åˆ—åŠ¨ä½œã€‚tasks çš„æ ¸å¿ƒä¸º ansible çš„æ¨¡å—ï¼Œå‰é¢å·²ç»æåˆ°æ¨¡å—çš„ç”¨æ³•ã€‚tasks åŒ…å« <code>name</code> å’Œ<code>è¦æ‰§è¡Œçš„æ¨¡å—</code>ï¼Œname æ˜¯å¯é€‰çš„ï¼Œåªæ˜¯ä¸ºäº†ä¾¿äºç”¨æˆ·é˜…è¯»ï¼Œä¸è¿‡è¿˜æ˜¯å»ºè®®åŠ ä¸Šå»ï¼Œæ¨¡å—æ˜¯å¿…é¡»çš„ï¼ŒåŒæ—¶ä¹Ÿè¦ç»™äºˆæ¨¡å—ç›¸åº”çš„å‚æ•°ã€‚</p></blockquote><p>ã€€ã€€ä½¿ç”¨ansible-playbookè¿è¡Œplaybookæ–‡ä»¶ï¼Œå¾—åˆ°å¦‚ä¸‹è¾“å‡ºä¿¡æ¯ï¼Œè¾“å‡ºå†…å®¹ä¸ºJSONæ ¼å¼ã€‚å¹¶ä¸”ç”±ä¸åŒé¢œè‰²ç»„æˆï¼Œä¾¿äºè¯†åˆ«ã€‚ä¸€èˆ¬è€Œè¨€<br>| ç»¿è‰²ä»£è¡¨æ‰§è¡ŒæˆåŠŸï¼Œç³»ç»Ÿä¿æŒåŸæ ·<br>| é»„è‰²ä»£è¡¨ç³»ç»Ÿä»£è¡¨ç³»ç»ŸçŠ¶æ€å‘ç”Ÿæ”¹å˜<br>| çº¢è‰²ä»£è¡¨æ‰§è¡Œå¤±è´¥ï¼Œæ˜¾ç¤ºé”™è¯¯è¾“å‡º<br>ã€€ã€€æ‰§è¡Œæœ‰ä¸‰ä¸ªæ­¥éª¤ï¼š1ã€æ”¶é›†facts  2ã€æ‰§è¡Œtasks  3ã€æŠ¥å‘Šç»“æœ</p><h3 id="2ã€æ ¸å¿ƒå…ƒç´ "><a href="#2ã€æ ¸å¿ƒå…ƒç´ " class="headerlink" title="2ã€æ ¸å¿ƒå…ƒç´ "></a>2ã€æ ¸å¿ƒå…ƒç´ </h3><p>ã€€ã€€Playbookçš„æ ¸å¿ƒå…ƒç´ ï¼š</p><blockquote><p><code>Hosts</code>ï¼šä¸»æœºç»„ï¼›<br><code>Tasks</code>ï¼šä»»åŠ¡åˆ—è¡¨ï¼›<br><code>Variables</code>ï¼šå˜é‡ï¼Œè®¾ç½®æ–¹å¼æœ‰å››ç§ï¼›<br><code>Templates</code>ï¼šåŒ…å«äº†æ¨¡æ¿è¯­æ³•çš„æ–‡æœ¬æ–‡ä»¶ï¼›<br><code>Handlers</code>ï¼šç”±ç‰¹å®šæ¡ä»¶è§¦å‘çš„ä»»åŠ¡ï¼›</p></blockquote><h3 id="3ã€åŸºæœ¬ç»„ä»¶"><a href="#3ã€åŸºæœ¬ç»„ä»¶" class="headerlink" title="3ã€åŸºæœ¬ç»„ä»¶"></a>3ã€åŸºæœ¬ç»„ä»¶</h3><p>ã€€ã€€Playbooksé…ç½®æ–‡ä»¶çš„åŸºç¡€ç»„ä»¶ï¼š</p><blockquote><p><code>Hosts</code>ï¼šè¿è¡ŒæŒ‡å®šä»»åŠ¡çš„ç›®æ ‡ä¸»æœº<br><code>remote_user</code>ï¼šåœ¨è¿œç¨‹ä¸»æœºä¸Šæ‰§è¡Œä»»åŠ¡çš„ç”¨æˆ·ï¼›<br><code>sudo_user</code>ï¼š<br><code>tasks</code>ï¼šä»»åŠ¡åˆ—è¡¨</p><p>ã€€ã€€æ ¼å¼ï¼š<br>ã€€ã€€ã€€ã€€tasksï¼š<br>ã€€ã€€ã€€ã€€ã€€ã€€â€“ name: TASK_NAME<br>ã€€ã€€ã€€ã€€ã€€ã€€ module: arguments<br>ã€€ã€€ã€€ã€€ã€€ã€€ notify: HANDLER_NAME<br>ã€€ã€€ã€€ã€€ã€€ã€€ handlers:<br>ã€€ã€€ã€€ã€€ã€€ã€€â€“ name: HANDLER_NAME<br>ã€€ã€€ã€€ã€€ã€€ã€€ module: arguments</p></blockquote><blockquote><p><code>æ¨¡å—ï¼Œæ¨¡å—å‚æ•°</code>ï¼š</p><p>ã€€ã€€æ ¼å¼ï¼š<br>ã€€ã€€ã€€ã€€(1) action: module arguments<br>ã€€ã€€ã€€ã€€(2) module: arguments<br>ã€€ã€€ã€€ã€€æ³¨æ„ï¼šshellå’Œcommandæ¨¡å—åé¢ç›´æ¥è·Ÿå‘½ä»¤ï¼Œè€Œékey=valueç±»çš„å‚æ•°åˆ—è¡¨ï¼›</p></blockquote><blockquote><p><code>handlers</code>ï¼šä»»åŠ¡ï¼Œåœ¨ç‰¹å®šæ¡ä»¶ä¸‹è§¦å‘ï¼›æ¥æ”¶åˆ°å…¶å®ƒä»»åŠ¡çš„é€šçŸ¥æ—¶è¢«è§¦å‘ï¼›</p></blockquote><p>ã€€ã€€(1) æŸä»»åŠ¡çš„çŠ¶æ€åœ¨è¿è¡Œåä¸ºchangedæ—¶ï¼Œå¯é€šè¿‡â€œnotifyâ€é€šçŸ¥ç»™ç›¸åº”çš„handlersï¼›<br>ã€€ã€€(2) ä»»åŠ¡å¯ä»¥é€šè¿‡â€œtagsâ€œæ‰“æ ‡ç­¾ï¼Œè€Œåå¯åœ¨ansible-playbookå‘½ä»¤ä¸Šä½¿ç”¨-tæŒ‡å®šè¿›è¡Œè°ƒç”¨ï¼›</p><h5 id="ä¸¾ä¾‹"><a href="#ä¸¾ä¾‹" class="headerlink" title="ä¸¾ä¾‹"></a>ä¸¾ä¾‹</h5><p><strong>â‘  å®šä¹‰playbook</strong></p><pre><code>[root@server ~]# cd /etc/ansible[root@server ansible]# vim nginx.yml---- hosts: web  remote_user: root  tasks:    - name: install nginx      yum: name=nginx state=present    - name: copy nginx.conf      copy: src=/tmp/nginx.conf dest=/etc/nginx/nginx.conf backup=yes      notify: reloadã€€ã€€ã€€ã€€#å½“nginx.confå‘ç”Ÿæ”¹å˜æ—¶ï¼Œé€šçŸ¥ç»™ç›¸åº”çš„handlers      tags: reloadnginxã€€ã€€ã€€#æ‰“æ ‡ç­¾    - name: start nginx service      service: name=nginx state=started      tags: startnginxã€€ã€€ã€€#æ‰“æ ‡ç­¾  handlers:ã€€ã€€#æ³¨æ„ï¼Œå‰é¢æ²¡æœ‰-ï¼Œæ˜¯ä¸¤ä¸ªç©ºæ ¼    - name: reload      service: name=nginx state=restartedã€€ã€€#ä¸ºäº†åœ¨è¿›ç¨‹ä¸­èƒ½çœ‹å‡ºæ¥</code></pre><p><strong>â‘¡ æµ‹è¯•è¿è¡Œç»“æœ</strong><br>ã€€ã€€å†™å®Œäº†ä»¥åï¼Œæˆ‘ä»¬å°±å¯ä»¥è¿è¡Œäº†ï¼š</p><pre><code>[root@server ansible]# ansible-playbook nginx.yml</code></pre><p>ã€€ã€€ç°åœ¨æˆ‘ä»¬å¯ä»¥çœ‹çœ‹ä¸¤å°æœºå™¨çš„ç«¯å£æ˜¯å¦å¼€å¯ï¼š</p><pre><code>[root@server ansible]# ansible web -m shell -a &#39;ss -nutlp |grep nginx&#39;192.168.37.122 | SUCCESS | rc=0 &gt;&gt;tcp    LISTEN     0      128       *:80                    *:*                   users:((&quot;nginx&quot;,pid=8304,fd=6),(&quot;nginx&quot;,pid=8303,fd=6))192.168.37.133 | SUCCESS | rc=0 &gt;&gt;tcp    LISTEN     0      128       *:80                    *:*                   users:((&quot;nginx&quot;,pid=9671,fd=6),(&quot;nginx&quot;,pid=9670,fd=6))</code></pre><p><strong>â‘¢ æµ‹è¯•æ ‡ç­¾</strong><br>ã€€ã€€æˆ‘ä»¬åœ¨é‡Œé¢å·²ç»æ‰“ä¸Šäº†ä¸€ä¸ªæ ‡ç­¾ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥å¼•ç”¨æ ‡ç­¾ã€‚ä½†æ˜¯æˆ‘ä»¬éœ€è¦å…ˆæŠŠæœåŠ¡å…³é—­ï¼Œå†æ¥è¿è¡Œå‰§æœ¬å¹¶å¼•ç”¨æ ‡ç­¾ï¼š</p><pre><code>[root@server ansible]# ansible web -m shell -a &#39;systemctl stop nginx&#39;[root@server ansible]# ansible-playbook nginx.yml -t startnginx</code></pre><p><strong>â‘£ æµ‹è¯•notify</strong><br>ã€€ã€€æˆ‘ä»¬è¿˜åšäº†ä¸€ä¸ª<code>notify</code>ï¼Œæ¥æµ‹è¯•ä¸€ä¸‹ï¼š<br>ã€€ã€€é¦–å…ˆï¼Œå®ƒçš„è§¦å‘æ¡ä»¶æ˜¯é…ç½®æ–‡ä»¶è¢«æ”¹å˜ï¼Œæ‰€ä»¥æˆ‘ä»¬å»æŠŠé…ç½®æ–‡ä»¶ä¸­çš„ç«¯å£æ”¹ä¸€ä¸‹ï¼š</p><pre><code>[root@server ansible]# vim /tmp/nginx.conf    listen       8080;</code></pre><p>ã€€ã€€ç„¶åæˆ‘ä»¬é‡æ–°åŠ è½½ä¸€ä¸‹è¿™ä¸ªå‰§æœ¬ï¼š</p><pre><code> [root@server ansible]# ansible-playbook nginx.yml -t reloadnginx</code></pre><p>ã€€ã€€å‘ç°æˆ‘ä»¬æ‰§è¡Œçš„å°±æ˜¯reloadæ®µä»¥åŠæˆ‘ä»¬å®šä¹‰çš„<code>notify</code>éƒ¨åˆ†ã€‚<br>ã€€ã€€æˆ‘ä»¬æ¥çœ‹ä¸€çœ‹æˆ‘ä»¬çš„ç«¯å£å·ï¼š</p><p>ã€€ã€€å‘ç°æˆ‘ä»¬æ‰§è¡Œçš„å°±æ˜¯reloadæ®µä»¥åŠæˆ‘ä»¬å®šä¹‰çš„<code>notify</code>éƒ¨åˆ†ã€‚<br>ã€€ã€€æˆ‘ä»¬æ¥çœ‹ä¸€çœ‹æˆ‘ä»¬çš„ç«¯å£å·ï¼š</p><pre><code>[root@server ansible]# ansible web -m shell -a &#39;ss -ntlp | grep nginx&#39;192.168.37.122 | SUCCESS | rc=0 &gt;&gt;LISTEN     0      128          *:8080                     *:*                   users:((&quot;nginx&quot;,pid=2097,fd=6),(&quot;nginx&quot;,pid=2096,fd=6))192.168.37.133 | SUCCESS | rc=0 &gt;&gt;LISTEN     0      128          *:8080                     *:*                   users:((&quot;nginx&quot;,pid=3061,fd=6),(&quot;nginx&quot;,pid=3060,fd=6))</code></pre><p>ã€€ã€€å¯ä»¥çœ‹å‡ºï¼Œæˆ‘ä»¬çš„nginxç«¯å£å·²ç»å˜æˆäº†8080ã€‚ã€€ã€€</p><h3 id="4ã€variables-éƒ¨åˆ†"><a href="#4ã€variables-éƒ¨åˆ†" class="headerlink" title="4ã€variables éƒ¨åˆ†"></a>4ã€variables éƒ¨åˆ†</h3><p>ã€€ã€€ä¸Šæ–‡ä¸­ï¼Œæˆ‘ä»¬è¯´åˆ°äº†<code>variables</code>æ˜¯å˜é‡ï¼Œæœ‰å››ç§å®šä¹‰æ–¹æ³•ï¼Œç°åœ¨æˆ‘ä»¬å°±æ¥è¯´è¯´è¿™å››ç§å®šä¹‰æ–¹æ³•ï¼š</p><h4 id="â‘ -facts-ï¼šå¯ç›´æ¥è°ƒç”¨"><a href="#â‘ -facts-ï¼šå¯ç›´æ¥è°ƒç”¨" class="headerlink" title="â‘  facts ï¼šå¯ç›´æ¥è°ƒç”¨"></a>â‘  facts ï¼šå¯ç›´æ¥è°ƒç”¨</h4><p>ã€€ã€€ä¸Šä¸€ç¯‡ä¸­ï¼Œæˆ‘ä»¬æœ‰è¯´åˆ°<code>setup</code>è¿™ä¸ªæ¨¡å—ï¼Œè¿™ä¸ªæ¨¡å—å°±æ˜¯é€šè¿‡è°ƒç”¨factsç»„ä»¶æ¥å®ç°çš„ã€‚æˆ‘ä»¬è¿™é‡Œçš„<code>variables</code>ä¹Ÿå¯ä»¥ç›´æ¥è°ƒç”¨<code>facts</code>ç»„ä»¶ã€‚<br>ã€€ã€€å…·ä½“çš„<code>facters</code>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>setup</code>æ¨¡å—æ¥è·å–ï¼Œç„¶åç›´æ¥æ”¾å…¥æˆ‘ä»¬çš„å‰§æœ¬ä¸­è°ƒç”¨å³å¯ã€‚</p><pre><code>ansible_all_ipv4_addressesï¼šä»…æ˜¾ç¤ºipv4çš„ä¿¡æ¯ ---&gt; [u&#39;192.168.95.143&#39;]ansible_eth0[&#39;ipv4&#39;][&#39;address&#39;]ï¼šä»…æ˜¾ç¤ºipv4çš„ä¿¡æ¯ ---&gt; eth0 çš„ipåœ°å€ansible_devicesï¼šä»…æ˜¾ç¤ºç£ç›˜è®¾å¤‡ä¿¡æ¯ansible_distributionï¼šæ˜¾ç¤ºæ˜¯ä»€ä¹ˆç³»ç»Ÿï¼Œä¾‹ï¼šcentos,suseç­‰ansible_distribution_versionï¼šä»…æ˜¾ç¤ºç³»ç»Ÿç‰ˆæœ¬ansible_machineï¼šæ˜¾ç¤ºç³»ç»Ÿç±»å‹ï¼Œä¾‹ï¼š32ä½ï¼Œè¿˜æ˜¯64ä½ansible_eth0ï¼šä»…æ˜¾ç¤ºeth0çš„ä¿¡æ¯ansible_hostnameï¼šä»…æ˜¾ç¤ºä¸»æœºåansible_kernelï¼šä»…æ˜¾ç¤ºå†…æ ¸ç‰ˆæœ¬ansible_lvmï¼šæ˜¾ç¤ºlvmç›¸å…³ä¿¡æ¯ansible_memtotal_mbï¼šæ˜¾ç¤ºç³»ç»Ÿæ€»å†…å­˜ansible_memfree_mbï¼šæ˜¾ç¤ºå¯ç”¨ç³»ç»Ÿå†…å­˜ansible_memory_mbï¼šè¯¦ç»†æ˜¾ç¤ºå†…å­˜æƒ…å†µansible_swaptotal_mbï¼šæ˜¾ç¤ºæ€»çš„swapå†…å­˜ansible_swapfree_mbï¼šæ˜¾ç¤ºswapå†…å­˜çš„å¯ç”¨å†…å­˜ansible_mountsï¼šæ˜¾ç¤ºç³»ç»Ÿç£ç›˜æŒ‚è½½æƒ…å†µansible_processorï¼šæ˜¾ç¤ºcpuä¸ªæ•°(å…·ä½“æ˜¾ç¤ºæ¯ä¸ªcpuçš„å‹å·)ansible_processor_vcpusï¼šæ˜¾ç¤ºcpuä¸ªæ•°(åªæ˜¾ç¤ºæ€»çš„ä¸ªæ•°)ansible_python_versionï¼šæ˜¾ç¤ºpythonç‰ˆæœ¬</code></pre><p>ä¾‹å¦‚ï¼šæ‰¹é‡ä¿®æ”¹ä¸»æœº host æ–‡ä»¶</p><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">---</span><span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> web    <span class="token key atrule">vars</span><span class="token punctuation">:</span>            <span class="token key atrule">IP</span><span class="token punctuation">:</span> <span class="token string">"{{ ansible_eth0['ipv4']['address'] }}"</span>    <span class="token key atrule">tasks</span><span class="token punctuation">:</span>          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> å°†åŸæœ‰çš„hostsæ–‡ä»¶å¤‡ä»½              <span class="token key atrule">shell</span><span class="token punctuation">:</span> mv /etc/hosts /etc/hosts_bak          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> å°†ansibleç«¯çš„hostså¤åˆ¶åˆ°å„è‡ªæœºå™¨ä¸Š              <span class="token key atrule">copy</span><span class="token punctuation">:</span> src=/root/hosts dest=/etc/ owner=root group=root mode=0644          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> åœ¨æ–°çš„hostsæ–‡ä»¶åé¢è¿½åŠ å„è‡ªæœºå™¨å†…ç½‘ipå’Œhostname              <span class="token key atrule">lineinfile</span><span class="token punctuation">:</span> dest=/etc/hosts line="<span class="token punctuation">{</span><span class="token punctuation">{</span> IP <span class="token punctuation">}</span><span class="token punctuation">}</span>  <span class="token punctuation">{</span><span class="token punctuation">{</span> ansible_hostname <span class="token punctuation">}</span><span class="token punctuation">}</span>"</code></pre><h4 id="â‘¡-ç”¨æˆ·è‡ªå®šä¹‰å˜é‡"><a href="#â‘¡-ç”¨æˆ·è‡ªå®šä¹‰å˜é‡" class="headerlink" title="â‘¡ ç”¨æˆ·è‡ªå®šä¹‰å˜é‡"></a>â‘¡ ç”¨æˆ·è‡ªå®šä¹‰å˜é‡</h4><p>ã€€ã€€æˆ‘ä»¬ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨ç”¨æˆ·è‡ªå®šä¹‰å˜é‡ï¼Œæƒ³è¦è‡ªå®šä¹‰å˜é‡æœ‰ä»¥ä¸‹ä¸¤ç§æ–¹å¼ï¼š</p><blockquote><p>é€šè¿‡å‘½ä»¤è¡Œä¼ å…¥</p></blockquote><p>ã€€ã€€<code>ansible-playbook</code>å‘½ä»¤çš„å‘½ä»¤è¡Œä¸­çš„<code>-e VARS, --extra-vars=VARS</code>ï¼Œè¿™æ ·å°±å¯ä»¥ç›´æ¥æŠŠè‡ªå®šä¹‰çš„å˜é‡ä¼ å…¥ã€‚</p><blockquote><p>åœ¨playbookä¸­å®šä¹‰å˜é‡</p></blockquote><p>ã€€ã€€æˆ‘ä»¬ä¹Ÿå¯ä»¥ç›´æ¥åœ¨playbookä¸­å®šä¹‰æˆ‘ä»¬çš„å˜é‡ï¼š</p><pre><code>vars:ã€€ã€€- var1: value1ã€€ã€€- var2: value2</code></pre><h5 id="ä¸¾ä¾‹-1"><a href="#ä¸¾ä¾‹-1" class="headerlink" title="ä¸¾ä¾‹"></a>ä¸¾ä¾‹</h5><p><strong>â‘  å®šä¹‰å‰§æœ¬</strong><br>ã€€ã€€æˆ‘ä»¬å°±ä½¿ç”¨å…¨å±€æ›¿æ¢æŠŠæˆ‘ä»¬åˆšåˆšç¼–è¾‘çš„æ–‡ä»¶ä¿®æ”¹ä¸€ä¸‹ï¼š</p><pre><code>[root@server ansible]# vim nginx.yml</code></pre><p><img src="https://s1.ax1x.com/2020/04/16/JEZEz8.png" alt="JEZEz8.png"><br><img src="https://s1.ax1x.com/2020/04/16/JEZmLQ.png" alt="JEZmLQ.png">ã€€ã€€è¿™æ ·ä¸€æ¥ï¼Œæˆ‘ä»¬çš„å‰§æœ¬å°±å®šä¹‰å®Œæˆäº†ã€‚<br><strong>â‘¡ æ‹·è´é…ç½®æ–‡ä»¶</strong><br>ã€€ã€€æˆ‘ä»¬æƒ³è¦åœ¨è¢«ç›‘ç®¡çš„æœºå™¨ä¸Šå®‰è£…ä»€ä¹ˆæœåŠ¡çš„è¯ï¼Œå°±ç›´æ¥åœ¨æˆ‘ä»¬çš„serverç«¯ä¸ŠæŠŠè¯¥æœåŠ¡çš„é…ç½®æ–‡ä»¶æ‹·è´åˆ°æˆ‘ä»¬çš„<code>/tmp/</code>ç›®å½•ä¸‹ã€‚è¿™æ ·æˆ‘ä»¬çš„å‰§æœ¬æ‰èƒ½æ­£å¸¸è¿è¡Œã€‚<br>ã€€ã€€æˆ‘ä»¬å°±ä»¥<code>keepalived</code>æœåŠ¡ä¸ºä¾‹ï¼š</p><pre class=" language-shell"><code class="language-shell">[root@server ansible]# cp /etc/keepalived/keepalived.conf /tmp/keepalived.conf</code></pre><p><strong>â‘¢ è¿è¡Œå‰§æœ¬ï¼Œå˜é‡ç”±å‘½ä»¤è¡Œä¼ å…¥</strong></p><pre><code>[root@server ansible]# ansible-playbook nginx.yml -e rpmname=keepalived</code></pre><p><img src="https://s1.ax1x.com/2020/04/16/JEZKds.png" alt="JEZKds.png"><br><strong>â‘£ ä¿®æ”¹å‰§æœ¬ï¼Œç›´æ¥å®šä¹‰å˜é‡</strong><br>ã€€ã€€åŒæ ·çš„ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥åœ¨å‰§æœ¬ä¸­æŠŠå˜é‡å®šä¹‰å¥½ï¼Œè¿™æ ·å°±ä¸éœ€è¦åœ¨é€šè¿‡å‘½ä»¤è¡Œä¼ å…¥äº†ã€‚ä»¥åæƒ³è¦å®‰è£…ä¸åŒçš„æœåŠ¡ï¼Œç›´æ¥åœ¨å‰§æœ¬é‡ŒæŠŠå˜é‡ä¿®æ”¹ä¸€ä¸‹å³å¯ã€‚</p><pre><code>[root@server ansible]# vim nginx.yml</code></pre><p>![img](E:/å­¦ä¹ æ™‹å‡æ–‡ä»¶æ±‡æ€»/Linuxæ¶æ„å­¦ä¹ å…¥é—¨/4. network_manager/19-20å¤©-ä¼ä¸šè‡ªåŠ¨åŒ–è¿ç»´å·¥å…·Aansibleå®æˆ˜/assets/1204916-20171208112356562-1275040347.png)<br><strong>â‘¤ è¿è¡Œå®šä¹‰è¿‡å˜é‡çš„å‰§æœ¬</strong><br>ã€€ã€€æˆ‘ä»¬åˆšåˆšå·²ç»æŠŠå˜é‡å®šä¹‰åœ¨å‰§æœ¬é‡Œé¢äº†ã€‚ç°åœ¨æˆ‘ä»¬æ¥è¿è¡Œä¸€ä¸‹è¯•è¯•çœ‹ï¼š</p><pre><code>[root@server ansible]# ansible-playbook nginx.yml</code></pre><p><img src="https://s1.ax1x.com/2020/04/16/JEZMon.png" alt="JEZMon.png"><br>ã€€ã€€å‘ç°è¿™æ ·ä¹Ÿæ˜¯å¯ä»¥çš„~</p><h4 id="â‘¢-é€šè¿‡rolesä¼ é€’å˜é‡"><a href="#â‘¢-é€šè¿‡rolesä¼ é€’å˜é‡" class="headerlink" title="â‘¢ é€šè¿‡rolesä¼ é€’å˜é‡"></a>â‘¢ é€šè¿‡rolesä¼ é€’å˜é‡</h4><p>ã€€ã€€å…·ä½“çš„ï¼Œæˆ‘ä»¬ä¸‹æ–‡ä¸­è¯´åˆ° roles çš„æ—¶å€™å†è¯¦ç»†è¯´æ˜ã€‚</p><h4 id="â‘£-Host-Inventory"><a href="#â‘£-Host-Inventory" class="headerlink" title="â‘£ Host Inventory"></a>â‘£ Host Inventory</h4><p>ã€€ã€€æˆ‘ä»¬ä¹Ÿå¯ä»¥ç›´æ¥åœ¨ä¸»æœºæ¸…å•ä¸­å®šä¹‰ã€‚<br>ã€€ã€€å®šä¹‰çš„æ–¹æ³•å¦‚ä¸‹ï¼š</p><blockquote><p>å‘ä¸åŒçš„ä¸»æœºä¼ é€’ä¸åŒçš„å˜é‡ï¼š</p></blockquote><pre><code>ã€€ã€€IP/HOSTNAME varaiable=value var2=value2</code></pre><blockquote><p>å‘ç»„ä¸­çš„ä¸»æœºä¼ é€’ç›¸åŒçš„å˜é‡ï¼š</p></blockquote><pre><code>ã€€ã€€[groupname:vars]ã€€ã€€variable=value</code></pre><p>Ansible Inventory å†…ç½®å‚æ•°</p><p>![Ansible Inventory å†…ç½®å‚æ•°](E:/å­¦ä¹ æ™‹å‡æ–‡ä»¶æ±‡æ€»/Linuxæ¶æ„å­¦ä¹ å…¥é—¨/4. network_manager/19-20å¤©-ä¼ä¸šè‡ªåŠ¨åŒ–è¿ç»´å·¥å…·Aansibleå®æˆ˜/assets/Ansible Inventory å†…ç½®å‚æ•°.png)</p><p>ä½¿ç”¨å†…ç½®å˜é‡æŠŠç”¨æˆ·åå¯†ç å†™åœ¨Inventoryä¸­ï¼Œä¹Ÿå°±æ˜¯/etc/ansible/hostsæ–‡ä»¶é‡Œï¼Œç¼ºç‚¹å°±æ˜¯<strong>æš´éœ²äº†è´¦å·å¯†ç </strong>ï¼Œä¸å®‰å…¨ã€‚å¦‚æœæœ‰å¤šä¸ªä¸»æœºéœ€è¦ä½¿ç”¨åŒæ ·çš„å˜é‡ï¼Œå¯ä»¥ç”¨ç»„å˜é‡çš„å½¢å¼ï¼Œä¹¦å†™æ ¼å¼å¦‚ä¸‹ï¼š</p><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">[</span>web<span class="token punctuation">]</span>192.168.100.10192.168.100.11192.168.100.12 <span class="token punctuation">[</span>web<span class="token punctuation">:</span>vars<span class="token punctuation">]</span>  <span class="token comment" spellcheck="true">#ç»™åä¸ºwebserversçš„ç»„å®šä¹‰ä¸€ä¸ªå˜é‡ï¼Œ:varsæ˜¯å›ºå®šæ ¼å¼</span>ansible_ssh_port=22ansible_ssh_user='root'ansible_ssh_pass='1234.com'</code></pre><h3 id="5ã€æ¨¡æ¿-templates"><a href="#5ã€æ¨¡æ¿-templates" class="headerlink" title="5ã€æ¨¡æ¿ templates"></a>5ã€æ¨¡æ¿ templates</h3><p>ã€€ã€€æ¨¡æ¿æ˜¯ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ï¼ŒåµŒå¥—æœ‰è„šæœ¬ï¼ˆä½¿ç”¨æ¨¡æ¿ç¼–ç¨‹è¯­è¨€ç¼–å†™ï¼‰ã€‚<br>ã€€ã€€<code>Jinja2</code>ï¼šJinja2æ˜¯pythonçš„ä¸€ç§æ¨¡æ¿è¯­è¨€ï¼Œä»¥Djangoçš„æ¨¡æ¿è¯­è¨€ä¸ºåŸæœ¬ã€‚<br>æ¨¡æ¿æ”¯æŒï¼š</p><pre><code>ã€€ã€€å­—ç¬¦ä¸²ï¼šä½¿ç”¨å•å¼•å·æˆ–åŒå¼•å·ï¼›ã€€ã€€æ•°å­—ï¼šæ•´æ•°ï¼Œæµ®ç‚¹æ•°ï¼›ã€€ã€€åˆ—è¡¨ï¼š[item1, item2, ...]ã€€ã€€å…ƒç»„ï¼š(item1, item2, ...)ã€€ã€€å­—å…¸ï¼š{key1:value1, key2:value2, ...}ã€€ã€€å¸ƒå°”å‹ï¼štrue/falseã€€ã€€ç®—æœ¯è¿ç®—ï¼šã€€ã€€ã€€ã€€+, -, *, /, //, %, **ã€€ã€€æ¯”è¾ƒæ“ä½œï¼šã€€ã€€ã€€ã€€==, !=, &gt;, &gt;=, &lt;, &lt;=ã€€ã€€é€»è¾‘è¿ç®—ï¼šã€€ã€€ã€€ã€€and, or, not</code></pre><p>ã€€ã€€é€šå¸¸æ¥è¯´ï¼Œæ¨¡æ¿éƒ½æ˜¯é€šè¿‡å¼•ç”¨å˜é‡æ¥è¿ç”¨çš„ã€‚</p><h5 id="ä¸¾ä¾‹-2"><a href="#ä¸¾ä¾‹-2" class="headerlink" title="ä¸¾ä¾‹"></a>ä¸¾ä¾‹</h5><p><strong>â‘  å®šä¹‰æ¨¡æ¿</strong><br>ã€€ã€€æˆ‘ä»¬ç›´æ¥æŠŠä¹‹å‰å®šä¹‰çš„<code>/tmp/nginx.conf</code>æ”¹ä¸ªåï¼Œç„¶åç¼–è¾‘ä¸€ä¸‹ï¼Œå°±å¯ä»¥å®šä¹‰æˆæˆ‘ä»¬çš„æ¨¡æ¿æ–‡ä»¶äº†ï¼š</p><pre><code>[root@server ansible]# cd /tmp[root@server tmp]# mv nginx.conf nginx.conf.j2[root@server tmp]# vim nginx.conf.j2    worker_processes  {{ ansible_processor_vcpus }};    listen       {{ nginxport }};</code></pre><p><strong>â‘¡ ä¿®æ”¹å‰§æœ¬</strong><br>ã€€ã€€æˆ‘ä»¬ç°åœ¨éœ€è¦å»ä¿®æ”¹å‰§æœ¬æ¥å®šä¹‰å˜é‡ï¼š</p><pre><code>[root@server ansible]# vim nginx.yml</code></pre><p><a href="https://imgchr.com/i/JEZtL4" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2020/04/16/JEZtL4.png" alt="JEZtL4.png"></a><br>ã€€ã€€éœ€è¦ä¿®æ”¹çš„éƒ¨åˆ†å¦‚å›¾æ‰€ç¤ºã€‚</p><p>  copy ä¹Ÿéœ€è¦ä¿®æ”¹ä¸º template</p><p><strong>â‘¢ è¿è¡Œå‰§æœ¬</strong><br>ã€€ã€€ä¸Šé¢çš„å‡†å¤‡å·¥ä½œå®Œæˆåï¼Œæˆ‘ä»¬å°±å¯ä»¥å»è¿è¡Œå‰§æœ¬äº†ï¼š</p><pre><code>[root@server ansible]# ansible-playbook nginx.yml -t reloadnginxPLAY [web] *********************************************************************TASK [setup] *******************************************************************ok: [192.168.37.122]ok: [192.168.37.133]TASK [copy nginx.conf] *********************************************************ok: [192.168.37.122]ok: [192.168.37.133]PLAY RECAP *********************************************************************192.168.37.122             : ok=2    changed=0    unreachable=0    failed=0   192.168.37.133             : ok=2    changed=0    unreachable=0    failed=0 </code></pre><h3 id="6ã€æ¡ä»¶æµ‹è¯•"><a href="#6ã€æ¡ä»¶æµ‹è¯•" class="headerlink" title="6ã€æ¡ä»¶æµ‹è¯•"></a>6ã€æ¡ä»¶æµ‹è¯•</h3><p>whenè¯­å¥ï¼šåœ¨taskä¸­ä½¿ç”¨ï¼Œjinja2çš„è¯­æ³•æ ¼å¼ã€‚<br>ä¸¾ä¾‹å¦‚ä¸‹ï¼š</p><pre><code>tasks:- name: install conf file to centos7  template: src=files/nginx.conf.c7.j2  when: ansible_distribution_major_version == &quot;7&quot;- name: install conf file to centos6  template: src=files/nginx.conf.c6.j2  when: ansible_distribution_major_version == &quot;6&quot;</code></pre><p>å¾ªç¯ï¼šè¿­ä»£ï¼Œéœ€è¦é‡å¤æ‰§è¡Œçš„ä»»åŠ¡ï¼›<br>ã€€ã€€å¯¹è¿­ä»£é¡¹çš„å¼•ç”¨ï¼Œå›ºå®šå˜é‡åä¸ºâ€itemâ€ï¼Œè€Œåï¼Œè¦åœ¨taskä¸­ä½¿ç”¨with_itemsç»™å®šè¦è¿­ä»£çš„å…ƒç´ åˆ—è¡¨ï¼›<br>ä¸¾ä¾‹å¦‚ä¸‹ï¼š</p><pre><code>tasks:- name: unstall web packages  yum: name={{ item }} state=absent  with_items:  - httpd  - php  - php-mysql</code></pre><h3 id="7ã€å­—å…¸"><a href="#7ã€å­—å…¸" class="headerlink" title="7ã€å­—å…¸"></a>7ã€å­—å…¸</h3><p>ã€€ã€€ansible playbook è¿˜æ”¯æŒå­—å…¸åŠŸèƒ½ã€‚ä¸¾ä¾‹å¦‚ä¸‹ï¼š</p><pre><code>- name: install some packages  yum: name={{ item }} state=present  with_items:    - nginx    - memcached    - php-fpm- name: add some groups  group: name={{ item }} state=present  with_items:    - group11    - group12    - group13- name: add some users  user: name={{ item.name }} group={{ item.group }} state=present  with_items:    - { name: &#39;user11&#39;, group: &#39;group11&#39; }    - { name: &#39;user12&#39;, group: &#39;group12&#39; }    - { name: &#39;user13&#39;, group: &#39;group13&#39; }</code></pre><h3 id="8ã€è§’è‰²è®¢åˆ¶ï¼šroles"><a href="#8ã€è§’è‰²è®¢åˆ¶ï¼šroles" class="headerlink" title="8ã€è§’è‰²è®¢åˆ¶ï¼šroles"></a>8ã€è§’è‰²è®¢åˆ¶ï¼šroles</h3><h4 id="â‘ -ç®€ä»‹"><a href="#â‘ -ç®€ä»‹" class="headerlink" title="â‘  ç®€ä»‹"></a>â‘  ç®€ä»‹</h4><p>ã€€ã€€å¯¹äºä»¥ä¸Šæ‰€æœ‰çš„æ–¹å¼æœ‰ä¸ªå¼Šç«¯å°±æ˜¯æ— æ³•å®ç°å¤ç”¨å‡è®¾åœ¨åŒæ—¶éƒ¨ç½²Webã€dbã€ha æ—¶æˆ–ä¸åŒæœåŠ¡å™¨ç»„åˆä¸åŒçš„åº”ç”¨å°±éœ€è¦å†™å¤šä¸ªymlæ–‡ä»¶ã€‚å¾ˆéš¾å®ç°çµæ´»çš„è°ƒç”¨ã€‚<br>ã€€ã€€roles ç”¨äºå±‚æ¬¡æ€§ã€ç»“æ„åŒ–åœ°ç»„ç»‡playbookã€‚roles èƒ½å¤Ÿæ ¹æ®å±‚æ¬¡å‹ç»“æ„è‡ªåŠ¨è£…è½½å˜é‡æ–‡ä»¶ã€tasksä»¥åŠhandlersç­‰ã€‚è¦ä½¿ç”¨rolesåªéœ€è¦åœ¨playbookä¸­ä½¿ç”¨includeæŒ‡ä»¤å³å¯ã€‚ç®€å•æ¥è®²ï¼Œroleså°±æ˜¯é€šè¿‡åˆ†åˆ«å°†å˜é‡(vars)ã€æ–‡ä»¶(file)ã€ä»»åŠ¡(tasks)ã€æ¨¡å—(modules)åŠå¤„ç†å™¨(handlers)æ”¾ç½®äºå•ç‹¬çš„ç›®å½•ä¸­ï¼Œå¹¶å¯ä»¥ä¾¿æ·åœ°includeå®ƒä»¬çš„ä¸€ç§æœºåˆ¶ã€‚è§’è‰²ä¸€èˆ¬ç”¨äºåŸºäºä¸»æœºæ„å»ºæœåŠ¡çš„åœºæ™¯ä¸­ï¼Œä½†ä¹Ÿå¯ä»¥æ˜¯ç”¨äºæ„å»ºå®ˆæŠ¤è¿›ç¨‹ç­‰åœºæ™¯ä¸­ã€‚</p><h4 id="â‘¡-è§’è‰²é›†åˆ"><a href="#â‘¡-è§’è‰²é›†åˆ" class="headerlink" title="â‘¡ è§’è‰²é›†åˆ"></a>â‘¡ è§’è‰²é›†åˆ</h4><p>è§’è‰²é›†åˆï¼šroles/<br>mysql/<br>httpd/<br>nginx/<br>files/ï¼šå­˜å‚¨ç”±copyæˆ–scriptç­‰æ¨¡å—è°ƒç”¨çš„æ–‡ä»¶ï¼›<br>tasks/ï¼šæ­¤ç›®å½•ä¸­è‡³å°‘åº”è¯¥æœ‰ä¸€ä¸ªåä¸ºmain.ymlçš„æ–‡ä»¶ï¼Œç”¨äºå®šä¹‰å„taskï¼›å…¶å®ƒçš„æ–‡ä»¶éœ€è¦ç”±main.ymlè¿›è¡Œâ€œåŒ…å«â€è°ƒç”¨ï¼›<br>handlers/ï¼šæ­¤ç›®å½•ä¸­è‡³å°‘åº”è¯¥æœ‰ä¸€ä¸ªåä¸ºmain.ymlçš„æ–‡ä»¶ï¼Œç”¨äºå®šä¹‰å„handlerï¼›å…¶å®ƒçš„æ–‡ä»¶éœ€è¦ç”±main.ymlè¿›è¡Œâ€œåŒ…å«â€è°ƒç”¨ï¼›<br>vars/ï¼šæ­¤ç›®å½•ä¸­è‡³å°‘åº”è¯¥æœ‰ä¸€ä¸ªåä¸ºmain.ymlçš„æ–‡ä»¶ï¼Œç”¨äºå®šä¹‰å„variableï¼›å…¶å®ƒçš„æ–‡ä»¶éœ€è¦ç”±main.ymlè¿›è¡Œâ€œåŒ…å«â€è°ƒç”¨ï¼›<br>templates/ï¼šå­˜å‚¨ç”±templateæ¨¡å—è°ƒç”¨çš„æ¨¡æ¿æ–‡æœ¬ï¼›<br>meta/ï¼šæ­¤ç›®å½•ä¸­è‡³å°‘åº”è¯¥æœ‰ä¸€ä¸ªåä¸ºmain.ymlçš„æ–‡ä»¶ï¼Œå®šä¹‰å½“å‰è§’è‰²çš„ç‰¹æ®Šè®¾å®šåŠå…¶ä¾èµ–å…³ç³»ï¼›å…¶å®ƒçš„æ–‡ä»¶éœ€è¦ç”±main.ymlè¿›è¡Œâ€œåŒ…å«â€è°ƒç”¨ï¼›<br>default/ï¼šæ­¤ç›®å½•ä¸­è‡³å°‘åº”è¯¥æœ‰ä¸€ä¸ªåä¸ºmain.ymlçš„æ–‡ä»¶ï¼Œç”¨äºè®¾å®šé»˜è®¤å˜é‡ï¼›</p><h4 id="â‘¢-è§’è‰²å®šåˆ¶å®ä¾‹"><a href="#â‘¢-è§’è‰²å®šåˆ¶å®ä¾‹" class="headerlink" title="â‘¢ è§’è‰²å®šåˆ¶å®ä¾‹"></a>â‘¢ è§’è‰²å®šåˆ¶å®ä¾‹</h4><p><strong>1. åœ¨rolesç›®å½•ä¸‹ç”Ÿæˆå¯¹åº”çš„ç›®å½•ç»“æ„</strong></p><pre><code>[root@server ansible]# cd roles/[root@server roles]# ls[root@server roles]# mkdir -pv ./{nginx,mysql,httpd}/{files,templates,vars,tasks,handlers,meta,default}[root@server roles]# tree.â”œâ”€â”€ httpdâ”‚   â”œâ”€â”€ defaultâ”‚   â”œâ”€â”€ filesâ”‚   â”œâ”€â”€ handlersâ”‚   â”œâ”€â”€ metaâ”‚   â”œâ”€â”€ tasksâ”‚   â”œâ”€â”€ templatesâ”‚   â””â”€â”€ varsâ”œâ”€â”€ mysqlâ”‚   â”œâ”€â”€ defaultâ”‚   â”œâ”€â”€ filesâ”‚   â”œâ”€â”€ handlersâ”‚   â”œâ”€â”€ metaâ”‚   â”œâ”€â”€ tasksâ”‚   â”œâ”€â”€ templatesâ”‚   â””â”€â”€ varsâ””â”€â”€ nginx    â”œâ”€â”€ default    â”œâ”€â”€ files    â”œâ”€â”€ handlers    â”œâ”€â”€ meta    â”œâ”€â”€ tasks    â”œâ”€â”€ templates    â””â”€â”€ vars24 directories, 0 files</code></pre><p><strong>2. å®šä¹‰é…ç½®æ–‡ä»¶</strong><br>ã€€ã€€æˆ‘ä»¬éœ€è¦ä¿®æ”¹çš„é…ç½®æ–‡ä»¶ä¸º<code>/tasks/main.yml</code>ï¼Œä¸‹é¢ï¼Œæˆ‘ä»¬å°±æ¥ä¿®æ”¹ä¸€ä¸‹ï¼š</p><pre><code>[root@server roles]# vim nginx/tasks/main.yml- name: cp  copy: src=nginx-1.10.2-1.el7.ngx.x86_64.rpm dest=/tmp/nginx-1.10.2-1.el7.ngx.x86_64.rpm- name: install  yum: name=/tmp/nginx-1.10.2-1.el7.ngx.x86_64.rpm state=latest- name: conf  template: src=nginx.conf.j2 dest=/etc/nginx/nginx.conf  tags: nginxconf  notify: new conf to reload- name: start service  service: name=nginx state=started enabled=true</code></pre><p><strong>3. æ”¾ç½®æˆ‘ä»¬æ‰€éœ€è¦çš„æ–‡ä»¶åˆ°æŒ‡å®šç›®å½•</strong><br>ã€€ã€€å› ä¸ºæˆ‘ä»¬å®šä¹‰çš„è§’è‰²å·²ç»æœ‰äº†æ–°çš„ç»„æˆæ–¹å¼ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æŠŠæ–‡ä»¶éƒ½æ”¾åˆ°æŒ‡å®šçš„ä½ç½®ï¼Œè¿™æ ·ï¼Œæ‰èƒ½è®©é…ç½®æ–‡ä»¶æ‰¾åˆ°è¿™äº›å¹¶è¿›è¡ŒåŠ è½½ã€‚<br>ã€€ã€€rpmåŒ…æ”¾åœ¨<code>files</code>ç›®å½•ä¸‹ï¼Œæ¨¡æ¿æ”¾åœ¨<code>templates</code>ç›®å½•ä¸‹ï¼š</p><pre><code>[root@server nginx]# cp /tmp/nginx-1.10.2-1.el7.ngx.x86_64.rpm ./files/[root@server nginx]# cp /tmp/nginx.conf.j2 ./templates/[root@server nginx]# tree.â”œâ”€â”€ defaultâ”œâ”€â”€ filesâ”‚   â””â”€â”€ nginx-1.10.2-1.el7.ngx.x86_64.rpmâ”œâ”€â”€ handlersâ”œâ”€â”€ metaâ”œâ”€â”€ tasksâ”‚   â””â”€â”€ main.ymlâ”œâ”€â”€ templatesâ”‚   â””â”€â”€ nginx.conf.j2â””â”€â”€ vars7 directories, 3 files</code></pre><p><strong>4. ä¿®æ”¹å˜é‡æ–‡ä»¶</strong><br>ã€€ã€€æˆ‘ä»¬åœ¨æ¨¡æ¿ä¸­å®šä¹‰çš„å˜é‡ï¼Œä¹Ÿè¦å»é…ç½®æ–‡ä»¶ä¸­åŠ ä¸Šï¼š</p><pre><code>[root@server nginx]# vim vars/main.ymlnginxprot: 9999</code></pre><p><strong>5. å®šä¹‰handlersæ–‡ä»¶</strong><br>ã€€ã€€æˆ‘ä»¬åœ¨é…ç½®æ–‡ä»¶ä¸­å®šä¹‰äº†<code>notify</code>ï¼Œæ‰€ä»¥æˆ‘ä¹ˆä¹Ÿéœ€è¦å®šä¹‰<code>handlers</code>ï¼Œæˆ‘ä»¬æ¥ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼š</p><pre><code>[root@server nginx]# vim handlers/main.yml- name: new conf to reload  service: name=nginx state=restarted</code></pre><p><strong>6. å®šä¹‰å‰§æœ¬æ–‡ä»¶</strong><br>ã€€ã€€æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±æ¥å®šä¹‰å‰§æœ¬æ–‡ä»¶ï¼Œç”±äºå¤§éƒ¨åˆ†è®¾ç½®æˆ‘ä»¬éƒ½å•ç‹¬é…ç½®åœ¨äº†rolesé‡Œé¢ï¼Œæ‰€ä»¥ï¼Œæ¥ä¸‹æ¥å‰§æœ¬å°±åªéœ€è¦å†™ä¸€ç‚¹ç‚¹å†…å®¹å³å¯ï¼š</p><pre><code>[root@server ansible]# vim roles.yml - hosts: web  remote_user: root  roles:    - nginx</code></pre><p><strong>7. å¯åŠ¨æœåŠ¡</strong><br>ã€€ã€€å‰§æœ¬å®šä¹‰å®Œæˆä»¥åï¼Œæˆ‘ä»¬å°±å¯ä»¥æ¥å¯åŠ¨æœåŠ¡äº†ï¼š</p><pre><code>[root@server ansible]# ansible-playbook roles.ymlPLAY [web] *********************************************************************TASK [setup] *******************************************************************ok: [192.168.37.122]ok: [192.168.37.133]TASK [nginx : cp] **************************************************************ok: [192.168.37.122]ok: [192.168.37.133]TASK [nginx : install] *********************************************************changed: [192.168.37.122]changed: [192.168.37.133]TASK [nginx : conf] ************************************************************changed: [192.168.37.122]changed: [192.168.37.133]TASK [nginx : start service] ***************************************************changed: [192.168.37.122]changed: [192.168.37.133]RUNNING HANDLER [nginx : new conf to reload] ***********************************changed: [192.168.37.122]changed: [192.168.37.133]PLAY RECAP *********************************************************************192.168.37.122             : ok=6    changed=4    unreachable=0    failed=0   192.168.37.133             : ok=6    changed=4    unreachable=0    failed=0   </code></pre><p>ã€€ã€€å¯åŠ¨è¿‡åç…§ä¾‹æŸ¥çœ‹ç«¯å£å·ï¼š</p><pre><code>[root@server ansible]# ansible web -m shell -a &quot;ss -ntulp |grep 9999&quot;192.168.37.122 | SUCCESS | rc=0 &gt;&gt;tcp    LISTEN     0      128       *:9999                  *:*                   users:((&quot;nginx&quot;,pid=7831,fd=6),(&quot;nginx&quot;,pid=7830,fd=6),(&quot;nginx&quot;,pid=7829,fd=6))192.168.37.133 | SUCCESS | rc=0 &gt;&gt;tcp    LISTEN     0      128       *:9999                  *:*                   users:((&quot;nginx&quot;,pid=9654,fd=6),(&quot;nginx&quot;,pid=9653,fd=6),(&quot;nginx&quot;,pid=9652,fd=6))</code></pre><p>ã€€ã€€å¯ä»¥çœ‹å‡ºæˆ‘ä»¬çš„å‰§æœ¬å·²ç»æ‰§è¡ŒæˆåŠŸã€‚</p><h2 id="ä¹ã€Ansibleä½¿ç”¨jinja2ç®¡ç†é…ç½®æ–‡ä»¶ä»¥åŠjinja2è¯­æ³•ç®€ä»‹"><a href="#ä¹ã€Ansibleä½¿ç”¨jinja2ç®¡ç†é…ç½®æ–‡ä»¶ä»¥åŠjinja2è¯­æ³•ç®€ä»‹" class="headerlink" title="ä¹ã€Ansibleä½¿ç”¨jinja2ç®¡ç†é…ç½®æ–‡ä»¶ä»¥åŠjinja2è¯­æ³•ç®€ä»‹"></a>ä¹ã€Ansibleä½¿ç”¨jinja2ç®¡ç†é…ç½®æ–‡ä»¶ä»¥åŠjinja2è¯­æ³•ç®€ä»‹</h2><h3 id="1ã€Jinja2ä»‹ç»"><a href="#1ã€Jinja2ä»‹ç»" class="headerlink" title="1ã€Jinja2ä»‹ç»"></a>1ã€Jinja2ä»‹ç»</h3><p>Jinja2æ˜¯åŸºäºpythonçš„æ¨¡æ¿å¼•æ“ï¼ŒåŠŸèƒ½æ¯”è¾ƒç±»ä¼¼äºPHPçš„smartyï¼ŒJ2eeçš„Freemarkerå’Œvelocityã€‚å®ƒèƒ½å®Œå…¨æ”¯æŒunicodeï¼Œå¹¶å…·æœ‰é›†æˆçš„æ²™ç®±æ‰§è¡Œç¯å¢ƒï¼Œåº”ç”¨å¹¿æ³›ã€‚jinja2ä½¿ç”¨BSDæˆæƒ</p><p>Jinja2çš„è¯­æ³•æ˜¯ç”±variables(å˜é‡)å’Œstatement(è¯­å¥)ç»„æˆï¼Œå¦‚ä¸‹ï¼›</p><h4 id="1ã€variablesï¼šå¯ä»¥è¾“å‡ºæ•°æ®"><a href="#1ã€variablesï¼šå¯ä»¥è¾“å‡ºæ•°æ®" class="headerlink" title="1ã€variablesï¼šå¯ä»¥è¾“å‡ºæ•°æ®"></a>1ã€variablesï¼šå¯ä»¥è¾“å‡ºæ•°æ®</h4><pre><code> my_variables </code></pre>{{ some_dudes_name | capitalize }}<h4 id="2ã€statements-å¯ä»¥ç”¨æ¥åˆ›å»ºæ¡ä»¶å’Œå¾ªç¯ç­‰"><a href="#2ã€statements-å¯ä»¥ç”¨æ¥åˆ›å»ºæ¡ä»¶å’Œå¾ªç¯ç­‰" class="headerlink" title="2ã€statements: å¯ä»¥ç”¨æ¥åˆ›å»ºæ¡ä»¶å’Œå¾ªç¯ç­‰"></a>2ã€statements: å¯ä»¥ç”¨æ¥åˆ›å»ºæ¡ä»¶å’Œå¾ªç¯ç­‰</h4><pre class=" language-bash"><code class="language-bash">ifè¯­å¥ï¼š<span class="token punctuation">{</span>% <span class="token keyword">if</span> my_conditional %<span class="token punctuation">}</span> <span class="token punctuation">..</span>.<span class="token punctuation">{</span>% endif %<span class="token punctuation">}</span><span class="token keyword">for</span> è¯­å¥ï¼š<span class="token punctuation">{</span>% <span class="token keyword">for</span> item <span class="token keyword">in</span> all_items %<span class="token punctuation">}</span><span class="token variable"><span class="token variable">`</span>item<span class="token variable">`</span></span> â€¦â€¦<span class="token punctuation">{</span>% endfor %<span class="token punctuation">}</span></code></pre><p>ä»ä¸Šé¢ç¬¬äºŒä¸ªvariablesçš„ä¾‹å­ä¸­å¯ä»¥çœ‹å‡ºï¼Œjinja2æ”¯æŒä½¿ç”¨å¸¦è¿‡æ»¤å™¨çš„Unixå‹ç®¡é“æ“ä½œç¬¦ï¼Œæœ‰å¾ˆå¤šçš„å†…ç½®è¿‡æ»¤å™¨å¯ä¾›ä½¿ç”¨ã€‚æˆ‘ä»¬å¯ä»¥ä»…ä»…ç”¨ä¸€å †ç®€å•ifå’Œforå°±å¯ä»¥å»ºç«‹å‡ ä¹ä»»ä½•çš„å¸¸è§„é…ç½®æ–‡ä»¶ï¼Œä¸è¿‡å¦‚æœä½ æœ‰æ„æ›´è¿›ä¸€æ­¥ï¼Œjinja2 documentation ï¼ˆ<a href="http://jinja.pocoo.org/docs/dev/ï¼‰åŒ…å«äº†å¾ˆå¤šæœ‰è¶£çš„ä¸œè¥¿å¯ä¾›äº†è§£ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ansibleå…è®¸åœ¨æ¨¡æ¿ä¸­ä½¿ç”¨è¯¸å¦‚ç»˜åˆ¶æ—¶é—´æ­¤ç±»çš„ä¸€äº›é¢å¤–çš„æ¨¡æ¿å˜é‡" target="_blank" rel="noopener">http://jinja.pocoo.org/docs/dev/ï¼‰åŒ…å«äº†å¾ˆå¤šæœ‰è¶£çš„ä¸œè¥¿å¯ä¾›äº†è§£ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ansibleå…è®¸åœ¨æ¨¡æ¿ä¸­ä½¿ç”¨è¯¸å¦‚ç»˜åˆ¶æ—¶é—´æ­¤ç±»çš„ä¸€äº›é¢å¤–çš„æ¨¡æ¿å˜é‡</a></p><p>ç¬¬ä¸€ä¸ªä¾‹å­ï¼šå¼•ç”¨å˜é‡</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#cd roles/template/</span><span class="token keyword">.</span>â”œâ”€â”€ metaâ”‚   â””â”€â”€ main.ymlâ”œâ”€â”€ tasksâ”‚   â”œâ”€â”€ template.yml  â”‚   â””â”€â”€ main.ymlâ”œâ”€â”€ templatesâ”‚   â”œâ”€â”€ order.j2â””â”€â”€ vars    â””â”€â”€ main.yml</code></pre><p>æ€»è°ƒåº¦ymlæ–‡ä»¶ï¼š</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#cat templates.yml</span>---- hosts: 10.0.90.27  user: root  gather_facts: <span class="token boolean">false</span>  roles:   - role: template</code></pre><p>æ³¨æ„:è¿™é‡Œ - role: template å’Œ - template æ˜¯ä¸€æ ·çš„ï¼</p><p>å…¶ä»–ymlæ–‡ä»¶ï¼Œå¦‚ä¸‹ï¼š</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#cat tasks/main.yml</span>- include: template.yml<span class="token comment" spellcheck="true">#cat tasks/template.yml</span>- name: create <span class="token punctuation">{</span><span class="token punctuation">{</span> PROJECT <span class="token punctuation">}</span><span class="token punctuation">}</span> directory  file: dest<span class="token operator">=</span>/data/<span class="token punctuation">{</span><span class="token punctuation">{</span> PROJECT <span class="token punctuation">}</span><span class="token punctuation">}</span> state<span class="token operator">=</span>directory- name: template transfor java <span class="token function">dir</span>  template: src<span class="token operator">=</span>order.j2 dest<span class="token operator">=</span>/data/<span class="token punctuation">{</span><span class="token punctuation">{</span> PROJECT <span class="token punctuation">}</span><span class="token punctuation">}</span>/order.conf<span class="token comment" spellcheck="true">#cat templates/order.j2</span>project: <span class="token punctuation">{</span><span class="token punctuation">{</span> PROJECT <span class="token punctuation">}</span><span class="token punctuation">}</span>switch: <span class="token punctuation">{</span><span class="token punctuation">{</span> SWITCH <span class="token punctuation">}</span><span class="token punctuation">}</span>dbport: <span class="token punctuation">{</span><span class="token punctuation">{</span> DBPORT <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">#cat vars/main.yml</span>PROJECT: <span class="token string">"JAVA"</span>SWITCH: <span class="token string">"ON"</span>DBPORT: <span class="token string">"8080"</span>æµ‹è¯•ï¼š<span class="token comment" spellcheck="true"># ansible-playbook templates.yml --syntax-check</span>playbook: templates.ymlæ‰§è¡Œï¼š<span class="token comment" spellcheck="true"># ansible-playbook templates.yml </span>PLAY <span class="token punctuation">[</span>10.0.90.27<span class="token punctuation">]</span> **************************************************************TASK <span class="token punctuation">[</span>template <span class="token keyword">:</span> include<span class="token punctuation">]</span> ***************************************************included: /etc/ansible/roles/template/tasks/template.yml <span class="token keyword">for</span> 10.0.90.27TASK <span class="token punctuation">[</span>template <span class="token keyword">:</span> create JAVA directory<span class="token punctuation">]</span> *************************************changed: <span class="token punctuation">[</span>10.0.90.27<span class="token punctuation">]</span>TASK <span class="token punctuation">[</span>template <span class="token keyword">:</span> template transfor java dir<span class="token punctuation">]</span> ********************************changed: <span class="token punctuation">[</span>10.0.90.27<span class="token punctuation">]</span>PLAY RECAP *********************************************************************10.0.90.27                 <span class="token keyword">:</span> ok<span class="token operator">=</span>3    changed<span class="token operator">=</span>2    unreachable<span class="token operator">=</span>0    failed<span class="token operator">=</span>0   <span class="token comment" spellcheck="true">#åˆ°10.0.90.27æŸ¥çœ‹ç»“æœ</span><span class="token comment" spellcheck="true">#cat /data/JAVA/order.conf</span>project: JAVAswitch: ONdbport: 8080</code></pre><p>ç¬¬äºŒä¸ªä¾‹å­ï¼šfor è¯­å¥</p><p>ä¸ºè¿œç¨‹ä¸»æœºç”ŸæˆæœåŠ¡å™¨åˆ—è¡¨ï¼ŒåŠ å…¥è¯¥åˆ—è¡¨ä»192.168.13.201 web01.test.com åˆ°192.168.13.211 web11.test.com ç»“æŸï¼Œå¦‚æœæ‰‹åŠ¨æ·»åŠ å°±å¾ˆä¸ç§‘å­¦äº†ï¼Œè¿™é‡Œéœ€è¦ä½¿ç”¨jinja2è¯­æ³•çš„forå¾ªç¯é€šè¿‡æ¨¡æ¿æ‰¹é‡ç”Ÿæˆå¯¹åº”çš„é…ç½®æ–‡ä»¶ï¼Œå¦‚ä¸‹ï¼š</p><p>ansibleç›®å½•ç»“æ„ï¼š</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#cd /etc/ansible/roles/test_hosts</span><span class="token keyword">.</span>â”œâ”€â”€ metaâ”‚   â””â”€â”€ main.ymlâ”œâ”€â”€ tasksâ”‚   â”œâ”€â”€ file1.ymlâ”‚   â””â”€â”€ main.ymlâ”œâ”€â”€ templatesâ”‚   â””â”€â”€ test1.j2â””â”€â”€ vars    â””â”€â”€ main.yml</code></pre><p>å„ä¸ªç›®å½•ä¸‹ymlæ–‡ä»¶å†…å®¹ï¼š</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># cat tasks/file1.yml </span>- name: ansible jinja2 template <span class="token keyword">for</span> hosts config  template: src<span class="token operator">=</span>test1.j2 dest<span class="token operator">=</span>/etc/httpd/conf/httpd.conf.test<span class="token comment" spellcheck="true"># cat tasks/main.yml </span>- include: file1.yml<span class="token comment" spellcheck="true"># cat templates/test1.j2 </span><span class="token punctuation">{</span>% <span class="token keyword">for</span> <span class="token function">id</span> <span class="token keyword">in</span> range<span class="token punctuation">(</span>201,212<span class="token punctuation">)</span> %<span class="token punctuation">}</span>192.168.13.<span class="token punctuation">{</span><span class="token punctuation">{</span> <span class="token function">id</span> <span class="token punctuation">}</span><span class="token punctuation">}</span> web<span class="token punctuation">{</span><span class="token punctuation">{</span> <span class="token string">"%03d"</span> <span class="token operator">|</span>format<span class="token punctuation">(</span>id-200<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>.test.com<span class="token punctuation">{</span>% endfor %<span class="token punctuation">}</span>è§£é‡Šï¼š<span class="token punctuation">{</span><span class="token punctuation">{</span> <span class="token function">id</span> <span class="token punctuation">}</span><span class="token punctuation">}</span> æå–forå¾ªç¯ä¸­å¯¹åº”çš„å˜é‡idå€¼<span class="token string">"%02d"</span>   è°ƒç”¨çš„æ˜¯pythonå†…ç½®çš„å­—ç¬¦ä¸²æ ¼å¼åŒ–è¾“å‡ºï¼ˆ%dæ ¼å¼åŒ–æ•´æ•°ï¼‰å› ä¸ºæ˜¯01,02è¿™ç§æ ¼å¼ï¼Œæ‰€ä»¥æ˜¯ä¿ç•™2ä½ï¼Œæ•…ç”¨02ç„¶åå°†ç»“æœé€šè¿‡ç®¡é“ç¬¦ â€œ<span class="token operator">|</span>â€ ä¼ é€’ç»™format å‡½æ•°åšäºŒæ¬¡å¤„ç†ã€‚</code></pre><p>æ‰§è¡Œç»“æœï¼š</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#cat httpd.conf.test</span>192.168.13.201 web01.test.com192.168.13.202 web02.test.com192.168.13.203 web03.test.com192.168.13.204 web04.test.com192.168.13.205 web05.test.com192.168.13.206 web06.test.com192.168.13.207 web07.test.com192.168.13.208 web08.test.com192.168.13.209 web09.test.com192.168.13.210 web10.test.com192.168.13.211 web11.test.com</code></pre><p>ç¬¬ä¸‰ä¸ªä¾‹å­ï¼šifè¯­å¥</p><p>è¯´æ˜ï¼šå¦‚æœå®šä¹‰ç«¯å£å·ï¼Œå°±ç»‘å®šå®šä¹‰çš„ç«¯å£å·ï¼Œå¦‚æœä¸å®šä¹‰ç«¯å£å·ï¼Œå°±ç»‘å®šé»˜è®¤ç«¯å£å·</p><pre class=" language-bash"><code class="language-bash">ansibleç›®å½•ç»“æœ<span class="token comment" spellcheck="true">#cd /etc/ansible/roles/mysql_cnf</span><span class="token comment" spellcheck="true">#tree</span><span class="token keyword">.</span>â”œâ”€â”€ metaâ”‚   â””â”€â”€ main.ymlâ”œâ”€â”€ tasksâ”‚   â””â”€â”€ main.ymlâ”œâ”€â”€ templatesâ”‚   â””â”€â”€ test3.j2â””â”€â”€ vars</code></pre><p>ä¸»è¦çš„ymlæ–‡ä»¶æ˜¯templatesç›®å½•ä¸‹é¢çš„test3.j2</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># cat templates/test3.j2 </span><span class="token punctuation">{</span>% <span class="token keyword">if</span> PORT %<span class="token punctuation">}</span>bind_address<span class="token operator">=</span>10.0.90.27:<span class="token punctuation">{</span><span class="token punctuation">{</span> PORT <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">{</span>% <span class="token keyword">else</span> %<span class="token punctuation">}</span>bind_address<span class="token operator">=</span>10.0.90.27:3306<span class="token punctuation">{</span>% endif %<span class="token punctuation">}</span></code></pre><p>playbookä¸»æ–‡ä»¶</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># cat jinj2_test.yml </span>---- hosts: 10.0.90.27  user: root  gather_facts: <span class="token boolean">false</span>  vars:    PORT: 3136  tasks:    - name: copy <span class="token function">file</span> to client      template: src<span class="token operator">=</span>/etc/ansible/roles/mysql_cnf/templates/test3.j2 dest<span class="token operator">=</span>/root/my.cnf</code></pre><p>æ‰§è¡Œï¼š</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># ansible-playbook jinj2_test.yml</span>PLAY <span class="token punctuation">[</span>10.0.90.27<span class="token punctuation">]</span> **************************************************************TASK <span class="token punctuation">[</span>copy <span class="token function">file</span> to client<span class="token punctuation">]</span> *****************************************************changed: <span class="token punctuation">[</span>10.0.90.27<span class="token punctuation">]</span>PLAY RECAP *********************************************************************10.0.90.27                 <span class="token keyword">:</span> ok<span class="token operator">=</span>1    changed<span class="token operator">=</span>1    unreachable<span class="token operator">=</span>0    failed<span class="token operator">=</span>0</code></pre><p>æŸ¥çœ‹</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># cat my.cnf </span>bind_address<span class="token operator">=</span>10.0.90.27:3136</code></pre><p>å¦‚æœå°†varså˜é‡å»æ‰ï¼Œæ‰§è¡Œç»“æœï¼š</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># cat jinj2_test.yml </span>---- hosts: 10.0.90.27  user: root  gather_facts: <span class="token boolean">false</span>  vars:    PORT: <span class="token boolean">false</span>  tasks:    - name: copy <span class="token function">file</span> to client      template: src<span class="token operator">=</span>/etc/ansible/roles/mysql_cnf/templates/test3.j2 dest<span class="token operator">=</span>/root/my.cnf</code></pre><p>æŸ¥çœ‹ï¼š</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># cat my.cnf </span>bind_address<span class="token operator">=</span>10.0.90.27:3306</code></pre><h4 id="3ã€Jinja-default-è®¾å®š"><a href="#3ã€Jinja-default-è®¾å®š" class="headerlink" title="3ã€Jinja default()è®¾å®š"></a>3ã€Jinja default()è®¾å®š</h4><p>ç²¾é€šç¨‹åºç¼–ç çš„æœ‹å‹çš†çŸ¥ï¼Œdefault()é»˜è®¤å€¼çš„è®¾å®šæœ‰åŠ©äºç¨‹åºçš„å¥å£®æ€§å’Œç®€æ´æ€§ã€‚æ‰€å¹¸Jinjaä¹Ÿæ”¯æŒè¯¥åŠŸèƒ½ï¼Œä¸Šé¢çš„ä¾‹å­ä¸­ç”ŸæˆMysqlé…ç½®æ–‡ä»¶ä¸­çš„ç«¯å£å®šä¹‰ï¼Œå¦‚æœæŒ‡å®šåˆ™PORT=3136ï¼Œå¦åˆ™PORT=3306ï¼Œæˆ‘ä»¬å°†è¯¥æ¡ˆä¾‹æ”¹é€ ä¸ºä½¿ç”¨default()è¯•è¯•</p><p>ç¼–è¾‘/etc/ansible/roles/mysql_cnf/templates/test3.j2å†…å®¹å¦‚ä¸‹,è¿™ç§æ–¹æ³•æ›´ç®€ä»‹ã€‚</p><p>bind_address=10.0.90.27:3306</p><h3 id="2ã€ansibleä½¿ç”¨jiaja2ç”Ÿæˆapacheå¤šä¸»æœºé…ç½®"><a href="#2ã€ansibleä½¿ç”¨jiaja2ç”Ÿæˆapacheå¤šä¸»æœºé…ç½®" class="headerlink" title="2ã€ansibleä½¿ç”¨jiaja2ç”Ÿæˆapacheå¤šä¸»æœºé…ç½®"></a>2ã€ansibleä½¿ç”¨jiaja2ç”Ÿæˆapacheå¤šä¸»æœºé…ç½®</h3><h4 id="1ã€åˆ›å»ºç›®å½•ï¼Œåˆ›å»ºå¥½ä¹‹åå¦‚ä¸‹ï¼š"><a href="#1ã€åˆ›å»ºç›®å½•ï¼Œåˆ›å»ºå¥½ä¹‹åå¦‚ä¸‹ï¼š" class="headerlink" title="1ã€åˆ›å»ºç›®å½•ï¼Œåˆ›å»ºå¥½ä¹‹åå¦‚ä¸‹ï¼š"></a>1ã€åˆ›å»ºç›®å½•ï¼Œåˆ›å»ºå¥½ä¹‹åå¦‚ä¸‹ï¼š</h4><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#cd /etc/ansible/roles/apache_conf</span><span class="token comment" spellcheck="true"># tree ./</span>./â”œâ”€â”€ metaâ”‚   â””â”€â”€ main.ymlâ”œâ”€â”€ tasksâ”‚   â”œâ”€â”€ file.ymlâ”‚   â””â”€â”€ main.ymlâ”œâ”€â”€ templatesâ”‚   â””â”€â”€ apache.config.j2â””â”€â”€ vars    â””â”€â”€ main.yml4 directories, 5 files</code></pre><h4 id="2ã€åˆ›å»ºtasksè°ƒåº¦æ–‡ä»¶ï¼Œå¦‚ä¸‹ï¼š"><a href="#2ã€åˆ›å»ºtasksè°ƒåº¦æ–‡ä»¶ï¼Œå¦‚ä¸‹ï¼š" class="headerlink" title="2ã€åˆ›å»ºtasksè°ƒåº¦æ–‡ä»¶ï¼Œå¦‚ä¸‹ï¼š"></a>2ã€åˆ›å»ºtasksè°ƒåº¦æ–‡ä»¶ï¼Œå¦‚ä¸‹ï¼š</h4><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#cat file.yml </span>- name: ansible jinja2 template <span class="token keyword">for</span> apache config  template: src<span class="token operator">=</span>apache.config.j2 dest<span class="token operator">=</span>/etc/httpd/conf/httpd.conf.template<span class="token comment" spellcheck="true">#cat main.yml </span>- include: file.yml</code></pre><h4 id="3ã€åˆ›å»ºapacheçš„jinja2æ¨¡æ¿æ–‡ä»¶ï¼Œå¦‚ä¸‹ï¼š"><a href="#3ã€åˆ›å»ºapacheçš„jinja2æ¨¡æ¿æ–‡ä»¶ï¼Œå¦‚ä¸‹ï¼š" class="headerlink" title="3ã€åˆ›å»ºapacheçš„jinja2æ¨¡æ¿æ–‡ä»¶ï¼Œå¦‚ä¸‹ï¼š"></a>3ã€åˆ›å»ºapacheçš„jinja2æ¨¡æ¿æ–‡ä»¶ï¼Œå¦‚ä¸‹ï¼š</h4><pre class=" language-cpp"><code class="language-cpp"><span class="token macro property">#cat apache.config.j2 </span>NameVirtualHost <span class="token operator">*</span><span class="token operator">:</span><span class="token number">80</span><span class="token punctuation">{</span><span class="token operator">%</span> <span class="token keyword">for</span> vhost in apache_vhost <span class="token operator">%</span><span class="token punctuation">}</span><span class="token operator">&lt;</span>VirtualHost <span class="token operator">*</span><span class="token operator">:</span><span class="token number">80</span><span class="token operator">></span>ServerName <span class="token punctuation">{</span><span class="token punctuation">{</span> vhost<span class="token punctuation">.</span>servername <span class="token punctuation">}</span><span class="token punctuation">}</span>DocumentRoot <span class="token punctuation">{</span><span class="token punctuation">{</span> vhost<span class="token punctuation">.</span>documentroot <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token operator">%</span> <span class="token keyword">if</span> vhost<span class="token punctuation">.</span>serveradmin is defined <span class="token operator">%</span><span class="token punctuation">}</span>ServerAdmin <span class="token punctuation">{</span><span class="token punctuation">{</span> vhost<span class="token punctuation">.</span>serveradmin <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token operator">%</span> endif <span class="token operator">%</span><span class="token punctuation">}</span><span class="token operator">&lt;</span>Directory <span class="token string">"{{ vhost.documentroot }}"</span><span class="token operator">></span>AllowOverride AllOptions <span class="token operator">-</span>Indexes FollowSymLinksOrder allow<span class="token punctuation">,</span>denyAllow from all<span class="token operator">&lt;</span><span class="token operator">/</span>Directory<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>VirtualHost<span class="token operator">></span><span class="token punctuation">{</span><span class="token operator">%</span> endfor <span class="token operator">%</span><span class="token punctuation">}</span></code></pre><h4 id="4ã€åˆ›å»ºå˜é‡ï¼Œå¦‚ä¸‹ï¼š"><a href="#4ã€åˆ›å»ºå˜é‡ï¼Œå¦‚ä¸‹ï¼š" class="headerlink" title="4ã€åˆ›å»ºå˜é‡ï¼Œå¦‚ä¸‹ï¼š"></a>4ã€åˆ›å»ºå˜é‡ï¼Œå¦‚ä¸‹ï¼š</h4><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#cat vars/main.yml</span>apache_vhost:- <span class="token punctuation">{</span>servername: <span class="token string">"apache.test1.com"</span>, documentroot: <span class="token string">"/data/test1/"</span><span class="token punctuation">}</span>- <span class="token punctuation">{</span>servername: <span class="token string">"apache.test2.com"</span>, documentroot: <span class="token string">"/data/test2/"</span><span class="token punctuation">}</span></code></pre><h4 id="5ã€åˆ›å»ºæ€»è°ƒåº¦ymlæ–‡ä»¶ï¼Œå¦‚ä¸‹ï¼š"><a href="#5ã€åˆ›å»ºæ€»è°ƒåº¦ymlæ–‡ä»¶ï¼Œå¦‚ä¸‹ï¼š" class="headerlink" title="5ã€åˆ›å»ºæ€»è°ƒåº¦ymlæ–‡ä»¶ï¼Œå¦‚ä¸‹ï¼š"></a>5ã€åˆ›å»ºæ€»è°ƒåº¦ymlæ–‡ä»¶ï¼Œå¦‚ä¸‹ï¼š</h4><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#cat /etc/ansible/apache_test.yml </span>---- hosts: 10.0.90.27  user: root  gather_facts: no  roles:   - <span class="token punctuation">{</span> role: apache_conf <span class="token punctuation">}</span></code></pre><h4 id="6ã€æµ‹è¯•ï¼š"><a href="#6ã€æµ‹è¯•ï¼š" class="headerlink" title="6ã€æµ‹è¯•ï¼š"></a>6ã€æµ‹è¯•ï¼š</h4><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#ansible-playbook apache_test.yml --syntax-check</span>playbook: apache_test.yml</code></pre><h4 id="7ã€æ‰§è¡Œæµ‹è¯•"><a href="#7ã€æ‰§è¡Œæµ‹è¯•" class="headerlink" title="7ã€æ‰§è¡Œæµ‹è¯•"></a>7ã€æ‰§è¡Œæµ‹è¯•</h4><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#ansible-playbook apache_test.yml </span>PLAY <span class="token punctuation">[</span>10.0.90.27<span class="token punctuation">]</span> **************************************************************TASK <span class="token punctuation">[</span>apache_conf <span class="token keyword">:</span> include<span class="token punctuation">]</span> ***************************************************included: /etc/ansible/roles/apache_conf/tasks/file.yml <span class="token keyword">for</span> 10.0.90.27TASK <span class="token punctuation">[</span>apache_conf <span class="token keyword">:</span> ansible jinja2 template <span class="token keyword">for</span> apache config<span class="token punctuation">]</span> *****************changed: <span class="token punctuation">[</span>10.0.90.27<span class="token punctuation">]</span>PLAY RECAP *********************************************************************10.0.90.27                 <span class="token keyword">:</span> ok<span class="token operator">=</span>2    changed<span class="token operator">=</span>1    unreachable<span class="token operator">=</span>0    failed<span class="token operator">=</span>0</code></pre><h4 id="8ã€åˆ°å®¢æˆ·ç«¯æŸ¥çœ‹"><a href="#8ã€åˆ°å®¢æˆ·ç«¯æŸ¥çœ‹" class="headerlink" title="8ã€åˆ°å®¢æˆ·ç«¯æŸ¥çœ‹"></a>8ã€åˆ°å®¢æˆ·ç«¯æŸ¥çœ‹</h4><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#cat httpd.conf.template </span>NameVirtualHost *:80<span class="token operator">&lt;</span>VirtualHost *:80<span class="token operator">></span>ServerName apache.test1.comDocumentRoot /data/test1/<span class="token operator">&lt;</span>Directory <span class="token string">"/data/test1/"</span><span class="token operator">></span>AllowOverride AllOptions -Indexes FollowSymLinksOrder allow,denyAllow from all<span class="token operator">&lt;</span>/Directory<span class="token operator">></span><span class="token operator">&lt;</span>/VirtualHost<span class="token operator">></span><span class="token operator">&lt;</span>VirtualHost *:80<span class="token operator">></span>ServerName apache.test2.comDocumentRoot /data/test2/<span class="token operator">&lt;</span>Directory <span class="token string">"/data/test2/"</span><span class="token operator">></span>AllowOverride AllOptions -Indexes FollowSymLinksOrder allow,denyAllow from all<span class="token operator">&lt;</span>/Directory<span class="token operator">></span><span class="token operator">&lt;</span>/VirtualHost<span class="token operator">></span></code></pre><h2 id="3ã€ansibleä½¿ç”¨jiaja2ç”Ÿæˆnginxä¸€ä¸ªæ¨¡æ¿å¤šç§ä¸åŒé…ç½®"><a href="#3ã€ansibleä½¿ç”¨jiaja2ç”Ÿæˆnginxä¸€ä¸ªæ¨¡æ¿å¤šç§ä¸åŒé…ç½®" class="headerlink" title="3ã€ansibleä½¿ç”¨jiaja2ç”Ÿæˆnginxä¸€ä¸ªæ¨¡æ¿å¤šç§ä¸åŒé…ç½®"></a>3ã€ansibleä½¿ç”¨jiaja2ç”Ÿæˆnginxä¸€ä¸ªæ¨¡æ¿å¤šç§ä¸åŒé…ç½®</h2><p>è¯´æ˜ï¼šä¸º2å°Nginx Proxyï¼Œ1å°Nginx Webé€šè¿‡ä¸€å¥—æ¨¡æ¿ç”Ÿæˆå¯¹åº”çš„é…ç½®</p><h4 id="1ã€ansibleç›®å½•ç»“æ„ï¼š"><a href="#1ã€ansibleç›®å½•ç»“æ„ï¼š" class="headerlink" title="1ã€ansibleç›®å½•ç»“æ„ï¼š"></a>1ã€ansibleç›®å½•ç»“æ„ï¼š</h4><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># cd roles/nginx_conf/</span><span class="token comment" spellcheck="true">#tree</span><span class="token keyword">.</span>â”œâ”€â”€ filesâ”œâ”€â”€ metaâ”‚   â””â”€â”€ main.ymlâ”œâ”€â”€ tasksâ”‚   â”œâ”€â”€ file.ymlâ”‚   â””â”€â”€ main.ymlâ”œâ”€â”€ templatesâ”‚   â””â”€â”€ nginx.conf.j2â””â”€â”€ vars    â””â”€â”€ main.yml</code></pre><h4 id="2ã€tasksç›®å½•ä¸‹æ–‡ä»¶å†…å®¹ï¼š"><a href="#2ã€tasksç›®å½•ä¸‹æ–‡ä»¶å†…å®¹ï¼š" class="headerlink" title="2ã€tasksç›®å½•ä¸‹æ–‡ä»¶å†…å®¹ï¼š"></a>2ã€tasksç›®å½•ä¸‹æ–‡ä»¶å†…å®¹ï¼š</h4><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#cat tasks/file.yml </span>- name: nginx.j2 template transfer example   template: src<span class="token operator">=</span>nginx.conf.j2 dest<span class="token operator">=</span>/etc/nginx/nginx.conf.template<span class="token comment" spellcheck="true">#cat tasks/main.yml </span>- include: file.yml</code></pre><h4 id="3ã€nginxæ¨¡æ¿æ–‡ä»¶"><a href="#3ã€nginxæ¨¡æ¿æ–‡ä»¶" class="headerlink" title="3ã€nginxæ¨¡æ¿æ–‡ä»¶"></a>3ã€nginxæ¨¡æ¿æ–‡ä»¶</h4><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#cat templates/nginx.conf.j2 </span><span class="token punctuation">{</span>% <span class="token keyword">if</span> nginx_use_proxy %<span class="token punctuation">}</span><span class="token punctuation">{</span>% <span class="token keyword">for</span> proxy <span class="token keyword">in</span> nginx_proxies %<span class="token punctuation">}</span>upstream <span class="token punctuation">{</span><span class="token punctuation">{</span> proxy.name <span class="token punctuation">}</span><span class="token punctuation">}</span>   <span class="token comment" spellcheck="true">#server 127.0.0.1:{{ proxy.port }};</span>   server <span class="token punctuation">{</span><span class="token punctuation">{</span> ansible_eth0.ipv4.address <span class="token punctuation">}</span><span class="token punctuation">}</span>:<span class="token punctuation">{</span><span class="token punctuation">{</span> proxy.port <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">{</span>% endfor %<span class="token punctuation">}</span><span class="token punctuation">{</span>% endif%<span class="token punctuation">}</span>server <span class="token punctuation">{</span>    listen 80<span class="token punctuation">;</span>    servername <span class="token punctuation">{</span><span class="token punctuation">{</span> nginx_server_name <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>    access_log off<span class="token punctuation">;</span>    error_log /etc/nginx/nginx_error.log<span class="token punctuation">;</span>    rewrite ^ https://<span class="token variable">$server_name</span><span class="token variable">$request_uri?</span> permanent<span class="token punctuation">;</span><span class="token punctuation">}</span>server <span class="token punctuation">{</span>    listen 443 ssl<span class="token punctuation">;</span>    server_name <span class="token punctuation">{</span><span class="token punctuation">{</span> nginx_server_name <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>    ssl_certificate /etc/nginx/ssl/<span class="token punctuation">{</span><span class="token punctuation">{</span> nginx_ssl_cert_name <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>    ssl_certificate_key /etc/nginx/ssl/<span class="token punctuation">{</span><span class="token punctuation">{</span> nginx_ssl_cert_key <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>    root <span class="token punctuation">{</span><span class="token punctuation">{</span> nginx_web_root <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>    index index.html index.html<span class="token punctuation">;</span><span class="token punctuation">{</span>% <span class="token keyword">if</span> nginx_use_auth %<span class="token punctuation">}</span>   auth_basic  <span class="token string">"Restricted"</span><span class="token punctuation">;</span>   auth_basic_user_file /etc/nginx/<span class="token punctuation">{</span><span class="token punctuation">{</span> project_name <span class="token punctuation">}</span><span class="token punctuation">}</span>.htpasswd<span class="token punctuation">;</span><span class="token punctuation">{</span>% endif %<span class="token punctuation">}</span><span class="token punctuation">{</span>% <span class="token keyword">if</span> nginx_use_proxy %<span class="token punctuation">}</span><span class="token punctuation">{</span>% <span class="token keyword">for</span> proxy <span class="token keyword">in</span> nginx_proxies %<span class="token punctuation">}</span>   location <span class="token punctuation">{</span><span class="token punctuation">{</span> proxy.location <span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token punctuation">{</span>      proxy_set_header X-Real-IP <span class="token variable">$remote_addr</span><span class="token punctuation">;</span>      proxy_set_header X-Forwarded-Proto http<span class="token punctuation">;</span>      proxy_set_header X-Url-Scheme <span class="token variable">$scheme</span><span class="token punctuation">;</span>      proxy_set_header X-Forwarded-For <span class="token variable">$proxy_add_x_forwarded_for</span><span class="token punctuation">;</span>      proxy_set_header Host <span class="token variable">$http_host</span><span class="token punctuation">;</span>      proxy_set_header X-NginX-Proxy <span class="token boolean">true</span><span class="token punctuation">;</span>      proxy_redirect off<span class="token punctuation">;</span>      proxy_pass http://<span class="token punctuation">{</span><span class="token punctuation">{</span> proxy.name <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>      <span class="token keyword">break</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">{</span>% endfor %<span class="token punctuation">}</span><span class="token punctuation">{</span>% endif %<span class="token punctuation">}</span><span class="token punctuation">{</span>% <span class="token keyword">if</span> nginx_server_static %<span class="token punctuation">}</span>   location / <span class="token punctuation">{</span>       try_files <span class="token variable">$url</span> <span class="token variable">$url</span>/ <span class="token operator">=</span>404<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">{</span>% endif %<span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h4 id="4ã€ansibleå˜é‡æ–‡ä»¶"><a href="#4ã€ansibleå˜é‡æ–‡ä»¶" class="headerlink" title="4ã€ansibleå˜é‡æ–‡ä»¶"></a>4ã€ansibleå˜é‡æ–‡ä»¶</h4><pre class=" language-bash"><code class="language-bash"><span class="token function">cat</span> vars/main.yml nginx_server_name: www.testnginx.comnginx_web_root: /data/html/nginx_proxies:- name: suspicious  location: /  port: 1234- name: suspicious-api  location: /api  port: 4567</code></pre><h4 id="5ã€ansibleä¸»playbookæ–‡ä»¶"><a href="#5ã€ansibleä¸»playbookæ–‡ä»¶" class="headerlink" title="5ã€ansibleä¸»playbookæ–‡ä»¶"></a>5ã€ansibleä¸»playbookæ–‡ä»¶</h4><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#cat nginx_test.yml </span><span class="token comment" spellcheck="true">##The first roles</span>- name: Nginx Proxy Server<span class="token string">'s Config Dynamic Create  hosts: "10.0.90.25:10.0.90.26"  remote_user: root  vars:    nginx_use_proxy: true    nginx_ssl_cert_name: ifa.crt    nginx_ssl_cert_key: ifa.key    nginx_use_auth: true    project_name: suspicious    nginx_server_static: true  gather_facts: true  roles:     -  role: nginx_conf##The second roles- name: Nginx WebServer'</span>s Config Dynamic Create  hosts: 10.0.90.27  remote_user: root  vars:    nginx_use_proxy: <span class="token boolean">false</span>    nginx_ssl_cert_name: ifa.crt    nginx_ssl_cert_key: ifa.crt    nginx_use_auth: <span class="token boolean">false</span>    project_name: suspicious    nginx_server_static: <span class="token boolean">false</span>  gather_facts: <span class="token boolean">false</span>  roles:     -  role: nginx_conf</code></pre><h4 id="6ã€æµ‹è¯•å¹¶æ‰§è¡Œï¼š"><a href="#6ã€æµ‹è¯•å¹¶æ‰§è¡Œï¼š" class="headerlink" title="6ã€æµ‹è¯•å¹¶æ‰§è¡Œï¼š"></a>6ã€æµ‹è¯•å¹¶æ‰§è¡Œï¼š</h4><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#ansible-playbook nginx_test.yml --syntax-check</span>playbook: nginx_test.ymlæ‰§è¡Œï¼š<span class="token comment" spellcheck="true"># ansible-playbook nginx_test.yml</span>PLAY <span class="token punctuation">[</span>Nginx Proxy Server<span class="token string">'s Config Dynamic Create] ******************************TASK [setup] *******************************************************************ok: [10.0.90.25]ok: [10.0.90.26]TASK [nginx_conf : include] ****************************************************included: /etc/ansible/roles/nginx_conf/tasks/file.yml for 10.0.90.25, 10.0.90.26TASK [nginx_conf : nginx.j2 template transfer example] *************************changed: [10.0.90.26]changed: [10.0.90.25]PLAY [Nginx WebServer'</span>s Config Dynamic Create<span class="token punctuation">]</span> *********************************TASK <span class="token punctuation">[</span>nginx_conf <span class="token keyword">:</span> include<span class="token punctuation">]</span> ****************************************************included: /etc/ansible/roles/nginx_conf/tasks/file.yml <span class="token keyword">for</span> 10.0.90.27TASK <span class="token punctuation">[</span>nginx_conf <span class="token keyword">:</span> nginx.j2 template transfer example<span class="token punctuation">]</span> *************************changed: <span class="token punctuation">[</span>10.0.90.27<span class="token punctuation">]</span>PLAY RECAP *********************************************************************10.0.90.25                 <span class="token keyword">:</span> ok<span class="token operator">=</span>3    changed<span class="token operator">=</span>1    unreachable<span class="token operator">=</span>0    failed<span class="token operator">=</span>0   10.0.90.26                 <span class="token keyword">:</span> ok<span class="token operator">=</span>3    changed<span class="token operator">=</span>1    unreachable<span class="token operator">=</span>0    failed<span class="token operator">=</span>0   10.0.90.27                 <span class="token keyword">:</span> ok<span class="token operator">=</span>2    changed<span class="token operator">=</span>1    unreachable<span class="token operator">=</span>0    failed<span class="token operator">=</span>0</code></pre><h4 id="7ã€æŸ¥çœ‹æ£€æµ‹æ‰§è¡Œç»“æœ"><a href="#7ã€æŸ¥çœ‹æ£€æµ‹æ‰§è¡Œç»“æœ" class="headerlink" title="7ã€æŸ¥çœ‹æ£€æµ‹æ‰§è¡Œç»“æœ"></a>7ã€æŸ¥çœ‹æ£€æµ‹æ‰§è¡Œç»“æœ</h4><p>åˆ°Nginx Proxy æœåŠ¡å™¨æŸ¥çœ‹é…ç½®æ–‡ä»¶</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#cat nginx.conf.template </span>upstream suspicious   <span class="token comment" spellcheck="true">#server 127.0.0.1:1234;</span>   server 10.0.90.26:1234<span class="token punctuation">;</span><span class="token punctuation">}</span>upstream suspicious-api   <span class="token comment" spellcheck="true">#server 127.0.0.1:4567;</span>   server 10.0.90.26:4567<span class="token punctuation">;</span><span class="token punctuation">}</span>server <span class="token punctuation">{</span>    listen 80<span class="token punctuation">;</span>    servername www.testnginx.com<span class="token punctuation">;</span>    access_log off<span class="token punctuation">;</span>    error_log /etc/nginx/nginx_error.log<span class="token punctuation">;</span>    rewrite ^ https://<span class="token variable">$server_name</span><span class="token variable">$request_uri?</span> permanent<span class="token punctuation">;</span><span class="token punctuation">}</span>server <span class="token punctuation">{</span>    listen 443 ssl<span class="token punctuation">;</span>    server_name www.testnginx.com<span class="token punctuation">;</span>    ssl_certificate /etc/nginx/ssl/ifa.crt<span class="token punctuation">;</span>    ssl_certificate_key /etc/nginx/ssl/ifa.key<span class="token punctuation">;</span>    root /data/html/<span class="token punctuation">;</span>    index index.html index.html<span class="token punctuation">;</span>   auth_basic  <span class="token string">"Restricted"</span><span class="token punctuation">;</span>   auth_basic_user_file /etc/nginx/suspicious.htpasswd<span class="token punctuation">;</span>   location / <span class="token punctuation">{</span>      proxy_set_header X-Real-IP <span class="token variable">$remote_addr</span><span class="token punctuation">;</span>      proxy_set_header X-Forwarded-Proto http<span class="token punctuation">;</span>      proxy_set_header X-Url-Scheme <span class="token variable">$scheme</span><span class="token punctuation">;</span>      proxy_set_header X-Forwarded-For <span class="token variable">$proxy_add_x_forwarded_for</span><span class="token punctuation">;</span>      proxy_set_header Host <span class="token variable">$http_host</span><span class="token punctuation">;</span>      proxy_set_header X-NginX-Proxy <span class="token boolean">true</span><span class="token punctuation">;</span>      proxy_redirect off<span class="token punctuation">;</span>      proxy_pass http://suspicious<span class="token punctuation">;</span>      <span class="token keyword">break</span><span class="token punctuation">;</span><span class="token punctuation">}</span>   location /api <span class="token punctuation">{</span>      proxy_set_header X-Real-IP <span class="token variable">$remote_addr</span><span class="token punctuation">;</span>      proxy_set_header X-Forwarded-Proto http<span class="token punctuation">;</span>      proxy_set_header X-Url-Scheme <span class="token variable">$scheme</span><span class="token punctuation">;</span>      proxy_set_header X-Forwarded-For <span class="token variable">$proxy_add_x_forwarded_for</span><span class="token punctuation">;</span>      proxy_set_header Host <span class="token variable">$http_host</span><span class="token punctuation">;</span>      proxy_set_header X-NginX-Proxy <span class="token boolean">true</span><span class="token punctuation">;</span>      proxy_redirect off<span class="token punctuation">;</span>      proxy_pass http://suspicious-api<span class="token punctuation">;</span>      <span class="token keyword">break</span><span class="token punctuation">;</span><span class="token punctuation">}</span>   location / <span class="token punctuation">{</span>       try_files <span class="token variable">$url</span> <span class="token variable">$url</span>/ <span class="token operator">=</span>404<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>åˆ°Nginx Web æœåŠ¡å™¨ä¸ŠæŸ¥çœ‹é…ç½®æ–‡ä»¶</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#cat nginx.conf.template </span>server <span class="token punctuation">{</span>    listen 80<span class="token punctuation">;</span>    servername www.testnginx.com<span class="token punctuation">;</span>    access_log off<span class="token punctuation">;</span>    error_log /etc/nginx/nginx_error.log<span class="token punctuation">;</span>    rewrite ^ https://<span class="token variable">$server_name</span><span class="token variable">$request_uri?</span> permanent<span class="token punctuation">;</span><span class="token punctuation">}</span>server <span class="token punctuation">{</span>    listen 443 ssl<span class="token punctuation">;</span>    server_name www.testnginx.com<span class="token punctuation">;</span>    ssl_certificate /etc/nginx/ssl/ifa.crt<span class="token punctuation">;</span>    ssl_certificate_key /etc/nginx/ssl/ifa.crt<span class="token punctuation">;</span>    root /data/html/<span class="token punctuation">;</span>    index index.html index.html<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>åˆ°è¿™é‡Œï¼Œå°±ç»“æŸäº†ã€‚ç”¨åŒæ ·çš„æ¨¡æ¿é€šè¿‡ç®€å•çš„ifå’Œå˜é‡è®¾ç½®å°±å¯ä»¥å®Œæˆä¸åŒç±»å‹ä¸»æœºçš„Nginx confé…ç½®ï¼Œæ‰€ä»¥ä¸€æ–¹é¢åœ¨äº†è§£Ansibleå¼ºå¤§çš„æ¨¡æ¿åŠŸèƒ½çš„åŒæ—¶ï¼Œä¹Ÿéœ€è¦çœ‹åˆ°æ¨¡æ¿è´¨é‡çš„é‡è¦æ€§ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Tools </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Ansible </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RabbitMQæ¶ˆæ¯ä¸­é—´ä»¶</title>
      <link href="2019/04/16/sql/rabbitmq-xiao-xi-zhong-jian-jian/"/>
      <url>2019/04/16/sql/rabbitmq-xiao-xi-zhong-jian-jian/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h2 id="RabbitMQ-æ¶ˆæ¯ä¸­é—´ä»¶"><a href="#RabbitMQ-æ¶ˆæ¯ä¸­é—´ä»¶" class="headerlink" title="RabbitMQ æ¶ˆæ¯ä¸­é—´ä»¶"></a>RabbitMQ æ¶ˆæ¯ä¸­é—´ä»¶</h2><h3 id="1ã€æ¶ˆæ¯ä¸­é—´ä»¶"><a href="#1ã€æ¶ˆæ¯ä¸­é—´ä»¶" class="headerlink" title="1ã€æ¶ˆæ¯ä¸­é—´ä»¶"></a>1ã€æ¶ˆæ¯ä¸­é—´ä»¶</h3><h4 id="1ã€ç®€ä»‹"><a href="#1ã€ç®€ä»‹" class="headerlink" title="1ã€ç®€ä»‹"></a>1ã€ç®€ä»‹</h4><p>æ¶ˆæ¯ä¸­é—´ä»¶ä¹Ÿå¯ä»¥ç§°æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ˜¯æŒ‡ç”¨é«˜æ•ˆå¯é çš„æ¶ˆæ¯ä¼ é€’æœºåˆ¶è¿›è¡Œä¸å¹³å°æ— å…³çš„æ•°æ®äº¤æµï¼Œå¹¶åŸºäºæ•°æ®é€šä¿¡æ¥è¿›è¡Œåˆ†å¸ƒå¼ç³»ç»Ÿçš„é›†æˆã€‚é€šè¿‡æä¾›æ¶ˆæ¯ä¼ é€’å’Œæ¶ˆæ¯é˜Ÿåˆ—æ¨¡å‹ï¼Œå¯ä»¥åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸‹æ‰©å±•è¿›ç¨‹çš„é€šä¿¡ã€‚</p><p>å½“ä¸‹ä¸»æµçš„æ¶ˆæ¯ä¸­é—´ä»¶æœ‰RabbitMQã€Kafkaã€ActiveMQã€RocketMQç­‰ã€‚å…¶èƒ½åœ¨ä¸åŒå¹³å°ä¹‹é—´è¿›è¡Œé€šä¿¡ï¼Œå¸¸ç”¨æ¥å±è”½å„ç§å¹³å°åè®®ä¹‹é—´çš„ç‰¹æ€§ï¼Œå®ç°åº”ç”¨ç¨‹åºä¹‹é—´çš„ååŒã€‚ä¼˜ç‚¹åœ¨äºèƒ½å¤Ÿåœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´è¿›è¡ŒåŒæ­¥å’Œå¼‚æ­¥çš„è¿æ¥ï¼Œå¹¶ä¸”åœ¨ä»»ä½•æ—¶åˆ»éƒ½å¯ä»¥å°†æ¶ˆæ¯è¿›è¡Œä¼ é€å’Œè½¬å‘ï¼Œæ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿä¸­éå¸¸é‡è¦çš„ç»„ä»¶ï¼Œä¸»è¦ç”¨æ¥è§£å†³åº”ç”¨è€¦åˆã€å¼‚æ­¥é€šä¿¡ã€æµé‡å‰Šå³°ç­‰é—®é¢˜ã€‚ </p><h4 id="2ã€ä½œç”¨"><a href="#2ã€ä½œç”¨" class="headerlink" title="2ã€ä½œç”¨"></a>2ã€ä½œç”¨</h4><h5 id="1ã€æ¶ˆæ¯ä¸­é—´ä»¶ä¸»è¦ä½œç”¨"><a href="#1ã€æ¶ˆæ¯ä¸­é—´ä»¶ä¸»è¦ä½œç”¨" class="headerlink" title="1ã€æ¶ˆæ¯ä¸­é—´ä»¶ä¸»è¦ä½œç”¨"></a>1ã€æ¶ˆæ¯ä¸­é—´ä»¶ä¸»è¦ä½œç”¨</h5><ul><li>è§£è€¦</li><li>å†—ä½™(å­˜å‚¨)</li><li>æ‰©å±•æ€§</li><li>å‰Šå³°</li><li>å¯æ¢å¤æ€§</li><li>é¡ºåºä¿è¯</li><li>ç¼“å†²</li><li>å¼‚æ­¥é€šä¿¡</li></ul><h5 id="2ã€æ¶ˆæ¯ä¸­é—´ä»¶çš„ä¸¤ç§æ¨¡å¼"><a href="#2ã€æ¶ˆæ¯ä¸­é—´ä»¶çš„ä¸¤ç§æ¨¡å¼" class="headerlink" title="2ã€æ¶ˆæ¯ä¸­é—´ä»¶çš„ä¸¤ç§æ¨¡å¼"></a>2ã€æ¶ˆæ¯ä¸­é—´ä»¶çš„ä¸¤ç§æ¨¡å¼</h5><h6 id="1ã€P2Pæ¨¡å¼"><a href="#1ã€P2Pæ¨¡å¼" class="headerlink" title="1ã€P2Pæ¨¡å¼"></a>1ã€P2Pæ¨¡å¼</h6><p>P2Pæ¨¡å¼åŒ…å«ä¸‰ä¸ªè§’è‰²ï¼šæ¶ˆæ¯é˜Ÿåˆ—ï¼ˆQueueï¼‰ã€å‘é€è€…(Sender)ã€æ¥æ”¶è€…(Receiver)ã€‚æ¯ä¸ªæ¶ˆæ¯éƒ½è¢«å‘é€åˆ°ä¸€ä¸ªç‰¹å®šçš„é˜Ÿåˆ—ï¼Œæ¥æ”¶è€…ä»é˜Ÿåˆ—ä¸­è·å–æ¶ˆæ¯ã€‚é˜Ÿåˆ—ä¿ç•™ç€æ¶ˆæ¯ï¼Œç›´åˆ°å®ƒä»¬è¢«æ¶ˆè´¹æˆ–è¶…æ—¶ã€‚</p><p><strong>P2Pçš„ç‰¹ç‚¹ï¼š</strong></p><ul><li>æ¯ä¸ªæ¶ˆæ¯åªæœ‰ä¸€ä¸ªæ¶ˆè´¹è€…ï¼ˆConsumerï¼‰ï¼Œå³ä¸€æ—¦è¢«æ¶ˆè´¹ï¼Œæ¶ˆæ¯å°±ä¸å†åœ¨æ¶ˆæ¯é˜Ÿåˆ—ä¸­</li><li>å‘é€è€…å’Œæ¥æ”¶è€…ä¹‹é—´åœ¨æ—¶é—´ä¸Šæ²¡æœ‰ä¾èµ–æ€§ï¼Œä¹Ÿå°±æ˜¯è¯´å½“å‘é€è€…å‘é€äº†æ¶ˆæ¯ä¹‹åï¼Œä¸ç®¡æ¥æ”¶è€…æœ‰æ²¡æœ‰æ­£åœ¨è¿è¡Œå®ƒä¸ä¼šå½±å“åˆ°æ¶ˆæ¯è¢«å‘é€åˆ°é˜Ÿåˆ—</li><li>æ¥æ”¶è€…åœ¨æˆåŠŸæ¥æ”¶æ¶ˆæ¯ä¹‹åéœ€å‘é˜Ÿåˆ—åº”ç­”æˆåŠŸ</li><li>å¦‚æœå¸Œæœ›å‘é€çš„æ¯ä¸ªæ¶ˆæ¯éƒ½ä¼šè¢«æˆåŠŸå¤„ç†çš„è¯ï¼Œé‚£ä¹ˆéœ€è¦P2Pæ¨¡ </li></ul><h6 id="2ã€Pub-Subæ¨¡å¼"><a href="#2ã€Pub-Subæ¨¡å¼" class="headerlink" title="2ã€Pub/Subæ¨¡å¼"></a>2ã€Pub/Subæ¨¡å¼</h6><p>Pub/Subæ¨¡å¼åŒ…å«ä¸‰ä¸ªè§’è‰²ï¼šä¸»é¢˜ï¼ˆTopicï¼‰ã€å‘å¸ƒè€…ï¼ˆPublisherï¼‰ã€è®¢é˜…è€…ï¼ˆSubscriberï¼‰ ã€‚å¤šä¸ªå‘å¸ƒè€…å°†æ¶ˆæ¯å‘é€åˆ°Topicï¼Œç³»ç»Ÿå°†è¿™äº›æ¶ˆæ¯ä¼ é€’ç»™å¤šä¸ªè®¢é˜…è€…ã€‚</p><p><strong>Pub/Subçš„ç‰¹ç‚¹ï¼š</strong></p><ul><li>æ¯ä¸ªæ¶ˆæ¯å¯ä»¥æœ‰å¤šä¸ªæ¶ˆè´¹è€…</li><li>å‘å¸ƒè€…å’Œè®¢é˜…è€…ä¹‹é—´æœ‰æ—¶é—´ä¸Šçš„ä¾èµ–æ€§ã€‚é’ˆå¯¹æŸä¸ªä¸»é¢˜ï¼ˆTopicï¼‰çš„è®¢é˜…è€…ï¼Œå®ƒå¿…é¡»åˆ›å»ºä¸€ä¸ªè®¢é˜…è€…ä¹‹åï¼Œæ‰èƒ½æ¶ˆè´¹å‘å¸ƒè€…çš„æ¶ˆæ¯</li><li>ä¸ºäº†æ¶ˆè´¹æ¶ˆæ¯ï¼Œè®¢é˜…è€…å¿…é¡»ä¿æŒè¿è¡Œçš„çŠ¶æ€</li><li>å¦‚æœå¸Œæœ›å‘é€çš„æ¶ˆæ¯å¯ä»¥ä¸è¢«åšä»»ä½•å¤„ç†ã€æˆ–è€…åªè¢«ä¸€ä¸ªæ¶ˆæ¯è€…å¤„ç†ã€æˆ–è€…å¯ä»¥è¢«å¤šä¸ªæ¶ˆè´¹è€…å¤„ç†çš„è¯ï¼Œé‚£ä¹ˆå¯ä»¥é‡‡ç”¨Pub/Subæ¨¡å‹</li></ul><h5 id="3ã€å¸¸ç”¨ä¸­é—´ä»¶ä»‹ç»ä¸å¯¹æ¯”"><a href="#3ã€å¸¸ç”¨ä¸­é—´ä»¶ä»‹ç»ä¸å¯¹æ¯”" class="headerlink" title="3ã€å¸¸ç”¨ä¸­é—´ä»¶ä»‹ç»ä¸å¯¹æ¯”"></a>3ã€å¸¸ç”¨ä¸­é—´ä»¶ä»‹ç»ä¸å¯¹æ¯”</h5><h6 id="1ã€Kafka"><a href="#1ã€Kafka" class="headerlink" title="1ã€Kafka"></a>1ã€Kafka</h6><p>Kafkaæ˜¯LinkedInå¼€æºçš„åˆ†å¸ƒå¼å‘å¸ƒ-è®¢é˜…æ¶ˆæ¯ç³»ç»Ÿï¼Œç›®å‰å½’å±äºApacheé¡¶çº§é¡¹ç›®ã€‚Kafkaä¸»è¦ç‰¹ç‚¹æ˜¯åŸºäºPullçš„æ¨¡å¼æ¥å¤„ç†æ¶ˆæ¯æ¶ˆè´¹ï¼Œè¿½æ±‚é«˜ååé‡ï¼Œä¸€å¼€å§‹çš„ç›®çš„å°±æ˜¯ç”¨äºæ—¥å¿—æ”¶é›†å’Œä¼ è¾“ã€‚0.8ç‰ˆæœ¬å¼€å§‹æ”¯æŒå¤åˆ¶ï¼Œä¸æ”¯æŒäº‹åŠ¡ï¼Œå¯¹æ¶ˆæ¯çš„é‡å¤ã€ä¸¢å¤±ã€é”™è¯¯æ²¡æœ‰ä¸¥æ ¼è¦æ±‚ï¼Œé€‚åˆäº§ç”Ÿå¤§é‡æ•°æ®çš„äº’è”ç½‘æœåŠ¡çš„æ•°æ®æ”¶é›†ä¸šåŠ¡ã€‚</p><h6 id="2ã€RabbitMQ"><a href="#2ã€RabbitMQ" class="headerlink" title="2ã€RabbitMQ"></a>2ã€RabbitMQ</h6><p>RabbitMQæ˜¯ä½¿ç”¨Erlangè¯­è¨€å¼€å‘çš„å¼€æºæ¶ˆæ¯é˜Ÿåˆ—ç³»ç»Ÿï¼ŒåŸºäºAMQPåè®®æ¥å®ç°ã€‚AMQPçš„ä¸»è¦ç‰¹å¾æ˜¯é¢å‘æ¶ˆæ¯ã€é˜Ÿåˆ—ã€è·¯ç”±ï¼ˆåŒ…æ‹¬ç‚¹å¯¹ç‚¹å’Œå‘å¸ƒ/è®¢é˜…ï¼‰ã€å¯é æ€§ã€å®‰å…¨ã€‚AMQPåè®®æ›´å¤šç”¨åœ¨ä¼ä¸šç³»ç»Ÿå†…å¯¹æ•°æ®ä¸€è‡´æ€§ã€ç¨³å®šæ€§å’Œå¯é æ€§è¦æ±‚å¾ˆé«˜çš„åœºæ™¯ï¼Œå¯¹æ€§èƒ½å’Œååé‡çš„è¦æ±‚è¿˜åœ¨å…¶æ¬¡ã€‚</p><h6 id="3ã€RocketMQ"><a href="#3ã€RocketMQ" class="headerlink" title="3ã€RocketMQ"></a>3ã€RocketMQ</h6><p>RocketMQæ˜¯é˜¿é‡Œå¼€æºçš„æ¶ˆæ¯ä¸­é—´ä»¶ï¼Œå®ƒæ˜¯çº¯Javaå¼€å‘ï¼Œå…·æœ‰é«˜ååé‡ã€é«˜å¯ç”¨æ€§ã€é€‚åˆå¤§è§„æ¨¡åˆ†å¸ƒå¼ç³»ç»Ÿåº”ç”¨çš„ç‰¹ç‚¹ã€‚RocketMQæ€è·¯èµ·æºäºKafkaï¼Œä½†å¹¶ä¸æ˜¯Kafkaçš„ä¸€ä¸ªCopyï¼Œå®ƒå¯¹æ¶ˆæ¯çš„å¯é ä¼ è¾“åŠäº‹åŠ¡æ€§åšäº†ä¼˜åŒ–ï¼Œç›®å‰åœ¨é˜¿é‡Œé›†å›¢è¢«å¹¿æ³›åº”ç”¨äºäº¤æ˜“ã€å……å€¼ã€æµè®¡ç®—ã€æ¶ˆæ¯æ¨é€ã€æ—¥å¿—æµå¼å¤„ç†ã€binglogåˆ†å‘ç­‰åœºæ™¯ã€‚</p><p>RabbitMQæ¯”Kafkaå¯é ï¼ŒKafkaæ›´é€‚åˆIOé«˜ååçš„å¤„ç†ï¼Œä¸€èˆ¬åº”ç”¨åœ¨å¤§æ•°æ®æ—¥å¿—å¤„ç†æˆ–å¯¹å®æ—¶æ€§ï¼ˆå°‘é‡å»¶è¿Ÿï¼‰ï¼Œå¯é æ€§ï¼ˆå°‘é‡ä¸¢æ•°æ®ï¼‰è¦æ±‚ç¨ä½çš„åœºæ™¯ä½¿ç”¨ï¼Œæ¯”å¦‚ELKæ—¥å¿—æ”¶é›†ã€‚</p><h3 id="2ã€RabbitMQ-è¯¦è§£"><a href="#2ã€RabbitMQ-è¯¦è§£" class="headerlink" title="2ã€RabbitMQ è¯¦è§£"></a>2ã€RabbitMQ è¯¦è§£</h3><h4 id="1ã€RabbitMQ-ä»‹ç»"><a href="#1ã€RabbitMQ-ä»‹ç»" class="headerlink" title="1ã€RabbitMQ ä»‹ç»"></a>1ã€RabbitMQ ä»‹ç»</h4><p>RabbitMQæ˜¯ä¸€ä¸ªåœ¨AMQPï¼ˆAdvanced Message Queuing Protocol ï¼‰åŸºç¡€ä¸Šå®ç°çš„ï¼Œå¯å¤ç”¨çš„ä¼ä¸šæ¶ˆæ¯ç³»ç»Ÿã€‚å®ƒå¯ä»¥ç”¨äºå¤§å‹è½¯ä»¶ç³»ç»Ÿå„ä¸ªæ¨¡å—ä¹‹é—´çš„é«˜æ•ˆé€šä¿¡ï¼Œæ”¯æŒé«˜å¹¶å‘ï¼Œæ”¯æŒå¯æ‰©å±•ã€‚å®ƒæ”¯æŒå¤šç§å®¢æˆ·ç«¯å¦‚ï¼šPythonã€Rubyã€.NETã€Javaã€JMSã€Cã€PHPã€ActionScriptã€XMPPã€STOMPç­‰ï¼Œæ”¯æŒAJAXï¼ŒæŒä¹…åŒ–ï¼Œç”¨äºåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å­˜å‚¨è½¬å‘æ¶ˆæ¯ï¼Œåœ¨æ˜“ç”¨æ€§ã€æ‰©å±•æ€§ã€é«˜å¯ç”¨æ€§ç­‰æ–¹é¢è¡¨ç°ä¸ä¿—ã€‚</p><p>RabbitMQæ˜¯ä½¿ç”¨Erlangç¼–å†™çš„ä¸€ä¸ªå¼€æºçš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæœ¬èº«æ”¯æŒå¾ˆå¤šçš„åè®®ï¼šAMQPï¼ŒXMPP, SMTP, STOMPï¼Œä¹Ÿæ­£æ˜¯å¦‚æ­¤ï¼Œä½¿çš„å®ƒå˜çš„éå¸¸é‡é‡çº§ï¼Œæ›´é€‚åˆäºä¼ä¸šçº§çš„å¼€å‘ã€‚å®ƒåŒæ—¶å®ç°äº†ä¸€ä¸ªBrokeræ„æ¶ï¼Œè¿™æ„å‘³ç€æ¶ˆæ¯åœ¨å‘é€ç»™å®¢æˆ·ç«¯æ—¶å…ˆåœ¨ä¸­å¿ƒé˜Ÿåˆ—æ’é˜Ÿï¼Œå¯¹è·¯ç”±(Routing)ã€è´Ÿè½½å‡è¡¡(Load balance)æˆ–è€…æ•°æ®æŒä¹…åŒ–éƒ½æœ‰å¾ˆå¥½çš„æ”¯æŒã€‚</p><h4 id="2ã€RabbitMQ-ç‰¹ç‚¹"><a href="#2ã€RabbitMQ-ç‰¹ç‚¹" class="headerlink" title="2ã€RabbitMQ ç‰¹ç‚¹"></a>2ã€RabbitMQ ç‰¹ç‚¹</h4><ul><li>å¯é æ€§</li><li>çµæ´»çš„è·¯ç”±</li><li>æ‰©å±•æ€§</li><li>é«˜å¯ç”¨æ€§</li><li>å¤šç§åè®®</li><li>å¤šè¯­è¨€å®¢æˆ·ç«¯</li><li>ç®¡ç†ç•Œé¢</li><li>æ’ä»¶æœºåˆ¶</li></ul><h4 id="3ã€AMQP-ä»‹ç»"><a href="#3ã€AMQP-ä»‹ç»" class="headerlink" title="3ã€AMQP ä»‹ç»"></a>3ã€AMQP ä»‹ç»</h4><p>AMQPï¼Œå³Advanced Message Queuing Protocol,ä¸€ä¸ªæä¾›ç»Ÿä¸€æ¶ˆæ¯æœåŠ¡çš„åº”ç”¨å±‚æ ‡å‡†<strong>é«˜çº§æ¶ˆæ¯é˜Ÿåˆ—åè®®</strong>,æ˜¯åº”ç”¨å±‚åè®®çš„ä¸€ä¸ªå¼€æ”¾æ ‡å‡†,ä¸ºé¢å‘æ¶ˆæ¯çš„ä¸­é—´ä»¶è®¾è®¡ã€‚åŸºäºæ­¤åè®®çš„å®¢æˆ·ç«¯ä¸æ¶ˆæ¯ä¸­é—´ä»¶å¯ä¼ é€’æ¶ˆæ¯ï¼Œå¹¶ä¸å—å®¢æˆ·ç«¯/ä¸­é—´ä»¶ä¸åŒäº§å“ï¼Œä¸åŒçš„å¼€å‘è¯­è¨€ç­‰æ¡ä»¶çš„é™åˆ¶ã€‚</p><h4 id="4ã€ä»€ä¹ˆå’Œæ˜¯æ¶ˆæ¯é˜Ÿåˆ—"><a href="#4ã€ä»€ä¹ˆå’Œæ˜¯æ¶ˆæ¯é˜Ÿåˆ—" class="headerlink" title="4ã€ä»€ä¹ˆå’Œæ˜¯æ¶ˆæ¯é˜Ÿåˆ—"></a>4ã€ä»€ä¹ˆå’Œæ˜¯æ¶ˆæ¯é˜Ÿåˆ—</h4><p>MQ å…¨ç§°ä¸ºMessage Queue, æ¶ˆæ¯é˜Ÿåˆ—ã€‚æ˜¯ä¸€ç§åº”ç”¨ç¨‹åºå¯¹åº”ç”¨ç¨‹åºçš„é€šä¿¡æ–¹æ³•ã€‚åº”ç”¨ç¨‹åºé€šè¿‡è¯»å†™å‡ºå…¥é˜Ÿåˆ—çš„æ¶ˆæ¯ï¼ˆé’ˆå¯¹åº”ç”¨ç¨‹åºçš„æ•°æ®ï¼‰æ¥é€šä¿¡ï¼Œè€Œæ— éœ€ä¸“ç”¨è¿æ¥æ¥é“¾æ¥å®ƒä»¬ã€‚</p><p><strong>æ¶ˆæ¯ä¼ é€’</strong>æŒ‡çš„æ˜¯ç¨‹åºä¹‹é—´é€šè¿‡åœ¨æ¶ˆæ¯ä¸­å‘é€æ•°æ®è¿›è¡Œé€šä¿¡ï¼Œè€Œä¸æ˜¯é€šè¿‡ç›´æ¥è°ƒç”¨å½¼æ­¤æ¥é€šä¿¡ã€‚é˜Ÿåˆ—çš„ä½¿ç”¨é™¤å»äº†æ¥æ”¶å’Œå‘é€åº”ç”¨ç¨‹åºåŒæ—¶æ‰§è¡Œçš„è¦æ±‚ã€‚</p><p>åœ¨é¡¹ç›®ä¸­ï¼Œå°†ä¸€äº›æ— éœ€å³æ—¶è¿”å›ä¸”è€—æ—¶çš„æ“ä½œæå–å‡ºæ¥ï¼Œè¿›è¡Œäº†å¼‚æ­¥å¤„ç†ï¼Œè€Œè¿™ç§å¼‚æ­¥å¤„ç†çš„æ–¹å¼å¤§å¤§çš„èŠ‚çœäº†æœåŠ¡å™¨çš„è¯·æ±‚å“åº”æ—¶é—´ï¼Œä»è€Œæé«˜äº†ç³»ç»Ÿçš„ååé‡ã€‚</p><p>æ¶ˆæ¯é˜Ÿåˆ—çš„ä½¿ç”¨åœºæ™¯æ˜¯æ€æ ·çš„ï¼Ÿ</p><h4 id="5ã€RabbitMQ-åº”ç”¨åœºæ™¯"><a href="#5ã€RabbitMQ-åº”ç”¨åœºæ™¯" class="headerlink" title="5ã€RabbitMQ åº”ç”¨åœºæ™¯"></a>5ã€RabbitMQ åº”ç”¨åœºæ™¯</h4><p>å¯¹äºä¸€ä¸ªå¤§å‹çš„è½¯ä»¶ç³»ç»Ÿæ¥è¯´ï¼Œå®ƒä¼šæœ‰å¾ˆå¤šçš„ç»„ä»¶æˆ–è€…è¯´æ¨¡å—æˆ–è€…è¯´å­ç³»ç»Ÿæˆ–è€…ï¼ˆsubsystem or Component or submoduleï¼‰ã€‚é‚£ä¹ˆè¿™äº›æ¨¡å—çš„å¦‚ä½•é€šä¿¡ï¼Ÿè¿™å’Œä¼ ç»Ÿçš„IPCæœ‰å¾ˆå¤§çš„åŒºåˆ«ã€‚ä¼ ç»Ÿçš„IPCå¾ˆå¤šéƒ½æ˜¯åœ¨å•ä¸€ç³»ç»Ÿä¸Šçš„ï¼Œæ¨¡å—è€¦åˆæ€§å¾ˆå¤§ï¼Œä¸é€‚åˆæ‰©å±•ï¼ˆScalabilityï¼‰ï¼›å¦‚æœä½¿ç”¨socketé‚£ä¹ˆä¸åŒçš„æ¨¡å—çš„ç¡®å¯ä»¥éƒ¨ç½²åˆ°ä¸åŒçš„æœºå™¨ä¸Šï¼Œä½†æ˜¯è¿˜æ˜¯æœ‰å¾ˆå¤šé—®é¢˜éœ€è¦è§£å†³ã€‚æ¯”å¦‚ï¼š<br>1ï¼‰ä¿¡æ¯çš„å‘é€è€…å’Œæ¥æ”¶è€…å¦‚ä½•ç»´æŒè¿™ä¸ªè¿æ¥ï¼Œå¦‚æœä¸€æ–¹çš„è¿æ¥ä¸­æ–­ï¼Œè¿™æœŸé—´çš„æ•°æ®å¦‚ä½•é˜²æ­¢ä¸¢å¤±ï¼Ÿ<br>2ï¼‰å¦‚ä½•é™ä½å‘é€è€…å’Œæ¥æ”¶è€…çš„è€¦åˆåº¦ï¼Ÿ<br>3ï¼‰å¦‚ä½•è®©Priorityé«˜çš„æ¥æ”¶è€…å…ˆæ¥åˆ°æ•°æ®ï¼Ÿ<br>4ï¼‰å¦‚ä½•åšåˆ°load balanceï¼Ÿæœ‰æ•ˆå‡è¡¡æ¥æ”¶è€…çš„è´Ÿè½½ï¼Ÿ<br>5ï¼‰å¦‚ä½•æœ‰æ•ˆçš„å°†æ•°æ®å‘é€åˆ°ç›¸å…³çš„æ¥æ”¶è€…ï¼Ÿä¹Ÿå°±æ˜¯è¯´å°†æ¥æ”¶è€…subscribe ä¸åŒçš„æ•°æ®ï¼Œå¦‚ä½•åšæœ‰æ•ˆçš„filterã€‚<br>6ï¼‰å¦‚ä½•åšåˆ°å¯æ‰©å±•ï¼Œç”šè‡³å°†è¿™ä¸ªé€šä¿¡æ¨¡å—å‘åˆ°clusterä¸Šï¼Ÿ<br>7ï¼‰å¦‚ä½•ä¿è¯æ¥æ”¶è€…æ¥æ”¶åˆ°äº†å®Œæ•´ï¼Œæ­£ç¡®çš„æ•°æ®ï¼Ÿ<br><strong>AMDQ</strong>åè®®è§£å†³äº†ä»¥ä¸Šçš„é—®é¢˜ï¼Œè€ŒRabbitMQå®ç°äº†<strong>AMQP</strong>ã€‚</p><h4 id="6ã€RabbitMQ-æ¦‚å¿µä»‹ç»"><a href="#6ã€RabbitMQ-æ¦‚å¿µä»‹ç»" class="headerlink" title="6ã€RabbitMQ æ¦‚å¿µä»‹ç»"></a>6ã€RabbitMQ æ¦‚å¿µä»‹ç»</h4><ul><li><strong>Broker</strong>ï¼šç®€å•æ¥è¯´å°±æ˜¯æ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡å™¨å®ä½“ã€‚</li><li><strong>Exchange</strong>ï¼šæ¶ˆæ¯äº¤æ¢æœºï¼Œå®ƒæŒ‡å®šæ¶ˆæ¯æŒ‰ä»€ä¹ˆè§„åˆ™ï¼Œè·¯ç”±åˆ°å“ªä¸ªé˜Ÿåˆ—ã€‚</li><li><strong>Queue</strong>ï¼šæ¶ˆæ¯é˜Ÿåˆ—è½½ä½“ï¼Œæ¯ä¸ªæ¶ˆæ¯éƒ½ä¼šè¢«æŠ•å…¥åˆ°ä¸€ä¸ªæˆ–å¤šä¸ªé˜Ÿåˆ—ã€‚</li><li><strong>Binding</strong>ï¼šç»‘å®šï¼Œå®ƒçš„ä½œç”¨å°±æ˜¯æŠŠexchangeå’ŒqueueæŒ‰ç…§è·¯ç”±è§„åˆ™ç»‘å®šèµ·æ¥ã€‚</li><li><strong>Routing Key</strong>ï¼šè·¯ç”±å…³é”®å­—ï¼Œexchangeæ ¹æ®è¿™ä¸ªå…³é”®å­—è¿›è¡Œæ¶ˆæ¯æŠ•é€’ã€‚</li><li><strong>vhost</strong>ï¼šè™šæ‹Ÿä¸»æœºï¼Œä¸€ä¸ªbrokeré‡Œå¯ä»¥å¼€è®¾å¤šä¸ªvhostï¼Œç”¨ä½œä¸åŒç”¨æˆ·çš„æƒé™åˆ†ç¦»ã€‚</li><li><strong>producer</strong>ï¼šæ¶ˆæ¯ç”Ÿäº§è€…ï¼Œå°±æ˜¯æŠ•é€’æ¶ˆæ¯çš„ç¨‹åºã€‚</li><li><strong>consumer</strong>ï¼šæ¶ˆæ¯æ¶ˆè´¹è€…ï¼Œå°±æ˜¯æ¥å—æ¶ˆæ¯çš„ç¨‹åºã€‚</li><li><strong>channel</strong>ï¼šæ¶ˆæ¯é€šé“ï¼Œåœ¨å®¢æˆ·ç«¯çš„æ¯ä¸ªè¿æ¥é‡Œï¼Œå¯å»ºç«‹å¤šä¸ªchannelï¼Œæ¯ä¸ªchannelä»£è¡¨ä¸€ä¸ªä¼šè¯ä»»åŠ¡ã€‚</li></ul><p>RabbitMQä»æ•´ä½“ä¸Šæ¥çœ‹æ˜¯ä¸€ä¸ªå…¸å‹çš„ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹ï¼Œä¸»è¦è´Ÿè´£æ¥æ”¶ã€å­˜å‚¨å’Œè½¬å‘æ¶ˆæ¯</p><p><img src="https://s1.ax1x.com/2020/04/26/JRegrq.png" alt="JRegrq.png"></p><h4 id="7ã€RabbitMQ-ä½¿ç”¨æµç¨‹"><a href="#7ã€RabbitMQ-ä½¿ç”¨æµç¨‹" class="headerlink" title="7ã€RabbitMQ ä½¿ç”¨æµç¨‹"></a>7ã€RabbitMQ ä½¿ç”¨æµç¨‹</h4><p>AMQPæ¨¡å‹ä¸­ï¼Œæ¶ˆæ¯åœ¨producerä¸­äº§ç”Ÿï¼Œå‘é€åˆ°MQçš„exchangeä¸Šï¼Œexchangeæ ¹æ®é…ç½®çš„è·¯ç”±æ–¹å¼å‘åˆ°ç›¸åº”çš„Queueä¸Šï¼ŒQueueåˆå°†æ¶ˆæ¯å‘é€ç»™consumerï¼Œæ¶ˆæ¯ä»queueåˆ°consumeræœ‰pushå’Œpullä¸¤ç§æ–¹å¼ã€‚ æ¶ˆæ¯é˜Ÿåˆ—çš„ä½¿ç”¨è¿‡ç¨‹å¤§æ¦‚å¦‚ä¸‹ï¼š</p><ol><li>å®¢æˆ·ç«¯è¿æ¥åˆ°æ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡å™¨ï¼Œæ‰“å¼€ä¸€ä¸ªchannelã€‚</li><li>å®¢æˆ·ç«¯å£°æ˜ä¸€ä¸ªexchangeï¼Œå¹¶è®¾ç½®ç›¸å…³å±æ€§ã€‚</li><li>å®¢æˆ·ç«¯å£°æ˜ä¸€ä¸ªqueueï¼Œå¹¶è®¾ç½®ç›¸å…³å±æ€§ã€‚</li><li>å®¢æˆ·ç«¯ä½¿ç”¨routing keyï¼Œåœ¨exchangeå’Œqueueä¹‹é—´å»ºç«‹å¥½ç»‘å®šå…³ç³»ã€‚</li><li>å®¢æˆ·ç«¯æŠ•é€’æ¶ˆæ¯åˆ°exchangeã€‚</li></ol><p>exchangeæ¥æ”¶åˆ°æ¶ˆæ¯åï¼Œå°±æ ¹æ®æ¶ˆæ¯çš„keyå’Œå·²ç»è®¾ç½®çš„bindingï¼Œè¿›è¡Œæ¶ˆæ¯è·¯ç”±ï¼Œå°†æ¶ˆæ¯æŠ•é€’åˆ°ä¸€ä¸ªæˆ–å¤šä¸ªé˜Ÿåˆ—é‡Œã€‚ exchangeä¹Ÿæœ‰å‡ ä¸ªç±»å‹ï¼Œå®Œå…¨æ ¹æ®keyè¿›è¡ŒæŠ•é€’çš„å«åšDirectäº¤æ¢æœºï¼Œä¾‹å¦‚ï¼Œç»‘å®šæ—¶è®¾ç½®äº†routing keyä¸ºâ€abcâ€ï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯æäº¤çš„æ¶ˆæ¯ï¼Œåªæœ‰è®¾ç½®äº†keyä¸ºâ€abcâ€çš„æ‰ä¼šæŠ•é€’åˆ°é˜Ÿåˆ—ã€‚</p><h3 id="3ã€RabbitMQ-å•æœºå®‰è£…éƒ¨ç½²"><a href="#3ã€RabbitMQ-å•æœºå®‰è£…éƒ¨ç½²" class="headerlink" title="3ã€RabbitMQ å•æœºå®‰è£…éƒ¨ç½²"></a>3ã€RabbitMQ å•æœºå®‰è£…éƒ¨ç½²</h3><h4 id="1ã€ä¸‹è½½"><a href="#1ã€ä¸‹è½½" class="headerlink" title="1ã€ä¸‹è½½"></a>1ã€ä¸‹è½½</h4><p>ä¸‹è½½åœ°å€ï¼š<a href="http://www.rabbitmq.com/download.html" target="_blank" rel="noopener">http://www.rabbitmq.com/download.html</a></p><h4 id="2ã€Windowsä¸Šå®‰è£…"><a href="#2ã€Windowsä¸Šå®‰è£…" class="headerlink" title="2ã€Windowsä¸Šå®‰è£…"></a>2ã€Windowsä¸Šå®‰è£…</h4><h6 id="1ã€å®‰è£…å®‰è£…Erlang"><a href="#1ã€å®‰è£…å®‰è£…Erlang" class="headerlink" title="1ã€å®‰è£…å®‰è£…Erlang"></a>1ã€å®‰è£…å®‰è£…Erlang</h6><p>ä¸‹è½½erlangï¼š<a href="http://www.erlang.org/download/otp_win64_17.3.exe" target="_blank" rel="noopener">http://www.erlang.org/download/otp_win64_17.3.exe</a></p><p>å®‰è£…ï¼š</p><p><img src="https://s1.ax1x.com/2020/04/26/JRe5iF.png" alt="JRe5iF.png"></p><p><img src="https://s1.ax1x.com/2020/04/26/JRmiLt.png" alt="JRmiLt.png"></p><p><img src="https://s1.ax1x.com/2020/04/26/JRmEo8.png" alt="JRmEo8.png"></p><p><img src="https://s1.ax1x.com/2020/04/26/JRmnzj.png" alt="JRmnzj.png"></p><p>erlangå®‰è£…å®Œæˆã€‚</p><h6 id="2ã€å®‰è£…å®‰è£…RabbitMQ"><a href="#2ã€å®‰è£…å®‰è£…RabbitMQ" class="headerlink" title="2ã€å®‰è£…å®‰è£…RabbitMQ"></a>2ã€å®‰è£…å®‰è£…RabbitMQ</h6><p><img src="https://s1.ax1x.com/2020/04/26/JRm1e0.png" alt="JRm1e0.png"></p><p><img src="https://s1.ax1x.com/2020/04/26/JRm8oT.png" alt="JRm8oT.png"></p><p>RabbitMQå®‰è£…å®Œæˆã€‚</p><p><img src="https://s1.ax1x.com/2020/04/26/JRmUSJ.png" alt="JRmUSJ.png"></p><p>å¯åŠ¨ã€åœæ­¢ã€é‡æ–°å®‰è£…ç­‰ã€‚</p><h6 id="3ã€å¯ç”¨ç®¡ç†å·¥å…·"><a href="#3ã€å¯ç”¨ç®¡ç†å·¥å…·" class="headerlink" title="3ã€å¯ç”¨ç®¡ç†å·¥å…·"></a>3ã€å¯ç”¨ç®¡ç†å·¥å…·</h6><p>ç¬¬ä¸€æ­¥ï¼šç‚¹å‡»æ‰“å¼€RabbitMQçš„å‘½ä»¤çª—å£ã€‚å¦‚å›¾ï¼š</p><p><img src="https://s1.ax1x.com/2020/04/26/JRmwO1.png" alt="JRmwO1.png"></p><p>ç¬¬äºŒæ­¥ï¼šè¾“å…¥å‘½ä»¤rabbitmq-plugins enable rabbitmq_management</p><p>è¿™ä¸ªå‘½ä»¤çš„æ„æ€æ˜¯å®‰è£…RabbitMQçš„æ’ä»¶ã€‚</p><p>ç¬¬ä¸‰æ­¥ï¼šæµ‹è¯•æ˜¯å¦å®‰è£…æˆåŠŸã€‚</p><p>æ–¹æ³•ï¼šè®¿é—®åœ°å€ï¼š<a href="http://127.0.0.1:15672/" target="_blank" rel="noopener">http://127.0.0.1:15672/</a></p><p><img src="https://s1.ax1x.com/2020/04/26/JRmDw6.png" alt="JRmDw6.png"></p><p>é»˜è®¤è´¦å·ï¼šguest/guest</p><h4 id="3ã€Linuxä¸Šå®‰è£…"><a href="#3ã€Linuxä¸Šå®‰è£…" class="headerlink" title="3ã€Linuxä¸Šå®‰è£…"></a>3ã€Linuxä¸Šå®‰è£…</h4><h6 id="1ã€å®‰è£…-erlang"><a href="#1ã€å®‰è£…-erlang" class="headerlink" title="1ã€å®‰è£… erlang"></a>1ã€å®‰è£… erlang</h6><p>æ·»åŠ yumæ”¯æŒ</p><pre><code>cd /usr/local/src/mkdir rabbitmqcd rabbitmqwget http://packages.erlang-solutions.com/erlang-solutions-1.0-1.noarch.rpmrpm -ivh erlang-solutions-1.0-1.noarch.rpmrpm --import http://packages.erlang-solutions.com/rpm/erlang_solutions.ascyum install erlang</code></pre><h6 id="2ã€å®‰è£…RabbitMQ"><a href="#2ã€å®‰è£…RabbitMQ" class="headerlink" title="2ã€å®‰è£…RabbitMQ"></a>2ã€å®‰è£…RabbitMQ</h6><p>1ã€ç”¨ yum å®‰è£… RabbitMQ</p><pre class=" language-bash"><code class="language-bash">rpm --import https://github.com/rabbitmq/signing-keys/releases/download/2.0/rabbitmq-release-signing-key.asc<span class="token comment" spellcheck="true"># this example assumes the CentOS 7 version of the package</span>yum <span class="token function">install</span> rabbitmq-server-3.7.13-1.el7.noarch.rpm</code></pre><pre class=" language-bash"><code class="language-bash">rpm --import https://www.rabbitmq.com/rabbitmq-release-signing-key.asc<span class="token comment" spellcheck="true"># this example assumes the CentOS 7 version of the package</span>yum <span class="token function">install</span> rabbitmq-server-3.7.13-1.el7.noarch.rpm</code></pre><p>2ã€ç”¨ rpm æ‰‹åŠ¨å®‰è£…</p><p>ä¸‹è½½ï¼š</p><pre><code>wget  https://github.com/rabbitmq/rabbitmq-server/releases/download/v3.7.13/rabbitmq-server-3.7.13-1.el7.noarch.rpm</code></pre><p>ä¸Šä¼ rabbitmq-server-3.7.13-1.el7.noarch.rpmæ–‡ä»¶åˆ°/usr/local/src/rabbitmq/</p><p>å®‰è£…ï¼š</p><pre><code>rpm -ivh rabbitmq-server-3.7.13-1.el7.noarch.rpm</code></pre><p>å‡ ä¸ªå¸¸ç”¨å‘½ä»¤ï¼š</p><pre><code>service rabbitmq-server startservice rabbitmq-server stopservice rabbitmq-server restart chkconfig rabbitmq-server onã€€ã€€//è®¾ç½®å¼€æœºè‡ªå¯</code></pre><p>è®¾ç½®é…ç½®æ–‡ä»¶ï¼š</p><pre><code>cd /etc/rabbitmqcp /usr/share/doc/rabbitmq-server-3.7.13/rabbitmq.config.example /etc/rabbitmq/mv rabbitmq.config.example rabbitmq.config</code></pre><p>è®¾ç½®ç”¨æˆ·è¿œç¨‹è®¿é—®ï¼š</p><pre><code>vim /etc/rabbitmq/rabbitmq.config</code></pre><p><img src="https://s1.ax1x.com/2020/04/26/JRmyFO.png" alt="JRmyFO.png"></p><p>å»æ‰åé¢çš„é€—å·</p><p>å¼€å¯webç•Œé¢ç®¡ç†å·¥å…·</p><pre><code>rabbitmq-plugins enable rabbitmq_managementservice rabbitmq-server restart</code></pre><p>é˜²ç«å¢™å¼€æ”¾15672ç«¯å£(CentOS7 ä¸ç”¨æ“ä½œ)</p><pre><code>/sbin/iptables -I INPUT -p tcp --dport 15672 -j ACCEPT/etc/rc.d/init.d/iptables save</code></pre><h6 id="4ã€å®¢æˆ·ç«¯çš„ç®€å•ä»‹ç»"><a href="#4ã€å®¢æˆ·ç«¯çš„ç®€å•ä»‹ç»" class="headerlink" title="4ã€å®¢æˆ·ç«¯çš„ç®€å•ä»‹ç»"></a>4ã€å®¢æˆ·ç«¯çš„ç®€å•ä»‹ç»</h6><p>1ã€ç•Œé¢çš„ä»‹ç»</p><p><img src="https://s1.ax1x.com/2020/04/26/JRmcfe.png" alt="JRmcfe.png"></p><p>æ³¨æ„è®¾ç½®è™šæ‹Ÿä¸»æœºä¸æ·»åŠ ç”¨æˆ·è¿™å—ã€‚</p><p><img src="https://s1.ax1x.com/2020/04/26/JRmfOI.png" alt="JRmfOI.png"></p><pre><code>å‘½ä»¤è¡Œæ·»åŠ ç”¨æˆ·ï¼Œè®¾ç½®tagsrabbitmqctl list_usersrabbitmqctl add_user username passwordrabbitmqctl set_user_tags username  administrator</code></pre><p>å…³äºè™šæ‹Ÿä¸»æœºï¼ŒVirtual Hostï¼Œå…¶å®æ˜¯ä¸€ä¸ªè™šæ‹Ÿæ¦‚å¿µï¼Œç±»ä¼¼äºæƒé™æ§åˆ¶ç»„ï¼Œä¸€ä¸ªVirtual Hosté‡Œé¢å¯ä»¥æœ‰è‹¥å¹²ä¸ªExchangeå’ŒQueueï¼Œä½†æ˜¯æƒé™æ§åˆ¶çš„æœ€å°ç²’åº¦æ˜¯Virtual Host</p><p>ç”¨æˆ·è§’è‰²æœ‰ä¸‹é¢å‡ ç§ï¼š</p><ol><li>è¶…çº§ç®¡ç†å‘˜(administrator)</li></ol><p>å¯ç™»é™†ç®¡ç†æ§åˆ¶å°ï¼Œå¯æŸ¥çœ‹æ‰€æœ‰çš„ä¿¡æ¯ï¼Œå¹¶ä¸”å¯ä»¥å¯¹ç”¨æˆ·ï¼Œç­–ç•¥(policy)è¿›è¡Œæ“ä½œã€‚</p><ol><li>ç›‘æ§è€…(monitoring)</li></ol><p>å¯ç™»é™†ç®¡ç†æ§åˆ¶å°ï¼ŒåŒæ—¶å¯ä»¥æŸ¥çœ‹rabbitmqèŠ‚ç‚¹çš„ç›¸å…³ä¿¡æ¯(è¿›ç¨‹æ•°ï¼Œå†…å­˜ä½¿ç”¨æƒ…å†µï¼Œç£ç›˜ä½¿ç”¨æƒ…å†µç­‰)</p><ol><li>ç­–ç•¥åˆ¶å®šè€…(policymaker)</li></ol><p>å¯ç™»é™†ç®¡ç†æ§åˆ¶å°, åŒæ—¶å¯ä»¥å¯¹policyè¿›è¡Œç®¡ç†ã€‚ä½†æ— æ³•æŸ¥çœ‹èŠ‚ç‚¹çš„ç›¸å…³ä¿¡æ¯(ä¸Šå›¾çº¢æ¡†æ ‡è¯†çš„éƒ¨åˆ†)ã€‚</p><ol><li>æ™®é€šç®¡ç†è€…(management)</li></ol><p>ä»…å¯ç™»é™†ç®¡ç†æ§åˆ¶å°ï¼Œæ— æ³•çœ‹åˆ°èŠ‚ç‚¹ä¿¡æ¯ï¼Œä¹Ÿæ— æ³•å¯¹ç­–ç•¥è¿›è¡Œç®¡ç†ã€‚</p><ol><li>å…¶ä»–</li></ol><p>æ— æ³•ç™»é™†ç®¡ç†æ§åˆ¶å°ï¼Œé€šå¸¸å°±æ˜¯æ™®é€šçš„ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ã€‚</p><h4 id="4ã€Mac-å®‰è£…æ•™ç¨‹"><a href="#4ã€Mac-å®‰è£…æ•™ç¨‹" class="headerlink" title="4ã€Mac å®‰è£…æ•™ç¨‹"></a>4ã€Mac å®‰è£…æ•™ç¨‹</h4><h6 id="1ã€å®‰è£…"><a href="#1ã€å®‰è£…" class="headerlink" title="1ã€å®‰è£…"></a>1ã€å®‰è£…</h6><p>åœ¨Macä¸‹å®‰è£…RabbitMQæ˜¯éå¸¸ç®€å•çš„ï¼Œä¸€èˆ¬é»˜è®¤RabbitMQæœåŠ¡å™¨ä¾èµ–çš„Erlangå·²ç»å®‰è£…ï¼Œåªéœ€è¦ç”¨ä¸‹é¢ä¸¤ä¸ªå‘½ä»¤å°±å¯ä»¥å®ŒæˆRabbitMQçš„å®‰è£…ï¼ˆå‰ææ˜¯homebrewå·²ç»è¢«å®‰è£…ï¼‰ï¼š</p><pre><code>brew updatebrew install rabbitmq</code></pre><p>è€å¿ƒç­‰å¾…ï¼Œå®‰è£…å®Œæˆåéœ€è¦å°†/usr/local/sbinæ·»åŠ åˆ°$PATHï¼Œå¯ä»¥å°†ä¸‹é¢è¿™ä¸¤è¡ŒåŠ åˆ°~/.bash_profileï¼š</p><pre><code># RabbitMQ Configexport PATH=$PATH:/usr/local/sbin</code></pre><p>ç¼–è¾‘å®Œå:wqä¿å­˜é€€å‡ºï¼Œä½¿ç¯å¢ƒå˜é‡ç«‹å³ç”Ÿæ•ˆã€‚</p><pre><code>source ~/.bash_profile</code></pre><h6 id="2ã€å¯åŠ¨RabbitMQæœåŠ¡"><a href="#2ã€å¯åŠ¨RabbitMQæœåŠ¡" class="headerlink" title="2ã€å¯åŠ¨RabbitMQæœåŠ¡"></a>2ã€å¯åŠ¨RabbitMQæœåŠ¡</h6><p>ä¸Šé¢é…ç½®å®Œæˆåï¼Œéœ€è¦å…³é—­ç»ˆç«¯çª—å£ï¼Œé‡æ–°æ‰“å¼€ï¼Œç„¶åè¾“å…¥ä¸‹é¢å‘½ä»¤å³å¯å¯åŠ¨RabbitMQæœåŠ¡ï¼š</p><pre><code>rabbitmq-server</code></pre><h6 id="3ã€ç™»å½•Webç®¡ç†ç•Œé¢"><a href="#3ã€ç™»å½•Webç®¡ç†ç•Œé¢" class="headerlink" title="3ã€ç™»å½•Webç®¡ç†ç•Œé¢"></a>3ã€ç™»å½•Webç®¡ç†ç•Œé¢</h6><p>æµè§ˆå™¨è¾“å…¥<code>localhostï¼š15672</code>,è´¦å·å¯†ç å…¨è¾“å…¥guestå³å¯ç™»å½•ã€‚</p><h4 id="5ã€RabbitMQå¸¸ç”¨çš„å‘½ä»¤"><a href="#5ã€RabbitMQå¸¸ç”¨çš„å‘½ä»¤" class="headerlink" title="5ã€RabbitMQå¸¸ç”¨çš„å‘½ä»¤"></a>5ã€RabbitMQå¸¸ç”¨çš„å‘½ä»¤</h4><h5 id="1ã€åŸºæœ¬å‘½ä»¤"><a href="#1ã€åŸºæœ¬å‘½ä»¤" class="headerlink" title="1ã€åŸºæœ¬å‘½ä»¤"></a>1ã€åŸºæœ¬å‘½ä»¤</h5><p>å¯åŠ¨ç›‘æ§ç®¡ç†å™¨ï¼šrabbitmq-plugins enable rabbitmq_management<br>å…³é—­ç›‘æ§ç®¡ç†å™¨ï¼šrabbitmq-plugins disable rabbitmq_management<br>å¯åŠ¨rabbitmqï¼šrabbitmq-service start<br>å…³é—­rabbitmqï¼šrabbitmq-service stop<br>æŸ¥çœ‹æ‰€æœ‰çš„é˜Ÿåˆ—ï¼šrabbitmqctl list_queues<br>æ¸…é™¤æ‰€æœ‰çš„é˜Ÿåˆ—ï¼šrabbitmqctl reset<br>å…³é—­åº”ç”¨ï¼šrabbitmqctl stop_app<br>å¯åŠ¨åº”ç”¨ï¼šrabbitmqctl start_app</p><h5 id="2ã€ç”¨æˆ·å’Œæƒé™è®¾ç½®"><a href="#2ã€ç”¨æˆ·å’Œæƒé™è®¾ç½®" class="headerlink" title="2ã€ç”¨æˆ·å’Œæƒé™è®¾ç½®"></a>2ã€ç”¨æˆ·å’Œæƒé™è®¾ç½®</h5><p>æ·»åŠ ç”¨æˆ·ï¼šrabbitmqctl add_user username password<br>åˆ†é…è§’è‰²ï¼šrabbitmqctl set_user_tags username administrator<br>æ–°å¢è™šæ‹Ÿä¸»æœºï¼šrabbitmqctl add_vhost vhost_name<br>å°†æ–°è™šæ‹Ÿä¸»æœºæˆæƒç»™æ–°ç”¨æˆ·ï¼š<code>rabbitmqctl set_permissions -p vhost_name username â€œ.*â€ â€œ.*â€ â€œ.*â€</code>(åé¢ä¸‰ä¸ªâ€*â€ä»£è¡¨ç”¨æˆ·æ‹¥æœ‰é…ç½®ã€å†™ã€è¯»å…¨éƒ¨æƒé™)</p><h5 id="3ã€è§’è‰²è¯´æ˜"><a href="#3ã€è§’è‰²è¯´æ˜" class="headerlink" title="3ã€è§’è‰²è¯´æ˜"></a>3ã€è§’è‰²è¯´æ˜</h5><ul><li>è¶…çº§ç®¡ç†å‘˜(administrator)<br>å¯ç™»é™†ç®¡ç†æ§åˆ¶å°ï¼Œå¯æŸ¥çœ‹æ‰€æœ‰çš„ä¿¡æ¯ï¼Œå¹¶ä¸”å¯ä»¥å¯¹ç”¨æˆ·ï¼Œç­–ç•¥(policy)è¿›è¡Œæ“ä½œã€‚</li><li>ç›‘æ§è€…(monitoring)<br>å¯ç™»é™†ç®¡ç†æ§åˆ¶å°ï¼ŒåŒæ—¶å¯ä»¥æŸ¥çœ‹rabbitmqèŠ‚ç‚¹çš„ç›¸å…³ä¿¡æ¯(è¿›ç¨‹æ•°ï¼Œå†…å­˜ä½¿ç”¨æƒ…å†µï¼Œç£ç›˜ä½¿ç”¨æƒ…å†µç­‰)</li><li>ç­–ç•¥åˆ¶å®šè€…(policymaker)<br>å¯ç™»é™†ç®¡ç†æ§åˆ¶å°, åŒæ—¶å¯ä»¥å¯¹policyè¿›è¡Œç®¡ç†ã€‚ä½†æ— æ³•æŸ¥çœ‹èŠ‚ç‚¹çš„ç›¸å…³ä¿¡æ¯(ä¸Šå›¾çº¢æ¡†æ ‡è¯†çš„éƒ¨åˆ†)ã€‚</li><li>æ™®é€šç®¡ç†è€…(management)<br>ä»…å¯ç™»é™†ç®¡ç†æ§åˆ¶å°ï¼Œæ— æ³•çœ‹åˆ°èŠ‚ç‚¹ä¿¡æ¯ï¼Œä¹Ÿæ— æ³•å¯¹ç­–ç•¥è¿›è¡Œç®¡ç†ã€‚</li><li>å…¶ä»–<br>æ— æ³•ç™»é™†ç®¡ç†æ§åˆ¶å°ï¼Œé€šå¸¸å°±æ˜¯æ™®é€šçš„ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ã€‚</li></ul><h3 id="4ã€RabbitMQ-é›†ç¾¤éƒ¨ç½²åŠé…ç½®"><a href="#4ã€RabbitMQ-é›†ç¾¤éƒ¨ç½²åŠé…ç½®" class="headerlink" title="4ã€RabbitMQ é›†ç¾¤éƒ¨ç½²åŠé…ç½®"></a>4ã€RabbitMQ é›†ç¾¤éƒ¨ç½²åŠé…ç½®</h3><p>æ¶ˆæ¯ä¸­é—´ä»¶RabbitMQï¼Œä¸€èˆ¬ä»¥é›†ç¾¤æ–¹å¼éƒ¨ç½²ï¼Œä¸»è¦æä¾›æ¶ˆæ¯çš„æ¥å—å’Œå‘é€ï¼Œå®ç°å„å¾®æœåŠ¡ä¹‹é—´çš„æ¶ˆæ¯å¼‚æ­¥ã€‚ä»¥ä¸‹å°†ä»‹ç»RabbitMQ+HAæ–¹å¼è¿›è¡Œéƒ¨ç½²ã€‚</p><h4 id="1ã€åŸç†ä»‹ç»"><a href="#1ã€åŸç†ä»‹ç»" class="headerlink" title="1ã€åŸç†ä»‹ç»"></a>1ã€åŸç†ä»‹ç»</h4><p>RabbitMQæ˜¯ä¾æ®erlangçš„åˆ†å¸ƒå¼ç‰¹æ€§ï¼ˆRabbitMQåº•å±‚æ˜¯é€šè¿‡Erlangæ¶æ„æ¥å®ç°çš„ï¼Œæ‰€ä»¥rabbitmqctlä¼šå¯åŠ¨ErlangèŠ‚ç‚¹ï¼Œå¹¶åŸºäºErlangèŠ‚ç‚¹æ¥ä½¿ç”¨Erlangç³»ç»Ÿè¿æ¥RabbitMQèŠ‚ç‚¹ï¼Œåœ¨è¿æ¥è¿‡ç¨‹ä¸­éœ€è¦æ­£ç¡®çš„Erlang Cookieå’ŒèŠ‚ç‚¹åç§°ï¼ŒErlangèŠ‚ç‚¹é€šè¿‡äº¤æ¢Erlang Cookieä»¥è·å¾—è®¤è¯ï¼‰æ¥å®ç°çš„ï¼Œæ‰€ä»¥éƒ¨ç½²Rabbitmqåˆ†å¸ƒå¼é›†ç¾¤æ—¶è¦å…ˆå®‰è£…Erlangï¼Œå¹¶æŠŠå…¶ä¸­ä¸€ä¸ªæœåŠ¡çš„cookieå¤åˆ¶åˆ°å¦å¤–çš„èŠ‚ç‚¹ã€‚</p><p>RabbitMQé›†ç¾¤ä¸­ï¼Œå„ä¸ªRabbitMQä¸ºå¯¹ç­‰èŠ‚ç‚¹ï¼Œå³æ¯ä¸ªèŠ‚ç‚¹å‡æä¾›ç»™å®¢æˆ·ç«¯è¿æ¥ï¼Œè¿›è¡Œæ¶ˆæ¯çš„æ¥æ”¶å’Œå‘é€ã€‚èŠ‚ç‚¹åˆ†ä¸ºå†…å­˜èŠ‚ç‚¹å’Œç£ç›˜èŠ‚ç‚¹ï¼Œä¸€èˆ¬çš„ï¼Œå‡åº”å»ºç«‹ä¸ºç£ç›˜èŠ‚ç‚¹ï¼Œä¸ºäº†é˜²æ­¢æœºå™¨é‡å¯åçš„æ¶ˆæ¯æ¶ˆå¤±ï¼›</p><p>RabbitMQçš„Clusteré›†ç¾¤æ¨¡å¼ä¸€èˆ¬åˆ†ä¸ºä¸¤ç§ï¼Œæ™®é€šæ¨¡å¼å’Œé•œåƒæ¨¡å¼ã€‚æ¶ˆæ¯é˜Ÿåˆ—é€šè¿‡RabbitMQ HAé•œåƒé˜Ÿåˆ—è¿›è¡Œæ¶ˆæ¯é˜Ÿåˆ—å®ä½“å¤åˆ¶ã€‚</p><p>æ™®é€šæ¨¡å¼ä¸‹ï¼Œä»¥ä¸¤ä¸ªèŠ‚ç‚¹ï¼ˆrabbit01ã€rabbit02ï¼‰ä¸ºä¾‹æ¥è¿›è¡Œè¯´æ˜ã€‚å¯¹äºQueueæ¥è¯´ï¼Œæ¶ˆæ¯å®ä½“åªå­˜åœ¨äºå…¶ä¸­ä¸€ä¸ªèŠ‚ç‚¹rabbit01ï¼ˆæˆ–è€…rabbit02ï¼‰ï¼Œrabbit01å’Œrabbit02ä¸¤ä¸ªèŠ‚ç‚¹ä»…æœ‰ç›¸åŒçš„å…ƒæ•°æ®ï¼Œå³é˜Ÿåˆ—çš„ç»“æ„ã€‚å½“æ¶ˆæ¯è¿›å…¥rabbit01èŠ‚ç‚¹çš„Queueåï¼Œconsumerä»rabbit02èŠ‚ç‚¹æ¶ˆè´¹æ—¶ï¼ŒRabbitMQä¼šä¸´æ—¶åœ¨rabbit01ã€rabbit02é—´è¿›è¡Œæ¶ˆæ¯ä¼ è¾“ï¼ŒæŠŠAä¸­çš„æ¶ˆæ¯å®ä½“å–å‡ºå¹¶ç»è¿‡Bå‘é€ç»™consumerã€‚æ‰€ä»¥consumeråº”å°½é‡è¿æ¥æ¯ä¸€ä¸ªèŠ‚ç‚¹ï¼Œä»ä¸­å–æ¶ˆæ¯ã€‚å³å¯¹äºåŒä¸€ä¸ªé€»è¾‘é˜Ÿåˆ—ï¼Œè¦åœ¨å¤šä¸ªèŠ‚ç‚¹å»ºç«‹ç‰©ç†Queueã€‚å¦åˆ™æ— è®ºconsumerè¿rabbit01æˆ–rabbit02ï¼Œå‡ºå£æ€»åœ¨rabbit01ï¼Œä¼šäº§ç”Ÿç“¶é¢ˆã€‚</p><p>é•œåƒæ¨¡å¼ä¸‹ï¼Œå°†éœ€è¦æ¶ˆè´¹çš„é˜Ÿåˆ—å˜ä¸ºé•œåƒé˜Ÿåˆ—ï¼Œå­˜åœ¨äºå¤šä¸ªèŠ‚ç‚¹ï¼Œè¿™æ ·å°±å¯ä»¥å®ç°RabbitMQçš„HAé«˜å¯ç”¨æ€§ã€‚ä½œç”¨å°±æ˜¯æ¶ˆæ¯å®ä½“ä¼šä¸»åŠ¨åœ¨é•œåƒèŠ‚ç‚¹ä¹‹é—´å®ç°åŒæ­¥ï¼Œè€Œä¸æ˜¯åƒæ™®é€šæ¨¡å¼é‚£æ ·ï¼Œåœ¨consumeræ¶ˆè´¹æ•°æ®æ—¶ä¸´æ—¶è¯»å–ã€‚ç¼ºç‚¹å°±æ˜¯ï¼Œé›†ç¾¤å†…éƒ¨çš„åŒæ­¥é€šè®¯ä¼šå ç”¨å¤§é‡çš„ç½‘ç»œå¸¦å®½ã€‚</p><h4 id="2ã€éƒ¨ç½²-RabbitMQ-Cluster"><a href="#2ã€éƒ¨ç½²-RabbitMQ-Cluster" class="headerlink" title="2ã€éƒ¨ç½² RabbitMQ Cluster"></a>2ã€éƒ¨ç½² RabbitMQ Cluster</h4><p>å¤šå°æœºå™¨éƒ¨ç½²RabbitMQçš„clusterï¼Œ</p><h5 id="1ã€ç¯å¢ƒè¦æ±‚"><a href="#1ã€ç¯å¢ƒè¦æ±‚" class="headerlink" title="1ã€ç¯å¢ƒè¦æ±‚"></a>1ã€ç¯å¢ƒè¦æ±‚</h5><p>1ã€æ‰€æœ‰èŠ‚ç‚¹éœ€è¦å†åŒä¸€ä¸ªå±€åŸŸç½‘å†…ï¼›</p><p>2ã€æ‰€æœ‰èŠ‚ç‚¹éœ€è¦æœ‰ç›¸åŒçš„ erlang cookieï¼Œå¦åˆ™ä¸èƒ½æ­£å¸¸é€šä¿¡ï¼Œä¸ºäº†å®ç°cookieå†…å®¹ä¸€è‡´ï¼Œé‡‡ç”¨scpçš„æ–¹å¼è¿›è¡Œã€‚</p><p>3ã€å‡†å¤‡ä¸‰å°è™šæ‹Ÿæœºï¼Œé…ç½®ç›¸åŒ</p><p>rabbitmq01 192.168.101.11   </p><p>rabbitmq02 192.168.101.12  </p><p>rabbitmq03 192.168.101.13</p><p>æ“ä½œç³»ç»Ÿï¼šcentos7.5</p><h5 id="2ã€éƒ¨ç½²è¿‡ç¨‹"><a href="#2ã€éƒ¨ç½²è¿‡ç¨‹" class="headerlink" title="2ã€éƒ¨ç½²è¿‡ç¨‹"></a>2ã€éƒ¨ç½²è¿‡ç¨‹</h5><h6 id="1ã€æ‰€æœ‰èŠ‚ç‚¹é…ç½®-etc-hosts"><a href="#1ã€æ‰€æœ‰èŠ‚ç‚¹é…ç½®-etc-hosts" class="headerlink" title="1ã€æ‰€æœ‰èŠ‚ç‚¹é…ç½®/etc/hosts"></a>1ã€æ‰€æœ‰èŠ‚ç‚¹é…ç½®/etc/hosts</h6><p>node1 192.168.101.11   </p><p>node2 192.168.101.12  </p><p>node3 192.168.101.13</p><h6 id="2ã€æ‰€æœ‰èŠ‚ç‚¹å®‰è£…-erLang-å’Œ-rabbitmq"><a href="#2ã€æ‰€æœ‰èŠ‚ç‚¹å®‰è£…-erLang-å’Œ-rabbitmq" class="headerlink" title="2ã€æ‰€æœ‰èŠ‚ç‚¹å®‰è£… erLang å’Œ rabbitmq"></a>2ã€æ‰€æœ‰èŠ‚ç‚¹å®‰è£… erLang å’Œ rabbitmq</h6><p><strong>1ã€å®‰è£…erlang</strong></p><p>å®‰è£…ä¾èµ–åŒ…</p><pre><code>yum install -y *epel* gcc-c++ unixODBC unixODBC-devel openssl-devel ncurses-devel</code></pre><p>ç¼–è¯‘å®‰è£…</p><pre><code>wget http://erlang.org/download/otp_src_21.3.tar.gztar -zxvf otp_src_21.3.tar.gzcd otp_src_21.3./configure --prefix=/usr/local/bin/erlang --without-javacmake &amp;&amp; make installecho &quot;export PATH=$PATH:/usr/local/bin/erlang/bin:/usr/local/bin/rabbitmq_server-3.6.15/sbin&quot; &gt;&gt; /etc/profilesource /etc/profile</code></pre><p>å‡ºç° erl å‘½ä»¤åˆ™è¯´æ˜å®‰è£…æˆåŠŸï¼›</p><p><strong>2ã€å®‰è£…rabbitmq</strong></p><p>ç¼–è¯‘å®‰è£…</p><pre><code>wget http://www.rabbitmq.com/releases/rabbitmq-server/v3.6.15/rabbitmq-server-generic-unix-3.6.15.tar.xzyum install -y xzxz -d rabbitmq-server-generic-unix-3.6.15.tar.xztar -xvf rabbitmq-server-generic-unix-3.6.15.tar -C /usr/local/bin/echo &quot;export PATH=$PATH:/usr/local/bin/erlang/bin:/usr/local/bin/rabbitmq_server-3.6.15/sbin&quot; &gt;&gt; /etc/profilesource /etc/profile</code></pre><p><strong>3ã€å¯¼å…¥ rabbitmq çš„ç®¡ç†ç•Œé¢</strong></p><pre><code>rabbitmq-plugins enable rabbitmq_management</code></pre><p><strong>4ã€è®¾ç½® erlang</strong></p><p>æ‰¾åˆ°erlang cookieæ–‡ä»¶çš„ä½ç½®ï¼Œå®˜æ–¹åœ¨ä»‹ç»é›†ç¾¤çš„æ–‡æ¡£ä¸­æåˆ°è¿‡.erlang.cookie ä¸€èˆ¬ä¼šå­˜åœ¨è¿™ä¸¤ä¸ªåœ°å€ï¼šç¬¬ä¸€ä¸ªæ˜¯<code>home/.erlang.cookie</code>ï¼›ç¬¬äºŒä¸ªåœ°æ–¹å°±æ˜¯<code>/var/lib/rabbitmq/.erlang.cookie</code>ã€‚å¦‚æœæˆ‘ä»¬ä½¿ç”¨è§£å‹ç¼©æ–¹å¼å®‰è£…éƒ¨ç½²çš„rabbitmqï¼Œé‚£ä¹ˆè¿™ä¸ªæ–‡ä»¶ä¼šåœ¨{home}ç›®å½•ä¸‹ï¼Œä¹Ÿå°±æ˜¯<code>$home/.erlang.cookie</code>ã€‚å¦‚æœæˆ‘ä»¬ä½¿ç”¨rpmç­‰å®‰è£…åŒ…æ–¹å¼è¿›è¡Œå®‰è£…çš„ï¼Œé‚£ä¹ˆè¿™ä¸ªæ–‡ä»¶ä¼šåœ¨<code>/var/lib/rabbitmq</code>ç›®å½•ä¸‹ã€‚</p><p>è¿™é‡Œå°† node1 çš„è¯¥æ–‡ä»¶å¤åˆ¶åˆ° node2ã€node3ï¼Œæ³¨æ„è¿™ä¸ªæ–‡ä»¶çš„æƒé™æ˜¯ 400ï¼ˆé»˜è®¤å³æ˜¯400ï¼‰ï¼Œå› æ­¤é‡‡ç”¨scpçš„æ–¹å¼åªæ‹·è´å†…å®¹å³å¯ï¼›</p><p>å¯ä»¥é€šè¿‡<code>cat  $home/.erlang.cookie</code>æ¥æŸ¥çœ‹ä¸‰å°æœºå™¨çš„cookieæ˜¯å¦ä¸€è‡´ï¼Œè®¾ç½®erlangçš„ç›®çš„æ˜¯è¦ä¿è¯é›†ç¾¤å†…çš„cookieå†…å®¹ä¸€è‡´ã€‚</p><p><strong>ä½¿ç”¨-detachedå‚æ•°è¿è¡Œå„èŠ‚ç‚¹</strong></p><pre><code>rabbitmqctl stoprabbitmq-server -detached</code></pre><p>ç„¶åå¯ä»¥é€šè¿‡ <code>rabbitmqctl cluster_status</code>æŸ¥çœ‹èŠ‚ç‚¹çŠ¶æ€ã€‚</p><p>æ³¨æ„ï¼šè¦å…ˆæ‹·è´cookieåˆ°å¦å¤–ä¸¤å°æœºå™¨ä¸Šï¼Œä¿è¯ä¸‰å°æœºå™¨ä¸Šçš„cookieæ˜¯ä¸€è‡´çš„ï¼Œç„¶åå†å¯åŠ¨æœåŠ¡ã€‚</p><p>ç”±äºguestè¿™ä¸ªç”¨æˆ·,åªèƒ½åœ¨æœ¬åœ°è®¿é—®,æ‰€ä»¥æˆ‘ä»¬è¦æ–°å¢ä¸€ä¸ªç”¨æˆ·å¹¶èµ‹äºˆæƒé™:</p><p>æ·»åŠ ç”¨æˆ·å¹¶è®¾ç½®å¯†ç :</p><pre><code>rabbitmqctl add_user  admin 123456</code></pre><p>æ·»åŠ æƒé™ï¼ˆä½¿adminç”¨æˆ·å¯¹è™šæ‹Ÿä¸»æœºâ€œ/â€ å…·æœ‰æ‰€æœ‰æƒé™ï¼‰:</p><pre><code>rabbitmqctl set_permissions -p &quot;/&quot; admin &quot;.*&quot; &quot;.*&quot; &quot;.*&quot;</code></pre><p>ä¿®æ”¹ç”¨æˆ·è§’è‰²ï¼ˆåŠ å…¥administratorç”¨æˆ·ç»„ï¼‰</p><pre><code>rabbitmqctl set_user_tags admin administrator</code></pre><p>ç„¶åå°±å¯ä»¥è¿œç¨‹è®¿é—®äº†ï¼Œç„¶åå¯ç›´æ¥é…ç½®ç”¨æˆ·æƒé™ç­‰ä¿¡æ¯ã€‚åˆ°æ­¤,å°±å¯ä»¥é€šè¿‡<a href="http://ip:15672" target="_blank" rel="noopener">http://ip:15672</a> ä½¿ç”¨admin 123456 è¿›è¡Œç™»é™†äº†ã€‚</p><p>åˆ°è¿™é‡Œçš„è¯ï¼Œæ¯ä¸ªèŠ‚ç‚¹æ˜¯ä½œä¸ºå•ç‹¬çš„ä¸€å°RabbitMQå­˜åœ¨çš„ï¼Œä¹Ÿå¯ä»¥æ­£å¸¸æä¾›æœåŠ¡äº†</p><h5 id="3ã€ç»„æˆé›†ç¾¤"><a href="#3ã€ç»„æˆé›†ç¾¤" class="headerlink" title="3ã€ç»„æˆé›†ç¾¤"></a>3ã€ç»„æˆé›†ç¾¤</h5><p>rabbitmq-server å¯åŠ¨æ—¶ï¼Œä¼šä¸€èµ·å¯åŠ¨èŠ‚ç‚¹å’Œåº”ç”¨ï¼Œå®ƒé¢„å…ˆè®¾ç½®RabbitMQåº”ç”¨ä¸ºstandaloneæ¨¡å¼ã€‚è¦å°†ä¸€ä¸ªèŠ‚ç‚¹åŠ å…¥åˆ°ç°æœ‰çš„é›†ç¾¤ä¸­ï¼Œä½ éœ€è¦åœæ­¢è¿™ä¸ªåº”ç”¨ï¼Œå¹¶å°†èŠ‚ç‚¹è®¾ç½®ä¸ºåŸå§‹çŠ¶æ€ã€‚å¦‚æœä½¿ç”¨./rabbitmqctl stopï¼Œåº”ç”¨å’ŒèŠ‚ç‚¹éƒ½å°†è¢«å…³é—­ã€‚æ‰€ä»¥ä½¿ç”¨rabbitmqctl stop_appä»…ä»…å…³é—­åº”ç”¨ã€‚</p><p>1ã€å°† node2ã€node3ä¸ node1 ç»„æˆé›†ç¾¤ï¼Œè¿™é‡Œä»¥node2ä¸ºä¾‹</p><pre><code>node2# rabbitmqctl stop_app      node2# rabbitmqctl join_cluster rabbit@node1               ####è¿™é‡Œé›†ç¾¤çš„åå­—ä¸€å®šä¸è¦å†™é”™äº†node2# rabbitmqctl start_app</code></pre><p>2ã€å°†node3é‡å¤ä¸Šè¿°æ“ä½œï¼Œä¹ŸåŠ å…¥node1çš„é›†ç¾¤ã€‚</p><pre><code>node3# rabbitmqctl stop_app      node3# rabbitmqctl join_cluster rabbit@node1               ####è¿™é‡Œé›†ç¾¤çš„åå­—ä¸€å®šä¸è¦å†™é”™äº†node3# rabbitmqctl start_app</code></pre><p>åˆ™æ­¤æ—¶ node2 ä¸ node3 ä¹Ÿä¼šè‡ªåŠ¨å»ºç«‹è¿æ¥ï¼Œé›†ç¾¤é…ç½®å®Œæ¯•ï¼›</p><pre><code>#ä½¿ç”¨å†…å­˜èŠ‚ç‚¹åŠ å…¥é›†ç¾¤node2 # rabbitmqctl join_cluster --ram rabbit@node1</code></pre><p>3ã€åœ¨ RabbitMQ é›†ç¾¤ä»»æ„èŠ‚ç‚¹ä¸Šæ‰§è¡Œ <code>rabbitmqctl cluster_status</code>æ¥æŸ¥çœ‹æ˜¯å¦é›†ç¾¤é…ç½®æˆåŠŸã€‚</p><pre><code>node3# rabbitmqctl cluster_statusCluster status of node rabbit@node3 ...[{nodes,[{disc,[rabbit@node1,rabbit@node2,rabbit@node3]}]}, {running_nodes,[rabbit@node1,rabbit@node2,rabbit@node3]}, {cluster_name,&lt;&quot;rabbit@node1&quot;&gt;},      #é›†ç¾¤çš„åç§°é»˜è®¤ä¸º rabbit@node1 {partitions,[]}, {alarms,[{rabbit@node1,[]},{rabbit@node2,[]},{rabbit@node3,[]}]}]</code></pre><p>4ã€ä¹Ÿå¯é€šè¿‡åœ¨webé¡µé¢ä¸Šçš„â€œQueuesâ€çš„åˆ—è¡¨ä¸­ï¼ŒæŸ¥çœ‹æœ‰å¦‚ä¸‹æ˜¾ç¤ºä¸ºâ€œåŒæ­¥é•œåƒåˆ°node2â€ï¼Œåˆ™ä¹Ÿè¡¨ç¤ºé›†ç¾¤é…ç½®æˆåŠŸ</p><p><img src="https://s1.ax1x.com/2020/04/26/JRmHfg.png" alt="JRmHfg.png"></p><p>5ã€è®¾ç½®é•œåƒé˜Ÿåˆ—ç­–ç•¥</p><p>åœ¨ä»»æ„ä¸€ä¸ªèŠ‚ç‚¹ä¸Šæ‰§è¡Œå¦‚ä¸‹æ“ä½œï¼ˆè¿™é‡Œåœ¨node1ä¸Šæ‰§è¡Œï¼‰</p><p>é¦–å…ˆï¼Œåœ¨webç•Œé¢ï¼Œç™»é™†åï¼Œç‚¹å‡»â€œAdminâ€“Virtual Hostsï¼ˆé¡µé¢å³ä¾§ï¼‰â€ï¼Œåœ¨æ‰“å¼€çš„é¡µé¢ä¸Šçš„ä¸‹æ–¹çš„â€œAdd a new virtual hostâ€å¤„å¢åŠ ä¸€ä¸ªè™šæ‹Ÿä¸»æœºï¼ŒåŒæ—¶ç»™ç”¨æˆ·â€œadminâ€å’Œâ€œguestâ€å‡åŠ ä¸Šæƒé™ï¼ˆåœ¨é¡µé¢ç›´æ¥è®¾ç½®ã€ç‚¹ç‚¹ç‚¹å³å¯ï¼‰ï¼›</p><p>ç„¶åï¼Œåœ¨linuxä¸­æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤</p><pre><code>rabbitmqctl set_policy -p coresystem  ha-all &quot;^&quot; &#39;{&quot;ha-mode&quot;:&quot;all&quot;}&#39;</code></pre><p>â€œcoresystemâ€ vhoståç§°ï¼Œ â€œ^â€åŒ¹é…æ‰€æœ‰çš„é˜Ÿåˆ—ï¼Œ ha-all ç­–ç•¥åç§°ä¸ºha-all, â€˜{â€œha-modeâ€:â€allâ€}â€™ ç­–ç•¥æ¨¡å¼ä¸º all å³å¤åˆ¶åˆ°æ‰€æœ‰èŠ‚ç‚¹ï¼ŒåŒ…å«æ–°å¢èŠ‚ç‚¹ã€‚</p><p>åˆ™æ­¤æ—¶é•œåƒé˜Ÿåˆ—è®¾ç½®æˆåŠŸã€‚ï¼ˆè¿™é‡Œçš„è™šæ‹Ÿä¸»æœºcoresystemæ˜¯ä»£ç ä¸­éœ€è¦ç”¨åˆ°çš„è™šæ‹Ÿä¸»æœºï¼Œè™šæ‹Ÿä¸»æœºçš„ä½œç”¨æ˜¯åšä¸€ä¸ªæ¶ˆæ¯çš„éš”ç¦»ï¼Œæœ¬è´¨ä¸Šå¯è®¤ä¸ºæ˜¯ä¸€ä¸ªrabbitmq-serverï¼Œæ˜¯å¦å¢åŠ è™šæ‹Ÿä¸»æœºï¼Œå¢åŠ å‡ ä¸ªï¼Œè¿™æ˜¯ç”±å¼€å‘ä¸­çš„ä¸šåŠ¡å†³å®šï¼Œå³æœ‰å“ªå‡ ç±»æœåŠ¡ï¼Œå“ªäº›æœåŠ¡ç”¨å“ªä¸€ä¸ªè™šæ‹Ÿä¸»æœºï¼Œè¿™æ˜¯ä¸€ä¸ªè§„åˆ’ï¼‰ã€‚</p><p>6ã€é•œåƒé˜Ÿåˆ—ç­–ç•¥è®¾ç½®è¯´æ˜</p><pre><code>rabbitmqctl set_policy [-p Vhost] Name Pattern Definition [Priority]-p Vhostï¼š å¯é€‰å‚æ•°ï¼Œé’ˆå¯¹æŒ‡å®švhostä¸‹çš„queueè¿›è¡Œè®¾ç½®Name: policyçš„åç§°Pattern: queueçš„åŒ¹é…æ¨¡å¼(æ­£åˆ™è¡¨è¾¾å¼)Definitionï¼šé•œåƒå®šä¹‰ï¼ŒåŒ…æ‹¬ä¸‰ä¸ªéƒ¨åˆ†ha-mode, ha-params, ha-sync-mode    ha-mode:æŒ‡æ˜é•œåƒé˜Ÿåˆ—çš„æ¨¡å¼ï¼Œæœ‰æ•ˆå€¼ä¸º all/exactly/nodes        allï¼šè¡¨ç¤ºåœ¨é›†ç¾¤ä¸­æ‰€æœ‰çš„èŠ‚ç‚¹ä¸Šè¿›è¡Œé•œåƒ        exactlyï¼šè¡¨ç¤ºåœ¨æŒ‡å®šä¸ªæ•°çš„èŠ‚ç‚¹ä¸Šè¿›è¡Œé•œåƒï¼ŒèŠ‚ç‚¹çš„ä¸ªæ•°ç”±ha-paramsæŒ‡å®š        nodesï¼šè¡¨ç¤ºåœ¨æŒ‡å®šçš„èŠ‚ç‚¹ä¸Šè¿›è¡Œé•œåƒï¼ŒèŠ‚ç‚¹åç§°é€šè¿‡ha-paramsæŒ‡å®š    ha-paramsï¼šha-modeæ¨¡å¼éœ€è¦ç”¨åˆ°çš„å‚æ•°    ha-sync-modeï¼šè¿›è¡Œé˜Ÿåˆ—ä¸­æ¶ˆæ¯çš„åŒæ­¥æ–¹å¼ï¼Œæœ‰æ•ˆå€¼ä¸ºautomaticå’Œmanualpriorityï¼šå¯é€‰å‚æ•°ï¼Œpolicyçš„ä¼˜å…ˆçº§</code></pre><p>å°†æ‰€æœ‰é˜Ÿåˆ—è®¾ç½®ä¸ºé•œåƒé˜Ÿåˆ—ï¼Œå³é˜Ÿåˆ—ä¼šè¢«å¤åˆ¶åˆ°å„ä¸ªèŠ‚ç‚¹ï¼Œå„ä¸ªèŠ‚ç‚¹çŠ¶æ€ä¿æŒä¸€ç›´ã€‚å®Œæˆè¿™ 6 ä¸ªæ­¥éª¤åï¼ŒRabbitMQ é«˜å¯ç”¨é›†ç¾¤æ­å»ºå®Œæˆï¼Œæœ€åä¸€ä¸ªæ­¥éª¤å°±æ˜¯æ­å»ºå‡è¡¡å™¨ã€‚</p><p>7ã€å®‰è£…å¹¶é…ç½®è´Ÿè½½å‡è¡¡å™¨HA</p><p>æ³¨æ„ï¼šå¦‚æœä½¿ç”¨é˜¿é‡Œäº‘ï¼Œå¯ä»¥ä½¿ç”¨é˜¿é‡Œäº‘çš„å†…ç½‘slbæ¥å®ç°è´Ÿè½½å‡è¡¡ï¼Œä¸ç”¨è‡ªå·±æ­å»ºHAã€‚</p><p>1ã€åœ¨192.168.101.11å®‰è£…HAProxy</p><pre><code>yum -y install HAProxy</code></pre><p>2ã€ä¿®æ”¹ /etc/haproxy/haproxy.cfg</p><pre><code>vim /etc/haproxy/haproxy.cfgglobal     log         127.0.0.1 local2    chroot      /var/lib/haproxy    pidfile     /var/run/haproxy.pid    maxconn     4000    user        haproxy    group       haproxy    daemon    stats socket /var/lib/haproxy/statsdefaults        log        global        mode       tcp        option     tcplog        option     dontlognull        retries    3        option redispatch        maxconn 2000        contimeout      5s        clitimeout      120s        srvtimeout      120s listen rabbitmq_cluster 192.168.101.11:5670       mode      tcp        balance roundrobin        server rabbit1  192.168.101.11:5672 check inter 5000 rise 2 fall 2        server rabbit2  192.168.101.12:5672 check inter 5000 rise 2 fall 2        </code></pre><p>3ã€é‡å¯HAProxy</p><pre><code>service haproxy restart</code></pre><p>ç™»å½•æµè§ˆå™¨è¾“å…¥åœ°å€<a href="http://192.168.101.11:8100/rabbitmqstatsæŸ¥çœ‹HAProxyçš„çŠ¶æ€" target="_blank" rel="noopener">http://192.168.101.11:8100/rabbitmqstatsæŸ¥çœ‹HAProxyçš„çŠ¶æ€</a></p><p>ä¸‰ã€å¸¸è§é—®é¢˜</p><p>å¸¸è§é”™è¯¯ï¼š</p><p>1ã€ä½¿ç”¨ rabbitmq-server -detachedå‘½ä»¤å¯åŠ¨rabbitmqæ—¶ï¼Œå‡ºç°ä»¥ä¸‹æç¤ºWarning: PID file not written; -detached was passedï¼Œæ­¤æ—¶ä½¿ç”¨rabbitmqctl statusæç¤ºæœåŠ¡å·²å¯åŠ¨ï¼Œå¯çŸ¥æ­¤é—®é¢˜ä¸ç”¨è§£å†³ã€‚</p><p>2ã€ç”±äºæ›´æ”¹hostnameæ–‡ä»¶ï¼Œåœ¨æ¯æ¬¡rabbitmqctl stopæˆ–è€…rabbitmqctl cluster_statusç­‰ï¼Œåªè¦æ˜¯rabbitmqçš„å‘½ä»¤å°±æŠ¥é”™ï¼Œæç¤ºå¤§æ¦‚å¦‚ä¸‹</p><pre><code>Cluster status of node rabbit@web2 ...Error: unable to connect to node rabbit@web2: nodedownDIAGNOSTICS===========attempted to contact: [rabbit@web2]rabbit@web2:  * connected to epmd (port 4369) on web2  * epmd reports node &#39;rabbit&#39; running on port 25672  * TCP connection succeeded but Erlang distribution failed  * Hostname mismatch: node &quot;rabbit@mq2&quot; believes its host is different. Please ensure that hostnames resolve the same way locally and on &quot;rabbit@mq2&quot;current node details:- node name: &#39;rabbitmq-cli-11@web2&#39;- home dir: /root- cookie hash: SGwxMdJ3PjEXG1asIEFpBg==</code></pre><p>æ­¤æ—¶å…ˆ<code>ps aux | grep mq</code>ï¼Œç„¶å<code>kill -9</code> è¯¥è¿›ç¨‹ï¼Œç„¶åå†<code>rabbitmq-server -detached</code>å³å¯è§£å†³ã€‚ï¼ˆå³å…ˆå¼ºæ€ï¼Œå†é‡æ–°å¯åŠ¨ï¼‰</p><p>3ã€ä½¿ç”¨<code>rabbitmqctl stop</code>ï¼Œ<code>rabbitmq-server -detached</code>é‡æ–°å¯åŠ¨åï¼ŒåŸå…ˆæ·»åŠ çš„ç”¨æˆ·adminã€è™šæ‹Ÿä¸»æœºcoresystemç­‰å‡ä¸¢å¤±ï¼Œè¿˜éœ€è¦é‡æ–°æ·»åŠ ã€‚</p><p>é‡‡ç”¨è„šæœ¬å¯åŠ¨ï¼Œåœ¨è„šæœ¬ä¸­å†™å¥½å¯åŠ¨å¥½éœ€è¦åŠ è½½çš„å„é…ç½®é¡¹ï¼ˆåˆ›å»ºadminç”¨æˆ·å¹¶æˆæƒï¼Œåˆ›å»ºè™šæ‹Ÿä¸»æœºå¹¶æˆæƒï¼Œé…ç½®é•œåƒé˜Ÿåˆ—ï¼‰ã€‚</p><p>4ã€å‘½ä»¤</p><pre><code>rabbitmqctl stop_app         #ä»…å…³é—­åº”ç”¨ï¼Œä¸å…³é—­èŠ‚ç‚¹rabbitmqctl start_app         #å¼€å¯åº”ç”¨rabbitmq--server -detached     #å¯åŠ¨èŠ‚ç‚¹å’Œåº”ç”¨rabbitmqctl    stop             #å…³é—­èŠ‚ç‚¹å’Œåº”ç”¨</code></pre><p>4ã€å¸¸ç”¨å‘½ä»¤ï¼š</p><p>RabbitmqæœåŠ¡å™¨çš„ä¸»è¦é€šè¿‡rabbitmqctlå’Œrabbimq-pluginsä¸¤ä¸ªå·¥å…·æ¥ç®¡ç†ï¼Œä»¥ä¸‹æ˜¯ä¸€äº›å¸¸ç”¨åŠŸèƒ½ã€‚</p><p>1ã€ æœåŠ¡å™¨å¯åŠ¨ä¸å…³é—­</p><pre><code>  å¯åŠ¨: rabbitmq-server â€“detached  å…³é—­: rabbitmqctl stop  è‹¥å•æœºæœ‰å¤šä¸ªå®ä¾‹ï¼Œåˆ™åœ¨rabbitmqctlååŠ  â€“n æŒ‡å®šåç§°</code></pre><p>2ã€æ’ä»¶ç®¡ç†</p><pre><code>  å¼€å¯æŸä¸ªæ’ä»¶ï¼šrabbitmq-plugins enable  xxx  å…³é—­æŸä¸ªæ’ä»¶ï¼šrabbitmq-plugins disable xxx  æ³¨æ„ï¼šé‡å¯æœåŠ¡å™¨åç”Ÿæ•ˆã€‚</code></pre><p>3ã€virtual_hostç®¡ç†</p><pre><code>  æ–°å»ºvirtual_host:rabbitmqctl add_vhost  xxx  æ’¤é”€virtual_host:rabbitmqctl  delete_vhost xxx </code></pre><p>4ã€ç”¨æˆ·ç®¡ç†</p><pre><code>  æ–°å»ºç”¨æˆ·ï¼šrabbitmqctl add_user xxxpwd  åˆ é™¤ç”¨æˆ·: rabbitmqctl delete_user xxx  æŸ¥çœ‹ç”¨æˆ·ï¼šrabbitmqctl list_users  æ”¹å¯†ç : rabbimqctl change_password {username} {newpassword}  è®¾ç½®ç”¨æˆ·è§’è‰²ï¼šrabbitmqctlset_user_tags {username} {tag ...}          Tagå¯ä»¥ä¸º administrator,monitoring, management       </code></pre><p>5ã€ æƒé™ç®¡ç†</p><pre><code>  æƒé™è®¾ç½®ï¼šset_permissions [-pvhostpath] {user} {conf} {write} {read}  Vhostpath: Vhostè·¯å¾„  user: ç”¨æˆ·å  Conf: ä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼matchå“ªäº›é…ç½®èµ„æºèƒ½å¤Ÿè¢«è¯¥ç”¨æˆ·è®¿é—®ã€‚  Write: ä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼matchå“ªäº›é…ç½®èµ„æºèƒ½å¤Ÿè¢«è¯¥ç”¨æˆ·è¯»ã€‚  Read: ä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼matchå“ªäº›é…ç½®èµ„æºèƒ½å¤Ÿè¢«è¯¥ç”¨æˆ·è®¿é—®ã€‚</code></pre><p>6ã€è·å–æœåŠ¡å™¨çŠ¶æ€ä¿¡æ¯</p><pre><code> æœåŠ¡å™¨çŠ¶æ€ï¼šrabbitmqctl status     ##å…¶ä¸­å¯æŸ¥çœ‹rabbitmqçš„ç‰ˆæœ¬ä¿¡æ¯</code></pre><p>7ã€è·å–é›†ç¾¤çŠ¶æ€ä¿¡æ¯</p><pre><code>rabbitmqctl cluster_status</code></pre>]]></content>
      
      
      <categories>
          
          <category> SQL </category>
          
      </categories>
      
      
        <tags>
            
            <tag> RabbitMQ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Nginxç¼–è¯‘å®‰è£…</title>
      <link href="2019/03/27/linux/nginx/nginx-bian-yi-an-zhuang/"/>
      <url>2019/03/27/linux/nginx/nginx-bian-yi-an-zhuang/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h4 id="nginx-ç¼–è¯‘å®‰è£…ä¸é…ç½®ä½¿ç”¨"><a href="#nginx-ç¼–è¯‘å®‰è£…ä¸é…ç½®ä½¿ç”¨" class="headerlink" title="nginx ç¼–è¯‘å®‰è£…ä¸é…ç½®ä½¿ç”¨"></a>nginx ç¼–è¯‘å®‰è£…ä¸é…ç½®ä½¿ç”¨</h4><h5 id="1ã€å®‰è£…ç¼–è¯‘ç¯å¢ƒ"><a href="#1ã€å®‰è£…ç¼–è¯‘ç¯å¢ƒ" class="headerlink" title="1ã€å®‰è£…ç¼–è¯‘ç¯å¢ƒ"></a>1ã€å®‰è£…ç¼–è¯‘ç¯å¢ƒ</h5><p>yum -y install gcc gcc-c++</p><h5 id="2ã€å®‰è£…pcreè½¯ä»¶åŒ…ï¼ˆä½¿nginxæ”¯æŒhttp-rewriteæ¨¡å—ï¼‰"><a href="#2ã€å®‰è£…pcreè½¯ä»¶åŒ…ï¼ˆä½¿nginxæ”¯æŒhttp-rewriteæ¨¡å—ï¼‰" class="headerlink" title="2ã€å®‰è£…pcreè½¯ä»¶åŒ…ï¼ˆä½¿nginxæ”¯æŒhttp rewriteæ¨¡å—ï¼‰"></a>2ã€å®‰è£…pcreè½¯ä»¶åŒ…ï¼ˆä½¿nginxæ”¯æŒhttp rewriteæ¨¡å—ï¼‰</h5><p>yum install -y pcre pcre-devel</p><h5 id="3ã€å®‰è£…openssl-develï¼ˆä½¿nginxæ”¯æŒsslï¼‰"><a href="#3ã€å®‰è£…openssl-develï¼ˆä½¿nginxæ”¯æŒsslï¼‰" class="headerlink" title="3ã€å®‰è£…openssl-develï¼ˆä½¿nginxæ”¯æŒsslï¼‰"></a>3ã€å®‰è£…openssl-develï¼ˆä½¿nginxæ”¯æŒsslï¼‰</h5><p>yum install -y openssl openssl-devel </p><h5 id="4ã€å®‰è£…zlib"><a href="#4ã€å®‰è£…zlib" class="headerlink" title="4ã€å®‰è£…zlib"></a>4ã€å®‰è£…zlib</h5><p>yum install -y zlib zlib-devel</p><h5 id="5ã€åˆ›å»ºç”¨æˆ·nginx"><a href="#5ã€åˆ›å»ºç”¨æˆ·nginx" class="headerlink" title="5ã€åˆ›å»ºç”¨æˆ·nginx"></a>5ã€åˆ›å»ºç”¨æˆ·nginx</h5><p>useradd nginx </p><p>passwd nginx</p><h5 id="6ã€å®‰è£…nginx"><a href="#6ã€å®‰è£…nginx" class="headerlink" title="6ã€å®‰è£…nginx"></a>6ã€å®‰è£…nginx</h5><pre class=" language-shell"><code class="language-shell">[root@localhost ï½]#wget http://192.168.233.100/nginx.org/download/nginx-1.14.2.tar.gz</code></pre><pre class=" language-shell"><code class="language-shell">[root@localhost ï½]#tar -vzxf nginx-1.14.2.tar.gz -C /usr/local[root@localhost ï½]#cd nginx-1.14.2/ [root@localhost nginx-1.14.2]# ./configure \ --group=nginx \ --user=nginx \ --prefix=/usr/local/nginx \ --sbin-path=/usr/sbin/nginx \ --conf-path=/etc/nginx/nginx.conf \ --error-log-path=/var/log/nginx/error.log \ --http-log-path=/var/log/nginx/access.log \ --http-client-body-temp-path=/tmp/nginx/client_body \ --http-proxy-temp-path=/tmp/nginx/proxy \ --http-fastcgi-temp-path=/tmp/nginx/fastcgi \ --pid-path=/var/run/nginx.pid \ --lock-path=/var/lock/nginx \ --with-http_stub_status_module \ --with-http_ssl_module \ --with-http_gzip_static_module \ --with-pcre [root@localhost nginx-1.11.3]# make &&make install</code></pre><h5 id="7ã€Nginx-ç¼–è¯‘å‚æ•°"><a href="#7ã€Nginx-ç¼–è¯‘å‚æ•°" class="headerlink" title="7ã€Nginx ç¼–è¯‘å‚æ•°"></a>7ã€Nginx ç¼–è¯‘å‚æ•°</h5><pre class=" language-shell"><code class="language-shell"># æŸ¥çœ‹ nginx å®‰è£…çš„æ¨¡å—[root@tianyun ~]# nginx -V# æ¨¡å—å‚æ•°å…·ä½“åŠŸèƒ½ --with-cc-opt='-g -O2 -fPIE -fstack-protector    //è®¾ç½®é¢å¤–çš„å‚æ•°å°†è¢«æ·»åŠ åˆ°CFLAGSå˜é‡ã€‚ï¼ˆFreeBSDæˆ–è€…ubuntuä½¿ç”¨ï¼‰--param=ssp-buffer-size=4 -Wformat -Werror=format-security -D_FORTIFY_SOURCE=2' --with-ld-opt='-Wl,-Bsymbolic-functions -fPIE -pie -Wl,-z,relro -Wl,-z,now' --prefix=/usr/share/nginx                        //æŒ‡å‘å®‰è£…ç›®å½•--conf-path=/etc/nginx/nginx.conf                //æŒ‡å®šé…ç½®æ–‡ä»¶--http-log-path=/var/log/nginx/access.log        //æŒ‡å®šè®¿é—®æ—¥å¿—--error-log-path=/var/log/nginx/error.log        //æŒ‡å®šé”™è¯¯æ—¥å¿—--lock-path=/var/lock/nginx.lock                 //æŒ‡å®šlockæ–‡ä»¶--pid-path=/run/nginx.pid                        //æŒ‡å®špidæ–‡ä»¶--http-client-body-temp-path=/var/lib/nginx/body    //è®¾å®šhttpå®¢æˆ·ç«¯è¯·æ±‚ä¸´æ—¶æ–‡ä»¶è·¯å¾„--http-fastcgi-temp-path=/var/lib/nginx/fastcgi     //è®¾å®šhttp fastcgiä¸´æ—¶æ–‡ä»¶è·¯å¾„--http-proxy-temp-path=/var/lib/nginx/proxy         //è®¾å®šhttpä»£ç†ä¸´æ—¶æ–‡ä»¶è·¯å¾„--http-scgi-temp-path=/var/lib/nginx/scgi           //è®¾å®šhttp scgiä¸´æ—¶æ–‡ä»¶è·¯å¾„--http-uwsgi-temp-path=/var/lib/nginx/uwsgi         //è®¾å®šhttp uwsgiä¸´æ—¶æ–‡ä»¶è·¯å¾„--with-debug                                        //å¯ç”¨debugæ—¥å¿—--with-pcre-jit                                     //ç¼–è¯‘PCREåŒ…å«â€œjust-in-time compilationâ€--with-ipv6                                         //å¯ç”¨ipv6æ”¯æŒ--with-http_ssl_module                              //å¯ç”¨sslæ”¯æŒ--with-http_stub_status_module                      //è·å–nginxè‡ªä¸Šæ¬¡å¯åŠ¨ä»¥æ¥çš„çŠ¶æ€--with-http_realip_module                 //å…è®¸ä»è¯·æ±‚æ ‡å¤´æ›´æ”¹å®¢æˆ·ç«¯çš„IPåœ°å€å€¼ï¼Œé»˜è®¤ä¸ºå…³--with-http_auth_request_module           //å®ç°åŸºäºä¸€ä¸ªå­è¯·æ±‚çš„ç»“æœçš„å®¢æˆ·ç«¯æˆæƒã€‚å¦‚æœè¯¥å­è¯·æ±‚è¿”å›çš„2xxå“åº”ä»£ç ï¼Œæ‰€è¿°æ¥å…¥æ˜¯å…è®¸çš„ã€‚å¦‚æœå®ƒè¿”å›401æˆ–403ä¸­ï¼Œè®¿é—®è¢«æ‹’ç»ä¸ç›¸åº”çš„é”™è¯¯ä»£ç ã€‚ç”±å­è¯·æ±‚è¿”å›çš„ä»»ä½•å…¶ä»–å“åº”ä»£ç è¢«è®¤ä¸ºæ˜¯ä¸€ä¸ªé”™è¯¯ã€‚--with-http_addition_module               //ä½œä¸ºä¸€ä¸ªè¾“å‡ºè¿‡æ»¤å™¨ï¼Œæ”¯æŒä¸å®Œå…¨ç¼“å†²ï¼Œåˆ†éƒ¨åˆ†å“åº”è¯·æ±‚--with-http_dav_module                    //å¢åŠ PUT,DELETE,MKCOLï¼šåˆ›å»ºé›†åˆ,COPYå’ŒMOVEæ–¹æ³• é»˜è®¤å…³é—­ï¼Œéœ€ç¼–è¯‘å¼€å¯--with-http_geoip_module                  //ä½¿ç”¨é¢„ç¼–è¯‘çš„MaxMindæ•°æ®åº“è§£æå®¢æˆ·ç«¯IPåœ°å€ï¼Œå¾—åˆ°å˜é‡å€¼--with-http_gunzip_module                 //å®ƒä¸ºä¸æ”¯æŒâ€œgzipâ€ç¼–ç æ–¹æ³•çš„å®¢æˆ·ç«¯è§£å‹å…·æœ‰â€œContent-Encoding: gzipâ€å¤´çš„å“åº”ã€‚--with-http_gzip_static_module            //åœ¨çº¿å®æ—¶å‹ç¼©è¾“å‡ºæ•°æ®æµ--with-http_image_filter_module           //ä¼ è¾“JPEG/GIF/PNG å›¾ç‰‡çš„ä¸€ä¸ªè¿‡æ»¤å™¨ï¼‰ï¼ˆé»˜è®¤ä¸ºä¸å¯ç”¨ã€‚gdåº“è¦ç”¨åˆ°ï¼‰--with-http_spdy_module                   //SPDYå¯ä»¥ç¼©çŸ­ç½‘é¡µçš„åŠ è½½æ—¶é—´--with-http_sub_module                    //å…è®¸ç”¨ä¸€äº›å…¶ä»–æ–‡æœ¬æ›¿æ¢nginxå“åº”ä¸­çš„ä¸€äº›æ–‡æœ¬--with-http_xslt_module                   //è¿‡æ»¤è½¬æ¢XMLè¯·æ±‚--with-mail                               //å¯ç”¨POP3/IMAP4/SMTPä»£ç†æ¨¡å—æ”¯æŒ--with-mail_ssl_module                    //å¯ç”¨ngx_mail_ssl_moduleæ”¯æŒå¯ç”¨å¤–éƒ¨æ¨¡å—æ”¯æŒ</code></pre><h5 id="8ã€ä¿®æ”¹é…ç½®æ–‡ä»¶-etc-nginx-nginx-conf"><a href="#8ã€ä¿®æ”¹é…ç½®æ–‡ä»¶-etc-nginx-nginx-conf" class="headerlink" title="8ã€ä¿®æ”¹é…ç½®æ–‡ä»¶/etc/nginx/nginx.conf"></a>8ã€ä¿®æ”¹é…ç½®æ–‡ä»¶/etc/nginx/nginx.conf</h5><pre class=" language-shell"><code class="language-shell"># å…¨å±€å‚æ•°è®¾ç½® worker_processes  1;          #è®¾ç½®nginxå¯åŠ¨è¿›ç¨‹çš„æ•°é‡ï¼Œä¸€èˆ¬è®¾ç½®æˆä¸é€»è¾‘cpuæ•°é‡ç›¸åŒ error_log  logs/error.log;    #æŒ‡å®šé”™è¯¯æ—¥å¿— worker_rlimit_nofile 102400;  #è®¾ç½®ä¸€ä¸ªnginxè¿›ç¨‹èƒ½æ‰“å¼€çš„æœ€å¤§æ–‡ä»¶æ•° pid        /var/run/nginx.pid; events {     worker_connections  1024; #è®¾ç½®ä¸€ä¸ªè¿›ç¨‹çš„æœ€å¤§å¹¶å‘è¿æ¥æ•° } # http æœåŠ¡ç›¸å…³è®¾ç½® http {     include      mime.types;     default_type  application/octet-stream;     log_format  main  'remote_addr - remote_user [time_local] "request" '                      'status body_bytes_sent "$http_referer" '                      '"http_user_agent" "http_x_forwarded_for"';     access_log  /var/log/nginx/access.log  main;    #è®¾ç½®è®¿é—®æ—¥å¿—çš„ä½ç½®å’Œæ ¼å¼     sendfile          on; #æ˜¯å¦è°ƒç”¨sendfileå‡½æ•°è¾“å‡ºæ–‡ä»¶ï¼Œä¸€èˆ¬è®¾ç½®ä¸ºonï¼Œè‹¥nginxæ˜¯ç”¨æ¥è¿›è¡Œç£ç›˜IOè´Ÿè½½åº”ç”¨æ—¶ï¼Œå¯ä»¥è®¾ç½®ä¸ºoffï¼Œé™ä½ç³»ç»Ÿè´Ÿè½½     gzip              on;      #æ˜¯å¦å¼€å¯gzipå‹ç¼©     keepalive_timeout  65;     #è®¾ç½®é•¿è¿æ¥çš„è¶…æ—¶æ—¶é—´ # è™šæ‹ŸæœåŠ¡å™¨çš„ç›¸å…³è®¾ç½®     server {         listen      80;        #è®¾ç½®ç›‘å¬çš„ç«¯å£         server_name  localhost;        #è®¾ç½®ç»‘å®šçš„ä¸»æœºåã€åŸŸåæˆ–ipåœ°å€         charset koi8-r;        # è®¾ç½®ç¼–ç å­—ç¬¦         location / {             root  /var/www/nginx;           #è®¾ç½®æœåŠ¡å™¨é»˜è®¤ç½‘ç«™çš„æ ¹ç›®å½•ä½ç½®             index  index.html index.htm;    #è®¾ç½®é»˜è®¤æ‰“å¼€çš„æ–‡æ¡£             }         error_page  500 502 503 504  /50x.html; #è®¾ç½®é”™è¯¯ä¿¡æ¯è¿”å›é¡µé¢         location = /50x.html {             root  html;        #è¿™é‡Œçš„ç»å¯¹ä½ç½®æ˜¯/var/www/nginx/html         }     }  }</code></pre><h5 id="9ã€æ£€æµ‹-nginx-é…ç½®æ–‡ä»¶æ˜¯å¦æ­£ç¡®"><a href="#9ã€æ£€æµ‹-nginx-é…ç½®æ–‡ä»¶æ˜¯å¦æ­£ç¡®" class="headerlink" title="9ã€æ£€æµ‹ nginx é…ç½®æ–‡ä»¶æ˜¯å¦æ­£ç¡®"></a>9ã€æ£€æµ‹ nginx é…ç½®æ–‡ä»¶æ˜¯å¦æ­£ç¡®</h5><pre class=" language-shell"><code class="language-shell">[root@localhost ~]#/usr/local/nginx/sbin/nginx -t</code></pre><h5 id="10ã€å¯åŠ¨nginxæœåŠ¡"><a href="#10ã€å¯åŠ¨nginxæœåŠ¡" class="headerlink" title="10ã€å¯åŠ¨nginxæœåŠ¡"></a>10ã€å¯åŠ¨nginxæœåŠ¡</h5><pre class=" language-shell"><code class="language-shell">/usr/local/nginx/sbin/nginx</code></pre><h5 id="11ã€é€šè¿‡-nginx-å‘½ä»¤æ§åˆ¶-nginx-æœåŠ¡"><a href="#11ã€é€šè¿‡-nginx-å‘½ä»¤æ§åˆ¶-nginx-æœåŠ¡" class="headerlink" title="11ã€é€šè¿‡ nginx å‘½ä»¤æ§åˆ¶ nginx æœåŠ¡"></a>11ã€é€šè¿‡ nginx å‘½ä»¤æ§åˆ¶ nginx æœåŠ¡</h5><pre class=" language-shell"><code class="language-shell">nginx -c /path/to/nginx.conf       # ä»¥ç‰¹å®šç›®å½•ä¸‹çš„é…ç½®æ–‡ä»¶å¯åŠ¨nginx:nginx -s reload                      # ä¿®æ”¹é…ç½®åé‡æ–°åŠ è½½ç”Ÿæ•ˆnginx -s reopen                     # é‡æ–°æ‰“å¼€æ—¥å¿—æ–‡ä»¶nginx -s stop                        # å¿«é€Ÿåœæ­¢nginxnginx -s quit                         # å®Œæ•´æœ‰åºçš„åœæ­¢nginxnginx -t                         # æµ‹è¯•å½“å‰é…ç½®æ–‡ä»¶æ˜¯å¦æ­£ç¡®nginx -t -c /path/to/nginx.conf  # æµ‹è¯•ç‰¹å®šçš„nginxé…ç½®æ–‡ä»¶æ˜¯å¦æ­£ç¡®</code></pre><h5 id="12ã€å®ç°nginxå¼€æœºè‡ªå¯"><a href="#12ã€å®ç°nginxå¼€æœºè‡ªå¯" class="headerlink" title="12ã€å®ç°nginxå¼€æœºè‡ªå¯"></a>12ã€å®ç°nginxå¼€æœºè‡ªå¯</h5><p> aã€æ·»åŠ å¯åŠ¨è„šæœ¬  vim /etc/init.d/nginx</p><pre class=" language-shell"><code class="language-shell">#!/bin/sh # # nginx - this script starts and stops the nginx daemon # # chkconfig:  - 85 15  # description:  Nginx is an HTTP(S) server, HTTP(S) reverse \ #              proxy and IMAP/POP3 proxy server # processname: nginx # config:      /etc/nginx/nginx.conf # config:      /etc/sysconfig/nginx # pidfile:    /var/run/nginx.pid # Source function library. . /etc/rc.d/init.d/functions# Source networking configuration. . /etc/sysconfig/network# Check that networking is up. [ "$NETWORKING" = "no" ] && exit 0 nginx="/usr/sbin/nginx"prog=$(basename $nginx) NGINX_CONF_FILE="/etc/nginx/nginx.conf"[ -f /etc/sysconfig/nginx ] && . /etc/sysconfig/nginxlockfile=/var/lock/subsys/nginxmake_dirs() {   # make required directories   user=`nginx -V 2>&1 | grep "configure arguments:" | sed 's/[^*]*--user=\([^ ]*\).*/\1/g' -`   options=`$nginx -V 2>&1 | grep 'configure arguments:'`   for opt in $options; do      if [ `echo $opt | grep '.*-temp-path'` ]; then          value=`echo $opt | cut -d "=" -f 2`           if [ ! -d "$value" ]; then              # echo "creating" $value               mkdir -p $value && chown -R $user $value           fi      fi  done} start() {     [ -x $nginx ] || exit 5     [ -f $NGINX_CONF_FILE ] || exit 6     make_dirs     echo -n $"Starting $prog: "    daemon $nginx -c $NGINX_CONF_FILE     retval=$?     echo    [ $retval -eq 0 ] && touch $lockfile     return $retval } stop() {     echo -n $"Stopping $prog: "    killproc $prog -QUIT     retval=$?     echo    [ $retval -eq 0 ] && rm -f $lockfile     return $retval } restart() {     configtest || return $?     stop     sleep 1     start } reload() {     configtest || return $?     echo -n $"Reloading $prog: "    killproc $nginx -HUP     RETVAL=$?     echo} force_reload() {     restart } configtest() {   $nginx -t -c $NGINX_CONF_FILE } rh_status() {     status $prog } rh_status_q() {     rh_status >/dev/null 2>&1 } case "$1" in    start)         rh_status_q && exit 0         $1         ;;     stop)         rh_status_q || exit 0         $1         ;;     restart|configtest)         $1         ;;     reload)         rh_status_q || exit 7         $1         ;;     force-reload)         force_reload         ;;     status)         rh_status         ;;     condrestart|try-restart)         rh_status_q || exit 0             ;;     *)         echo $"Usage: $0 {start|stop|status|restart|condrestart|try-restart|reload|force-reload|configtest}"        exit 2 esac</code></pre><p>bã€æ·»åŠ æƒé™</p><pre class=" language-shell"><code class="language-shell">chmod +x /etc/init.d/nginx</code></pre><p>cã€é‡è½½ç³»ç»Ÿå¯åŠ¨æ–‡ä»¶</p><pre class=" language-shell"><code class="language-shell">systemctl daemon-reload</code></pre><p>dã€è®¾ç½®å¼€æœºè‡ªå¯</p><pre class=" language-shell"><code class="language-shell">systemctl start nginx</code></pre><p>10ã€nginx æ—¥å¿—æ–‡ä»¶è¯¦è§£</p><p>â€‹    nginx æ—¥å¿—æ–‡ä»¶åˆ†ä¸º <strong>log_format</strong> å’Œ <strong>access_log</strong> ä¸¤éƒ¨åˆ†</p><p>â€‹    log_format å®šä¹‰è®°å½•çš„æ ¼å¼ï¼Œå…¶è¯­æ³•æ ¼å¼ä¸º</p><p>â€‹    log_format        æ ·å¼åç§°        æ ·å¼è¯¦æƒ…</p><p>â€‹    é…ç½®æ–‡ä»¶ä¸­é»˜è®¤æœ‰</p><pre><code>log_format  main  &#39;remote_addr - remote_user [time_local] &quot;request&quot; &#39;                  &#39;status body_bytes_sent &quot;$http_referer&quot; &#39;                  &#39;&quot;http_user_agent&quot; &quot;http_x_forwarded_for&quot;&#39;;</code></pre><table><thead><tr><th>ç‚¹å‡»è¿™é‡Œ</th><th>ç‚¹å‡»è¿™é‡Œ</th></tr></thead><tbody><tr><td>å˜é‡</td><td>è¯´æ˜</td></tr><tr><td>$remote_addrå’Œ$http_x_forwarded_for</td><td>å®¢æˆ·ç«¯çš„ip</td></tr><tr><td>$remote_user</td><td>å®¢æˆ·ç«¯çš„åç§°</td></tr><tr><td>$time_local</td><td>è®¿é—®æ—¶çš„æœ¬åœ°æ—¶é—´</td></tr><tr><td>$request</td><td>è¯·æ±‚çš„URLå’Œhttpåè®®</td></tr><tr><td>$status</td><td>è®¿é—®çš„çŠ¶æ€ç </td></tr><tr><td>$body_bytes_sent</td><td>å‘é€ç»™å®¢æˆ·ç«¯çš„ä¸»ä½“å†…å®¹å¤§å°</td></tr><tr><td>$http_referer</td><td>è®°å½•å®¢æˆ·ç«¯æ˜¯ä»å“ªä¸ªé¡µé¢é“¾æ¥è®¿é—®è¿‡æ¥çš„ï¼Œè‹¥æ²¡æœ‰é“¾æ¥ï¼Œåˆ™è®¿é—®â€˜-â€™</td></tr><tr><td>$http_user_agent</td><td>è®°å½•å®¢æˆ·ç«¯ä½¿ç”¨çš„æµè§ˆå™¨çš„ç›¸å…³ä¿¡æ¯</td></tr></tbody></table>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Nginx </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>iptablesç¬”è®°</title>
      <link href="2019/02/28/linux/iptables-bi-ji/"/>
      <url>2019/02/28/linux/iptables-bi-ji/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h3 id="é˜²ç«å¢™ä¹‹-iptables"><a href="#é˜²ç«å¢™ä¹‹-iptables" class="headerlink" title="é˜²ç«å¢™ä¹‹ iptables"></a>é˜²ç«å¢™ä¹‹ iptables</h3><h2 id="1-1-å®‰å…¨ä¼˜åŒ–é…ç½®åŸåˆ™"><a href="#1-1-å®‰å…¨ä¼˜åŒ–é…ç½®åŸåˆ™" class="headerlink" title="1.1 å®‰å…¨ä¼˜åŒ–é…ç½®åŸåˆ™"></a>1.1 å®‰å…¨ä¼˜åŒ–é…ç½®åŸåˆ™</h2><p>å°½å¯èƒ½ä¸ç»™æœåŠ¡å™¨é…ç½®å¤–ç½‘ip ,å¯ä»¥é€šè¿‡ä»£ç†è½¬å‘æˆ–è€…é€šè¿‡é˜²ç«å¢™æ˜ å°„.å¹¶å‘ä¸æ˜¯ç‰¹åˆ«å¤§æƒ…å†µæœ‰å¤–ç½‘ip,å¯ä»¥å¼€å¯é˜²ç«å¢™æœåŠ¡.</p><p>å¤§å¹¶å‘çš„æƒ…å†µï¼Œä¸èƒ½å¼€iptables,å½±å“æ€§èƒ½ï¼Œåˆ©ç”¨ç¡¬ä»¶é˜²ç«å¢™æå‡æ¶æ„å®‰å…¨</p><h3 id="1-1-1-ç”Ÿäº§ä¸­-iptables-çš„å®é™…åº”ç”¨"><a href="#1-1-1-ç”Ÿäº§ä¸­-iptables-çš„å®é™…åº”ç”¨" class="headerlink" title="1.1.1 ç”Ÿäº§ä¸­ iptables çš„å®é™…åº”ç”¨"></a>1.1.1 ç”Ÿäº§ä¸­ iptables çš„å®é™…åº”ç”¨</h3><p>ä¸»è¦åº”ç”¨æ–¹å‘</p><p>1ã€ä¸»æœºé˜²ç«å¢™ï¼ˆfilterè¡¨çš„INPUTé“¾ï¼‰ã€‚</p><p>2ã€å±€åŸŸç½‘å…±äº«ä¸Šç½‘(nat è¡¨çš„ POSTROUTING é“¾)ã€‚åŠä¸ªè·¯ç”±å™¨ï¼ŒNATåŠŸèƒ½ã€‚</p><p>3ã€ç«¯å£åŠIPæ˜ å°„(nat è¡¨çš„ PREROUTING é“¾)ï¼Œç¡¬é˜²çš„NATåŠŸèƒ½ã€‚</p><p>4ã€IPä¸€å¯¹ä¸€æ˜ å°„ã€‚</p><p><strong>å…¶ä»–è¯´æ˜ï¼š</strong></p><blockquote><p> â‘ iptablesæ˜¯åŸºäºå†…æ ¸çš„é˜²ç«å¢™ï¼ŒåŠŸèƒ½éå¸¸å¼ºå¤§ï¼ŒåŸºäºæ•°æ®åŒ…çš„è¿‡æ»¤ï¼ç‰¹åˆ«æ˜¯å¯ä»¥åœ¨ä¸€å°éå¸¸ä½çš„ç¡¬ä»¶é…ç½®ä¸‹è·‘çš„éå¸¸å¥½ã€‚</p><p> ã€€ã€€<strong>æ³¨ï¼š</strong>iptablesä¸»è¦å·¥ä½œåœ¨OSIä¸ƒå±‚çš„2.3.4å±‚ã€‚ä¸ƒå±‚çš„æ§åˆ¶å¯ä»¥ä½¿ç”¨squidä»£ç†+iptablesã€‚</p><p> â‘¡iptabesï¼šç”Ÿäº§ä¸­æ ¹æ®å…·ä½“æƒ…å†µï¼Œä¸€èˆ¬ï¼Œå†…ç½‘å…³é—­ï¼Œå¤–ç½‘æ‰“å¼€ã€‚å¤§å¹¶å‘çš„æƒ…å†µä¸èƒ½å¼€iptablesï¼Œå½±å“æ€§èƒ½ï¼Œiptablesæ˜¯è¦æ¶ˆè€—CPUçš„ï¼Œæ‰€ä»¥å¤§å¹¶å‘çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä½¿ç”¨ç¡¬ä»¶é˜²ç«å¢™çš„å„æ–¹é¢åšçš„å¾ˆä»”ç»†ã€‚selinuxï¼šç”Ÿäº§ä¸­ä¹Ÿæ˜¯å…³é—­çš„ã€‚å¯ä»¥åšidsçš„å…¥ä¾µæ£€æµ‹ã€‚</p><p> â‘¢å®é™…ç”Ÿäº§ä¸­å°½å¯èƒ½ä¸ç»™æœåŠ¡å™¨é…ç½®å¤–ç½‘IPã€‚å¯ä»¥é€šè¿‡ä»£ç†è½¬å‘ã€‚æ¯”å¦‚ï¼Œnagioså°±ä¸éœ€è¦å¤–ç½‘ã€‚</p><p> â‘£å¹¶å‘ä¸æ˜¯å¾ˆå¤§çš„æƒ…å†µä¸‹ï¼Œå†å¤–ç½‘çš„IPç¯å¢ƒï¼Œå¼€é˜²ç«å¢™ã€‚</p><p> â‘¤ç¬¬ä¸€æ¬¡ç›´æ¥é»˜è®¤è§„åˆ™ç”Ÿæˆé…ç½®æ–‡ä»¶ï¼Œä»¥åå°±åœ¨é…ç½®æ–‡ä»¶ä¸­è¿›è¡Œä¿®æ”¹ï¼ˆç¼–è¾‘æ·»åŠ åˆ é™¤ï¼‰ã€‚</p><p> â‘¥å°æ‰IPï¼šæ ¹æ®IPåœ°å€å’Œç½‘ç»œè¿æ¥æ•°è¿›è¡Œå°æ€ã€‚ï¼ˆå®šæ—¶ä»»åŠ¡ï¼Œå®šæ—¶å°æ‰ï¼Œåˆ¤æ–­ï¼Œå­˜åœ¨å°±ä¸å†è¿›è¡ŒäºŒæ¬¡å°æ€ï¼‰</p></blockquote><h3 id="1-1-2-å¸¸ç”¨æ¡ˆä¾‹åŠŸèƒ½å°ç»“ï¼š"><a href="#1-1-2-å¸¸ç”¨æ¡ˆä¾‹åŠŸèƒ½å°ç»“ï¼š" class="headerlink" title="1.1.2 å¸¸ç”¨æ¡ˆä¾‹åŠŸèƒ½å°ç»“ï¼š"></a>1.1.2 å¸¸ç”¨æ¡ˆä¾‹åŠŸèƒ½å°ç»“ï¼š</h3><p>1ï¼‰linuxä¸»æœºé˜²ç«å¢™ï¼Œå•æœºä½œä¸ºé˜²ç«å¢™ï¼ˆè¡¨filterï¼‰ã€‚</p><p>2ï¼‰å±€åŸŸç½‘å…±äº«ä¸Šç½‘ï¼ˆè¡¨nat postroutingï¼‰ã€‚</p><p>3ï¼‰å¤–éƒ¨åœ°å€æ˜ å°„ä¸ºå†…éƒ¨åœ°å€å’Œç«¯å£ï¼ˆè¡¨nat preroutingï¼‰</p><h2 id="1-2-iptables-é˜²ç«å¢™ç®€ä»‹"><a href="#1-2-iptables-é˜²ç«å¢™ç®€ä»‹" class="headerlink" title="1.2 iptables é˜²ç«å¢™ç®€ä»‹"></a>1.2 iptables é˜²ç«å¢™ç®€ä»‹</h2><p>Netfilter/Iptables(ä»¥ä¸‹ç®€ç§°Iptables)æ˜¯unix/linuxè‡ªå¸¦çš„ä¸€æ¬¾ä¼˜ç§€ä¸”å¼€æ”¾æºä»£ç çš„å®Œå…¨è‡ªç”±çš„åŸºäºåŒ…è¿‡æ»¤çš„é˜²ç«å¢™å·¥å…·ï¼Œå®ƒçš„åŠŸèƒ½ååˆ†å¼ºå¤§ï¼Œä½¿ç”¨éå¸¸çµæ´»ï¼Œå¯ä»¥å¯¹æµå…¥å’Œæµå‡ºæœåŠ¡å™¨çš„æ•°æ®åŒ…è¿›è¡Œå¾ˆç²¾ç»†çš„æ§åˆ¶.ç‰¹åˆ«æ˜¯å®ƒå¯ä»¥åœ¨ä¸€å°éå¸¸ä½çš„ç¡¬ä»¶é…ç½®æœåŠ¡å™¨ä¸Šè·‘çš„éå¸¸å¥½ï¼ˆèµ›æ‰¬500HZ cpu 64M å†…å­˜çš„æƒ²å†µä¸‹éƒ¨ç½²ç½‘å…³é˜²ç«å¢™ï¼‰ï¼Œæä¾›è¿‘400äººçš„ä¸Šç½‘æœåŠ¡ä¸æ¯«ä¸é€Šè‰²ä¸“ä¸šè·¯ç”±å™¨é˜²ç«å¢™ã€‚ iptables + zebra + squid (å¸¸ç”¨ç½‘ç»œå¼€æºäº§å“ï¼‰ã€‚</p><p>   iptablesæ˜¯linux2.4åŠ2.6å†…æ ¸ä¸­é›†æˆçš„æœåŠ¡ï¼Œå…¶åŠŸèƒ½ä¸å®‰å…¨æ€§æ¯”å…¶è€ä¸€èœšipfwadmï¼Œipchains å¼ºå¤§çš„å¤šï¼Œiptablesä¸»è¦å·¥ä½œåœ¨0SIä¸ƒå±‚çš„äºŒã€ä¸‰ã€å››å±‚ï¼Œå¦‚æœé‡æ–°ç¼–è¯‘å†…æ ¸ï¼Œiptablesä¹Ÿå¯ä»¥æ”¯æŒ 7 å±‚æ§åˆ¶ï¼ˆsquidä»£ç†+iptablesï¼‰ã€‚</p><h3 id="1-2-1-iptablesåè¯å’Œæœ¯è¯­"><a href="#1-2-1-iptablesåè¯å’Œæœ¯è¯­" class="headerlink" title="1.2.1 iptablesåè¯å’Œæœ¯è¯­"></a>1.2.1 iptablesåè¯å’Œæœ¯è¯­</h3><p>ä¸å°‘åˆšæ¥è§¦åˆ°iptablesçš„æœ‹å‹å¯èƒ½ä¼šå¯¹iptablesé˜²ç«å¢™çš„ç›¸å…³åè¯æçš„å¾ˆæ™•ï¼Œä¸çŸ¥é“å…¶æ‰€äº‘çš„å…·ä½“æ„æ€ï¼Œè€Œæ˜¯å°±æœ€åŸºæœ¬çš„èƒ½è®©å¤§å®¶å®¹æ˜“å¿«é€Ÿç†è§£å’ŒæŒæ¡çš„æ€è·¯æ¥æè¿°ï¼š</p><p>å®¹å™¨ï¼šåŒ…å«æˆ–è€…è¯´å±äºçš„å…³ç³»</p><h3 id="1-2-2-ä»€ä¹ˆæ˜¯å®¹å™¨"><a href="#1-2-2-ä»€ä¹ˆæ˜¯å®¹å™¨" class="headerlink" title="1.2.2 ä»€ä¹ˆæ˜¯å®¹å™¨"></a>1.2.2 ä»€ä¹ˆæ˜¯å®¹å™¨</h3><p>è°ä¸çŸ¥é“å•Šï¼Œå®¹å™¨å°±æ˜¯è£…ä¸œè¥¿çš„ï¼Œå¦‚ï¼ˆç®±ã€åŒ…ã€å›ï¼‰ã€‚æ²¡é”™ï¼Œæ­å–œä½ ç­”å¯¹äº†.è¯å…¸é‡Œè§£é‡Šè¯´ï¼Œå®¹å™¨å°±æ˜¯ç”¨æ¥åŒ…è£…æˆ–è£…è½½ç‰©å“çš„è´®å­˜å™¨ï¼ˆå¦‚ç®±ã€ç½ã€å›ï¼‰æˆ–è€…æˆå½¢æˆ–æŸ”è½¯ä¸æˆå½¢çš„åŒ…è¦†ææ–™.</p><p>åœ¨iptablesé‡Œçš„å‘¢ï¼Œå°±æ˜¯ç”¨æ¥æè¿°è¿™ç§åŒ…å«æˆ–è€…è¯´å±äºçš„å…³ç³»ã€‚</p><h3 id="1-2-3-ä»€ä¹ˆæ˜¯-Netfilter-iptables"><a href="#1-2-3-ä»€ä¹ˆæ˜¯-Netfilter-iptables" class="headerlink" title="1.2.3 ä»€ä¹ˆæ˜¯ Netfilter/iptables ?"></a>1.2.3 ä»€ä¹ˆæ˜¯ Netfilter/iptables ?</h3><p>Netfilteræ˜¯è¡¨ï¼ˆtablesï¼‰çš„å®¹å™¨ï¼Œè¿™æ ·è§£é‡Šå¤§å®¶è‚¯å®šè¿˜æ˜¯æ™•ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœæŠŠNetfilterçœ‹æˆæ˜¯æŸä¸ªå°åŒºçš„ä¸€æ ‹æ¥¼ã€‚é‚£ä¹ˆè¡¨ï¼ˆtables)å°±æ˜¯æ¥¼é‡Œçš„å…¶ä¸­çš„ä¸€å¥—æˆ¿å­ã€‚è¿™å¥—æˆ¿å­â€è¡¨ï¼ˆtables)â€å±äºè¿™æ ‹â€œNetfilterâ€ã€‚</p><h3 id="1-2-4-ä»€ä¹ˆæ˜¯è¡¨ï¼ˆtablesï¼‰ï¼Ÿ"><a href="#1-2-4-ä»€ä¹ˆæ˜¯è¡¨ï¼ˆtablesï¼‰ï¼Ÿ" class="headerlink" title="1.2.4 ä»€ä¹ˆæ˜¯è¡¨ï¼ˆtablesï¼‰ï¼Ÿ"></a>1.2.4 ä»€ä¹ˆæ˜¯è¡¨ï¼ˆtablesï¼‰ï¼Ÿ</h3><p>è¡¨ï¼ˆtablesï¼‰æ˜¯é“¾çš„å®¹å™¨ï¼Œå³æ‰€æœ‰çš„é“¾ï¼ˆchainsï¼‰éƒ½å±äºå…¶å¯¹åº”çš„è¡¨ï¼ˆtablesï¼‰.å¦‚ä¸Šï¼Œå¦‚æœæŠŠNetfilterçœ‹æˆæ˜¯æŸä¸ªå°åŒºçš„ä¸€æ ‹æ¥¼.é‚£ä¹ˆè¡¨ï¼ˆtablesï¼‰å°±æ˜¯æ¥¼é‡Œçš„å…¶ä¸­çš„ä¸€å¥—æˆ¿å­ã€‚</p><h3 id="1-2-5-ä»€ä¹ˆæ˜¯é“¾ï¼ˆchainsï¼‰ï¼Ÿ"><a href="#1-2-5-ä»€ä¹ˆæ˜¯é“¾ï¼ˆchainsï¼‰ï¼Ÿ" class="headerlink" title="1.2.5 ä»€ä¹ˆæ˜¯é“¾ï¼ˆchainsï¼‰ï¼Ÿ"></a>1.2.5 ä»€ä¹ˆæ˜¯é“¾ï¼ˆchainsï¼‰ï¼Ÿ</h3><p>é“¾ï¼ˆchainsï¼‰æ˜¯è§„åˆ™ï¼ˆPolicysï¼‰çš„å®¹å™¨ã€‚æ¥ä¸Šï¼Œå¦‚æœæŠŠè¡¨ï¼ˆtablesï¼‰å½“ä½œæœ‰ä¸€å¥—æˆ¿å­ï¼Œé‚£ä¹ˆé“¾ï¼ˆchainsï¼‰å°±å¯ä»¥è¯´æ˜¯æˆ¿å­é‡Œçš„å®¶å…·ï¼ˆæŸœå­ç­‰ï¼‰ã€‚</p><h3 id="1-2-6-ä»€ä¹ˆæ˜¯è§„åˆ™ï¼ˆPolicyï¼‰ï¼Ÿ"><a href="#1-2-6-ä»€ä¹ˆæ˜¯è§„åˆ™ï¼ˆPolicyï¼‰ï¼Ÿ" class="headerlink" title="1.2.6 ä»€ä¹ˆæ˜¯è§„åˆ™ï¼ˆPolicyï¼‰ï¼Ÿ"></a>1.2.6 ä»€ä¹ˆæ˜¯è§„åˆ™ï¼ˆPolicyï¼‰ï¼Ÿ</h3><p>è§„åˆ™ï¼ˆPolicyï¼‰å°±æ¯”è¾ƒå®¹æ˜“ç†è§£äº†ï¼Œå°±æ˜¯iptablesç³»åˆ—è¿‡æ»¤ä¿¡æ¯çš„è§„èŒƒå’Œå…·ä½“æ–¹æ³•æ¡æ¬¾äº†.å¯ä»¥ç†è§£ä¸ºæŸœå­å¦‚ä½•å¢åŠ å¹¶æ‘†æ”¾æŸœå­ä¸œè¥¿ç­‰ã€‚</p><p>åŸºæœ¬æœ¯è¯­å¦‚ä¸‹è¡¨æ ¼æ‰€ç¤ºï¼š</p><table><thead><tr><th><strong>Netfilter</strong></th><th><strong>è¡¨ï¼ˆtables**</strong>ï¼‰**</th><th><strong>é“¾ï¼ˆchains**</strong>ï¼‰**</th><th><strong>è§„åˆ™ï¼ˆPolicy**</strong>ï¼‰**</th></tr></thead><tbody><tr><td><strong>ä¸€æ ‹æ¥¼</strong></td><td>æ¥¼é‡Œçš„æˆ¿å­</td><td>æˆ¿å­é‡Œçš„æŸœå­</td><td>æŸœå­é‡Œè¡£æœï¼Œæ‘†æ”¾è§„åˆ™</td></tr></tbody></table><h2 id="1-3-iptables-è¡¨å’Œé“¾"><a href="#1-3-iptables-è¡¨å’Œé“¾" class="headerlink" title="1.3 iptables è¡¨å’Œé“¾"></a>1.3 iptables è¡¨å’Œé“¾</h2><p>æè¿°å®Œiptablesæœ¯è¯­åï¼Œç›¸ä¿¡å¤§å®¶å¯¹iptablesçš„è¡¨å’Œé“¾æœ‰äº†åˆæ­¥çš„äº†è§£äº†ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œiptablesæ ¹æ®åŠŸèƒ½å’Œè¡¨çš„å®šä¹‰åˆ’åˆ†åŒ…å«ä¸‰ä¸ªè¡¨ï¼Œfilter,nat,mangle,å…¶æ¯ä¸ªè¡¨åˆåŒ…å«ä¸åŒçš„æ“ä½œé“¾ï¼ˆchains )ã€‚ å®é™…iptablesåŒ…å«4å¼ è¡¨å’Œäº”ä¸ªé“¾,å·§ä¸»è¦è®°ä½ä¸¤å¼ è¡¨å³å¯filterå’Œnatè¡¨å³å¯ã€‚</p><p>ä¸‹é¢è¡¨æ ¼å±•ç¤ºäº†è¡¨å’Œé“¾çš„å¯¹åº”å…³ç³»ã€‚</p><p><strong>å››ä¸ªè¡¨ï¼š</strong></p><table><thead><tr><th><strong>è¡¨ï¼ˆtables**</strong>ï¼‰**</th><th><strong>é“¾ï¼ˆchains**</strong>ï¼‰**</th></tr></thead><tbody><tr><td><strong>Filter</strong> 1</td><td>è¿™æ˜¯é»˜è®¤è¡¨ï¼Œå®ç°é˜²ç«å¢™æ•°æ®è¿‡æ»¤åŠŸèƒ½ã€‚</td></tr><tr><td>1-<strong>INPUT</strong></td><td>å¯¹äºæŒ‡å®šåˆ°æœ¬åœ°å¥—æ¥å­—çš„åŒ…ï¼Œå³åˆ°è¾¾æœ¬åœ°é˜²ç«å¢™æœåŠ¡å™¨çš„æ•°æ®åŒ…ã€‚</td></tr><tr><td>1-<strong>FORWARD</strong></td><td>è·¯ç”±ç©¿è¿‡çš„æ•°æ®åŒ…ï¼Œå³ç»è¿‡æœ¬åœ°é˜²ç«å¢™æœåŠ¡å™¨çš„æ•°æ®åŒ…ã€‚</td></tr><tr><td>1-<strong>OUTPUT</strong></td><td>æœ¬åœ°åˆ›å»ºçš„æ•°æ®åŒ…</td></tr><tr><td><strong>NAT</strong>2</td><td>å½“é‡åˆ°æ–°åˆ›å»ºçš„æ•°æ®åŒ…è¿æ¥æ—¶å°†å‚è€ƒè¿™ä¸ªè¡¨</td></tr><tr><td>2-<strong>FREROUTING</strong></td><td>ä¸€è¿›æ¥å°±å¯¹æ•°æ®åŒ…è¿›è¡Œæ”¹å˜</td></tr><tr><td>2-<strong>OUTPUT</strong></td><td>æœ¬åœ°åˆ›å»ºçš„æ•°æ®åŒ…åœ¨è·¯ç”±å‰è¿›è¡Œæ”¹å˜</td></tr><tr><td>2-<strong>POSTROUTING</strong></td><td>åœ¨æ•°æ®åŒ…å³å°†å‡ºå»æ—¶æ”¹å˜æ•°æ®åŒ…ä¿¡æ¯</td></tr><tr><td><strong>Mangle</strong>3</td><td>è¿™ä¸ªè¡¨ä¸“é—¨ç”¨äºæ”¹å˜æ•°æ®åŒ…</td></tr><tr><td>3-<strong>INPUT</strong></td><td>è¿›å…¥åˆ°è®¾å¤‡æœ¬èº«çš„åŒ…</td></tr><tr><td>3-<strong>FORWARD</strong></td><td>å¯¹è·¯ç”±åçš„æ•°æ®åŒ…ä¿¡æ¯è¿›è¡Œä¿®æ”¹</td></tr><tr><td>3-<strong>FREROUTING</strong></td><td>åœ¨è·¯ç”±ä¹‹å‰æ›´æ”¹ä¼ å…¥çš„åŒ…</td></tr><tr><td>3-<strong>OUTPUT</strong></td><td>æœ¬åœ°åˆ›å»ºçš„æ•°æ®åŒ…åœ¨è·¯ç”±ä¹‹å‰æ”¹å˜</td></tr><tr><td>3-<strong>POSTROUTING</strong></td><td>åœ¨æ•°æ®åŒ…å³å°†ç¦»å¼€æ—¶æ›´æ”¹æ•°æ®åŒ…ä¿¡æ¯</td></tr><tr><td><strong>raw</strong>4</td><td><strong>æ­¤è¡¨ç”¨å¤„è¾ƒå°‘ï¼Œå¯ä»¥å¿½ç•¥ä¸è®¡ã€‚</strong>This  table is used mainly for configuring exemptions from connection tracking in combination with the  NOTRACK  target.</td></tr><tr><td>4-<strong>PREROUTING</strong></td><td>for packets arriving via any network interface</td></tr><tr><td>4-<strong>OUTPUT</strong></td><td>for packets  generated by local processes</td></tr></tbody></table><p><strong>äº”ä¸ªé“¾</strong></p><table><thead><tr><th><strong>è¡¨ï¼ˆtables**</strong>ï¼‰**</th><th><strong>é“¾ï¼ˆchains**</strong>ï¼‰**</th><th></th><th></th><th></th><th></th></tr></thead><tbody><tr><td>INPUT</td><td>FORWARD</td><td>OUTPUT</td><td>PREROUTING</td><td>POSTROUTING</td><td></td></tr><tr><td><strong>Filter</strong></td><td>âˆš</td><td>âˆš</td><td>âˆš</td><td>Ã—</td><td>Ã—</td></tr><tr><td><strong>NAT</strong></td><td><strong>Ã—</strong></td><td>Ã—</td><td>âˆš</td><td>âˆš</td><td>âˆš</td></tr><tr><td><strong>Managle</strong></td><td>âˆš</td><td>âˆš</td><td>âˆš</td><td>âˆš</td><td>âˆš</td></tr><tr><td><strong>raw</strong></td><td>Ã—</td><td>Ã—</td><td>âˆš</td><td>âˆš</td><td>Ã—</td></tr><tr><td>è¯´æ˜ï¼šâˆš è¡¨ç¤ºæœ‰ï¼ŒÃ— è¡¨ç¤ºæ— ã€‚</td><td></td><td></td><td></td><td></td><td></td></tr></tbody></table><p><img src="https://s1.ax1x.com/2020/04/26/JRnutO.png" alt="JRnutO.png"></p><p>å›¾ - iptablesä¸­çš„è¡¨ä¸é“¾çš„ç»“æ„å…³ç³»</p><h3 id="1-3-1-filterè¡¨çš„è¯¦ç»†ä»‹ç»"><a href="#1-3-1-filterè¡¨çš„è¯¦ç»†ä»‹ç»" class="headerlink" title="1.3.1 filterè¡¨çš„è¯¦ç»†ä»‹ç»"></a>1.3.1 filterè¡¨çš„è¯¦ç»†ä»‹ç»</h3><table><thead><tr><th><strong>filter**</strong>è¡¨**</th><th>ä¸»è¦å’Œä¸»æœºè‡ªèº«ç›¸å…³ï¼ŒçœŸæ­£è´Ÿè´£ä¸»æœºé˜²ç«å¢™åŠŸèƒ½çš„ï¼ˆè¿‡æ»¤æµå…¥æµå‡ºä¸»æœºçš„æ•°æ®åŒ…ï¼‰filterè¡¨æ˜¯iptablesé»˜è®¤ä½¿ç”¨çš„è¡¨ï¼Œè¿™ä¸ªè¡¨å®šä¹‰äº†ä¸‰ä¸ªé“¾ï¼ˆchainsï¼‰<strong>å·¥ä½œåœºæ™¯:**</strong>ä¸»æœºé˜²ç«å¢™**</th></tr></thead><tbody><tr><td><strong>INPUT</strong></td><td>è´Ÿè´£è¿‡æ»¤æ‰€æœ‰ç›®æ ‡æ˜¯æœ¬æœºåœ°å€çš„æ•°æ®åŒ…é€šä¿—æ¥è¯´ï¼šå°±æ˜¯è¿‡æ»¤è¿›å…¥ä¸»æœºçš„æ•°æ®åŒ…</td></tr><tr><td><strong>FORWARD</strong></td><td>è´Ÿè´£è½¬å‘æµç»ä¸»æœºçš„æ•°æ®åŒ…ã€‚èµ·åˆ°è½¬å‘çš„ä½œç”¨ï¼Œå’ŒNATå…³ç³»å¾ˆå¤§ã€‚LVS NAT æ¨¡å¼ï¼Œnet.ipv4.ip_forward=0</td></tr><tr><td><strong>OUTPUT</strong></td><td>å¤„ç†æ‰€æœ‰æºåœ°å€æ˜¯æœ¬æœºåœ°å€çš„æ•°æ®åŒ…é€šä¿—çš„è®²ï¼šå°±æ˜¯å¤„ç†ä»ä¸»æœºå‘å‡ºçš„æ•°æ®åŒ…</td></tr></tbody></table><p>   å¯¹äºfilterè¡¨çš„æ§åˆ¶æ˜¯æˆ‘ä»¬å®ç°æœ¬æœºé˜²ç«å¢™åŠŸèƒ½çš„é‡è¦æ‰‹æ®µï¼Œç‰¹åˆ«æ˜¯INPUTé“¾çš„æ§åˆ¶ã€‚</p><h3 id="1-3-2-NATè¡¨ä¿¡æ¯è¯¦ç»†ä»‹ç»"><a href="#1-3-2-NATè¡¨ä¿¡æ¯è¯¦ç»†ä»‹ç»" class="headerlink" title="1.3.2 NATè¡¨ä¿¡æ¯è¯¦ç»†ä»‹ç»"></a>1.3.2 NATè¡¨ä¿¡æ¯è¯¦ç»†ä»‹ç»</h3><table><thead><tr><th>NATè¡¨</th><th>è´Ÿè´£ç½‘ç»œåœ°å€è½¬æ¢çš„ï¼Œå³æ¥æºä¸ç›®çš„çš„IPåœ°å€å’Œportçš„è½¬æ¢ã€‚åº”ç”¨ï¼šå’Œä¸»æœºæœ¬èº«æ— å…³ï¼Œä¸€èˆ¬ç”¨äºå±€åŸŸç½‘å…±äº«ä¸Šç½‘æˆ–è€…ç‰¹æ®Šçš„ç«¯å£è½¬æ¢ç›¸å…³.<strong>å·¥ä½œåœºæ™¯ï¼š</strong>1ã€ç”¨äºè·¯ç”±(zebra)æˆ–ç½‘å…³(iptables),å…±äº«ä¸Šç½‘(POSTROUTING)2ã€åšå†…éƒ¨å¤–éƒ¨IPåœ°å€ä¸€å¯¹ä¸€æ˜ å°„(dmz),ç¡¬ä»¶é˜²ç«å¢™æ˜ å°„IPåˆ°å†…éƒ¨æœåŠ¡å™¨ï¼ŒFTPæœåŠ¡(PREROUTING)3ã€WEB,å•ä¸ªç«¯å£çš„æ˜ å°„ï¼Œç›´æ¥æ˜ å°„80ç«¯å£(PREROUTING)è¿™ä¸ªè¡¨å®šä¹‰äº†3ä¸ªé“¾ï¼ŒnatåŠŸèƒ½ç›¸å½“äºç½‘ç»œçš„aclæ§åˆ¶ã€‚å’Œç½‘ç»œäº¤æ¢æœºaclç±»ä¼¼ã€‚</th></tr></thead><tbody><tr><td><strong>OUTPUT</strong></td><td>å’Œä¸»æœºæ”¾å‡ºå»çš„æ•°æ®åŒ…æœ‰å…³ï¼Œæ”¹å˜ä¸»æœºå‘å‡ºæ•°æ®åŒ…çš„ç›®çš„åœ°å€ã€‚</td></tr><tr><td><strong>PREROUTING</strong></td><td>åœ¨æ•°æ®åŒ…åˆ°è¾¾é˜²ç«å¢™æ—¶ï¼Œè¿›è¡Œè·¯ç”±åˆ¤æ–­ä¹‹å‰æ‰§è¡Œçš„è§„åˆ™ï¼Œä½œç”¨æ˜¯æ”¹å˜æ•°æ®åŒ…çš„ç›®çš„åœ°å€ã€ç›®çš„ç«¯å£ç­‰å°±æ˜¯æ”¶ä¿¡æ—¶ï¼Œæ ¹æ®è§„åˆ™é‡å†™æ”¶ä»¶äººçš„åœ°å€ä¾‹å¦‚ï¼šæŠŠå…¬ç½‘IPï¼š xxx.xxx.xxx.xxx æ˜ å°„åˆ°å±€åŸŸç½‘çš„ x.x.x.x æœåŠ¡å™¨å¦‚æœæ˜¯webæœåŠ¡ï¼Œå¯ä»¥æŠŠ80è½¬æ¢ä¸ºå±€åŸŸç½‘çš„æœåŠ¡å™¨9000ç«¯å£ä¸Šã€‚</td></tr><tr><td><strong>POSTROUTING</strong></td><td>åœ¨æ•°æ®åŒ…ç¦»å¼€é˜²ç«å¢™æ—¶è¿›è¡Œè·¯ç”±åˆ¤æ–­ä¹‹åæ‰§è¡Œçš„è§„åˆ™ï¼Œä½œç”¨æ”¹å˜æ•°æ®åŒ…çš„æºåœ°å€ï¼Œæºç«¯å£ç­‰ã€‚å†™å¥½æ”¶ä»¶äººçš„åœ°å€ï¼Œè¦è®©å®¶äººå›ä¿¡æ—¶èƒ½å¤Ÿæœ‰åœ°å€å¯å›ã€‚ä¾‹å¦‚ã€‚é»˜è®¤ç¬”è®°æœ¬å’Œè™šæ‹Ÿæœºéƒ½æ˜¯å±€åŸŸç½‘åœ°å€ï¼Œåœ¨å‡ºç½‘çš„æ—¶å€™è¢«è·¯ç”±å™¨å°†æºåœ°å€æ”¹ä¸ºå…¬ç½‘åœ°å€ã€‚<strong>ç”Ÿäº§åº”ç”¨ï¼š</strong>å±€åŸŸç½‘å…±äº«ä¸Šç½‘ã€‚</td></tr></tbody></table><h3 id="1-3-3-Mangleè¡¨ä¿¡æ¯è¯¦ç»†ä»‹ç»"><a href="#1-3-3-Mangleè¡¨ä¿¡æ¯è¯¦ç»†ä»‹ç»" class="headerlink" title="1.3.3 Mangleè¡¨ä¿¡æ¯è¯¦ç»†ä»‹ç»"></a>1.3.3 Mangleè¡¨ä¿¡æ¯è¯¦ç»†ä»‹ç»</h3><table><thead><tr><th>Mangleè¡¨</th><th>ä¸»è¦è´Ÿè´£ä¿®æ”¹æ•°æ®åŒ…ä¸­ç‰¹æ®Šçš„è·¯ç”±æ ‡è®°ï¼Œå¦‚TTL,TOS,MARKç­‰ï¼Œè¿™ä¸ªè¡¨å®šä¹‰äº†5ä¸ªé“¾(chains).</th></tr></thead><tbody><tr><td></td><td></td></tr></tbody></table><p>ç”±äºè¿™ä¸ªè¡¨ä¸ç‰¹æ®Šæ ‡è®°ç›¸å…³ï¼Œä¸€èˆ¬å€©å†µä¸‹ï¼Œæˆ‘ä»¬ç”¨ä¸åˆ°è¿™ä¸ªmangleè¡¨ã€‚</p><p>è¿™é‡Œå°±ä¸åšè¯¦ç»†ä»‹ç»äº†ã€‚</p><h2 id="1-4-iptableså·¥ä½œæµç¨‹"><a href="#1-4-iptableså·¥ä½œæµç¨‹" class="headerlink" title="1.4 iptableså·¥ä½œæµç¨‹"></a>1.4 iptableså·¥ä½œæµç¨‹</h2><h3 id="1-4-1-å·¥ä½œæµç¨‹è¯´æ˜"><a href="#1-4-1-å·¥ä½œæµç¨‹è¯´æ˜" class="headerlink" title="1.4.1 å·¥ä½œæµç¨‹è¯´æ˜"></a>1.4.1 å·¥ä½œæµç¨‹è¯´æ˜</h3><p>å‰é¢ä»‹ç»å·²ç»æåˆ°ï¼Œiptablesæ˜¯é‡‡ç”¨æ•°æ®åŒ…è¿‡æ»¤æœºåˆ¶å·¥ä½œçš„ï¼Œæ‰€ä»¥å®ƒä¼šå¯¹è¯·æ±‚çš„æ•°æ®åŒ…çš„åŒ…å¤´æ•°æ®è¿›è¡Œåˆ†æï¼Œå¹¶æ ¹æ®æˆ‘ä»¬é¢„å…ˆè®¾å®šçš„è§„åˆ™è¿›è¡ŒåŒ¹é…æ¥å†³å®šæ˜¯å¦å¯ä»¥è¿›å…¥ä¸»æœºã€‚</p><p>iptablesæ˜¯é‡‡ç”¨æ•°æ®åŒ…è¿‡æ»¤æœºåˆ¶å·¥ä½œçš„ï¼Œæ‰€ä»¥å®ƒä¼šå¯¹è¯·æ±‚çš„æ•°æ®åŒ…çš„åŒ…å¤´æ•°æ®è¿›è¡Œåˆ†æï¼Œå¹¶æ ¹æ®æˆ‘ä»¬é¢„å…ˆè®¾å®šçš„è§„åˆ™è¿›è¡ŒåŒ¹é…æ¥å†³å®šæ˜¯å¦å¯ä»¥è¿›å…¥ä¸»æœºã€‚</p><p>æ•°æ®åŒ…çš„æµå‘æ˜¯ä»å·¦å‘å³çš„ã€‚</p><p><img src="https://s1.ax1x.com/2020/04/26/JRnXCD.png" alt="JRnXCD.png">å›¾ - iptablesåŒ…å¤„ç†æµç¨‹å›¾</p><p> <img src="https://s1.ax1x.com/2020/04/26/JRupDI.png" alt="JRupDI.png"></p><p>å›¾ - iptablesåŒ…å¤„ç†æµç¨‹å›¾(ç®€åŒ–)</p><p><strong>æŠ½è±¡è¯´æ˜ï¼š</strong>ä¸Šå›¾å¯ä»¥ç”¨åŒ—äº¬åœ°é“1,2å·çº¿æ¥æè¿°ï¼š</p><p>1å·çº¿ï¼šä¸»è¦æ˜¯NATåŠŸèƒ½</p><blockquote><p> æ¡ˆä¾‹ï¼š</p><p> ã€€ã€€1)å±€åŸŸç½‘ä¸Šç½‘å…±äº«ï¼ˆè·¯ç”±å’Œç½‘å…³ï¼‰ï¼Œä½¿ç”¨NATçš„POSTROUTINGé“¾ã€‚</p><p> ã€€ã€€2)å¤–éƒ¨IPå’Œç«¯å£æ˜ å°„ä¸ºå†…éƒ¨IPå’Œç«¯å£ï¼ˆDMZåŠŸèƒ½ï¼‰ï¼Œä½¿ç”¨NATçš„PREROUTINGé“¾</p></blockquote><p>2å·çº¿ï¼šä¸»è¦æ˜¯FILTERåŠŸèƒ½ï¼Œå³é˜²ç«å¢™åŠŸèƒ½FILTER INPUT FORWARD</p><blockquote><p>æ¡ˆä¾‹ï¼š</p><p>ã€€ã€€ä¸»è¦åº”ç”¨å°±æ˜¯ä¸»æœºæœåŠ¡å™¨é˜²ç«å¢™ï¼Œä½¿ç”¨FILTERçš„INPUTé“¾</p></blockquote><p> <img src="https://s1.ax1x.com/2020/04/26/JRuPVP.png" alt="JRuPVP.png"></p><p>å›¾ - iptablesæ•°æ®åŒ…è½¬å‘æµç¨‹å›¾</p><h3 id="1-4-2-iptableså·¥ä½œæµç¨‹å°ç»“"><a href="#1-4-2-iptableså·¥ä½œæµç¨‹å°ç»“" class="headerlink" title="1.4.2 iptableså·¥ä½œæµç¨‹å°ç»“"></a>1.4.2 iptableså·¥ä½œæµç¨‹å°ç»“</h3><blockquote><p>1ã€é˜²ç«å¢™æ˜¯ä¸€å±‚å±‚è¿‡æ»¤çš„ã€‚å®é™…æ˜¯æŒ‰ç…§é…ç½®è§„åˆ™çš„é¡ºåºä»ä¸Šåˆ°ä¸‹ï¼Œä»å‰åˆ°åè¿›è¡Œè¿‡æ»¤çš„ã€‚</p><p>2ã€å¦‚æœåŒ¹é…ä¸Šäº†è§„åˆ™ï¼Œå³æ˜ç¡®è¡¨æ˜æ˜¯é˜»æ­¢è¿˜æ˜¯é€šè¿‡ï¼Œæ­¤æ—¶æ•°æ®åŒ…å°±ä¸åœ¨å‘ä¸‹åŒ¹é…æ–°è§„åˆ™äº†ã€‚</p><p>3ã€å¦‚æœæ‰€æœ‰è§„åˆ™ä¸­æ²¡æœ‰æ˜ç¡®è¡¨æ˜æ˜¯é˜»æ­¢è¿˜æ˜¯é€šè¿‡è¿™ä¸ªæ•°æ®åŒ…ï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰åŒ¹é…ä¸Šè§„åˆ™ï¼Œå‘ä¸‹è¿›è¡ŒåŒ¹é…ï¼Œç›´åˆ°åŒ¹é…é»˜è®¤è§„åˆ™å¾—åˆ°æ˜ç¡®çš„é˜»æ­¢è¿˜æ˜¯é€šè¿‡ã€‚</p><p>4ã€é˜²ç«å¢™çš„é»˜è®¤è§„åˆ™æ˜¯å¯¹åº”é“¾çš„æ‰€æœ‰çš„è§„åˆ™æ‰§è¡Œå®Œä»¥åæ‰ä¼šæ‰§è¡Œçš„ï¼ˆæœ€åæ‰§è¡Œçš„è§„åˆ™ï¼‰ã€‚</p></blockquote><h2 id="1-5-iptablesæ“ä½œ"><a href="#1-5-iptablesæ“ä½œ" class="headerlink" title="1.5 iptablesæ“ä½œ"></a>1.5 iptablesæ“ä½œ</h2><p>ç³»ç»Ÿç¯å¢ƒè¯´æ˜</p><pre><code>[root@clsn ~]# cat /etc/redhat-release CentOS release 6.9 (Final)[root@clsn ~]# hostname -I10.0.0.188 172.16.1.188</code></pre><p>è½¯ä»¶ç‰ˆæœ¬</p><pre><code>[root@clsn ~]# iptables -Viptables v1.4.7</code></pre><h3 id="1-5-1-iptableså‚æ•°è¯´æ˜"><a href="#1-5-1-iptableså‚æ•°è¯´æ˜" class="headerlink" title="1.5.1 iptableså‚æ•°è¯´æ˜"></a>1.5.1 iptableså‚æ•°è¯´æ˜</h3><table><thead><tr><th><strong>å‚æ•°</strong></th><th><strong>å‚æ•°è¯´æ˜</strong></th><th></th><th></th></tr></thead><tbody><tr><td><strong>æ˜¾ç¤ºç›¸å…³å‚æ•°</strong></td><td></td><td></td><td></td></tr><tr><td><strong>-n/â€“numeric</strong></td><td>ä»¥æ•°å­—çš„æ–¹å¼æ˜¾ç¤ºåœ°å€æˆ–ç«¯å£ä¿¡æ¯</td><td></td><td></td></tr><tr><td><strong>-L/ â€“list</strong></td><td>åˆ—å‡ºä¸€ä¸ªé“¾æˆ–æ‰€æœ‰é“¾ä¸­çš„è§„åˆ™ä¿¡æ¯</td><td></td><td></td></tr><tr><td><strong>â€“list-rules/-S</strong></td><td>Print the rules in a chain or all chains</td><td></td><td></td></tr><tr><td><strong>â€“line-number</strong></td><td>å½“åˆ—å‡ºè§„åˆ™ä¿¡æ¯æ—¶ï¼Œæ‰“å°è§„åˆ™è¡Œå·</td><td></td><td></td></tr><tr><td><strong>-v</strong></td><td>æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯ï¼Œå¯ä»¥å åŠ </td><td></td><td></td></tr><tr><td><strong>-h</strong></td><td>æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯</td><td></td><td></td></tr><tr><td><strong>åˆå§‹åŒ–ç›¸å…³å‚æ•°</strong></td><td></td><td></td><td></td></tr><tr><td><strong>iptables -F</strong></td><td>æ¸…é™¤æ‰€æœ‰è§„åˆ™ï¼Œä¸ä¼šå¤„ç†é»˜è®¤çš„è§„åˆ™</td><td></td><td></td></tr><tr><td><strong>iptables -X</strong></td><td>åˆ é™¤ç”¨æˆ·è‡ªå®šä¹‰çš„é“¾</td><td></td><td></td></tr><tr><td><strong>iptables -Z</strong></td><td>é“¾çš„è®¡æ•°å™¨æ¸…é›¶ï¼ˆæ•°æ®åŒ…è®¡æ•°å™¨ä¸æ•°æ®åŒ…å­—èŠ‚è®¡æ•°å™¨ï¼‰</td><td></td><td></td></tr><tr><td><strong>é…ç½®å¸¸ç”¨å‚æ•°</strong></td><td></td><td></td><td></td></tr><tr><td><strong>-t</strong> <strong>è¡¨åç§°</strong></td><td>æŒ‡å®šé…ç½®å“ªä¸ªè¡¨ï¼ŒæŒ‡å®šé…ç½®è¡¨åç§°ã€‚</td><td></td><td></td></tr><tr><td><strong>â€“append/-A</strong> <strong>é“¾åç§°</strong></td><td>é™„åŠ æˆ–è¿½åŠ ä¸Šç›¸åº”è§„åˆ™ç­–ç•¥ï¼Œåˆ°æŒ‡å®šé“¾(é“¾åç§°å¿…é¡»å¤§å†™)ï¼Œé»˜è®¤å°†é…ç½®çš„è§„åˆ™æ’å…¥åˆ°æœ€åä¸€æ¡ã€‚</td><td></td><td></td></tr><tr><td><strong>â€“check/-C</strong></td><td>Check for the existence of a rule</td><td></td><td></td></tr><tr><td><strong>â€“insert/-I</strong> <strong>é“¾åç§°</strong></td><td>æ’å…¥ç›¸åº”è§„åˆ™ç­–ç•¥ï¼Œåˆ°æŒ‡å®šé“¾ä¸Šï¼Œé»˜è®¤å°†é…ç½®çš„è§„åˆ™æ’å…¥åˆ°ç¬¬ä¸€æ¡ï¼ˆå¯ä»¥æ ¹æ®è§„åˆ™åºå·æ’å…¥åˆ°æŒ‡å®šä½ç½®ï¼‰â€“å°IPåœ°å€ä½¿ç”¨ã€‚</td><td></td><td></td></tr><tr><td><strong>â€“delete/-D</strong> <strong>é“¾åç§°</strong></td><td>åˆ é™¤æŒ‡å®šçš„è§„åˆ™(å¯ä»¥æ ¹æ®è§„åˆ™åºå·è¿›è¡Œåˆ é™¤)</td><td></td><td></td></tr><tr><td><strong>â€“replace/-R</strong></td><td>Replace rule rulenum (1 = first) in chain</td><td></td><td></td></tr><tr><td><strong>-P(**</strong>å¤§å†™)<strong>**é“¾åç§°</strong></td><td>æ”¹å˜é“¾ä¸Šçš„æœ€ç»ˆé»˜è®¤è§„åˆ™ç­–ç•¥</td><td></td><td></td></tr><tr><td><strong>â€“new/-N</strong></td><td>åˆ›å»ºæ–°çš„ç”¨æˆ·å®šä¹‰é“¾</td><td></td><td></td></tr><tr><td><strong>-p</strong> <strong>åè®®åç§°**</strong>[!] â€“proto**</td><td>æŒ‡å®šè§„åˆ™çš„åè®®åç§° all tcp udp icmp</td><td></td><td></td></tr><tr><td><strong>â€“dport</strong></td><td>æŒ‡å®šåŒ¹é…çš„ç›®æ ‡ç«¯å£ä¿¡æ¯</td><td></td><td></td></tr><tr><td><strong>â€“sport</strong></td><td>æŒ‡å®šåŒ¹é…çš„æºç«¯å£ä¿¡æ¯</td><td></td><td></td></tr><tr><td><strong>-j</strong> <strong>åŠ¨ä½œ</strong></td><td>åŒ¹é…æ•°æ®åŒ…åçš„åŠ¨ä½œ</td><td></td><td></td></tr><tr><td><strong>ACCEPT</strong></td><td>å…è®¸</td><td></td><td></td></tr><tr><td><strong>DROP</strong></td><td>ä¸¢å¼ƒ(æ²¡æœ‰å“åº”)</td><td></td><td></td></tr><tr><td><strong>REJECT</strong></td><td>æ‹’ç»(å›åº”è¯·æ±‚è€…æ˜ç¡®çš„æ‹’ç»)</td><td></td><td></td></tr><tr><td><strong>MASQUERADE</strong></td><td>ä¼ªè£…ä¸Šç½‘æ—¶ä½¿ç”¨</td><td></td><td></td></tr><tr><td><strong>SNAT</strong></td><td>å…±äº«åœ°å€ä¸Šç½‘</td><td></td><td></td></tr><tr><td><strong>DNAT</strong></td><td>ç›®çš„åœ°å€æ”¹å†™</td><td></td><td></td></tr><tr><td><strong>-i**</strong>[!] â€“in-interface**</td><td>åœ¨INPUTé“¾é…ç½®è§„åˆ™ä¸­ï¼ŒæŒ‡å®šä»å“ªä¸€ä¸ªç½‘å¡æ¥å£è¿›å…¥çš„æµé‡ï¼ˆåªèƒ½é…ç½®åœ¨INPUTé“¾ä¸Šï¼‰</td><td></td><td></td></tr><tr><td><strong>-o**</strong>[!] â€“out-interface**</td><td>åœ¨OUTPUTé“¾é…ç½®è§„åˆ™ä¸­ï¼ŒæŒ‡å®šä»å“ªä¸€ä¸ªç½‘æ¥å£å‡ºå»çš„æµé‡ï¼ˆåªèƒ½é…ç½®åœ¨OUTPUTé“¾ä¸Šï¼‰</td><td></td><td></td></tr><tr><td><strong>-s</strong> <strong>[!] â€“source</strong></td><td>æŒ‡å®šæºIPåœ°å€æˆ–æºç½‘æ®µä¿¡æ¯</td><td></td><td></td></tr><tr><td><strong>-d**</strong>[!] â€“destination**</td><td>æŒ‡å®šç›®æ ‡IPåœ°å€æˆ–ç›®æ ‡ç½‘æ®µä¿¡æ¯</td><td></td><td></td></tr><tr><td><strong>æ‰©å±•å‚æ•°</strong></td><td></td><td></td><td></td></tr><tr><td><strong>-m</strong> <strong>æ¨¡å—</strong></td><td>è¡¨ç¤ºå¢åŠ æ‰©å±•ï¼ŒåŒ¹é…åŠŸèƒ½æ‰©å±•åŒ¹é…ï¼ˆå¯ä»¥åŠ è½½æ‰©å±•å‚æ•°ï¼‰</td><td></td><td></td></tr><tr><td><strong>multiport</strong></td><td>å®ç°ä¸è¿ç»­å¤šç«¯å£æ‰©å±•åŒ¹é…</td><td></td><td></td></tr><tr><td><strong>icmp</strong></td><td>ä½¿ç”¨icmpçš„æ‰©å±•</td><td></td><td></td></tr><tr><td><strong>state</strong></td><td>çŠ¶æ€æ¨¡å—æ‰©å±•</td><td></td><td></td></tr><tr><td><strong>â€“icmp-type</strong></td><td>åªæœ‰ç±»å‹8æ˜¯çœŸæ­£ä¼šå½±å“pingï¼Œæˆ–è€…ä¹Ÿå¯ä»¥é‡‡ç”¨anyï¼›äº†è§£å¾ˆå¤šicmpç±»å‹<em>iptables -p icmp -h</em></td><td></td><td></td></tr><tr><td><strong>â€“limit n/{second/minute/hour}</strong></td><td>æŒ‡å®šæ—¶é—´å†…çš„è¯·æ±‚é€Ÿç‡â€nâ€ä¸ºé€Ÿç‡ï¼Œåé¢ä¸ºæ—¶é—´åˆ†åˆ«ä¸ºï¼šç§’åˆ† æ—¶</td><td></td><td></td></tr><tr><td><strong>â€“limit-burst [n]</strong></td><td>åœ¨åŒä¸€æ—¶é—´å†…å…è®¸é€šè¿‡çš„è¯·æ±‚â€nâ€ä¸ºæ•°å­—ï¼Œä¸æŒ‡å®šé»˜è®¤ä¸º5</td><td></td><td></td></tr><tr><td><strong>â€“exact/-x</strong></td><td>æ‰©å±•æ•°å­—ï¼ˆæ˜¾ç¤ºç²¾ç¡®æ•°å€¼ï¼‰</td><td></td><td></td></tr><tr><td></td><td></td><td></td><td></td></tr></tbody></table><p><strong>!**</strong>çš„ä½¿ç”¨å®ä¾‹**</p><pre><code>[root@clsn ~]# iptables ! -VNot 1.4.7 ;-)[root@clsn ~]# iptables  -Viptables v1.4.7</code></pre><p>æ³¨æ„ï¼šåœ¨iptablesä¸­æ‰€æœ‰é“¾åå¿…é¡»å¤§å†™ï¼Œè¡¨æ˜å¿…é¡»å°å†™ï¼ŒåŠ¨ä½œå¿…é¡»å¤§å†™ï¼ŒåŒ¹é…å¿…é¡»å°å†™ã€‚</p><h3 id="1-5-2-é…ç½®å‰å‡†å¤‡"><a href="#1-5-2-é…ç½®å‰å‡†å¤‡" class="headerlink" title="1.5.2 é…ç½®å‰å‡†å¤‡"></a>1.5.2 é…ç½®å‰å‡†å¤‡</h3><p>åœ¨é…ç½®é˜²ç«å¢™é¦–å…ˆè¦å…¶ä¸­é˜²ç«å¢™</p><pre><code>[root@clsn ~]# /etc/init.d/iptables start iptables: Applying firewall rules:                         [  OK  ]</code></pre><p>æ¸…é™¤iptablesæ‰€æœ‰è§„åˆ™</p><pre><code>[root@clsn ~]# iptables -Z[root@clsn ~]# iptables -X[root@clsn ~]# iptables -F</code></pre><p>æŸ¥çœ‹iptablesçš„è§„åˆ™</p><pre><code>[root@clsn ~]# iptables -nvLChain INPUT (policy ACCEPT 0 packets, 0 bytes) pkts bytes target     prot opt in     out     source               destination         Chain FORWARD (policy ACCEPT 0 packets, 0 bytes) pkts bytes target     prot opt in     out     source               destination         Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes) pkts bytes target     prot opt in     out     source               destination</code></pre><p>æŸ¥çœ‹å…¶ä»–çš„è¡¨é…ç½®ï¼ˆ-t å‚æ•°ï¼‰</p><pre><code>[root@clsn ~]# iptables -nL -t rawChain PREROUTING (policy ACCEPT)target     prot opt source               destination         Chain OUTPUT (policy ACCEPT)target     prot opt source               destination</code></pre><p>æŸ¥çœ‹é…ç½®è§„åˆ™çš„é¡ºåºå·</p><pre><code>[root@clsn ~]# iptables -nvL -line-number--line-number #  æ˜¾ç¤ºè§„åˆ™çš„åºå·</code></pre><h2 id="1-6-iptables-filterè¡¨é…ç½®å®ä¾‹"><a href="#1-6-iptables-filterè¡¨é…ç½®å®ä¾‹" class="headerlink" title="1.6 iptables filterè¡¨é…ç½®å®ä¾‹"></a>1.6 iptables filterè¡¨é…ç½®å®ä¾‹</h2><h3 id="1-6-1-åŸºç¡€é…ç½®"><a href="#1-6-1-åŸºç¡€é…ç½®" class="headerlink" title="1.6.1 åŸºç¡€é…ç½®"></a>1.6.1 åŸºç¡€é…ç½®</h3><p><strong>é…ç½®å®ä¾‹ä¸€ï¼š</strong>é…ç½®22/sshç«¯å£è®¿é—®æ§åˆ¶è§„åˆ™</p><pre><code>iptables -A INPUT -p tcp --dprot 22 -j DROP     # ç¦æ­¢æ‰€æœ‰äººè®¿é—®22ç«¯å£iptables -I INPUT -p tcp --dprot 22 -j ACCEPT   # æ¢å¤è¿æ¥æ–¹æ³•iptables -I INPUT 2 -p tcp --dprot 22 -j ACCEPT # é€šè¿‡æ’å…¥æŒ‡å®šè¡Œå·ä¿¡æ¯ï¼ŒæŒ‡å®šå°†è§„åˆ™æ’å…¥åˆ°ç¬¬å‡ è¡Œiptables -D INPUT -p tcp --dport 22 -j ACCEPT   # åˆ é™¤æŒ‡å®šè§„åˆ™iptables -D INPUT 2                             # æ ¹æ®è§„åˆ™è¡Œå·ï¼Œåˆ é™¤ç›¸åº”çš„è§„åˆ™</code></pre><p>åªå…è®¸10.0.0.1çš„ipé€šè¿‡sshè¿æ¥è¿™å°æœåŠ¡å™¨</p><pre><code>iptables -I INPUT -s 10.0.0.1 -p tcp --dport 22 -j ACCEPT </code></pre><p>é…ç½®å®ä¾‹äºŒï¼šç¦æ­¢ç½‘æ®µè¿å…¥ï¼ˆç¦æ­¢172.16.1.0ç½‘æ®µè®¿é—®172.16.1.188ï¼‰</p><pre><code>iptables -A INPUT  -s 172.16.1.0/24 -d 172.16.1.188  -j DROP</code></pre><p>é…ç½®å®ä¾‹ä¸‰ï¼šç¦æ­¢æŸä¸ª172.16.1.0ç½‘æ®µè®¿é—®æœåŠ¡å™¨ä¸»æœºçš„22ç«¯å£</p><pre><code>iptables -A INPUT -s 172.16.1.0/24 -d 172.16.1.188  -p tcp --dport 22 -j DROP</code></pre><p>æ–¹å‘è¯´æ˜ï¼š</p><pre><code># åœ¨å…¥æ–¹å‘æ§åˆ¶iptables -I INPUT -i eth0  -p tcp --dport 22 -j ACCEPT# åœ¨å‡ºæ–¹å‘æ§åˆ¶iptables -I OUTPUT -o eth0  -p tcp --sport 22 -j DROP</code></pre><h3 id="1-6-2-é…ç½®å®ä¾‹å››ï¼šé™¤10-0-0-0ç½‘æ®µå¯ä»¥è¿›è¡Œè¿æ¥æœåŠ¡å™¨ä¸»æœºæ„å¤–ï¼Œå…¶ä½™ç½‘æ®µéƒ½ç¦æ­¢"><a href="#1-6-2-é…ç½®å®ä¾‹å››ï¼šé™¤10-0-0-0ç½‘æ®µå¯ä»¥è¿›è¡Œè¿æ¥æœåŠ¡å™¨ä¸»æœºæ„å¤–ï¼Œå…¶ä½™ç½‘æ®µéƒ½ç¦æ­¢" class="headerlink" title="1.6.2 é…ç½®å®ä¾‹å››ï¼šé™¤10.0.0.0ç½‘æ®µå¯ä»¥è¿›è¡Œè¿æ¥æœåŠ¡å™¨ä¸»æœºæ„å¤–ï¼Œå…¶ä½™ç½‘æ®µéƒ½ç¦æ­¢"></a>1.6.2 é…ç½®å®ä¾‹å››ï¼šé™¤10.0.0.0ç½‘æ®µå¯ä»¥è¿›è¡Œè¿æ¥æœåŠ¡å™¨ä¸»æœºæ„å¤–ï¼Œå…¶ä½™ç½‘æ®µéƒ½ç¦æ­¢</h3><p>  <em>ç¬¬ä¸€ç§æ–¹å¼ï¼š</em></p><pre><code>iptables -A INPUT -s 10.0.0.0/24 -d 172.16.1.8  -j ACCEPT</code></pre><p>   ä¿®æ”¹é»˜è®¤è§„åˆ™ï¼Œå°†é»˜è®¤è§„åˆ™æ”¹ä¸ºæ‹’ç»</p><p><em>ç¬¬äºŒç§æ–¹å¼ï¼š</em></p><p>   ï¼  â€” è¡¨ç¤ºå¯¹è§„åˆ™ä¿¡æ¯è¿›è¡Œå–å</p><pre><code>iptables -A INPUT ! -s 10.0.0.0/24 -d 172.16.1.8  -j DROP   --- centos6ç”¨æ³•iptables -A INPUT -s ! 10.0.0.0/24 -d 172.16.1.8  -j DROP   --- centos5ç”¨æ³•</code></pre><p>è¯´æ˜ï¼šåªæœ‰iptableså¸®åŠ©æ‰‹å†Œä¸­æŒ‡å®šçš„å‚æ•°å¯ä»¥ç”¨å–åç¬¦å·ï¼ˆiptables â€“helpï¼‰</p><h3 id="1-6-3-é…ç½®å®ä¾‹äº”ï¼šæµ‹è¯•åŒ¹é…åˆ—ä¸¾ç«¯å£èŒƒå›´ã€‚"><a href="#1-6-3-é…ç½®å®ä¾‹äº”ï¼šæµ‹è¯•åŒ¹é…åˆ—ä¸¾ç«¯å£èŒƒå›´ã€‚" class="headerlink" title="1.6.3 é…ç½®å®ä¾‹äº”ï¼šæµ‹è¯•åŒ¹é…åˆ—ä¸¾ç«¯å£èŒƒå›´ã€‚"></a>1.6.3 é…ç½®å®ä¾‹äº”ï¼šæµ‹è¯•åŒ¹é…åˆ—ä¸¾ç«¯å£èŒƒå›´ã€‚</h3><pre><code>iptables -A INPUT -p tcp --dport 22:80 -j DROP                 # è®¾ç½®è¿ç»­å¤šç«¯å£æ§åˆ¶ç­–ç•¥iptables -A INPUT -p tcp -m multiport  --dport 22,80 -j DROP   # è®¾ç½®ä¸è¿ç»­å¤šç«¯å£æ§åˆ¶ç­–ç•¥</code></pre><p>   -m å‚æ•°è¡¨ç¤ºå¢åŠ æ‰©å±•åŒ¹é…åŠŸèƒ½ï¼Œmultiport å®ç°ä¸è¿ç»­å¤šç«¯å£æ‰©å±•åŒ¹é…</p><h3 id="1-6-4-é…ç½®å®ä¾‹å…­ï¼šåŒ¹é…ICMPç±»å‹"><a href="#1-6-4-é…ç½®å®ä¾‹å…­ï¼šåŒ¹é…ICMPç±»å‹" class="headerlink" title="1.6.4 é…ç½®å®ä¾‹å…­ï¼šåŒ¹é…ICMPç±»å‹"></a>1.6.4 é…ç½®å®ä¾‹å…­ï¼šåŒ¹é…ICMPç±»å‹</h3><p>   ç¦æ­¢pingç­–ç•¥åŸåˆ™</p><p>   iptablesæœåŠ¡å™¨æ˜¯pingå‘½ä»¤å‘èµ·è€…æˆ–æ˜¯æ¥å—è€…</p><p><strong>å‘èµ·è€…ï¼š</strong></p><p>inputé“¾ï¼š ç¦æ­¢icmp-type 0        0 Echo Replyâ€”â€”å›æ˜¾åº”ç­”ï¼ˆPingåº”ç­”)</p><pre><code>iptables -A INPUT -i eth0 -p icmp --icmp-type 0 -j DROP</code></pre><p>outputé“¾ï¼š ç¦æ­¢icmp-type 8     8 Echo requestâ€”â€”å›æ˜¾è¯·æ±‚ï¼ˆPingè¯·æ±‚ï¼‰</p><pre><code>iptables -A OUTPUT -o eth0 -p icmp --icmp-type 8 -j DROP</code></pre><p>   <strong>æ¥å—è€…ï¼š</strong></p><p>inputé“¾ï¼š ç¦æ­¢icmp-type 8      8 Echo requestâ€”â€”å›æ˜¾è¯·æ±‚ï¼ˆPingè¯·æ±‚ï¼‰</p><pre><code>iptables -A INPUT -i eth0 -p icmp --icmp-type 8 -j DROP </code></pre><p>outputé“¾ï¼š ç¦æ­¢icmp-type 0     0 Echo Replyâ€”â€”å›æ˜¾åº”ç­”ï¼ˆPingåº”ç­”)</p><pre><code>iptables -A OUTPUT -o eth0 -p icmp --icmp-type 0 -j DROP</code></pre><p>ç®€åŒ–é…ç½®ï¼š</p><pre><code>iptables -A INPUT -i eth0 -p icmp -m icmp --icmp-type any -j DROP  #ç¦æ­¢æ‰€æœ‰ç±»å‹çš„icmp</code></pre><p>   æŒ‡å®šç±»å‹ç¦æ­¢icmp</p><pre><code>iptables -A INPUT -p icmp --icmp-type 8iptables -A INPUT -p icmp --icmp-type 8 -j DROPiptables -A INPUT -p icmp -m icmp --icmp-type any -j ACCEPTiptables -A FORWARD -s 192.168.1.0/24 -p icmp -m icmp --icmp-type any -j ACCEPT</code></pre><p>   è¯´æ˜ï¼šåªæœ‰ç±»å‹8æ˜¯çœŸæ­£ä¼šå½±å“pingï¼Œæˆ–è€…ä¹Ÿå¯ä»¥é‡‡ç”¨anyï¼›äº†è§£å¾ˆå¤šicmpç±»å‹iptables -p icmp -h</p><p><strong>ICMP**</strong>ç±»å‹çš„è¯´æ˜**</p><table><thead><tr><th>TYPE</th><th>CODE</th><th>Description</th><th>Query</th><th>Error</th></tr></thead><tbody><tr><td><strong>0</strong></td><td>0</td><td>Echo Replyâ€”â€”å›æ˜¾åº”ç­”ï¼ˆPingåº”ç­”ï¼‰</td><td>x</td><td></td></tr><tr><td><strong>3</strong></td><td>0</td><td>Network Unreachableâ€”â€”ç½‘ç»œä¸å¯è¾¾</td><td></td><td>x</td></tr><tr><td><strong>3</strong></td><td>1</td><td>Host Unreachableâ€”â€”ä¸»æœºä¸å¯è¾¾</td><td></td><td>x</td></tr><tr><td><strong>3</strong></td><td>2</td><td>Protocol Unreachableâ€”â€”åè®®ä¸å¯è¾¾</td><td></td><td>x</td></tr><tr><td><strong>3</strong></td><td>3</td><td>Port Unreachableâ€”â€”ç«¯å£ä¸å¯è¾¾</td><td></td><td>x</td></tr><tr><td><strong>3</strong></td><td>4</td><td>Fragmentation needed but no frag. bit setâ€”â€”éœ€è¦è¿›è¡Œåˆ†ç‰‡ä½†è®¾ç½®ä¸åˆ†ç‰‡æ¯”ç‰¹</td><td></td><td>x</td></tr><tr><td><strong>3</strong></td><td>5</td><td>Source routing failedâ€”â€”æºç«™é€‰è·¯å¤±è´¥</td><td></td><td>x</td></tr><tr><td><strong>3</strong></td><td>6</td><td>Destination network unknownâ€”â€”ç›®çš„ç½‘ç»œæœªçŸ¥</td><td></td><td>x</td></tr><tr><td><strong>3</strong></td><td>7</td><td>Destination host unknownâ€”â€”ç›®çš„ä¸»æœºæœªçŸ¥</td><td></td><td>x</td></tr><tr><td><strong>3</strong></td><td>8</td><td>Source host isolated (obsolete)â€”â€”æºä¸»æœºè¢«éš”ç¦»ï¼ˆä½œåºŸä¸ç”¨ï¼‰</td><td></td><td>x</td></tr><tr><td><strong>3</strong></td><td>9</td><td>Destination network administratively prohibitedâ€”â€”ç›®çš„ç½‘ç»œè¢«å¼ºåˆ¶ç¦æ­¢</td><td></td><td>x</td></tr><tr><td><strong>3</strong></td><td>10</td><td>Destination host administratively prohibitedâ€”â€”ç›®çš„ä¸»æœºè¢«å¼ºåˆ¶ç¦æ­¢</td><td></td><td>x</td></tr><tr><td><strong>3</strong></td><td>11</td><td>Network unreachable for TOSâ€”â€”ç”±äºæœåŠ¡ç±»å‹TOSï¼Œç½‘ç»œä¸å¯è¾¾</td><td></td><td>x</td></tr><tr><td><strong>3</strong></td><td>12</td><td>Host unreachable for TOSâ€”â€”ç”±äºæœåŠ¡ç±»å‹TOSï¼Œä¸»æœºä¸å¯è¾¾</td><td></td><td>x</td></tr><tr><td><strong>3</strong></td><td>13</td><td>Communication administratively prohibited by filteringâ€”â€”ç”±äºè¿‡æ»¤ï¼Œé€šä¿¡è¢«å¼ºåˆ¶ç¦æ­¢</td><td></td><td>x</td></tr><tr><td><strong>3</strong></td><td>14</td><td>Host precedence violationâ€”â€”ä¸»æœºè¶Šæƒ</td><td></td><td>x</td></tr><tr><td><strong>3</strong></td><td>15</td><td>Precedence cutoff in effectâ€”â€”ä¼˜å…ˆä¸­æ­¢ç”Ÿæ•ˆ</td><td></td><td>x</td></tr><tr><td><strong>4</strong></td><td>0</td><td>Source quenchâ€”â€”æºç«¯è¢«å…³é—­ï¼ˆåŸºæœ¬æµæ§åˆ¶ï¼‰</td><td></td><td></td></tr><tr><td><strong>5</strong></td><td>0</td><td>Redirect for networkâ€”â€”å¯¹ç½‘ç»œé‡å®šå‘</td><td></td><td></td></tr><tr><td><strong>5</strong></td><td>1</td><td>Redirect for hostâ€”â€”å¯¹ä¸»æœºé‡å®šå‘</td><td></td><td></td></tr><tr><td><strong>5</strong></td><td>2</td><td>Redirect for TOS and networkâ€”â€”å¯¹æœåŠ¡ç±»å‹å’Œç½‘ç»œé‡å®šå‘</td><td></td><td></td></tr><tr><td><strong>5</strong></td><td>3</td><td>Redirect for TOS and hostâ€”â€”å¯¹æœåŠ¡ç±»å‹å’Œä¸»æœºé‡å®šå‘</td><td></td><td></td></tr><tr><td><strong>8</strong></td><td>0</td><td>Echo requestâ€”â€”å›æ˜¾è¯·æ±‚ï¼ˆPingè¯·æ±‚ï¼‰</td><td>x</td><td></td></tr><tr><td><strong>9</strong></td><td>0</td><td>Router advertisementâ€”â€”è·¯ç”±å™¨é€šå‘Š</td><td></td><td></td></tr><tr><td><strong>10</strong></td><td>0</td><td>Route solicitationâ€”â€”è·¯ç”±å™¨è¯·æ±‚</td><td></td><td></td></tr><tr><td><strong>11</strong></td><td>0</td><td>TTL equals 0 during transitâ€”â€”ä¼ è¾“æœŸé—´ç”Ÿå­˜æ—¶é—´ä¸º0</td><td></td><td>x</td></tr><tr><td><strong>11</strong></td><td>1</td><td>TTL equals 0 during reassemblyâ€”â€”åœ¨æ•°æ®æŠ¥ç»„è£…æœŸé—´ç”Ÿå­˜æ—¶é—´ä¸º0</td><td></td><td>x</td></tr><tr><td><strong>12</strong></td><td>0</td><td>IP header bad (catchall error)â€”â€”åçš„IPé¦–éƒ¨ï¼ˆåŒ…æ‹¬å„ç§å·®é”™ï¼‰</td><td></td><td>x</td></tr><tr><td><strong>12</strong></td><td>1</td><td>Required options missingâ€”â€”ç¼ºå°‘å¿…éœ€çš„é€‰é¡¹</td><td></td><td>x</td></tr><tr><td><strong>13</strong></td><td>0</td><td>Timestamp request (obsolete)â€”â€”æ—¶é—´æˆ³è¯·æ±‚ï¼ˆä½œåºŸä¸ç”¨ï¼‰</td><td>x</td><td></td></tr><tr><td><strong>14</strong></td><td></td><td>Timestamp reply (obsolete)â€”â€”æ—¶é—´æˆ³åº”ç­”ï¼ˆä½œåºŸä¸ç”¨ï¼‰</td><td>x</td><td></td></tr><tr><td><strong>15</strong></td><td>0</td><td>Information request (obsolete)â€”â€”ä¿¡æ¯è¯·æ±‚ï¼ˆä½œåºŸä¸ç”¨ï¼‰</td><td>x</td><td></td></tr><tr><td><strong>16</strong></td><td>0</td><td>Information reply (obsolete)â€”â€”ä¿¡æ¯åº”ç­”ï¼ˆä½œåºŸä¸ç”¨ï¼‰</td><td>x</td><td></td></tr><tr><td><strong>17</strong></td><td>0</td><td>Address mask requestâ€”â€”åœ°å€æ©ç è¯·æ±‚</td><td>x</td><td></td></tr><tr><td><strong>18</strong></td><td>0</td><td>Address mask replyâ€”â€”åœ°å€æ©ç åº”ç­”</td><td></td><td></td></tr></tbody></table><p>æ•°æ®æ¥æºï¼š<a href="http://www.cnitblog.com/yang55xiaoguang/articles/59581.html" target="_blank" rel="noopener">http://www.cnitblog.com/yang55xiaoguang/articles/59581.html</a></p><h3 id="1-6-5-é˜²ç«å¢™çŠ¶æ€æœºåˆ¶é…ç½®"><a href="#1-6-5-é˜²ç«å¢™çŠ¶æ€æœºåˆ¶é…ç½®" class="headerlink" title="1.6.5 é˜²ç«å¢™çŠ¶æ€æœºåˆ¶é…ç½®"></a>1.6.5 é˜²ç«å¢™çŠ¶æ€æœºåˆ¶é…ç½®</h3><p>çŠ¶æ€é›†ç®€å•è¯´æ˜:</p><table><thead><tr><th><strong>çŠ¶æ€é›†</strong></th><th><strong>è¯´æ˜</strong></th></tr></thead><tbody><tr><td><strong>NEW</strong></td><td>è¡¨ç¤ºæ–°å»ºç«‹è¿æ¥çš„æ•°æ®åŒ…çŠ¶æ€</td></tr><tr><td><strong>ESTABLISHED</strong></td><td>è¡¨ç¤ºæ–°å»ºç«‹è¿æ¥æ•°æ®åŒ…å‘é€ä¹‹åï¼Œå›å¤å“åº”çš„æ•°æ®åŒ…çŠ¶æ€</td></tr><tr><td><strong>RELATED</strong></td><td>è¡¨ç¤ºå€ŸåŠ©å·²ç»å»ºç«‹çš„é“¾è·¯ï¼Œå‘é€æ–°çš„è¿æ¥æ•°æ®åŒ…</td></tr><tr><td><strong>INVALID</strong></td><td>æ— æ•ˆæ— æ³•è¯†åˆ«çš„æ•°æ®åŒ…</td></tr></tbody></table><p>æ³¨æ„ï¼šå…è®¸å…³è”çš„çŠ¶æ€åŒ…é€šè¿‡ï¼ˆwebæœåŠ¡ä¸è¦ä½¿ç”¨FTPæœåŠ¡ï¼‰</p><p>é˜²ç«å¢™æœåŠ¡é…ç½®åœ¨FTPæœåŠ¡å™¨ä¸Šæ—¶ï¼Œéœ€è¦é…ç½®ä»¥ä¸‹ç­–ç•¥</p><pre><code>iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPTiptables -A OUTPUT -m state --state ESTABLISHED,RELATED -j ACCEPT</code></pre><p>å®ç°å‘ç°sent_synçŠ¶æ€</p><pre><code>iptables -A INPUT -m state --state NEW -j DROP    # é˜²ç«å¢™æ‰€è¿æ¥å®¢æˆ·ç«¯ä¸Šé…ç½®</code></pre><p>å®ç°å‘ç°sent_rcvdçŠ¶æ€</p><pre><code>iptables -I INPUT -i eth0 -s 10.0.0.201 -m state --state ESTABLISHED -j DROP  # é˜²æŠ¤å¢™ä¸Šé…ç½®çš„</code></pre><h3 id="1-6-6-ä½¿ç”¨iptableså®ç°é™é€ŸåŠŸèƒ½"><a href="#1-6-6-ä½¿ç”¨iptableså®ç°é™é€ŸåŠŸèƒ½" class="headerlink" title="1.6.6 ä½¿ç”¨iptableså®ç°é™é€ŸåŠŸèƒ½"></a>1.6.6 ä½¿ç”¨iptableså®ç°é™é€ŸåŠŸèƒ½</h3><p>limitæ˜¯iptablesçš„ä¸€ä¸ªåŒ¹é…æ¨¡å—ï¼Œç”¨å®ƒç»“åˆiptablesçš„å…¶å®ƒå‘½ä»¤å¯ä»¥å®ç°é™é€Ÿçš„åŠŸèƒ½ã€‚</p><p>ä¸è¿‡é¦–å…ˆå¿…é¡»æ˜ç¡®ï¼Œlimitæœ¬èº«åªæ˜¯ä¸€ä¸ªâ€œåŒ¹é…â€æ¨¡å—ã€‚æˆ‘ä»¬çŸ¥é“ï¼Œiptablesçš„åŸºæœ¬åŸç†æ˜¯â€œåŒ¹é…â€“å¤„ç†â€ï¼Œlimitåœ¨è¿™ä¸ªå·¥ä½œè¿‡ç¨‹ä¸­åªèƒ½èµ·åˆ°åŒ¹é…çš„ä½œç”¨ï¼Œå®ƒæœ¬èº«æ˜¯æ— æ³•å¯¹ç½‘ç»œæ•°æ®åŒ…è¿›è¡Œä»»ä½•å¤„ç†çš„ã€‚æˆ‘çœ‹åˆ°ç½‘ä¸Šæœ‰äº›limitçš„ä¾‹å­é‡Œé¢è¯´åª ç”¨ä¸€æ¡åŒ…å«limitåŒ¹é…è§„åˆ™çš„iptablesè¯­å¥å°±å¯ä»¥å®ç°é™é€Ÿï¼Œé‚£æ˜¯é”™è¯¯çš„ã€‚</p><p>å®é™…ä¸Šï¼Œåˆ©ç”¨imitæ¥é™é€Ÿéœ€è¦åŒ…æ‹¬ä¸¤ä¸ªæ­¥éª¤:</p><p>1.å¯¹ç¬¦åˆlimitåŒ¹é…è§„åˆ™åŒ…æ”¾è¡Œ</p><p>2.ä¸¢å¼ƒ/æ‹’ç»æœªæ”¾è¡Œçš„åŒ…</p><p>ç¤ºä¾‹ï¼š</p><pre><code>iptables -I INPUT -s 10.0.0.7 -p icmp --icmp-type 8 -m limit --limit 6/min --limit-burst 5 -j ACCEPT iptables -I INPUT -s 10.0.0.7 -p icmp --icmp-type 8 -j DROP</code></pre><p>   è¯­å¥å«ä¹‰ï¼šå½“æ¥è‡ª10.0.0.7 çš„pingåŒ…è¶…è¿‡5ä¸ªæ—¶è¿›è¡Œé™é€Ÿï¼Œé™åˆ¶ä¸ºæ¯10sä¸€ä¸ªã€‚</p><p>å‚æ•°è¯´æ˜ï¼š</p><table><thead><tr><th><strong>å‚æ•°</strong></th><th><strong>å‚æ•°å«ä¹‰</strong></th></tr></thead><tbody><tr><td><strong>â€“limit n/{second/minute/hour}</strong></td><td>æŒ‡å®šæ—¶é—´å†…çš„è¯·æ±‚é€Ÿç‡â€nâ€ä¸ºé€Ÿç‡ï¼Œåé¢ä¸ºæ—¶é—´åˆ†åˆ«ä¸ºï¼šç§’ åˆ† æ—¶</td></tr><tr><td><strong>â€“limit-burst [n]</strong></td><td>åœ¨åŒä¸€æ—¶é—´å†…å…è®¸é€šè¿‡çš„è¯·æ±‚â€nâ€ä¸ºæ•°å­—ï¼Œä¸æŒ‡å®šé»˜è®¤ä¸º5</td></tr></tbody></table><p><strong>limit</strong> <strong>æ¨¡å—å…·ä½“æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚ï¼Ÿ</strong></p><p>limitçš„åŒ¹é…æ˜¯åŸºäºä»¤ç‰Œæ¡¶ (Token bucketï¼‰æ¨¡å‹çš„ã€‚</p><p>ä»¤ç‰Œæ¡¶æ˜¯ä¸€ç§ç½‘ç»œé€šè®¯ä¸­å¸¸è§çš„ç¼“å†²åŒºå·¥ä½œåŸç†ï¼Œå®ƒæœ‰ä¸¤ä¸ªé‡è¦çš„å‚æ•°ï¼Œä»¤ç‰Œæ¡¶å®¹é‡nå’Œä»¤ç‰Œäº§ç”Ÿé€Ÿç‡sã€‚</p><blockquote><p>æˆ‘ä»¬å¯ä»¥æŠŠä»¤ç‰Œå½“æˆæ˜¯é—¨ç¥¨ï¼Œè€Œä»¤ç‰Œæ¡¶åˆ™æ˜¯è´Ÿè´£åˆ¶ä½œå’Œå‘æ”¾é—¨ç¥¨çš„ç®¡ç†å‘˜ï¼Œå®ƒæ‰‹é‡Œæœ€å¤šæœ‰nå¼ ä»¤ç‰Œã€‚ä¸€å¼€å§‹ï¼Œç®¡ç†å‘˜å¼€å§‹æ‰‹é‡Œæœ‰nå¼ ä»¤ç‰Œã€‚æ¯å½“ä¸€ä¸ªæ•°æ®åŒ…åˆ°è¾¾åï¼Œç®¡ç†å‘˜å°±çœ‹çœ‹æ‰‹é‡Œæ˜¯å¦è¿˜æœ‰å¯ç”¨çš„ä»¤ç‰Œã€‚å¦‚æœæœ‰ï¼Œå°±æŠŠä»¤ç‰Œå‘ç»™è¿™ä¸ªæ•°æ®åŒ…ï¼Œlimitå°±å‘Šè¯‰iptablesï¼Œè¿™ä¸ªæ•°æ®åŒ…è¢«åŒ¹é…äº†ã€‚è€Œå½“ç®¡ç†å‘˜æŠŠæ‰‹ä¸Šæ‰€æœ‰çš„ä»¤ç‰Œéƒ½å‘å®Œäº†ï¼Œå†æ¥çš„æ•°æ®åŒ…å°±æ‹¿ä¸åˆ°ä»¤ç‰Œäº†ã€‚è¿™æ—¶ï¼Œlimitæ¨¡å—å°±å‘Šè¯‰iptablesï¼Œè¿™ä¸ªæ•°æ®åŒ…ä¸èƒ½è¢«åŒ¹é…ã€‚é™¤äº†å‘æ”¾ä»¤ç‰Œä¹‹å¤–ï¼Œåªè¦ä»¤ç‰Œæ¡¶ä¸­çš„ä»¤ç‰Œæ•°é‡å°‘äºnï¼Œå®ƒå°±ä¼šä»¥é€Ÿç‡sæ¥äº§ç”Ÿæ–°çš„ä»¤ç‰Œï¼Œç›´åˆ°ä»¤ç‰Œæ•°é‡åˆ°è¾¾nä¸ºæ­¢ã€‚</p></blockquote><p>é€šè¿‡ä»¤ç‰Œæ¡¶æœºåˆ¶ï¼Œå³å¯ä»¥æœ‰æ•ˆçš„æ§åˆ¶å•ä½æ—¶é—´å†…é€šè¿‡ï¼ˆåŒ¹é…ï¼‰çš„æ•°æ®åŒ…æ•°é‡ï¼Œåˆå¯ä»¥å®¹è®¸çŸ­æ—¶é—´å†…çªå‘çš„å¤§é‡æ•°æ®åŒ…çš„é€šè¿‡ï¼ˆåªè¦æ•°æ®åŒ…æ•°é‡ä¸è¶…è¿‡ä»¤ç‰Œæ¡¶nï¼‰ã€‚</p><p>limitæ¨¡å—æä¾›äº†ä¸¤ä¸ªå‚æ•°â€“limitå’Œâ€“limit-burstï¼Œåˆ†åˆ«å¯¹åº”äºä»¤ç‰Œäº§ç”Ÿé€Ÿç‡å’Œä»¤ç‰Œæ¡¶å®¹é‡ã€‚é™¤äº†ä»¤ç‰Œæ¡¶æ¨¡å‹å¤–ï¼ŒlimitåŒ¹é…çš„å¦å¤–ä¸€ä¸ªé‡è¦æ¦‚å¿µæ˜¯åŒ¹é…é¡¹ã€‚åœ¨limitä¸­ï¼Œæ¯ä¸ªåŒ¹é…é¡¹æ‹¥æœ‰ä¸€ä¸ªå•ç‹¬çš„ä»¤ç‰Œæ¡¶ï¼Œæ‰§è¡Œç‹¬ç«‹çš„åŒ¹é…è®¡ç®—ã€‚</p><h3 id="1-6-7é˜²ç«å¢™é…ç½®"><a href="#1-6-7é˜²ç«å¢™é…ç½®" class="headerlink" title="1.6.7é˜²ç«å¢™é…ç½®"></a>1.6.7é˜²ç«å¢™é…ç½®</h3><p>æ¸…é™¤é˜²ç«å¢™è§„åˆ™</p><pre><code>[root@clsn ~]# iptables -F[root@clsn ~]# iptables -X[root@clsn ~]# iptables -Z</code></pre><p>ä¿®æ”¹é»˜è®¤è§„åˆ™ä¸ºæ‹’ç»ï¼ˆä¿®æ”¹å‰å…ˆæ”¾è¡Œ22ç«¯å£ï¼Œä¿è¯è‡ªå·±èƒ½å¤Ÿè¿ä¸Šä¸»æœºï¼‰</p><pre><code>[root@clsn ~]# iptables -A INPUT -p tcp --dport  22 -j ACCEPT[root@clsn ~]# iptables -P INPUT DROP [root@clsn ~]# iptables -P FORWARD DROP</code></pre><p>æ”¾è¡ŒæŒ‡å®šçš„ç«¯å£</p><pre><code>[root@clsn ~]# iptables -A INPUT -i lo -j ACCEPT[root@clsn ~]# iptables -A INPUT  -p tcp  -m multiport --dport  80,443 -j ACCEPT [root@clsn ~]# iptables -A INPUT -s 172.16.1.0/24 -j ACCEPT[root@clsn ~]# iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT#multiportå¤šä¸ªä¸è¿ç»­   21:25,80,443</code></pre><p><strong>ä¿å­˜iptables**</strong>é…ç½®**</p><p>\01. ç¬¬ä¸€ç§æ–¹å¼</p><pre><code>[root@clsn ~]# /etc/init.d/iptables saveiptables: Saving firewall rules to /etc/sysconfig/iptables:[  OK  ][root@clsn ~]# cat /etc/sysconfig/iptables# Generated by iptables-save v1.4.7 on Tue Apr  4 12:24:43 2017*filter:INPUT DROP [0:0]:FORWARD DROP [0:0]:OUTPUT ACCEPT [159:10664]-A INPUT -s 10.0.0.0/24 -j ACCEPT -A INPUT -p tcp -m tcp --dport 22 -j ACCEPT -A INPUT -p tcp -m multiport --dports 80,443 -j ACCEPT -A INPUT -s 172.16.1.0/24 -j ACCEPT -A INPUT -i lo -j ACCEPT -A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT COMMIT# Completed on Tue Apr  4 12:24:43 2017</code></pre><p>\02. ç¬¬äºŒç§æ–¹å¼</p><pre><code>iptables-save &gt;/etc/sysconfig/iptables</code></pre><h2 id="1-7-iptables-natè¡¨é…ç½®å®ä¾‹-ç†è®º"><a href="#1-7-iptables-natè¡¨é…ç½®å®ä¾‹-ç†è®º" class="headerlink" title="1.7 iptables natè¡¨é…ç½®å®ä¾‹(ç†è®º)"></a>1.7 iptables natè¡¨é…ç½®å®ä¾‹(ç†è®º)</h2><p>(ç†è®ºæŒæ¡)</p><h3 id="1-7-1-iptableså®ç°å…±äº«ä¸Šç½‘"><a href="#1-7-1-iptableså®ç°å…±äº«ä¸Šç½‘" class="headerlink" title="1.7.1 iptableså®ç°å…±äº«ä¸Šç½‘"></a>1.7.1 iptableså®ç°å…±äº«ä¸Šç½‘</h3><p> <img src="https://s1.ax1x.com/2020/04/26/JRuF58.png" alt="JRuF58.png"></p><p>å›¾ - SNAT é…ç½®åŸç†å›¾</p><p>ç¬¬ä¸€ä¸ªé‡Œç¨‹ç¢‘ï¼šé…ç½®å†…ç½‘æœåŠ¡å™¨ï¼Œè®¾ç½®ç½‘å…³åœ°å€</p><pre><code>/etc/init.d/iptables stop      # å†…ç½‘æœåŠ¡å™¨åœæ­¢é˜²ç«å¢™æœåŠ¡ifdown eth0                    # æ¨¡æ‹Ÿå…³é—­å†…ç½‘æœåŠ¡å™¨å¤–ç½‘ç½‘å¡setup                          # ä¿®æ”¹å†…ç½‘ç½‘å¡ç½‘å…³å’ŒDNSåœ°å€ä¿¡æ¯</code></pre><p>ä¹Ÿå¯ä»¥ä½¿ç”¨å‘½ä»¤æ·»åŠ é»˜è®¤ç½‘å…³</p><pre><code>route add default gw 172.16.1.188</code></pre><p>æŸ¥çœ‹é»˜è®¤çš„è·¯ç”±ä¿¡æ¯</p><pre><code>[root@test ~]# route -nKernel IP routing tableDestination     Gateway         Genmask         Flags Metric Ref    Use Iface172.16.1.0      0.0.0.0         255.255.255.0   U     0      0        0 eth1169.254.0.0     0.0.0.0         255.255.0.0     U     1003   0        0 eth10.0.0.0         172.16.1.188    0.0.0.0         UG    0      0        0 eth1</code></pre><p>è¯´æ˜ï¼šå†…ç½‘æœåŠ¡å™¨ç½‘å…³åœ°å€æŒ‡å®šä¸ºå…±äº«ä¸Šç½‘æœåŠ¡å™¨å†…ç½‘ç½‘å¡åœ°å€</p><p>ç¬¬äºŒä¸ªé‡Œç¨‹ç¢‘ï¼šé…ç½®å…±äº«ä¸Šç½‘æœåŠ¡å™¨ï¼Œå¼€å¯å…±äº«ä¸Šç½‘æœåŠ¡å™¨è·¯ç”±è½¬å‘åŠŸèƒ½</p><pre><code>[root@clsn ~]# vim /etc/sysctl.conf [root@clsn ~]# sysctl -p~~~net.ipv4.ip_forward = 1~~~</code></pre><p>ç¬¬ä¸‰ä¸ªé‡Œç¨‹ç¢‘ï¼šé…ç½®å…±äº«ä¸Šç½‘æœåŠ¡å™¨ï¼Œå®ç°å†…ç½‘è®¿é—®å¤–ç½‘çš„NATæ˜ å°„</p><pre><code>iptables -t nat -A POSTROUTING -s 172.16.1.0/24 -o eth0 -j SNAT --to-source 10.0.0.188</code></pre><p>å‚æ•°è¯¦è§£ï¼š</p><table><thead><tr><th><strong>å‚æ•°</strong></th><th><strong>å‚æ•°è¯´æ˜</strong></th></tr></thead><tbody><tr><td><strong>-s 172.16.1.0/24</strong></td><td>æŒ‡å®šå°†å“ªäº›å†…ç½‘ç½‘æ®µè¿›è¡Œæ˜ å°„è½¬æ¢</td></tr><tr><td><strong>-o eth0</strong></td><td>æŒ‡å®šåœ¨å…±äº«ä¸Šç½‘å“ªä¸ªç½‘å¡æ¥å£ä¸ŠåšNATåœ°å€è½¬æ¢</td></tr><tr><td><strong>-j SNAT</strong></td><td>å°†æºåœ°å€è¿›è¡Œè½¬æ¢å˜æ›´</td></tr><tr><td><strong>-j DNAT</strong></td><td>å°†ç›®æ ‡åœ°å€è¿›è¡Œè½¬æ¢å˜æ›´</td></tr><tr><td><strong>â€“to-source ip**</strong>åœ°å€**</td><td>å°†æºåœ°å€æ˜ å°„ä¸ºä»€ä¹ˆIPåœ°å€</td></tr><tr><td><strong>â€“to-destination ip**</strong>åœ°å€**</td><td>å°†ç›®æ ‡åœ°å€æ˜ å°„ä¸ºä»€ä¹ˆIPåœ°å€</td></tr></tbody></table><p>å½“filterè¡¨ä¸­çš„forwardé»˜è®¤ä¸ºdropç­–ç•¥æ—¶ï¼Œå¦‚ä½•é…ç½®forwardé“¾ï¼Ÿ</p><p> <img src="https://s1.ax1x.com/2020/04/26/JRuubq.png" alt="JRuubq.png"></p><p>å›¾ - forwardå·¥ä½œåŸç†</p><p>   <strong>é…ç½®ç¤ºä¾‹</strong></p><pre><code>iptables -A FORWARD -i eth1 -s 172.16.1.0/24 -j ACCEPT# iptables -A FORWARD -o eth0 -s 172.16.1.0/24 -j ACCEPT  # å¯ä»¥ä¸è¿›è¡Œé…ç½®iptables -A FORWARD -i eth0 -d 172.16.1.0/24 -j ACCEPT# iptables -A FORWARD -o eth1 -d 172.16.1.0/24 -j ACCEPT   # å¯ä»¥ä¸è¿›è¡Œé…ç½®</code></pre><p>å½“å¤–ç½‘ipä¸å›ºå®šæ—¶å¦‚ä½•é…ç½®ï¼Ÿ</p><pre><code>iptables -t nat -A POSTROUTING -s 172.16.1.0/24 -o eth0 -j MASQUERADE   # ä¼ªè£…å…±äº«ä¸Šç½‘</code></pre><p>è¯´æ˜ï¼šåœ¨å·¥ä½œä¸­å¦‚ä½•æ²¡æœ‰å›ºå®šå¤–ç½‘IPåœ°å€ï¼Œå¯ä»¥é‡‡å–ä»¥ä¸Šä¼ªè£…æ˜ å°„çš„æ–¹å¼è¿›è¡Œå…±äº«ä¸Šç½‘</p><p><strong>é…ç½®æ˜ å°„æ–¹æ³•å°ç»“</strong></p><blockquote><p> \01. æŒ‡å®šå“ªäº›ç½‘æ®µéœ€è¦è¿›è¡Œæ˜ å°„     -s 172.16.1.0/24</p><p> \02. æŒ‡å®šåœ¨å“ªåšæ˜ å°„               -o eth0</p><p> \03. ç”¨ä»€ä¹ˆæ–¹æ³•åšæ˜ å°„             -j SNAT/DNAT MASQUERADE</p><p> \04. æ˜ å°„æˆä»€ä¹ˆåœ°å€               â€“to-source  ipåœ°å€/â€“to-destination ipåœ°å€</p></blockquote><h3 id="1-7-2-iptableså®ç°å¤–ç½‘IPçš„ç«¯å£æ˜ å°„åˆ°å†…ç½‘IPçš„ç«¯å£"><a href="#1-7-2-iptableså®ç°å¤–ç½‘IPçš„ç«¯å£æ˜ å°„åˆ°å†…ç½‘IPçš„ç«¯å£" class="headerlink" title="1.7.2 iptableså®ç°å¤–ç½‘IPçš„ç«¯å£æ˜ å°„åˆ°å†…ç½‘IPçš„ç«¯å£"></a>1.7.2 iptableså®ç°å¤–ç½‘IPçš„ç«¯å£æ˜ å°„åˆ°å†…ç½‘IPçš„ç«¯å£</h3><p>å®é™…éœ€æ±‚ï¼šå°†ç½‘å…³çš„IPå’Œ9000ç«¯å£æ˜ å°„åˆ°å†…ç½‘æœåŠ¡å™¨çš„22ç«¯å£</p><p>ç«¯å£æ˜ å°„ 10.0.0.188:9000 â€“&gt;172.16.1.180:22</p><p>é…ç½®å®ä¾‹ï¼š</p><pre><code>iptables -t nat -A PREROUTING -d 10.0.0.188 -p tcp --dport 9000 -i eth0 -j DNAT --to-destination 172.16.1.7:22</code></pre><p>å‚æ•°è¯´æ˜:</p><table><thead><tr><th><strong>å‚æ•°</strong></th><th><strong>å‚æ•°è¯´æ˜</strong></th></tr></thead><tbody><tr><td><strong>-d 10.0.0.188</strong></td><td>ç›®æ ‡åœ°å€ã€‚</td></tr><tr><td><strong>-j DNAT</strong></td><td>ç›®çš„åœ°å€æ”¹å†™ã€‚</td></tr></tbody></table><h3 id="1-7-3-IPä¸€å¯¹ä¸€æ˜ å°„"><a href="#1-7-3-IPä¸€å¯¹ä¸€æ˜ å°„" class="headerlink" title="1.7.3 IPä¸€å¯¹ä¸€æ˜ å°„"></a>1.7.3 IPä¸€å¯¹ä¸€æ˜ å°„</h3><p><img src="https://s1.ax1x.com/2020/04/26/JRu3PU.png" alt="JRu3PU.png"></p><p>å›¾ - DNAT æ˜ å°„åŸç†</p><p>   å®é™…éœ€æ±‚ï¼šå°†ip åœ°å€172.16.1.180 æ˜ å°„åˆ°10.0.0.188</p><p>é€šè¿‡è¾…åŠ©IPé…ç½®ï¼š</p><pre><code>ip addr add 10.0.0.81/24 dev eth0 label eth0:0   # æ·»åŠ è¾…åŠ©IPiptables  -t nat -I PREROUTING -d 10.0.0.81 -j DNAT --to-destination 172.16.1.51iptables  -t nat -I POSTROUTING -s 172.16.1.51 -o eth0 -j SNAT --to-source 10.0.0.81</code></pre><p>é€‚åˆå†…ç½‘çš„æœºå™¨è®¿é—®NATå¤–ç½‘çš„IP</p><pre><code>iptables  -t nat -I POSTROUTING -s 172.16.1.0/255.255.240.0 -d 10.0.0.81 -j SNAT --to-source 172.16.1.8</code></pre><p>æ£€æŸ¥é…ç½®ï¼š</p><pre><code>ping 10.0.0.81 -ttcpdump|grep -i icmpï¼ˆä¸¤å°æœºå™¨ä¸Šåˆ†åˆ«ç›‘æµ‹ï¼‰telnet 10.0.0.81 22</code></pre><h3 id="1-7-4-æ˜ å°„å¤šä¸ªå¤–ç½‘IPä¸Šç½‘"><a href="#1-7-4-æ˜ å°„å¤šä¸ªå¤–ç½‘IPä¸Šç½‘" class="headerlink" title="1.7.4 æ˜ å°„å¤šä¸ªå¤–ç½‘IPä¸Šç½‘"></a>1.7.4 æ˜ å°„å¤šä¸ªå¤–ç½‘IPä¸Šç½‘</h3><p>   æ–¹æ³•1ï¼š</p><pre><code>iptables -t nat -A POSTROUTING -s 10.0.1.0/255.255.240.0 -o eth0 -j SNAT --to-source 124.42.60.11-124.42.60.16</code></pre><p>â€‹      åœ¨ä¸‰å±‚äº¤æ¢æœºæˆ–è·¯ç”±å™¨ï¼Œåˆ’åˆ†VLANã€‚</p><p>   æ–¹æ³•2ï¼š</p><pre><code>iptables -t nat -A POSTROUTING -s 10.0.1.0/22 -o eth0 -j SNAT --to-source 124.42.60.11iptables -t nat -A POSTROUTING -s 10.0.2.0/22 -o eth0 -j SNAT --to-source 124.42.60.12</code></pre><p>â€‹      æ‰©å¤§å­ç½‘ï¼Œä¼šå¢åŠ å¹¿æ’­é£æš´ã€‚</p><h3 id="1-7-5-ç³»ç»Ÿé˜²ç«å¢™ä¸ç½‘ç»œå†…æ ¸ä¼˜åŒ–æ ‡å‡†å‚æ•°"><a href="#1-7-5-ç³»ç»Ÿé˜²ç«å¢™ä¸ç½‘ç»œå†…æ ¸ä¼˜åŒ–æ ‡å‡†å‚æ•°" class="headerlink" title="1.7.5 ç³»ç»Ÿé˜²ç«å¢™ä¸ç½‘ç»œå†…æ ¸ä¼˜åŒ–æ ‡å‡†å‚æ•°"></a>1.7.5 ç³»ç»Ÿé˜²ç«å¢™ä¸ç½‘ç»œå†…æ ¸ä¼˜åŒ–æ ‡å‡†å‚æ•°</h3><p>æœ‰å…³iptablesçš„å†…æ ¸ä¼˜åŒ–</p><p>è°ƒæ•´å†…æ ¸å‚æ•°æ–‡ä»¶/etc/sysctl.conf</p><p>ä»¥ä¸‹æ˜¯æˆ‘çš„ç”Ÿäº§ç¯å¢ƒçš„æŸä¸ªæœåŠ¡å™¨çš„é…ç½®ï¼š</p><p><strong>è§£å†³time-wait**</strong>è¿‡å¤š**çš„è§£å†³åŠæ³•ï¼š</p><pre><code>net.ipv4.tcp_fin_timeout = 2net.ipv4.tcp_tw_reuse = 1net.ipv4.tcp_tw_recycle = 1net.ipv4.tcp_syncookies = 1net.ipv4.tcp_keepalive_time = 600net.ipv4.tcp_max_tw_buckets = 36000net.ipv4.ip_local_port_range = 4000  65000net.ipv4.tcp_max_syn_backlog = 16384net.ipv4.route.gc_timeout = 100net.ipv4.tcp_syn_retries = 1net.ipv4.tcp_synack_retries = 1</code></pre><p>åœ¨dmesgä¸­æ˜¾ç¤º  ip_conntrack: table full, dropping packet. çš„é”™è¯¯æç¤ºï¼Œä»€ä¹ˆåŸå› ï¼Ÿ</p><p>å¦‚ä½•è§£å†³ï¼Ÿ</p><p>   #iptablesä¼˜åŒ–</p><pre><code>net.nf_conntrack_max = 25000000net.netfilter.nf_conntrack_max = 25000000net.netfilter.nf_conntrack_tcp_timeout_established = 180net.netfilter.nf_conntrack_tcp_timeout_time_wait = 120net.netfilter.nf_conntrack_tcp_timeout_close_wait = 60net.netfilter.nf_conntrack_tcp_timeout_fin_wait = 120</code></pre><h2 id="1-8-è‡ªå®šä¹‰é“¾çš„é…ç½®-äº†è§£"><a href="#1-8-è‡ªå®šä¹‰é“¾çš„é…ç½®-äº†è§£" class="headerlink" title="1.8 è‡ªå®šä¹‰é“¾çš„é…ç½®(äº†è§£)"></a>1.8 è‡ªå®šä¹‰é“¾çš„é…ç½®(äº†è§£)</h2><p> <img src="https://s1.ax1x.com/2020/04/26/JRuG24.png" alt="JRuG24.png"></p><p>å›¾ - è‡ªå®šä¹‰é“¾åŸç†</p><p>åˆ›å»ºè‡ªå®šä¹‰é“¾</p><pre><code>#ç¤ºä¾‹ï¼šåœ¨filterè¡¨ä¸­åˆ›å»ºNOICMPè‡ªå®šä¹‰é“¾iptables -t filter -N NOICMP</code></pre><p>å¼•ç”¨è‡ªå®šä¹‰é“¾</p><pre><code>#ç¤ºä¾‹ï¼šåœ¨INPUTé“¾ä¸­å¼•ç”¨åˆšæ‰åˆ›å»ºçš„è‡ªå®šä¹‰é“¾iptables -t filter -I INPUT -p icmp  -j NOICMP</code></pre><p>é‡å‘½åè‡ªå®šä¹‰é“¾</p><pre><code>#ç¤ºä¾‹ï¼šå°†IN_WEBè‡ªå®šä¹‰é“¾é‡å‘½åä¸ºWEBiptables -E NOICMP ACCEPTICMP</code></pre><p>åˆ é™¤è‡ªå®šä¹‰é“¾</p><blockquote><p> åˆ é™¤è‡ªå®šä¹‰é“¾éœ€è¦æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶</p><p> ã€€ã€€1ã€è‡ªå®šä¹‰é“¾æ²¡æœ‰è¢«å¼•ç”¨</p><p> ã€€ã€€2ã€è‡ªå®šä¹‰é“¾ä¸­æ²¡æœ‰ä»»ä½•è§„åˆ™</p></blockquote><pre><code># ç¤ºä¾‹ï¼š åˆ é™¤å¼•ç”¨æ•°ä¸º0ä¸”ä¸åŒ…å«ä»»ä½•è§„åˆ™çš„ACCEPTICMPé“¾iptables -X ACCEPTICMP</code></pre><h2 id="1-9-é™„å½•-é˜²ç«å¢™çŠ¶æ€æœºåˆ¶"><a href="#1-9-é™„å½•-é˜²ç«å¢™çŠ¶æ€æœºåˆ¶" class="headerlink" title="1.9 é™„å½•-é˜²ç«å¢™çŠ¶æ€æœºåˆ¶"></a>1.9 é™„å½•-é˜²ç«å¢™çŠ¶æ€æœºåˆ¶</h2><p>çŠ¶æ€æœºåˆ¶æ˜¯iptablesä¸­è¾ƒä¸ºç‰¹æ®Šçš„ä¸€éƒ¨åˆ†ï¼Œè¿™ä¹Ÿæ˜¯iptableså’Œæ¯”è¾ƒè€çš„ipchainsçš„ä¸€ä¸ªæ¯”è¾ƒå¤§çš„åŒºåˆ¥ä¹‹ä¸€ï¼Œè¿è¡ŒçŠ¶æ€æœºåˆ¶ï¼ˆè¿æ¥è·Ÿè¸ªï¼‰çš„é˜²ç«å¢™ç§°ä½œå¸¦æœ‰çŠ¶æ€æœºåˆ¶çš„é˜²ç«å¢™ï¼Œä»¥ä¸‹ç®€ç§°ä¸ºçŠ¶æ€é˜²ç«å¢™.çŠ¶æ€é˜²ç«å¢™æ¯”éçŠ¶æ€é˜²ç«å¢™è¦å®‰å…¨ï¼Œå› ä¸ºå®ƒå…è®¸æˆ‘ä»¬ç¼–å†™æ›´ä¸¥å¯†çš„è§„åˆ™ã€‚</p><p>åœ¨iptablesä¸Šä¸€å…±æœ‰å››ç§çŠ¶æ€ï¼Œåˆ†åˆ«è¢«ç§°ä¸ºNEWã€ESTABLISHEDã€INVALIDã€RELATED,è¿™å››ç§çŠ¶æ€å¯¹äºTCPã€UDPã€ICMPä¸‰ç§åè®®å‡æœ‰æ•ˆã€‚ä¸‹é¢ï¼Œæˆ‘ä»¬æ¥åˆ†åˆ«é˜è¿°å››ç§çŠ¶æ€çš„ç‰¹æ€§.</p><p><strong>ğŸ”” NEW</strong></p><p>meaning that the packet has started a new connection, or otherwise associated with a connection which has not seen packets in both directions</p><p>NEWè¯´æ˜è¿™ä¸ªåŒ…æ˜¯æˆ‘ä»¬çœ‹åˆ°çš„ç¬¬ä¸€ä¸ªåŒ…ã€‚æ„æ€å°±æ˜¯ï¼Œè¿™æ˜¯conntrackæ¨¡å—çœ‹åˆ°çš„æŸä¸ªè¿æ¥çš„ç¬¬ä¸€ä¸ªåŒ…ï¼Œå®ƒå³æ ¼è¢«åŒ¹é…äº†ã€‚æ¯”å¦‚ï¼Œæˆ‘ä»¬çœ‹åˆ°ä¸€ä¸ªSYNåŒ…ï¼Œæ˜¯æˆ‘ä»¬æ‰€ç•™æ„çš„è¿æ¥çš„ç¬¬ä¸€ä¸ªåŒ…ï¼Œå°±è¦åŒ¹é…å®ƒã€‚</p><p><img src="https://s1.ax1x.com/2020/04/26/JRutM9.png" alt="JRutM9.png"> </p><p><strong>ğŸ”” ESTABLISHED</strong></p><p>meaning that the packet is associated with a connection which has seen packets in both directions</p><p>ESTABLISHEDå·²ç»æ³¨æ„åˆ°ä¸¤ä¸ªæ–¹å‘ä¸Šçš„æ•°æ®ä¼ è¾“ï¼Œè€Œä¸”ä¼šç»§ç»­åŒ¹é…è¿™ä¸ªè¿æ¥çš„åŒ….å¤„äºESTABLISHEDçŠ¶æ€çš„è¿æ¥æ˜¯éå¸¸å®¹æ˜“ç†è§£çš„.åªè¦å‘é€å¹¶æ¥åˆ°åº”ç­”ï¼Œè¿æ¥å°±æ˜¯ESTABLISHEDçš„äº†ã€‚ä¸€ä¸ªè¿æ¥è¦ä»NEWå˜ä¸ºESTABLISHED,åªéœ€è¦æ¥åˆ°åº”ç­”åŒ…å³å¯ï¼Œä¸ç®¡è¿™ä¸ªåŒ…æ˜¯å‘å¾€é˜²ç«å¢™çš„ï¼Œè¿˜æ˜¯è¦ç”±é˜²ç«å¢™è½¬å‘çš„.ICMPçš„é”™è¯¯å’Œé‡å®šå‘ç­‰ä¿¡æ¯åŒ…ä¹Ÿè¢«çœ‹ä½œæ˜¯ESTABLISHED,åªè¦å®ƒä»¬æ˜¯æˆ‘ä»¬æ‰€å‘å‡ºçš„ä¿¡æ¯çš„åº”ç­”ã€‚</p><p> <img src="https://s1.ax1x.com/2020/04/26/JRuUq1.png" alt="JRuUq1.png"></p><p><strong>ğŸ””</strong> RELATED</p><p>meaning that the packet is starting a new connection, but is associated with an existing connection, such as an FTP data transfer, or an ICMP error.</p><p>RELATEDæ˜¯ä¸ªæ¯”è¾ƒéº»çƒ¦çš„çŠ¶æ€.å½“ä¸€ä¸ªè¿æ¥å’ŒæŸä¸ªå·²å¤„äºESTABLISHEDçŠ¶æ€çš„è¿æ¥æœ‰å…³ç³»æ—¶ï¼Œå°±è¢«è®¤ä¸ºæ˜¯RELATEDçš„äº†ï¼Œæ¢å¥è¯è¯´ï¼Œä¸€ä¸ªè¿æ¥è¦æƒ³æ˜¯RELATEDçš„ï¼Œé¦–å…ˆè¦æœ‰ä¸€ä¸ªESTABLISHEDçš„è¿æ¥ã€‚è¿™ä¸ªESTABLISHEDè¿æ¥å†äº§ç”Ÿä¸€ä¸ªä¸»è¿æ¥ä¹‹å¤–çš„è¿æ¥ï¼Œè¿™ä¸ªæ–°çš„è¿æ¥å°±æ˜¯RELATEDçš„äº†ï¼Œå½“ç„¶å‰ææ˜¯conntrackæ¨¡å—è¦èƒ½ç†è§£RELATEDã€‚ftpæ˜¯ä¸ªå¾ˆå¥½çš„ä¾‹å­ï¼ŒFTP-dataè¿æ¥å°±æ˜¯å’ŒFTP-controlæœ‰å…³è”çš„ï¼Œå¦‚æœæ²¡æœ‰åœ¨iptablesçš„ç­–ç•¥ä¸­é…RELATEDçŠ¶æ€ï¼ŒFTP-dataçš„è¿æ¥æ˜¯æ— æ³•æ­£ç¡®å»ºç«‹çš„ï¼Œè¿˜æœ‰å…¶ä»–çš„ä¾‹å­ï¼Œæ¯”å¦‚ï¼Œé€šè¿‡IRCçš„DCCè¿æ¥#æœ‰äº†è¿™ä¸ªçŠ¶æ€ï¼ŒICMPåº”ç­”ã€FTPä¼ è¾“ã€DCCç­‰æ‰èƒ½ç©¿è¿‡é˜²ç«å¢™æ­£å¸¸å·¥ä½œ.æ³¨æ„ï¼Œå¤§éƒ¨åˆ†è¿˜æœ‰ä¸€äº›UDPåè®®éƒ½ä¾èµ–è¿™ä¸ªæœºåˆ¶ã€‚è¿™äº›åè®®æ˜¯å¾ˆå¤æ‚çš„ï¼Œå®ƒä»¬æŠŠè¿æ¥ä¿¡æ¯æ”¾åœ¨æ•°æ®åŒ…é‡Œï¼Œå¹¶ä¸”è¦æ±‚è¿™äº›ä¿¡æ¯èƒ½è¢«æ­£ç¡®ç†è§£ã€‚</p><p><img src="https://s1.ax1x.com/2020/04/26/JRudVx.png" alt="JRudVx.png"> </p><p><strong>ğŸ”” INVALID</strong></p><p>meaning that the packet is associated with no known connection</p><p>INVALIDè¯´æ˜æ•°æ®åŒ…ä¸èƒ½è¢«è¯†åˆ«å±äºå“ªä¸ªè¿æ¥æˆ–æ²¡æœ‰ä»»ä½•çŠ¶æ€.æœ‰å‡ ä¸ªåŸå› å¯ä»¥äº§ç”Ÿè¿™ç§æƒ…å†µï¼Œæ¯”å¦‚ï¼Œå†…å­˜æº¢å‡ºï¼Œæ”¶åˆ°ä¸çŸ¥å²äºå“ªä¸ªè¿æ¥çš„ICMPé”™è¯¯ä¿¡æ¯ã€‚ä¸€èˆ¬åœ°ï¼Œæˆ‘ä»¬DROPè¿™ä¸ªçŠ¶æ€çš„ä»»ä½•ä¸œè¥¿ï¼Œå› ä¸ºé˜²ç«å¢™è®¤ä¸ºè¿™æ˜¯ä¸å®‰å…¨çš„ä¸œè¥¿</p><p> <img src="https://s1.ax1x.com/2020/04/26/JRuwa6.png" alt="JRuwa6.png"></p><h3 id="1-9-1-iptablesé…ç½®å“²å­¦"><a href="#1-9-1-iptablesé…ç½®å“²å­¦" class="headerlink" title="1.9.1 iptablesé…ç½®å“²å­¦"></a>1.9.1 iptablesé…ç½®å“²å­¦</h3><p>å¦‚ä½•é˜²æ­¢è‡ªå·±è¢«å…³åœ¨é—¨å¤–ï¼Ÿ</p><blockquote><p> 01ã€å»æœºæˆ¿é‡å¯ç³»ç»Ÿæˆ–è€…ç™»é™†æœåŠªå™¨åˆ é™¤åˆšæ‰çš„ç¦æ­¢è§„åˆ™ã€‚</p><p> 02ã€è®©æœºæˆ¿äººå‘˜é‡å¯æœåŠ¡å™¨æˆ–è€…è®©æœºæˆ¿äººå‘˜æ‹¿ç”¨æˆ·å¯†ç ç™»å½•è¿›å»ã€‚</p><p> 03ã€é€šè¿‡æœåŠ¡å™¨çš„è¿œç¨‹ç®¡ç†å¡ç®¡ç†ï¼ˆæ¨èï¼‰ã€‚</p><p> 04ã€å…ˆå†™ä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œæ¯5åˆ†é’Ÿå°±åœæ­¢é˜²ç«å¢™ã€‚</p><p> 05ã€æµ‹è¯•ç¯å¢ƒæµ‹è¯•å¥½ï¼Œå†™æˆè„šæœ¬ï¼Œæ‰¹ç½®æ‰§è¡Œ</p></blockquote><p>é…ç½®ç¦ç”¨22ç«¯å£ç­–ç•¥:</p><pre><code>iptables -I INPUT -p tcp - dport 22 -j DROP# è¯´æ˜ï¼šåˆ©ç”¨-Iå‚æ•°ï¼Œå®ç°å¼ºè¡Œé˜»æ­¢è®¿é—®22ç«¯å£ï¼Œå°†Jffcè§„åˆ™æ”¾åœ¨ç¬¬ä¸€ä½</code></pre><p>åˆ é™¤é…ç½®çš„ç¦æ­¢è¿æ¥22ç«¯å£çš„è§„åˆ™</p><pre><code>iptables -t filter -D INPUT -p tcp â€”dport 22 -j DROPiptables -F/etc/init.d/iptables restart</code></pre><p> 1.10 å‚è€ƒæ–‡çŒ®</p><blockquote><p> [1]  <a href="http://www.aichengxu.com/linux/3122717.htm" target="_blank" rel="noopener">http://www.aichengxu.com/linux/3122717.htm</a></p><p> [2]  <a href="http://blog.csdn.net/huguohu2006/article/details/6453522" target="_blank" rel="noopener">http://blog.csdn.net/huguohu2006/article/details/6453522</a></p><p> [3]  <a href="http://blog.csdn.net/lin_credible/article/details/8614907" target="_blank" rel="noopener">http://blog.csdn.net/lin_credible/article/details/8614907</a></p><p> [4]  <a href="http://blog.chinaunix.net/uid-27057175-id-5179329.html" target="_blank" rel="noopener">http://blog.chinaunix.net/uid-27057175-id-5179329.html</a></p><p> [5]  <a href="http://blog.51cto.com/oldboy/974194" target="_blank" rel="noopener">http://blog.51cto.com/oldboy/974194</a></p><p> [6]  <a href="http://blog.sina.com.cn/s/blog_773d9b6701018rwo.html" target="_blank" rel="noopener">http://blog.sina.com.cn/s/blog_773d9b6701018rwo.html</a></p><p> [7]  <a href="http://www.zsythink.net/archives/1625" target="_blank" rel="noopener">http://www.zsythink.net/archives/1625</a></p></blockquote><pre><code># iptables  -t  è¡¨å  åŠ¨ä½œ(å‘½ä»¤)   é“¾å   åŒ¹é…æ¡ä»¶  -j  ç›®æ ‡åŠ¨ä½œ        -t è¡¨å  raw mangle nat filter  ï¼ˆå¦‚æœä¸å†™-t é»˜è®¤ä½¿ç”¨filterè¡¨ï¼‰ é“¾å(å„è¡¨å¯¹åº”çš„é“¾)raw(PROROUTINGã€OUPUT)mangle(PROROUTINGã€FORWARDã€OUTPUTã€POSTROUTING)nat(PREROUTINGã€INPUTã€FORWARDã€OUTPUTã€POSTROUING)filter(INPUTã€FORWARDã€OUTPUT)      åŠ¨ä½œ(å®˜æ–¹å«å‘½ä»¤)ï¼š-A  æ·»åŠ è§„åˆ™ï¼š  (appendè¿½åŠ )  # iptables -t filter -A INPUT -p icmp -j REJECT(æ‹’ç»)     //æ‹’ç»æ‰€æœ‰çš„icmpï¼Œå³ä»»ä½•äººä¸èƒ½pingåŒä½    # iptables -t filter -A INPUT -p tcp --dport 22 -s 10.18.44.158  -j REJECT    æ‹’ç»æºåœ°å€10.18.44.158çš„tcpåè®®çš„22ç«¯å£   -I æ’å…¥è§„åˆ™  ï¼š     #   iptables -t filter -I INPUT 2  -p tcp --dport 22 -s 10.18.44.171  -j REJECT   //INPUTä¸åŠ æ•°å­—é»˜è®¤æ˜¯ç¬¬ä¸€è¡Œï¼Œæ•°å­—ä»£è¡¨æ’å…¥åˆ°å“ªä¸€è¡Œå‰è¾¹-R æ›¿æ¢è§„åˆ™ï¼š      #  iptables -t filter -R INPUT 1 -p tcp --dport 22 -s 10.18.44.181  -j REJECT    //æ›¿æ¢çš„æ—¶å€™ INPUTå¿…é¡»è·Ÿä¸Šè¡Œå·-D åˆ é™¤è§„åˆ™      #  iptables -t filter -D INPUT -p icmp -j REJECT      #  iptables -D INPUT 2-P ä¿®æ”¹é»˜è®¤ç­–ç•¥ï¼šåªèƒ½ä½¿ç”¨DROPå’ŒACCEPT       #  iptables -P INPUT DROP         #  iptables -P INPUT ACCEPT -N æ·»åŠ è‡ªå®šä¹‰é“¾          #iptables -N tiger        #iptables -A tiger -p tcp --dport 22 -s 10.18.44.208 -j REJECT     å­˜å‚¨è§„åˆ™         è‡ªå®šä¹‰é“¾é‡Œçš„è§„åˆ™åœ¨æ²¡æœ‰è¢«è°ƒç”¨çš„æƒ…å†µä¸‹ä¸ç”Ÿæ•ˆ ä½¿ç”¨è‡ªå®šä¹‰é“¾(å…³è”è‡ªå®šä¹‰é“¾) #iptables -A INPUT -j tiger ä¿®æ”¹è‡ªå®šä¹‰é“¾åç§°  #iptables -E tiger TIGERåˆ æ‰è‡ªå®šä¹‰é“¾ï¼š    1.ä¸èƒ½è¢«å…³è”    2.å¿…é¡»æ˜¯ç©ºé“¾     #iptables  -X  é“¾å-F  æ¸…ç©ºè§„åˆ™     # iptables  -F é“¾å             //æŒ‡å®šé“¾çš„æ‰€æœ‰è§„åˆ™     #iptables -F                     //æ‰€æœ‰çš„è§„åˆ™-Z  è®¡æ•°æ¸…é›¶      å­—èŠ‚æ•°        æ•°æ®åŒ…ä¸ªæ•°      #iptables -Z                          //å–œçˆ±å—¯çœ‹åˆ°è®¡æ•°ç”¨#iptables -L -n -v   (vå¯æœ‰å·å¤šä¸ª)-L  æŸ¥çœ‹è§„åˆ™  -nä»¥æ•°å­—çš„å½¢å¼æ˜¾ç¤ºipå’Œç«¯å£åè®® --line æ˜¾ç¤ºè§„åˆ™è¡Œå·  -væµé‡è®¡æ•°(verbose æ•°æ®åŒ…çš„è®¡æ•°)  #iptables  -L   #iptables  -L -n  #iptables -L -n --line    #iptables  -L -n   -v                       åŒ¹é…æ¡ä»¶ï¼šåŸºæœ¬åŒ¹é…    åœ¨ä½¿ç”¨åè®®çš„æ—¶å€™ä¸å¿…éå¾—å†™ç«¯å£ï¼Œä½†æ˜¯ä½¿ç”¨ç«¯å£æ˜¯å¿…é¡»è·Ÿåè®®    åè®®                          /etc/protocols  ---icmpåè®®ç°‡    /etc/servers --TCP/IPåè®®ç°‡        -p            tcp udp  icmp           -ptcp    ç«¯å£                                  --sport    //æºç«¯å£                 # iptables -A INPUT -p tcp --sport 22 -s 10.18.44.208 -j REJECT                            # iptables _A INPUT -p tcp --sport 22:30 -s 10.18.44.208,10.18.44.209,10.18.44.210 -j REJECT              --dport    //ç›®æ ‡ç«¯å£                # iptables -A INPUT -p tcp --dport 22 -s 10.18.44.208 -j REJECT    ip          -s                  #iptables -A INPUT -p tcp --dport 20:30 -s 10.18.44.208/24 -j REJECT   // åœ¨iptablesä¸­  10.18.44.208/24  å…¶å®æ˜¯10.18.44.0/24          -d</code></pre>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> iptables </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Redis-ç®€ä»‹</title>
      <link href="2018/12/05/sql/redis/"/>
      <url>2018/12/05/sql/redis/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h2 id="redis"><a href="#redis" class="headerlink" title="redis"></a>redis</h2><p><img src="https://i.loli.net/2019/05/03/5ccc19cfabc71.jpg" alt=""></p><h3 id="redisç®€ä»‹"><a href="#redisç®€ä»‹" class="headerlink" title="redisç®€ä»‹"></a>redisç®€ä»‹</h3><pre><code>ä»€ä¹ˆæ˜¯redisREmote DIctionary Server(Redis) æ˜¯ä¸€ä¸ªç”±Salvatore Sanfilippoå†™çš„key-valueå­˜å‚¨ç³»ç»Ÿã€‚Redisæ˜¯ä¸€ä¸ªå¼€æºçš„ä½¿ç”¨ANSI Cè¯­è¨€ç¼–å†™ã€éµå®ˆBSDåè®®ã€æ”¯æŒç½‘ç»œã€å¯åŸºäºå†…å­˜äº¦å¯æŒä¹…åŒ–çš„æ—¥å¿—å‹ã€Key-Valueæ•°æ®åº“ï¼Œå¹¶æä¾›å¤šç§è¯­è¨€çš„APIã€‚å®ƒé€šå¸¸è¢«ç§°ä¸ºæ•°æ®ç»“æ„æœåŠ¡å™¨ï¼Œå› ä¸ºå€¼ï¼ˆvalueï¼‰å¯ä»¥æ˜¯ å­—ç¬¦ä¸²(String), å“ˆå¸Œ(Hash), åˆ—è¡¨(list), é›†åˆ(sets) å’Œ æœ‰åºé›†åˆ(sorted sets)ç­‰ç±»å‹ã€‚redisæ˜¯ä¸€ä¸ªå¼€æºçš„ã€ä½¿ç”¨Cè¯­è¨€ç¼–å†™çš„ã€æ”¯æŒç½‘ç»œäº¤äº’çš„ã€å¯åŸºäºå†…å­˜ä¹Ÿå¯æŒä¹…åŒ–çš„Key-Valueæ•°æ®åº“ã€‚redisçš„å®˜ç½‘ï¼šredis.ioæ³¨:åŸŸååç¼€ioå±äºå›½å®¶åŸŸåï¼Œæ˜¯british Indian Ocean territoryï¼Œå³è‹±å±å°åº¦æ´‹é¢†åœ°1.Redisæ˜¯ä¸€ä¸ªkey-valueå­˜å‚¨ç³»ç»Ÿã€‚å’ŒMemcachedç±»ä¼¼ï¼Œå®ƒæ”¯æŒå­˜å‚¨çš„valueç±»å‹ç›¸å¯¹æ›´å¤šï¼ŒåŒ…æ‹¬string(å­—ç¬¦ä¸²)ã€list(é“¾è¡¨)ã€set(é›†åˆ)ã€zset(sorted set â€“æœ‰åºé›†åˆ)å’Œhashï¼ˆå“ˆå¸Œç±»å‹ï¼‰ã€‚è¿™äº›æ•°æ®ç±»å‹éƒ½æ”¯æŒpush/popã€add/removeåŠå–äº¤é›†å¹¶é›†å’Œå·®é›†åŠæ›´ä¸°å¯Œçš„æ“ä½œï¼Œè€Œä¸”è¿™äº›æ“ä½œéƒ½æ˜¯åŸå­æ€§çš„ã€‚2.åœ¨æ­¤åŸºç¡€ä¸Šï¼Œredisæ”¯æŒå„ç§ä¸åŒæ–¹å¼çš„æ’åºã€‚ä¸memcachedä¸€æ ·ï¼Œä¸ºäº†ä¿è¯æ•ˆç‡ï¼Œæ•°æ®éƒ½æ˜¯ç¼“å­˜åœ¨å†…å­˜ä¸­ã€‚åŒºåˆ«çš„æ˜¯redisä¼šå‘¨æœŸæ€§çš„æŠŠæ›´æ–°çš„æ•°æ®å†™å…¥ç£ç›˜æˆ–è€…æŠŠä¿®æ”¹æ“ä½œå†™å…¥è¿½åŠ çš„è®°å½•æ–‡ä»¶ï¼Œå¹¶ä¸”åœ¨æ­¤åŸºç¡€ä¸Šå®ç°äº†master-slave(ä¸»ä»)åŒæ­¥ã€‚ Redis æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„key-valueæ•°æ®åº“ã€‚ redisçš„å‡ºç°ï¼Œå¾ˆå¤§ç¨‹åº¦è¡¥å¿äº†memcachedè¿™ç±»key/valueå­˜å‚¨çš„ä¸è¶³ï¼Œåœ¨éƒ¨ åˆ†åœºåˆå¯ä»¥å¯¹å…³ç³»æ•°æ®åº“èµ·åˆ°å¾ˆå¥½çš„è¡¥å……ä½œç”¨ã€‚å®ƒæä¾›äº†Javaï¼ŒC/C++ï¼ŒC#ï¼ŒPHPï¼ŒJavaScriptï¼ŒPerlï¼ŒObject-Cï¼ŒPythonï¼ŒRubyï¼ŒErlangç­‰å®¢æˆ·ç«¯ï¼Œä½¿ç”¨å¾ˆæ–¹ä¾¿ã€‚3.Redisæ”¯æŒä¸»ä»åŒæ­¥ã€‚æ•°æ®å¯ä»¥ä»ä¸»æœåŠ¡å™¨å‘ä»»æ„æ•°é‡çš„ä»æœåŠ¡å™¨ä¸ŠåŒæ­¥ï¼Œä»æœåŠ¡å™¨å¯ä»¥æ˜¯å…³è”å…¶ä»–ä»æœåŠ¡å™¨çš„ä¸»æœåŠ¡å™¨ã€‚è¿™ä½¿å¾—Rediså¯æ‰§è¡Œå•å±‚æ ‘å¤åˆ¶ã€‚å­˜ç›˜å¯ä»¥æœ‰æ„æ— æ„çš„å¯¹æ•°æ®è¿›è¡Œå†™æ“ä½œã€‚ç”±äºå®Œå…¨å®ç°äº†å‘å¸ƒ/è®¢é˜…æœºåˆ¶ï¼Œä½¿å¾—ä»æ•°æ®åº“åœ¨ä»»ä½•åœ°æ–¹åŒæ­¥æ ‘æ—¶ï¼Œå¯è®¢é˜…ä¸€ä¸ªé¢‘é“å¹¶æ¥æ”¶ä¸»æœåŠ¡å™¨å®Œæ•´çš„æ¶ˆæ¯å‘å¸ƒè®°å½•ã€‚åŒæ­¥å¯¹è¯»å–æ“ä½œçš„å¯æ‰©å±•æ€§å’Œæ•°æ®å†—ä½™å¾ˆæœ‰å¸®åŠ©ã€‚</code></pre><pre><code>Redis ä¸å…¶ä»– key - value ç¼“å­˜äº§å“æœ‰ä»¥ä¸‹ä¸‰ä¸ªç‰¹ç‚¹ï¼š- Redisæ”¯æŒæ•°æ®çš„æŒä¹…åŒ–ï¼Œå¯ä»¥å°†å†…å­˜ä¸­çš„æ•°æ®ä¿å­˜åœ¨ç£ç›˜ä¸­ï¼Œé‡å¯çš„æ—¶å€™å¯ä»¥å†æ¬¡åŠ è½½è¿›è¡Œä½¿ç”¨ã€‚- Redisä¸ä»…ä»…æ”¯æŒç®€å•çš„key-valueç±»å‹çš„æ•°æ®ï¼ŒåŒæ—¶è¿˜æä¾›listï¼Œsetï¼Œzsetï¼Œhashç­‰æ•°æ®ç»“æ„çš„å­˜å‚¨ã€‚- Redisæ”¯æŒæ•°æ®çš„å¤‡ä»½ï¼Œå³master-slaveæ¨¡å¼çš„æ•°æ®å¤‡ä»½ã€‚</code></pre><h3 id="redisä¼˜åŠ¿"><a href="#redisä¼˜åŠ¿" class="headerlink" title="redisä¼˜åŠ¿"></a>redisä¼˜åŠ¿</h3><pre><code>- æ€§èƒ½æé«˜ â€“ Redisèƒ½è¯»çš„é€Ÿåº¦æ˜¯110000æ¬¡/s,å†™çš„é€Ÿåº¦æ˜¯81000æ¬¡/s ã€‚- ä¸°å¯Œçš„æ•°æ®ç±»å‹ â€“ Redisæ”¯æŒäºŒè¿›åˆ¶æ¡ˆä¾‹çš„ Strings, Lists, Hashes, Sets åŠ Ordered Sets æ•°æ®ç±»å‹æ“ä½œã€‚- åŸå­ â€“ Redisçš„æ‰€æœ‰æ“ä½œéƒ½æ˜¯åŸå­æ€§çš„ï¼Œæ„æ€å°±æ˜¯è¦ä¹ˆæˆåŠŸæ‰§è¡Œè¦ä¹ˆå¤±è´¥å®Œå…¨ä¸æ‰§è¡Œã€‚å•ä¸ªæ“ä½œæ˜¯åŸå­æ€§çš„ã€‚å¤šä¸ªæ“ä½œä¹Ÿæ”¯æŒäº‹åŠ¡ï¼Œå³åŸå­æ€§ï¼Œé€šè¿‡MULTIå’ŒEXECæŒ‡ä»¤åŒ…èµ·æ¥ã€‚- ä¸°å¯Œçš„ç‰¹æ€§ â€“ Redisè¿˜æ”¯æŒ publish/subscribe, é€šçŸ¥, key è¿‡æœŸç­‰ç­‰ç‰¹æ€§ã€‚</code></pre><h3 id="rediså®‰è£…"><a href="#rediså®‰è£…" class="headerlink" title="rediså®‰è£…"></a>rediså®‰è£…</h3><pre><code>ä¸‹è½½åœ°å€http://redis.io/downloadï¼Œä¸‹è½½æœ€æ–°ç¨³å®šç‰ˆæœ¬ã€‚$ wget http://download.redis.io/releases/redis-5.0.4.tar.gz$ tar xzf redis-5.0.4.tar.gz$ cd redis-5.0.4.tar.gz$ yum install -y make gcc$ make</code></pre><h3 id="redisç®€å•é…ç½®"><a href="#redisç®€å•é…ç½®" class="headerlink" title="redisç®€å•é…ç½®"></a>redisç®€å•é…ç½®</h3><pre><code># cp redis.conf redis.conf.bak# vim redis.conf     ---ä¿®æ”¹å¦‚ä¸‹bind 127.0.0.1ã€€ã€€#åªç›‘å¬å†…ç½‘IPdaemonize yesã€€ã€€ã€€ã€€ã€€#å¼€å¯åå°æ¨¡å¼å°†onæ”¹ä¸ºyestimeout 300ã€€ã€€ã€€ã€€ã€€ã€€#è¿æ¥è¶…æ—¶æ—¶é—´port 6379                      #ç«¯å£å·databases 0                 å­˜å‚¨Sessionçš„Redisåº“ç¼–å·dir ./ã€€ã€€#æœ¬åœ°æ•°æ®åº“å­˜æ”¾ç›®å½•è¯¥ç›®å½•éœ€è¦å­˜åœ¨pidfile /var/run/redis_6379.pidã€€ã€€#å®šä¹‰pidæ–‡ä»¶logfile /var/log/redis_6379.logã€€ã€€#å®šä¹‰logæ–‡ä»¶requirepass cyy     # è®¾ç½®å¯†ç </code></pre><h3 id="é…ç½®redisä¸ºsystemctlå¯åŠ¨"><a href="#é…ç½®redisä¸ºsystemctlå¯åŠ¨" class="headerlink" title="é…ç½®redisä¸ºsystemctlå¯åŠ¨"></a>é…ç½®redisä¸ºsystemctlå¯åŠ¨</h3><pre><code># cd /lib/systemd/system# vim /lib/systemd/system/redis.service[Unit]Description=RedisAfter=network.target[Service]ExecStart=/usr/local/redis-5.0.4/src/redis-server /usr/local/redis-5.0.4/redis.conf  --daemonize noExecStop=/usr/local/redis-5.0.4/src/redis-cli -h 127.0.0.1 -p 6379 shutdown[Install]WantedBy=multi-user.target=====================å‚æ•°è¯¦è§£:â€¢ [Unit] è¡¨ç¤ºè¿™æ˜¯åŸºç¡€ä¿¡æ¯ â€¢ Description æ˜¯æè¿°â€¢ After æ˜¯åœ¨é‚£ä¸ªæœåŠ¡åé¢å¯åŠ¨ï¼Œä¸€èˆ¬æ˜¯ç½‘ç»œæœåŠ¡å¯åŠ¨åå¯åŠ¨â€¢ [Service] è¡¨ç¤ºè¿™é‡Œæ˜¯æœåŠ¡ä¿¡æ¯ â€¢ ExecStart æ˜¯å¯åŠ¨æœåŠ¡çš„å‘½ä»¤â€¢ ExecStop æ˜¯åœæ­¢æœåŠ¡çš„æŒ‡ä»¤â€¢ [Install] è¡¨ç¤ºè¿™æ˜¯æ˜¯å®‰è£…ç›¸å…³ä¿¡æ¯ â€¢ WantedBy æ˜¯ä»¥å“ªç§æ–¹å¼å¯åŠ¨ï¼šmulti-user.targetè¡¨æ˜å½“ç³»ç»Ÿä»¥å¤šç”¨æˆ·æ–¹å¼ï¼ˆé»˜è®¤çš„è¿è¡Œçº§åˆ«ï¼‰å¯åŠ¨æ—¶ï¼Œè¿™ä¸ªæœåŠ¡éœ€è¦è¢«è‡ªåŠ¨è¿è¡Œã€‚</code></pre><h3 id="rediså¯åŠ¨"><a href="#rediså¯åŠ¨" class="headerlink" title="rediså¯åŠ¨"></a>rediså¯åŠ¨</h3><pre><code>makeå®Œå redis-5.0.4ç›®å½•ä¸‹ä¼šå‡ºç°ç¼–è¯‘åçš„redisæœåŠ¡ç¨‹åºredis-server,è¿˜æœ‰ç”¨äºæµ‹è¯•çš„å®¢æˆ·ç«¯ç¨‹åºredis-cli,ä¸¤ä¸ªç¨‹åºä½äºå®‰è£…ç›®å½• src ç›®å½•ä¸‹ï¼šä¸‹é¢å¯åŠ¨redisæœåŠ¡.</code></pre><p><img src="https://i.loli.net/2019/05/07/5cd186575317a.jpg" alt=""></p><pre><code>$ src/redis-serveræ³¨æ„è¿™ç§æ–¹å¼å¯åŠ¨redis ä½¿ç”¨çš„æ˜¯é»˜è®¤é…ç½®ã€‚ä¹Ÿå¯ä»¥é€šè¿‡å¯åŠ¨å‚æ•°å‘Šè¯‰redisä½¿ç”¨æŒ‡å®šé…ç½®æ–‡ä»¶ä½¿ç”¨ä¸‹é¢å‘½ä»¤å¯åŠ¨ã€‚$ cd src$ ./redis-server ../redis.confredis.conf æ˜¯ä¸€ä¸ªé»˜è®¤çš„é…ç½®æ–‡ä»¶ã€‚æˆ‘ä»¬å¯ä»¥æ ¹æ®éœ€è¦ä½¿ç”¨è‡ªå·±çš„é…ç½®æ–‡ä»¶ã€‚</code></pre><h3 id="rediså®¢æˆ·ç«¯æµ‹è¯•"><a href="#rediså®¢æˆ·ç«¯æµ‹è¯•" class="headerlink" title="rediså®¢æˆ·ç«¯æµ‹è¯•"></a>rediså®¢æˆ·ç«¯æµ‹è¯•</h3><pre><code>$ src/redis-cli127.0.0.1:6379&gt; set 2020 GZOK127.0.0.1:6379&gt; get 2020&quot;GZ&quot;127.0.0.1:6379&gt; pingPONG</code></pre><h3 id="redisé…ç½®"><a href="#redisé…ç½®" class="headerlink" title="redisé…ç½®"></a>redisé…ç½®</h3><pre><code>redisçš„é…ç½®é»˜è®¤ä½äºrediså®‰è£…ç›®å½•ä¸‹ï¼Œæ–‡ä»¶åæœªredis.confRedis CONFIG å‘½ä»¤æ ¼å¼å¦‚ä¸‹ï¼šredis 127.0.0.1:6379&gt; CONFIG GET CONFIG_SETTING_NAMEä¹Ÿå¯ä»¥é€šè¿‡å‘½ä»¤æŸ¥çœ‹æˆ–è®¾ç½®ç›¸å…³é…ç½®127.0.0.1:6379&gt; config get loglevel1) &quot;loglevel&quot;2) &quot;notice&quot;é€šè¿‡* æŸ¥çœ‹æ‰€æœ‰é…ç½®127.0.0.1:6379&gt; config get *  1) &quot;dbfilename&quot;  2) &quot;dump.rdb&quot;  3) &quot;requirepass&quot;  4) &quot;&quot;  5) &quot;masterauth&quot;  6) &quot;&quot;  7) &quot;cluster-announce-ip&quot;  8) &quot;&quot;  9) &quot;unixsocket&quot; 10) &quot;&quot; 11) &quot;logfile&quot; 12) &quot;&quot; 13) &quot;pidfile&quot; 14) &quot;&quot; 15) &quot;slave-announce-ip&quot; 16) &quot;&quot; 17) &quot;replica-announce-ip&quot; 18) &quot;&quot; 19) &quot;maxmemory&quot; 20) &quot;0&quot; 21) &quot;proto-max-bulk-len&quot; 22) &quot;536870912&quot; 23) &quot;client-query-buffer-limit&quot; 24) &quot;1073741824&quot; 25) &quot;maxmemory-samples&quot; 26) &quot;5&quot; 27) &quot;lfu-log-factor&quot; 28) &quot;10&quot; 29) &quot;lfu-decay-time&quot; 30) &quot;1&quot; 31) &quot;timeout&quot; 32) &quot;0&quot; 33) &quot;active-defrag-threshold-lower&quot; 34) &quot;10&quot; 35) &quot;active-defrag-threshold-upper&quot; 36) &quot;100&quot; 37) &quot;active-defrag-ignore-bytes&quot; 38) &quot;104857600&quot; 39) &quot;active-defrag-cycle-min&quot; 40) &quot;5&quot; 41) &quot;active-defrag-cycle-max&quot; 42) &quot;75&quot; 43) &quot;active-defrag-max-scan-fields&quot; 44) &quot;1000&quot; 45) &quot;auto-aof-rewrite-percentage&quot; 46) &quot;100&quot; 47) &quot;auto-aof-rewrite-min-size&quot; 48) &quot;67108864&quot; 49) &quot;hash-max-ziplist-entries&quot; 50) &quot;512&quot; 51) &quot;hash-max-ziplist-value&quot; 52) &quot;64&quot; 53) &quot;stream-node-max-bytes&quot; 54) &quot;4096&quot; 55) &quot;stream-node-max-entries&quot; 56) &quot;100&quot; 57) &quot;list-max-ziplist-size&quot; 58) &quot;-2&quot; 59) &quot;list-compress-depth&quot; 60) &quot;0&quot; 61) &quot;set-max-intset-entries&quot; 62) &quot;512&quot; 63) &quot;zset-max-ziplist-entries&quot; 64) &quot;128&quot; 65) &quot;zset-max-ziplist-value&quot; 66) &quot;64&quot; 67) &quot;hll-sparse-max-bytes&quot; 68) &quot;3000&quot; 69) &quot;lua-time-limit&quot; 70) &quot;5000&quot; 71) &quot;slowlog-log-slower-than&quot; 72) &quot;10000&quot; 73) &quot;latency-monitor-threshold&quot; 74) &quot;0&quot; 75) &quot;slowlog-max-len&quot; 76) &quot;128&quot; 77) &quot;port&quot; 78) &quot;6379&quot; 79) &quot;cluster-announce-port&quot; 80) &quot;0&quot;ã€‚ã€‚ã€‚</code></pre><p>ç¼–è¾‘é…ç½®</p><p>å¯ä»¥é€šè¿‡ä¿®æ”¹redis.confæ–‡ä»¶æˆ–è€…ä½¿ç”¨ CONFIG setmå‘½ä»¤ä¿®æ”¹é…ç½®</p><pre><code>CONFIG set è¯­æ³•å¦‚ä¸‹redis 127.0.0.1:6379&gt; CONFIG SET CONFIG_SETTING_NAME NEW_CONFIG_VALUEç¤ºä¾‹redis 127.0.0.1:6379&gt; CONFIG SET loglevel &quot;notice&quot;OKredis 127.0.0.1:6379&gt; CONFIG GET loglevel1) &quot;loglevel&quot;2) &quot;notice&quot;</code></pre><p>ç›¸å…³é…ç½®å‚æ•°è¯¦è§£</p><pre><code> Redisé…ç½®æ–‡ä»¶å‚æ•°è¯´æ˜:1. Redisé»˜è®¤ä¸æ˜¯ä»¥å®ˆæŠ¤è¿›ç¨‹çš„æ–¹å¼è¿è¡Œï¼Œå¯ä»¥é€šè¿‡è¯¥é…ç½®é¡¹ä¿®æ”¹ï¼Œä½¿ç”¨yeså¯ç”¨å®ˆæŠ¤è¿›ç¨‹daemonize no2. å½“Redisä»¥å®ˆæŠ¤è¿›ç¨‹æ–¹å¼è¿è¡Œæ—¶ï¼ŒRedisé»˜è®¤ä¼šæŠŠpidå†™å…¥/var/run/redis.pidæ–‡ä»¶ï¼Œå¯ä»¥é€šè¿‡pidfileæŒ‡å®špidfile /var/run/redis.pid3. æŒ‡å®šRedisç›‘å¬ç«¯å£ï¼Œé»˜è®¤ç«¯å£ä¸º6379ï¼Œä½œè€…åœ¨è‡ªå·±çš„ä¸€ç¯‡åšæ–‡ä¸­è§£é‡Šäº†ä¸ºä»€ä¹ˆé€‰ç”¨6379ä½œä¸ºé»˜è®¤ç«¯å£ï¼Œå› ä¸º6379åœ¨æ‰‹æœºæŒ‰é”®ä¸ŠMERZå¯¹åº”çš„å·ç ï¼Œè€ŒMERZå–è‡ªæ„å¤§åˆ©æ­Œå¥³Alessia Merzçš„åå­—port 63794. ç»‘å®šçš„ä¸»æœºåœ°å€bind 127.0.0.15.å½“ å®¢æˆ·ç«¯é—²ç½®å¤šé•¿æ—¶é—´åå…³é—­è¿æ¥ï¼Œå¦‚æœæŒ‡å®šä¸º0ï¼Œè¡¨ç¤ºå…³é—­è¯¥åŠŸèƒ½timeout 3006. æŒ‡å®šæ—¥å¿—è®°å½•çº§åˆ«ï¼ŒRedisæ€»å…±æ”¯æŒå››ä¸ªçº§åˆ«ï¼šdebugã€verboseã€noticeã€warningï¼Œé»˜è®¤ä¸ºverboseloglevel verbose7. æ—¥å¿—è®°å½•æ–¹å¼ï¼Œé»˜è®¤ä¸ºæ ‡å‡†è¾“å‡ºï¼Œå¦‚æœé…ç½®Redisä¸ºå®ˆæŠ¤è¿›ç¨‹æ–¹å¼è¿è¡Œï¼Œè€Œè¿™é‡Œåˆé…ç½®ä¸ºæ—¥å¿—è®°å½•æ–¹å¼ä¸ºæ ‡å‡†è¾“å‡ºï¼Œåˆ™æ—¥å¿—å°†ä¼šå‘é€ç»™/dev/nulllogfile stdout8. è®¾ç½®æ•°æ®åº“çš„æ•°é‡ï¼Œé»˜è®¤æ•°æ®åº“ä¸º0ï¼Œå¯ä»¥ä½¿ç”¨SELECT &lt;dbid&gt;å‘½ä»¤åœ¨è¿æ¥ä¸ŠæŒ‡å®šæ•°æ®åº“iddatabases 169. æŒ‡å®šåœ¨å¤šé•¿æ—¶é—´å†…ï¼Œæœ‰å¤šå°‘æ¬¡æ›´æ–°æ“ä½œï¼Œå°±å°†æ•°æ®åŒæ­¥åˆ°æ•°æ®æ–‡ä»¶ï¼Œå¯ä»¥å¤šä¸ªæ¡ä»¶é…åˆsave &lt;seconds&gt; &lt;changes&gt;Redisé»˜è®¤é…ç½®æ–‡ä»¶ä¸­æä¾›äº†ä¸‰ä¸ªæ¡ä»¶ï¼šsave 900 1save 300 10save 60 10000åˆ†åˆ«è¡¨ç¤º900ç§’ï¼ˆ15åˆ†é’Ÿï¼‰å†…æœ‰1ä¸ªæ›´æ”¹ï¼Œ300ç§’ï¼ˆ5åˆ†é’Ÿï¼‰å†…æœ‰10ä¸ªæ›´æ”¹ä»¥åŠ60ç§’å†…æœ‰10000ä¸ªæ›´æ”¹ã€‚10. æŒ‡å®šå­˜å‚¨è‡³æœ¬åœ°æ•°æ®åº“æ—¶æ˜¯å¦å‹ç¼©æ•°æ®ï¼Œé»˜è®¤ä¸ºyesï¼ŒRedisé‡‡ç”¨LZFå‹ç¼©ï¼Œå¦‚æœä¸ºäº†èŠ‚çœCPUæ—¶é—´ï¼Œå¯ä»¥å…³é—­è¯¥é€‰é¡¹ï¼Œä½†ä¼šå¯¼è‡´æ•°æ®åº“æ–‡ä»¶å˜çš„å·¨å¤§rdbcompression yes11. æŒ‡å®šæœ¬åœ°æ•°æ®åº“æ–‡ä»¶åï¼Œé»˜è®¤å€¼ä¸ºdump.rdbdbfilename dump.rdb12. æŒ‡å®šæœ¬åœ°æ•°æ®åº“å­˜æ”¾ç›®å½•dir ./13. è®¾ç½®å½“æœ¬æœºä¸ºslavæœåŠ¡æ—¶ï¼Œè®¾ç½®masteræœåŠ¡çš„IPåœ°å€åŠç«¯å£ï¼Œåœ¨Rediså¯åŠ¨æ—¶ï¼Œå®ƒä¼šè‡ªåŠ¨ä»masterè¿›è¡Œæ•°æ®åŒæ­¥slaveof &lt;masterip&gt; &lt;masterport&gt;14. å½“masteræœåŠ¡è®¾ç½®äº†å¯†ç ä¿æŠ¤æ—¶ï¼ŒslavæœåŠ¡è¿æ¥masterçš„å¯†ç masterauth &lt;master-password&gt;15. è®¾ç½®Redisè¿æ¥å¯†ç ï¼Œå¦‚æœé…ç½®äº†è¿æ¥å¯†ç ï¼Œå®¢æˆ·ç«¯åœ¨è¿æ¥Redisæ—¶éœ€è¦é€šè¿‡AUTH &lt;password&gt;å‘½ä»¤æä¾›å¯†ç ï¼Œé»˜è®¤å…³é—­requirepass foobared16. è®¾ç½®åŒä¸€æ—¶é—´æœ€å¤§å®¢æˆ·ç«¯è¿æ¥æ•°ï¼Œé»˜è®¤æ— é™åˆ¶ï¼ŒRediså¯ä»¥åŒæ—¶æ‰“å¼€çš„å®¢æˆ·ç«¯è¿æ¥æ•°ä¸ºRedisè¿›ç¨‹å¯ä»¥æ‰“å¼€çš„æœ€å¤§æ–‡ä»¶æè¿°ç¬¦æ•°ï¼Œå¦‚æœè®¾ç½® maxclients 0ï¼Œè¡¨ç¤ºä¸ä½œé™åˆ¶ã€‚å½“å®¢æˆ·ç«¯è¿æ¥æ•°åˆ°è¾¾é™åˆ¶æ—¶ï¼ŒRedisä¼šå…³é—­æ–°çš„è¿æ¥å¹¶å‘å®¢æˆ·ç«¯è¿”å›max number of clients reachedé”™è¯¯ä¿¡æ¯maxclients 12817. æŒ‡å®šRedisæœ€å¤§å†…å­˜é™åˆ¶ï¼ŒRedisåœ¨å¯åŠ¨æ—¶ä¼šæŠŠæ•°æ®åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œè¾¾åˆ°æœ€å¤§å†…å­˜åï¼ŒRedisä¼šå…ˆå°è¯•æ¸…é™¤å·²åˆ°æœŸæˆ–å³å°†åˆ°æœŸçš„Keyï¼Œå½“æ­¤æ–¹æ³•å¤„ç† åï¼Œä»ç„¶åˆ°è¾¾æœ€å¤§å†…å­˜è®¾ç½®ï¼Œå°†æ— æ³•å†è¿›è¡Œå†™å…¥æ“ä½œï¼Œä½†ä»ç„¶å¯ä»¥è¿›è¡Œè¯»å–æ“ä½œã€‚Redisæ–°çš„vmæœºåˆ¶ï¼Œä¼šæŠŠKeyå­˜æ”¾å†…å­˜ï¼ŒValueä¼šå­˜æ”¾åœ¨swapåŒºmaxmemory &lt;bytes&gt;18. æŒ‡å®šæ˜¯å¦åœ¨æ¯æ¬¡æ›´æ–°æ“ä½œåè¿›è¡Œæ—¥å¿—è®°å½•ï¼ŒRedisåœ¨é»˜è®¤æƒ…å†µä¸‹æ˜¯å¼‚æ­¥çš„æŠŠæ•°æ®å†™å…¥ç£ç›˜ï¼Œå¦‚æœä¸å¼€å¯ï¼Œå¯èƒ½ä¼šåœ¨æ–­ç”µæ—¶å¯¼è‡´ä¸€æ®µæ—¶é—´å†…çš„æ•°æ®ä¸¢å¤±ã€‚å› ä¸º redisæœ¬èº«åŒæ­¥æ•°æ®æ–‡ä»¶æ˜¯æŒ‰ä¸Šé¢saveæ¡ä»¶æ¥åŒæ­¥çš„ï¼Œæ‰€ä»¥æœ‰çš„æ•°æ®ä¼šåœ¨ä¸€æ®µæ—¶é—´å†…åªå­˜åœ¨äºå†…å­˜ä¸­ã€‚é»˜è®¤ä¸ºnoappendonly no19. æŒ‡å®šæ›´æ–°æ—¥å¿—æ–‡ä»¶åï¼Œé»˜è®¤ä¸ºappendonly.aofappendfilename appendonly.aof20. æŒ‡å®šæ›´æ–°æ—¥å¿—æ¡ä»¶ï¼Œå…±æœ‰3ä¸ªå¯é€‰å€¼ï¼šnoï¼šè¡¨ç¤ºç­‰æ“ä½œç³»ç»Ÿè¿›è¡Œæ•°æ®ç¼“å­˜åŒæ­¥åˆ°ç£ç›˜ï¼ˆå¿«ï¼‰alwaysï¼šè¡¨ç¤ºæ¯æ¬¡æ›´æ–°æ“ä½œåæ‰‹åŠ¨è°ƒç”¨fsync()å°†æ•°æ®å†™åˆ°ç£ç›˜ï¼ˆæ…¢ï¼Œå®‰å…¨ï¼‰everysecï¼šè¡¨ç¤ºæ¯ç§’åŒæ­¥ä¸€æ¬¡ï¼ˆæŠ˜è¡·ï¼Œé»˜è®¤å€¼ï¼‰appendfsync everysec21. æŒ‡å®šæ˜¯å¦å¯ç”¨è™šæ‹Ÿå†…å­˜æœºåˆ¶ï¼Œé»˜è®¤å€¼ä¸ºnoï¼Œç®€å•çš„ä»‹ç»ä¸€ä¸‹ï¼ŒVMæœºåˆ¶å°†æ•°æ®åˆ†é¡µå­˜æ”¾ï¼Œç”±Rediså°†è®¿é—®é‡è¾ƒå°‘çš„é¡µå³å†·æ•°æ®swapåˆ°ç£ç›˜ä¸Šï¼Œè®¿é—®å¤šçš„é¡µé¢ç”±ç£ç›˜è‡ªåŠ¨æ¢å‡ºåˆ°å†…å­˜ä¸­ï¼ˆåœ¨åé¢çš„æ–‡ç« æˆ‘ä¼šä»”ç»†åˆ†æRedisçš„VMæœºåˆ¶ï¼‰vm-enabled no22. è™šæ‹Ÿå†…å­˜æ–‡ä»¶è·¯å¾„ï¼Œé»˜è®¤å€¼ä¸º/tmp/redis.swapï¼Œä¸å¯å¤šä¸ªRediså®ä¾‹å…±äº«vm-swap-file /tmp/redis.swap23. å°†æ‰€æœ‰å¤§äºvm-max-memoryçš„æ•°æ®å­˜å…¥è™šæ‹Ÿå†…å­˜,æ— è®ºvm-max-memoryè®¾ç½®å¤šå°,æ‰€æœ‰ç´¢å¼•æ•°æ®éƒ½æ˜¯å†…å­˜å­˜å‚¨çš„(Redisçš„ç´¢å¼•æ•°æ® å°±æ˜¯keys),ä¹Ÿå°±æ˜¯è¯´,å½“vm-max-memoryè®¾ç½®ä¸º0çš„æ—¶å€™,å…¶å®æ˜¯æ‰€æœ‰valueéƒ½å­˜åœ¨äºç£ç›˜ã€‚é»˜è®¤å€¼ä¸º0vm-max-memory 024. Redis swapæ–‡ä»¶åˆ†æˆäº†å¾ˆå¤šçš„pageï¼Œä¸€ä¸ªå¯¹è±¡å¯ä»¥ä¿å­˜åœ¨å¤šä¸ªpageä¸Šé¢ï¼Œä½†ä¸€ä¸ªpageä¸Šä¸èƒ½è¢«å¤šä¸ªå¯¹è±¡å…±äº«ï¼Œvm-page-sizeæ˜¯è¦æ ¹æ®å­˜å‚¨çš„ æ•°æ®å¤§å°æ¥è®¾å®šçš„ï¼Œä½œè€…å»ºè®®å¦‚æœå­˜å‚¨å¾ˆå¤šå°å¯¹è±¡ï¼Œpageå¤§å°æœ€å¥½è®¾ç½®ä¸º32æˆ–è€…64bytesï¼›å¦‚æœå­˜å‚¨å¾ˆå¤§å¤§å¯¹è±¡ï¼Œåˆ™å¯ä»¥ä½¿ç”¨æ›´å¤§çš„pageï¼Œå¦‚æœä¸ ç¡®å®šï¼Œå°±ä½¿ç”¨é»˜è®¤å€¼vm-page-size 3225. è®¾ç½®swapæ–‡ä»¶ä¸­çš„pageæ•°é‡ï¼Œç”±äºé¡µè¡¨ï¼ˆä¸€ç§è¡¨ç¤ºé¡µé¢ç©ºé—²æˆ–ä½¿ç”¨çš„bitmapï¼‰æ˜¯åœ¨æ”¾åœ¨å†…å­˜ä¸­çš„ï¼Œï¼Œåœ¨ç£ç›˜ä¸Šæ¯8ä¸ªpageså°†æ¶ˆè€—1byteçš„å†…å­˜ã€‚vm-pages 13421772826. è®¾ç½®è®¿é—®swapæ–‡ä»¶çš„çº¿ç¨‹æ•°,æœ€å¥½ä¸è¦è¶…è¿‡æœºå™¨çš„æ ¸æ•°,å¦‚æœè®¾ç½®ä¸º0,é‚£ä¹ˆæ‰€æœ‰å¯¹swapæ–‡ä»¶çš„æ“ä½œéƒ½æ˜¯ä¸²è¡Œçš„ï¼Œå¯èƒ½ä¼šé€ æˆæ¯”è¾ƒé•¿æ—¶é—´çš„å»¶è¿Ÿã€‚é»˜è®¤å€¼ä¸º4vm-max-threads 427. è®¾ç½®åœ¨å‘å®¢æˆ·ç«¯åº”ç­”æ—¶ï¼Œæ˜¯å¦æŠŠè¾ƒå°çš„åŒ…åˆå¹¶ä¸ºä¸€ä¸ªåŒ…å‘é€ï¼Œé»˜è®¤ä¸ºå¼€å¯glueoutputbuf yes28. æŒ‡å®šåœ¨è¶…è¿‡ä¸€å®šçš„æ•°é‡æˆ–è€…æœ€å¤§çš„å…ƒç´ è¶…è¿‡æŸä¸€ä¸´ç•Œå€¼æ—¶ï¼Œé‡‡ç”¨ä¸€ç§ç‰¹æ®Šçš„å“ˆå¸Œç®—æ³•hash-max-zipmap-entries 64hash-max-zipmap-value 51229. æŒ‡å®šæ˜¯å¦æ¿€æ´»é‡ç½®å“ˆå¸Œï¼Œé»˜è®¤ä¸ºå¼€å¯ï¼ˆåé¢åœ¨ä»‹ç»Redisçš„å“ˆå¸Œç®—æ³•æ—¶å…·ä½“ä»‹ç»ï¼‰activerehashing yes</code></pre><h3 id="redisæ•°æ®ç±»å‹"><a href="#redisæ•°æ®ç±»å‹" class="headerlink" title="redisæ•°æ®ç±»å‹"></a>redisæ•°æ®ç±»å‹</h3><pre><code>Redisæ”¯æŒäº”ç§æ•°æ®ç±»å‹ï¼šstringï¼ˆå­—ç¬¦ä¸²ï¼‰ï¼Œhashï¼ˆå“ˆå¸Œï¼‰ï¼Œlistï¼ˆåˆ—è¡¨ï¼‰ï¼Œsetï¼ˆé›†åˆï¼‰åŠzset(sorted setï¼šæœ‰åºé›†åˆ)ã€‚</code></pre><h4 id="string"><a href="#string" class="headerlink" title="string"></a>string</h4><pre><code>string æ˜¯ redis æœ€åŸºæœ¬çš„ç±»å‹ï¼Œä½ å¯ä»¥ç†è§£æˆä¸ Memcached ä¸€æ¨¡ä¸€æ ·çš„ç±»å‹ï¼Œä¸€ä¸ª key å¯¹åº”ä¸€ä¸ª valueã€‚string ç±»å‹æ˜¯äºŒè¿›åˆ¶å®‰å…¨çš„ã€‚æ„æ€æ˜¯ redis çš„ string å¯ä»¥åŒ…å«ä»»ä½•æ•°æ®ã€‚æ¯”å¦‚jpgå›¾ç‰‡æˆ–è€…åºåˆ—åŒ–çš„å¯¹è±¡ã€‚string ç±»å‹æ˜¯ Redis æœ€åŸºæœ¬çš„æ•°æ®ç±»å‹ï¼Œstring ç±»å‹çš„å€¼æœ€å¤§èƒ½å­˜å‚¨ 512MB127.0.0.1:6379&gt; set name cyylogOK127.0.0.1:6379&gt; get name&quot;cyylog&quot;æˆ‘ä»¬ä½¿ç”¨äº† Redis çš„ SET å’Œ GET å‘½ä»¤ã€‚é”®ä¸º nameï¼Œå¯¹åº”çš„å€¼ä¸º cyylog</code></pre><h4 id="hash"><a href="#hash" class="headerlink" title="hash"></a>hash</h4><pre><code>Redis hash æ˜¯ä¸€ä¸ªé”®å€¼(key=&gt;value)å¯¹é›†åˆã€‚Redis hash æ˜¯ä¸€ä¸ª string ç±»å‹çš„ field å’Œ value çš„æ˜ å°„è¡¨ï¼Œhash ç‰¹åˆ«é€‚åˆç”¨äºå­˜å‚¨å¯¹è±¡ã€‚ç¤ºä¾‹:127.0.0.1:6379&gt; hmset myhash name tiger name2 fiveOK127.0.0.1:6379&gt; hget myhash name&quot;tiger&quot;127.0.0.1:6379&gt; hget myhash name2&quot;five&quot;å®ä¾‹ä¸­æˆ‘ä»¬ä½¿ç”¨äº† Redis HMSET, HGET å‘½ä»¤ï¼ŒHMSET è®¾ç½®äº†ä¸¤ä¸ª field=&gt;value å¯¹, HGET è·å–å¯¹åº” field å¯¹åº”çš„ valueã€‚æ¯ä¸ª hash å¯ä»¥å­˜å‚¨ 232 -1 é”®å€¼å¯¹ï¼ˆ40å¤šäº¿ï¼‰ã€‚</code></pre><h4 id="List"><a href="#List" class="headerlink" title="List"></a>List</h4><pre><code>Redis åˆ—è¡¨æ˜¯ç®€å•çš„å­—ç¬¦ä¸²åˆ—è¡¨ï¼ŒæŒ‰ç…§æ’å…¥é¡ºåºæ’åºã€‚ä½ å¯ä»¥æ·»åŠ ä¸€ä¸ªå…ƒç´ åˆ°åˆ—è¡¨çš„å¤´éƒ¨ï¼ˆå·¦è¾¹ï¼‰æˆ–è€…å°¾éƒ¨ï¼ˆå³è¾¹ï¼‰ã€‚ç¤ºä¾‹127.0.0.1:6379&gt; lpush mylist redis1(integer) 1127.0.0.1:6379&gt; lpush mylist redis2 redis3 redis4(integer) 4127.0.0.1:6379&gt; lpush mylist tiger 2020(integer) 6127.0.0.1:6379&gt; lrange mylist 0 31) &quot;2020&quot;2) &quot;tiger&quot;3) &quot;redis4&quot;4) &quot;redis3&quot;127.0.0.1:6379&gt; lrange mylist 0 101) &quot;2020&quot;2) &quot;tiger&quot;3) &quot;redis4&quot;4) &quot;redis3&quot;5) &quot;redis2&quot;6) &quot;redis1&quot;ä¸Šè¿°ç¤ºä¾‹æˆ‘ä»¬é€šè¿‡ lpush åˆ›å»ºlistå¹¶æ·»åŠ æ•°æ®ï¼Œé€šè¿‡lrangeè·å–åˆ—è¡¨ä¸­çš„æ•°æ®åˆ—è¡¨æœ€å¤šå¯å­˜å‚¨ 232 - 1 å…ƒç´  (4294967295, æ¯ä¸ªåˆ—è¡¨å¯å­˜å‚¨40å¤šäº¿)ã€‚</code></pre><h4 id="set"><a href="#set" class="headerlink" title="set"></a>set</h4><pre><code>Redisçš„Setæ˜¯stringç±»å‹çš„æ— åºé›†åˆã€‚é›†åˆæ˜¯é€šè¿‡å“ˆå¸Œè¡¨å®ç°çš„ï¼Œæ‰€ä»¥æ·»åŠ ï¼Œåˆ é™¤ï¼ŒæŸ¥æ‰¾çš„å¤æ‚åº¦éƒ½æ˜¯O(1)ã€‚sadd å‘½ä»¤æ·»åŠ ä¸€ä¸ª string å…ƒç´ åˆ° key å¯¹åº”çš„ set é›†åˆä¸­ï¼ŒæˆåŠŸè¿”å›1ï¼Œå¦‚æœå…ƒç´ å·²ç»åœ¨é›†åˆä¸­è¿”å› 0ï¼Œå¦‚æœ key å¯¹åº”çš„ set ä¸å­˜åœ¨åˆ™è¿”å›é”™è¯¯ã€‚ç¤ºä¾‹127.0.0.1:6379&gt; sadd myset GZ BJ ZZ BK(integer) 4127.0.0.1:6379&gt; sadd myset TJ(integer) 1127.0.0.1:6379&gt; sadd myset TJ(integer) 0127.0.0.1:6379&gt; smembers myset 1) &quot;BJ&quot;2) &quot;BK&quot;3) &quot;TJ&quot;4) &quot;GZ&quot;5) &quot;ZZ&quot;127.0.0.1:6379&gt; sadd myset SZ(integer) 1127.0.0.1:6379&gt; smembers myset 1) &quot;BJ&quot;2) &quot;BK&quot;3) &quot;TJ&quot;4) &quot;GZ&quot;5) &quot;ZZ&quot;6) &quot;SZ&quot;æ³¨æ„ï¼šä»¥ä¸Šå®ä¾‹ä¸­ TJ æ·»åŠ äº†ä¸¤æ¬¡ï¼Œä½†æ ¹æ®é›†åˆå†…å…ƒç´ çš„å”¯ä¸€æ€§ï¼Œç¬¬äºŒæ¬¡æ’å…¥çš„å…ƒç´ å°†è¢«å¿½ç•¥ã€‚é›†åˆä¸­æœ€å¤§çš„æˆå‘˜æ•°ä¸º 232 - 1(4294967295, æ¯ä¸ªé›†åˆå¯å­˜å‚¨40å¤šäº¿ä¸ªæˆå‘˜)ã€‚</code></pre><h4 id="zset"><a href="#zset" class="headerlink" title="zset"></a>zset</h4><pre><code>Redis zset å’Œ set ä¸€æ ·ä¹Ÿæ˜¯stringç±»å‹å…ƒç´ çš„é›†åˆ,ä¸”ä¸å…è®¸é‡å¤çš„æˆå‘˜ã€‚ä¸åŒçš„æ˜¯æ¯ä¸ªå…ƒç´ éƒ½ä¼šå…³è”ä¸€ä¸ªdoubleç±»å‹çš„åˆ†æ•°ã€‚redisæ­£æ˜¯é€šè¿‡åˆ†æ•°æ¥ä¸ºé›†åˆä¸­çš„æˆå‘˜è¿›è¡Œä»å°åˆ°å¤§çš„æ’åºã€‚zsetçš„æˆå‘˜æ˜¯å”¯ä¸€çš„,ä½†åˆ†æ•°(score)å´å¯ä»¥é‡å¤ã€‚zadd å‘½ä»¤æ·»åŠ å…ƒç´ åˆ°é›†åˆï¼Œå…ƒç´ åœ¨é›†åˆä¸­å­˜åœ¨åˆ™æ›´æ–°å¯¹åº”scoreç¤ºä¾‹127.0.0.1:6379&gt; zadd myzset 0 GZ(integer) 1127.0.0.1:6379&gt; zadd myzset 0 BJ(integer) 1127.0.0.1:6379&gt; zadd myzset 0 ZZ(integer) 1127.0.0.1:6379&gt; zrangebyscore myzset 0 51) &quot;BJ&quot;2) &quot;GZ&quot;3) &quot;ZZ&quot;</code></pre><pre><code>æ³¨æ„ï¼šRedisæ”¯æŒå¤šä¸ªæ•°æ®åº“ï¼Œå¹¶ä¸”æ¯ä¸ªæ•°æ®åº“çš„æ•°æ®æ˜¯éš”ç¦»çš„ä¸èƒ½å…±äº«ï¼Œå¹¶ä¸”åŸºäºå•æœºæ‰æœ‰ï¼Œå¦‚æœæ˜¯é›†ç¾¤å°±æ²¡æœ‰æ•°æ®åº“çš„æ¦‚å¿µã€‚Redisæ˜¯ä¸€ä¸ªå­—å…¸ç»“æ„çš„å­˜å‚¨æœåŠ¡å™¨ï¼Œè€Œå®é™…ä¸Šä¸€ä¸ªRediså®ä¾‹æä¾›äº†å¤šä¸ªç”¨æ¥å­˜å‚¨æ•°æ®çš„å­—å…¸ï¼Œå®¢æˆ·ç«¯å¯ä»¥æŒ‡å®šå°†æ•°æ®å­˜å‚¨åœ¨å“ªä¸ªå­—å…¸ä¸­ã€‚è¿™ä¸æˆ‘ä»¬ç†ŸçŸ¥çš„åœ¨ä¸€ä¸ªå…³ç³»æ•°æ®åº“å®ä¾‹ä¸­å¯ä»¥åˆ›å»ºå¤šä¸ªæ•°æ®åº“ç±»ä¼¼ï¼Œæ‰€ä»¥å¯ä»¥å°†å…¶ä¸­çš„æ¯ä¸ªå­—å…¸éƒ½ç†è§£æˆä¸€ä¸ªç‹¬ç«‹çš„æ•°æ®åº“ã€‚æ¯ä¸ªæ•°æ®åº“å¯¹å¤–éƒ½æ˜¯ä¸€ä¸ªä»0å¼€å§‹çš„é€’å¢æ•°å­—å‘½åï¼ŒRedisé»˜è®¤æ”¯æŒ16ä¸ªæ•°æ®åº“ï¼ˆå¯ä»¥é€šè¿‡é…ç½®æ–‡ä»¶æ”¯æŒæ›´å¤šï¼Œæ— ä¸Šé™ï¼‰ï¼Œå¯ä»¥é€šè¿‡é…ç½®databasesæ¥ä¿®æ”¹è¿™ä¸€æ•°å­—ã€‚å®¢æˆ·ç«¯ä¸Rediså»ºç«‹è¿æ¥åä¼šè‡ªåŠ¨é€‰æ‹©0å·æ•°æ®åº“ï¼Œä¸è¿‡å¯ä»¥éšæ—¶ä½¿ç”¨SELECTå‘½ä»¤æ›´æ¢æ•°æ®åº“ï¼Œå¦‚è¦é€‰æ‹©1å·æ•°æ®åº“ï¼šç¤ºä¾‹:127.0.0.1:6379&gt; select 1OK127.0.0.1:6379[1]&gt; get name(nil)127.0.0.1:6379[1]&gt; get myzset(nil)127.0.0.1:6379[1]&gt; select 0OK127.0.0.1:6379&gt; get name&quot;cyylog&quot;127.0.0.1:6379&gt; zrangebyscore myzset 0 21) &quot;BJ&quot;2) &quot;GZ&quot;3) &quot;ZZ&quot;ç„¶è€Œè¿™äº›ä»¥æ•°å­—å‘½åçš„æ•°æ®åº“åˆä¸æˆ‘ä»¬ç†è§£çš„æ•°æ®åº“æœ‰æ‰€åŒºåˆ«ã€‚é¦–å…ˆRedisä¸æ”¯æŒè‡ªå®šä¹‰æ•°æ®åº“çš„åå­—ï¼Œæ¯ä¸ªæ•°æ®åº“éƒ½ä»¥ç¼–å·å‘½åï¼Œå¼€å‘è€…å¿…é¡»è‡ªå·±è®°å½•å“ªäº›æ•°æ®åº“å­˜å‚¨äº†å“ªäº›æ•°æ®ã€‚å¦å¤–Redisä¹Ÿä¸æ”¯æŒä¸ºæ¯ä¸ªæ•°æ®åº“è®¾ç½®ä¸åŒçš„è®¿é—®å¯†ç ï¼Œæ‰€ä»¥ä¸€ä¸ªå®¢æˆ·ç«¯è¦ä¹ˆå¯ä»¥è®¿é—®å…¨éƒ¨æ•°æ®åº“ï¼Œè¦ä¹ˆè¿ä¸€ä¸ªæ•°æ®åº“ä¹Ÿæ²¡æœ‰æƒé™è®¿é—®ã€‚æœ€é‡è¦çš„ä¸€ç‚¹æ˜¯å¤šä¸ªæ•°æ®åº“ä¹‹é—´å¹¶ä¸æ˜¯å®Œå…¨éš”ç¦»çš„ï¼Œæ¯”å¦‚FLUSHALLå‘½ä»¤å¯ä»¥æ¸…ç©ºä¸€ä¸ªRediså®ä¾‹ä¸­æ‰€æœ‰æ•°æ®åº“ä¸­çš„æ•°æ®ã€‚ç»¼ä¸Šæ‰€è¿°ï¼Œè¿™äº›æ•°æ®åº“æ›´åƒæ˜¯ä¸€ç§å‘½åç©ºé—´ï¼Œè€Œä¸é€‚å®œå­˜å‚¨ä¸åŒåº”ç”¨ç¨‹åºçš„æ•°æ®ã€‚æ¯”å¦‚å¯ä»¥ä½¿ç”¨0å·æ•°æ®åº“å­˜å‚¨æŸä¸ªåº”ç”¨ç”Ÿäº§ç¯å¢ƒä¸­çš„æ•°æ®ï¼Œä½¿ç”¨1å·æ•°æ®åº“å­˜å‚¨æµ‹è¯•ç¯å¢ƒä¸­çš„æ•°æ®ï¼Œä½†ä¸é€‚å®œä½¿ç”¨0å·æ•°æ®åº“å­˜å‚¨Aåº”ç”¨çš„æ•°æ®è€Œä½¿ç”¨1å·æ•°æ®åº“Båº”ç”¨çš„æ•°æ®ï¼Œä¸åŒçš„åº”ç”¨åº”è¯¥ä½¿ç”¨ä¸åŒçš„Rediså®ä¾‹å­˜å‚¨æ•°æ®ã€‚ç”±äºRediséå¸¸è½»é‡çº§ï¼Œä¸€ä¸ªç©ºRediså®ä¾‹å ç”¨çš„å†…åœ¨åªæœ‰1Må·¦å³ï¼Œæ‰€ä»¥ä¸ç”¨æ‹…å¿ƒå¤šä¸ªRediså®ä¾‹ä¼šé¢å¤–å ç”¨å¾ˆå¤šå†…å­˜ã€‚</code></pre><h3 id="rediså‘½ä»¤"><a href="#rediså‘½ä»¤" class="headerlink" title="rediså‘½ä»¤"></a>rediså‘½ä»¤</h3><pre><code>Redis å‘½ä»¤ç”¨äºåœ¨ redis æœåŠ¡ä¸Šæ‰§è¡Œæ“ä½œã€‚è¦åœ¨ redis æœåŠ¡ä¸Šæ‰§è¡Œå‘½ä»¤éœ€è¦ä¸€ä¸ª redis å®¢æˆ·ç«¯ã€‚Redis å®¢æˆ·ç«¯åœ¨æˆ‘ä»¬ä¹‹å‰ä¸‹è½½çš„çš„ redis çš„å®‰è£…åŒ…ä¸­ã€‚è¯­æ³•Redis å®¢æˆ·ç«¯çš„åŸºæœ¬è¯­æ³•ä¸ºï¼š$ redis-cliåœ¨è¿œç¨‹æœåŠ¡ä¸Šæ‰§è¡Œå‘½ä»¤å¦‚æœéœ€è¦åœ¨è¿œç¨‹ redis æœåŠ¡ä¸Šæ‰§è¡Œå‘½ä»¤ï¼ŒåŒæ ·æˆ‘ä»¬ä½¿ç”¨çš„ä¹Ÿæ˜¯ redis-cli å‘½ä»¤ã€‚è¯­æ³•$ redis-cli -h host -p port -a password</code></pre><h3 id="redisæ•°æ®å¤‡ä»½å’Œæ¢å¤"><a href="#redisæ•°æ®å¤‡ä»½å’Œæ¢å¤" class="headerlink" title="redisæ•°æ®å¤‡ä»½å’Œæ¢å¤"></a>redisæ•°æ®å¤‡ä»½å’Œæ¢å¤</h3><pre><code>Redis SAVE å‘½ä»¤ç”¨äºåˆ›å»ºå½“å‰æ•°æ®åº“çš„å¤‡ä»½ã€‚è¯­æ³•redis Save å‘½ä»¤åŸºæœ¬è¯­æ³•å¦‚ä¸‹ï¼š127.0.0.1:6379&gt; saveOKè¯¥å‘½ä»¤ä¼šåœ¨rediså®‰è£…ç›®å½•ä¸‹åˆ›å»ºdump.rdbæ–‡ä»¶æ¢å¤æ•°æ®å¦‚æœéœ€è¦æ¢å¤æ•°æ®ï¼Œåªéœ€å°†å¤‡ä»½æ–‡ä»¶ (dump.rdb) ç§»åŠ¨åˆ° redis å®‰è£…ç›®å½•å¹¶å¯åŠ¨æœåŠ¡å³å¯ã€‚è·å– redis ç›®å½•å¯ä»¥ä½¿ç”¨ CONFIG å‘½ä»¤ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š127.0.0.1:6379&gt; config get dir1) &quot;dir&quot;2) &quot;/usr/local/redis/src&quot;ä»¥ä¸Šå‘½ä»¤ CONFIG GET dir è¾“å‡ºçš„ redis å®‰è£…ç›®å½•ä¸º/usr/local/redis/srcBgsaveåˆ›å»º redis å¤‡ä»½æ–‡ä»¶ä¹Ÿå¯ä»¥ä½¿ç”¨å‘½ä»¤ BGSAVEï¼Œè¯¥å‘½ä»¤åœ¨åå°æ‰§è¡Œã€‚127.0.0.1:6379&gt; BGSAVEBackground saving started</code></pre><h3 id="rediså®‰å…¨"><a href="#rediså®‰å…¨" class="headerlink" title="rediså®‰å…¨"></a>rediså®‰å…¨</h3><pre><code>æˆ‘ä»¬å¯ä»¥é€šè¿‡ redis çš„é…ç½®æ–‡ä»¶è®¾ç½®å¯†ç å‚æ•°ï¼Œè¿™æ ·å®¢æˆ·ç«¯è¿æ¥åˆ° redis æœåŠ¡å°±éœ€è¦å¯†ç éªŒè¯ï¼Œè¿™æ ·å¯ä»¥è®©ä½ çš„ redis æœåŠ¡æ›´å®‰å…¨ã€‚127.0.0.1:6379&gt; CONFIG get requirepass1) &quot;requirepass&quot;2) &quot;&quot;é»˜è®¤æƒ…å†µä¸‹ requirepass å‚æ•°æ˜¯ç©ºçš„ï¼Œè¿™å°±æ„å‘³ç€ä½ æ— éœ€é€šè¿‡å¯†ç éªŒè¯å°±å¯ä»¥è¿æ¥åˆ° redis æœåŠ¡ã€‚ä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤æ¥ä¿®æ”¹è¯¥å‚æ•°ï¼š127.0.0.1:6379&gt; CONFIG set requirepass &quot;tiger&quot;OK127.0.0.1:6379&gt; CONFIG get requirepass1) &quot;requirepass&quot;2) &quot;tiger&quot;ç™»å½•redis-cli -h 127.0.0.1 -p 6379 -a tigeræˆ–è€…ç™»é™†åè®¤è¯127.0.0.1:6379&gt; AUTH &quot;tiger&quot;OK127.0.0.1:6379&gt; SET name &quot;Test value&quot;OK127.0.0.1:6379&gt; GET name&quot;Test value&quot;</code></pre><h3 id="redisæŒä¹…åŒ–"><a href="#redisæŒä¹…åŒ–" class="headerlink" title="redisæŒä¹…åŒ–"></a>redisæŒä¹…åŒ–</h3><pre><code>redisæŒä¹…åŒ– â€“ ä¸¤ç§æ–¹å¼å¼€å¯æŒä¹…åŒ–åŠŸèƒ½åï¼Œé‡å¯redisåï¼Œæ•°æ®ä¼šè‡ªåŠ¨é€šè¿‡æŒä¹…åŒ–æ–‡ä»¶æ¢å¤ï¼ï¼redisæä¾›äº†ä¸¤ç§æŒä¹…åŒ–çš„æ–¹å¼ï¼Œåˆ†åˆ«æ˜¯RDBï¼ˆRedis DataBaseï¼‰å’ŒAOFï¼ˆAppend Only Fileï¼‰ã€‚RDBï¼Œæ˜¯åœ¨ä¸åŒçš„æ—¶é—´ç‚¹ï¼Œå°†rediså­˜å‚¨çš„æ•°æ®ç”Ÿæˆå¿«ç…§å¹¶å­˜å‚¨åˆ°ç£ç›˜ç­‰ä»‹è´¨ä¸Šï¼›AOFï¼Œåˆ™æ˜¯æ¢äº†ä¸€ä¸ªè§’åº¦æ¥å®ç°æŒä¹…åŒ–ï¼Œé‚£å°±æ˜¯å°†redisæ‰§è¡Œè¿‡çš„æ‰€æœ‰å†™æŒ‡ä»¤è®°å½•ä¸‹æ¥ï¼Œåœ¨ä¸‹æ¬¡redisé‡æ–°å¯åŠ¨æ—¶ï¼Œåªè¦æŠŠè¿™äº›å†™æŒ‡ä»¤ä»å‰åˆ°åå†é‡å¤æ‰§è¡Œä¸€éï¼Œå°±å¯ä»¥å®ç°æ•°æ®æ¢å¤äº†ã€‚RDBå’ŒAOFä¸¤ç§æ–¹å¼ä¹Ÿå¯ä»¥åŒæ—¶ä½¿ç”¨ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœredisé‡å¯çš„è¯ï¼Œåˆ™ä¼šä¼˜å…ˆé‡‡ç”¨AOFæ–¹å¼æ¥è¿›è¡Œæ•°æ®æ¢å¤ï¼Œè¿™æ˜¯å› ä¸ºAOFæ–¹å¼çš„æ•°æ®æ¢å¤å®Œæ•´åº¦æ›´é«˜ã€‚å¦‚æœä½ æ²¡æœ‰æ•°æ®æŒä¹…åŒ–çš„éœ€æ±‚ï¼Œä¹Ÿå®Œå…¨å¯ä»¥å…³é—­RDBå’ŒAOFæ–¹å¼ï¼Œè¿™æ ·çš„è¯ï¼Œrediså°†å˜æˆä¸€ä¸ªçº¯å†…å­˜æ•°æ®åº“ï¼Œå°±åƒmemcacheä¸€æ ·ã€‚redisæŒä¹…åŒ– â€“ RDBRDBæ–¹å¼ï¼Œæ˜¯å°†redisæŸä¸€æ—¶åˆ»çš„æ•°æ®æŒä¹…åŒ–åˆ°ç£ç›˜ä¸­ï¼Œæ˜¯ä¸€ç§å¿«ç…§å¼çš„æŒä¹…åŒ–æ–¹æ³•ã€‚redisåœ¨è¿›è¡Œæ•°æ®æŒä¹…åŒ–çš„è¿‡ç¨‹ä¸­ï¼Œä¼šå…ˆå°†æ•°æ®å†™å…¥åˆ°ä¸€ä¸ªä¸´æ—¶æ–‡ä»¶ä¸­ï¼Œå¾…æŒä¹…åŒ–è¿‡ç¨‹éƒ½ç»“æŸäº†ï¼Œæ‰ä¼šç”¨è¿™ä¸ªä¸´æ—¶æ–‡ä»¶æ›¿æ¢ä¸Šæ¬¡æŒä¹…åŒ–å¥½çš„æ–‡ä»¶ã€‚æ­£æ˜¯è¿™ç§ç‰¹æ€§ï¼Œè®©æˆ‘ä»¬å¯ä»¥éšæ—¶æ¥è¿›è¡Œå¤‡ä»½ï¼Œå› ä¸ºå¿«ç…§æ–‡ä»¶æ€»æ˜¯å®Œæ•´å¯ç”¨çš„ã€‚                -------------&gt;----------&gt;------------------&gt;                1 2 3 4 5  6 7 8 9  10 11 12 13  14 15 16                              -----------&gt;                   --------&gt;                              1 2 3 4 5                  1 2 3 4 5  6 7 8 9  10 11 12 13å¯¹äºRDBæ–¹å¼ï¼Œredisä¼šå•ç‹¬åˆ›å»ºï¼ˆforkï¼‰ä¸€ä¸ªå­è¿›ç¨‹æ¥è¿›è¡ŒæŒä¹…åŒ–ï¼Œè€Œä¸»è¿›ç¨‹æ˜¯ä¸ä¼šè¿›è¡Œä»»ä½•IOæ“ä½œçš„ï¼Œè¿™æ ·å°±ç¡®ä¿äº†redisæé«˜çš„æ€§èƒ½ã€‚å¦‚æœéœ€è¦è¿›è¡Œå¤§è§„æ¨¡æ•°æ®çš„æ¢å¤ï¼Œä¸”å¯¹äºæ•°æ®æ¢å¤çš„å®Œæ•´æ€§ä¸æ˜¯éå¸¸æ•æ„Ÿï¼Œé‚£RDBæ–¹å¼è¦æ¯”AOFæ–¹å¼æ›´åŠ çš„é«˜æ•ˆã€‚è™½ç„¶RDBæœ‰ä¸å°‘ä¼˜ç‚¹ï¼Œä½†å®ƒçš„ç¼ºç‚¹ä¹Ÿæ˜¯ä¸å®¹å¿½è§†çš„ã€‚å¦‚æœä½ å¯¹æ•°æ®çš„å®Œæ•´æ€§éå¸¸æ•æ„Ÿï¼Œé‚£ä¹ˆRDBæ–¹å¼å°±ä¸å¤ªé€‚åˆä½ ï¼Œå› ä¸ºå³ä½¿ä½ æ¯5åˆ†é’Ÿéƒ½æŒä¹…åŒ–ä¸€æ¬¡ï¼Œå½“redisæ•…éšœæ—¶ï¼Œä»ç„¶ä¼šæœ‰è¿‘5åˆ†é’Ÿçš„æ•°æ®ä¸¢å¤±ã€‚æ‰€ä»¥ï¼Œredisè¿˜æä¾›äº†å¦ä¸€ç§æŒä¹…åŒ–æ–¹å¼ï¼Œé‚£å°±æ˜¯AOFã€‚redisæŒä¹…åŒ– â€“ AOFAOFï¼Œè‹±æ–‡æ˜¯Append Only Fileï¼Œå³åªå…è®¸è¿½åŠ ä¸å…è®¸æ”¹å†™çš„æ–‡ä»¶ã€‚AOFæ–¹å¼æ˜¯å°†æ‰§è¡Œè¿‡çš„å†™æŒ‡ä»¤è®°å½•ä¸‹æ¥ï¼Œåœ¨æ•°æ®æ¢å¤æ—¶æŒ‰ç…§ä»å‰åˆ°åçš„é¡ºåºå†å°†æŒ‡ä»¤éƒ½æ‰§è¡Œä¸€éï¼Œå°±è¿™ä¹ˆç®€å•ã€‚é€šè¿‡é…ç½®redis.confä¸­çš„appendonly yeså°±å¯ä»¥æ‰“å¼€AOFåŠŸèƒ½ã€‚å¦‚æœæœ‰å†™æ“ä½œï¼ˆå¦‚SETç­‰ï¼‰ï¼Œrediså°±ä¼šè¢«è¿½åŠ åˆ°AOFæ–‡ä»¶çš„æœ«å°¾ã€‚é»˜è®¤çš„AOFæŒä¹…åŒ–ç­–ç•¥æ˜¯æ¯ç§’é’Ÿfsyncä¸€æ¬¡ï¼ˆfsyncæ˜¯æŒ‡æŠŠç¼“å­˜ä¸­çš„å†™æŒ‡ä»¤è®°å½•åˆ°ç£ç›˜ä¸­ï¼‰ï¼Œå› ä¸ºåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œredisä»ç„¶å¯ä»¥ä¿æŒå¾ˆå¥½çš„å¤„ç†æ€§èƒ½ï¼Œå³ä½¿redisæ•…éšœï¼Œä¹Ÿåªä¼šä¸¢å¤±æœ€è¿‘1ç§’é’Ÿçš„æ•°æ®ã€‚å¦‚æœåœ¨è¿½åŠ æ—¥å¿—æ—¶ï¼Œæ°å¥½é‡åˆ°ç£ç›˜ç©ºé—´æ»¡ã€inodeæ»¡æˆ–æ–­ç”µç­‰æƒ…å†µå¯¼è‡´æ—¥å¿—å†™å…¥ä¸å®Œæ•´ï¼Œä¹Ÿæ²¡æœ‰å…³ç³»ï¼Œredisæä¾›äº†redis-check-aofå·¥å…·ï¼Œå¯ä»¥ç”¨æ¥è¿›è¡Œæ—¥å¿—ä¿®å¤ã€‚å› ä¸ºé‡‡ç”¨äº†è¿½åŠ æ–¹å¼ï¼Œå¦‚æœä¸åšä»»ä½•å¤„ç†çš„è¯ï¼ŒAOFæ–‡ä»¶ä¼šå˜å¾—è¶Šæ¥è¶Šå¤§ï¼Œä¸ºæ­¤ï¼Œredisæä¾›äº†AOFæ–‡ä»¶é‡å†™ï¼ˆrewriteï¼‰æœºåˆ¶ï¼Œå³å½“AOFæ–‡ä»¶çš„å¤§å°è¶…è¿‡æ‰€è®¾å®šçš„é˜ˆå€¼æ—¶ï¼Œrediså°±ä¼šå¯åŠ¨AOFæ–‡ä»¶çš„å†…å®¹å‹ç¼©ï¼Œåªä¿ç•™å¯ä»¥æ¢å¤æ•°æ®çš„æœ€å°æŒ‡ä»¤é›†ã€‚ä¸¾ä¸ªä¾‹å­æˆ–è®¸æ›´å½¢è±¡ï¼Œå‡å¦‚æˆ‘ä»¬è°ƒç”¨äº†100æ¬¡INCRæŒ‡ä»¤ï¼Œåœ¨AOFæ–‡ä»¶ä¸­å°±è¦å­˜å‚¨100æ¡æŒ‡ä»¤ï¼Œä½†è¿™æ˜æ˜¾æ˜¯å¾ˆä½æ•ˆçš„ï¼Œå®Œå…¨å¯ä»¥æŠŠè¿™100æ¡æŒ‡ä»¤åˆå¹¶æˆä¸€æ¡SETæŒ‡ä»¤ï¼Œè¿™å°±æ˜¯é‡å†™æœºåˆ¶çš„åŸç†ã€‚åœ¨è¿›è¡ŒAOFé‡å†™æ—¶ï¼Œä»ç„¶æ˜¯é‡‡ç”¨å…ˆå†™ä¸´æ—¶æ–‡ä»¶ï¼Œå…¨éƒ¨å®Œæˆåå†æ›¿æ¢çš„æµç¨‹ï¼Œæ‰€ä»¥æ–­ç”µã€ç£ç›˜æ»¡ç­‰é—®é¢˜éƒ½ä¸ä¼šå½±å“AOFæ–‡ä»¶çš„å¯ç”¨æ€§ï¼Œè¿™ç‚¹å¯ä»¥æ”¾å¿ƒã€‚AOFæ–¹å¼çš„å¦ä¸€ä¸ªå¥½å¤„ï¼Œæˆ‘ä»¬é€šè¿‡ä¸€ä¸ªâ€œåœºæ™¯å†ç°â€æ¥è¯´æ˜ã€‚æŸåŒå­¦åœ¨æ“ä½œredisæ—¶ï¼Œä¸å°å¿ƒæ‰§è¡Œäº†FLUSHALLï¼Œå¯¼è‡´rediså†…å­˜ä¸­çš„æ•°æ®å…¨éƒ¨è¢«æ¸…ç©ºäº†ï¼Œè¿™æ˜¯å¾ˆæ‚²å‰§çš„äº‹æƒ…ã€‚ä¸è¿‡è¿™ä¹Ÿä¸æ˜¯ä¸–ç•Œæœ«æ—¥ï¼Œåªè¦redisé…ç½®äº†AOFæŒä¹…åŒ–æ–¹å¼ï¼Œä¸”AOFæ–‡ä»¶è¿˜æ²¡æœ‰è¢«é‡å†™ï¼ˆrewriteï¼‰ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç”¨æœ€å¿«çš„é€Ÿåº¦æš‚åœrediså¹¶ç¼–è¾‘AOFæ–‡ä»¶ï¼Œå°†æœ€åä¸€è¡Œçš„FLUSHALLå‘½ä»¤åˆ é™¤ï¼Œç„¶åé‡å¯redisï¼Œå°±å¯ä»¥æ¢å¤redisçš„æ‰€æœ‰æ•°æ®åˆ°FLUSHALLä¹‹å‰çš„çŠ¶æ€äº†ã€‚æ˜¯ä¸æ˜¯å¾ˆç¥å¥‡ï¼Œè¿™å°±æ˜¯AOFæŒä¹…åŒ–æ–¹å¼çš„å¥½å¤„ä¹‹ä¸€ã€‚ä½†æ˜¯å¦‚æœAOFæ–‡ä»¶å·²ç»è¢«é‡å†™äº†ï¼Œé‚£å°±æ— æ³•é€šè¿‡è¿™ç§æ–¹æ³•æ¥æ¢å¤æ•°æ®äº†ã€‚è™½ç„¶ä¼˜ç‚¹å¤šå¤šï¼Œä½†AOFæ–¹å¼ä¹ŸåŒæ ·å­˜åœ¨ç¼ºé™·ï¼Œæ¯”å¦‚åœ¨åŒæ ·æ•°æ®è§„æ¨¡çš„æƒ…å†µä¸‹ï¼ŒAOFæ–‡ä»¶è¦æ¯”RDBæ–‡ä»¶çš„ä½“ç§¯å¤§ã€‚è€Œä¸”ï¼ŒAOFæ–¹å¼çš„æ¢å¤é€Ÿåº¦ä¹Ÿè¦æ…¢äºRDBæ–¹å¼ã€‚1 2 3 4 5 6     6zi0å¦‚æœä½ ç›´æ¥æ‰§è¡ŒBGREWRITEAOFå‘½ä»¤ï¼Œé‚£ä¹ˆredisä¼šç”Ÿæˆä¸€ä¸ªå…¨æ–°çš„AOFæ–‡ä»¶ï¼Œå…¶ä¸­ä¾¿åŒ…æ‹¬äº†å¯ä»¥æ¢å¤ç°æœ‰æ•°æ®çš„æœ€å°‘çš„å‘½ä»¤é›†ã€‚å¦‚æœè¿æ°”æ¯”è¾ƒå·®ï¼ŒAOFæ–‡ä»¶å‡ºç°äº†è¢«å†™åçš„æƒ…å†µï¼Œä¹Ÿä¸å¿…è¿‡åˆ†æ‹…å¿§ï¼Œrediså¹¶ä¸ä¼šè´¸ç„¶åŠ è½½è¿™ä¸ªæœ‰é—®é¢˜çš„AOFæ–‡ä»¶ï¼Œè€Œæ˜¯æŠ¥é”™é€€å‡ºã€‚è¿™æ—¶å¯ä»¥é€šè¿‡ä»¥ä¸‹æ­¥éª¤æ¥ä¿®å¤å‡ºé”™çš„æ–‡ä»¶ï¼š1.å¤‡ä»½è¢«å†™åçš„AOFæ–‡ä»¶2.è¿è¡Œredis-check-aof â€“fixè¿›è¡Œä¿®å¤3.ç”¨diff -uæ¥çœ‹ä¸‹ä¸¤ä¸ªæ–‡ä»¶çš„å·®å¼‚ï¼Œç¡®è®¤é—®é¢˜ç‚¹4.é‡å¯redisï¼ŒåŠ è½½ä¿®å¤åçš„AOFæ–‡ä»¶redisæŒä¹…åŒ– â€“ AOFé‡å†™AOFé‡å†™çš„å†…éƒ¨è¿è¡ŒåŸç†ï¼Œæœ‰å¿…è¦äº†è§£ä¸€ä¸‹ã€‚åœ¨é‡å†™å³å°†å¼€å§‹ä¹‹é™…ï¼Œredisä¼šåˆ›å»ºï¼ˆforkï¼‰ä¸€ä¸ªâ€œé‡å†™å­è¿›ç¨‹â€ï¼Œè¿™ä¸ªå­è¿›ç¨‹ä¼šé¦–å…ˆè¯»å–ç°æœ‰çš„AOFæ–‡ä»¶ï¼Œå¹¶å°†å…¶åŒ…å«çš„æŒ‡ä»¤è¿›è¡Œåˆ†æå‹ç¼©å¹¶å†™å…¥åˆ°ä¸€ä¸ªä¸´æ—¶æ–‡ä»¶ä¸­ã€‚ä¸æ­¤åŒæ—¶ï¼Œä¸»å·¥ä½œè¿›ç¨‹ä¼šå°†æ–°æ¥æ”¶åˆ°çš„å†™æŒ‡ä»¤ä¸€è¾¹ç´¯ç§¯åˆ°å†…å­˜ç¼“å†²åŒºä¸­ï¼Œä¸€è¾¹ç»§ç»­å†™å…¥åˆ°åŸæœ‰çš„AOFæ–‡ä»¶ä¸­ï¼Œè¿™æ ·åšæ˜¯ä¿è¯åŸæœ‰çš„AOFæ–‡ä»¶çš„å¯ç”¨æ€§ï¼Œé¿å…åœ¨é‡å†™è¿‡ç¨‹ä¸­å‡ºç°æ„å¤–ã€‚å½“â€œé‡å†™å­è¿›ç¨‹â€å®Œæˆé‡å†™å·¥ä½œåï¼Œå®ƒä¼šç»™çˆ¶è¿›ç¨‹å‘ä¸€ä¸ªä¿¡å·ï¼Œçˆ¶è¿›ç¨‹æ”¶åˆ°ä¿¡å·åå°±ä¼šå°†å†…å­˜ä¸­ç¼“å­˜çš„å†™æŒ‡ä»¤è¿½åŠ åˆ°æ–°AOFæ–‡ä»¶ä¸­ã€‚å½“è¿½åŠ ç»“æŸåï¼Œrediså°±ä¼šç”¨æ–°AOFæ–‡ä»¶æ¥ä»£æ›¿æ—§AOFæ–‡ä»¶ï¼Œä¹‹åå†æœ‰æ–°çš„å†™æŒ‡ä»¤ï¼Œå°±éƒ½ä¼šè¿½åŠ åˆ°æ–°çš„AOFæ–‡ä»¶ä¸­äº†ã€‚redisæŒä¹…åŒ– â€“ å¦‚ä½•é€‰æ‹©RDBå’ŒAOFå¯¹äºæˆ‘ä»¬åº”è¯¥é€‰æ‹©RDBè¿˜æ˜¯AOFï¼Œå®˜æ–¹çš„å»ºè®®æ˜¯ä¸¤ä¸ªåŒæ—¶ä½¿ç”¨ã€‚è¿™æ ·å¯ä»¥æä¾›æ›´å¯é çš„æŒä¹…åŒ–æ–¹æ¡ˆã€‚å†™å…¥é€Ÿåº¦å¿« AOFå†™å…¥é€Ÿåº¦æ…¢ RDBredisçš„äº‹åŠ¡å¤„ç†ä¼—æ‰€å‘¨çŸ¥ï¼Œäº‹åŠ¡æ˜¯æŒ‡â€œä¸€ä¸ªå®Œæ•´çš„åŠ¨ä½œï¼Œè¦ä¹ˆå…¨éƒ¨æ‰§è¡Œï¼Œè¦ä¹ˆä»€ä¹ˆä¹Ÿæ²¡æœ‰åšâ€ã€‚åœ¨èŠredisäº‹åŠ¡å¤„ç†ä¹‹å‰ï¼Œè¦å…ˆå’Œå¤§å®¶ä»‹ç»å››ä¸ªredisæŒ‡ä»¤ï¼Œå³MULTIã€EXECã€DISCARDã€WATCHã€‚è¿™å››ä¸ªæŒ‡ä»¤æ„æˆäº†redisäº‹åŠ¡å¤„ç†çš„åŸºç¡€ã€‚1.MULTIç”¨æ¥ç»„è£…ä¸€ä¸ªäº‹åŠ¡ï¼›2.EXECç”¨æ¥æ‰§è¡Œä¸€ä¸ªäº‹åŠ¡ï¼›3.DISCARDç”¨æ¥å–æ¶ˆä¸€ä¸ªäº‹åŠ¡ï¼›4.WATCHç”¨æ¥ç›‘è§†ä¸€äº›keyï¼Œä¸€æ—¦è¿™äº›keyåœ¨äº‹åŠ¡æ‰§è¡Œä¹‹å‰è¢«æ”¹å˜ï¼Œåˆ™å–æ¶ˆäº‹åŠ¡çš„æ‰§è¡Œã€‚ä¸€ä¸ªMULTIå’ŒEXECçš„ä¾‹å­ï¼šredis&gt; MULTI //æ ‡è®°äº‹åŠ¡å¼€å§‹OKredis&gt; INCR user_id //å¤šæ¡å‘½ä»¤æŒ‰é¡ºåºå…¥é˜ŸQUEUEDredis&gt; INCR user_idQUEUEDredis&gt; INCR user_idQUEUEDredis&gt; PINGQUEUEDredis&gt; EXEC //æ‰§è¡Œ1) (integer) 12) (integer) 23) (integer) 34) PONGåœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œçœ‹åˆ°äº†QUEUEDçš„å­—æ ·ï¼Œè¿™è¡¨ç¤ºæˆ‘ä»¬åœ¨ç”¨MULTIç»„è£…äº‹åŠ¡æ—¶ï¼Œæ¯ä¸€ä¸ªå‘½ä»¤éƒ½ä¼šè¿›å…¥åˆ°å†…å­˜é˜Ÿåˆ—ä¸­ç¼“å­˜èµ·æ¥ï¼Œå¦‚æœå‡ºç°QUEUEDåˆ™è¡¨ç¤ºæˆ‘ä»¬è¿™ä¸ªå‘½ä»¤æˆåŠŸæ’å…¥äº†ç¼“å­˜é˜Ÿåˆ—ï¼Œåœ¨å°†æ¥æ‰§è¡ŒEXECæ—¶ï¼Œè¿™äº›è¢«QUEUEDçš„å‘½ä»¤éƒ½ä¼šè¢«ç»„è£…æˆä¸€ä¸ªäº‹åŠ¡æ¥æ‰§è¡Œã€‚å¯¹äºäº‹åŠ¡çš„æ‰§è¡Œæ¥è¯´ï¼Œå¦‚æœrediså¼€å¯äº†AOFæŒä¹…åŒ–çš„è¯ï¼Œé‚£ä¹ˆä¸€æ—¦äº‹åŠ¡è¢«æˆåŠŸæ‰§è¡Œï¼Œäº‹åŠ¡ä¸­çš„å‘½ä»¤å°±ä¼šé€šè¿‡writeå‘½ä»¤ä¸€æ¬¡æ€§å†™åˆ°ç£ç›˜ä¸­å»ï¼Œå¦‚æœåœ¨å‘ç£ç›˜ä¸­å†™çš„è¿‡ç¨‹ä¸­æ°å¥½å‡ºç°æ–­ç”µã€ç¡¬ä»¶æ•…éšœç­‰é—®é¢˜ï¼Œé‚£ä¹ˆå°±å¯èƒ½å‡ºç°åªæœ‰éƒ¨åˆ†å‘½ä»¤è¿›è¡Œäº†AOFæŒä¹…åŒ–ï¼Œè¿™æ—¶AOFæ–‡ä»¶å°±ä¼šå‡ºç°ä¸å®Œæ•´çš„æƒ…å†µï¼Œè¿™æ—¶ï¼Œå¯ä»¥ä½¿ç”¨redis-check-aofå·¥å…·æ¥ä¿®å¤è¿™ä¸€é—®é¢˜ï¼Œè¿™ä¸ªå·¥å…·ä¼šå°†AOFæ–‡ä»¶ä¸­ä¸å®Œæ•´çš„ä¿¡æ¯ç§»é™¤ï¼Œç¡®ä¿AOFæ–‡ä»¶å®Œæ•´å¯ç”¨ã€‚æœ‰å…³äº‹åŠ¡ï¼Œç»å¸¸ä¼šé‡åˆ°çš„æ˜¯ä¸¤ç±»é”™è¯¯ï¼š1.è°ƒç”¨EXECä¹‹å‰çš„é”™è¯¯2.è°ƒç”¨EXECä¹‹åçš„é”™è¯¯â€œè°ƒç”¨EXECä¹‹å‰çš„é”™è¯¯â€ï¼Œæœ‰å¯èƒ½æ˜¯ç”±äºè¯­æ³•æœ‰è¯¯å¯¼è‡´çš„ï¼Œä¹Ÿå¯èƒ½æ—¶ç”±äºå†…å­˜ä¸è¶³å¯¼è‡´çš„ã€‚åªè¦å‡ºç°æŸä¸ªå‘½ä»¤æ— æ³•æˆåŠŸå†™å…¥ç¼“å†²é˜Ÿåˆ—çš„æƒ…å†µï¼Œrediséƒ½ä¼šè¿›è¡Œè®°å½•ï¼Œåœ¨å®¢æˆ·ç«¯è°ƒç”¨EXECæ—¶ï¼Œredisä¼šæ‹’ç»æ‰§è¡Œè¿™ä¸€äº‹åŠ¡ã€‚ï¼ˆè¿™æ—¶2.6.5ç‰ˆæœ¬ä¹‹åçš„ç­–ç•¥ã€‚åœ¨2.6.5ä¹‹å‰çš„ç‰ˆæœ¬ä¸­ï¼Œredisä¼šå¿½ç•¥é‚£äº›å…¥é˜Ÿå¤±è´¥çš„å‘½ä»¤ï¼Œåªæ‰§è¡Œé‚£äº›å…¥é˜ŸæˆåŠŸçš„å‘½ä»¤ï¼‰ã€‚æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªè¿™æ ·çš„ä¾‹å­ï¼š127.0.0.1:6379&gt; multiOK127.0.0.1:6379&gt; haha //ä¸€ä¸ªæ˜æ˜¾é”™è¯¯çš„æŒ‡ä»¤(error) ERR unknown command &#39;haha&#39;127.0.0.1:6379&gt; pingQUEUED127.0.0.1:6379&gt; exec//redisæ— æƒ…çš„æ‹’ç»äº†äº‹åŠ¡çš„æ‰§è¡Œï¼ŒåŸå› æ˜¯â€œä¹‹å‰å‡ºç°äº†é”™è¯¯â€(error) EXECABORT Transaction discarded because of previous errors.è€Œå¯¹äºâ€œè°ƒç”¨EXECä¹‹åçš„é”™è¯¯â€ï¼Œredisåˆ™é‡‡å–äº†å®Œå…¨ä¸åŒçš„ç­–ç•¥ï¼Œå³redisä¸ä¼šç†ç¬è¿™äº›é”™è¯¯ï¼Œè€Œæ˜¯ç»§ç»­å‘ä¸‹æ‰§è¡Œäº‹åŠ¡ä¸­çš„å…¶ä»–å‘½ä»¤ã€‚è¿™æ˜¯å› ä¸ºï¼Œå¯¹äºåº”ç”¨å±‚é¢çš„é”™è¯¯ï¼Œå¹¶ä¸æ˜¯redisè‡ªèº«éœ€è¦è€ƒè™‘å’Œå¤„ç†çš„é—®é¢˜ï¼Œæ‰€ä»¥ä¸€ä¸ªäº‹åŠ¡ä¸­å¦‚æœæŸä¸€æ¡å‘½ä»¤æ‰§è¡Œå¤±è´¥ï¼Œå¹¶ä¸ä¼šå½±å“æ¥ä¸‹æ¥çš„å…¶ä»–å‘½ä»¤çš„æ‰§è¡Œã€‚æˆ‘ä»¬ä¹Ÿæ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼š127.0.0.1:6379&gt; multiOK127.0.0.1:6379&gt; set age 23QUEUED//ageä¸æ˜¯é›†åˆï¼Œæ‰€ä»¥å¦‚ä¸‹æ˜¯ä¸€æ¡æ˜æ˜¾é”™è¯¯çš„æŒ‡ä»¤127.0.0.1:6379&gt; sadd age 15 QUEUED127.0.0.1:6379&gt; set age 29QUEUED127.0.0.1:6379&gt; exec //æ‰§è¡Œäº‹åŠ¡æ—¶ï¼Œredisä¸ä¼šç†ç¬ç¬¬2æ¡æŒ‡ä»¤æ‰§è¡Œé”™è¯¯1) OK2) (error) WRONGTYPE Operation against a key holding the wrong kind of value3) OK127.0.0.1:6379&gt; get age&quot;29&quot; //å¯ä»¥çœ‹å‡ºç¬¬3æ¡æŒ‡ä»¤è¢«æˆåŠŸæ‰§è¡Œäº†æœ€åä¸€ä¸ªæŒ‡ä»¤â€œWATCHâ€ï¼Œè¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½ç”¨çš„æŒ‡ä»¤ï¼Œå®ƒå¯ä»¥å¸®æˆ‘ä»¬å®ç°ç±»ä¼¼äºâ€œä¹è§‚é”â€çš„æ•ˆæœï¼Œå³CASï¼ˆcheck and setï¼‰ã€‚WATCHæœ¬èº«çš„ä½œç”¨æ˜¯â€œç›‘è§†keyæ˜¯å¦è¢«æ”¹åŠ¨è¿‡â€ï¼Œè€Œä¸”æ”¯æŒåŒæ—¶ç›‘è§†å¤šä¸ªkeyï¼Œåªè¦è¿˜æ²¡çœŸæ­£è§¦å‘äº‹åŠ¡ï¼ŒWATCHéƒ½ä¼šå°½èŒå°½è´£çš„ç›‘è§†ï¼Œä¸€æ—¦å‘ç°æŸä¸ªkeyè¢«ä¿®æ”¹äº†ï¼Œåœ¨æ‰§è¡ŒEXECæ—¶å°±ä¼šè¿”å›nilï¼Œè¡¨ç¤ºäº‹åŠ¡æ— æ³•è§¦å‘ã€‚127.0.0.1:6379&gt; set age 23OK127.0.0.1:6379&gt; watch age //å¼€å§‹ç›‘è§†ageOK127.0.0.1:6379&gt; set age 24 //åœ¨EXECä¹‹å‰ï¼Œageçš„å€¼è¢«ä¿®æ”¹äº†OK127.0.0.1:6379&gt; multiOK127.0.0.1:6379&gt; set age 25QUEUED127.0.0.1:6379&gt; get ageQUEUED127.0.0.1:6379&gt; exec //è§¦å‘EXEC(nil) //äº‹åŠ¡æ— æ³•è¢«æ‰§è¡Œ</code></pre><h2 id="redisä¸»ä»-å“¨å…µ"><a href="#redisä¸»ä»-å“¨å…µ" class="headerlink" title="redisä¸»ä»  + å“¨å…µ"></a>redisä¸»ä»  + å“¨å…µ</h2><h3 id="ä¸»ä»-ç”¨æ³•"><a href="#ä¸»ä»-ç”¨æ³•" class="headerlink" title="ä¸»ä» - ç”¨æ³•"></a>ä¸»ä» - ç”¨æ³•</h3><pre><code>åƒMySQLä¸€æ ·ï¼Œredisæ˜¯æ”¯æŒä¸»ä»åŒæ­¥çš„ï¼Œè€Œä¸”ä¹Ÿæ”¯æŒä¸€ä¸»å¤šä»ä»¥åŠå¤šçº§ä»ç»“æ„ã€‚ä¸»ä»ç»“æ„ï¼Œä¸€æ˜¯ä¸ºäº†çº¯ç²¹çš„å†—ä½™å¤‡ä»½ï¼ŒäºŒæ˜¯ä¸ºäº†æå‡è¯»æ€§èƒ½ï¼Œæ¯”å¦‚å¾ˆæ¶ˆè€—æ€§èƒ½çš„SORTå°±å¯ä»¥ç”±ä»æœåŠ¡å™¨æ¥æ‰¿æ‹…ã€‚redisçš„ä¸»ä»åŒæ­¥æ˜¯å¼‚æ­¥è¿›è¡Œçš„ï¼Œè¿™æ„å‘³ç€ä¸»ä»åŒæ­¥ä¸ä¼šå½±å“ä¸»é€»è¾‘ï¼Œä¹Ÿä¸ä¼šé™ä½redisçš„å¤„ç†æ€§èƒ½ã€‚ä¸»ä»æ¶æ„ä¸­ï¼Œå¯ä»¥è€ƒè™‘å…³é—­ä¸»æœåŠ¡å™¨çš„æ•°æ®æŒä¹…åŒ–åŠŸèƒ½ï¼Œåªè®©ä»æœåŠ¡å™¨è¿›è¡ŒæŒä¹…åŒ–ï¼Œè¿™æ ·å¯ä»¥æé«˜ä¸»æœåŠ¡å™¨çš„å¤„ç†æ€§èƒ½ã€‚åœ¨ä¸»ä»æ¶æ„ä¸­ï¼Œä»æœåŠ¡å™¨é€šå¸¸è¢«è®¾ç½®ä¸ºåªè¯»æ¨¡å¼ï¼Œè¿™æ ·å¯ä»¥é¿å…ä»æœåŠ¡å™¨çš„æ•°æ®è¢«è¯¯ä¿®æ”¹ã€‚ä½†æ˜¯ä»æœåŠ¡å™¨ä»ç„¶å¯ä»¥æ¥å—CONFIGç­‰æŒ‡ä»¤ï¼Œæ‰€ä»¥è¿˜æ˜¯ä¸åº”è¯¥å°†ä»æœåŠ¡å™¨ç›´æ¥æš´éœ²åˆ°ä¸å®‰å…¨çš„ç½‘ç»œç¯å¢ƒä¸­ã€‚å¦‚æœå¿…é¡»å¦‚æ­¤ï¼Œé‚£å¯ä»¥è€ƒè™‘ç»™é‡è¦æŒ‡ä»¤è¿›è¡Œé‡å‘½åï¼Œæ¥é¿å…å‘½ä»¤è¢«å¤–äººè¯¯æ‰§è¡Œã€‚</code></pre><h3 id="ä¸»ä»-åŒæ­¥åŸç†"><a href="#ä¸»ä»-åŒæ­¥åŸç†" class="headerlink" title="ä¸»ä» - åŒæ­¥åŸç†"></a>ä¸»ä» - åŒæ­¥åŸç†</h3><pre><code>ä»æœåŠ¡å™¨ä¼šå‘ä¸»æœåŠ¡å™¨å‘å‡ºSYNCæŒ‡ä»¤ï¼Œå½“ä¸»æœåŠ¡å™¨æ¥åˆ°æ­¤å‘½ä»¤åï¼Œå°±ä¼šè°ƒç”¨BGSAVEæŒ‡ä»¤æ¥åˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹ä¸“é—¨è¿›è¡Œæ•°æ®æŒä¹…åŒ–å·¥ä½œï¼Œä¹Ÿå°±æ˜¯å°†ä¸»æœåŠ¡å™¨çš„æ•°æ®å†™å…¥RDBæ–‡ä»¶ä¸­ã€‚åœ¨æ•°æ®æŒä¹…åŒ–æœŸé—´ï¼Œä¸»æœåŠ¡å™¨å°†æ‰§è¡Œçš„å†™æŒ‡ä»¤éƒ½ç¼“å­˜åœ¨å†…å­˜ä¸­ã€‚åœ¨BGSAVEæŒ‡ä»¤æ‰§è¡Œå®Œæˆåï¼Œä¸»æœåŠ¡å™¨ä¼šå°†æŒä¹…åŒ–å¥½çš„RDBæ–‡ä»¶å‘é€ç»™ä»æœåŠ¡å™¨ï¼Œä»æœåŠ¡å™¨æ¥åˆ°æ­¤æ–‡ä»¶åä¼šå°†å…¶å­˜å‚¨åˆ°ç£ç›˜ä¸Šï¼Œç„¶åå†å°†å…¶è¯»å–åˆ°å†…å­˜ä¸­ã€‚è¿™ä¸ªåŠ¨ä½œå®Œæˆåï¼Œä¸»æœåŠ¡å™¨ä¼šå°†è¿™æ®µæ—¶é—´ç¼“å­˜çš„å†™æŒ‡ä»¤å†ä»¥redisåè®®çš„æ ¼å¼å‘é€ç»™ä»æœåŠ¡å™¨ã€‚å¦å¤–ï¼Œè¦è¯´çš„ä¸€ç‚¹æ˜¯ï¼Œå³ä½¿æœ‰å¤šä¸ªä»æœåŠ¡å™¨åŒæ—¶å‘æ¥SYNCæŒ‡ä»¤ï¼Œä¸»æœåŠ¡å™¨ä¹Ÿåªä¼šæ‰§è¡Œä¸€æ¬¡BGSAVEï¼Œç„¶åæŠŠæŒä¹…åŒ–å¥½çš„RDBæ–‡ä»¶å‘ç»™å¤šä¸ªä¸‹æ¸¸ã€‚åœ¨redis2.8ç‰ˆæœ¬ä¹‹å‰ï¼Œå¦‚æœä»æœåŠ¡å™¨ä¸ä¸»æœåŠ¡å™¨å› æŸäº›åŸå› æ–­å¼€è¿æ¥çš„è¯ï¼Œéƒ½ä¼šè¿›è¡Œä¸€æ¬¡ä¸»ä»ä¹‹é—´çš„å…¨é‡çš„æ•°æ®åŒæ­¥ï¼›è€Œåœ¨2.8ç‰ˆæœ¬ä¹‹åï¼Œredisæ”¯æŒäº†æ•ˆç‡æ›´é«˜çš„å¢é‡åŒæ­¥ç­–ç•¥ï¼Œè¿™å¤§å¤§é™ä½äº†è¿æ¥æ–­å¼€çš„æ¢å¤æˆæœ¬ã€‚ä¸»æœåŠ¡å™¨ä¼šåœ¨å†…å­˜ä¸­ç»´æŠ¤ä¸€ä¸ªç¼“å†²åŒºï¼Œç¼“å†²åŒºä¸­å­˜å‚¨ç€å°†è¦å‘ç»™ä»æœåŠ¡å™¨çš„å†…å®¹ã€‚ä»æœåŠ¡å™¨åœ¨ä¸ä¸»æœåŠ¡å™¨å‡ºç°ç½‘ç»œç¬æ–­ä¹‹åï¼Œä»æœåŠ¡å™¨ä¼šå°è¯•å†æ¬¡ä¸ä¸»æœåŠ¡å™¨è¿æ¥ï¼Œä¸€æ—¦è¿æ¥æˆåŠŸï¼Œä»æœåŠ¡å™¨å°±ä¼šæŠŠâ€œå¸Œæœ›åŒæ­¥çš„ä¸»æœåŠ¡å™¨IDâ€å’Œâ€œå¸Œæœ›è¯·æ±‚çš„æ•°æ®çš„åç§»ä½ç½®ï¼ˆreplication offsetï¼‰â€å‘é€å‡ºå»ã€‚ä¸»æœåŠ¡å™¨æ¥æ”¶åˆ°è¿™æ ·çš„åŒæ­¥è¯·æ±‚åï¼Œé¦–å…ˆä¼šéªŒè¯ä¸»æœåŠ¡å™¨IDæ˜¯å¦å’Œè‡ªå·±çš„IDåŒ¹é…ï¼Œå…¶æ¬¡ä¼šæ£€æŸ¥â€œè¯·æ±‚çš„åç§»ä½ç½®â€æ˜¯å¦å­˜åœ¨äºè‡ªå·±çš„ç¼“å†²åŒºä¸­ï¼Œå¦‚æœä¸¤è€…éƒ½æ»¡è¶³çš„è¯ï¼Œä¸»æœåŠ¡å™¨å°±ä¼šå‘ä»æœåŠ¡å™¨å‘é€å¢é‡å†…å®¹ã€‚å¢é‡åŒæ­¥åŠŸèƒ½ï¼Œéœ€è¦æœåŠ¡å™¨ç«¯æ”¯æŒå…¨æ–°çš„PSYNCæŒ‡ä»¤ã€‚è¿™ä¸ªæŒ‡ä»¤ï¼Œåªæœ‰åœ¨redis-2.8ä¹‹åæ‰å…·æœ‰ã€‚</code></pre><h3 id="sentinelä»‹ç»"><a href="#sentinelä»‹ç»" class="headerlink" title="sentinelä»‹ç»"></a><strong>sentinelä»‹ç»</strong></h3><pre><code>Sentinel(å“¨å…µ)æ˜¯ç”¨äºç›‘æ§redisé›†ç¾¤ä¸­MasterçŠ¶æ€çš„å·¥å…·ï¼Œå…¶å·²ç»è¢«é›†æˆåœ¨redis2.4+çš„ç‰ˆæœ¬ä¸­Sentinelä½œç”¨ï¼š 1)ï¼šMasterçŠ¶æ€æ£€æµ‹ 2)ï¼šå¦‚æœMasterå¼‚å¸¸ï¼Œåˆ™ä¼šè¿›è¡ŒMaster-Slaveåˆ‡æ¢ï¼Œå°†å…¶ä¸­ä¸€ä¸ªSlaveä½œä¸ºMasterï¼Œå°†ä¹‹å‰çš„Masterä½œä¸ºSlave 3)ï¼šMaster-Slaveåˆ‡æ¢åï¼Œmaster_redis.confã€slave_redis.confå’Œsentinel.confçš„å†…å®¹éƒ½ä¼šå‘ç”Ÿæ”¹å˜ï¼Œå³master_redis.confä¸­ä¼šå¤šä¸€è¡Œslaveofçš„é…ç½®ï¼Œsentinel.confçš„ç›‘æ§ç›®æ ‡ä¼šéšä¹‹è°ƒæ¢ Sentinelå·¥ä½œæ–¹å¼ï¼š 1)ï¼šæ¯ä¸ªSentinelä»¥æ¯ç§’é’Ÿä¸€æ¬¡çš„é¢‘ç‡å‘å®ƒæ‰€çŸ¥çš„Masterï¼ŒSlaveä»¥åŠå…¶ä»– Sentinel å®ä¾‹å‘é€ä¸€ä¸ª PING å‘½ä»¤ 2)ï¼šå¦‚æœä¸€ä¸ªå®ä¾‹ï¼ˆinstanceï¼‰è·ç¦»æœ€åä¸€æ¬¡æœ‰æ•ˆå›å¤ PING å‘½ä»¤çš„æ—¶é—´è¶…è¿‡ down-after-milliseconds é€‰é¡¹æ‰€æŒ‡å®šçš„å€¼ï¼Œ åˆ™è¿™ä¸ªå®ä¾‹ä¼šè¢« Sentinel æ ‡è®°ä¸ºä¸»è§‚ä¸‹çº¿ã€‚ 3)ï¼šå¦‚æœä¸€ä¸ªMasterè¢«æ ‡è®°ä¸ºä¸»è§‚ä¸‹çº¿ï¼Œåˆ™æ­£åœ¨ç›‘è§†è¿™ä¸ªMasterçš„æ‰€æœ‰ Sentinel è¦ä»¥æ¯ç§’ä¸€æ¬¡çš„é¢‘ç‡ç¡®è®¤Masterçš„ç¡®è¿›å…¥äº†ä¸»è§‚ä¸‹çº¿çŠ¶æ€ã€‚ 4)ï¼šå½“æœ‰è¶³å¤Ÿæ•°é‡çš„ Sentinelï¼ˆå¤§äºç­‰äºé…ç½®æ–‡ä»¶æŒ‡å®šçš„å€¼ï¼‰åœ¨æŒ‡å®šçš„æ—¶é—´èŒƒå›´å†…ç¡®è®¤Masterçš„ç¡®è¿›å…¥äº†ä¸»è§‚ä¸‹çº¿çŠ¶æ€ï¼Œ åˆ™Masterä¼šè¢«æ ‡è®°ä¸ºå®¢è§‚ä¸‹çº¿ 5)ï¼šåœ¨ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œ æ¯ä¸ª Sentinel ä¼šä»¥æ¯ 10 ç§’ä¸€æ¬¡çš„é¢‘ç‡å‘å®ƒå·²çŸ¥çš„æ‰€æœ‰Masterï¼ŒSlaveå‘é€ INFO å‘½ä»¤ 6)ï¼šå½“Masterè¢« Sentinel æ ‡è®°ä¸ºå®¢è§‚ä¸‹çº¿æ—¶ï¼ŒSentinel å‘ä¸‹çº¿çš„ Master çš„æ‰€æœ‰ Slave å‘é€ INFO å‘½ä»¤çš„é¢‘ç‡ä¼šä» 10 ç§’ä¸€æ¬¡æ”¹ä¸ºæ¯ç§’ä¸€æ¬¡ 7)ï¼šè‹¥æ²¡æœ‰è¶³å¤Ÿæ•°é‡çš„ Sentinel åŒæ„ Master å·²ç»ä¸‹çº¿ï¼Œ Master çš„å®¢è§‚ä¸‹çº¿çŠ¶æ€å°±ä¼šè¢«ç§»é™¤ã€‚ è‹¥ Master é‡æ–°å‘ Sentinel çš„ PING å‘½ä»¤è¿”å›æœ‰æ•ˆå›å¤ï¼Œ Master çš„ä¸»è§‚ä¸‹çº¿çŠ¶æ€å°±ä¼šè¢«ç§»é™¤ã€‚=============================================================ä¸»è§‚ä¸‹çº¿å’Œå®¢è§‚ä¸‹çº¿ ä¸»è§‚ä¸‹çº¿ï¼šSubjectively Downï¼Œç®€ç§° SDOWNï¼ŒæŒ‡çš„æ˜¯å½“å‰ Sentinel å®ä¾‹å¯¹æŸä¸ªredisæœåŠ¡å™¨åšå‡ºçš„ä¸‹çº¿åˆ¤æ–­ã€‚ å®¢è§‚ä¸‹çº¿ï¼šObjectively Downï¼Œ ç®€ç§° ODOWNï¼ŒæŒ‡çš„æ˜¯å¤šä¸ª Sentinel å®ä¾‹åœ¨å¯¹Master Serveråšå‡º SDOWN  åˆ¤æ–­ï¼Œå¹¶ä¸”é€šè¿‡ SENTINEL is-master-down-by-addr å‘½ä»¤äº’ç›¸äº¤æµä¹‹åï¼Œå¾—å‡ºçš„Master  Serverä¸‹çº¿åˆ¤æ–­ï¼Œç„¶åå¼€å¯failover.</code></pre><h3 id="ä¸»ä»åŒæ­¥éƒ¨ç½²"><a href="#ä¸»ä»åŒæ­¥éƒ¨ç½²" class="headerlink" title="ä¸»ä»åŒæ­¥éƒ¨ç½²"></a>ä¸»ä»åŒæ­¥éƒ¨ç½²</h3><pre><code>æµ‹è¯•ç¯å¢ƒ:centos7.4redis-master:192.168.19.129   vm1redis-slave1:192.168.19.136   vm4redis-slave2:192.168.19.135   vm51.é¦–å…ˆä¸‰å°æœåŠ¡å™¨å°†rediså•æœºéƒ¨ç½²å®Œæˆã€‚ç¼–è¾‘masterçš„redisé…ç½®æ–‡ä»¶:[root@redis-master ~]# cd /usr/local/redis-5.0.4[root@redis-master redis]# vim redis.conf</code></pre><img src="https://i.loli.net/2019/05/07/5cd19e2caa3bf.jpg" /><p>2.ä¿®æ”¹slave1çš„é…ç½®æ–‡ä»¶ï¼š<br>[root@redis-slave1 ~]# cd /data/application/redis/<br>[root@redis-slave1 redis]# vim redis.conf      â€”ä¿®æ”¹å¦‚ä¸‹ï¼š</p><img src="https://i.loli.net/2019/05/07/5cd19e5ea0f84.jpg" /><img src="https://i.loli.net/2019/05/07/5cd19e838e43e.jpg" /><p>3.é…ç½®slave2çš„é…ç½®æ–‡ä»¶:<br>[root@redis-slave2 ~]# cd /data/application/redis/<br>[root@redis-slave2 redis]# vim redis.conf       â€”ä¿®æ”¹å¦‚ä¸‹  å’Œslave1 ç›¸åŒ</p><p>4.é‡å¯ä¸‰å°redis</p><img src="https://i.loli.net/2019/05/07/5cd19ebbe787b.jpg" /><p>5.æµ‹è¯•ä¸»ä»</p><img src="https://i.loli.net/2019/05/07/5cd19f3641529.jpg" /><p><img src="C:%5CUsers%5Cw%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5C1557241701339.png" alt="1557241701339"></p><p>ä¸‰å°å‡æµ‹è¯•æ— è¯¯ï¼Œä¸»ä»åŒæ­¥éƒ¨ç½²å®Œæˆ</p><h3 id="é…ç½®å“¨å…µæ¨¡å¼"><a href="#é…ç½®å“¨å…µæ¨¡å¼" class="headerlink" title="é…ç½®å“¨å…µæ¨¡å¼"></a>é…ç½®å“¨å…µæ¨¡å¼</h3><pre><code>1.æ¯å°æœºå™¨ä¸Šä¿®æ”¹redisä¸»é…ç½®æ–‡ä»¶redis.confæ–‡ä»¶è®¾ç½®ï¼šbind 0.0.0.0       ---é…ç½®ä¸»ä»æ—¶å·²ç»å®Œæˆ2.æ¯å°æœºå™¨ä¸Šä¿®æ”¹sentinel.confé…ç½®æ–‡ä»¶ï¼šä¿®æ”¹å¦‚ä¸‹é…ç½®[root@redis-master src]# cd ..[root@redis-master redis]# vim sentinel.conf        sentinel monitor mymaster 192.168.233.10 6379 2 (slaveä¸Šé¢å†™çš„æ˜¯masterçš„ipï¼Œmasterå†™è‡ªå·±ip)        sentinel down-after-milliseconds mymaster 3000        sentinel failover-timeout mymaster 10000        protected-mode no</code></pre><pre><code>å…³é—­åŠ å¯†protected-mode noæ„æˆmasterå®¢è§‚ä¸‹çº¿çš„å‰æï¼Œè‡³å°‘æœ‰ä¸¤ä¸ªsentinel(å“¨å…µ)ä¸»è§‚è®¤ä¸ºmasterå·²ç»ä¸‹çº¿sentinel monitor mymaster 192.168.19.129 6379 2 sentinelæ¯éš”ä¸€å®šæ—¶é—´å‘å…¶å·²çŸ¥çš„masterå‘é€pingæŒ‡ä»¤ï¼Œåœ¨è®¾ç½®çš„è¿™ä¸ªæ—¶é—´å†…å¦‚æœæ²¡æœ‰æ”¶masterè¿”å›çš„æ•°æ®åŒ…ï¼Œå°±ä¼šæŠŠmasteræ ‡è®°ä¸ºä¸»è§‚ä¸‹çº¿ã€‚å•ä½ä¸ºæ¯«ç§’sentinel down-after-milliseconds mymaster 3000åœ¨è¿™ä¸ªæ—¶é—´å†…å¦‚æœä¸»ä»åˆ‡æ¢æ²¡æœ‰å®Œæˆå°±åœæ­¢åˆ‡æ¢ã€‚å•ä½æ¯«ç§’sentinel failover-timeout mymaster 10000</code></pre><pre><code>3.æ¯å°æœºå™¨å¯åŠ¨å“¨å…µæœåŠ¡ï¼š        # ./src/redis-sentinel sentinel.confæ³¨æ„:åœ¨ç”Ÿäº§ç¯å¢ƒä¸‹å°†å“¨å…µæ¨¡å¼å¯åŠ¨æ”¾åˆ°åå°æ‰§è¡Œ:         ./src/redis-sentinel sentinel.conf &amp;åœ¨masterä¸Šé¢æ‰§è¡Œè¿™æ˜¯å¯åŠ¨æˆåŠŸçš„ï¼</code></pre><img src="https://i.loli.net/2019/05/07/5cd1a228086b6.jpg" /><img src="https://i.loli.net/2019/05/07/5cd1a2797a3e7.jpg" /><p>å°†masterçš„å“¨å…µæ¨¡å¼é€€å‡ºï¼Œå†å°†redisæœåŠ¡stopäº†ï¼Œåœ¨ä¸¤å°slaveä¸Šé¢æŸ¥çœ‹å…¶ä¸­ä¸€å°æ˜¯å¦åˆ‡æ¢ä¸ºmaster:(æ²¡æœ‰ä¼˜å…ˆçº§ï¼Œä¸ºéšæœºåˆ‡æ¢)</p><p>master 192.168.19.129</p><img src="https://i.loli.net/2019/05/07/5cd1a2ef82487.jpg" /><p>slave 192.168.19.136</p><p><img src="C:%5CUsers%5Cw%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5C1557242911037.png" alt="1557242911037"></p><p>â€‹               ä¸»ä»+å“¨å…µæ¨¡å¼æµ‹è¯•éƒ¨ç½²å®Œæˆï¼</p><p>==========================================================</p><p>äº†è§£</p><p>ä¸»ä»+å“¨å…µ+lvs  åˆ¶ä½œredisä¸»ä»çš„é«˜ç§‘ç”¨</p><p>redisåˆ‡ç‰‡ç­‰</p>]]></content>
      
      
      <categories>
          
          <category> SQL </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Redis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ‰¾å‡ºJavaä¸­CPUä½¿ç”¨ç‡æœ€é«˜çš„çº¿ç¨‹ï¼Œå¹¶æ‰“å°è¿™äº›çº¿ç¨‹çš„å †æ ˆã€‚</title>
      <link href="2018/09/28/linux/zhao-chu-java-zhong-cpu-shi-yong-lu-zui-gao-de-xian-cheng-bing-da-yin-zhe-xie-xian-cheng-de-dui-zhan/"/>
      <url>2018/09/28/linux/zhao-chu-java-zhong-cpu-shi-yong-lu-zui-gao-de-xian-cheng-bing-da-yin-zhe-xie-xian-cheng-de-dui-zhan/</url>
      
        <content type="html"><![CDATA[<h5 id="1"><a href="#1" class="headerlink" title="1"></a>1</h5><pre class=" language-shell"><code class="language-shell">#!/bin/bash# @Function# Find out the highest cpu consumed threads of java, and print the stack of these threads.## @Usage#   $ ./show-busy-java-threads.sh## @author Jerry Leereadonly PROG=`basename $0`readonly -a COMMAND_LINE=("$0" "$@")usage() {    cat <<EOFUsage: ${PROG} [OPTION]...Find out the highest cpu consumed threads of java, and print the stack of these threads.Example: ${PROG} -c 10Options:    -p, --pid       find out the highest cpu consumed threads from the specifed java process,                    default from all java process.    -c, --count     set the thread count to show, default is 5    -h, --help      display this help and exitEOF    exit $1}readonly ARGS=`getopt -n "$PROG" -a -o c:p:h -l count:,pid:,help -- "$@"`[ $? -ne 0 ] && usage 1eval set -- "${ARGS}"while true; do    case "$1" in    -c|--count)        count="$2"        shift 2        ;;    -p|--pid)        pid="$2"        shift 2        ;;    -h|--help)        usage        ;;    --)        shift        break        ;;    esacdonecount=${count:-5}redEcho() {    [ -c /dev/stdout ] && {        # if stdout is console, turn on color output.        echo -ne "\033[1;31m"        echo -n "$@"        echo -e "\033[0m"    } || echo "$@"}yellowEcho() {    [ -c /dev/stdout ] && {        # if stdout is console, turn on color output.        echo -ne "\033[1;33m"        echo -n "$@"        echo -e "\033[0m"    } || echo "$@"}blueEcho() {    [ -c /dev/stdout ] && {        # if stdout is console, turn on color output.        echo -ne "\033[1;36m"        echo -n "$@"        echo -e "\033[0m"    } || echo "$@"}# Check the existence of jstack command!if ! which jstack &> /dev/null; then    [ -z "$JAVA_HOME" ] && {        redEcho "Error: jstack not found on PATH!"        exit 1    }    ! [ -f "$JAVA_HOME/bin/jstack" ] && {        redEcho "Error: jstack not found on PATH and $JAVA_HOME/bin/jstack file does NOT exists!"        exit 1    }    ! [ -x "$JAVA_HOME/bin/jstack" ] && {        redEcho "Error: jstack not found on PATH and $JAVA_HOME/bin/jstack is NOT executalbe!"        exit 1    }    export PATH="$JAVA_HOME/bin:$PATH"fireadonly uuid=`date +%s`_${RANDOM}_$$cleanupWhenExit() {    rm /tmp/${uuid}_* &> /dev/null}trap "cleanupWhenExit" EXITprintStackOfThread() {    local line    local count=1    while IFS=" " read -a line ; do        local pid=${line[0]}        local threadId=${line[1]}        local threadId0x=`printf %x ${threadId}`        local user=${line[2]}        local pcpu=${line[4]}        local jstackFile=/tmp/${uuid}_${pid}        [ ! -f "${jstackFile}" ] && {            {                if [ "${user}" == "${USER}" ]; then                    jstack ${pid} > ${jstackFile}                else                    if [ $UID == 0 ]; then                        sudo -u ${user} jstack ${pid} > ${jstackFile}                    else                        redEcho "[$((count++))] Fail to jstack Busy(${pcpu}%) thread(${threadId}/0x${threadId0x}) stack of java process(${pid}) under user(${user})."                        redEcho "User of java process($user) is not current user($USER), need sudo to run again:"                        yellowEcho "    sudo ${COMMAND_LINE[@]}"                        echo                        continue                    fi                fi            } || {                redEcho "[$((count++))] Fail to jstack Busy(${pcpu}%) thread(${threadId}/0x${threadId0x}) stack of java process(${pid}) under user(${user})."                echo                rm ${jstackFile}                continue            }        }        blueEcho "[$((count++))] Busy(${pcpu}%) thread(${threadId}/0x${threadId0x}) stack of java process(${pid}) under user(${user}):"        sed "/nid=0x${threadId0x} /,/^$/p" -n ${jstackFile}    done}ps -Leo pid,lwp,user,comm,pcpu --no-headers | {    [ -z "${pid}" ] &&    awk '$4=="java"{print $0}' ||    awk -v "pid=${pid}" '$1==pid,$4=="java"{print $0}'} | sort -k5 -r -n | head --lines "${count}" | printStackOfThread</code></pre><p>åŸæ–‡åœ°å€ï¼š<a href="https://files-cdn.cnblogs.com/files/clsn/show-busy-java-threads.sh" target="_blank" rel="noopener">https://files-cdn.cnblogs.com/files/clsn/show-busy-java-threads.sh</a></p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç›‘æ§ä½“ç³»</title>
      <link href="2018/06/05/jian-kong/jian-kong-ti-xi/"/>
      <url>2018/06/05/jian-kong/jian-kong-ti-xi/</url>
      
        <content type="html"><![CDATA[<h6 id="ç›‘æ§å¯¹è±¡ï¼š"><a href="#ç›‘æ§å¯¹è±¡ï¼š" class="headerlink" title="ç›‘æ§å¯¹è±¡ï¼š"></a>ç›‘æ§å¯¹è±¡ï¼š</h6><p>ã€€ã€€ã€€ã€€1. ç›‘æ§å¯¹è±¡çš„ç†è§£ï¼šCPUæ˜¯æ€ä¹ˆå·¥ä½œçš„ï¼ŒåŸç†<br>ã€€ã€€ã€€ã€€2. ç›‘æ§å¯¹è±¡çš„æŒ‡æ ‡ï¼šCPUä½¿ç”¨ç‡ CPUè´Ÿè½½ CPUä¸ªæ•° ä¸Šä¸‹æ–‡åˆ‡æ¢<br>ã€€ã€€ã€€ã€€3. ç¡®å®šæ€§èƒ½åŸºå‡†çº¿ï¼šæ€ä¹ˆæ ·æ‰ç®—æ•…éšœï¼ŸCPUè´Ÿè½½å¤šä¸Šæ‰ç®—é«˜<br>ç›‘æ§èŒƒå›´ï¼š<br>ã€€ã€€ã€€ã€€1.ç¡¬ä»¶ç›‘æ§æœåŠ¡å™¨çš„ç¡¬ä»¶æ•…éšœ<br>ã€€ã€€ã€€ã€€2.æ“ä½œç³»ç»Ÿç›‘æ§ CPUã€å†…å­˜ã€ç¡¬ç›˜ã€IOã€è¿›ç¨‹<br>ã€€ã€€ã€€ã€€3.åº”ç”¨æœåŠ¡ç›‘æ§ nginxã€MySQLã€ç­‰æœåŠ¡<br>ã€€ã€€ã€€ã€€4.ä¸šåŠ¡ç›‘æ§</p><hr><h3 id="ç¡¬ä»¶ç›‘æ§ï¼š"><a href="#ç¡¬ä»¶ç›‘æ§ï¼š" class="headerlink" title="ç¡¬ä»¶ç›‘æ§ï¼š"></a>ç¡¬ä»¶ç›‘æ§ï¼š</h3><p>ã€€ã€€1.ä½¿ç”¨IPMI<br>ã€€ã€€2.æœºæˆ¿å·¡æ£€<br>è¿œç¨‹æ§åˆ¶å¡ï¼š<br>ã€€ã€€ã€€ã€€DELLæœåŠ¡å™¨ï¼šiDRAC<br>ã€€ã€€ã€€ã€€HPæœåŠ¡å™¨ï¼šILO â€”â€”â€”â€”-Linuxå°±å¯ä»¥ä½¿ç”¨IPMIï¼ˆä¾èµ–äºBMCæ§åˆ¶å™¨ï¼‰<br>ã€€ã€€ã€€ã€€IBMæœåŠ¡å™¨ï¼šIMM |<br>ã€€ã€€ã€€ã€€Linuxæ˜¯ç®¡ç†IPMIå·¥å…·<br>ã€€ã€€ã€€ã€€â€˜ipmitoolâ€™ï¼ˆç›‘æ§å’Œæ§åˆ¶ï¼‰</p><h4 id="1-ç¡¬ä»¶è¦æ”¯æŒ"><a href="#1-ç¡¬ä»¶è¦æ”¯æŒ" class="headerlink" title="1.ç¡¬ä»¶è¦æ”¯æŒ"></a>1.ç¡¬ä»¶è¦æ”¯æŒ</h4><h4 id="2-æ“ä½œç³»ç»Ÿ-â€˜Linux-IPMIâ€™"><a href="#2-æ“ä½œç³»ç»Ÿ-â€˜Linux-IPMIâ€™" class="headerlink" title="2.æ“ä½œç³»ç»Ÿ â€˜Linux IPMIâ€™"></a>2.æ“ä½œç³»ç»Ÿ â€˜Linux IPMIâ€™</h4><p>ipmitoolå®‰è£…:</p><pre><code>[root@localhost ~]# yum install OpenIPMI ipmitool -y[root@localhost ~]# rpm -qa OpenIPMI ipmitoolipmitool-1.8.13-8.el7_1.x86_64OpenIPMI-2.0.19-11.el7.x86_64</code></pre><p>ä½¿ç”¨IPMIæœ‰ä¸¤ç§æ–¹å¼<br>1ã€æœ¬åœ°è¿›è¡Œè°ƒç”¨<br>2ã€è¿œç¨‹è°ƒç”¨ ï¼ˆIPåœ°å€ ç”¨æˆ·åå’Œå¯†ç ï¼‰</p><pre><code>[root@localhost ~]# systemctl start ipmi  #å¯åŠ¨æœ¬æ¬¡ä»¥Centos7è¿›è¡Œæ¼”ç¤º</code></pre><p>IPMIç›¸å…³å‘½ä»¤</p><pre><code>[root@localhost ~]# ipmitool --helpipmitool: invalid option -- &#39;-&#39;ipmitool version 1.8.13usage: ipmitool [options...] &lt;command&gt;       -h             This help       -V             Show version information       -v             Verbose (can use multiple times)       -c             Display output in comma separated format       -d N           Specify a /dev/ipmiN device to use (default=0)       -I intf        Interface to use       -H hostname    Remote host name for LAN interface       -p port        Remote RMCP port [default=623]       -U username    Remote session username       -f file        Read remote session password from file       -z size        Change Size of Communication Channel (OEM)       -S sdr         Use local file for remote SDR cache       -D tty:b[:s]   Specify the serial device, baud rate to use                      and, optionally, specify that interface is the system one       -a             Prompt for remote password       -Y             Prompt for the Kg key for IPMIv2 authentication       -e char        Set SOL escape character       -C ciphersuite Cipher suite to be used by lanplus interface       -k key         Use Kg key for IPMIv2 authentication       -y hex_key     Use hexadecimal-encoded Kg key for IPMIv2 authentication       -L level       Remote session privilege level [default=ADMINISTRATOR]                      Append a &#39;+&#39; to use name/privilege lookup in RAKP1       -A authtype    Force use of auth type NONE, PASSWORD, MD2, MD5 or OEM       -P password    Remote session password       -E             Read password from IPMI_PASSWORD environment variable       -K             Read kgkey from IPMI_KGKEY environment variable       -m address     Set local IPMB address       -b channel     Set destination channel for bridged request       -t address     Bridge request to remote target address       -B channel     Set transit channel for bridged request (dual bridge)       -T address     Set transit address for bridge request (dual bridge)       -l lun         Set destination lun for raw commands       -o oemtype     Setup for OEM (use &#39;list&#39; to see available OEM types)       -O seloem      Use file for OEM SEL event descriptions       -N seconds     Specify timeout for lan [default=2] / lanplus [default=1] interface       -R retry       Set the number of retries for lan/lanplus interface [default=4]Interfaces:    open          Linux OpenIPMI Interface [default]    imb           Intel IMB Interface     lan           IPMI v1.5 LAN Interface     lanplus       IPMI v2.0 RMCP+ LAN Interface     serial-terminal  Serial Interface, Terminal Mode     serial-basic  Serial Interface, Basic Mode Commands:    raw           Send a RAW IPMI request and print response    i2c           Send an I2C Master Write-Read command and print response    spd           Print SPD info from remote I2C device    lan           Configure LAN Channels    chassis       Get chassis status and set power state    power         Shortcut to chassis power commands    event         Send pre-defined events to MC    mc            Management Controller status and global enables    sdr           Print Sensor Data Repository entries and readings    sensor        Print detailed sensor information    fru           Print built-in FRU and scan SDR for FRU locators    gendev        Read/Write Device associated with Generic Device locators sdr    sel           Print System Event Log (SEL)    pef           Configure Platform Event Filtering (PEF)    sol           Configure and connect IPMIv2.0 Serial-over-LAN    tsol          Configure and connect with Tyan IPMIv1.5 Serial-over-LAN    isol          Configure IPMIv1.5 Serial-over-LAN    user          Configure Management Controller users    channel       Configure Management Controller channels    session       Print session information    dcmi          Data Center Management Interface    sunoem        OEM Commands for Sun servers    kontronoem    OEM Commands for Kontron devices    picmg         Run a PICMG/ATCA extended cmd    fwum          Update IPMC using Kontron OEM Firmware Update Manager    firewall      Configure Firmware Firewall    delloem       OEM Commands for Dell systems    shell         Launch interactive IPMI shell    exec          Run list of commands from file    set           Set runtime variable for shell and exec    hpm           Update HPM components using PICMG HPM.1 file    ekanalyzer    run FRU-Ekeying analyzer using FRU files    ime           Update Intel Manageability Engine Firmware</code></pre><p>IPMIé…ç½®ç½‘ç»œï¼Œæœ‰ä¸¤ç§æ–¹å¼ï¼š<br>ipmi over lanï¼ˆå¤§ä½“æ„æ€æ˜¯é€šè¿‡ç½‘å¡æ¥è¿›è¡Œè¿æ¥ï¼‰<br>ç‹¬ç«‹ ï¼ˆç»™æœåŠ¡å™¨å•ç‹¬æ’ä¸€ä¸ªç½‘çº¿ï¼‰ DELLæœåŠ¡å™¨å¯ä»¥åœ¨å°é¢æ¿ä¸­è®¾ç½®ipmi äº‘ä¸»æœºæˆ‘ä»¬ä¸éœ€è¦è€ƒè™‘IPMI</p><p>å¯¹äºè·¯ç”±å™¨å’Œäº¤æ¢æœºï¼šSNMP<br>å¯¹äºè¿™äº›è®¾å¤‡ï¼Œå°±ä¸åšå…·ä½“æè¿°äº†ï¼Œæ¯•ç«Ÿæ²¡æœ‰æ¥è§¦è¿‡</p><h3 id="ç³»ç»Ÿç›‘æ§"><a href="#ç³»ç»Ÿç›‘æ§" class="headerlink" title="ç³»ç»Ÿç›‘æ§"></a>ç³»ç»Ÿç›‘æ§</h3><p>åšä¸ºç³»ç»Ÿè¿ç»´æ¥è¯´ç³»ç»Ÿç›‘æ§æ˜¯é‡ç‚¹</p><pre><code>- CPU- å†…å­˜- IO Input/Ouputï¼ˆç½‘ç»œã€ç£ç›˜ï¼‰</code></pre><h4 id="CPUä¸‰ä¸ªé‡è¦çš„æ¦‚å¿µï¼š"><a href="#CPUä¸‰ä¸ªé‡è¦çš„æ¦‚å¿µï¼š" class="headerlink" title="CPUä¸‰ä¸ªé‡è¦çš„æ¦‚å¿µï¼š"></a>CPUä¸‰ä¸ªé‡è¦çš„æ¦‚å¿µï¼š</h4><p>ã€€ã€€1.ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼šCPUè°ƒåº¦å™¨å®æ–½çš„è¿›ç¨‹çš„åˆ‡æ¢è¿‡ç¨‹ï¼Œä¸Šä¸‹æ–‡åˆ‡æ¢<br>ã€€ã€€2.è¿è¡Œé˜Ÿåˆ—ï¼ˆè´Ÿè½½ï¼‰ï¼šè¿è¡Œé˜Ÿåˆ—ï¼Œæ’é˜Ÿ å¯ä»¥å‚è€ƒæˆ‘æ˜¯ä¸€ä¸ªè¿›ç¨‹æ–‡ç« <br>ã€€ã€€3.ä½¿ç”¨ç‡<br>ç›‘æ§CPUéœ€è¦ç¡®å®šæœåŠ¡ç±»å‹ï¼š<br>ï¼ˆ1ï¼‰ IOå¯†é›†å‹ ï¼ˆæ•°æ®åº“ï¼‰<br>ï¼ˆ2ï¼‰ CPUå¯†é›†å‹ï¼ˆWeb/mailï¼‰</p><p>ç¡®å®šæ€§èƒ½çš„åŸºå‡†çº¿<br>ã€€ã€€è¿è¡Œé˜Ÿåˆ—ï¼š1-3ä¸ªçº¿ç¨‹ 1CPU 4æ ¸ è´Ÿè½½ä¸è¶…è¿‡12<br>ã€€ã€€CPUä½¿ç”¨ï¼š65%-70%ç”¨æˆ·æ€åˆ©ç”¨ç‡<br>ã€€ã€€ã€€ã€€ã€€ã€€ã€€30%-35%å†…æ ¸æ€åˆ©ç”¨ç‡<br>ã€€ã€€ã€€ã€€ã€€ã€€ã€€0%-5% ç©ºé—²<br>ã€€ã€€ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼š è¶Šå°‘è¶Šå¥½<br>æ‰€æœ‰çš„ç›‘æ§éƒ½è¦æ ¹æ®ä¸šåŠ¡æ¥è€ƒè™‘</p><h4 id="å¸¸è§çš„ç³»ç»Ÿç›‘æ§å·¥å…·"><a href="#å¸¸è§çš„ç³»ç»Ÿç›‘æ§å·¥å…·" class="headerlink" title="å¸¸è§çš„ç³»ç»Ÿç›‘æ§å·¥å…·"></a>å¸¸è§çš„ç³»ç»Ÿç›‘æ§å·¥å…·</h4><p>Topã€sysstatã€mpstat</p><p>å·¥å…·çš„ä½¿ç”¨æ–¹æ³•<br>TOPå‚æ•°è§£é‡Š</p><p>topçš„è¯¦ç»†å¯ä»¥å‚è€ƒæˆ‘åœ¨51ctoçš„è¿™ç¯‡æ–‡ç«  <a href="http://blog.51cto.com/12419955/2052642" target="_blank" rel="noopener">http://blog.51cto.com/12419955/2052642</a></p><p>å…¶å®å¯¹äºTopï¼Œç°åœ¨æˆ‘æ›´å–œæ¬¢htopå’Œgtopï¼Œgtopè™½ç„¶è‰²å½©å’ŒåŠŸèƒ½æ›´å¼ºå¤§ï¼Œä½†æ˜¯å› ä¸ºgtopä¸åœ¨epelæºé‡Œï¼Œå¯¼è‡´gtopçš„ä½¿ç”¨æ²¡æœ‰htopç”¨çš„å¹¿æ³›</p><p>å½“ç„¶gtopè¿™ä¹ˆå¥½ç”¨ï¼Œå½“ç„¶è¦ç”¨ä¸€ä¸‹ï¼Œè¿™æ˜¯å¦ä¸€ç‰‡å…³äºgtopçš„æ–‡ç«  <a href="https://tigerfivegit.github.io/2018/12/14/Linuxæ€§èƒ½ç›‘æ§å·¥å…·-gtop/" target="_blank" rel="noopener">https://tigerfivegit.github.io/2018/12/14/Linux%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E5%B7%A5%E5%85%B7-gtop/</a></p><p>ç¬¬ä¸€è¡Œ åˆ†åˆ«æ˜¾ç¤ºï¼šç³»ç»Ÿå½“å‰æ—¶é—´ ç³»ç»Ÿè¿è¡Œæ—¶é—´ å½“å‰ç”¨æˆ·ç™»é™†æ•° ç³»ç»Ÿè´Ÿè½½ã€‚<br>ã€€ã€€ç³»ç»Ÿè´Ÿè½½ï¼ˆload averageï¼‰ï¼Œè¿™é‡Œæœ‰ä¸‰ä¸ªæ•°å€¼ï¼Œåˆ†åˆ«æ˜¯ç³»ç»Ÿæœ€è¿‘1åˆ†é’Ÿï¼Œ5åˆ†é’Ÿï¼Œ15åˆ†é’Ÿçš„å¹³å‡è´Ÿè½½ã€‚ä¸€èˆ¬å¯¹äºå•ä¸ªå¤„ç†å™¨æ¥è¯´ï¼Œè´Ÿè½½åœ¨0 â€” 1.00 ä¹‹é—´æ˜¯æ­£å¸¸çš„ï¼Œè¶…è¿‡1.00å°±è¦å¼•èµ·æ³¨æ„äº†ã€‚åœ¨å¤šæ ¸å¤„ç†å™¨ä¸­ï¼Œä½ çš„ç³»ç»Ÿå‡å€¼ä¸åº”è¯¥é«˜äºå¤„ç†å™¨æ ¸å¿ƒçš„æ€»æ•°ã€‚</p><p>ç¬¬äºŒè¡Œ åˆ†åˆ«æ˜¾ç¤ºï¼štotalè¿›ç¨‹æ€»æ•°ã€ runningæ­£åœ¨è¿è¡Œçš„è¿›ç¨‹æ•°ã€ sleepingç¡çœ çš„è¿›ç¨‹æ•°ã€stoppedåœæ­¢çš„è¿›ç¨‹æ•°ã€ zombieåƒµå°¸è¿›ç¨‹æ•°ã€‚</p><p>ç¬¬ä¸‰è¡Œ<br>åˆ†åˆ«æ˜¾ç¤ºï¼š<br>%usç”¨æˆ·ç©ºé—´å ç”¨CPUç™¾åˆ†æ¯”ã€<br>%syå†…æ ¸ç©ºé—´å ç”¨CPUç™¾åˆ†æ¯”ã€<br>%niç”¨æˆ·è¿›ç¨‹ç©ºé—´å†…æ”¹å˜è¿‡ä¼˜å…ˆçº§çš„è¿›ç¨‹å ç”¨CPUç™¾åˆ†æ¯”ã€<br>%idç©ºé—²CPUç™¾åˆ†æ¯”ã€<br>%waç­‰å¾…è¾“å…¥è¾“å‡ºï¼ˆI/Oï¼‰çš„CPUæ—¶é—´ç™¾åˆ†æ¯” ã€<br>%hiæŒ‡çš„æ˜¯cpuå¤„ç†ç¡¬ä»¶ä¸­æ–­çš„æ—¶é—´ã€%siæŒ‡çš„æ˜¯cpuå¤„ç†è½¯ä¸­æ–­çš„æ—¶é—´ ã€<br>%stç”¨äºæœ‰è™šæ‹Ÿcpuçš„æƒ…å†µï¼Œç”¨æ¥æŒ‡ç¤ºè¢«è™šæ‹Ÿæœºå·æ‰çš„cpuæ—¶é—´ã€‚<br>é€šå¸¸id%å€¼å¯ä»¥åæ˜ ä¸€ä¸ªç³»ç»Ÿcpuçš„é—²å¿™ç¨‹åº¦ã€‚</p><p>ç¬¬å››è¡Œ MEM ï¼štotal ç‰©ç†å†…å­˜æ€»é‡ã€ used ä½¿ç”¨çš„ç‰©ç†å†…å­˜æ€»é‡ã€free ç©ºé—²å†…å­˜æ€»é‡ã€ buffers ç”¨ä½œå†…æ ¸ç¼“å­˜çš„å†…å­˜é‡ã€‚</p><p>ç¬¬äº”è¡Œ SWAPï¼štotal äº¤æ¢åŒºæ€»é‡ã€ usedä½¿ç”¨çš„äº¤æ¢åŒºæ€»é‡ã€free ç©ºé—²äº¤æ¢åŒºæ€»é‡ã€ cachedç¼“å†²çš„äº¤æ¢åŒºæ€»é‡ã€‚<br>bufferså’Œcachedçš„åŒºåˆ«éœ€è¦è¯´æ˜ä¸€ä¸‹ï¼ŒbuffersæŒ‡çš„æ˜¯å—è®¾å¤‡çš„è¯»å†™ç¼“å†²åŒºï¼ŒcachedæŒ‡çš„æ˜¯æ–‡ä»¶ç³»ç»Ÿæœ¬èº«çš„é¡µé¢ç¼“å­˜ã€‚å®ƒä»¬éƒ½æ˜¯linuxæ“ä½œç³»ç»Ÿåº•å±‚çš„æœºåˆ¶ï¼Œç›®çš„å°±æ˜¯ä¸ºäº†åŠ é€Ÿå¯¹ç£ç›˜çš„è®¿é—®ã€‚</p><p>ç¬¬å…­è¡Œ PID(è¿›ç¨‹å·)ã€ USERï¼ˆè¿è¡Œç”¨æˆ·ï¼‰ã€PRï¼ˆä¼˜å…ˆçº§ï¼‰ã€NIï¼ˆä»»åŠ¡niceå€¼ï¼‰ã€VIRTï¼ˆè™šæ‹Ÿå†…å­˜ç”¨é‡ï¼‰VIRT=SWAP+RES ã€RESï¼ˆç‰©ç†å†…å­˜ç”¨é‡ï¼‰ã€SHRï¼ˆå…±äº«å†…å­˜ç”¨é‡ï¼‰ã€Sï¼ˆè¿›ç¨‹çŠ¶æ€ï¼‰ã€%CPUï¼ˆCPUå ç”¨æ¯”ï¼‰ã€%MEMï¼ˆç‰©ç†å†…å­˜å ç”¨æ¯”ï¼‰ã€TIME+ï¼ˆç´¯è®¡CPUå  ç”¨æ—¶é—´)ã€ã€€COMMAND å‘½ä»¤å/å‘½ä»¤è¡Œã€‚</p><p>ä¸‹é¢ç®€å•ä»‹ç»topå‘½ä»¤çš„ä½¿ç”¨æ–¹æ³•ï¼š<br>top [-] [d]</p><p>[q] [c] [C] [S] [n]<br>è¿ç»´å¿…ä¼šï¼<br>å‚æ•°è¯´æ˜<br>dæŒ‡å®šæ¯ä¸¤æ¬¡å±å¹•ä¿¡æ¯åˆ·æ–°ä¹‹é—´çš„æ—¶é—´é—´éš”ã€‚å½“ç„¶ç”¨æˆ·å¯ä»¥ä½¿ç”¨säº¤äº’å‘½ä»¤æ¥æ”¹å˜ä¹‹ã€‚<br>pé€šè¿‡æŒ‡å®šç›‘æ§è¿›ç¨‹IDæ¥ä»…ä»…ç›‘æ§æŸä¸ªè¿›ç¨‹çš„çŠ¶æ€ã€‚<br>qè¯¥é€‰é¡¹å°†ä½¿topæ²¡æœ‰ä»»ä½•å»¶è¿Ÿçš„è¿›è¡Œåˆ·æ–°ã€‚å¦‚æœè°ƒç”¨ç¨‹åºæœ‰è¶…çº§ç”¨æˆ·æƒé™ï¼Œé‚£ä¹ˆtopå°†ä»¥å°½å¯èƒ½é«˜çš„ä¼˜å…ˆçº§è¿è¡Œã€‚<br>SæŒ‡å®šç´¯è®¡æ¨¡å¼ã€‚<br>sä½¿topå‘½ä»¤åœ¨å®‰å…¨æ¨¡å¼ä¸­è¿è¡Œã€‚è¿™å°†å»é™¤äº¤äº’å‘½ä»¤æ‰€å¸¦æ¥çš„æ½œåœ¨å±é™©ã€‚<br>iä½¿topä¸æ˜¾ç¤ºä»»ä½•é—²ç½®æˆ–è€…åƒµæ­»è¿›ç¨‹ã€‚<br>cæ˜¾ç¤ºæ•´ä¸ªå‘½ä»¤è¡Œè€Œä¸åªæ˜¯æ˜¾ç¤ºå‘½ä»¤åã€‚<br>ä¸‹é¢ä»‹ç»åœ¨topå‘½ä»¤æ‰§è¡Œè¿‡ç¨‹ä¸­å¯ä»¥ä½¿ç”¨çš„ä¸€äº›äº¤äº’å‘½ä»¤<br>ã€€ã€€ä»ä½¿ç”¨è§’åº¦æ¥çœ‹ï¼Œç†Ÿç»ƒçš„æŒæ¡è¿™äº›å‘½ä»¤æ¯”æŒæ¡é€‰é¡¹è¿˜é‡è¦ä¸€äº›ã€‚<br>ã€€ã€€è¿™äº›å‘½ä»¤éƒ½æ˜¯å•å­—æ¯çš„ï¼Œå¦‚æœåœ¨å‘½ä»¤è¡Œé€‰é¡¹ä¸­ä½¿ç”¨äº†sé€‰é¡¹ï¼Œåˆ™å¯èƒ½å…¶ä¸­ä¸€äº›å‘½ä»¤ä¼šè¢«å±è”½æ‰ã€‚<br>Ctrl+L æ“¦é™¤å¹¶ä¸”é‡å†™å±å¹•ã€‚<br>hæˆ–è€…? æ˜¾ç¤ºå¸®åŠ©ç”»é¢ï¼Œç»™å‡ºä¸€äº›ç®€çŸ­çš„å‘½ä»¤æ€»ç»“è¯´æ˜ã€‚<br>k ç»ˆæ­¢ä¸€ä¸ªè¿›ç¨‹ã€‚ç³»ç»Ÿå°†æç¤ºç”¨æˆ·è¾“å…¥éœ€è¦ç»ˆæ­¢çš„è¿›ç¨‹PIDï¼Œä»¥åŠéœ€è¦å‘é€ç»™è¯¥è¿›ç¨‹ä»€ä¹ˆæ ·çš„ä¿¡å·ã€‚ä¸€èˆ¬çš„ç»ˆæ­¢è¿›ç¨‹å¯ä»¥ä½¿ç”¨15ä¿¡å·ï¼›å¦‚æœä¸èƒ½æ­£å¸¸ç»“æŸé‚£å°±ä½¿ç”¨ä¿¡å·9å¼ºåˆ¶ç»“æŸè¯¥è¿›ç¨‹ã€‚é»˜è®¤å€¼æ˜¯ä¿¡å·15ã€‚åœ¨å®‰å…¨æ¨¡å¼ä¸­æ­¤å‘½ä»¤è¢«å±è”½ã€‚<br>i å¿½ç•¥é—²ç½®å’Œåƒµæ­»è¿›ç¨‹ã€‚è¿™æ˜¯ä¸€ä¸ªå¼€å…³å¼å‘½ä»¤ã€‚<br>q é€€å‡ºç¨‹åºã€‚<br>r é‡æ–°å®‰æ’ä¸€ä¸ªè¿›ç¨‹çš„ä¼˜å…ˆçº§åˆ«ã€‚ç³»ç»Ÿæç¤ºç”¨æˆ·è¾“å…¥éœ€è¦æ”¹å˜çš„è¿›ç¨‹PIDä»¥åŠéœ€è¦è®¾ç½®çš„è¿›ç¨‹ä¼˜å…ˆçº§å€¼ã€‚è¾“å…¥ä¸€ä¸ªæ­£å€¼å°†ä½¿ä¼˜å…ˆçº§é™ä½ï¼Œåä¹‹åˆ™å¯ä»¥ä½¿è¯¥è¿›ç¨‹æ‹¥æœ‰æ›´é«˜çš„ä¼˜å…ˆæƒã€‚é»˜è®¤å€¼æ˜¯10ã€‚<br>s æ”¹å˜ä¸¤æ¬¡åˆ·æ–°ä¹‹é—´çš„å»¶è¿Ÿæ—¶é—´ã€‚ç³»ç»Ÿå°†æç¤ºç”¨æˆ·è¾“å…¥æ–°çš„æ—¶é—´ï¼Œå•ä½ä¸ºsã€‚å¦‚æœæœ‰å°æ•°ï¼Œå°±æ¢ç®—æˆm sã€‚è¾“å…¥0å€¼åˆ™ç³»ç»Ÿå°†ä¸æ–­åˆ·æ–°ï¼Œé»˜è®¤å€¼æ˜¯5 sã€‚éœ€è¦æ³¨æ„çš„æ˜¯å¦‚æœè®¾ç½®å¤ªå°çš„æ—¶é—´ï¼Œå¾ˆå¯èƒ½ä¼šå¼•èµ·ä¸æ–­åˆ·æ–°ï¼Œä»è€Œæ ¹æœ¬æ¥ä¸åŠçœ‹æ¸…æ˜¾ç¤ºçš„æƒ…å†µï¼Œè€Œä¸”ç³»ç»Ÿè´Ÿè½½ä¹Ÿä¼šå¤§å¤§å¢åŠ ã€‚<br>fæˆ–è€…F ä»å½“å‰æ˜¾ç¤ºä¸­æ·»åŠ æˆ–è€…åˆ é™¤é¡¹ç›®ã€‚<br>oæˆ–è€…O æ”¹å˜æ˜¾ç¤ºé¡¹ç›®çš„é¡ºåºã€‚<br>l åˆ‡æ¢æ˜¾ç¤ºå¹³å‡è´Ÿè½½å’Œå¯åŠ¨æ—¶é—´ä¿¡æ¯ã€‚<br>m åˆ‡æ¢æ˜¾ç¤ºå†…å­˜ä¿¡æ¯ã€‚<br>t åˆ‡æ¢æ˜¾ç¤ºè¿›ç¨‹å’ŒCPUçŠ¶æ€ä¿¡æ¯ã€‚<br>c åˆ‡æ¢æ˜¾ç¤ºå‘½ä»¤åç§°å’Œå®Œæ•´å‘½ä»¤è¡Œã€‚<br>M æ ¹æ®é©»ç•™å†…å­˜å¤§å°è¿›è¡Œæ’åºã€‚<br>P æ ¹æ®CPUä½¿ç”¨ç™¾åˆ†æ¯”å¤§å°è¿›è¡Œæ’åºã€‚<br>T æ ¹æ®æ—¶é—´/ç´¯è®¡æ—¶é—´è¿›è¡Œæ’åºã€‚<br>W å°†å½“å‰è®¾ç½®å†™å…¥~/.toprcæ–‡ä»¶ä¸­ã€‚è¿™æ˜¯å†™topé…ç½®æ–‡ä»¶çš„æ¨èæ–¹æ³•ã€‚<br>Shift+M å¯æŒ‰å†…å­˜å ç”¨æƒ…å†µè¿›è¡Œæ’åºã€‚</p><h4 id="sysstat-è¯´æ˜"><a href="#sysstat-è¯´æ˜" class="headerlink" title="sysstat è¯´æ˜"></a>sysstat è¯´æ˜</h4><pre><code>yum install sysstat -yvmstat --helpusage: vmstat [-V] [-n] [delay [count]]              -V prints version.              -n causes the headers not to be reprinted regularly.              -a print inactive/active page stats.              -d prints disk statistics              -D prints disk table              -p prints disk partition statistics              -s prints vm table              -m prints slabinfo              -t add timestamp to output              -S unit size              delay is the delay between updates in seconds.               unit size k:1000 K:1024 m:1000000 M:1048576 (default is K)              count is the number of updates.</code></pre><p>ä¾‹å­ï¼šæ¯éš”1ç§’è·å–1æ¬¡ï¼Œæ¬¡æ•°ä¸é™</p><pre><code># vmstat 1procs -----------memory---------- ---swap-- -----io---- --system-- -----cpu----- r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st 0  0      0 547332 177544 535336    0    0     1     6    5   41  1  0 98  0  0     0  0      0 547324 177544 535336    0    0     0     0  210  445  1  0 99  0  0     0  0      0 547324 177544 535336    0    0     0     0  195  435  0  0 100  0  0 0  0      0 547324 177544 535336    0    0     0     0  208  440  1  0 99  0  0     0  0      0 547332 177544 535336    0    0     0     0  209  446  0  0 100  0  0 0  0      0 547332 177544 535336    0    0     0     0  207  442  1  1 98  0  0     0  0      0 547332 177544 535336    0    0     0     0  201  438  0  0 100  0  0</code></pre><p>#rè¡¨ç¤ºCPUæ’é˜Ÿçš„æƒ…å†µï¼Œbä»£è¡¨ è¿›ç¨‹å µå¡ï¼Œç­‰å¾…io<br>æ¯éš”1ç§’è·å–1æ¬¡ï¼Œæ¬¡æ•°10æ¬¡</p><pre><code># vmstat 1 10procs -----------memory---------- ---swap-- -----io---- --system-- -----cpu----- r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st 1  0      0 547340 177544 535344    0    0     1     6    5   41  1  0 98  0  0     0  0      0 547332 177544 535344    0    0     0    28  210  453  1  1 97  1  0     0  0      0 547332 177544 535344    0    0     0     0  200  433  0  0 100  0  0 0  0      0 547332 177544 535344    0    0     0     0  211  445  1  0 99  0  0     0  0      0 547332 177544 535344    0    0     0     0  201  439  0  1 99  0  0     0  0      0 547332 177544 535344    0    0     0     0  197  436  0  0 100  0  0 0  0      0 547332 177544 535344    0    0     0     0  201  442  1  0 99  0  0     0  0      0 547324 177544 535348    0    0     0     0  240  484  2  1 97  0  0     0  0      0 547324 177544 535348    0    0     0     0  203  438  0  0 100  0  0 0  0      0 547324 177544 535348    0    0     0     0  197  430  1  0 99  0  0</code></pre><p>mpstat<br>æŸ¥çœ‹æ‰€æœ‰CPUçš„å¹³å‡å€¼</p><pre><code>mpstat 1Linux 2.6.32-431.23.3.el6.x86_64 (www)  08/30/2016  _x86_64_    (1 CPU)05:13:22 PM  CPU    %usr   %nice    %sys %iowait    %irq   %soft  %steal  %guest   %idle05:13:23 PM  all    1.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00   99.00105:13:24 PM  all    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.0005:13:25 PM  all    2.00    0.00    1.00    0.00    0.00    0.00    0.00    0.00   97.0005:13:26 PM  all    1.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00   99.00</code></pre><pre><code>mpstat 1 10Linux 2.6.32-431.23.3.el6.x86_64 (www)  08/30/2016  _x86_64_    (1 CPU)05:13:38 PM  CPU    %usr   %nice    %sys %iowait    %irq   %soft  %steal  %guest   %idle05:13:39 PM  all    2.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00   98.0005:13:40 PM  all    0.00    0.00    1.00    0.00    0.00    0.00    0.00    0.00   99.0005:13:41 PM  all    1.01    0.00    0.00    0.00    0.00    0.00    0.00    0.00   98.99</code></pre><p>ä¸Šè¿°æ˜¯CPUç›‘æ§ï¼ŒCPUç›‘æ§ä¸»è¦é ç»éªŒã€‚å› ä¸ºä¸šåŠ¡ä¸åŒæŒ‡æ ‡ä¸åŒï¼ŒæŒ‡æ ‡è¶Šä½è¶Šå¥½æ˜¯ä¸å˜çš„é“ç†</p><p>sarå‘½ä»¤ä¹Ÿæœ‰ç±»ä¼¼çš„åŠŸèƒ½ï¼Œä½†æ˜¯sarå‘½ä»¤æ›´èƒ½çœ‹åˆ°å†å²çš„ä¿¡æ¯ï¼Œå¯¹äºé—®é¢˜æ’æŸ¥æœ‰æ›´å¥½çš„ä½œç”¨<br>å½“ç„¶å¯¹äºæˆ‘è¿™ç§å–œæ¬¢éªšæ“ä½œçš„äººï¼Œsarå‘½ä»¤ä¸å¯èƒ½ä¸æå•Šï¼Œè¿™é‡Œæ”¾ä¸ªé“¾æ¥ <a href="https://tigerfivegit.github.io/2018/11/21/sar/" target="_blank" rel="noopener">https://tigerfivegit.github.io/2018/11/21/sar/</a></p><h4 id="å†…å­˜ç¡¬ç›˜ç›‘æ§ï¼š"><a href="#å†…å­˜ç¡¬ç›˜ç›‘æ§ï¼š" class="headerlink" title="å†…å­˜ç¡¬ç›˜ç›‘æ§ï¼š"></a>å†…å­˜ç¡¬ç›˜ç›‘æ§ï¼š</h4><p>ç¡¬ç›˜æ ¼å¼åŒ–ååˆ†æˆå—ï¼ˆblogï¼‰<br>å†…å­˜é»˜è®¤æ˜¯é¡µï¼ˆå¤§å°4kbï¼‰è¯»å–æŒ‰ç…§é¡µæ¥è¿›è¡Œè¯»å–<br>å†…å­˜ï¼šfree vmstat</p><pre><code>free -m             total       used       free     shared    buffers     cachedMem:          1875       1338        537          0        173        523-/+ buffers/cache:        640       1234Swap:            0          0          0</code></pre><p>total æ€»å†…å­˜<br>used å·²ä½¿ç”¨å†…å­˜<br>free ç©ºé—²å†…å­˜<br>shared å…±äº«å†…å­˜ï¼ˆè¿›ç¨‹é—´ç›¸äº’é€šä¿¡ä½¿ç”¨å…±äº«å†…å­˜ï¼‰<br>buffers ç¼“å†²<br>cached ç¼“å­˜<br>Centos7 ä¼šæœ‰ä¸€ä¸ªavailableï¼Œæ´»åŠ¨å†…å­˜</p><p>#äº‘æœåŠ¡å™¨ä¸€èˆ¬ä¸åˆ†é…swapåˆ†åŒºï¼Œç‰©ç†æœºèƒ½ä¸ä½¿ç”¨äº¤æ¢åˆ†åŒºå°±ä¸ä½¿ç”¨äº¤æ¢åˆ†åŒº</p><pre><code>vmstat 1procs -----------memory---------- ---swap-- -----io---- --system-- -----cpu----- r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st 0  0      0 550628 177684 536324    0    0     1     6    7   46  1  0 98  0  0     0  0      0 550620 177684 536324    0    0     0    40  187  429  0  0 100  0  0 0  0      0 550620 177684 536324    0    0     0     0  183  427  1  0 99  0  0     0  0      0 550620 177684 536324    0    0     0     0  197  436  0  1 99  0  0</code></pre><p>swpdäº¤æ¢åˆ†åŒºçš„å¤§å°<br>freeå¯ç”¨çš„ç‰©ç†å†…å­˜å¤§å°<br>buff ç¼“å†²åŒºçš„å¤§å°<br>cache ç¼“å­˜åŒºçš„å¤§å°<br>si æ•°æ®ä»äº¤æ¢åˆ†åŒºè¯»å–åˆ°å†…å­˜çš„å¤§å°<br>so æ•°æ®ä»å†…å­˜åˆ°äº¤æ¢åˆ†åŒº<br>bi ä»äº¤æ¢åˆ†åŒºè¯»åˆ°å†…å­˜ï¼ˆblockï¼‰<br>bo å†…å­˜å†™åˆ°ç¡¬ç›˜çš„</p><pre><code>å†…å­˜è¾¾åˆ°å¤šå°‘æŠ¥è­¦å‘¢ï¼Ÿ 80%</code></pre><h4 id="ç¡¬ç›˜ï¼šIOPS-IOâ€™s-Per-Second-iotop-df-h-iostat"><a href="#ç¡¬ç›˜ï¼šIOPS-IOâ€™s-Per-Second-iotop-df-h-iostat" class="headerlink" title="ç¡¬ç›˜ï¼šIOPS IOâ€™s Per Second iotop df -h iostat"></a>ç¡¬ç›˜ï¼šIOPS IOâ€™s Per Second iotop df -h iostat</h4><p>ã€€ã€€é¡ºåºIOï¼ˆå¿«ï¼‰<br>ã€€ã€€éšæœºIOï¼ˆæ…¢ï¼‰<br>æŸ¥çœ‹ç£ç›˜å‰©ä½™ç©ºé—´</p><pre><code>df -hFilesystem      Size  Used Avail Use% Mounted on/dev/xvda1       40G  4.1G   34G  11% /tmpfs           938M     0  938M   0% /dev/shm</code></pre><p>ç›‘æ§ç£ç›˜IO iotop</p><pre><code>yum install iotop -y</code></pre><p><img src="https://i.loli.net/2018/12/14/5c139a40ccaac.jpg" alt="htop"></p><pre><code>å¯ä»¥ä½¿ç”¨ddå‘½ä»¤ç”Ÿæˆä¸€ä¸ªæ–‡ä»¶å¤¹è¿›è¡Œæµ‹è¯• ç”Ÿæˆå‘½ä»¤å¦‚ä¸‹ï¼š# dd if=/dev/zero of=/tmp/1.txt bs=1M count=10001000+0 records in1000+0 records out1048576000 bytes (1.0 GB) copied, 20.509 s, 51.1 MB/s[root@www ~]# ls -lh /tmp/1.txt -rw-r--r-- 1 root root 1000M Aug 30 19:48 /tmp/1.txt</code></pre><p>æ­¤æ—¶IOå†™å…¥å¦‚ä¸‹å›¾<br><img src="https://i.loli.net/2018/12/14/5c139a7dbf4d3.jpg" alt="IOå†™å¦‚å›¾"><br>iostatå‘½ä»¤ï¼Œå¯ä»¥çœ‹åˆ°é‚£å—ç£ç›˜ï¼Œæ¯”iotopæ›´åŠ ç»†è‡´</p><pre><code># iostat 1 2Linux 2.6.32-431.23.3.el6.x86_64 (www)  08/30/2016  _x86_64_    (1 CPU)avg-cpu:  %user   %nice %system %iowait  %steal   %idle           1.10    0.00    0.27    0.16    0.00   98.46Device:            tps   Blk_read/s   Blk_wrtn/s   Blk_read   Blk_wrtnxvda              1.51         2.26        17.09     986748    7467560avg-cpu:  %user   %nice %system %iowait  %steal   %idle           1.02    0.00    0.00    0.00    0.00   98.98Device:            tps   Blk_read/s   Blk_wrtn/s   Blk_read   Blk_wrtnxvda              0.00         0.00         0.00          0          0</code></pre><p>tps è®¾å¤‡æ¯ç§’çš„ä¼ è¾“æ¬¡æ•°ï¼ˆæ¯ç§’å¤šå°‘çš„ioè¯·æ±‚ï¼‰<br>Blk_read/s æ¯ç§’ä»è®¾å¤‡è¯»å–çš„æ•°æ®é‡<br>Blk_wrtn/s æ¯ç§’åƒè®¾å¤‡å†™å…¥çš„æ•°æ®é‡<br>Blk_read å†™å…¥æ•°æ®çš„æ€»æ•°<br>Blk_wrtn è¯»å–æ•°æ®çš„æ€»æ•°</p><h4 id="ç½‘ç»œç›‘æ§ï¼šiftop"><a href="#ç½‘ç»œç›‘æ§ï¼šiftop" class="headerlink" title="ç½‘ç»œç›‘æ§ï¼šiftop"></a>ç½‘ç»œç›‘æ§ï¼šiftop</h4><pre><code># yum install iftop -y# iftop -n    #-nä¸åšåŸŸåè§£æ</code></pre><p><img src="https://i.loli.net/2018/12/14/5c139adfd7ab3.jpg" alt="iftop"></p><p>æ­£å¸¸ç›‘æ§åªéœ€è¦ç›‘æ§ç½‘å¡å¸¦å®½å³å¯<br>å…¶ä¸­ç½‘ç»œç›‘æ§æ˜¯æœ€å¤æ‚çš„ï¼Œpingç›‘æ§ç½‘ç»œå»¶è¿Ÿç½‘ç»œä¸¢åŒ…ç­‰ã€‚ä½†æ˜¯æ­¤ç±»çš„ç½‘ç»œç›‘æ§åªæ˜¯ç›‘æ§è‡ªå·±åˆ°å®¢æˆ·ç«¯æ˜¯å¦ä¸¢åŒ…ï¼Œå¹¶ä¸èƒ½ä¿è¯å®¢æˆ·ç«¯åˆ°æœåŠ¡å™¨è¿™è¾¹ä¸ä¸¢åŒ…<br>ã€€å…¶ä¸­å°±äº§ç”Ÿäº†å¦‚ï¼šé˜¿é‡Œæµ‹ã€å¥‡äº‘æµ‹ã€ç«™é•¿å·¥å…·ç­‰ä¸€ç³»åˆ—å¤šèŠ‚ç‚¹çš„ç›‘æ§å·¥å…·</p><p>æ€§èƒ½æµ‹è¯•å¸¸ç”¨å·¥å…·ï¼šIBM nmon ï¼ˆnmon analyserâ€”ç”ŸæˆAIXæ€§èƒ½æŠ¥å‘Šçš„å…è´¹å·¥å…·ï¼‰<br><a href="http://nmon.sourceforge.net/pmwiki.php" target="_blank" rel="noopener">http://nmon.sourceforge.net/pmwiki.php</a> #ä¸‹è½½åœ°å€ï¼ˆéœ€è¦ç¿»å¢™å·¥å…·ï¼‰<br>æ‰€ä»¥æˆ‘ä»¬æä¾›äº†ç™¾åº¦äº‘ä¸‹è½½<br>é“¾æ¥ï¼š<a href="http://pan.baidu.com/s/1boXV6R9" target="_blank" rel="noopener">http://pan.baidu.com/s/1boXV6R9</a> å¯†ç ï¼šsblf<br>åªéœ€è¦ä¸‹è½½å¯¹åº”çš„ç‰ˆæœ¬ï¼Œç»™æ‰§è¡Œæƒé™ã€‚æ‰§è¡Œå³å¯</p><pre><code># chmod +x nmon16e_x86_rhel72 # ./nmon16e_x86_rhel72</code></pre><p><img src="https://i.loli.net/2018/12/14/5c139b3a8ece4.jpg" alt="nmon"></p><p>æˆ‘ä»¬å¯ä»¥ç›´æ¥è¾“å…¥ä¸€ä¸ªc ä¸€ä¸ªmä¸€ä¸ªdã€‚è¿™ä¸ªæ˜¯å®æ—¶çš„ä¸€ä¸ªçŠ¶æ€</p><p><img src="https://i.loli.net/2018/12/14/5c139b6978986.jpg" alt="nmon1"></p><pre><code>./nmon16e_x86_rhel72 --help./nmon16e_x86_rhel72: invalid option -- &#39;-&#39;Hint for nmon16e_x86_rhel72 version 16e    Full Help Info : nmon16e_x86_rhel72 -h    On-screen Stats: nmon16e_x86_rhel72    Data Collection: nmon16e_x86_rhel72 -f [-s &lt;seconds&gt;] [-c &lt;count&gt;] [-t|-T]    Capacity Plan  : nmon16e_x86_rhel72 -xInteractive-Mode:    Read the Welcome screen &amp; at any time type: &quot;h&quot; for more help    Type &quot;q&quot; to exit nmonFor Data-Collect-Mode    -f            Must be the first option on the line (switches off interactive mode)                  Saves data to a CSV Spreadsheet format .nmon file in then local directory                  Note: -f sets a defaults -s300 -c288    which you can then modify    Further Data Collection Options:    -s &lt;seconds&gt;  time between data snapshots    -c &lt;count&gt;    of snapshots before exiting    -t            Includes Top Processes stats (-T also collects command arguments)    -x            Capacity Planning=15 min snapshots for 1 day. (nmon -ft -s 900 -c 96)---- End of Hints-c  é‡‡é›†çš„æ¬¡æ•°-s  é‡‡é›†çš„é—´éš”æ—¶é—´-f  ç”Ÿæˆä¸€ä¸ªæ–‡ä»¶-m  æŒ‡å®šç”Ÿæˆæ–‡ä»¶ä½ç½®</code></pre><p>é‡‡é›†10æ¬¡ é—´éš”10ç§’</p><pre><code># ./nmon16e_x86_rhel72 -c 10 -s 10 -f -m /tmp/# lslocalhost_160831_0435.nmon  nmon16e_x86_rhel72</code></pre><p>å‰é¢ä¸ºä¸»æœºååé¢æ˜¯æ—¥æœŸï¼ˆå¹´æœˆæ—¥æ—¶åˆ†ï¼‰<br>å› ä¸ºæµ‹è¯•å¯èƒ½éœ€è¦ï¼Œæˆ‘ä»¬è¦åˆ¶ä½œæˆè¡¨æ ¼ï¼Œæ‰€ä»¥ç°åœ¨å°†æ–‡ä»¶ä¸Šä¼ åˆ°æ¡Œé¢ä¸Š</p><h1 id="sz-localhost-160831-0435-nmon"><a href="#sz-localhost-160831-0435-nmon" class="headerlink" title="sz localhost_160831_0435.nmon"></a>sz localhost_160831_0435.nmon</h1><p>æˆ‘ä»¬æ‰“å¼€ä¸‹è½½çš„å·¥å…·</p><p><img src="https://i.loli.net/2018/12/14/5c139bd30d9d5.jpg" alt="img"></p><p>è§£å‹æ–‡ä»¶å¤¹ï¼Œæ‰“å¼€nmon analyser v34a.xls</p><p><img src="https://i.loli.net/2018/12/14/5c139be8400bd.jpg" alt="img"></p><p>ç‚¹å‡»Analyse nmon dataæ‰¾åˆ°æˆ‘ä»¬åˆšåˆšå¤åˆ¶å‡ºæ¥çš„æ–‡ä»¶ï¼Œå°±å¯ä»¥çœ‹åˆ°äº†ã€‚</p><p><img src="https://i.loli.net/2018/12/14/5c139bf883548.jpg" alt="img"></p><h4 id="åº”ç”¨æœåŠ¡ç›‘æ§ï¼š"><a href="#åº”ç”¨æœåŠ¡ç›‘æ§ï¼š" class="headerlink" title="åº”ç”¨æœåŠ¡ç›‘æ§ï¼š"></a>åº”ç”¨æœåŠ¡ç›‘æ§ï¼š</h4><p>ä¸¾ä¾‹ï¼šNginx<br>å®‰è£…nginx</p><pre><code># yum install -y gcc glibc gcc-c++ prce-devel openssl-devel pcre-devel</code></pre><p>æç¤ºï¼šnginxå¯ä»¥ä½¿ç”¨ç¨³å®šç‰ˆçš„æœ€æ–°ç‰ˆï¼Œå› ä¸ºå®‰å…¨æ€§ä¼šä¸æ–­çš„æé«˜ã€‚å¦‚æœæ˜¯ç‰¹åˆ«è€çš„ç‰ˆæœ¬ä¼šæœ‰ä¸€äº›æ¼æ´å’ŒåŠŸèƒ½<br>ã€€ã€€è¦æƒ³ç›‘æ§nginxéœ€è¦åœ¨ç¼–è¯‘æ—¶æ·»åŠ å¦‚ä¸‹å‚æ•°</p><pre><code>--with-http_stub_status_module</code></pre><p>ä¸‹è½½Nginx</p><pre><code>wget http://nginx.org/download/nginx-1.10.1.tar.gz</code></pre><p>è§£å‹ï¼Œåé¢æ­¥éª¤å¤ªç®€å•ä¸è¯´äº†<br>å®‰è£…</p><pre><code>[root@localhost nginx-1.10.1]# useradd -s /sbin/nologin www[root@localhost nginx-1.10.1]# ./configure --prefix=/usr/local/nginx-1.10.1 --user=www --group=www --with-http_ssl_module --with-http_stub_status_module</code></pre><p>#configure æ˜¯ä¸€ä¸ªshellè„šæœ¬ï¼Œæ‰§è¡Œå®ƒçš„ä½œç”¨æ˜¯ç”ŸæˆMAKEFILEï¼ˆç¼–è¯‘makeéœ€è¦ï¼‰</p><pre><code>[root@localhost nginx-1.10.1]# make &amp;&amp; make install[root@localhost nginx-1.10.1]# lltotal 676drwxr-xr-x 6 1001 1001   4096 Aug 31 06:02 auto-rw-r--r-- 1 1001 1001 262898 May 31 09:47 CHANGES-rw-r--r-- 1 1001 1001 400701 May 31 09:47 CHANGES.rudrwxr-xr-x 2 1001 1001   4096 Aug 31 06:02 conf-rwxr-xr-x 1 1001 1001   2481 May 31 09:47 configuredrwxr-xr-x 4 1001 1001     68 Aug 31 06:02 contribdrwxr-xr-x 2 1001 1001     38 Aug 31 06:02 html-rw-r--r-- 1 1001 1001   1397 May 31 09:47 LICENSE-rw-r--r-- 1 root root    404 Aug 31 07:46 Makefiledrwxr-xr-x 2 1001 1001     20 Aug 31 06:02 mandrwxr-xr-x 3 root root    119 Aug 31 07:46 objs-rw-r--r-- 1 1001 1001     49 May 31 09:47 READMEdrwxr-xr-x 9 1001 1001     84 Aug 31 06:02 src</code></pre><p>#makeæ˜¯ç”Ÿæˆæ–‡ä»¶ï¼Œmake installæ˜¯å°†ç”Ÿæˆçš„æ–‡ä»¶æ‹·è´åˆ°ä¸åŒçš„åœ°æ–¹<br>make install å®Œæˆä¹‹åå¯ä»¥ç›´æ¥å°†å½“å‰ç›®å½•æ‹·è´åˆ°å…¶ä»–æœåŠ¡å™¨ä¸Šï¼Œå®‰è£…ç›¸åŒçš„ä¾èµ–å°±å¯ä»¥è¿›è¡Œä½¿ç”¨ã€‚</p><pre><code>[root@localhost nginx-1.10.1]# ln -s /usr/local/nginx-1.10.1/ /usr/local/nginx[root@localhost nginx-1.10.1]# netstat -lntp|grep nginxtcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      7058/nginx: master</code></pre><p>ä¿®æ”¹nginx.confé…ç½®æ–‡ä»¶</p><pre><code>    location /status {    stub_status on;    access_log off;        allow 192.168.56.0/24;    deny all;}</code></pre><p>è®¾ç½®åªå…è®¸56ç½‘æ®µè®¿é—®ï¼Œå¹¶å¼€å¯æ—¥å¿—å’ŒçŠ¶æ€æ¨¡å—</p><p>#è¿™ä¸ªæ¯”è¾ƒåŸºç¡€ï¼Œå¦‚æœä¸çŸ¥é“æ€ä¹ˆæ·»åŠ ã€‚å¯ä»¥å‚è€ƒ<a href="http://www.nginx.org/" target="_blank" rel="noopener">www.nginx.org</a> çŠ¶æ€æ¨¡å—<br>æµè§ˆå™¨è®¿é—®ï¼š<a href="http://192.168.56.11/status" target="_blank" rel="noopener">http://192.168.56.11/status</a></p><pre><code>Active connections: 1 server accepts handled requests 3 3 163 Reading: 0 Writing: 1 Waiting: 0</code></pre><p>Active connections: å½“å‰æ´»è·ƒçš„è¿æ¥æ•°<br>3â€”-&gt; ä¸€å…±å¤„ç†äº†å¤šå°‘ä¸ªé“¾æ¥ï¼ˆè¯·æ±‚ï¼‰<br>3â€”-&gt; æˆåŠŸåˆ›å»ºå¤šå°‘æ¬¡æ¡æ‰‹<br>163â€“&gt; æ€»å…±åˆ›å»ºäº†å¤šå°‘ä¸ªè¯·æ±‚<br>Reading:å½“å‰è¯»å–å®¢æˆ·ç«¯heardrçš„æ•°é‡<br>Writing:å½“å‰è¿”å›ç»™å®¢æˆ·ç«¯heardrçš„æ•°é‡ ã€€#å¦‚æœè¿™ä¸ªæŒ‡æ ‡é£™å‡ï¼Œè¯´æ˜æ˜¯åé¢çš„èŠ‚ç‚¹æŒ‚æ‰äº†ï¼Œä¾‹å¦‚æ•°æ®åº“ç­‰ã€‚<br>Waiting:å¤§ä½“æ„æ€æ˜¯å·²ç»å¤„ç†å®Œï¼Œç­‰å¾…ä¸‹æ¬¡è¯·æ±‚çš„æ•°é‡<br>æç¤ºï¼šæˆ‘ä»¬åªéœ€è¦å…³æ³¨æ´»åŠ¨é“¾æ¥å³å¯</p><p>ç›‘æ§æœ€åŸºç¡€çš„åŠŸèƒ½<br>é‡‡é›† å­˜å‚¨ å±•ç¤º å‘Šè­¦</p><p>å‡ æ¬¾ç›‘æ§è½¯ä»¶è¯´æ˜ï¼š<br>å‡ æ¬¾ç›‘æ§è½¯ä»¶å¤§å®¶éƒ½çŸ¥é“åº”è¯¥æ˜¯zabbixï¼Œè¿™ä¸ªå…¥é—¨å’Œéƒ¨ç½²æ¯”è¾ƒç®€å•ï¼Œå¯¹äºä¸­å°ä¼ä¸šéƒ½æ˜¯å‹å¥½çš„ï¼Œä½†æ˜¯éš¾ä»¥ç»†åŒ–å’Œæ·±å…¥åŒ–ã€‚<br>åæ¥å› ä¸šåŠ¡éœ€æ±‚ä»zabbixé€æ¸è½¬ç”¨å°ç±³çš„å¼€æºç›‘æ§open-falconï¼Œè¿™ä¸ªå¯¹äºæ–°æ‰‹ä¸å¤ªå‹å¥½ï¼Œä½†æ˜¯åæœŸçš„æ·»åŠ å’Œç»†åŒ–éƒ½æ˜¯ç‰¹åˆ«å‹å¥½çš„ï¼Œæ¨¡å—åŒ–ã€åˆ†æ”¯åŒ–</p>]]></content>
      
      
      <categories>
          
          <category> ç›‘æ§ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linuxæ—¥å¿—åˆ‡å‰²å·¥å…·Logrotateé…ç½®è¯¦è§£</title>
      <link href="2018/04/05/linux/linux-ri-zhi-qie-ge-gong-ju-logrotate-pei-zhi-xiang-jie/"/>
      <url>2018/04/05/linux/linux-ri-zhi-qie-ge-gong-ju-logrotate-pei-zhi-xiang-jie/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h1 id="Linuxæ—¥å¿—åˆ‡å‰²å·¥å…·Logrotateé…ç½®è¯¦è§£"><a href="#Linuxæ—¥å¿—åˆ‡å‰²å·¥å…·Logrotateé…ç½®è¯¦è§£" class="headerlink" title="[Linuxæ—¥å¿—åˆ‡å‰²å·¥å…·Logrotateé…ç½®è¯¦è§£]"></a>[Linuxæ—¥å¿—åˆ‡å‰²å·¥å…·Logrotateé…ç½®è¯¦è§£]</h1><p>æ–‡ç« ç›®å½•</p><p>[TOC]</p><p>Logrotate ç¨‹åºæ˜¯ä¸€ä¸ªæ—¥å¿—æ–‡ä»¶ç®¡ç†å·¥å…·ã€‚ç”¨äºåˆ†å‰²æ—¥å¿—æ–‡ä»¶ï¼Œå‹ç¼©è½¬å­˜ã€åˆ é™¤æ—§çš„æ—¥å¿—æ–‡ä»¶ï¼Œå¹¶åˆ›å»ºæ–°çš„æ—¥å¿—æ–‡ä»¶ï¼Œä¸‹é¢å°±å¯¹logrotateæ—¥å¿—è½®è½¬çš„è®°å½•ï¼š</p><h2 id="1-Logrotateé…ç½®æ–‡ä»¶ä»‹ç»"><a href="#1-Logrotateé…ç½®æ–‡ä»¶ä»‹ç»" class="headerlink" title="1. Logrotateé…ç½®æ–‡ä»¶ä»‹ç»"></a>1. Logrotateé…ç½®æ–‡ä»¶ä»‹ç»</h2><p><a href="https://www.centos.bz/tag/linux/" target="_blank" rel="noopener">Linux</a>ç³»ç»Ÿé»˜è®¤å®‰è£…logrotateï¼Œé»˜è®¤çš„é…ç½®æ–‡ä»¶ï¼š</p><ul><li><code>/etc/logrotate.conf</code></li><li><code>/etc/logrotate.d/</code></li><li><code>logrotate.conf</code>ï¼šä¸ºä¸»é…ç½®æ–‡ä»¶</li><li><code>logrotate.d</code>ï¼šä¸ºé…ç½®ç›¸å…³å­ç³»ç»Ÿï¼Œç”¨äºéš”ç¦»æ¯ä¸ªåº”ç”¨é…ç½®ï¼ˆ<a href="https://www.centos.bz/category/web-server/nginx/" target="_blank" rel="noopener">Nginx</a>ã€PHPã€<a href="https://www.centos.bz/category/web-server/tomcat/" target="_blank" rel="noopener">Tomcat</a>â€¦ï¼‰</li></ul><p>Logrotateæ˜¯åŸºäºCRONæ¥è¿è¡Œçš„ï¼Œå…¶è„šæœ¬æ˜¯/etc/cron.daily/logrotateï¼Œæ—¥å¿—è½®è½¬æ˜¯ç³»ç»Ÿè‡ªåŠ¨å®Œæˆçš„ã€‚<br>å®é™…è¿è¡Œæ—¶ï¼ŒLogrotateä¼šè°ƒç”¨é…ç½®æ–‡ä»¶/etc/logrotate.confã€‚</p><p>Logrotateå¯ä»¥ç”±è‡ªåŠ¨æˆ–è€…æ‰‹åŠ¨è§¦å‘æ—¥å¿—è½®è½¬ï¼š</p><pre class=" language-shell"><code class="language-shell">logrotate -f /etc/logrotate.d/nginxlogrotate -f /etc/logrotate.d/php</code></pre><p>ä¸è¿‡æ­£å¼æ‰§è¡Œå‰æœ€å¥½é€šè¿‡<a href="https://www.centos.bz/tag/debug/" target="_blank" rel="noopener">Debug</a>é€‰é¡¹æ¥éªŒè¯ä¸€ä¸‹ï¼ˆ-då‚æ•°ï¼‰<br>å…·ä½“logrotateå‘½ä»¤æ ¼å¼å¦‚ä¸‹ï¼š</p><pre class=" language-shell"><code class="language-shell">logrotate [OPTION...] <configfile></code></pre><ul><li><code>-d</code>, <code>--debug</code> ï¼šdebugæ¨¡å¼ï¼Œæµ‹è¯•é…ç½®æ–‡ä»¶æ˜¯å¦æœ‰é”™è¯¯ã€‚</li><li><code>-f</code>, <code>--force</code> ï¼šå¼ºåˆ¶è½¬å‚¨æ–‡ä»¶ã€‚</li><li><code>-m</code>, <code>--mail=command</code> ï¼šå‹ç¼©æ—¥å¿—åï¼Œå‘é€æ—¥å¿—åˆ°æŒ‡å®šé‚®ç®±ã€‚</li><li><code>-s</code>, <code>--state=statefile</code> ï¼šä½¿ç”¨æŒ‡å®šçš„çŠ¶æ€æ–‡ä»¶ã€‚</li><li><code>-v</code>, <code>--verbose</code> ï¼šæ˜¾ç¤ºè½¬å‚¨è¿‡ç¨‹ã€‚</li></ul><h2 id="2-Logrotateræ—¥å¿—æ–‡ä»¶åˆ‡å‰²ç­–ç•¥"><a href="#2-Logrotateræ—¥å¿—æ–‡ä»¶åˆ‡å‰²ç­–ç•¥" class="headerlink" title="2. Logrotateræ—¥å¿—æ–‡ä»¶åˆ‡å‰²ç­–ç•¥"></a>2. Logrotateræ—¥å¿—æ–‡ä»¶åˆ‡å‰²ç­–ç•¥</h2><p>æŸ¥çœ‹logrotate.confé…ç½®ï¼š</p><pre class=" language-shell"><code class="language-shell">cat /etc/logrotate.confweekly //é»˜è®¤æ¯ä¸€å‘¨æ‰§è¡Œä¸€æ¬¡rotateè½®è½¬å·¥ä½œrotate 4 //ä¿ç•™å¤šå°‘ä¸ªæ—¥å¿—æ–‡ä»¶(è½®è½¬å‡ æ¬¡).é»˜è®¤ä¿ç•™å››ä¸ª.å°±æ˜¯æŒ‡å®šæ—¥å¿—æ–‡ä»¶åˆ é™¤ä¹‹å‰è½®è½¬çš„æ¬¡æ•°ï¼Œ0 æŒ‡æ²¡æœ‰å¤‡ä»½create //è‡ªåŠ¨åˆ›å»ºæ–°çš„æ—¥å¿—æ–‡ä»¶ï¼Œæ–°çš„æ—¥å¿—æ–‡ä»¶å…·æœ‰å’ŒåŸæ¥çš„æ–‡ä»¶ç›¸åŒçš„æƒé™ï¼›å› ä¸ºæ—¥å¿—è¢«æ”¹å,å› æ­¤è¦åˆ›å»ºä¸€ä¸ªæ–°çš„æ¥ç»§ç»­å­˜å‚¨ä¹‹å‰çš„æ—¥å¿—dateext //è¿™ä¸ªå‚æ•°å¾ˆé‡è¦ï¼å°±æ˜¯åˆ‡å‰²åçš„æ—¥å¿—æ–‡ä»¶ä»¥å½“å‰æ—¥æœŸä¸ºæ ¼å¼ç»“å°¾ï¼Œå¦‚xxx.log-20131216è¿™æ ·,å¦‚æœæ³¨é‡Šæ‰,åˆ‡å‰²å‡ºæ¥æ˜¯æŒ‰æ•°å­—é€’å¢,å³å‰é¢è¯´çš„ xxx.log-1è¿™ç§æ ¼å¼compress //æ˜¯å¦é€šè¿‡gzipå‹ç¼©è½¬å‚¨ä»¥åçš„æ—¥å¿—æ–‡ä»¶ï¼Œå¦‚xxx.log-20131216.gz ï¼›å¦‚æœä¸éœ€è¦å‹ç¼©ï¼Œæ³¨é‡Šæ‰å°±è¡Œinclude /etc/logrotate.d //å¯¼å…¥/etc/logrotate.d/ ç›®å½•ä¸­çš„å„ä¸ªåº”ç”¨é…ç½®/var/log/wtmp { //ä»…é’ˆå¯¹ /var/log/wtmp æ‰€è®¾å®šçš„å‚æ•°monthly //æ¯æœˆä¸€æ¬¡åˆ‡å‰²,å–ä»£é»˜è®¤çš„ä¸€å‘¨minsize 1M //æ–‡ä»¶å¤§å°è¶…è¿‡ 1M åæ‰ä¼šåˆ‡å‰²create 0664 root utmp //æŒ‡å®šæ–°å»ºçš„æ—¥å¿—æ–‡ä»¶æƒé™ä»¥åŠæ‰€å±ç”¨æˆ·å’Œç»„rotate 1 //åªä¿ç•™ä¸€ä¸ªæ—¥å¿—.}#è¿™ä¸ª wtmp å¯è®°å½•ç”¨æˆ·ç™»å½•ç³»ç»ŸåŠç³»ç»Ÿé‡å¯çš„æ—¶é—´#å› ä¸ºæœ‰ minsize çš„å‚æ•°ï¼Œå› æ­¤ä¸è§å¾—æ¯ä¸ªæœˆä¸€å®šä¼šæ‰§è¡Œä¸€æ¬¡å–”.è¦çœ‹æ–‡ä»¶å¤§å°ã€‚</code></pre><p>Logrotateä¸­å…¶ä»–å¯é…ç½®å‚æ•°ï¼Œå…·ä½“å¦‚ä¸‹ï¼š</p><pre class=" language-shell"><code class="language-shell">compress //é€šè¿‡gzip å‹ç¼©è½¬å‚¨ä»¥åçš„æ—¥å¿—nocompress //ä¸åšgzipå‹ç¼©å¤„ç†copytruncate //ç”¨äºè¿˜åœ¨æ‰“å¼€ä¸­çš„æ—¥å¿—æ–‡ä»¶ï¼ŒæŠŠå½“å‰æ—¥å¿—å¤‡ä»½å¹¶æˆªæ–­ï¼›æ˜¯å…ˆæ‹·è´å†æ¸…ç©ºçš„æ–¹å¼ï¼Œæ‹·è´å’Œæ¸…ç©ºä¹‹é—´æœ‰ä¸€ä¸ªæ—¶é—´å·®ï¼Œå¯èƒ½ä¼šä¸¢å¤±éƒ¨åˆ†æ—¥å¿—æ•°æ®ã€‚nocopytruncate //å¤‡ä»½æ—¥å¿—æ–‡ä»¶ä¸è¿‡ä¸æˆªæ–­create mode owner group //è½®è½¬æ—¶æŒ‡å®šåˆ›å»ºæ–°æ–‡ä»¶çš„å±æ€§ï¼Œå¦‚create 0777 nobody nobodynocreate //ä¸å»ºç«‹æ–°çš„æ—¥å¿—æ–‡ä»¶delaycompress //å’Œcompress ä¸€èµ·ä½¿ç”¨æ—¶ï¼Œè½¬å‚¨çš„æ—¥å¿—æ–‡ä»¶åˆ°ä¸‹ä¸€æ¬¡è½¬å‚¨æ—¶æ‰å‹ç¼©nodelaycompress //è¦†ç›– delaycompress é€‰é¡¹ï¼Œè½¬å‚¨åŒæ—¶å‹ç¼©ã€‚missingok //å¦‚æœæ—¥å¿—ä¸¢å¤±ï¼Œä¸æŠ¥é”™ç»§ç»­æ»šåŠ¨ä¸‹ä¸€ä¸ªæ—¥å¿—errors address //ä¸“å‚¨æ—¶çš„é”™è¯¯ä¿¡æ¯å‘é€åˆ°æŒ‡å®šçš„Email åœ°å€ifempty //å³ä½¿æ—¥å¿—æ–‡ä»¶ä¸ºç©ºæ–‡ä»¶ä¹Ÿåšè½®è½¬ï¼Œè¿™ä¸ªæ˜¯logrotateçš„ç¼ºçœé€‰é¡¹ã€‚notifempty //å½“æ—¥å¿—æ–‡ä»¶ä¸ºç©ºæ—¶ï¼Œä¸è¿›è¡Œè½®è½¬mail address //æŠŠè½¬å‚¨çš„æ—¥å¿—æ–‡ä»¶å‘é€åˆ°æŒ‡å®šçš„E-mail åœ°å€nomail //è½¬å‚¨æ—¶ä¸å‘é€æ—¥å¿—æ–‡ä»¶olddir directory //è½¬å‚¨åçš„æ—¥å¿—æ–‡ä»¶æ”¾å…¥æŒ‡å®šçš„ç›®å½•ï¼Œå¿…é¡»å’Œå½“å‰æ—¥å¿—æ–‡ä»¶åœ¨åŒä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿnoolddir //è½¬å‚¨åçš„æ—¥å¿—æ–‡ä»¶å’Œå½“å‰æ—¥å¿—æ–‡ä»¶æ”¾åœ¨åŒä¸€ä¸ªç›®å½•ä¸‹sharedscripts //è¿è¡Œpostrotateè„šæœ¬ï¼Œä½œç”¨æ˜¯åœ¨æ‰€æœ‰æ—¥å¿—éƒ½è½®è½¬åç»Ÿä¸€æ‰§è¡Œä¸€æ¬¡è„šæœ¬ã€‚å¦‚æœæ²¡æœ‰é…ç½®è¿™ä¸ªï¼Œé‚£ä¹ˆæ¯ä¸ªæ—¥å¿—è½®è½¬åéƒ½ä¼šæ‰§è¡Œä¸€æ¬¡è„šæœ¬prerotate //åœ¨logrotateè½¬å‚¨ä¹‹å‰éœ€è¦æ‰§è¡Œçš„æŒ‡ä»¤ï¼Œä¾‹å¦‚ä¿®æ”¹æ–‡ä»¶çš„å±æ€§ç­‰åŠ¨ä½œï¼›å¿…é¡»ç‹¬ç«‹æˆè¡Œpostrotate //åœ¨logrotateè½¬å‚¨ä¹‹åéœ€è¦æ‰§è¡Œçš„æŒ‡ä»¤ï¼Œä¾‹å¦‚é‡æ–°å¯åŠ¨ (kill -HUP) æŸä¸ªæœåŠ¡ï¼å¿…é¡»ç‹¬ç«‹æˆè¡Œdaily //æŒ‡å®šè½¬å‚¨å‘¨æœŸä¸ºæ¯å¤©weekly //æŒ‡å®šè½¬å‚¨å‘¨æœŸä¸ºæ¯å‘¨monthly //æŒ‡å®šè½¬å‚¨å‘¨æœŸä¸ºæ¯æœˆrotate count //æŒ‡å®šæ—¥å¿—æ–‡ä»¶åˆ é™¤ä¹‹å‰è½¬å‚¨çš„æ¬¡æ•°ï¼Œ0 æŒ‡æ²¡æœ‰å¤‡ä»½ï¼Œ5 æŒ‡ä¿ç•™5 ä¸ªå¤‡ä»½dateext //ä½¿ç”¨å½“æœŸæ—¥æœŸä½œä¸ºå‘½åæ ¼å¼dateformat .%s //é…åˆdateextä½¿ç”¨ï¼Œç´§è·Ÿåœ¨ä¸‹ä¸€è¡Œå‡ºç°ï¼Œå®šä¹‰æ–‡ä»¶åˆ‡å‰²åçš„æ–‡ä»¶åï¼Œå¿…é¡»é…åˆdateextä½¿ç”¨ï¼Œåªæ”¯æŒ %Y %m %d %s è¿™å››ä¸ªå‚æ•°size(æˆ–minsize) log-size //å½“æ—¥å¿—æ–‡ä»¶åˆ°è¾¾æŒ‡å®šçš„å¤§å°æ—¶æ‰è½¬å‚¨ï¼Œlog-sizeèƒ½æŒ‡å®šbytes(ç¼ºçœ)åŠKB (sizek)æˆ–MB(sizem).å½“æ—¥å¿—æ–‡ä»¶ >= log-size çš„æ—¶å€™å°±è½¬å‚¨ã€‚ ä»¥ä¸‹ä¸ºåˆæ³•æ ¼å¼ï¼šï¼ˆå…¶ä»–æ ¼å¼çš„å•ä½å¤§å°å†™æ²¡æœ‰è¯•è¿‡ï¼‰size = 5 æˆ– size 5 ï¼ˆ>= 5 ä¸ªå­—èŠ‚å°±è½¬å‚¨ï¼‰size = 100k æˆ– size 100ksize = 100M æˆ– size 100M</code></pre><h2 id="3-NGINXæ—¥å¿—çš„é…ç½®å®ä¾‹å‚è€ƒ"><a href="#3-NGINXæ—¥å¿—çš„é…ç½®å®ä¾‹å‚è€ƒ" class="headerlink" title="3. NGINXæ—¥å¿—çš„é…ç½®å®ä¾‹å‚è€ƒ:"></a>3. NGINXæ—¥å¿—çš„é…ç½®å®ä¾‹å‚è€ƒ:</h2><pre class=" language-shell"><code class="language-shell">vim /etc/logrotate.d/nginx/var/log/weblog/*.log {    daily  //æŒ‡å®šè½¬å‚¨å‘¨æœŸä¸ºæ¯å¤©    compress  //é€šè¿‡gzip å‹ç¼©è½¬å‚¨ä»¥åçš„æ—¥å¿—    rotate 7  //ä¿å­˜7å¤©çš„æ—¥å¿—    missingok  //å¦‚æœæ—¥å¿—æ–‡ä»¶ä¸¢å¤±ï¼Œä¸è¦æ˜¾ç¤ºé”™è¯¯    notifempty  //å½“æ—¥å¿—æ–‡ä»¶ä¸ºç©ºæ—¶ï¼Œä¸è¿›è¡Œè½®è½¬    dateext  //ä½¿ç”¨å½“æœŸæ—¥æœŸä½œä¸ºå‘½åæ ¼å¼ï¼Œexp: nginx_access.log-20190120    sharedscripts  //è¿è¡Œpostrotateè„šæœ¬    postrotate  //æ‰§è¡Œçš„æŒ‡ä»¤            if [ -f /run/nginx.pid ]; then                    kill -USR1 `cat /run/nginx.pid`            fi    endscript  //ç»“æŸæŒ‡ä»¤}</code></pre><h2 id="4-PHP-FPMæ—¥å¿—çš„é…ç½®å®ä¾‹å‚è€ƒ"><a href="#4-PHP-FPMæ—¥å¿—çš„é…ç½®å®ä¾‹å‚è€ƒ" class="headerlink" title="4. PHP-FPMæ—¥å¿—çš„é…ç½®å®ä¾‹å‚è€ƒ:"></a>4. PHP-FPMæ—¥å¿—çš„é…ç½®å®ä¾‹å‚è€ƒ:</h2><pre class=" language-shell"><code class="language-shell">vim /etc/logrotate.d/nginx/usr/local/php/var/log/*.log {dailycompressrotate 7missingoknotifemptydateextsharedscriptspostrotate    if [ -f /usr/local/php/var/run/php-fpm.pid ]; then        kill -USR2 `cat /usr/local/php/var/run/php-fpm.pid`    fiendscript}</code></pre><h2 id="5-Logrotateræ—¥å¿—åˆ‡å‰²è½®è¯¢"><a href="#5-Logrotateræ—¥å¿—åˆ‡å‰²è½®è¯¢" class="headerlink" title="5. Logrotateræ—¥å¿—åˆ‡å‰²è½®è¯¢"></a>5. Logrotateræ—¥å¿—åˆ‡å‰²è½®è¯¢</h2><p>ç”±äºLogrotateæ˜¯åŸºäºCRONè¿è¡Œçš„ï¼Œæ‰€ä»¥è¿™ä¸ªæ—¥å¿—è½®è½¬çš„æ—¶é—´æ˜¯ç”±CRONæ§åˆ¶çš„ï¼Œå…·ä½“å¯ä»¥æŸ¥è¯¢CRONçš„é…ç½®æ–‡ä»¶/etc/anacrontabï¼Œè¿‡å¾€çš„è€ç‰ˆæœ¬çš„æ–‡ä»¶ä¸ºï¼ˆ/etc/crontabï¼‰</p><p>æŸ¥çœ‹è½®è½¬æ–‡ä»¶ï¼š/etc/anacrontab</p><pre class=" language-shell"><code class="language-shell">cat /etc/anacrontab    SHELL=/bin/sh    PATH=/sbin:/bin:/usr/sbin:/usr/bin    MAILTO=root    RANDOM_DELAY=45    START_HOURS_RANGE=3-22    1   5   cron.daily      nice run-parts /etc/cron.daily    7   25  cron.weekly     nice run-parts /etc/cron.weekly    @monthly 45 cron.monthly        nice run-parts /etc/cron.monthly</code></pre><p>ä½¿ç”¨anacrontabè½®è½¬çš„é…ç½®æ–‡ä»¶ï¼Œæ—¥å¿—åˆ‡å‰²çš„ç”Ÿæ•ˆæ—¶é—´æ˜¯åœ¨å‡Œæ™¨3ç‚¹åˆ°22ç‚¹ä¹‹é—´ï¼Œè€Œä¸”éšæœºå»¶è¿Ÿæ—¶é—´æ˜¯45åˆ†é’Ÿï¼Œä½†æ˜¯è¿™æ ·é…ç½®æ— æ³•æ»¡è¶³æˆ‘ä»¬åœ¨ç°å®ä¸­çš„åº”ç”¨</p><p>ç°åœ¨çš„éœ€æ±‚æ˜¯å°†åˆ‡å‰²æ—¶é—´è°ƒæ•´åˆ°æ¯å¤©çš„æ™šä¸Š12ç‚¹ï¼Œå³æ¯å¤©åˆ‡å‰²çš„æ—¥å¿—æ˜¯å‰ä¸€å¤©çš„0-24ç‚¹ä¹‹é—´çš„å†…å®¹ï¼Œæ“ä½œå¦‚ä¸‹ï¼š</p><pre class=" language-shell"><code class="language-shell">mv /etc/anacrontab /etc/anacrontab.bak          //å–æ¶ˆæ—¥å¿—è‡ªåŠ¨è½®è½¬çš„è®¾ç½®</code></pre><p>ä½¿ç”¨crontabæ¥ä½œä¸ºæ—¥å¿—è½®è½¬çš„è§¦å‘å®¹å™¨æ¥ä¿®æ”¹Logrotateé»˜è®¤æ‰§è¡Œæ—¶é—´</p><pre class=" language-shell"><code class="language-shell">vi /etc/crontab SHELL=/bin/bashPATH=/sbin:/bin:/usr/sbin:/usr/binMAILTO=rootHOME=/# run-parts01 * * * * root run-parts /etc/cron.hourly59 23 * * * root run-parts /etc/cron.daily22 4 * * 0 root run-parts /etc/cron.weekly42 4 1 * * root run-parts /etc/cron.monthly</code></pre><h2 id="6-è§£å†³logrotateæ— æ³•è‡ªåŠ¨è½®è¯¢æ—¥å¿—çš„åŠæ³•"><a href="#6-è§£å†³logrotateæ— æ³•è‡ªåŠ¨è½®è¯¢æ—¥å¿—çš„åŠæ³•" class="headerlink" title="6. è§£å†³logrotateæ— æ³•è‡ªåŠ¨è½®è¯¢æ—¥å¿—çš„åŠæ³•"></a>6. è§£å†³logrotateæ— æ³•è‡ªåŠ¨è½®è¯¢æ—¥å¿—çš„åŠæ³•</h2><p>ç°è±¡è¯´æ˜ï¼š</p><p>ä½¿ç”¨logrotateè½®è¯¢nginxæ—¥å¿—ï¼Œé…ç½®å¥½ä¹‹åï¼Œå‘ç°nginxæ—¥å¿—è¿ç»­ä¸¤å¤©æ²¡è¢«åˆ‡å‰²ï¼Œæ£€æŸ¥åç¡®å®šé…ç½®æ–‡ä»¶ä¸€åˆ‡æ­£å¸¸ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿï¼Ÿ</p><p>å¼ºè¡Œå¯åŠ¨è®°å½•æ–‡ä»¶ç»´æŠ¤æ“ä½œï¼Œçºµä½¿logrotateæŒ‡ä»¤è®¤ä¸ºæ²¡æœ‰éœ€è¦ï¼Œåº”è¯¥æœ‰å¯èƒ½æ˜¯logroateè®¤ä¸ºnginxæ—¥å¿—å¤ªå°ï¼Œä¸è¿›è¡Œè½®è¯¢ã€‚<br>æ•…éœ€è¦å¼ºåˆ¶è½®è¯¢ï¼Œå³åœ¨/etc/cron.daily/logrotateè„šæœ¬ä¸­å°† -t å‚æ•°æ›¿æ¢æˆ -f å‚æ•°</p><pre class=" language-shell"><code class="language-shell">vim /etc/cron.daily/logrotate #!/bin/sh/usr/sbin/logrotate /etc/logrotate.confEXITVALUE=$?if [ $EXITVALUE != 0 ]; then    /usr/bin/logger -f logrotate "ALERT exited abnormally with [$EXITVALUE]"fiexit 0</code></pre><p>æœ€åæœ€åé‡å¯ä¸‹cronæœåŠ¡ï¼š</p><pre class=" language-shell"><code class="language-shell">/etc/init.d/crond restartStopping crond: [ OK ]Starting crond: [ OK ]</code></pre>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
