<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>Cyylog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Cyylog">
<meta property="og:url" content="https://github.com/cyylog/page/32/index.html">
<meta property="og:site_name" content="Cyylog">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Cyylog">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Cyylog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 4.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Cyylog</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">有些人是山川是河流，唯独不是可停泊的港口</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://github.com/cyylog"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-Nginx性能优化" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/08/05/Nginx%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" class="article-date">
  <time datetime="2019-08-04T17:55:39.000Z" itemprop="datePublished">2019-08-05</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Linux/">Linux</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/08/05/Nginx%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/">Nginx性能优化</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <a id="more"></a>



<p><img src="https://p6-tt.byteimg.com/large/pgc-image/95d788eda3ed45b58b6e982192a7a650" alt="img"></p>
<p>当我需要进行性能优化时，说明我们服务器无法满足日益增长的业务。性能优化是一个比较大的课题，需要从以下几个方面进行探讨</p>
<ul>
<li>当前系统结构瓶颈</li>
<li>了解业务模式</li>
<li>性能与安全</li>
</ul>
<h4 id="1、当前系统结构瓶颈"><a href="#1、当前系统结构瓶颈" class="headerlink" title="1、当前系统结构瓶颈"></a>1、当前系统结构瓶颈</h4><p>首先需要了解的是当前系统瓶颈，用的是什么，跑的是什么业务。里面的服务是什么样子，每个服务最大支持多少并发。比如针对nginx而言，我们处理静态资源效率最高的瓶颈是多大？能支持多少qps访问请求？怎么得出系统当前的结构瓶颈？</p>
<p>可以通过查看当前cpu负荷，内存使用率，进程使用率来做简单判断。还可以通过操作系统的一些工具来判断当前系统性能瓶颈，如分析对应的日志，查看请求数量。也可以通过nginx http_stub_status_module模块来查看对应的连接数，总握手次数，总请求数。也可以对线上进行压力测试，来了解当前的系统能性能，并发数，做好性能评估。</p>
<h4 id="2、了解业务模式"><a href="#2、了解业务模式" class="headerlink" title="2、了解业务模式"></a>2、了解业务模式</h4><p>虽然我们是在做性能优化，但还是要熟悉业务，最终目的都是为业务服务的。我们要了解每一个接口业务类型是什么样的业务，比如电子商务抢购模式，这种情况平时流量会很小，但是到了抢购时间，流量一下子就会猛涨。也要了解系统层级结构，每一层在中间层做的是代理还是动静分离，还是后台进行直接服务。需要我们对业务接入层和系统层次要有一个梳理</p>
<h4 id="3、性能与安全"><a href="#3、性能与安全" class="headerlink" title="3、性能与安全"></a>3、性能与安全</h4><p>性能与安全也是一个需要考虑的因素，往往大家注重性能忽略安全或注重安全又忽略性能。比如说我们在设计防火墙时，如果规则过于全面肯定会对性能方面有影响。如果对性能过于注重在安全方面肯定会留下很大隐患。所以大家要评估好两者的关系，把握好两者的孰重孰轻，以及整体的相关性。权衡好对应的点。</p>
<h4 id="4、系统与nginx性能优化"><a href="#4、系统与nginx性能优化" class="headerlink" title="4、系统与nginx性能优化"></a>4、系统与nginx性能优化</h4><p>大家对相关的系统瓶颈及现状有了一定的了解之后，就可以根据影响性能方面做一个全体的评估和优化。</p>
<ul>
<li>网络（网络流量、是否有丢包，网络的稳定性都会影响用户请求）</li>
<li>系统（系统负载、饱和、内存使用率、系统的稳定性、硬件磁盘是否有损坏）</li>
<li>服务（连接优化、内核性能优化、http服务请求优化都可以在nginx中根据业务来进行设置）</li>
<li>程序（接口性能、处理请求速度、每个程序的执行效率）</li>
<li>数据库、底层服务</li>
</ul>
<p>上面列举出来每一级都会有关联，也会影响整体性能，这里主要关注的是nginx服务这一层。</p>
<h5 id="1、文件句柄"><a href="#1、文件句柄" class="headerlink" title="1、文件句柄"></a>1、文件句柄</h5><p>在linux/unix操作系统中一切皆文件，我们的设备是文件，文件是文件，文件夹也是文件。当我们用户每发起一次请求，就会产生一个文件句柄。文件句柄可以简单的理解为文件句柄就是一个索引。文件句柄就会随着请求量的增多,进程调用频繁增加，那么产生的文件句柄也就会越多。</p>
<p>系统默认对文件句柄是有限制的，不可能会让一个进程无限制的调用句柄。因为系统资源是有限的，所以我们需要限制每一个服务能够使用多大的文件句柄。操作系统默认使用的文件句柄是1024个句柄。</p>
<h5 id="2、设置方式"><a href="#2、设置方式" class="headerlink" title="2、设置方式"></a>2、设置方式</h5><ul>
<li>系统全局性修改</li>
<li>用户局部性修改</li>
<li>进程局部性修改</li>
</ul>
<h5 id="3、系统全局性修该和用户局部性修改"><a href="#3、系统全局性修该和用户局部性修改" class="headerlink" title="3、系统全局性修该和用户局部性修改"></a>3、系统全局性修该和用户局部性修改</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]#vim &#x2F;etc&#x2F;security&#x2F;limits.conf</span><br></pre></td></tr></table></figure>

<p>在文件最下面找到</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#*               soft    core            0</span><br><span class="line">#*               hard    rss             10000</span><br><span class="line">#@student        hard    nproc           20</span><br><span class="line">#@faculty        soft    nproc           20</span><br><span class="line">#@faculty        hard    nproc           50</span><br><span class="line">#ftp             hard    nproc           0</span><br><span class="line">#@student        -       maxlogins       4</span><br><span class="line"></span><br><span class="line">#root只是针对root这个用户来限制，soft只是发提醒，操作系统不会强制限制,一般的站点设置为一万左右就ok了</span><br><span class="line">root soft nofile 65535</span><br><span class="line">root hard nofile 65535</span><br><span class="line"># *代表通配符 所有的用户</span><br><span class="line">*    soft nofile 25535</span><br><span class="line">*    hard nofile 25535</span><br></pre></td></tr></table></figure>

<p>可以看到root和<em>，root代表是root用户，</em>代表的是所有用户，后面的数字就是文件句柄大小。大家可以根据个人业务来进行设置。</p>
<h5 id="4、进程局部性修改"><a href="#4、进程局部性修改" class="headerlink" title="4、进程局部性修改"></a>4、进程局部性修改</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]#vim &#x2F;etc&#x2F;nginx&#x2F;nginx.conf</span><br><span class="line">user  nginx;</span><br><span class="line">worker_processes  1;  </span><br><span class="line"></span><br><span class="line">error_log  &#x2F;var&#x2F;log&#x2F;nginx&#x2F;error.log warn;</span><br><span class="line">pid        &#x2F;var&#x2F;run&#x2F;nginx.pid;</span><br><span class="line"></span><br><span class="line">worker_rlimit_nofile 65535; #进程限制</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include       &#x2F;etc&#x2F;nginx&#x2F;mime.types;</span><br><span class="line">    default_type  application&#x2F;octet-stream;</span><br><span class="line"></span><br><span class="line">    log_format  main  &#39;$http_user_agent&#39; &#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39;</span><br><span class="line">                      &#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;</span><br><span class="line">                      &#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot; &#39;</span><br><span class="line">                      &#39;&quot;$args&quot; &quot;$request_uri&quot;&#39;;</span><br><span class="line"></span><br><span class="line">    access_log  &#x2F;var&#x2F;log&#x2F;nginx&#x2F;access.log  main;</span><br><span class="line"></span><br><span class="line">    sendfile        on; </span><br><span class="line">    #tcp_nopush     on; </span><br><span class="line"></span><br><span class="line">    keepalive_timeout  65; </span><br><span class="line"></span><br><span class="line">    #gzip  on; </span><br><span class="line"></span><br><span class="line">    include &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;*.conf;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>worker_rlimit_nofile 是在进程上面进行限制。</p>
<h5 id="5、cpu的亲和配置"><a href="#5、cpu的亲和配置" class="headerlink" title="5、cpu的亲和配置"></a>5、cpu的亲和配置</h5><p>cpu的亲和能够使nginx对于不同的work工作进程绑定到不同的cpu上面去。就能够减少在work间不断切换cpu，把进程通常不会在处理器之间频繁迁移，进程迁移的频率小，来减少性能损耗。nginx 亲和配置</p>
<p>查看物理cpu</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]#cat &#x2F;proc&#x2F;cpuinfo|grep &quot;physical id&quot;|sort |uniq|wc -l</span><br></pre></td></tr></table></figure>

<p>查看cpu核心数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]#cat &#x2F;proc&#x2F;cpuinfo|grep &quot;cpu cores&quot;|uniq</span><br></pre></td></tr></table></figure>

<p>查看cpu使用率</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]#top  回车后按 1</span><br></pre></td></tr></table></figure>

<h5 id="6、配置worker-processes"><a href="#6、配置worker-processes" class="headerlink" title="6、配置worker_processes"></a>6、配置worker_processes</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]#vim &#x2F;etc&#x2F;nginx&#x2F;nginx.conf</span><br></pre></td></tr></table></figure>

<p>将刚才查看到自己cpu * cpu核心就是worker_processes</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">worker_processes 2; #根据自己cpu核心数配置</span><br></pre></td></tr></table></figure>

<h5 id="7、cpu亲和配置"><a href="#7、cpu亲和配置" class="headerlink" title="7、cpu亲和配置"></a>7、cpu亲和配置</h5><p>假如小菜的配置是2cpu，每个cpu是8核。配置如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">worker_processes 16;</span><br><span class="line">worker_cpu_affinity 1010101010101010 0101010101010101;</span><br></pre></td></tr></table></figure>

<p>配置完成后可以通过下面命令查看nginx进程配置在哪个核上</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]#ps -eo pid,args,psr |grep [n]ginx</span><br></pre></td></tr></table></figure>

<p>在nginx 1.9版本之后，就帮我们自动绑定了cpu;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">worker_cpu_affinity auto;</span><br></pre></td></tr></table></figure>

<h4 id="5、nginx通用配置优化"><a href="#5、nginx通用配置优化" class="headerlink" title="5、nginx通用配置优化"></a>5、nginx通用配置优化</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]#vim &#x2F;etc&#x2F;nginx&#x2F;nginx.conf</span><br><span class="line">#将nginx进程设置为普通用户，为了安全考虑</span><br><span class="line">user nginx; </span><br><span class="line"></span><br><span class="line">#当前启动的worker进程，官方建议是与系统核心数一直</span><br><span class="line">worker_processes 2;</span><br><span class="line">#方式一， 第一个work进程绑定第一个cpu核心，第二个work进程绑定到第二个cpu核心，依次内推 直到弟16个</span><br><span class="line">#wokrer_cpu_affinity 0000000000000000 0000000000000001 0000000000000010 0000000000000100 ... 1000000000000000</span><br><span class="line"></span><br><span class="line">#方式二，当 worker_processes 2 时，表明 第一work进程可以绑定第 2 4 6 8 10 12 14 16 核心，那么第二work进程就绑定 奇数核心</span><br><span class="line">#worker_cpu_affinity 1010101010101010 0101010101010101;</span><br><span class="line"></span><br><span class="line">#方式三，就是自动分配绑定</span><br><span class="line">worker_cpu_affinity auto;</span><br><span class="line"></span><br><span class="line">#日志配置成warn</span><br><span class="line">error_log &#x2F;var&#x2F;log&#x2F;nginx&#x2F;error.log warn; </span><br><span class="line">pid &#x2F;var&#x2F;run&#x2F;nginx.pid;</span><br><span class="line"></span><br><span class="line">#针对 nginx 句柄的文件限制</span><br><span class="line">worker_rlimit_nofile 35535;</span><br><span class="line">#事件模型</span><br><span class="line">events &#123;</span><br><span class="line">    #使用epoll内核模型</span><br><span class="line">    user epoll;</span><br><span class="line">    #每一个进程可以处理多少个连接，如果是多核可以将连接数调高 worker_processes * 1024</span><br><span class="line">    worker_connections 10240;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include       &#x2F;etc&#x2F;nginx&#x2F;mime.types;</span><br><span class="line">    default_type  application&#x2F;octet-stream;</span><br><span class="line"></span><br><span class="line">    charset utf-8;  #设置字符集</span><br><span class="line"></span><br><span class="line">    #设置日志输出格式，根据自己的情况设置</span><br><span class="line">    log_format  main  &#39;$http_user_agent&#39; &#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39;</span><br><span class="line">                      &#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;</span><br><span class="line">                      &#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot; &#39;</span><br><span class="line">                      &#39;&quot;$args&quot; &quot;$request_uri&quot;&#39;;</span><br><span class="line"></span><br><span class="line">    access_log  &#x2F;var&#x2F;log&#x2F;nginx&#x2F;access.log  main;</span><br><span class="line"></span><br><span class="line">    sendfile        on;   #对静态资源的处理比较有效</span><br><span class="line">    #tcp_nopush     on;   #如果做静态资源服务器可以打开</span><br><span class="line">    #tcp_nodeny     on;   #当nginx做动态的服务时可以选择打开</span><br><span class="line"></span><br><span class="line">    keepalive_timeout  65; </span><br><span class="line"></span><br><span class="line">    ########</span><br><span class="line">    #Gzip module</span><br><span class="line">    gzip  on;    #文件压缩默认可以打开</span><br><span class="line">    gzip_disable &quot;MSIE [1-6]\.&quot;; #对于有些浏览器不能识别压缩，需要过滤如ie6</span><br><span class="line">    gzip_http_version 1.1;</span><br><span class="line"></span><br><span class="line">    include &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;*.conf;</span><br><span class="line">&#125;</span><br><span class="line">#查看 核心绑定的nginx work进程</span><br><span class="line">[root@server ~]#ps -eo pid,args,psr | grep [n]ginx</span><br></pre></td></tr></table></figure>

<h4 id="6、ab接口压力测试工具"><a href="#6、ab接口压力测试工具" class="headerlink" title="6、ab接口压力测试工具"></a>6、ab接口压力测试工具</h4><p>ab是Apache超文本传输协议(HTTP)的性能测试工具。其设计意图是描绘当前所安装的Apache的执行性能，主要是显示你安装的Apache每秒可以处理多少个请求。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 安装工具</span><br><span class="line">[root@server ~]#yum install httpd-tools</span><br><span class="line"></span><br><span class="line"># 使用</span><br><span class="line">[root@server ~]#ab -n 2000 -c 2 http:&#x2F;&#x2F;127.0.0.1&#x2F;index.html</span><br><span class="line">-n 总的请求数</span><br><span class="line">-c 并发数</span><br><span class="line">-k 是否开启长连接</span><br></pre></td></tr></table></figure>

<h5 id="1、参数选项"><a href="#1、参数选项" class="headerlink" title="1、参数选项"></a>1、参数选项</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">-n：即requests，用于指定压力测试总共的执行次数</span><br><span class="line">-c：即concurrency，用于指定的并发数</span><br><span class="line">-t：即timelimit，等待响应的最大时间(单位：秒)</span><br><span class="line">-b：即windowsize，TCP发送&#x2F;接收的缓冲大小(单位：字节)</span><br><span class="line">-p：即postfile，发送POST请求时需要上传的文件，此外还必须设置-T参数</span><br><span class="line">-u：即putfile，发送PUT请求时需要上传的文件，此外还必须设置-T参数</span><br><span class="line">-T：即content-type，用于设置Content-Type请求头信息，例如：application&#x2F;x-www-form-urlencoded，默认值为text&#x2F;plain</span><br><span class="line">-v：即verbosity，指定打印帮助信息的冗余级别</span><br><span class="line">-w：以HTML表格形式打印结果</span><br><span class="line">-i：使用HEAD请求代替GET请求</span><br><span class="line">-x：插入字符串作为table标签的属性</span><br><span class="line">-y：插入字符串作为tr标签的属性</span><br><span class="line">-z：插入字符串作为td标签的属性</span><br><span class="line">-C：添加cookie信息，例如：&quot;Apache&#x3D;1234&quot;(可以重复该参数选项以添加多个)</span><br><span class="line">-H：添加任意的请求头，例如：&quot;Accept-Encoding: gzip&quot;，请求头将会添加在现有的多个请求头之后(可以重复该参数选项以添加多个)</span><br><span class="line">-A：添加一个基本的网络认证信息，用户名和密码之间用英文冒号隔开</span><br><span class="line">-P：添加一个基本的代理认证信息，用户名和密码之间用英文冒号隔开</span><br><span class="line">-X：指定使用的和端口号，例如:&quot;126.10.10.3:88&quot;</span><br><span class="line">-V：打印版本号并退出</span><br><span class="line">-k：使用HTTP的KeepAlive特性</span><br><span class="line">-d：不显示百分比</span><br><span class="line">-S：不显示预估和警告信息</span><br><span class="line">-g：输出结果信息到gnuplot格式的文件中</span><br><span class="line">-e：输出结果信息到CSV格式的文件中</span><br><span class="line">-r：指定接收到错误信息时不退出程序</span><br><span class="line">-H：显示用法信息，其实就是ab -help</span><br></pre></td></tr></table></figure>

<h5 id="2、内容解释"><a href="#2、内容解释" class="headerlink" title="2、内容解释"></a>2、内容解释</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">Server Software:        nginx&#x2F;1.10.2 (服务器软件名称及版本信息)</span><br><span class="line">Server Hostname:        192.168.1.106(服务器主机名)</span><br><span class="line">Server Port:            80 (服务器端口)</span><br><span class="line">Document Path:          &#x2F;index1.html. (供测试的URL路径)</span><br><span class="line">Document Length:        3721 bytes (供测试的URL返回的文档大小)</span><br><span class="line">Concurrency Level:      1000 (并发数)</span><br><span class="line">Time taken for tests:   2.327 seconds (压力测试消耗的总时间)</span><br><span class="line">Complete requests:      5000 (的总次数)</span><br><span class="line">Failed requests:        688 (失败的请求数)</span><br><span class="line">Write errors:           0 (网络连接写入错误数)</span><br><span class="line">Total transferred:      17402975 bytes (传输的总数据量)</span><br><span class="line">HTML transferred:       16275725 bytes (HTML文档的总数据量)</span><br><span class="line">Requests per second:    2148.98 [#&#x2F;sec] (mean) (平均每秒的请求数) 这个是非常重要的参数数值，服务器的吞吐量 </span><br><span class="line">Time per request:       465.338 [ms] (mean) (所有并发用户(这里是1000)都请求一次的平均时间)</span><br><span class="line">Time  request:          0.247 [ms] (mean, across all concurrent requests) (单个用户请求一次的平均时间)</span><br><span class="line">Transfer rate:          7304.41 [Kbytes&#x2F;sec] received 每秒获取的数据长度 (传输速率，单位：KB&#x2F;s)</span><br><span class="line">...</span><br><span class="line">Percentage of the requests served within a certain time (ms)</span><br><span class="line">  50%    347  ## 50%的请求在347ms内返回 </span><br><span class="line">  66%    401  ## 60%的请求在401ms内返回 </span><br><span class="line">  75%    431</span><br><span class="line">  80%    516</span><br><span class="line">  90%    600</span><br><span class="line">  95%    846</span><br><span class="line">  98%   1571</span><br><span class="line">  99%   1593</span><br><span class="line"> 100%   1619 (longest request)</span><br></pre></td></tr></table></figure>

<h5 id="3、示例演示"><a href="#3、示例演示" class="headerlink" title="3、示例演示"></a>3、示例演示</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]#ab -n 50 -c 20 http:&#x2F;&#x2F;walidream.com&#x2F;sub_module</span><br></pre></td></tr></table></figure>

<p>输出内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">Server Software:        nginx&#x2F;1.14.1</span><br><span class="line">Server Hostname:        walidream.com</span><br><span class="line">Server Port:            80</span><br><span class="line"></span><br><span class="line">Document Path:          &#x2F;sub_module</span><br><span class="line">Document Length:        169 bytes</span><br><span class="line"></span><br><span class="line">Concurrency Level:      20</span><br><span class="line">Time taken for tests:   0.005 seconds</span><br><span class="line">Complete requests:      50</span><br><span class="line">Failed requests:        0</span><br><span class="line">Write errors:           0</span><br><span class="line">Non-2xx responses:      50</span><br><span class="line">Total transferred:      14900 bytes</span><br><span class="line">HTML transferred:       8450 bytes</span><br><span class="line">Requests per second:    9746.59 [#&#x2F;sec] (mean)</span><br><span class="line">Time per request:       2.052 [ms] (mean)</span><br><span class="line">Time per request:       0.103 [ms] (mean, across all concurrent requests)</span><br><span class="line">Transfer rate:          2836.41 [Kbytes&#x2F;sec] received</span><br><span class="line"></span><br><span class="line">Connection Times (ms)</span><br><span class="line">              min  mean[+&#x2F;-sd] median   max</span><br><span class="line">Connect:        0    0   0.1      0       1</span><br><span class="line">Processing:     1    1   0.3      1       2</span><br><span class="line">Waiting:        0    1   0.2      1       1</span><br><span class="line">Total:          1    2   0.3      2       2</span><br><span class="line"></span><br><span class="line">Percentage of the requests served within a certain time (ms)</span><br><span class="line">  50%      2</span><br><span class="line">  66%      2</span><br><span class="line">  75%      2</span><br><span class="line">  80%      2</span><br><span class="line">  90%      2</span><br><span class="line">  95%      2</span><br><span class="line">  98%      2</span><br><span class="line">  99%      2</span><br><span class="line"> 100%      2 (longest request)</span><br></pre></td></tr></table></figure>

<h5 id="5、注意事项"><a href="#5、注意事项" class="headerlink" title="5、注意事项"></a>5、注意事项</h5><p>● 测试机与被测试机要分开</p>
<p>● 不要对线上的服务器做压力测试</p>
<p>● 观察测试工具ab所在机器，以及被测试的前端机的CPU、内存、网络等都不超过最高限度的75%</p>
<h5 id="6、ab性能指标"><a href="#6、ab性能指标" class="headerlink" title="6、ab性能指标"></a>6、ab性能指标</h5><h6 id="1、吞吐率（Requests-per-second）"><a href="#1、吞吐率（Requests-per-second）" class="headerlink" title="1、吞吐率（Requests per second）"></a>1、吞吐率（Requests per second）</h6><p>服务器并发处理能力的量化描述，单位是reqs/s，指的是在某个并发用户数下单位时间内处理的请求数。某个并发用户数下单位时间内能处理的最大请求数，称之为最大吞吐率。记住：吞吐率是基于并发用户数的。这句话代表了两个含义：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">● 吞吐率和并发用户数相关</span><br><span class="line"></span><br><span class="line">● 不同的并发用户数下，吞吐率一般是不同的</span><br></pre></td></tr></table></figure>

<p>计算公式：总请求数/处理完成这些请求数所花费的时间，即</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Request per second&#x3D;Complete requests&#x2F;Time taken for tests</span><br></pre></td></tr></table></figure>

<p>必须要说明的是，这个数值表示当前机器的整体性能，值越大越好</p>
<h6 id="2、并发连接数（The-number-of-concurrent-connections）"><a href="#2、并发连接数（The-number-of-concurrent-connections）" class="headerlink" title="2、并发连接数（The number of concurrent connections）"></a>2、并发连接数（The number of concurrent connections）</h6><p>并发连接数指的是某个时刻服务器所接受的请求数目，简单的讲，就是一个会话。</p>
<h6 id="3、并发用户数（Concurrency-Level）"><a href="#3、并发用户数（Concurrency-Level）" class="headerlink" title="3、并发用户数（Concurrency Level）"></a>3、并发用户数（Concurrency Level）</h6><p>要注意区分这个概念和并发连接数之间的区别，一个用户可能同时会产生多个会话，也即连接数。在HTTP/1.1下，IE7支持两个并发连接，IE8支持6个并发连接，FireFox3支持4个并发连接，所以相应的，我们的并发用户数就得除以这个基数。</p>
<h6 id="4-用户平均请求等待时间（Time-per-request）"><a href="#4-用户平均请求等待时间（Time-per-request）" class="headerlink" title="4.用户平均请求等待时间（Time per request）"></a>4.用户平均请求等待时间（Time per request）</h6><p>计算公式：处理完成所有请求数所花费的时间/（总请求数/并发用户数），即：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Time per request&#x3D;Time taken for tests&#x2F;（Complete requests&#x2F;Concurrency Level）</span><br></pre></td></tr></table></figure>

<h6 id="5-服务器平均请求等待时间（Time-per-request-across-all-concurrent-requests）"><a href="#5-服务器平均请求等待时间（Time-per-request-across-all-concurrent-requests）" class="headerlink" title="5.服务器平均请求等待时间（Time per request:across all concurrent requests）"></a>5.服务器平均请求等待时间（Time per request:across all concurrent requests）</h6><p>计算公式：处理完成所有请求数所花费的时间/总请求数，即：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Time taken for&#x2F;testsComplete requests</span><br></pre></td></tr></table></figure>

<p>可以看到，它是吞吐率的倒数。同时，它也等于用户平均请求等待时间/并发用户数，即</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Time per request&#x2F;Concurrency Level</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://github.com/cyylog/2019/08/05/Nginx%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" data-id="ckco9xsbc0015bwuvbldjbypk" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Nginx/" rel="tag">Nginx</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/31/">&amp;laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/30/">30</a><a class="page-number" href="/page/31/">31</a><span class="page-number current">32</span><a class="page-number" href="/page/33/">33</a><a class="page-number" href="/page/34/">34</a><span class="space">&hellip;</span><a class="page-number" href="/page/46/">46</a><a class="extend next" rel="next" href="/page/33/">Next &amp;raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/DevOps/">DevOps</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Interview/">Interview</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/SQL/">SQL</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%AE%B9%E5%99%A8/">容器</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%9B%91%E6%8E%A7/">监控</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Docker/" rel="tag">Docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Gitlab/" rel="tag">Gitlab</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Go/" rel="tag">Go</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Jenkins/" rel="tag">Jenkins</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Kubernetes/" rel="tag">Kubernetes</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/" rel="tag">Linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MySQL/" rel="tag">MySQL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Network/" rel="tag">Network</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Nginx/" rel="tag">Nginx</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Oracle/" rel="tag">Oracle</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Prometheus/" rel="tag">Prometheus</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Python/" rel="tag">Python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RabbitMQ/" rel="tag">RabbitMQ</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Redis/" rel="tag">Redis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/System/" rel="tag">System</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Tomcat/" rel="tag">Tomcat</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Tools/" rel="tag">Tools</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/iptables/" rel="tag">iptables</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kafka/" rel="tag">kafka</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/zabbix/" rel="tag">zabbix</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Docker/" style="font-size: 20px;">Docker</a> <a href="/tags/Gitlab/" style="font-size: 10px;">Gitlab</a> <a href="/tags/Go/" style="font-size: 10px;">Go</a> <a href="/tags/Jenkins/" style="font-size: 12.5px;">Jenkins</a> <a href="/tags/Kubernetes/" style="font-size: 17.5px;">Kubernetes</a> <a href="/tags/Linux/" style="font-size: 20px;">Linux</a> <a href="/tags/MySQL/" style="font-size: 15px;">MySQL</a> <a href="/tags/Network/" style="font-size: 10px;">Network</a> <a href="/tags/Nginx/" style="font-size: 15px;">Nginx</a> <a href="/tags/Oracle/" style="font-size: 12.5px;">Oracle</a> <a href="/tags/Prometheus/" style="font-size: 10px;">Prometheus</a> <a href="/tags/Python/" style="font-size: 10px;">Python</a> <a href="/tags/RabbitMQ/" style="font-size: 10px;">RabbitMQ</a> <a href="/tags/Redis/" style="font-size: 10px;">Redis</a> <a href="/tags/System/" style="font-size: 10px;">System</a> <a href="/tags/Tomcat/" style="font-size: 20px;">Tomcat</a> <a href="/tags/Tools/" style="font-size: 12.5px;">Tools</a> <a href="/tags/iptables/" style="font-size: 10px;">iptables</a> <a href="/tags/kafka/" style="font-size: 12.5px;">kafka</a> <a href="/tags/zabbix/" style="font-size: 17.5px;">zabbix</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/9999/11/">November 9999</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/9999/10/">October 9999</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/9999/09/">September 9999</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">August 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">July 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">June 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">May 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">February 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">September 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">June 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/9999/11/01/Interview_MySQL_001/">Interview MySQL_001</a>
          </li>
        
          <li>
            <a href="/9999/10/01/Interview_Network_001/">Interview Network_001</a>
          </li>
        
          <li>
            <a href="/9999/09/01/Interview_System_001/">Interview System_001</a>
          </li>
        
          <li>
            <a href="/2020/08/05/Interview_Go_001/">Interview Go_001</a>
          </li>
        
          <li>
            <a href="/2020/07/16/Mysql%E6%B8%B8%E6%A0%87/">Mysql 游标</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 Cyylog<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>