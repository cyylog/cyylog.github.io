<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>ansible | Cyylog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="自动化运维工具—ansible详解一、ansible 简介1、ansible 是什么？　　ansible是目前最受运维欢迎的自动化运维工具，基于Python开发，集合了众多运维工具（SaltStack puppet、chef、func、fabric）的优点，实现了批量系统配置、批量程序部署、批量运行命令等功能。 　　ansible是基于 paramiko 开发的,并且基于模块化工作，本身没有批">
<meta property="og:type" content="article">
<meta property="og:title" content="ansible">
<meta property="og:url" content="https://github.com/cyylog/2019/04/16/Linux/ansible/index.html">
<meta property="og:site_name" content="Cyylog">
<meta property="og:description" content="自动化运维工具—ansible详解一、ansible 简介1、ansible 是什么？　　ansible是目前最受运维欢迎的自动化运维工具，基于Python开发，集合了众多运维工具（SaltStack puppet、chef、func、fabric）的优点，实现了批量系统配置、批量程序部署、批量运行命令等功能。 　　ansible是基于 paramiko 开发的,并且基于模块化工作，本身没有批">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://s1.ax1x.com/2020/04/17/JEZyQO.png">
<meta property="og:image" content="https://s1.ax1x.com/2020/04/17/JEZ2eH.png">
<meta property="og:image" content="https://s1.ax1x.com/2020/04/16/JEZEz8.png">
<meta property="og:image" content="https://s1.ax1x.com/2020/04/16/JEZmLQ.png">
<meta property="og:image" content="https://s1.ax1x.com/2020/04/16/JEZKds.png">
<meta property="og:image" content="https://s1.ax1x.com/2020/04/16/JEZMon.png">
<meta property="og:image" content="https://s1.ax1x.com/2020/04/16/JEZtL4.png">
<meta property="article:published_time" content="2019-04-16T15:50:14.000Z">
<meta property="article:modified_time" content="2020-05-25T13:53:31.482Z">
<meta property="article:author" content="Cyylog">
<meta property="article:tag" content="Tools">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s1.ax1x.com/2020/04/17/JEZyQO.png">
  
    <link rel="alternate" href="/atom.xml" title="Cyylog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 4.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Cyylog</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">有些人是山川是河流，唯独不是可停泊的港口</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://github.com/cyylog"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-Linux/ansible" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/04/16/Linux/ansible/" class="article-date">
  <time datetime="2019-04-16T15:50:14.000Z" itemprop="datePublished">2019-04-16</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Linux/">Linux</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      ansible
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <a id="more"></a>

<h1 id="自动化运维工具—ansible详解"><a href="#自动化运维工具—ansible详解" class="headerlink" title="自动化运维工具—ansible详解"></a>自动化运维工具—ansible详解</h1><h2 id="一、ansible-简介"><a href="#一、ansible-简介" class="headerlink" title="一、ansible 简介"></a>一、ansible 简介</h2><h3 id="1、ansible-是什么？"><a href="#1、ansible-是什么？" class="headerlink" title="1、ansible 是什么？"></a>1、ansible 是什么？</h3><p>　　ansible是目前最受运维欢迎的自动化运维工具，基于Python开发，集合了众多运维工具（SaltStack puppet、chef、func、fabric）的优点，实现了批量系统配置、批量程序部署、批量运行命令等功能。<br> 　　ansible是基于 paramiko 开发的,并且基于模块化工作，本身没有批量部署的能力。真正具有批量部署的是ansible所运行的模块，ansible只是提供一种框架。ansible不需要在远程主机上安装client/agents，因为它们是基于ssh来和远程主机通讯的。ansible目前已经已经被红帽官方收购，是自动化运维工具中大家认可度最高的，并且上手容易，学习简单。是每位运维工程师必须掌握的技能之一。</p>
<h3 id="2、ansible-特点"><a href="#2、ansible-特点" class="headerlink" title="2、ansible 特点"></a>2、ansible 特点</h3><ol>
<li>部署简单，只需在主控端部署Ansible环境，被控端无需做任何操作；</li>
<li>默认使用SSH协议对设备进行管理；</li>
<li>有大量常规运维操作模块，可实现日常绝大部分操作；</li>
<li>配置简单、功能强大、扩展性强；</li>
<li>支持API及自定义模块，可通过Python轻松扩展；</li>
<li>通过Playbooks来定制强大的配置、状态管理；</li>
<li>轻量级，无需在客户端安装agent，更新时，只需在操作机上进行一次更新即可；</li>
<li>提供一个功能强大、操作性强的Web管理界面和REST API接口——AWX平台。</li>
</ol>
<h3 id="3、ansible-架构图"><a href="#3、ansible-架构图" class="headerlink" title="3、ansible 架构图"></a>3、ansible 架构图</h3><p><img src="https://s1.ax1x.com/2020/04/17/JEZyQO.png" alt="JEZyQO.png"></p>
<blockquote>
<p><code>Ansible</code>：Ansible核心程序。<br><code>HostInventory</code>：记录由Ansible管理的主机信息，包括端口、密码、ip等。<br><code>Playbooks</code>：“剧本”YAML格式文件，多个任务定义在一个文件中，定义主机需要调用哪些模块来完成的功能。<br><code>CoreModules</code>：<strong>核心模块</strong>，主要操作是通过调用核心模块来完成管理任务。<br><code>CustomModules</code>：自定义模块，完成核心模块无法完成的功能，支持多种语言。<br><code>ConnectionPlugins</code>：连接插件，Ansible和Host通信使用</p>
</blockquote>
<h2 id="二、ansible-任务执行"><a href="#二、ansible-任务执行" class="headerlink" title="二、ansible 任务执行"></a>二、ansible 任务执行</h2><h3 id="1、ansible-任务执行模式"><a href="#1、ansible-任务执行模式" class="headerlink" title="1、ansible 任务执行模式"></a>1、ansible 任务执行模式</h3><p>　　Ansible 系统由控制主机对被管节点的操作方式可分为两类，即<code>ad-hoc</code>和<code>playbook</code>：</p>
<ul>
<li>ad-hoc模式(点对点模式)<br>使用单个模块，支持批量执行单条命令。ad-hoc 命令是一种可以快速输入的命令，而且不需要保存起来的命令。<strong>就相当于bash中的一句话shell。</strong></li>
<li>playbook模式(剧本模式)<br>是Ansible主要管理方式，也是Ansible功能强大的关键所在。<strong>playbook通过多个task集合完成一类功能</strong>，如Web服务的安装部署、数据库服务器的批量备份等。可以简单地把playbook理解为通过组合多条ad-hoc操作的配置文件。</li>
</ul>
<h3 id="2、ansible-执行流程"><a href="#2、ansible-执行流程" class="headerlink" title="2、ansible 执行流程"></a>2、ansible 执行流程</h3><p> 　　简单理解就是Ansible在运行时， 首先读取<code>ansible.cfg</code>中的配置， 根据规则获取<code>Inventory</code>中的管理主机列表， 并行的在这些主机中执行配置的任务， 最后等待执行返回的结果。</p>
<h3 id="3、ansible-命令执行过程"><a href="#3、ansible-命令执行过程" class="headerlink" title="3、ansible 命令执行过程"></a>3、ansible 命令执行过程</h3><p><img src="https://s1.ax1x.com/2020/04/17/JEZ2eH.png" alt="JEZ2eH.png"></p>
<ol>
<li>加载自己的配置文件，默认<code>/etc/ansible/ansible.cfg</code>；</li>
<li>查找对应的主机配置文件，找到要执行的主机或者组；</li>
<li>加载自己对应的模块文件，如 command；</li>
<li>通过ansible将模块或命令生成对应的临时py文件(python脚本)， 并将该文件传输至远程服务器；</li>
<li>对应执行用户的家目录的<code>.ansible/tmp/XXX/XXX.PY</code>文件；</li>
<li>给文件 +x 执行权限；</li>
<li>执行并返回结果；</li>
<li>删除临时py文件，<code>sleep 0</code>退出；</li>
</ol>
<h2 id="三、ansible-配置详解"><a href="#三、ansible-配置详解" class="headerlink" title="三、ansible 配置详解"></a>三、ansible 配置详解</h2><h3 id="1、ansible-安装方式"><a href="#1、ansible-安装方式" class="headerlink" title="1、ansible 安装方式"></a>1、ansible 安装方式</h3><p>　　ansible安装常用两种方式，<code>yum 安装</code> 和 <code>pip 程序安装</code>。下面我们来详细介绍一下这两种安装方式。</p>
<h3 id="2、使用-pip（python的包管理模块）安装"><a href="#2、使用-pip（python的包管理模块）安装" class="headerlink" title="2、使用 pip（python的包管理模块）安装"></a>2、使用 pip（python的包管理模块）安装</h3><p>　　首先，我们需要安装一个<code>python-pip</code>包，安装完成以后，则直接使用<code>pip</code>命令来安装我们的包，具体操作过程如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum install python-pip</span><br><span class="line">pip install ansible</span><br></pre></td></tr></table></figure>

<h3 id="4、使用-yum-安装"><a href="#4、使用-yum-安装" class="headerlink" title="4、使用 yum 安装"></a>4、使用 yum 安装</h3><p>　　yum 安装是我们很熟悉的安装方式了。我们需要先安装一个<code>epel-release</code>包，然后再安装我们的 ansible 即可。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum install epel-release -y</span><br><span class="line">yum install ansible –y</span><br></pre></td></tr></table></figure>

<h3 id="5、ansible-程序结构"><a href="#5、ansible-程序结构" class="headerlink" title="5、ansible 程序结构"></a>5、ansible 程序结构</h3><p>安装目录如下(yum安装)：<br> 　   配置文件目录：/etc/ansible/<br>　　执行文件目录：/usr/bin/<br>　　Lib库依赖目录：/usr/lib/pythonX.X/site-packages/ansible/<br>　　Help文档目录：/usr/share/doc/ansible-X.X.X/<br>　　Man文档目录：/usr/share/man/man1/</p>
<h3 id="6、ansible配置文件查找顺序"><a href="#6、ansible配置文件查找顺序" class="headerlink" title="6、ansible配置文件查找顺序"></a>6、ansible配置文件查找顺序</h3><p>　　ansible与我们其他的服务在这一点上有很大不同，这里的配置文件查找是从多个地方找的，顺序如下：</p>
<ol>
<li>检查环境变量<code>ANSIBLE_CONFIG</code>指向的路径文件(export ANSIBLE_CONFIG=/etc/ansible.cfg)；</li>
<li><code>~/.ansible.cfg</code>，检查当前目录下的ansible.cfg配置文件；</li>
<li><code>/etc/ansible.cfg</code>检查etc目录的配置文件。</li>
</ol>
<h3 id="7、ansible配置文件"><a href="#7、ansible配置文件" class="headerlink" title="7、ansible配置文件"></a>7、ansible配置文件</h3><p>　　ansible 的配置文件为<code>/etc/ansible/ansible.cfg</code>，ansible 有许多参数，下面我们列出一些常见的参数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">inventory &#x3D; &#x2F;etc&#x2F;ansible&#x2F;hosts #这个参数表示资源清单inventory文件的位置</span><br><span class="line">library &#x3D; &#x2F;usr&#x2F;share&#x2F;ansible   #指向存放Ansible模块的目录，支持多个目录方式，只要用冒号（：）隔开就可以</span><br><span class="line">forks &#x3D; 5       #并发连接数，默认为5</span><br><span class="line">sudo_user &#x3D; root        #设置默认执行命令的用户</span><br><span class="line">remote_port &#x3D; 22        #指定连接被管节点的管理端口，默认为22端口，建议修改，能够更加安全</span><br><span class="line">host_key_checking &#x3D; False #设置是否检查SSH主机的密钥，值为True&#x2F;False。关闭后第一次连接不会提示配置实例</span><br><span class="line">timeout &#x3D; 60        #设置SSH连接的超时时间，单位为秒</span><br><span class="line">log_path &#x3D; &#x2F;var&#x2F;log&#x2F;ansible.log     #指定一个存储ansible日志的文件（默认不记录日志）</span><br></pre></td></tr></table></figure>

<h3 id="8、ansuble主机清单"><a href="#8、ansuble主机清单" class="headerlink" title="8、ansuble主机清单"></a>8、ansuble主机清单</h3><p>　　在配置文件中，我们提到了资源清单，这个清单就是我们的主机清单，里面保存的是一些 ansible 需要连接管理的主机列表。我们可以来看看他的定义方式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">1、 直接指明主机地址或主机名：</span><br><span class="line">    # green.example.com</span><br><span class="line">    # blue.example.com</span><br><span class="line">    # 192.168.100.1</span><br><span class="line">    # 192.168.100.10</span><br><span class="line">2、 定义一个主机组[组名]把地址或主机名加进去</span><br><span class="line">    [mysql_test]</span><br><span class="line">    192.168.253.159</span><br><span class="line">    192.168.253.160</span><br><span class="line">    192.168.253.153</span><br></pre></td></tr></table></figure>

<p>　　需要注意的是，这里的组成员可以使用通配符来匹配，这样对于一些标准化的管理来说就很轻松方便了。<br> 　　我们可以根据实际情况来配置我们的主机列表，具体操作如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]# vim &#x2F;etc&#x2F;ansible&#x2F;hosts</span><br><span class="line">    [web]</span><br><span class="line">    192.168.37.122</span><br><span class="line">    192.168.37.133</span><br></pre></td></tr></table></figure>

<h2 id="四、ansible-常用命令"><a href="#四、ansible-常用命令" class="headerlink" title="四、ansible 常用命令"></a>四、ansible 常用命令</h2><h3 id="1、ansible-命令集"><a href="#1、ansible-命令集" class="headerlink" title="1、ansible 命令集"></a>1、ansible 命令集</h3><blockquote>
<p><code>/usr/bin/ansible</code>　　Ansibe AD-Hoc 临时命令执行工具，常用于临时命令的执行<br><code>/usr/bin/ansible-doc</code> 　　Ansible 模块功能查看工具<br><code>/usr/bin/ansible-galaxy</code>　　下载/上传优秀代码或Roles模块 的官网平台，基于网络的<br><code>/usr/bin/ansible-playbook</code>　　Ansible 定制自动化的任务集编排工具<br><code>/usr/bin/ansible-pull</code>　　Ansible远程执行命令的工具，拉取配置而非推送配置（使用较少，海量机器时使用，对运维的架构能力要求较高）<br><code>/usr/bin/ansible-vault</code>　　    Ansible 文件加密工具<br><code>/usr/bin/ansible-console</code>　　Ansible基于Linux Consoble界面可与用户交互的命令执行工具</p>
</blockquote>
<p>　　其中，我们比较常用的是<code>/usr/bin/ansible</code>和<code>/usr/bin/ansible-playbook</code>。</p>
<h3 id="2、ansible-doc-命令"><a href="#2、ansible-doc-命令" class="headerlink" title="2、ansible-doc 命令"></a>2、ansible-doc 命令</h3><p>　　ansible-doc 命令常用于获取模块信息及其使用帮助，一般用法如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ansible-doc -l              #获取全部模块的信息</span><br><span class="line">ansible-doc -s MOD_NAME     #获取指定模块的使用帮助</span><br></pre></td></tr></table></figure>

<p>　　我们也可以查看一下ansible-doc的全部用法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]# ansible-doc</span><br><span class="line">Usage: ansible-doc [options] [module...]</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">  -h, --help            show this help message and exit　　# 显示命令参数API文档</span><br><span class="line">  -l, --list            List available modules　　#列出可用的模块</span><br><span class="line">  -M MODULE_PATH, --module-path&#x3D;MODULE_PATH　　#指定模块的路径</span><br><span class="line">                        specify path(s) to module library (default&#x3D;None)</span><br><span class="line">  -s, --snippet         Show playbook snippet for specified module(s)　　#显示playbook制定模块的用法</span><br><span class="line">  -v, --verbose         verbose mode (-vvv for more, -vvvv to enable　　# 显示ansible-doc的版本号查看模块列表：</span><br><span class="line">                        connection debugging)</span><br><span class="line">  --version             show program&#39;s version number and exit</span><br></pre></td></tr></table></figure>

<p>　　我们可以来看一下，以mysql相关的为例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]# ansible-doc -l |grep mysql</span><br><span class="line">mysql_db                           Add or remove MySQL databases from a remote...</span><br><span class="line">mysql_replication                  Manage MySQL replication                   </span><br><span class="line">mysql_user                         Adds or removes a user from a MySQL databas...</span><br><span class="line">mysql_variables                    Manage MySQL global variables      </span><br><span class="line">[root@server ~]# ansible-doc -s mysql_user</span><br></pre></td></tr></table></figure>

<h3 id="2、ansible-命令详解"><a href="#2、ansible-命令详解" class="headerlink" title="2、ansible 命令详解"></a>2、ansible 命令详解</h3><p>　　命令的具体格式如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible &lt;host-pattern&gt; [-f forks] [-m module_name] [-a args]</span><br></pre></td></tr></table></figure>

<p>　　也可以通过<code>ansible -h</code>来查看帮助，下面我们列出一些比较常用的选项，并解释其含义：</p>
<blockquote>
<p><code>-a MODULE_ARGS</code> #模块的参数，如果执行默认COMMAND的模块，即是命令参数，如： “date”，“pwd”等等<br><code>-k</code>，<code>--ask-pass</code> #ask for SSH password。登录密码，提示输入SSH密码而不是假设基于密钥的验证<br><code>--ask-su-pass</code> #ask for su password。su切换密码<br><code>-K</code>，<code>--ask-sudo-pass</code> #ask for sudo password。提示密码使用sudo，sudo表示提权操作<br><code>--ask-vault-pass</code> #ask for vault password。假设我们设定了加密的密码，则用该选项进行访问<br><code>-B SECONDS</code> #后台运行超时时间<br><code>-C</code> #模拟运行环境并进行预运行，可以进行查错测试<br><code>-c CONNECTION</code> #连接类型使用<br><code>-f FORKS</code> #并行任务数，默认为5<br><code>-i INVENTORY</code> #指定主机清单的路径，默认为<code>/etc/ansible/hosts</code><br><code>--list-hosts</code> #查看有哪些主机组<br><code>-m MODULE_NAME</code> #执行模块的名字，默认使用 command 模块，所以如果是只执行单一命令可以不用 -m参数<br><code>-o</code> #压缩输出，尝试将所有结果在一行输出，一般针对收集工具使用<br><code>-S</code> #用 su 命令<br><code>-R SU_USER</code> #指定 su 的用户，默认为 root 用户<br><code>-s</code> #用 sudo 命令<br><code>-U SUDO_USER</code> #指定 sudo 到哪个用户，默认为 root 用户<br><code>-T TIMEOUT</code> #指定 ssh 默认超时时间，默认为10s，也可在配置文件中修改<br><code>-u REMOTE_USER</code> #远程用户，默认为 root 用户<br><code>-v</code> #查看详细信息，同时支持<code>-vvv</code>，<code>-vvvv</code>可查看更详细信息</p>
</blockquote>
<h3 id="3、ansible-配置公私钥"><a href="#3、ansible-配置公私钥" class="headerlink" title="3、ansible 配置公私钥"></a>3、ansible 配置公私钥</h3><p>　　上面我们已经提到过 ansible 是基于 ssh 协议实现的，所以其配置公私钥的方式与 ssh 协议的方式相同，具体操作步骤如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#1.生成私钥</span><br><span class="line">[root@server ~]# ssh-keygen </span><br><span class="line">#2.向主机分发私钥</span><br><span class="line">[root@server ~]# ssh-copy-id root@192.168.37.122</span><br><span class="line">[root@server ~]# ssh-copy-id root@192.168.37.133</span><br></pre></td></tr></table></figure>

<p>　　这样的话，就可以实现无密码登录，我们的实验过程也会顺畅很多。<br> 　　注意，如果出现了一下报错：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-bash: ssh-copy-id: command not found</span><br></pre></td></tr></table></figure>

<p>　　那么就证明我们需要安装一个包：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install openssh-clientsansible</span><br></pre></td></tr></table></figure>

<p>　　把包安装上即可。</p>
<h2 id="五、ansible-常用模块"><a href="#五、ansible-常用模块" class="headerlink" title="五、ansible 常用模块"></a>五、ansible 常用模块</h2><h3 id="1、主机连通性测试"><a href="#1、主机连通性测试" class="headerlink" title="1、主机连通性测试"></a>1、主机连通性测试</h3><p>　　我们使用<code>ansible web -m ping</code>命令来进行主机连通性测试，效果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]# ansible web -m ping</span><br><span class="line">192.168.37.122 | SUCCESS &#x3D;&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: false, </span><br><span class="line">    &quot;ping&quot;: &quot;pong&quot;</span><br><span class="line">&#125;</span><br><span class="line">192.168.37.133 | SUCCESS &#x3D;&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: false, </span><br><span class="line">    &quot;ping&quot;: &quot;pong&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>　　这样就说明我们的主机是连通状态的。接下来的操作才可以正常进行。</p>
<h3 id="2、command-模块"><a href="#2、command-模块" class="headerlink" title="2、command 模块"></a>2、command 模块</h3><p>　　这个模块可以直接在远程主机上执行命令，并将结果返回本主机。<br> 　　举例如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]# ansible web -m command -a &#39;ss -ntl&#39;</span><br><span class="line">192.168.37.122 | SUCCESS | rc&#x3D;0 &gt;&gt;</span><br><span class="line">State      Recv-Q Send-Q Local Address:Port               Peer Address:Port              </span><br><span class="line">LISTEN     0      128          *:111                      *:*                  </span><br><span class="line">LISTEN     0      5      192.168.122.1:53                       *:*                  </span><br><span class="line">LISTEN     0      128          *:22                       *:*                  </span><br><span class="line">LISTEN     0      128    127.0.0.1:631                      *:*                  </span><br><span class="line">LISTEN     0      128          *:23000                    *:*                  </span><br><span class="line">LISTEN     0      100    127.0.0.1:25                       *:*                  </span><br><span class="line">LISTEN     0      128         :::111                     :::*                  </span><br><span class="line">LISTEN     0      128         :::22                      :::*                  </span><br><span class="line">LISTEN     0      128        ::1:631                     :::*                  </span><br><span class="line">LISTEN     0      100        ::1:25                      :::*                  </span><br><span class="line"></span><br><span class="line">192.168.37.133 | SUCCESS | rc&#x3D;0 &gt;&gt;</span><br><span class="line">State      Recv-Q Send-Q Local Address:Port               Peer Address:Port              </span><br><span class="line">LISTEN     0      128          *:111                      *:*                  </span><br><span class="line">LISTEN     0      128          *:22                       *:*                  </span><br><span class="line">LISTEN     0      128    127.0.0.1:631                      *:*                  </span><br><span class="line">LISTEN     0      128          *:23000                    *:*                  </span><br><span class="line">LISTEN     0      100    127.0.0.1:25                       *:*                  </span><br><span class="line">LISTEN     0      128         :::111                     :::*                  </span><br><span class="line">LISTEN     0      128         :::22                      :::*                  </span><br><span class="line">LISTEN     0      128        ::1:631                     :::*                  </span><br><span class="line">LISTEN     0      100        ::1:25                      :::*</span><br></pre></td></tr></table></figure>

<p>　　命令模块接受命令名称，后面是空格分隔的列表参数。给定的命令将在所有选定的节点上执行。它不会通过shell进行处理，比如$HOME和操作如”&lt;”，”&gt;”，”|”，”;”，”&amp;” 工作（需要使用（shell）模块实现这些功能）。注意，该命令不支持<code>| 管道命令</code>。<br> 　　下面来看一看该模块下常用的几个命令：</p>
<blockquote>
<p>chdir　　　   # 在执行命令之前，先切换到该目录<br>executable    # 切换shell来执行命令，需要使用命令的绝对路径<br>free_form 　 # 要执行的Linux指令，一般使用Ansible的-a参数代替。<br>creates 　      # 一个文件名，当这个文件存在，则该命令不执行,可以用来做判断<br>removes        # 一个文件名，这个文件不存在，则该命令不执行</p>
</blockquote>
<p>　　下面我们来看看这些命令的执行效果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]# ansible web -m command -a &#39;chdir&#x3D;&#x2F;data&#x2F; ls&#39;  #先切换到&#x2F;data&#x2F; 目录，再执行“ls”命令</span><br><span class="line">192.168.37.122 | SUCCESS | rc&#x3D;0 &gt;&gt;</span><br><span class="line">aaa.jpg</span><br><span class="line">fastdfs</span><br><span class="line">mogdata</span><br><span class="line">tmp</span><br><span class="line">web</span><br><span class="line">wKgleloeYoCAMLtZAAAWEekAtkc497.jpg</span><br><span class="line"></span><br><span class="line">192.168.37.133 | SUCCESS | rc&#x3D;0 &gt;&gt;</span><br><span class="line">aaa.jpg</span><br><span class="line">fastdfs</span><br><span class="line">mogdata</span><br><span class="line">tmp</span><br><span class="line">web</span><br><span class="line">wKgleloeYoCAMLtZAAAWEekAtkc497.jpg</span><br><span class="line">[root@server ~]# ansible web -m command -a &#39;creates&#x3D;&#x2F;data&#x2F;aaa.jpg ls&#39;  #如果&#x2F;data&#x2F;aaa.jpg存在，则不执行“ls”命令</span><br><span class="line">192.168.37.122 | SUCCESS | rc&#x3D;0 &gt;&gt;</span><br><span class="line">skipped, since &#x2F;data&#x2F;aaa.jpg exists</span><br><span class="line"></span><br><span class="line">192.168.37.133 | SUCCESS | rc&#x3D;0 &gt;&gt;</span><br><span class="line">skipped, since &#x2F;data&#x2F;aaa.jpg exists</span><br><span class="line">[root@server ~]# ansible web -m command -a &#39;removes&#x3D;&#x2F;data&#x2F;aaa.jpg cat &#x2F;data&#x2F;a&#39; #如果&#x2F;data&#x2F;aaa.jpg存在，则执行“cat &#x2F;data&#x2F;a”命令</span><br><span class="line">192.168.37.122 | SUCCESS | rc&#x3D;0 &gt;&gt;</span><br><span class="line">hello</span><br><span class="line"></span><br><span class="line">192.168.37.133 | SUCCESS | rc&#x3D;0 &gt;&gt;</span><br><span class="line">hello</span><br></pre></td></tr></table></figure>

<h3 id="3、shell-模块"><a href="#3、shell-模块" class="headerlink" title="3、shell 模块"></a>3、shell 模块</h3><p>　　shell模块可以在远程主机上调用shell解释器运行命令，支持shell的各种功能，例如管道等。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]# ansible web -m shell -a &#39;cat &#x2F;etc&#x2F;passwd |grep &quot;keer&quot;&#39;</span><br><span class="line">192.168.37.122 | SUCCESS | rc&#x3D;0 &gt;&gt;</span><br><span class="line">keer:x:10001:1000:keer:&#x2F;home&#x2F;keer:&#x2F;bin&#x2F;sh</span><br><span class="line"></span><br><span class="line">192.168.37.133 | SUCCESS | rc&#x3D;0 &gt;&gt;</span><br><span class="line">keer:x:10001:10001::&#x2F;home&#x2F;keer:&#x2F;bin&#x2F;sh</span><br></pre></td></tr></table></figure>

<p>　　只要是我们的shell命令，都可以通过这个模块在远程主机上运行，这里就不一一举例了。</p>
<h3 id="4、copy-模块"><a href="#4、copy-模块" class="headerlink" title="4、copy 模块"></a>4、copy 模块</h3><p>　　这个模块用于将文件复制到远程主机，同时支持给定内容生成文件和修改权限等。<br> 　　其相关选项如下：</p>
<blockquote>
<p><code>src</code>　　　　 #被复制到远程主机的本地文件。可以是绝对路径，也可以是相对路径。如果路径是一个目录，则会递归复制，用法类似于”rsync”<br><code>content</code>　　#用于替换”src”，可以直接指定文件的值<br><code>dest</code>　　　   #必选项，将源文件复制到的远程主机的<strong>绝对路径</strong><br><code>backup</code>　　　#当文件内容发生改变后，在覆盖之前把源文件备份，备份文件包含时间信息<br><code>directory_mode</code>　　　　#递归设定目录的权限，默认为系统默认权限<br><code>force</code>　　　　#当目标主机包含该文件，但内容不同时，设为”yes”，表示强制覆盖；设为”no”，表示目标主机的目标位置不存在该文件才复制。默认为”yes”<br><code>others</code>　　　　#所有的 file 模块中的选项可以在这里使用</p>
</blockquote>
<p>用法举例如下：<br><strong>① 复制文件：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]# ansible web -m copy -a &#39;src&#x3D;~&#x2F;hello dest&#x3D;&#x2F;data&#x2F;hello&#39; </span><br><span class="line">192.168.37.122 | SUCCESS &#x3D;&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;checksum&quot;: &quot;22596363b3de40b06f981fb85d82312e8c0ed511&quot;, </span><br><span class="line">    &quot;dest&quot;: &quot;&#x2F;data&#x2F;hello&quot;, </span><br><span class="line">    &quot;gid&quot;: 0, </span><br><span class="line">    &quot;group&quot;: &quot;root&quot;, </span><br><span class="line">    &quot;md5sum&quot;: &quot;6f5902ac237024bdd0c176cb93063dc4&quot;, </span><br><span class="line">    &quot;mode&quot;: &quot;0644&quot;, </span><br><span class="line">    &quot;owner&quot;: &quot;root&quot;, </span><br><span class="line">    &quot;size&quot;: 12, </span><br><span class="line">    &quot;src&quot;: &quot;&#x2F;root&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-1512437093.55-228281064292921&#x2F;source&quot;, </span><br><span class="line">    &quot;state&quot;: &quot;file&quot;, </span><br><span class="line">    &quot;uid&quot;: 0</span><br><span class="line">&#125;</span><br><span class="line">192.168.37.133 | SUCCESS &#x3D;&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;checksum&quot;: &quot;22596363b3de40b06f981fb85d82312e8c0ed511&quot;, </span><br><span class="line">    &quot;dest&quot;: &quot;&#x2F;data&#x2F;hello&quot;, </span><br><span class="line">    &quot;gid&quot;: 0, </span><br><span class="line">    &quot;group&quot;: &quot;root&quot;, </span><br><span class="line">    &quot;md5sum&quot;: &quot;6f5902ac237024bdd0c176cb93063dc4&quot;, </span><br><span class="line">    &quot;mode&quot;: &quot;0644&quot;, </span><br><span class="line">    &quot;owner&quot;: &quot;root&quot;, </span><br><span class="line">    &quot;size&quot;: 12, </span><br><span class="line">    &quot;src&quot;: &quot;&#x2F;root&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-1512437093.74-44694985235189&#x2F;source&quot;, </span><br><span class="line">    &quot;state&quot;: &quot;file&quot;, </span><br><span class="line">    &quot;uid&quot;: 0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>② 给定内容生成文件，并制定权限</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]# ansible web -m copy -a &#39;content&#x3D;&quot;I am keer\n&quot; dest&#x3D;&#x2F;data&#x2F;name mode&#x3D;666&#39;</span><br><span class="line">192.168.37.122 | SUCCESS &#x3D;&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;checksum&quot;: &quot;0421570938940ea784f9d8598dab87f07685b968&quot;, </span><br><span class="line">    &quot;dest&quot;: &quot;&#x2F;data&#x2F;name&quot;, </span><br><span class="line">    &quot;gid&quot;: 0, </span><br><span class="line">    &quot;group&quot;: &quot;root&quot;, </span><br><span class="line">    &quot;md5sum&quot;: &quot;497fa8386590a5fc89090725b07f175c&quot;, </span><br><span class="line">    &quot;mode&quot;: &quot;0666&quot;, </span><br><span class="line">    &quot;owner&quot;: &quot;root&quot;, </span><br><span class="line">    &quot;size&quot;: 10, </span><br><span class="line">    &quot;src&quot;: &quot;&#x2F;root&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-1512437327.37-199512601767687&#x2F;source&quot;, </span><br><span class="line">    &quot;state&quot;: &quot;file&quot;, </span><br><span class="line">    &quot;uid&quot;: 0</span><br><span class="line">&#125;</span><br><span class="line">192.168.37.133 | SUCCESS &#x3D;&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;checksum&quot;: &quot;0421570938940ea784f9d8598dab87f07685b968&quot;, </span><br><span class="line">    &quot;dest&quot;: &quot;&#x2F;data&#x2F;name&quot;, </span><br><span class="line">    &quot;gid&quot;: 0, </span><br><span class="line">    &quot;group&quot;: &quot;root&quot;, </span><br><span class="line">    &quot;md5sum&quot;: &quot;497fa8386590a5fc89090725b07f175c&quot;, </span><br><span class="line">    &quot;mode&quot;: &quot;0666&quot;, </span><br><span class="line">    &quot;owner&quot;: &quot;root&quot;, </span><br><span class="line">    &quot;size&quot;: 10, </span><br><span class="line">        &quot;src&quot;: &quot;&#x2F;root&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-1512437327.55-218104039503110&#x2F;source&quot;, </span><br><span class="line">    &quot;state&quot;: &quot;file&quot;, </span><br><span class="line">    &quot;uid&quot;: 0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>　　我们现在可以去查看一下我们生成的文件及其权限：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]# ansible web -m shell -a &#39;ls -l &#x2F;data&#x2F;&#39;</span><br><span class="line">192.168.37.122 | SUCCESS | rc&#x3D;0 &gt;&gt;</span><br><span class="line">total 28</span><br><span class="line">-rw-rw-rw-   1 root root   12 Dec  6 09:45 name</span><br><span class="line"></span><br><span class="line">192.168.37.133 | SUCCESS | rc&#x3D;0 &gt;&gt;</span><br><span class="line">total 40</span><br><span class="line">-rw-rw-rw- 1 root     root       12 Dec  5 09:45 name</span><br></pre></td></tr></table></figure>

<p>　　可以看出我们的name文件已经生成，并且权限为666。<br><strong>③ 关于覆盖</strong><br> 　　我们把文件的内容修改一下，然后选择覆盖备份：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]# ansible web -m copy -a &#39;content&#x3D;&quot;I am keerya\n&quot; backup&#x3D;yes dest&#x3D;&#x2F;data&#x2F;name mode&#x3D;666&#39;</span><br><span class="line">192.168.37.122 | SUCCESS &#x3D;&gt; &#123;</span><br><span class="line">    &quot;backup_file&quot;: &quot;&#x2F;data&#x2F;name.4394.2017-12-06@09:46:25~&quot;, </span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;checksum&quot;: &quot;064a68908ab9971ee85dbc08ea038387598e3778&quot;, </span><br><span class="line">    &quot;dest&quot;: &quot;&#x2F;data&#x2F;name&quot;, </span><br><span class="line">    &quot;gid&quot;: 0, </span><br><span class="line">    &quot;group&quot;: &quot;root&quot;, </span><br><span class="line">    &quot;md5sum&quot;: &quot;8ca7c11385856155af52e560f608891c&quot;, </span><br><span class="line">    &quot;mode&quot;: &quot;0666&quot;, </span><br><span class="line">    &quot;owner&quot;: &quot;root&quot;, </span><br><span class="line">    &quot;size&quot;: 12, </span><br><span class="line">    &quot;src&quot;: &quot;&#x2F;root&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-1512438383.78-228128616784888&#x2F;source&quot;, </span><br><span class="line">    &quot;state&quot;: &quot;file&quot;, </span><br><span class="line">    &quot;uid&quot;: 0</span><br><span class="line">&#125;</span><br><span class="line">192.168.37.133 | SUCCESS &#x3D;&gt; &#123;</span><br><span class="line">    &quot;backup_file&quot;: &quot;&#x2F;data&#x2F;name.5962.2017-12-05@09:46:24~&quot;, </span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;checksum&quot;: &quot;064a68908ab9971ee85dbc08ea038387598e3778&quot;, </span><br><span class="line">    &quot;dest&quot;: &quot;&#x2F;data&#x2F;name&quot;, </span><br><span class="line">    &quot;gid&quot;: 0, </span><br><span class="line">    &quot;group&quot;: &quot;root&quot;, </span><br><span class="line">    &quot;md5sum&quot;: &quot;8ca7c11385856155af52e560f608891c&quot;, </span><br><span class="line">    &quot;mode&quot;: &quot;0666&quot;, </span><br><span class="line">    &quot;owner&quot;: &quot;root&quot;, </span><br><span class="line">    &quot;size&quot;: 12, </span><br><span class="line">    &quot;src&quot;: &quot;&#x2F;root&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-1512438384.0-170718946740009&#x2F;source&quot;, </span><br><span class="line">    &quot;state&quot;: &quot;file&quot;, </span><br><span class="line">    &quot;uid&quot;: 0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>　　现在我们可以去查看一下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]# ansible web -m shell -a &#39;ls -l &#x2F;data&#x2F;&#39;</span><br><span class="line">192.168.37.122 | SUCCESS | rc&#x3D;0 &gt;&gt;</span><br><span class="line">total 28</span><br><span class="line">-rw-rw-rw-   1 root root   12 Dec  6 09:46 name</span><br><span class="line">-rw-rw-rw-   1 root root   10 Dec  6 09:45 name.4394.2017-12-06@09:46:25~</span><br><span class="line"></span><br><span class="line">192.168.37.133 | SUCCESS | rc&#x3D;0 &gt;&gt;</span><br><span class="line">total 40</span><br><span class="line">-rw-rw-rw- 1 root     root       12 Dec  5 09:46 name</span><br><span class="line">-rw-rw-rw- 1 root     root       10 Dec  5 09:45 name.5962.2017-12-05@09:46:24~</span><br></pre></td></tr></table></figure>

<p>　　可以看出，我们的源文件已经被备份，我们还可以查看一下<code>name</code>文件的内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]# ansible web -m shell -a &#39;cat &#x2F;data&#x2F;name&#39;</span><br><span class="line">192.168.37.122 | SUCCESS | rc&#x3D;0 &gt;&gt;</span><br><span class="line">I am keerya</span><br><span class="line"></span><br><span class="line">192.168.37.133 | SUCCESS | rc&#x3D;0 &gt;&gt;</span><br><span class="line">I am keerya</span><br></pre></td></tr></table></figure>

<p>　　证明，这正是我们新导入的文件的内容。</p>
<h3 id="5、file-模块"><a href="#5、file-模块" class="headerlink" title="5、file 模块"></a>5、file 模块</h3><p>　　该模块主要用于设置文件的属性，比如创建文件、创建链接文件、删除文件等。<br> 　　下面是一些常见的命令：</p>
<blockquote>
<p><code>force</code>　　#需要在两种情况下强制创建软链接，一种是源文件不存在，但之后会建立的情况下；另一种是目标软链接已存在，需要先取消之前的软链，然后创建新的软链，有两个选项：yes|no<br><code>group</code>　　#定义文件/目录的属组。后面可以加上<code>mode</code>：定义文件/目录的权限<br><code>owner</code>　　#定义文件/目录的属主。后面必须跟上<code>path</code>：定义文件/目录的路径<br><code>recurse</code>　　#递归设置文件的属性，只对目录有效，后面跟上<code>src</code>：被链接的源文件路径，只应用于<code>state=link</code>的情况<br><code>dest</code>　　#被链接到的路径，只应用于<code>state=link</code>的情况<br><code>state</code>　　#状态，有以下选项：</p>
<p><code>directory</code>：如果目录不存在，就创建目录<br><code>file</code>：即使文件不存在，也不会被创建<br><code>link</code>：创建软链接<br><code>hard</code>：创建硬链接<br><code>touch</code>：如果文件不存在，则会创建一个新的文件，如果文件或目录已存在，则更新其最后修改时间<br><code>absent</code>：删除目录、文件或者取消链接文件</p>
</blockquote>
<p>　　用法举例如下：<br><strong>① 创建目录：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]# ansible web -m file -a &#39;path&#x3D;&#x2F;data&#x2F;app state&#x3D;directory&#39;</span><br><span class="line">192.168.37.122 | SUCCESS &#x3D;&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;gid&quot;: 0, </span><br><span class="line">    &quot;group&quot;: &quot;root&quot;, </span><br><span class="line">    &quot;mode&quot;: &quot;0755&quot;, </span><br><span class="line">    &quot;owner&quot;: &quot;root&quot;, </span><br><span class="line">    &quot;path&quot;: &quot;&#x2F;data&#x2F;app&quot;, </span><br><span class="line">    &quot;size&quot;: 6, </span><br><span class="line">    &quot;state&quot;: &quot;directory&quot;, </span><br><span class="line">    &quot;uid&quot;: 0</span><br><span class="line">&#125;</span><br><span class="line">192.168.37.133 | SUCCESS &#x3D;&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;gid&quot;: 0, </span><br><span class="line">    &quot;group&quot;: &quot;root&quot;, </span><br><span class="line">    &quot;mode&quot;: &quot;0755&quot;, </span><br><span class="line">    &quot;owner&quot;: &quot;root&quot;, </span><br><span class="line">    &quot;path&quot;: &quot;&#x2F;data&#x2F;app&quot;, </span><br><span class="line">    &quot;size&quot;: 4096, </span><br><span class="line">    &quot;state&quot;: &quot;directory&quot;, </span><br><span class="line">    &quot;uid&quot;: 0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>　　我们可以查看一下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]# ansible web -m shell -a &#39;ls -l &#x2F;data&#39;</span><br><span class="line">192.168.37.122 | SUCCESS | rc&#x3D;0 &gt;&gt;</span><br><span class="line">total 28</span><br><span class="line">drwxr-xr-x   2 root root    6 Dec  6 10:21 app</span><br><span class="line"></span><br><span class="line">192.168.37.133 | SUCCESS | rc&#x3D;0 &gt;&gt;</span><br><span class="line">total 44</span><br><span class="line">drwxr-xr-x 2 root     root     4096 Dec  5 10:21 app</span><br></pre></td></tr></table></figure>

<p>　　可以看出，我们的目录已经创建完成。<br><strong>② 创建链接文件</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]# ansible web -m file -a &#39;path&#x3D;&#x2F;data&#x2F;bbb.jpg src&#x3D;aaa.jpg state&#x3D;link&#39;</span><br><span class="line">192.168.37.122 | SUCCESS &#x3D;&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;dest&quot;: &quot;&#x2F;data&#x2F;bbb.jpg&quot;, </span><br><span class="line">    &quot;gid&quot;: 0, </span><br><span class="line">    &quot;group&quot;: &quot;root&quot;, </span><br><span class="line">    &quot;mode&quot;: &quot;0777&quot;, </span><br><span class="line">    &quot;owner&quot;: &quot;root&quot;, </span><br><span class="line">    &quot;size&quot;: 7, </span><br><span class="line">    &quot;src&quot;: &quot;aaa.jpg&quot;, </span><br><span class="line">    &quot;state&quot;: &quot;link&quot;, </span><br><span class="line">    &quot;uid&quot;: 0</span><br><span class="line">&#125;</span><br><span class="line">192.168.37.133 | SUCCESS &#x3D;&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;dest&quot;: &quot;&#x2F;data&#x2F;bbb.jpg&quot;, </span><br><span class="line">    &quot;gid&quot;: 0, </span><br><span class="line">    &quot;group&quot;: &quot;root&quot;, </span><br><span class="line">    &quot;mode&quot;: &quot;0777&quot;, </span><br><span class="line">    &quot;owner&quot;: &quot;root&quot;, </span><br><span class="line">    &quot;size&quot;: 7, </span><br><span class="line">    &quot;src&quot;: &quot;aaa.jpg&quot;, </span><br><span class="line">    &quot;state&quot;: &quot;link&quot;, </span><br><span class="line">    &quot;uid&quot;: 0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>　　我们可以去查看一下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]# ansible web -m shell -a &#39;ls -l &#x2F;data&#39;</span><br><span class="line">192.168.37.122 | SUCCESS | rc&#x3D;0 &gt;&gt;</span><br><span class="line">total 28</span><br><span class="line">-rw-r--r--   1 root root 5649 Dec  5 13:49 aaa.jpg</span><br><span class="line">lrwxrwxrwx   1 root root    7 Dec  6 10:25 bbb.jpg -&gt; aaa.jpg</span><br><span class="line"></span><br><span class="line">192.168.37.133 | SUCCESS | rc&#x3D;0 &gt;&gt;</span><br><span class="line">total 44</span><br><span class="line">-rw-r--r-- 1 root     root     5649 Dec  4 14:44 aaa.jpg</span><br><span class="line">lrwxrwxrwx 1 root     root        7 Dec  5 10:25 bbb.jpg -&gt; aaa.jpg</span><br></pre></td></tr></table></figure>

<p>　　我们的链接文件已经创建成功。<br><strong>③ 删除文件</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]# ansible web -m file -a &#39;path&#x3D;&#x2F;data&#x2F;a state&#x3D;absent&#39;</span><br><span class="line">192.168.37.122 | SUCCESS &#x3D;&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;path&quot;: &quot;&#x2F;data&#x2F;a&quot;, </span><br><span class="line">    &quot;state&quot;: &quot;absent&quot;</span><br><span class="line">&#125;</span><br><span class="line">192.168.37.133 | SUCCESS &#x3D;&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;path&quot;: &quot;&#x2F;data&#x2F;a&quot;, </span><br><span class="line">    &quot;state&quot;: &quot;absent&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>　　我们可以查看一下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]# ansible web -m shell -a &#39;ls &#x2F;data&#x2F;a&#39;</span><br><span class="line">192.168.37.122 | FAILED | rc&#x3D;2 &gt;&gt;</span><br><span class="line">ls: cannot access &#x2F;data&#x2F;a: No such file or directory</span><br><span class="line"></span><br><span class="line">192.168.37.133 | FAILED | rc&#x3D;2 &gt;&gt;</span><br><span class="line">ls: cannot access &#x2F;data&#x2F;a: No such file or directory</span><br></pre></td></tr></table></figure>

<p>　　发现已经没有这个文件了。</p>
<h3 id="6、fetch-模块"><a href="#6、fetch-模块" class="headerlink" title="6、fetch 模块"></a>6、fetch 模块</h3><p>　　该模块用于从远程某主机获取（复制）文件到本地。<br> 　　有两个选项：</p>
<blockquote>
<p><code>dest</code>：用来存放文件的目录<br><code>src</code>：在远程拉取的文件，并且必须是一个<strong>file</strong>，不能是<strong>目录</strong></p>
</blockquote>
<p>　　具体举例如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]# ansible web -m fetch -a &#39;src&#x3D;&#x2F;data&#x2F;hello dest&#x3D;&#x2F;data&#39;  </span><br><span class="line">192.168.37.122 | SUCCESS &#x3D;&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;checksum&quot;: &quot;22596363b3de40b06f981fb85d82312e8c0ed511&quot;, </span><br><span class="line">    &quot;dest&quot;: &quot;&#x2F;data&#x2F;192.168.37.122&#x2F;data&#x2F;hello&quot;, </span><br><span class="line">    &quot;md5sum&quot;: &quot;6f5902ac237024bdd0c176cb93063dc4&quot;, </span><br><span class="line">    &quot;remote_checksum&quot;: &quot;22596363b3de40b06f981fb85d82312e8c0ed511&quot;, </span><br><span class="line">    &quot;remote_md5sum&quot;: null</span><br><span class="line">&#125;</span><br><span class="line">192.168.37.133 | SUCCESS &#x3D;&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;checksum&quot;: &quot;22596363b3de40b06f981fb85d82312e8c0ed511&quot;, </span><br><span class="line">    &quot;dest&quot;: &quot;&#x2F;data&#x2F;192.168.37.133&#x2F;data&#x2F;hello&quot;, </span><br><span class="line">    &quot;md5sum&quot;: &quot;6f5902ac237024bdd0c176cb93063dc4&quot;, </span><br><span class="line">    &quot;remote_checksum&quot;: &quot;22596363b3de40b06f981fb85d82312e8c0ed511&quot;, </span><br><span class="line">    &quot;remote_md5sum&quot;: null</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>　　我们可以在本机上查看一下文件是否复制成功。要注意，文件保存的路径是我们设置的接收目录下的<code>被管制主机ip</code>目录下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]# cd &#x2F;data&#x2F;</span><br><span class="line">[root@server data]# ls</span><br><span class="line">1  192.168.37.122  192.168.37.133  fastdfs  web</span><br><span class="line">[root@server data]# cd 192.168.37.122</span><br><span class="line">[root@server 192.168.37.122]# ls</span><br><span class="line">data</span><br><span class="line">[root@server 192.168.37.122]# cd data&#x2F;</span><br><span class="line">[root@server data]# ls</span><br><span class="line">hello</span><br><span class="line">[root@server data]# pwd</span><br><span class="line">&#x2F;data&#x2F;192.168.37.122&#x2F;data</span><br></pre></td></tr></table></figure>

<h3 id="7、cron-模块"><a href="#7、cron-模块" class="headerlink" title="7、cron 模块"></a>7、cron 模块</h3><p>　　该模块适用于管理<code>cron</code>计划任务的。<br> 　　其使用的语法跟我们的<code>crontab</code>文件中的语法一致，同时，可以指定以下选项：</p>
<blockquote>
<p><code>day=</code>           #日应该运行的工作( 1-31, <em>,</em> /2, )<br><code>hour=</code>         # 小时 ( 0-23, <em>,</em> /2, )<br><code>minute=</code>     #分钟( 0-59, <em>,</em> /2, )<br><code>month=</code>       # 月( 1-12, *, /2, )<br><code>weekday=</code>       # 周 ( 0-6 for Sunday-Saturday,, )<br><code>job=</code>           #指明运行的命令是什么<br><code>name=</code>        #定时任务描述<br><code>reboot</code>      # 任务在重启时运行，不建议使用，建议使用special_time<br><code>special_time</code> #特殊的时间范围，参数：reboot（重启时），annually（每年），monthly（每月），weekly（每周），daily（每天），hourly（每小时）<br><code>state</code>        #指定状态，present表示添加定时任务，也是默认设置，absent表示删除定时任务<br><code>user</code>          # 以哪个用户的身份执行</p>
</blockquote>
<p>　　举例如下：<br><strong>① 添加计划任务</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]# ansible web -m cron -a &#39;name&#x3D;&quot;ntp update every 5 min&quot; minute&#x3D;*&#x2F;5 job&#x3D;&quot;&#x2F;sbin&#x2F;ntpdate 172.17.0.1 &amp;&gt; &#x2F;dev&#x2F;null&quot;&#39;</span><br><span class="line">192.168.37.122 | SUCCESS &#x3D;&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;envs&quot;: [], </span><br><span class="line">    &quot;jobs&quot;: [</span><br><span class="line">        &quot;ntp update every 5 min&quot;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">192.168.37.133 | SUCCESS &#x3D;&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;envs&quot;: [], </span><br><span class="line">    &quot;jobs&quot;: [</span><br><span class="line">        &quot;ntp update every 5 min&quot;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>　　我们可以去查看一下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]# ansible web -m shell -a &#39;crontab -l&#39;</span><br><span class="line">192.168.37.122 | SUCCESS | rc&#x3D;0 &gt;&gt;</span><br><span class="line">#Ansible: ntp update every 5 min</span><br><span class="line">*&#x2F;5 * * * * &#x2F;sbin&#x2F;ntpdate 172.17.0.1 &amp;&gt; &#x2F;dev&#x2F;null</span><br><span class="line"></span><br><span class="line">192.168.37.133 | SUCCESS | rc&#x3D;0 &gt;&gt;</span><br><span class="line">#Ansible: ntp update every 5 min</span><br><span class="line">*&#x2F;5 * * * * &#x2F;sbin&#x2F;ntpdate 172.17.0.1 &amp;&gt; &#x2F;dev&#x2F;null</span><br></pre></td></tr></table></figure>

<p>　　可以看出，我们的计划任务已经设置成功了。<br><strong>② 删除计划任务</strong><br> 　　如果我们的计划任务添加错误，想要删除的话，则执行以下操作：<br> 　　首先我们查看一下现有的计划任务：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]# ansible web -m shell -a &#39;crontab -l&#39;</span><br><span class="line">192.168.37.122 | SUCCESS | rc&#x3D;0 &gt;&gt;</span><br><span class="line">#Ansible: ntp update every 5 min</span><br><span class="line">*&#x2F;5 * * * * &#x2F;sbin&#x2F;ntpdate 172.17.0.1 &amp;&gt; &#x2F;dev&#x2F;null</span><br><span class="line">#Ansible: df everyday</span><br><span class="line">* 15 * * * df -lh &gt;&gt; &#x2F;tmp&#x2F;disk_total &amp;&gt; &#x2F;dev&#x2F;null</span><br><span class="line"></span><br><span class="line">192.168.37.133 | SUCCESS | rc&#x3D;0 &gt;&gt;</span><br><span class="line">#Ansible: ntp update every 5 min</span><br><span class="line">*&#x2F;5 * * * * &#x2F;sbin&#x2F;ntpdate 172.17.0.1 &amp;&gt; &#x2F;dev&#x2F;null</span><br><span class="line">#Ansible: df everyday</span><br><span class="line">* 15 * * * df -lh &gt;&gt; &#x2F;tmp&#x2F;disk_total &amp;&gt; &#x2F;dev&#x2F;null</span><br></pre></td></tr></table></figure>

<p>　　然后执行删除操作：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]# ansible web -m cron -a &#39;name&#x3D;&quot;df everyday&quot; hour&#x3D;15 job&#x3D;&quot;df -lh &gt;&gt; &#x2F;tmp&#x2F;disk_total &amp;&gt; &#x2F;dev&#x2F;null&quot; state&#x3D;absent&#39;</span><br><span class="line">192.168.37.122 | SUCCESS &#x3D;&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;envs&quot;: [], </span><br><span class="line">    &quot;jobs&quot;: [</span><br><span class="line">        &quot;ntp update every 5 min&quot;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">192.168.37.133 | SUCCESS &#x3D;&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;envs&quot;: [], </span><br><span class="line">    &quot;jobs&quot;: [</span><br><span class="line">        &quot;ntp update every 5 min&quot;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>　　删除完成后，我们再查看一下现有的计划任务确认一下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]# ansible web -m shell -a &#39;crontab -l&#39;</span><br><span class="line">192.168.37.122 | SUCCESS | rc&#x3D;0 &gt;&gt;</span><br><span class="line">#Ansible: ntp update every 5 min</span><br><span class="line">*&#x2F;5 * * * * &#x2F;sbin&#x2F;ntpdate 172.17.0.1 &amp;&gt; &#x2F;dev&#x2F;null</span><br><span class="line"></span><br><span class="line">192.168.37.133 | SUCCESS | rc&#x3D;0 &gt;&gt;</span><br><span class="line">#Ansible: ntp update every 5 min</span><br><span class="line">*&#x2F;5 * * * * &#x2F;sbin&#x2F;ntpdate 172.17.0.1 &amp;&gt; &#x2F;dev&#x2F;null</span><br></pre></td></tr></table></figure>

<p>　　我们的删除操作已经成功。</p>
<h3 id="8、yum-模块"><a href="#8、yum-模块" class="headerlink" title="8、yum 模块"></a>8、yum 模块</h3><p>　　顾名思义，该模块主要用于软件的安装。<br> 　　其选项如下：</p>
<blockquote>
<p><code>name=</code>　　  #所安装的包的名称<br><code>state=</code>　　#<code>present</code>—&gt;安装， <code>latest</code>—&gt;安装最新的, <code>absent</code>—&gt; 卸载软件。<br><code>update_cache</code>　　#强制更新yum的缓存<br><code>conf_file</code>　　#指定远程yum安装时所依赖的配置文件（安装本地已有的包）。<br><code>disable_pgp_check</code>　　#是否禁止GPG checking，只用于<code>present</code>or <code>latest</code>。<br><code>disablerepo</code>　　#临时禁止使用yum库。 只用于安装或更新时。<br><code>enablerepo</code>　　 #临时使用的yum库。只用于安装或更新时。</p>
</blockquote>
<p>　　下面我们就来安装一个包试试看：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]# ansible web -m yum -a &#39;name&#x3D;htop state&#x3D;present&#39;</span><br><span class="line">192.168.37.122 | SUCCESS &#x3D;&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;msg&quot;: &quot;&quot;, </span><br><span class="line">    &quot;rc&quot;: 0, </span><br><span class="line">    &quot;results&quot;: [</span><br><span class="line">        &quot;Loaded plugins: fastestmirror, langpacks\nLoading mirror speeds from cached hostfile\nResolving Dependencies\n--&gt; Running transaction check\n---&gt; Package htop.x86_64 0:2.0.2-1.el7 will be installed\n--&gt; Finished Dependency Resolution\n\nDependencies Resolved\n\n&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;\n Package         Arch              Version                Repository       Size\n&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;\nInstalling:\n htop            x86_64            2.0.2-1.el7            epel             98 k\n\nTransaction Summary\n&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;\nInstall  1 Package\n\nTotal download size: 98 k\nInstalled size: 207 k\nDownloading packages:\nRunning transaction check\nRunning transaction test\nTransaction test succeeded\nRunning transaction\n  Installing : htop-2.0.2-1.el7.x86_64                                      1&#x2F;1 \n  Verifying  : htop-2.0.2-1.el7.x86_64                                      1&#x2F;1 \n\nInstalled:\n  htop.x86_64 0:2.0.2-1.el7                                                     \n\nComplete!\n&quot;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">192.168.37.133 | SUCCESS &#x3D;&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;msg&quot;: &quot;Warning: RPMDB altered outside of yum.\n** Found 3 pre-existing rpmdb problem(s), &#39;yum check&#39; output follows:\nipa-client-4.4.0-12.el7.centos.x86_64 has installed conflicts freeipa-client: ipa-client-4.4.0-12.el7.centos.x86_64\nipa-client-common-4.4.0-12.el7.centos.noarch has installed conflicts freeipa-client-common: ipa-client-common-4.4.0-12.el7.centos.noarch\nipa-common-4.4.0-12.el7.centos.noarch has installed conflicts freeipa-common: ipa-common-4.4.0-12.el7.centos.noarch\n&quot;, </span><br><span class="line">    &quot;rc&quot;: 0, </span><br><span class="line">    &quot;results&quot;: [</span><br><span class="line">        &quot;Loaded plugins: fastestmirror, langpacks\nLoading mirror speeds from cached hostfile\nResolving Dependencies\n--&gt; Running transaction check\n---&gt; Package htop.x86_64 0:2.0.2-1.el7 will be installed\n--&gt; Finished Dependency Resolution\n\nDependencies Resolved\n\n&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;\n Package         Arch              Version                Repository       Size\n&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;\nInstalling:\n htop            x86_64            2.0.2-1.el7            epel             98 k\n\nTransaction Summary\n&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;\nInstall  1 Package\n\nTotal download size: 98 k\nInstalled size: 207 k\nDownloading packages:\nRunning transaction check\nRunning transaction test\nTransaction test succeeded\nRunning transaction\n  Installing : htop-2.0.2-1.el7.x86_64                                      1&#x2F;1 \n  Verifying  : htop-2.0.2-1.el7.x86_64                                      1&#x2F;1 \n\nInstalled:\n  htop.x86_64 0:2.0.2-1.el7                                                     \n\nComplete!\n&quot;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>　　安装成功。</p>
<h3 id="9、service-模块"><a href="#9、service-模块" class="headerlink" title="9、service 模块"></a>9、service 模块</h3><p>　　该模块用于服务程序的管理。<br> 　　其主要选项如下：</p>
<blockquote>
<p><code>arguments</code> #命令行提供额外的参数<br><code>enabled</code>     #设置开机启动。<br><code>name=</code> #服务名称<br><code>runlevel</code> #开机启动的级别，一般不用指定。<br><code>sleep</code> #在重启服务的过程中，是否等待。如在服务关闭以后等待2秒再启动。(定义在剧本中。)<br><code>state</code> #有四种状态，分别为：<code>started</code>—&gt;启动服务， <code>stopped</code>—&gt;停止服务， <code>restarted</code>—&gt;重启服务， <code>reloaded</code>—&gt;重载配置</p>
</blockquote>
<p>　　下面是一些例子：<br><strong>① 开启服务并设置自启动</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]# ansible web -m service -a &#39;name&#x3D;nginx state&#x3D;started enabled&#x3D;true&#39; </span><br><span class="line">192.168.37.122 | SUCCESS &#x3D;&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;enabled&quot;: true, </span><br><span class="line">    &quot;name&quot;: &quot;nginx&quot;, </span><br><span class="line">    &quot;state&quot;: &quot;started&quot;, </span><br><span class="line">    ……</span><br><span class="line">&#125;</span><br><span class="line">192.168.37.133 | SUCCESS &#x3D;&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;enabled&quot;: true, </span><br><span class="line">    &quot;name&quot;: &quot;nginx&quot;, </span><br><span class="line">    &quot;state&quot;: &quot;started&quot;, </span><br><span class="line">    ……</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>　　我们可以去查看一下端口是否打开：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]# ansible web -m shell -a &#39;ss -ntl&#39;</span><br><span class="line">192.168.37.122 | SUCCESS | rc&#x3D;0 &gt;&gt;</span><br><span class="line">State      Recv-Q Send-Q Local Address:Port               Peer Address:Port              </span><br><span class="line">LISTEN     0      128          *:80                       *:*                                  </span><br><span class="line"></span><br><span class="line">192.168.37.133 | SUCCESS | rc&#x3D;0 &gt;&gt;</span><br><span class="line">State      Recv-Q Send-Q Local Address:Port               Peer Address:Port                    </span><br><span class="line">LISTEN     0      128          *:80                       *:*</span><br></pre></td></tr></table></figure>

<p>　　可以看出我们的80端口已经打开。<br><strong>② 关闭服务</strong><br> 　　我们也可以通过该模块来关闭我们的服务：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]# ansible web -m service -a &#39;name&#x3D;nginx state&#x3D;stopped&#39;</span><br><span class="line">192.168.37.122 | SUCCESS &#x3D;&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;name&quot;: &quot;nginx&quot;, </span><br><span class="line">    &quot;state&quot;: &quot;stopped&quot;, </span><br><span class="line">    ……</span><br><span class="line">&#125;</span><br><span class="line">192.168.37.133 | SUCCESS &#x3D;&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;name&quot;: &quot;nginx&quot;, </span><br><span class="line">    &quot;state&quot;: &quot;stopped&quot;, </span><br><span class="line">    ……</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>　　一样的，我们来查看一下端口：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]# ansible web -m shell -a &#39;ss -ntl | grep 80&#39;</span><br><span class="line">192.168.37.122 | FAILED | rc&#x3D;1 &gt;&gt;</span><br><span class="line"></span><br><span class="line">192.168.37.133 | FAILED | rc&#x3D;1 &gt;&gt;</span><br></pre></td></tr></table></figure>

<p>　　可以看出，我们已经没有80端口了，说明我们的nginx服务已经关闭了。</p>
<h3 id="10、user-模块"><a href="#10、user-模块" class="headerlink" title="10、user 模块"></a>10、user 模块</h3><p>　　该模块主要是用来管理用户账号。<br> 　　其主要选项如下：</p>
<blockquote>
<p><code>comment</code>　　# 用户的描述信息<br><code>createhome</code>　　# 是否创建家目录<br><code>force</code>　　# 在使用state=absent时, 行为与userdel –force一致.<br><code>group</code>　　# 指定基本组<br><code>groups</code>　　# 指定附加组，如果指定为(groups=)表示删除所有组<br><code>home</code>　　    # 指定用户家目录<br><code>move_home</code>　　# 如果设置为home=时, 试图将用户主目录移动到指定的目录<br><code>name</code>　　# 指定用户名<br><code>non_unique</code>　　# 该选项允许改变非唯一的用户ID值<br><code>password</code>　　# 指定用户密码<br><code>remove</code>　　# 在使用state=absent时, 行为是与userdel –remove一致<br><code>shell</code>　　# 指定默认shell<br><code>state</code>　　# 设置帐号状态，不指定为创建，指定值为absent表示删除<br><code>system</code>　　# 当创建一个用户，设置这个用户是系统用户。这个设置不能更改现有用户<br><code>uid</code>　　# 指定用户的uid</p>
</blockquote>
<p>　　举例如下：<br><strong>① 添加一个用户并指定其 uid</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]# ansible web -m user -a &#39;name&#x3D;keer uid&#x3D;11111&#39;</span><br><span class="line">192.168.37.122 | SUCCESS &#x3D;&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;comment&quot;: &quot;&quot;, </span><br><span class="line">    &quot;createhome&quot;: true, </span><br><span class="line">    &quot;group&quot;: 11111, </span><br><span class="line">    &quot;home&quot;: &quot;&#x2F;home&#x2F;keer&quot;, </span><br><span class="line">    &quot;name&quot;: &quot;keer&quot;, </span><br><span class="line">    &quot;shell&quot;: &quot;&#x2F;bin&#x2F;bash&quot;, </span><br><span class="line">    &quot;state&quot;: &quot;present&quot;, </span><br><span class="line">    &quot;stderr&quot;: &quot;useradd: warning: the home directory already exists.\nNot copying any file from skel directory into it.\nCreating mailbox file: File exists\n&quot;, </span><br><span class="line">    &quot;system&quot;: false, </span><br><span class="line">    &quot;uid&quot;: 11111</span><br><span class="line">&#125;</span><br><span class="line">192.168.37.133 | SUCCESS &#x3D;&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;comment&quot;: &quot;&quot;, </span><br><span class="line">    &quot;createhome&quot;: true, </span><br><span class="line">    &quot;group&quot;: 11111, </span><br><span class="line">    &quot;home&quot;: &quot;&#x2F;home&#x2F;keer&quot;, </span><br><span class="line">    &quot;name&quot;: &quot;keer&quot;, </span><br><span class="line">    &quot;shell&quot;: &quot;&#x2F;bin&#x2F;bash&quot;, </span><br><span class="line">    &quot;state&quot;: &quot;present&quot;, </span><br><span class="line">    &quot;stderr&quot;: &quot;useradd: warning: the home directory already exists.\nNot copying any file from skel directory into it.\nCreating mailbox file: File exists\n&quot;, </span><br><span class="line">    &quot;system&quot;: false, </span><br><span class="line">    &quot;uid&quot;: 11111</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>　　添加完成，我们可以去查看一下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]# ansible web -m shell -a &#39;cat &#x2F;etc&#x2F;passwd |grep keer&#39;</span><br><span class="line">192.168.37.122 | SUCCESS | rc&#x3D;0 &gt;&gt;</span><br><span class="line">keer:x:11111:11111::&#x2F;home&#x2F;keer:&#x2F;bin&#x2F;bash</span><br><span class="line"></span><br><span class="line">192.168.37.133 | SUCCESS | rc&#x3D;0 &gt;&gt;</span><br><span class="line">keer:x:11111:11111::&#x2F;home&#x2F;keer:&#x2F;bin&#x2F;bash</span><br></pre></td></tr></table></figure>

<p><strong>② 删除用户</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]# ansible web -m user -a &#39;name&#x3D;keer state&#x3D;absent&#39;</span><br><span class="line">192.168.37.122 | SUCCESS &#x3D;&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;force&quot;: false, </span><br><span class="line">    &quot;name&quot;: &quot;keer&quot;, </span><br><span class="line">    &quot;remove&quot;: false, </span><br><span class="line">    &quot;state&quot;: &quot;absent&quot;</span><br><span class="line">&#125;</span><br><span class="line">192.168.37.133 | SUCCESS &#x3D;&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;force&quot;: false, </span><br><span class="line">    &quot;name&quot;: &quot;keer&quot;, </span><br><span class="line">    &quot;remove&quot;: false, </span><br><span class="line">    &quot;state&quot;: &quot;absent&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>　　一样的，删除之后，我们去看一下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]# ansible web -m shell -a &#39;cat &#x2F;etc&#x2F;passwd |grep keer&#39;</span><br><span class="line">192.168.37.122 | FAILED | rc&#x3D;1 &gt;&gt;</span><br><span class="line"></span><br><span class="line">192.168.37.133 | FAILED | rc&#x3D;1 &gt;&gt;</span><br></pre></td></tr></table></figure>

<p>　　发现已经没有这个用户了。</p>
<h3 id="11、group-模块"><a href="#11、group-模块" class="headerlink" title="11、group 模块"></a>11、group 模块</h3><p>　　该模块主要用于添加或删除组。<br> 　　常用的选项如下：</p>
<blockquote>
<p><code>gid=</code>　　#设置组的GID号<br><code>name=</code>　　#指定组的名称<br><code>state=</code>　　#指定组的状态，默认为创建，设置值为<code>absent</code>为删除<br><code>system=</code>　　#设置值为<code>yes</code>，表示创建为系统组</p>
</blockquote>
<p>　　举例如下：<br><strong>① 创建组</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]# ansible web -m group -a &#39;name&#x3D;sanguo gid&#x3D;12222&#39;</span><br><span class="line">192.168.37.122 | SUCCESS &#x3D;&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;gid&quot;: 12222, </span><br><span class="line">    &quot;name&quot;: &quot;sanguo&quot;, </span><br><span class="line">    &quot;state&quot;: &quot;present&quot;, </span><br><span class="line">    &quot;system&quot;: false</span><br><span class="line">&#125;</span><br><span class="line">192.168.37.133 | SUCCESS &#x3D;&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;gid&quot;: 12222, </span><br><span class="line">    &quot;name&quot;: &quot;sanguo&quot;, </span><br><span class="line">    &quot;state&quot;: &quot;present&quot;, </span><br><span class="line">    &quot;system&quot;: false</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>　　创建过后，我们来查看一下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]# ansible web -m shell -a &#39;cat &#x2F;etc&#x2F;group | grep 12222&#39; </span><br><span class="line">192.168.37.122 | SUCCESS | rc&#x3D;0 &gt;&gt;</span><br><span class="line">sanguo:x:12222:</span><br><span class="line"></span><br><span class="line">192.168.37.133 | SUCCESS | rc&#x3D;0 &gt;&gt;</span><br><span class="line">sanguo:x:12222:</span><br></pre></td></tr></table></figure>

<p>　　可以看出，我们的组已经创建成功了。<br><strong>② 删除组</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]# ansible web -m group -a &#39;name&#x3D;sanguo state&#x3D;absent&#39;</span><br><span class="line">192.168.37.122 | SUCCESS &#x3D;&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;name&quot;: &quot;sanguo&quot;, </span><br><span class="line">    &quot;state&quot;: &quot;absent&quot;</span><br><span class="line">&#125;</span><br><span class="line">192.168.37.133 | SUCCESS &#x3D;&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;name&quot;: &quot;sanguo&quot;, </span><br><span class="line">    &quot;state&quot;: &quot;absent&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>　　照例查看一下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]# ansible web -m shell -a &#39;cat &#x2F;etc&#x2F;group | grep 12222&#39; </span><br><span class="line">192.168.37.122 | FAILED | rc&#x3D;1 &gt;&gt;</span><br><span class="line"></span><br><span class="line">192.168.37.133 | FAILED | rc&#x3D;1 &gt;&gt;</span><br></pre></td></tr></table></figure>

<p>　　已经没有这个组的相关信息了。</p>
<h3 id="12、script-模块"><a href="#12、script-模块" class="headerlink" title="12、script 模块"></a>12、script 模块</h3><p>　　该模块用于将本机的脚本在被管理端的机器上运行。<br> 　　该模块直接指定脚本的路径即可，我们通过例子来看一看到底如何使用的：<br> 　　首先，我们写一个脚本，并给其加上执行权限：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]# vim &#x2F;tmp&#x2F;df.sh</span><br><span class="line">    #!&#x2F;bin&#x2F;bash</span><br><span class="line">    date &gt;&gt; &#x2F;tmp&#x2F;disk_total.log</span><br><span class="line">    df -lh &gt;&gt; &#x2F;tmp&#x2F;disk_total.log </span><br><span class="line">[root@server ~]# chmod +x &#x2F;tmp&#x2F;df.sh</span><br></pre></td></tr></table></figure>

<p>　　然后，我们直接运行命令来实现在被管理端执行该脚本：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]# ansible web -m script -a &#39;&#x2F;tmp&#x2F;df.sh&#39;</span><br><span class="line">192.168.37.122 | SUCCESS &#x3D;&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;rc&quot;: 0, </span><br><span class="line">    &quot;stderr&quot;: &quot;Shared connection to 192.168.37.122 closed.\r\n&quot;, </span><br><span class="line">    &quot;stdout&quot;: &quot;&quot;, </span><br><span class="line">    &quot;stdout_lines&quot;: []</span><br><span class="line">&#125;</span><br><span class="line">192.168.37.133 | SUCCESS &#x3D;&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;rc&quot;: 0, </span><br><span class="line">    &quot;stderr&quot;: &quot;Shared connection to 192.168.37.133 closed.\r\n&quot;, </span><br><span class="line">    &quot;stdout&quot;: &quot;&quot;, </span><br><span class="line">    &quot;stdout_lines&quot;: []</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>　　照例查看一下文件内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]# ansible web -m shell -a &#39;cat &#x2F;tmp&#x2F;disk_total.log&#39;</span><br><span class="line">192.168.37.122 | SUCCESS | rc&#x3D;0 &gt;&gt;</span><br><span class="line">Tue Dec  5 15:58:21 CST 2017</span><br><span class="line">Filesystem      Size  Used Avail Use% Mounted on</span><br><span class="line">&#x2F;dev&#x2F;sda2        47G  4.4G   43G  10% &#x2F;</span><br><span class="line">devtmpfs        978M     0  978M   0% &#x2F;dev</span><br><span class="line">tmpfs           993M   84K  993M   1% &#x2F;dev&#x2F;shm</span><br><span class="line">tmpfs           993M  9.1M  984M   1% &#x2F;run</span><br><span class="line">tmpfs           993M     0  993M   0% &#x2F;sys&#x2F;fs&#x2F;cgroup</span><br><span class="line">&#x2F;dev&#x2F;sda3        47G   33M   47G   1% &#x2F;app</span><br><span class="line">&#x2F;dev&#x2F;sda1       950M  153M  798M  17% &#x2F;boot</span><br><span class="line">tmpfs           199M   16K  199M   1% &#x2F;run&#x2F;user&#x2F;42</span><br><span class="line">tmpfs           199M     0  199M   0% &#x2F;run&#x2F;user&#x2F;0</span><br><span class="line"></span><br><span class="line">192.168.37.133 | SUCCESS | rc&#x3D;0 &gt;&gt;</span><br><span class="line">Tue Dec  5 15:58:21 CST 2017</span><br><span class="line">Filesystem      Size  Used Avail Use% Mounted on</span><br><span class="line">&#x2F;dev&#x2F;sda2        46G  4.1G   40G  10% &#x2F;</span><br><span class="line">devtmpfs        898M     0  898M   0% &#x2F;dev</span><br><span class="line">tmpfs           912M   84K  912M   1% &#x2F;dev&#x2F;shm</span><br><span class="line">tmpfs           912M  9.0M  903M   1% &#x2F;run</span><br><span class="line">tmpfs           912M     0  912M   0% &#x2F;sys&#x2F;fs&#x2F;cgroup</span><br><span class="line">&#x2F;dev&#x2F;sda3       3.7G   15M  3.4G   1% &#x2F;app</span><br><span class="line">&#x2F;dev&#x2F;sda1       1.9G  141M  1.6G   9% &#x2F;boot</span><br><span class="line">tmpfs           183M   16K  183M   1% &#x2F;run&#x2F;user&#x2F;42</span><br><span class="line">tmpfs           183M     0  183M   0% &#x2F;run&#x2F;user&#x2F;0</span><br></pre></td></tr></table></figure>

<p>　　可以看出已经执行成功了。</p>
<h3 id="13、setup-模块"><a href="#13、setup-模块" class="headerlink" title="13、setup 模块"></a>13、setup 模块</h3><p>　　该模块主要用于收集信息，是通过调用facts组件来实现的。<br> 　　facts组件是Ansible用于采集被管机器设备信息的一个功能，我们可以使用setup模块查机器的所有facts信息，可以使用filter来查看指定信息。整个facts信息被包装在一个JSON格式的数据结构中，ansible_facts是最上层的值。<br> 　　facts就是变量，内建变量 。每个主机的各种信息，cpu颗数、内存大小等。会存在facts中的某个变量中。调用后返回很多对应主机的信息，在后面的操作中可以根据不同的信息来做不同的操作。如redhat系列用yum安装，而debian系列用apt来安装软件。<br><strong>① 查看信息</strong><br> 　　我们可以直接用命令获取到变量的值，具体我们来看看例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]# ansible web -m setup -a &#39;filter&#x3D;&quot;*mem*&quot;&#39;   #查看内存</span><br><span class="line">192.168.37.122 | SUCCESS &#x3D;&gt; &#123;</span><br><span class="line">    &quot;ansible_facts&quot;: &#123;</span><br><span class="line">        &quot;ansible_memfree_mb&quot;: 1116, </span><br><span class="line">        &quot;ansible_memory_mb&quot;: &#123;</span><br><span class="line">            &quot;nocache&quot;: &#123;</span><br><span class="line">                &quot;free&quot;: 1397, </span><br><span class="line">                &quot;used&quot;: 587</span><br><span class="line">            &#125;, </span><br><span class="line">            &quot;real&quot;: &#123;</span><br><span class="line">                &quot;free&quot;: 1116, </span><br><span class="line">                &quot;total&quot;: 1984, </span><br><span class="line">                &quot;used&quot;: 868</span><br><span class="line">            &#125;, </span><br><span class="line">            &quot;swap&quot;: &#123;</span><br><span class="line">                &quot;cached&quot;: 0, </span><br><span class="line">                &quot;free&quot;: 3813, </span><br><span class="line">                &quot;total&quot;: 3813, </span><br><span class="line">                &quot;used&quot;: 0</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, </span><br><span class="line">        &quot;ansible_memtotal_mb&quot;: 1984</span><br><span class="line">    &#125;, </span><br><span class="line">    &quot;changed&quot;: false</span><br><span class="line">&#125;</span><br><span class="line">192.168.37.133 | SUCCESS &#x3D;&gt; &#123;</span><br><span class="line">    &quot;ansible_facts&quot;: &#123;</span><br><span class="line">        &quot;ansible_memfree_mb&quot;: 1203, </span><br><span class="line">        &quot;ansible_memory_mb&quot;: &#123;</span><br><span class="line">            &quot;nocache&quot;: &#123;</span><br><span class="line">                &quot;free&quot;: 1470, </span><br><span class="line">                &quot;used&quot;: 353</span><br><span class="line">            &#125;, </span><br><span class="line">            &quot;real&quot;: &#123;</span><br><span class="line">                &quot;free&quot;: 1203, </span><br><span class="line">                &quot;total&quot;: 1823, </span><br><span class="line">                &quot;used&quot;: 620</span><br><span class="line">            &#125;, </span><br><span class="line">            &quot;swap&quot;: &#123;</span><br><span class="line">                &quot;cached&quot;: 0, </span><br><span class="line">                &quot;free&quot;: 3813, </span><br><span class="line">                &quot;total&quot;: 3813, </span><br><span class="line">                &quot;used&quot;: 0</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, </span><br><span class="line">        &quot;ansible_memtotal_mb&quot;: 1823</span><br><span class="line">    &#125;, </span><br><span class="line">    &quot;changed&quot;: false</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>　　我们可以通过命令查看一下内存的大小以确认一下是否一致：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]# ansible web -m shell -a &#39;free -m&#39;</span><br><span class="line">192.168.37.122 | SUCCESS | rc&#x3D;0 &gt;&gt;</span><br><span class="line">              total        used        free      shared  buff&#x2F;cache   available</span><br><span class="line">Mem:           1984         404        1122           9         457        1346</span><br><span class="line">Swap:          3813           0        3813</span><br><span class="line"></span><br><span class="line">192.168.37.133 | SUCCESS | rc&#x3D;0 &gt;&gt;</span><br><span class="line">              total        used        free      shared  buff&#x2F;cache   available</span><br><span class="line">Mem:           1823         292        1207           9         323        1351</span><br><span class="line">Swap:          3813           0        3813</span><br></pre></td></tr></table></figure>

<p>　　可以看出信息是一致的。<br><strong>② 保存信息</strong><br> 　　我们的setup模块还有一个很好用的功能就是可以保存我们所筛选的信息至我们的主机上，同时，文件名为我们被管制的主机的IP，这样方便我们知道是哪台机器出的问题。<br> 　　我们可以看一看例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">[root@server tmp]# ansible web -m setup -a &#39;filter&#x3D;&quot;*mem*&quot;&#39; --tree &#x2F;tmp&#x2F;facts</span><br><span class="line">192.168.37.122 | SUCCESS &#x3D;&gt; &#123;</span><br><span class="line">    &quot;ansible_facts&quot;: &#123;</span><br><span class="line">        &quot;ansible_memfree_mb&quot;: 1115, </span><br><span class="line">        &quot;ansible_memory_mb&quot;: &#123;</span><br><span class="line">            &quot;nocache&quot;: &#123;</span><br><span class="line">                &quot;free&quot;: 1396, </span><br><span class="line">                &quot;used&quot;: 588</span><br><span class="line">            &#125;, </span><br><span class="line">            &quot;real&quot;: &#123;</span><br><span class="line">                &quot;free&quot;: 1115, </span><br><span class="line">                &quot;total&quot;: 1984, </span><br><span class="line">                &quot;used&quot;: 869</span><br><span class="line">            &#125;, </span><br><span class="line">            &quot;swap&quot;: &#123;</span><br><span class="line">                &quot;cached&quot;: 0, </span><br><span class="line">                &quot;free&quot;: 3813, </span><br><span class="line">                &quot;total&quot;: 3813, </span><br><span class="line">                &quot;used&quot;: 0</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, </span><br><span class="line">        &quot;ansible_memtotal_mb&quot;: 1984</span><br><span class="line">    &#125;, </span><br><span class="line">    &quot;changed&quot;: false</span><br><span class="line">&#125;</span><br><span class="line">192.168.37.133 | SUCCESS &#x3D;&gt; &#123;</span><br><span class="line">    &quot;ansible_facts&quot;: &#123;</span><br><span class="line">        &quot;ansible_memfree_mb&quot;: 1199, </span><br><span class="line">        &quot;ansible_memory_mb&quot;: &#123;</span><br><span class="line">            &quot;nocache&quot;: &#123;</span><br><span class="line">                &quot;free&quot;: 1467, </span><br><span class="line">                &quot;used&quot;: 356</span><br><span class="line">            &#125;, </span><br><span class="line">            &quot;real&quot;: &#123;</span><br><span class="line">                &quot;free&quot;: 1199, </span><br><span class="line">                &quot;total&quot;: 1823, </span><br><span class="line">                &quot;used&quot;: 624</span><br><span class="line">            &#125;, </span><br><span class="line">            &quot;swap&quot;: &#123;</span><br><span class="line">                &quot;cached&quot;: 0, </span><br><span class="line">                &quot;free&quot;: 3813, </span><br><span class="line">                &quot;total&quot;: 3813, </span><br><span class="line">                &quot;used&quot;: 0</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, </span><br><span class="line">        &quot;ansible_memtotal_mb&quot;: 1823</span><br><span class="line">    &#125;, </span><br><span class="line">    &quot;changed&quot;: false</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>　　然后我们可以去查看一下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]# cd &#x2F;tmp&#x2F;facts&#x2F;</span><br><span class="line">[root@server facts]# ls</span><br><span class="line">192.168.37.122  192.168.37.133</span><br><span class="line">[root@server facts]# cat 192.168.37.122 </span><br><span class="line">&#123;&quot;ansible_facts&quot;: &#123;&quot;ansible_memfree_mb&quot;: 1115, &quot;ansible_memory_mb&quot;: &#123;&quot;nocache&quot;: &#123;&quot;free&quot;: 1396, &quot;used&quot;: 588&#125;, &quot;real&quot;: &#123;&quot;free&quot;: 1115, &quot;total&quot;: 1984, &quot;used&quot;: 869&#125;, &quot;swap&quot;: &#123;&quot;cached&quot;: 0, &quot;free&quot;: 3813, &quot;total&quot;: 3813, &quot;used&quot;: 0&#125;&#125;, &quot;ansible_memtotal_mb&quot;: 1984&#125;, &quot;changed&quot;: false&#125;</span><br></pre></td></tr></table></figure>

<h2 id="六、Ansible-playbook-简介"><a href="#六、Ansible-playbook-简介" class="headerlink" title="六、Ansible playbook 简介"></a>六、Ansible playbook 简介</h2><p>　　<strong>playbook 是 ansible 用于配置，部署，和管理被控节点的剧本。</strong><br>　　通过 playbook 的详细描述，执行其中的一系列 tasks ，可以让远端主机达到预期的状态。playbook 就像 Ansible 控制器给被控节点列出的的一系列 to-do-list ，而被控节点必须要完成。<br>　　也可以这么理解，playbook 字面意思，即剧本，现实中由演员按照剧本表演，在Ansible中，这次由计算机进行表演，由计算机安装，部署应用，提供对外服务，以及组织计算机处理各种各样的事情。</p>
<h2 id="七、Ansible-playbook使用场景"><a href="#七、Ansible-playbook使用场景" class="headerlink" title="七、Ansible playbook使用场景"></a>七、Ansible playbook使用场景</h2><p>　　执行一些简单的任务，使用ad-hoc命令可以方便的解决问题，但是有时一个设施过于复杂，需要大量的操作时候，执行的ad-hoc命令是不适合的，这时最好使用playbook。<br>　　就像执行shell命令与写shell脚本一样，也可以理解为批处理任务，不过playbook有自己的语法格式。<br>　　使用playbook你可以方便的重用这些代码，可以移植到不同的机器上面，像函数一样，最大化的利用代码。在你使用Ansible的过程中，你也会发现，你所处理的大部分操作都是编写playbook。可以把常见的应用都编写成playbook，之后管理服务器会变得十分简单。</p>
<h2 id="八、Ansible-playbook格式"><a href="#八、Ansible-playbook格式" class="headerlink" title="八、Ansible playbook格式"></a>八、Ansible playbook格式</h2><h3 id="1、格式简介"><a href="#1、格式简介" class="headerlink" title="1、格式简介"></a>1、格式简介</h3><p>　　<strong>playbook由YMAL语言编写。</strong>YAML( /ˈjæməl/ )参考了其他多种语言，包括：XML、C语言、Python、Perl以及电子邮件格式RFC2822，Clark Evans在2001年5月在首次发表了这种语言，另外Ingy döt Net与OrenBen-Kiki也是这语言的共同设计者。<br>　　YMAL格式是类似于JSON的文件格式，便于人理解和阅读，同时便于书写。首先学习了解一下YMAL的格式，对我们后面书写playbook很有帮助。以下为playbook常用到的YMAL格式：<br>　　1、文件的第一行应该以 “—“ (三个连字符)开始，表明YMAL文件的开始。<br>　　2、在同一行中，#之后的内容表示注释，类似于shell，python和ruby。<br>　　3、YMAL中的列表元素以”-”开头然后紧跟着一个空格，后面为元素内容。<br>　　4、同一个列表中的元素应该保持相同的缩进。否则会被当做错误处理。<br>　　5、play中hosts，variables，roles，tasks等对象的表示方法都是键值中间以”:”分隔表示，”:”后面还要增加一个空格。<br>　　下面是一个举例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">#安装与运行mysql服务</span><br><span class="line">- hosts: node1</span><br><span class="line">  remote_user: root</span><br><span class="line">  tasks:  </span><br><span class="line">    - name: install mysql-server package</span><br><span class="line">      yum: name&#x3D;mysql-server state&#x3D;present</span><br><span class="line">    - name: starting mysqld service</span><br><span class="line">      service: name&#x3D;mysql state&#x3D;started</span><br></pre></td></tr></table></figure>

<p>　　我们的文件名称应该以<code>.yml</code>结尾，像我们上面的例子就是<code>mysql.yml</code>。其中，有三个部分组成：</p>
<blockquote>
<p><code>host部分</code>：使用 hosts 指示使用哪个主机或主机组来运行下面的 tasks ，每个 playbook 都必须指定 hosts ，hosts也<strong>可以使用通配符格式</strong>。主机或主机组在 inventory 清单中指定，可以使用系统默认的<code>/etc/ansible/hosts</code>，也可以自己编辑，在运行的时候加上<code>-i</code>选项，指定清单的位置即可。在运行清单文件的时候，<code>–list-hosts</code>选项会显示那些主机将会参与执行 task 的过程中。<br><code>remote_user</code>：指定远端主机中的哪个用户来登录远端系统，在远端系统执行 task 的用户，可以任意指定，也可以使用 sudo，但是用户必须要有执行相应 task 的权限。<br><code>tasks</code>：指定远端主机将要执行的一系列动作。tasks 的核心为 ansible 的模块，前面已经提到模块的用法。tasks 包含 <code>name</code> 和<code>要执行的模块</code>，name 是可选的，只是为了便于用户阅读，不过还是建议加上去，模块是必须的，同时也要给予模块相应的参数。</p>
</blockquote>
<p>　　使用ansible-playbook运行playbook文件，得到如下输出信息，输出内容为JSON格式。并且由不同颜色组成，便于识别。一般而言<br>| 绿色代表执行成功，系统保持原样<br>| 黄色代表系统代表系统状态发生改变<br>| 红色代表执行失败，显示错误输出<br>　　执行有三个步骤：1、收集facts  2、执行tasks  3、报告结果</p>
<h3 id="2、核心元素"><a href="#2、核心元素" class="headerlink" title="2、核心元素"></a>2、核心元素</h3><p>　　Playbook的核心元素：</p>
<blockquote>
<p><code>Hosts</code>：主机组；<br><code>Tasks</code>：任务列表；<br><code>Variables</code>：变量，设置方式有四种；<br><code>Templates</code>：包含了模板语法的文本文件；<br><code>Handlers</code>：由特定条件触发的任务；</p>
</blockquote>
<h3 id="3、基本组件"><a href="#3、基本组件" class="headerlink" title="3、基本组件"></a>3、基本组件</h3><p>　　Playbooks配置文件的基础组件：</p>
<blockquote>
<p><code>Hosts</code>：运行指定任务的目标主机<br><code>remote_user</code>：在远程主机上执行任务的用户；<br><code>sudo_user</code>：<br><code>tasks</code>：任务列表</p>
<p>　　格式：<br>　　　　tasks：<br>　　　　　　– name: TASK_NAME<br>　　　　　　 module: arguments<br>　　　　　　 notify: HANDLER_NAME<br>　　　　　　 handlers:<br>　　　　　　– name: HANDLER_NAME<br>　　　　　　 module: arguments</p>
</blockquote>
<blockquote>
<p><code>模块，模块参数</code>：</p>
<p>　　格式：<br>　　　　(1) action: module arguments<br>　　　　(2) module: arguments<br>　　　　注意：shell和command模块后面直接跟命令，而非key=value类的参数列表；</p>
</blockquote>
<blockquote>
<p><code>handlers</code>：任务，在特定条件下触发；接收到其它任务的通知时被触发；</p>
</blockquote>
<p>　　(1) 某任务的状态在运行后为changed时，可通过“notify”通知给相应的handlers；<br>　　(2) 任务可以通过“tags“打标签，而后可在ansible-playbook命令上使用-t指定进行调用；</p>
<h5 id="举例"><a href="#举例" class="headerlink" title="举例"></a>举例</h5><p><strong>① 定义playbook</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]# cd &#x2F;etc&#x2F;ansible</span><br><span class="line">[root@server ansible]# vim nginx.yml</span><br><span class="line">---</span><br><span class="line">- hosts: web</span><br><span class="line">  remote_user: root</span><br><span class="line">  tasks:</span><br><span class="line">    - name: install nginx</span><br><span class="line">      yum: name&#x3D;nginx state&#x3D;present</span><br><span class="line">    - name: copy nginx.conf</span><br><span class="line">      copy: src&#x3D;&#x2F;tmp&#x2F;nginx.conf dest&#x3D;&#x2F;etc&#x2F;nginx&#x2F;nginx.conf backup&#x3D;yes</span><br><span class="line">      notify: reload　　　　#当nginx.conf发生改变时，通知给相应的handlers</span><br><span class="line">      tags: reloadnginx　　　#打标签</span><br><span class="line">    - name: start nginx service</span><br><span class="line">      service: name&#x3D;nginx state&#x3D;started</span><br><span class="line">      tags: startnginx　　　#打标签</span><br><span class="line"></span><br><span class="line">  handlers:　　#注意，前面没有-，是两个空格</span><br><span class="line">    - name: reload</span><br><span class="line">      service: name&#x3D;nginx state&#x3D;restarted　　#为了在进程中能看出来</span><br></pre></td></tr></table></figure>

<p><strong>② 测试运行结果</strong><br>　　写完了以后，我们就可以运行了：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@server ansible]# ansible-playbook nginx.yml</span><br></pre></td></tr></table></figure>

<p>　　现在我们可以看看两台机器的端口是否开启：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@server ansible]# ansible web -m shell -a &#39;ss -nutlp |grep nginx&#39;</span><br><span class="line">192.168.37.122 | SUCCESS | rc&#x3D;0 &gt;&gt;</span><br><span class="line">tcp    LISTEN     0      128       *:80                    *:*                   users:((&quot;nginx&quot;,pid&#x3D;8304,fd&#x3D;6),(&quot;nginx&quot;,pid&#x3D;8303,fd&#x3D;6))</span><br><span class="line"></span><br><span class="line">192.168.37.133 | SUCCESS | rc&#x3D;0 &gt;&gt;</span><br><span class="line">tcp    LISTEN     0      128       *:80                    *:*                   users:((&quot;nginx&quot;,pid&#x3D;9671,fd&#x3D;6),(&quot;nginx&quot;,pid&#x3D;9670,fd&#x3D;6))</span><br></pre></td></tr></table></figure>

<p><strong>③ 测试标签</strong><br>　　我们在里面已经打上了一个标签，所以可以直接引用标签。但是我们需要先把服务关闭，再来运行剧本并引用标签：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@server ansible]# ansible web -m shell -a &#39;systemctl stop nginx&#39;</span><br><span class="line">[root@server ansible]# ansible-playbook nginx.yml -t startnginx</span><br></pre></td></tr></table></figure>

<p><strong>④ 测试notify</strong><br>　　我们还做了一个<code>notify</code>，来测试一下：<br>　　首先，它的触发条件是配置文件被改变，所以我们去把配置文件中的端口改一下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@server ansible]# vim &#x2F;tmp&#x2F;nginx.conf</span><br><span class="line">    listen       8080;</span><br></pre></td></tr></table></figure>

<p>　　然后我们重新加载一下这个剧本：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@server ansible]# ansible-playbook nginx.yml -t reloadnginx</span><br></pre></td></tr></table></figure>

<p>　　发现我们执行的就是reload段以及我们定义的<code>notify</code>部分。<br>　　我们来看一看我们的端口号：</p>
<p>　　发现我们执行的就是reload段以及我们定义的<code>notify</code>部分。<br>　　我们来看一看我们的端口号：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@server ansible]# ansible web -m shell -a &#39;ss -ntlp | grep nginx&#39;</span><br><span class="line">192.168.37.122 | SUCCESS | rc&#x3D;0 &gt;&gt;</span><br><span class="line">LISTEN     0      128          *:8080                     *:*                   users:((&quot;nginx&quot;,pid&#x3D;2097,fd&#x3D;6),(&quot;nginx&quot;,pid&#x3D;2096,fd&#x3D;6))</span><br><span class="line"></span><br><span class="line">192.168.37.133 | SUCCESS | rc&#x3D;0 &gt;&gt;</span><br><span class="line">LISTEN     0      128          *:8080                     *:*                   users:((&quot;nginx&quot;,pid&#x3D;3061,fd&#x3D;6),(&quot;nginx&quot;,pid&#x3D;3060,fd&#x3D;6))</span><br></pre></td></tr></table></figure>

<p>　　可以看出，我们的nginx端口已经变成了8080。　　</p>
<h3 id="4、variables-部分"><a href="#4、variables-部分" class="headerlink" title="4、variables 部分"></a>4、variables 部分</h3><p>　　上文中，我们说到了<code>variables</code>是变量，有四种定义方法，现在我们就来说说这四种定义方法：</p>
<h4 id="①-facts-：可直接调用"><a href="#①-facts-：可直接调用" class="headerlink" title="① facts ：可直接调用"></a>① facts ：可直接调用</h4><p>　　上一篇中，我们有说到<code>setup</code>这个模块，这个模块就是通过调用facts组件来实现的。我们这里的<code>variables</code>也可以直接调用<code>facts</code>组件。<br>　　具体的<code>facters</code>我们可以使用<code>setup</code>模块来获取，然后直接放入我们的剧本中调用即可。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">ansible_all_ipv4_addresses：仅显示ipv4的信息 ---&gt; [u&#39;192.168.95.143&#39;]</span><br><span class="line">ansible_eth0[&#39;ipv4&#39;][&#39;address&#39;]：仅显示ipv4的信息 ---&gt; eth0 的ip地址</span><br><span class="line">ansible_devices：仅显示磁盘设备信息</span><br><span class="line">ansible_distribution：显示是什么系统，例：centos,suse等</span><br><span class="line">ansible_distribution_version：仅显示系统版本</span><br><span class="line">ansible_machine：显示系统类型，例：32位，还是64位</span><br><span class="line">ansible_eth0：仅显示eth0的信息</span><br><span class="line">ansible_hostname：仅显示主机名</span><br><span class="line">ansible_kernel：仅显示内核版本</span><br><span class="line">ansible_lvm：显示lvm相关信息</span><br><span class="line">ansible_memtotal_mb：显示系统总内存</span><br><span class="line">ansible_memfree_mb：显示可用系统内存</span><br><span class="line">ansible_memory_mb：详细显示内存情况</span><br><span class="line">ansible_swaptotal_mb：显示总的swap内存</span><br><span class="line">ansible_swapfree_mb：显示swap内存的可用内存</span><br><span class="line">ansible_mounts：显示系统磁盘挂载情况</span><br><span class="line">ansible_processor：显示cpu个数(具体显示每个cpu的型号)</span><br><span class="line">ansible_processor_vcpus：显示cpu个数(只显示总的个数)</span><br><span class="line">ansible_python_version：显示python版本</span><br></pre></td></tr></table></figure>

<p>例如：批量修改主机 host 文件</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">web</span>  </span><br><span class="line">  <span class="attr">vars:</span>        </span><br><span class="line">    <span class="attr">IP:</span> <span class="string">"<span class="template-variable">&#123;&#123; ansible_eth0['ipv4']['address'] &#125;&#125;</span>"</span>  </span><br><span class="line">  <span class="attr">tasks:</span>        </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">将原有的hosts文件备份</span>          </span><br><span class="line">    <span class="attr">shell:</span> <span class="string">mv</span> <span class="string">/etc/hosts</span> <span class="string">/etc/hosts_bak</span>        </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">将ansible端的hosts复制到各自机器上</span>          </span><br><span class="line">    <span class="attr">copy:</span> <span class="string">src=/root/hosts</span> <span class="string">dest=/etc/</span> <span class="string">owner=root</span> <span class="string">group=root</span> <span class="string">mode=0644</span>        </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">在新的hosts文件后面追加各自机器内网ip和hostname</span>          </span><br><span class="line">    <span class="attr">lineinfile:</span> <span class="string">dest=/etc/hosts</span> <span class="string">line="&#123;&#123;</span> <span class="string">IP</span> <span class="string">&#125;&#125;</span>  <span class="string">&#123;&#123;</span> <span class="string">ansible_hostname</span> <span class="string">&#125;&#125;"</span></span><br></pre></td></tr></table></figure>

<h4 id="②-用户自定义变量"><a href="#②-用户自定义变量" class="headerlink" title="② 用户自定义变量"></a>② 用户自定义变量</h4><p>　　我们也可以直接使用用户自定义变量，想要自定义变量有以下两种方式：</p>
<blockquote>
<p>通过命令行传入</p>
</blockquote>
<p>　　<code>ansible-playbook</code>命令的命令行中的<code>-e VARS, --extra-vars=VARS</code>，这样就可以直接把自定义的变量传入。</p>
<blockquote>
<p>在playbook中定义变量</p>
</blockquote>
<p>　　我们也可以直接在playbook中定义我们的变量：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vars:</span><br><span class="line">　　- var1: value1</span><br><span class="line">　　- var2: value2</span><br></pre></td></tr></table></figure>

<h5 id="举例-1"><a href="#举例-1" class="headerlink" title="举例"></a>举例</h5><p><strong>① 定义剧本</strong><br>　　我们就使用全局替换把我们刚刚编辑的文件修改一下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@server ansible]# vim nginx.yml</span><br></pre></td></tr></table></figure>

<p><img src="https://s1.ax1x.com/2020/04/16/JEZEz8.png" alt="JEZEz8.png"><br><img src="https://s1.ax1x.com/2020/04/16/JEZmLQ.png" alt="JEZmLQ.png">　　这样一来，我们的剧本就定义完成了。<br><strong>② 拷贝配置文件</strong><br>　　我们想要在被监管的机器上安装什么服务的话，就直接在我们的server端上把该服务的配置文件拷贝到我们的<code>/tmp/</code>目录下。这样我们的剧本才能正常运行。<br>　　我们就以<code>keepalived</code>服务为例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@server ansible]# cp /etc/keepalived/keepalived.conf /tmp/keepalived.conf</span><br></pre></td></tr></table></figure>

<p><strong>③ 运行剧本，变量由命令行传入</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@server ansible]# ansible-playbook nginx.yml -e rpmname&#x3D;keepalived</span><br></pre></td></tr></table></figure>

<p><img src="https://s1.ax1x.com/2020/04/16/JEZKds.png" alt="JEZKds.png"><br><strong>④ 修改剧本，直接定义变量</strong><br>　　同样的，我们可以直接在剧本中把变量定义好，这样就不需要在通过命令行传入了。以后想要安装不同的服务，直接在剧本里把变量修改一下即可。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@server ansible]# vim nginx.yml</span><br></pre></td></tr></table></figure>

<p>![img](E:/学习晋升文件汇总/Linux架构学习入门/4. network_manager/19-20天-企业自动化运维工具Aansible实战/assets/1204916-20171208112356562-1275040347.png)<br><strong>⑤ 运行定义过变量的剧本</strong><br>　　我们刚刚已经把变量定义在剧本里面了。现在我们来运行一下试试看：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@server ansible]# ansible-playbook nginx.yml</span><br></pre></td></tr></table></figure>

<p><img src="https://s1.ax1x.com/2020/04/16/JEZMon.png" alt="JEZMon.png"><br>　　发现这样也是可以的~</p>
<h4 id="③-通过roles传递变量"><a href="#③-通过roles传递变量" class="headerlink" title="③ 通过roles传递变量"></a>③ 通过roles传递变量</h4><p>　　具体的，我们下文中说到 roles 的时候再详细说明。</p>
<h4 id="④-Host-Inventory"><a href="#④-Host-Inventory" class="headerlink" title="④ Host Inventory"></a>④ Host Inventory</h4><p>　　我们也可以直接在主机清单中定义。<br>　　定义的方法如下：</p>
<blockquote>
<p>向不同的主机传递不同的变量：</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">　　IP&#x2F;HOSTNAME varaiable&#x3D;value var2&#x3D;value2</span><br></pre></td></tr></table></figure>

<blockquote>
<p>向组中的主机传递相同的变量：</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">　　[groupname:vars]</span><br><span class="line">　　variable&#x3D;value</span><br></pre></td></tr></table></figure>

<p>Ansible Inventory 内置参数</p>
<p>![Ansible Inventory 内置参数](E:/学习晋升文件汇总/Linux架构学习入门/4. network_manager/19-20天-企业自动化运维工具Aansible实战/assets/Ansible Inventory 内置参数.png)</p>
<p>使用内置变量把用户名密码写在Inventory中，也就是/etc/ansible/hosts文件里，缺点就是<strong>暴露了账号密码</strong>，不安全。如果有多个主机需要使用同样的变量，可以用组变量的形式，书写格式如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[web]</span></span><br><span class="line"><span class="number">192.168</span><span class="number">.100</span><span class="number">.10</span></span><br><span class="line"><span class="number">192.168</span><span class="number">.100</span><span class="number">.11</span></span><br><span class="line"><span class="number">192.168</span><span class="number">.100</span><span class="number">.12</span> </span><br><span class="line"><span class="string">[web:vars]</span>  <span class="comment">#给名为webservers的组定义一个变量，:vars是固定格式</span></span><br><span class="line"><span class="string">ansible_ssh_port=22</span></span><br><span class="line"><span class="string">ansible_ssh_user='root'</span></span><br><span class="line"><span class="string">ansible_ssh_pass='1234.com'</span></span><br></pre></td></tr></table></figure>

<h3 id="5、模板-templates"><a href="#5、模板-templates" class="headerlink" title="5、模板 templates"></a>5、模板 templates</h3><p>　　模板是一个文本文件，嵌套有脚本（使用模板编程语言编写）。<br>　　<code>Jinja2</code>：Jinja2是python的一种模板语言，以Django的模板语言为原本。<br>模板支持：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">　　字符串：使用单引号或双引号；</span><br><span class="line">　　数字：整数，浮点数；</span><br><span class="line">　　列表：[item1, item2, ...]</span><br><span class="line">　　元组：(item1, item2, ...)</span><br><span class="line">　　字典：&#123;key1:value1, key2:value2, ...&#125;</span><br><span class="line">　　布尔型：true&#x2F;false</span><br><span class="line">　　算术运算：</span><br><span class="line">　　　　+, -, *, &#x2F;, &#x2F;&#x2F;, %, **</span><br><span class="line">　　比较操作：</span><br><span class="line">　　　　&#x3D;&#x3D;, !&#x3D;, &gt;, &gt;&#x3D;, &lt;, &lt;&#x3D;</span><br><span class="line">　　逻辑运算：</span><br><span class="line">　　　　and, or, not</span><br></pre></td></tr></table></figure>

<p>　　通常来说，模板都是通过引用变量来运用的。</p>
<h5 id="举例-2"><a href="#举例-2" class="headerlink" title="举例"></a>举例</h5><p><strong>① 定义模板</strong><br>　　我们直接把之前定义的<code>/tmp/nginx.conf</code>改个名，然后编辑一下，就可以定义成我们的模板文件了：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@server ansible]# cd &#x2F;tmp</span><br><span class="line">[root@server tmp]# mv nginx.conf nginx.conf.j2</span><br><span class="line">[root@server tmp]# vim nginx.conf.j2</span><br><span class="line">    worker_processes  &#123;&#123; ansible_processor_vcpus &#125;&#125;;</span><br><span class="line">    listen       &#123;&#123; nginxport &#125;&#125;;</span><br></pre></td></tr></table></figure>

<p><strong>② 修改剧本</strong><br>　　我们现在需要去修改剧本来定义变量：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@server ansible]# vim nginx.yml</span><br></pre></td></tr></table></figure>

<p><a href="https://imgchr.com/i/JEZtL4" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2020/04/16/JEZtL4.png" alt="JEZtL4.png"></a><br>　　需要修改的部分如图所示。</p>
<p>  copy 也需要修改为 template</p>
<p><strong>③ 运行剧本</strong><br>　　上面的准备工作完成后，我们就可以去运行剧本了：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@server ansible]# ansible-playbook nginx.yml -t reloadnginx</span><br><span class="line"></span><br><span class="line">PLAY [web] *********************************************************************</span><br><span class="line"></span><br><span class="line">TASK [setup] *******************************************************************</span><br><span class="line">ok: [192.168.37.122]</span><br><span class="line">ok: [192.168.37.133]</span><br><span class="line"></span><br><span class="line">TASK [copy nginx.conf] *********************************************************</span><br><span class="line">ok: [192.168.37.122]</span><br><span class="line">ok: [192.168.37.133]</span><br><span class="line"></span><br><span class="line">PLAY RECAP *********************************************************************</span><br><span class="line">192.168.37.122             : ok&#x3D;2    changed&#x3D;0    unreachable&#x3D;0    failed&#x3D;0   </span><br><span class="line">192.168.37.133             : ok&#x3D;2    changed&#x3D;0    unreachable&#x3D;0    failed&#x3D;0</span><br></pre></td></tr></table></figure>

<h3 id="6、条件测试"><a href="#6、条件测试" class="headerlink" title="6、条件测试"></a>6、条件测试</h3><p>when语句：在task中使用，jinja2的语法格式。<br>举例如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">tasks:</span><br><span class="line">- name: install conf file to centos7</span><br><span class="line">  template: src&#x3D;files&#x2F;nginx.conf.c7.j2</span><br><span class="line">  when: ansible_distribution_major_version &#x3D;&#x3D; &quot;7&quot;</span><br><span class="line">- name: install conf file to centos6</span><br><span class="line">  template: src&#x3D;files&#x2F;nginx.conf.c6.j2</span><br><span class="line">  when: ansible_distribution_major_version &#x3D;&#x3D; &quot;6&quot;</span><br></pre></td></tr></table></figure>

<p>循环：迭代，需要重复执行的任务；<br>　　对迭代项的引用，固定变量名为”item”，而后，要在task中使用with_items给定要迭代的元素列表；<br>举例如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">tasks:</span><br><span class="line">- name: unstall web packages</span><br><span class="line">  yum: name&#x3D;&#123;&#123; item &#125;&#125; state&#x3D;absent</span><br><span class="line">  with_items:</span><br><span class="line">  - httpd</span><br><span class="line">  - php</span><br><span class="line">  - php-mysql</span><br></pre></td></tr></table></figure>

<h3 id="7、字典"><a href="#7、字典" class="headerlink" title="7、字典"></a>7、字典</h3><p>　　ansible playbook 还支持字典功能。举例如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">- name: install some packages</span><br><span class="line">  yum: name&#x3D;&#123;&#123; item &#125;&#125; state&#x3D;present</span><br><span class="line">  with_items:</span><br><span class="line">    - nginx</span><br><span class="line">    - memcached</span><br><span class="line">    - php-fpm</span><br><span class="line">- name: add some groups</span><br><span class="line">  group: name&#x3D;&#123;&#123; item &#125;&#125; state&#x3D;present</span><br><span class="line">  with_items:</span><br><span class="line">    - group11</span><br><span class="line">    - group12</span><br><span class="line">    - group13</span><br><span class="line">- name: add some users</span><br><span class="line">  user: name&#x3D;&#123;&#123; item.name &#125;&#125; group&#x3D;&#123;&#123; item.group &#125;&#125; state&#x3D;present</span><br><span class="line">  with_items:</span><br><span class="line">    - &#123; name: &#39;user11&#39;, group: &#39;group11&#39; &#125;</span><br><span class="line">    - &#123; name: &#39;user12&#39;, group: &#39;group12&#39; &#125;</span><br><span class="line">    - &#123; name: &#39;user13&#39;, group: &#39;group13&#39; &#125;</span><br></pre></td></tr></table></figure>

<h3 id="8、角色订制：roles"><a href="#8、角色订制：roles" class="headerlink" title="8、角色订制：roles"></a>8、角色订制：roles</h3><h4 id="①-简介"><a href="#①-简介" class="headerlink" title="① 简介"></a>① 简介</h4><p>　　对于以上所有的方式有个弊端就是无法实现复用假设在同时部署Web、db、ha 时或不同服务器组合不同的应用就需要写多个yml文件。很难实现灵活的调用。<br>　　roles 用于层次性、结构化地组织playbook。roles 能够根据层次型结构自动装载变量文件、tasks以及handlers等。要使用roles只需要在playbook中使用include指令即可。简单来讲，roles就是通过分别将变量(vars)、文件(file)、任务(tasks)、模块(modules)及处理器(handlers)放置于单独的目录中，并可以便捷地include它们的一种机制。角色一般用于基于主机构建服务的场景中，但也可以是用于构建守护进程等场景中。</p>
<h4 id="②-角色集合"><a href="#②-角色集合" class="headerlink" title="② 角色集合"></a>② 角色集合</h4><p>角色集合：roles/<br>mysql/<br>httpd/<br>nginx/<br>files/：存储由copy或script等模块调用的文件；<br>tasks/：此目录中至少应该有一个名为main.yml的文件，用于定义各task；其它的文件需要由main.yml进行“包含”调用；<br>handlers/：此目录中至少应该有一个名为main.yml的文件，用于定义各handler；其它的文件需要由main.yml进行“包含”调用；<br>vars/：此目录中至少应该有一个名为main.yml的文件，用于定义各variable；其它的文件需要由main.yml进行“包含”调用；<br>templates/：存储由template模块调用的模板文本；<br>meta/：此目录中至少应该有一个名为main.yml的文件，定义当前角色的特殊设定及其依赖关系；其它的文件需要由main.yml进行“包含”调用；<br>default/：此目录中至少应该有一个名为main.yml的文件，用于设定默认变量；</p>
<h4 id="③-角色定制实例"><a href="#③-角色定制实例" class="headerlink" title="③ 角色定制实例"></a>③ 角色定制实例</h4><p><strong>1. 在roles目录下生成对应的目录结构</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[root@server ansible]# cd roles&#x2F;</span><br><span class="line">[root@server roles]# ls</span><br><span class="line">[root@server roles]# mkdir -pv .&#x2F;&#123;nginx,mysql,httpd&#125;&#x2F;&#123;files,templates,vars,tasks,handlers,meta,default&#125;</span><br><span class="line">[root@server roles]# tree</span><br><span class="line">.</span><br><span class="line">├── httpd</span><br><span class="line">│   ├── default</span><br><span class="line">│   ├── files</span><br><span class="line">│   ├── handlers</span><br><span class="line">│   ├── meta</span><br><span class="line">│   ├── tasks</span><br><span class="line">│   ├── templates</span><br><span class="line">│   └── vars</span><br><span class="line">├── mysql</span><br><span class="line">│   ├── default</span><br><span class="line">│   ├── files</span><br><span class="line">│   ├── handlers</span><br><span class="line">│   ├── meta</span><br><span class="line">│   ├── tasks</span><br><span class="line">│   ├── templates</span><br><span class="line">│   └── vars</span><br><span class="line">└── nginx</span><br><span class="line">    ├── default</span><br><span class="line">    ├── files</span><br><span class="line">    ├── handlers</span><br><span class="line">    ├── meta</span><br><span class="line">    ├── tasks</span><br><span class="line">    ├── templates</span><br><span class="line">    └── vars</span><br><span class="line"></span><br><span class="line">24 directories, 0 files</span><br></pre></td></tr></table></figure>

<p><strong>2. 定义配置文件</strong><br>　　我们需要修改的配置文件为<code>/tasks/main.yml</code>，下面，我们就来修改一下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@server roles]# vim nginx&#x2F;tasks&#x2F;main.yml</span><br><span class="line">- name: cp</span><br><span class="line">  copy: src&#x3D;nginx-1.10.2-1.el7.ngx.x86_64.rpm dest&#x3D;&#x2F;tmp&#x2F;nginx-1.10.2-1.el7.ngx.x86_64.rpm</span><br><span class="line">- name: install</span><br><span class="line">  yum: name&#x3D;&#x2F;tmp&#x2F;nginx-1.10.2-1.el7.ngx.x86_64.rpm state&#x3D;latest</span><br><span class="line">- name: conf</span><br><span class="line">  template: src&#x3D;nginx.conf.j2 dest&#x3D;&#x2F;etc&#x2F;nginx&#x2F;nginx.conf</span><br><span class="line">  tags: nginxconf</span><br><span class="line">  notify: new conf to reload</span><br><span class="line">- name: start service</span><br><span class="line">  service: name&#x3D;nginx state&#x3D;started enabled&#x3D;true</span><br></pre></td></tr></table></figure>

<p><strong>3. 放置我们所需要的文件到指定目录</strong><br>　　因为我们定义的角色已经有了新的组成方式，所以我们需要把文件都放到指定的位置，这样，才能让配置文件找到这些并进行加载。<br>　　rpm包放在<code>files</code>目录下，模板放在<code>templates</code>目录下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@server nginx]# cp &#x2F;tmp&#x2F;nginx-1.10.2-1.el7.ngx.x86_64.rpm .&#x2F;files&#x2F;</span><br><span class="line">[root@server nginx]# cp &#x2F;tmp&#x2F;nginx.conf.j2 .&#x2F;templates&#x2F;</span><br><span class="line">[root@server nginx]# tree</span><br><span class="line">.</span><br><span class="line">├── default</span><br><span class="line">├── files</span><br><span class="line">│   └── nginx-1.10.2-1.el7.ngx.x86_64.rpm</span><br><span class="line">├── handlers</span><br><span class="line">├── meta</span><br><span class="line">├── tasks</span><br><span class="line">│   └── main.yml</span><br><span class="line">├── templates</span><br><span class="line">│   └── nginx.conf.j2</span><br><span class="line">└── vars</span><br><span class="line"></span><br><span class="line">7 directories, 3 files</span><br></pre></td></tr></table></figure>

<p><strong>4. 修改变量文件</strong><br>　　我们在模板中定义的变量，也要去配置文件中加上：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@server nginx]# vim vars&#x2F;main.yml</span><br><span class="line">nginxprot: 9999</span><br></pre></td></tr></table></figure>

<p><strong>5. 定义handlers文件</strong><br>　　我们在配置文件中定义了<code>notify</code>，所以我么也需要定义<code>handlers</code>，我们来修改配置文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@server nginx]# vim handlers&#x2F;main.yml</span><br><span class="line">- name: new conf to reload</span><br><span class="line">  service: name&#x3D;nginx state&#x3D;restarted</span><br></pre></td></tr></table></figure>

<p><strong>6. 定义剧本文件</strong><br>　　接下来，我们就来定义剧本文件，由于大部分设置我们都单独配置在了roles里面，所以，接下来剧本就只需要写一点点内容即可：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@server ansible]# vim roles.yml </span><br><span class="line">- hosts: web</span><br><span class="line">  remote_user: root</span><br><span class="line">  roles:</span><br><span class="line">    - nginx</span><br></pre></td></tr></table></figure>

<p><strong>7. 启动服务</strong><br>　　剧本定义完成以后，我们就可以来启动服务了：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[root@server ansible]# ansible-playbook roles.yml</span><br><span class="line"></span><br><span class="line">PLAY [web] *********************************************************************</span><br><span class="line"></span><br><span class="line">TASK [setup] *******************************************************************</span><br><span class="line">ok: [192.168.37.122]</span><br><span class="line">ok: [192.168.37.133]</span><br><span class="line"></span><br><span class="line">TASK [nginx : cp] **************************************************************</span><br><span class="line">ok: [192.168.37.122]</span><br><span class="line">ok: [192.168.37.133]</span><br><span class="line"></span><br><span class="line">TASK [nginx : install] *********************************************************</span><br><span class="line">changed: [192.168.37.122]</span><br><span class="line">changed: [192.168.37.133]</span><br><span class="line"></span><br><span class="line">TASK [nginx : conf] ************************************************************</span><br><span class="line">changed: [192.168.37.122]</span><br><span class="line">changed: [192.168.37.133]</span><br><span class="line"></span><br><span class="line">TASK [nginx : start service] ***************************************************</span><br><span class="line">changed: [192.168.37.122]</span><br><span class="line">changed: [192.168.37.133]</span><br><span class="line"></span><br><span class="line">RUNNING HANDLER [nginx : new conf to reload] ***********************************</span><br><span class="line">changed: [192.168.37.122]</span><br><span class="line">changed: [192.168.37.133]</span><br><span class="line"></span><br><span class="line">PLAY RECAP *********************************************************************</span><br><span class="line">192.168.37.122             : ok&#x3D;6    changed&#x3D;4    unreachable&#x3D;0    failed&#x3D;0   </span><br><span class="line">192.168.37.133             : ok&#x3D;6    changed&#x3D;4    unreachable&#x3D;0    failed&#x3D;0</span><br></pre></td></tr></table></figure>

<p>　　启动过后照例查看端口号：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@server ansible]# ansible web -m shell -a &quot;ss -ntulp |grep 9999&quot;</span><br><span class="line">192.168.37.122 | SUCCESS | rc&#x3D;0 &gt;&gt;</span><br><span class="line">tcp    LISTEN     0      128       *:9999                  *:*                   users:((&quot;nginx&quot;,pid&#x3D;7831,fd&#x3D;6),(&quot;nginx&quot;,pid&#x3D;7830,fd&#x3D;6),(&quot;nginx&quot;,pid&#x3D;7829,fd&#x3D;6))</span><br><span class="line"></span><br><span class="line">192.168.37.133 | SUCCESS | rc&#x3D;0 &gt;&gt;</span><br><span class="line">tcp    LISTEN     0      128       *:9999                  *:*                   users:((&quot;nginx&quot;,pid&#x3D;9654,fd&#x3D;6),(&quot;nginx&quot;,pid&#x3D;9653,fd&#x3D;6),(&quot;nginx&quot;,pid&#x3D;9652,fd&#x3D;6))</span><br></pre></td></tr></table></figure>

<p>　　可以看出我们的剧本已经执行成功。</p>
<h2 id="九、Ansible使用jinja2管理配置文件以及jinja2语法简介"><a href="#九、Ansible使用jinja2管理配置文件以及jinja2语法简介" class="headerlink" title="九、Ansible使用jinja2管理配置文件以及jinja2语法简介"></a>九、Ansible使用jinja2管理配置文件以及jinja2语法简介</h2><h3 id="1、Jinja2介绍"><a href="#1、Jinja2介绍" class="headerlink" title="1、Jinja2介绍"></a>1、Jinja2介绍</h3><p>Jinja2是基于python的模板引擎，功能比较类似于PHP的smarty，J2ee的Freemarker和velocity。它能完全支持unicode，并具有集成的沙箱执行环境，应用广泛。jinja2使用BSD授权</p>
<p>Jinja2的语法是由variables(变量)和statement(语句)组成，如下；</p>
<h4 id="1、variables：可以输出数据"><a href="#1、variables：可以输出数据" class="headerlink" title="1、variables：可以输出数据"></a>1、variables：可以输出数据</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">my_variables</span><br></pre></td></tr></table></figure>



<h4 id="2、statements-可以用来创建条件和循环等"><a href="#2、statements-可以用来创建条件和循环等" class="headerlink" title="2、statements: 可以用来创建条件和循环等"></a>2、statements: 可以用来创建条件和循环等</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>语句：</span><br><span class="line">&#123;% <span class="keyword">if</span> my_conditional %&#125; </span><br><span class="line">...</span><br><span class="line">&#123;% endif %&#125;</span><br><span class="line"><span class="keyword">for</span> 语句：</span><br><span class="line">&#123;% <span class="keyword">for</span> item <span class="keyword">in</span> all_items %&#125;</span><br><span class="line">`item` </span><br><span class="line">……</span><br><span class="line">&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure>

<p>从上面第二个variables的例子中可以看出，jinja2支持使用带过滤器的Unix型管道操作符，有很多的内置过滤器可供使用。我们可以仅仅用一堆简单if和for就可以建立几乎任何的常规配置文件，不过如果你有意更进一步，jinja2 documentation （<a href="http://jinja.pocoo.org/docs/dev/）包含了很多有趣的东西可供了解。我们可以看到ansible允许在模板中使用诸如绘制时间此类的一些额外的模板变量" target="_blank" rel="noopener">http://jinja.pocoo.org/docs/dev/）包含了很多有趣的东西可供了解。我们可以看到ansible允许在模板中使用诸如绘制时间此类的一些额外的模板变量</a></p>
<p>第一个例子：引用变量</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#cd roles/template/</span></span><br><span class="line">.</span><br><span class="line">├── meta</span><br><span class="line">│   └── main.yml</span><br><span class="line">├── tasks</span><br><span class="line">│   ├── template.yml  </span><br><span class="line">│   └── main.yml</span><br><span class="line">├── templates</span><br><span class="line">│   ├── order.j2</span><br><span class="line">└── vars</span><br><span class="line">    └── main.yml</span><br></pre></td></tr></table></figure>

<p>总调度yml文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#cat templates.yml</span></span><br><span class="line">---</span><br><span class="line">- hosts: 10.0.90.27</span><br><span class="line">  user: root</span><br><span class="line">  gather_facts: <span class="literal">false</span></span><br><span class="line">  roles:</span><br><span class="line">   - role: template</span><br></pre></td></tr></table></figure>

<p>注意:这里 - role: template 和 - template 是一样的！</p>
<p>其他yml文件，如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#cat tasks/main.yml</span></span><br><span class="line">- include: template.yml</span><br><span class="line"></span><br><span class="line"><span class="comment">#cat tasks/template.yml</span></span><br><span class="line">- name: create &#123;&#123; PROJECT &#125;&#125; directory</span><br><span class="line">  file: dest=/data/&#123;&#123; PROJECT &#125;&#125; state=directory</span><br><span class="line">- name: template transfor java dir</span><br><span class="line">  template: src=order.j2 dest=/data/&#123;&#123; PROJECT &#125;&#125;/order.conf</span><br><span class="line">  </span><br><span class="line"><span class="comment">#cat templates/order.j2</span></span><br><span class="line">project: &#123;&#123; PROJECT &#125;&#125;</span><br><span class="line">switch: &#123;&#123; SWITCH &#125;&#125;</span><br><span class="line">dbport: &#123;&#123; DBPORT &#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#cat vars/main.yml</span></span><br><span class="line">PROJECT: <span class="string">"JAVA"</span></span><br><span class="line">SWITCH: <span class="string">"ON"</span></span><br><span class="line">DBPORT: <span class="string">"8080"</span></span><br><span class="line"></span><br><span class="line">测试：</span><br><span class="line"><span class="comment"># ansible-playbook templates.yml --syntax-check</span></span><br><span class="line">playbook: templates.yml</span><br><span class="line"></span><br><span class="line">执行：</span><br><span class="line"><span class="comment"># ansible-playbook templates.yml </span></span><br><span class="line">PLAY [10.0.90.27] **************************************************************</span><br><span class="line">TASK [template : include] ***************************************************</span><br><span class="line">included: /etc/ansible/roles/template/tasks/template.yml <span class="keyword">for</span> 10.0.90.27</span><br><span class="line">TASK [template : create JAVA directory] *************************************</span><br><span class="line">changed: [10.0.90.27]</span><br><span class="line">TASK [template : template transfor java dir] ********************************</span><br><span class="line">changed: [10.0.90.27]</span><br><span class="line">PLAY RECAP *********************************************************************</span><br><span class="line">10.0.90.27                 : ok=3    changed=2    unreachable=0    failed=0   </span><br><span class="line"><span class="comment">#到10.0.90.27查看结果</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#cat /data/JAVA/order.conf</span></span><br><span class="line">project: JAVA</span><br><span class="line">switch: ON</span><br><span class="line">dbport: 8080</span><br></pre></td></tr></table></figure>

<p>第二个例子：for 语句</p>
<p>为远程主机生成服务器列表，加入该列表从192.168.13.201 web01.test.com 到192.168.13.211 web11.test.com 结束，如果手动添加就很不科学了，这里需要使用jinja2语法的for循环通过模板批量生成对应的配置文件，如下：</p>
<p>ansible目录结构：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#cd /etc/ansible/roles/test_hosts</span></span><br><span class="line">.</span><br><span class="line">├── meta</span><br><span class="line">│   └── main.yml</span><br><span class="line">├── tasks</span><br><span class="line">│   ├── file1.yml</span><br><span class="line">│   └── main.yml</span><br><span class="line">├── templates</span><br><span class="line">│   └── test1.j2</span><br><span class="line">└── vars</span><br><span class="line">    └── main.yml</span><br></pre></td></tr></table></figure>

<p>各个目录下yml文件内容：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat tasks/file1.yml </span></span><br><span class="line">- name: ansible jinja2 template <span class="keyword">for</span> hosts config</span><br><span class="line">  template: src=test1.j2 dest=/etc/httpd/conf/httpd.conf.test</span><br><span class="line">  </span><br><span class="line"><span class="comment"># cat tasks/main.yml </span></span><br><span class="line">- include: file1.yml</span><br><span class="line"></span><br><span class="line"><span class="comment"># cat templates/test1.j2 </span></span><br><span class="line">&#123;% <span class="keyword">for</span> id <span class="keyword">in</span> range(201,212) %&#125;</span><br><span class="line">192.168.13.&#123;&#123; id &#125;&#125; web&#123;&#123; <span class="string">"%03d"</span> |format(id-200) &#125;&#125;.test.com</span><br><span class="line">&#123;% endfor %&#125;</span><br><span class="line">解释：</span><br><span class="line">&#123;&#123; id &#125;&#125; 提取<span class="keyword">for</span>循环中对应的变量id值</span><br><span class="line"><span class="string">"%02d"</span>   调用的是python内置的字符串格式化输出（%d格式化整数）因为是01,02这种格式，所以是保留2位，故用02</span><br><span class="line">然后将结果通过管道符 “|” 传递给format 函数做二次处理。</span><br></pre></td></tr></table></figure>

<p>执行结果：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#cat httpd.conf.test</span></span><br><span class="line">192.168.13.201 web01.test.com</span><br><span class="line">192.168.13.202 web02.test.com</span><br><span class="line">192.168.13.203 web03.test.com</span><br><span class="line">192.168.13.204 web04.test.com</span><br><span class="line">192.168.13.205 web05.test.com</span><br><span class="line">192.168.13.206 web06.test.com</span><br><span class="line">192.168.13.207 web07.test.com</span><br><span class="line">192.168.13.208 web08.test.com</span><br><span class="line">192.168.13.209 web09.test.com</span><br><span class="line">192.168.13.210 web10.test.com</span><br><span class="line">192.168.13.211 web11.test.com</span><br></pre></td></tr></table></figure>

<p>第三个例子：if语句</p>
<p>说明：如果定义端口号，就绑定定义的端口号，如果不定义端口号，就绑定默认端口号</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ansible目录结果</span><br><span class="line"><span class="comment">#cd /etc/ansible/roles/mysql_cnf</span></span><br><span class="line"><span class="comment">#tree</span></span><br><span class="line">.</span><br><span class="line">├── meta</span><br><span class="line">│   └── main.yml</span><br><span class="line">├── tasks</span><br><span class="line">│   └── main.yml</span><br><span class="line">├── templates</span><br><span class="line">│   └── test3.j2</span><br><span class="line">└── vars</span><br></pre></td></tr></table></figure>

<p>主要的yml文件是templates目录下面的test3.j2</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat templates/test3.j2 </span></span><br><span class="line">&#123;% <span class="keyword">if</span> PORT %&#125;</span><br><span class="line">bind_address=10.0.90.27:&#123;&#123; PORT &#125;&#125;</span><br><span class="line">&#123;% <span class="keyword">else</span> %&#125;</span><br><span class="line">bind_address=10.0.90.27:3306</span><br><span class="line">&#123;% endif %&#125;</span><br></pre></td></tr></table></figure>

<p>playbook主文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat jinj2_test.yml </span></span><br><span class="line">---</span><br><span class="line">- hosts: 10.0.90.27</span><br><span class="line">  user: root</span><br><span class="line">  gather_facts: <span class="literal">false</span></span><br><span class="line">  vars:</span><br><span class="line">    PORT: 3136</span><br><span class="line">  tasks:</span><br><span class="line">    - name: copy file to client</span><br><span class="line">      template: src=/etc/ansible/roles/mysql_cnf/templates/test3.j2 dest=/root/my.cnf</span><br></pre></td></tr></table></figure>

<p>执行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ansible-playbook jinj2_test.yml</span></span><br><span class="line">PLAY [10.0.90.27] **************************************************************</span><br><span class="line">TASK [copy file to client] *****************************************************</span><br><span class="line">changed: [10.0.90.27]</span><br><span class="line">PLAY RECAP *********************************************************************</span><br><span class="line">10.0.90.27                 : ok=1    changed=1    unreachable=0    failed=0</span><br></pre></td></tr></table></figure>

<p>查看</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat my.cnf </span></span><br><span class="line">bind_address=10.0.90.27:3136</span><br></pre></td></tr></table></figure>

<p>如果将vars变量去掉，执行结果：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat jinj2_test.yml </span></span><br><span class="line">---</span><br><span class="line">- hosts: 10.0.90.27</span><br><span class="line">  user: root</span><br><span class="line">  gather_facts: <span class="literal">false</span></span><br><span class="line">  vars:</span><br><span class="line">    PORT: <span class="literal">false</span></span><br><span class="line">  tasks:</span><br><span class="line">    - name: copy file to client</span><br><span class="line">      template: src=/etc/ansible/roles/mysql_cnf/templates/test3.j2 dest=/root/my.cnf</span><br></pre></td></tr></table></figure>

<p>查看：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat my.cnf </span></span><br><span class="line">bind_address=10.0.90.27:3306</span><br></pre></td></tr></table></figure>

<h4 id="3、Jinja-default-设定"><a href="#3、Jinja-default-设定" class="headerlink" title="3、Jinja default()设定"></a>3、Jinja default()设定</h4><p>精通程序编码的朋友皆知，default()默认值的设定有助于程序的健壮性和简洁性。所幸Jinja也支持该功能，上面的例子中生成Mysql配置文件中的端口定义，如果指定则PORT=3136，否则PORT=3306，我们将该案例改造为使用default()试试</p>
<p>编辑/etc/ansible/roles/mysql_cnf/templates/test3.j2内容如下,这种方法更简介。</p>
<p>bind_address=10.0.90.27:3306</p>
<h3 id="2、ansible使用jiaja2生成apache多主机配置"><a href="#2、ansible使用jiaja2生成apache多主机配置" class="headerlink" title="2、ansible使用jiaja2生成apache多主机配置"></a>2、ansible使用jiaja2生成apache多主机配置</h3><h4 id="1、创建目录，创建好之后如下："><a href="#1、创建目录，创建好之后如下：" class="headerlink" title="1、创建目录，创建好之后如下："></a>1、创建目录，创建好之后如下：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#cd /etc/ansible/roles/apache_conf</span></span><br><span class="line"><span class="comment"># tree ./</span></span><br><span class="line">./</span><br><span class="line">├── meta</span><br><span class="line">│   └── main.yml</span><br><span class="line">├── tasks</span><br><span class="line">│   ├── file.yml</span><br><span class="line">│   └── main.yml</span><br><span class="line">├── templates</span><br><span class="line">│   └── apache.config.j2</span><br><span class="line">└── vars</span><br><span class="line">    └── main.yml</span><br><span class="line"></span><br><span class="line">4 directories, 5 files</span><br></pre></td></tr></table></figure>

<h4 id="2、创建tasks调度文件，如下："><a href="#2、创建tasks调度文件，如下：" class="headerlink" title="2、创建tasks调度文件，如下："></a>2、创建tasks调度文件，如下：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#cat file.yml </span></span><br><span class="line">- name: ansible jinja2 template <span class="keyword">for</span> apache config</span><br><span class="line">  template: src=apache.config.j2 dest=/etc/httpd/conf/httpd.conf.template</span><br><span class="line">  </span><br><span class="line"><span class="comment">#cat main.yml </span></span><br><span class="line">- include: file.yml</span><br></pre></td></tr></table></figure>

<h4 id="3、创建apache的jinja2模板文件，如下："><a href="#3、创建apache的jinja2模板文件，如下：" class="headerlink" title="3、创建apache的jinja2模板文件，如下："></a>3、创建apache的jinja2模板文件，如下：</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#cat apache.config.j2 </span></span><br><span class="line">NameVirtualHost *:<span class="number">80</span></span><br><span class="line">&#123;% <span class="keyword">for</span> vhost in apache_vhost %&#125;</span><br><span class="line">&lt;VirtualHost *:<span class="number">80</span>&gt;</span><br><span class="line">ServerName &#123;&#123; vhost.servername &#125;&#125;</span><br><span class="line">DocumentRoot &#123;&#123; vhost.documentroot &#125;&#125;</span><br><span class="line">&#123;% <span class="keyword">if</span> vhost.serveradmin is defined %&#125;</span><br><span class="line">ServerAdmin &#123;&#123; vhost.serveradmin &#125;&#125;</span><br><span class="line">&#123;% endif %&#125;</span><br><span class="line">&lt;Directory <span class="string">"&#123;&#123; vhost.documentroot &#125;&#125;"</span>&gt;</span><br><span class="line">AllowOverride All</span><br><span class="line">Options -Indexes FollowSymLinks</span><br><span class="line">Order allow,deny</span><br><span class="line">Allow from all</span><br><span class="line">&lt;/Directory&gt;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line">&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4、创建变量，如下："><a href="#4、创建变量，如下：" class="headerlink" title="4、创建变量，如下："></a>4、创建变量，如下：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#cat vars/main.yml</span></span><br><span class="line">apache_vhost:</span><br><span class="line">- &#123;servername: <span class="string">"apache.test1.com"</span>, documentroot: <span class="string">"/data/test1/"</span>&#125;</span><br><span class="line">- &#123;servername: <span class="string">"apache.test2.com"</span>, documentroot: <span class="string">"/data/test2/"</span>&#125;</span><br></pre></td></tr></table></figure>

<h4 id="5、创建总调度yml文件，如下："><a href="#5、创建总调度yml文件，如下：" class="headerlink" title="5、创建总调度yml文件，如下："></a>5、创建总调度yml文件，如下：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#cat /etc/ansible/apache_test.yml </span></span><br><span class="line">---</span><br><span class="line">- hosts: 10.0.90.27</span><br><span class="line">  user: root</span><br><span class="line">  gather_facts: no</span><br><span class="line">  roles:</span><br><span class="line">   - &#123; role: apache_conf &#125;</span><br></pre></td></tr></table></figure>

<h4 id="6、测试："><a href="#6、测试：" class="headerlink" title="6、测试："></a>6、测试：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ansible-playbook apache_test.yml --syntax-check</span></span><br><span class="line"></span><br><span class="line">playbook: apache_test.yml</span><br></pre></td></tr></table></figure>

<h4 id="7、执行测试"><a href="#7、执行测试" class="headerlink" title="7、执行测试"></a>7、执行测试</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ansible-playbook apache_test.yml </span></span><br><span class="line">PLAY [10.0.90.27] **************************************************************</span><br><span class="line">TASK [apache_conf : include] ***************************************************</span><br><span class="line">included: /etc/ansible/roles/apache_conf/tasks/file.yml <span class="keyword">for</span> 10.0.90.27</span><br><span class="line">TASK [apache_conf : ansible jinja2 template <span class="keyword">for</span> apache config] *****************</span><br><span class="line">changed: [10.0.90.27]</span><br><span class="line">PLAY RECAP *********************************************************************</span><br><span class="line">10.0.90.27                 : ok=2    changed=1    unreachable=0    failed=0</span><br></pre></td></tr></table></figure>

<h4 id="8、到客户端查看"><a href="#8、到客户端查看" class="headerlink" title="8、到客户端查看"></a>8、到客户端查看</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#cat httpd.conf.template </span></span><br><span class="line">NameVirtualHost *:80</span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">ServerName apache.test1.com</span><br><span class="line">DocumentRoot /data/test1/</span><br><span class="line">&lt;Directory <span class="string">"/data/test1/"</span>&gt;</span><br><span class="line">AllowOverride All</span><br><span class="line">Options -Indexes FollowSymLinks</span><br><span class="line">Order allow,deny</span><br><span class="line">Allow from all</span><br><span class="line">&lt;/Directory&gt;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">ServerName apache.test2.com</span><br><span class="line">DocumentRoot /data/test2/</span><br><span class="line">&lt;Directory <span class="string">"/data/test2/"</span>&gt;</span><br><span class="line">AllowOverride All</span><br><span class="line">Options -Indexes FollowSymLinks</span><br><span class="line">Order allow,deny</span><br><span class="line">Allow from all</span><br><span class="line">&lt;/Directory&gt;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br></pre></td></tr></table></figure>

<h2 id="3、ansible使用jiaja2生成nginx一个模板多种不同配置"><a href="#3、ansible使用jiaja2生成nginx一个模板多种不同配置" class="headerlink" title="3、ansible使用jiaja2生成nginx一个模板多种不同配置"></a>3、ansible使用jiaja2生成nginx一个模板多种不同配置</h2><p>说明：为2台Nginx Proxy，1台Nginx Web通过一套模板生成对应的配置</p>
<h4 id="1、ansible目录结构："><a href="#1、ansible目录结构：" class="headerlink" title="1、ansible目录结构："></a>1、ansible目录结构：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cd roles/nginx_conf/</span></span><br><span class="line"><span class="comment">#tree</span></span><br><span class="line">.</span><br><span class="line">├── files</span><br><span class="line">├── meta</span><br><span class="line">│   └── main.yml</span><br><span class="line">├── tasks</span><br><span class="line">│   ├── file.yml</span><br><span class="line">│   └── main.yml</span><br><span class="line">├── templates</span><br><span class="line">│   └── nginx.conf.j2</span><br><span class="line">└── vars</span><br><span class="line">    └── main.yml</span><br></pre></td></tr></table></figure>

<h4 id="2、tasks目录下文件内容："><a href="#2、tasks目录下文件内容：" class="headerlink" title="2、tasks目录下文件内容："></a>2、tasks目录下文件内容：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#cat tasks/file.yml </span></span><br><span class="line">- name: nginx.j2 template transfer example </span><br><span class="line">  template: src=nginx.conf.j2 dest=/etc/nginx/nginx.conf.template</span><br><span class="line">  </span><br><span class="line"><span class="comment">#cat tasks/main.yml </span></span><br><span class="line">- include: file.yml</span><br></pre></td></tr></table></figure>

<h4 id="3、nginx模板文件"><a href="#3、nginx模板文件" class="headerlink" title="3、nginx模板文件"></a>3、nginx模板文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#cat templates/nginx.conf.j2 </span></span><br><span class="line">&#123;% <span class="keyword">if</span> nginx_use_proxy %&#125;</span><br><span class="line">&#123;% <span class="keyword">for</span> proxy <span class="keyword">in</span> nginx_proxies %&#125;</span><br><span class="line">upstream &#123;&#123; proxy.name &#125;&#125;</span><br><span class="line">   <span class="comment">#server 127.0.0.1:&#123;&#123; proxy.port &#125;&#125;;</span></span><br><span class="line">   server &#123;&#123; ansible_eth0.ipv4.address &#125;&#125;:&#123;&#123; proxy.port &#125;&#125;;</span><br><span class="line">&#125;</span><br><span class="line">&#123;% endfor %&#125;</span><br><span class="line">&#123;% endif%&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    servername &#123;&#123; nginx_server_name &#125;&#125;;</span><br><span class="line">    access_log off;</span><br><span class="line">    error_log /etc/nginx/nginx_error.log;</span><br><span class="line">    rewrite ^ https://<span class="variable">$server_name</span><span class="variable">$request_uri</span>? permanent;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen 443 ssl;</span><br><span class="line">    server_name &#123;&#123; nginx_server_name &#125;&#125;;</span><br><span class="line">    ssl_certificate /etc/nginx/ssl/&#123;&#123; nginx_ssl_cert_name &#125;&#125;;</span><br><span class="line">    ssl_certificate_key /etc/nginx/ssl/&#123;&#123; nginx_ssl_cert_key &#125;&#125;;</span><br><span class="line">    root &#123;&#123; nginx_web_root &#125;&#125;;</span><br><span class="line">    index index.html index.html;</span><br><span class="line">&#123;% <span class="keyword">if</span> nginx_use_auth %&#125;</span><br><span class="line">   auth_basic  <span class="string">"Restricted"</span>;</span><br><span class="line">   auth_basic_user_file /etc/nginx/&#123;&#123; project_name &#125;&#125;.htpasswd;</span><br><span class="line">&#123;% endif %&#125;</span><br><span class="line">&#123;% <span class="keyword">if</span> nginx_use_proxy %&#125;</span><br><span class="line">&#123;% <span class="keyword">for</span> proxy <span class="keyword">in</span> nginx_proxies %&#125;</span><br><span class="line">   location &#123;&#123; proxy.location &#125;&#125; &#123;</span><br><span class="line">      proxy_set_header X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">      proxy_set_header X-Forwarded-Proto http;</span><br><span class="line">      proxy_set_header X-Url-Scheme <span class="variable">$scheme</span>;</span><br><span class="line">      proxy_set_header X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">      proxy_set_header Host <span class="variable">$http_host</span>;</span><br><span class="line">      proxy_set_header X-NginX-Proxy <span class="literal">true</span>;</span><br><span class="line">      proxy_redirect off;</span><br><span class="line">      proxy_pass http://&#123;&#123; proxy.name &#125;&#125;;</span><br><span class="line">      <span class="built_in">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#123;% endfor %&#125;</span><br><span class="line">&#123;% endif %&#125;</span><br><span class="line">&#123;% <span class="keyword">if</span> nginx_server_static %&#125;</span><br><span class="line">   location / &#123;</span><br><span class="line">       try_files <span class="variable">$url</span> <span class="variable">$url</span>/ =404;</span><br><span class="line">&#125;</span><br><span class="line">&#123;% endif %&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4、ansible变量文件"><a href="#4、ansible变量文件" class="headerlink" title="4、ansible变量文件"></a>4、ansible变量文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cat vars/main.yml </span><br><span class="line">nginx_server_name: www.testnginx.com</span><br><span class="line">nginx_web_root: /data/html/</span><br><span class="line">nginx_proxies:</span><br><span class="line">- name: suspicious</span><br><span class="line">  location: /</span><br><span class="line">  port: 1234</span><br><span class="line">- name: suspicious-api</span><br><span class="line">  location: /api</span><br><span class="line">  port: 4567</span><br></pre></td></tr></table></figure>

<h4 id="5、ansible主playbook文件"><a href="#5、ansible主playbook文件" class="headerlink" title="5、ansible主playbook文件"></a>5、ansible主playbook文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#cat nginx_test.yml </span></span><br><span class="line"><span class="comment">##The first roles</span></span><br><span class="line">- name: Nginx Proxy Server<span class="string">'s Config Dynamic Create</span></span><br><span class="line"><span class="string">  hosts: "10.0.90.25:10.0.90.26"</span></span><br><span class="line"><span class="string">  remote_user: root</span></span><br><span class="line"><span class="string">  vars:</span></span><br><span class="line"><span class="string">    nginx_use_proxy: true</span></span><br><span class="line"><span class="string">    nginx_ssl_cert_name: ifa.crt</span></span><br><span class="line"><span class="string">    nginx_ssl_cert_key: ifa.key</span></span><br><span class="line"><span class="string">    nginx_use_auth: true</span></span><br><span class="line"><span class="string">    project_name: suspicious</span></span><br><span class="line"><span class="string">    nginx_server_static: true</span></span><br><span class="line"><span class="string">  gather_facts: true</span></span><br><span class="line"><span class="string">  roles:</span></span><br><span class="line"><span class="string">     -  role: nginx_conf</span></span><br><span class="line"><span class="string">##The second roles</span></span><br><span class="line"><span class="string">- name: Nginx WebServer'</span>s Config Dynamic Create</span><br><span class="line">  hosts: 10.0.90.27</span><br><span class="line">  remote_user: root</span><br><span class="line">  vars:</span><br><span class="line">    nginx_use_proxy: <span class="literal">false</span></span><br><span class="line">    nginx_ssl_cert_name: ifa.crt</span><br><span class="line">    nginx_ssl_cert_key: ifa.crt</span><br><span class="line">    nginx_use_auth: <span class="literal">false</span></span><br><span class="line">    project_name: suspicious</span><br><span class="line">    nginx_server_static: <span class="literal">false</span></span><br><span class="line">  gather_facts: <span class="literal">false</span></span><br><span class="line">  roles:</span><br><span class="line">     -  role: nginx_conf</span><br></pre></td></tr></table></figure>

<h4 id="6、测试并执行："><a href="#6、测试并执行：" class="headerlink" title="6、测试并执行："></a>6、测试并执行：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ansible-playbook nginx_test.yml --syntax-check</span></span><br><span class="line">playbook: nginx_test.yml</span><br><span class="line"></span><br><span class="line">执行：</span><br><span class="line"><span class="comment"># ansible-playbook nginx_test.yml</span></span><br><span class="line">PLAY [Nginx Proxy Server<span class="string">'s Config Dynamic Create] ******************************</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">TASK [setup] *******************************************************************</span></span><br><span class="line"><span class="string">ok: [10.0.90.25]</span></span><br><span class="line"><span class="string">ok: [10.0.90.26]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">TASK [nginx_conf : include] ****************************************************</span></span><br><span class="line"><span class="string">included: /etc/ansible/roles/nginx_conf/tasks/file.yml for 10.0.90.25, 10.0.90.26</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">TASK [nginx_conf : nginx.j2 template transfer example] *************************</span></span><br><span class="line"><span class="string">changed: [10.0.90.26]</span></span><br><span class="line"><span class="string">changed: [10.0.90.25]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">PLAY [Nginx WebServer'</span>s Config Dynamic Create] *********************************</span><br><span class="line"></span><br><span class="line">TASK [nginx_conf : include] ****************************************************</span><br><span class="line">included: /etc/ansible/roles/nginx_conf/tasks/file.yml <span class="keyword">for</span> 10.0.90.27</span><br><span class="line"></span><br><span class="line">TASK [nginx_conf : nginx.j2 template transfer example] *************************</span><br><span class="line">changed: [10.0.90.27]</span><br><span class="line"></span><br><span class="line">PLAY RECAP *********************************************************************</span><br><span class="line">10.0.90.25                 : ok=3    changed=1    unreachable=0    failed=0   </span><br><span class="line">10.0.90.26                 : ok=3    changed=1    unreachable=0    failed=0   </span><br><span class="line">10.0.90.27                 : ok=2    changed=1    unreachable=0    failed=0</span><br></pre></td></tr></table></figure>

<h4 id="7、查看检测执行结果"><a href="#7、查看检测执行结果" class="headerlink" title="7、查看检测执行结果"></a>7、查看检测执行结果</h4><p>到Nginx Proxy 服务器查看配置文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#cat nginx.conf.template </span></span><br><span class="line">upstream suspicious</span><br><span class="line">   <span class="comment">#server 127.0.0.1:1234;</span></span><br><span class="line">   server 10.0.90.26:1234;</span><br><span class="line">&#125;</span><br><span class="line">upstream suspicious-api</span><br><span class="line">   <span class="comment">#server 127.0.0.1:4567;</span></span><br><span class="line">   server 10.0.90.26:4567;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    servername www.testnginx.com;</span><br><span class="line">    access_log off;</span><br><span class="line">    error_log /etc/nginx/nginx_error.log;</span><br><span class="line">    rewrite ^ https://<span class="variable">$server_name</span><span class="variable">$request_uri</span>? permanent;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen 443 ssl;</span><br><span class="line">    server_name www.testnginx.com;</span><br><span class="line">    ssl_certificate /etc/nginx/ssl/ifa.crt;</span><br><span class="line">    ssl_certificate_key /etc/nginx/ssl/ifa.key;</span><br><span class="line">    root /data/html/;</span><br><span class="line">    index index.html index.html;</span><br><span class="line">   auth_basic  <span class="string">"Restricted"</span>;</span><br><span class="line">   auth_basic_user_file /etc/nginx/suspicious.htpasswd;</span><br><span class="line">   location / &#123;</span><br><span class="line">      proxy_set_header X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">      proxy_set_header X-Forwarded-Proto http;</span><br><span class="line">      proxy_set_header X-Url-Scheme <span class="variable">$scheme</span>;</span><br><span class="line">      proxy_set_header X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">      proxy_set_header Host <span class="variable">$http_host</span>;</span><br><span class="line">      proxy_set_header X-NginX-Proxy <span class="literal">true</span>;</span><br><span class="line">      proxy_redirect off;</span><br><span class="line">      proxy_pass http://suspicious;</span><br><span class="line">      <span class="built_in">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">   location /api &#123;</span><br><span class="line">      proxy_set_header X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">      proxy_set_header X-Forwarded-Proto http;</span><br><span class="line">      proxy_set_header X-Url-Scheme <span class="variable">$scheme</span>;</span><br><span class="line">      proxy_set_header X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">      proxy_set_header Host <span class="variable">$http_host</span>;</span><br><span class="line">      proxy_set_header X-NginX-Proxy <span class="literal">true</span>;</span><br><span class="line">      proxy_redirect off;</span><br><span class="line">      proxy_pass http://suspicious-api;</span><br><span class="line">      <span class="built_in">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">   location / &#123;</span><br><span class="line">       try_files <span class="variable">$url</span> <span class="variable">$url</span>/ =404;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>到Nginx Web 服务器上查看配置文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#cat nginx.conf.template </span></span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    servername www.testnginx.com;</span><br><span class="line">    access_log off;</span><br><span class="line">    error_log /etc/nginx/nginx_error.log;</span><br><span class="line">    rewrite ^ https://<span class="variable">$server_name</span><span class="variable">$request_uri</span>? permanent;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen 443 ssl;</span><br><span class="line">    server_name www.testnginx.com;</span><br><span class="line">    ssl_certificate /etc/nginx/ssl/ifa.crt;</span><br><span class="line">    ssl_certificate_key /etc/nginx/ssl/ifa.crt;</span><br><span class="line">    root /data/html/;</span><br><span class="line">    index index.html index.html;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>到这里，就结束了。用同样的模板通过简单的if和变量设置就可以完成不同类型主机的Nginx conf配置，所以一方面在了解Ansible强大的模板功能的同时，也需要看到模板质量的重要性。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://github.com/cyylog/2019/04/16/Linux/ansible/" data-id="ckeglx6uw000uxsuv0vwr75fb" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Tools/" rel="tag">Tools</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2019/04/26/SQL/kafka%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          kafka集群搭建
        
      </div>
    </a>
  
  
    <a href="/2019/04/16/SQL/RabbitMQ%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">RabbitMQ消息中间件</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/DevOps/">DevOps</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Interview/">Interview</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/SQL/">SQL</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%AE%B9%E5%99%A8/">容器</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%9B%91%E6%8E%A7/">监控</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Docker/" rel="tag">Docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Gitlab/" rel="tag">Gitlab</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Go/" rel="tag">Go</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Jenkins/" rel="tag">Jenkins</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Kubernetes/" rel="tag">Kubernetes</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/" rel="tag">Linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MySQL/" rel="tag">MySQL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NFS/" rel="tag">NFS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Network/" rel="tag">Network</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Nginx/" rel="tag">Nginx</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Oracle/" rel="tag">Oracle</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Prometheus/" rel="tag">Prometheus</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Python/" rel="tag">Python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RabbitMQ/" rel="tag">RabbitMQ</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Redis/" rel="tag">Redis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/System/" rel="tag">System</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Tomcat/" rel="tag">Tomcat</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Tools/" rel="tag">Tools</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Vue/" rel="tag">Vue</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/iptables/" rel="tag">iptables</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kafka/" rel="tag">kafka</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/zabbix/" rel="tag">zabbix</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Docker/" style="font-size: 20px;">Docker</a> <a href="/tags/Gitlab/" style="font-size: 12.5px;">Gitlab</a> <a href="/tags/Go/" style="font-size: 12.5px;">Go</a> <a href="/tags/Jenkins/" style="font-size: 12.5px;">Jenkins</a> <a href="/tags/Kubernetes/" style="font-size: 20px;">Kubernetes</a> <a href="/tags/Linux/" style="font-size: 20px;">Linux</a> <a href="/tags/MySQL/" style="font-size: 15px;">MySQL</a> <a href="/tags/NFS/" style="font-size: 10px;">NFS</a> <a href="/tags/Network/" style="font-size: 10px;">Network</a> <a href="/tags/Nginx/" style="font-size: 15px;">Nginx</a> <a href="/tags/Oracle/" style="font-size: 12.5px;">Oracle</a> <a href="/tags/Prometheus/" style="font-size: 10px;">Prometheus</a> <a href="/tags/Python/" style="font-size: 10px;">Python</a> <a href="/tags/RabbitMQ/" style="font-size: 10px;">RabbitMQ</a> <a href="/tags/Redis/" style="font-size: 10px;">Redis</a> <a href="/tags/System/" style="font-size: 10px;">System</a> <a href="/tags/Tomcat/" style="font-size: 20px;">Tomcat</a> <a href="/tags/Tools/" style="font-size: 12.5px;">Tools</a> <a href="/tags/Vue/" style="font-size: 10px;">Vue</a> <a href="/tags/iptables/" style="font-size: 10px;">iptables</a> <a href="/tags/kafka/" style="font-size: 12.5px;">kafka</a> <a href="/tags/zabbix/" style="font-size: 17.5px;">zabbix</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">September 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">August 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">July 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">June 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">May 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">February 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">September 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">June 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/09/20/DevOPs/gitlab-ci%E5%85%A5%E9%97%A8/">gitlab-ci 入门</a>
          </li>
        
          <li>
            <a href="/2020/09/16/Linux/%E9%83%A8%E7%BD%B2NFS%E6%9C%8D%E5%8A%A1/">搭建 NFS 服务</a>
          </li>
        
          <li>
            <a href="/2020/09/15/%E5%AE%B9%E5%99%A8/Kubernetes%E7%BB%84%E4%BB%B6%E2%80%94%E4%BB%8B%E7%BB%8D002/">Kubernetes组件—介绍002</a>
          </li>
        
          <li>
            <a href="/2020/09/04/%5Bxshell%E7%AA%81%E5%87%BA%E6%98%BE%E7%A4%BA%E9%9B%86%5D/">[xshell突出显示集]</a>
          </li>
        
          <li>
            <a href="/2020/08/22/Interview/%E5%88%86%E5%B8%83%E5%BC%8F%E8%A7%81%E8%A7%A3/">分布式见解--undone</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 Cyylog<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>