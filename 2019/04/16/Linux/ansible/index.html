<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="ansible, Cyylog">
    <meta name="description" content="">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>ansible | Cyylog</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="Cyylog" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">Cyylog</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle-o" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="" class="waves-effect waves-light">

      
      <i class="fas fa-list" style="zoom: 0.6;"></i>
      
      <span>Medias</span>
      <i class="fas fa-chevron-down" aria-hidden="true" style="zoom: 0.6;"></i>
    </a>
    <ul class="sub-nav menus_item_child ">
      
      <li>
        <a href="/musics">
          
          <i class="fas fa-music" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>Musics</span>
        </a>
      </li>
      
      <li>
        <a href="/movies">
          
          <i class="fas fa-film" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>Movies</span>
        </a>
      </li>
      
      <li>
        <a href="/books">
          
          <i class="fas fa-book" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>Books</span>
        </a>
      </li>
      
      <li>
        <a href="/galleries">
          
          <i class="fas fa-image" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>Galleries</span>
        </a>
      </li>
      
    </ul>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">Cyylog</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle-o"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="javascript:;">
			
				<i class="fa-fw fas fa-list"></i>
			
			Medias
			<span class="m-icon"><i class="fas fa-chevron-right"></i></span>
		</a>
            <ul  style="background:  ;" >
              
                <li>

                  <a href="/musics " style="margin-left:75px">
				  
				   <i class="fa fas fa-music" style="position: absolute;left:50px" ></i>
			      
		          <span>Musics</span>
                  </a>
                </li>
              
                <li>

                  <a href="/movies " style="margin-left:75px">
				  
				   <i class="fa fas fa-film" style="position: absolute;left:50px" ></i>
			      
		          <span>Movies</span>
                  </a>
                </li>
              
                <li>

                  <a href="/books " style="margin-left:75px">
				  
				   <i class="fa fas fa-book" style="position: absolute;left:50px" ></i>
			      
		          <span>Books</span>
                  </a>
                </li>
              
                <li>

                  <a href="/galleries " style="margin-left:75px">
				  
				   <i class="fa fas fa-image" style="position: absolute;left:50px" ></i>
			      
		          <span>Galleries</span>
                  </a>
                </li>
              
            </ul>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/cyylog/Go_status" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/cyylog/Go_status" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/16.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">ansible</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        height: calc(100vh - 250px);
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Tools/">
                                <span class="chip bg-color">Tools</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/Linux/" class="post-category">
                                Linux
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2019-04-16
                </div>
                

                

                

                

                
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <a id="more"></a>

<h1 id="自动化运维工具—ansible详解"><a href="#自动化运维工具—ansible详解" class="headerlink" title="自动化运维工具—ansible详解"></a>自动化运维工具—ansible详解</h1><h2 id="一、ansible-简介"><a href="#一、ansible-简介" class="headerlink" title="一、ansible 简介"></a>一、ansible 简介</h2><h3 id="1、ansible-是什么？"><a href="#1、ansible-是什么？" class="headerlink" title="1、ansible 是什么？"></a>1、ansible 是什么？</h3><p>　　ansible是目前最受运维欢迎的自动化运维工具，基于Python开发，集合了众多运维工具（SaltStack puppet、chef、func、fabric）的优点，实现了批量系统配置、批量程序部署、批量运行命令等功能。<br> 　　ansible是基于 paramiko 开发的,并且基于模块化工作，本身没有批量部署的能力。真正具有批量部署的是ansible所运行的模块，ansible只是提供一种框架。ansible不需要在远程主机上安装client/agents，因为它们是基于ssh来和远程主机通讯的。ansible目前已经已经被红帽官方收购，是自动化运维工具中大家认可度最高的，并且上手容易，学习简单。是每位运维工程师必须掌握的技能之一。</p>
<h3 id="2、ansible-特点"><a href="#2、ansible-特点" class="headerlink" title="2、ansible 特点"></a>2、ansible 特点</h3><ol>
<li>部署简单，只需在主控端部署Ansible环境，被控端无需做任何操作；</li>
<li>默认使用SSH协议对设备进行管理；</li>
<li>有大量常规运维操作模块，可实现日常绝大部分操作；</li>
<li>配置简单、功能强大、扩展性强；</li>
<li>支持API及自定义模块，可通过Python轻松扩展；</li>
<li>通过Playbooks来定制强大的配置、状态管理；</li>
<li>轻量级，无需在客户端安装agent，更新时，只需在操作机上进行一次更新即可；</li>
<li>提供一个功能强大、操作性强的Web管理界面和REST API接口——AWX平台。</li>
</ol>
<h3 id="3、ansible-架构图"><a href="#3、ansible-架构图" class="headerlink" title="3、ansible 架构图"></a>3、ansible 架构图</h3><p><img src="https://s1.ax1x.com/2020/04/17/JEZyQO.png" alt="JEZyQO.png"></p>
<blockquote>
<p><code>Ansible</code>：Ansible核心程序。<br><code>HostInventory</code>：记录由Ansible管理的主机信息，包括端口、密码、ip等。<br><code>Playbooks</code>：“剧本”YAML格式文件，多个任务定义在一个文件中，定义主机需要调用哪些模块来完成的功能。<br><code>CoreModules</code>：<strong>核心模块</strong>，主要操作是通过调用核心模块来完成管理任务。<br><code>CustomModules</code>：自定义模块，完成核心模块无法完成的功能，支持多种语言。<br><code>ConnectionPlugins</code>：连接插件，Ansible和Host通信使用</p>
</blockquote>
<h2 id="二、ansible-任务执行"><a href="#二、ansible-任务执行" class="headerlink" title="二、ansible 任务执行"></a>二、ansible 任务执行</h2><h3 id="1、ansible-任务执行模式"><a href="#1、ansible-任务执行模式" class="headerlink" title="1、ansible 任务执行模式"></a>1、ansible 任务执行模式</h3><p>　　Ansible 系统由控制主机对被管节点的操作方式可分为两类，即<code>ad-hoc</code>和<code>playbook</code>：</p>
<ul>
<li>ad-hoc模式(点对点模式)<br>使用单个模块，支持批量执行单条命令。ad-hoc 命令是一种可以快速输入的命令，而且不需要保存起来的命令。<strong>就相当于bash中的一句话shell。</strong></li>
<li>playbook模式(剧本模式)<br>是Ansible主要管理方式，也是Ansible功能强大的关键所在。<strong>playbook通过多个task集合完成一类功能</strong>，如Web服务的安装部署、数据库服务器的批量备份等。可以简单地把playbook理解为通过组合多条ad-hoc操作的配置文件。</li>
</ul>
<h3 id="2、ansible-执行流程"><a href="#2、ansible-执行流程" class="headerlink" title="2、ansible 执行流程"></a>2、ansible 执行流程</h3><p> 　　简单理解就是Ansible在运行时， 首先读取<code>ansible.cfg</code>中的配置， 根据规则获取<code>Inventory</code>中的管理主机列表， 并行的在这些主机中执行配置的任务， 最后等待执行返回的结果。</p>
<h3 id="3、ansible-命令执行过程"><a href="#3、ansible-命令执行过程" class="headerlink" title="3、ansible 命令执行过程"></a>3、ansible 命令执行过程</h3><p><img src="https://s1.ax1x.com/2020/04/17/JEZ2eH.png" alt="JEZ2eH.png"></p>
<ol>
<li>加载自己的配置文件，默认<code>/etc/ansible/ansible.cfg</code>；</li>
<li>查找对应的主机配置文件，找到要执行的主机或者组；</li>
<li>加载自己对应的模块文件，如 command；</li>
<li>通过ansible将模块或命令生成对应的临时py文件(python脚本)， 并将该文件传输至远程服务器；</li>
<li>对应执行用户的家目录的<code>.ansible/tmp/XXX/XXX.PY</code>文件；</li>
<li>给文件 +x 执行权限；</li>
<li>执行并返回结果；</li>
<li>删除临时py文件，<code>sleep 0</code>退出；</li>
</ol>
<h2 id="三、ansible-配置详解"><a href="#三、ansible-配置详解" class="headerlink" title="三、ansible 配置详解"></a>三、ansible 配置详解</h2><h3 id="1、ansible-安装方式"><a href="#1、ansible-安装方式" class="headerlink" title="1、ansible 安装方式"></a>1、ansible 安装方式</h3><p>　　ansible安装常用两种方式，<code>yum 安装</code> 和 <code>pip 程序安装</code>。下面我们来详细介绍一下这两种安装方式。</p>
<h3 id="2、使用-pip（python的包管理模块）安装"><a href="#2、使用-pip（python的包管理模块）安装" class="headerlink" title="2、使用 pip（python的包管理模块）安装"></a>2、使用 pip（python的包管理模块）安装</h3><p>　　首先，我们需要安装一个<code>python-pip</code>包，安装完成以后，则直接使用<code>pip</code>命令来安装我们的包，具体操作过程如下：</p>
<pre><code>    yum install python-pip
    pip install ansible</code></pre><h3 id="4、使用-yum-安装"><a href="#4、使用-yum-安装" class="headerlink" title="4、使用 yum 安装"></a>4、使用 yum 安装</h3><p>　　yum 安装是我们很熟悉的安装方式了。我们需要先安装一个<code>epel-release</code>包，然后再安装我们的 ansible 即可。</p>
<pre><code>    yum install epel-release -y
    yum install ansible –y</code></pre><h3 id="5、ansible-程序结构"><a href="#5、ansible-程序结构" class="headerlink" title="5、ansible 程序结构"></a>5、ansible 程序结构</h3><p>安装目录如下(yum安装)：<br> 　   配置文件目录：/etc/ansible/<br>　　执行文件目录：/usr/bin/<br>　　Lib库依赖目录：/usr/lib/pythonX.X/site-packages/ansible/<br>　　Help文档目录：/usr/share/doc/ansible-X.X.X/<br>　　Man文档目录：/usr/share/man/man1/</p>
<h3 id="6、ansible配置文件查找顺序"><a href="#6、ansible配置文件查找顺序" class="headerlink" title="6、ansible配置文件查找顺序"></a>6、ansible配置文件查找顺序</h3><p>　　ansible与我们其他的服务在这一点上有很大不同，这里的配置文件查找是从多个地方找的，顺序如下：</p>
<ol>
<li>检查环境变量<code>ANSIBLE_CONFIG</code>指向的路径文件(export ANSIBLE_CONFIG=/etc/ansible.cfg)；</li>
<li><code>~/.ansible.cfg</code>，检查当前目录下的ansible.cfg配置文件；</li>
<li><code>/etc/ansible.cfg</code>检查etc目录的配置文件。</li>
</ol>
<h3 id="7、ansible配置文件"><a href="#7、ansible配置文件" class="headerlink" title="7、ansible配置文件"></a>7、ansible配置文件</h3><p>　　ansible 的配置文件为<code>/etc/ansible/ansible.cfg</code>，ansible 有许多参数，下面我们列出一些常见的参数：</p>
<pre><code>    inventory = /etc/ansible/hosts #这个参数表示资源清单inventory文件的位置
    library = /usr/share/ansible   #指向存放Ansible模块的目录，支持多个目录方式，只要用冒号（：）隔开就可以
    forks = 5       #并发连接数，默认为5
    sudo_user = root        #设置默认执行命令的用户
    remote_port = 22        #指定连接被管节点的管理端口，默认为22端口，建议修改，能够更加安全
    host_key_checking = False #设置是否检查SSH主机的密钥，值为True/False。关闭后第一次连接不会提示配置实例
    timeout = 60        #设置SSH连接的超时时间，单位为秒
    log_path = /var/log/ansible.log     #指定一个存储ansible日志的文件（默认不记录日志）</code></pre><h3 id="8、ansuble主机清单"><a href="#8、ansuble主机清单" class="headerlink" title="8、ansuble主机清单"></a>8、ansuble主机清单</h3><p>　　在配置文件中，我们提到了资源清单，这个清单就是我们的主机清单，里面保存的是一些 ansible 需要连接管理的主机列表。我们可以来看看他的定义方式：</p>
<pre><code>1、 直接指明主机地址或主机名：
    # green.example.com
    # blue.example.com
    # 192.168.100.1
    # 192.168.100.10
2、 定义一个主机组[组名]把地址或主机名加进去
    [mysql_test]
    192.168.253.159
    192.168.253.160
    192.168.253.153</code></pre><p>　　需要注意的是，这里的组成员可以使用通配符来匹配，这样对于一些标准化的管理来说就很轻松方便了。<br> 　　我们可以根据实际情况来配置我们的主机列表，具体操作如下：</p>
<pre><code>[root@server ~]# vim /etc/ansible/hosts
    [web]
    192.168.37.122
    192.168.37.133</code></pre><h2 id="四、ansible-常用命令"><a href="#四、ansible-常用命令" class="headerlink" title="四、ansible 常用命令"></a>四、ansible 常用命令</h2><h3 id="1、ansible-命令集"><a href="#1、ansible-命令集" class="headerlink" title="1、ansible 命令集"></a>1、ansible 命令集</h3><blockquote>
<p><code>/usr/bin/ansible</code>　　Ansibe AD-Hoc 临时命令执行工具，常用于临时命令的执行<br><code>/usr/bin/ansible-doc</code> 　　Ansible 模块功能查看工具<br><code>/usr/bin/ansible-galaxy</code>　　下载/上传优秀代码或Roles模块 的官网平台，基于网络的<br><code>/usr/bin/ansible-playbook</code>　　Ansible 定制自动化的任务集编排工具<br><code>/usr/bin/ansible-pull</code>　　Ansible远程执行命令的工具，拉取配置而非推送配置（使用较少，海量机器时使用，对运维的架构能力要求较高）<br><code>/usr/bin/ansible-vault</code>　　    Ansible 文件加密工具<br><code>/usr/bin/ansible-console</code>　　Ansible基于Linux Consoble界面可与用户交互的命令执行工具</p>
</blockquote>
<p>　　其中，我们比较常用的是<code>/usr/bin/ansible</code>和<code>/usr/bin/ansible-playbook</code>。</p>
<h3 id="2、ansible-doc-命令"><a href="#2、ansible-doc-命令" class="headerlink" title="2、ansible-doc 命令"></a>2、ansible-doc 命令</h3><p>　　ansible-doc 命令常用于获取模块信息及其使用帮助，一般用法如下：</p>
<pre><code>    ansible-doc -l              #获取全部模块的信息
    ansible-doc -s MOD_NAME     #获取指定模块的使用帮助</code></pre><p>　　我们也可以查看一下ansible-doc的全部用法：</p>
<pre><code>[root@server ~]# ansible-doc
Usage: ansible-doc [options] [module...]

Options:
  -h, --help            show this help message and exit　　# 显示命令参数API文档
  -l, --list            List available modules　　#列出可用的模块
  -M MODULE_PATH, --module-path=MODULE_PATH　　#指定模块的路径
                        specify path(s) to module library (default=None)
  -s, --snippet         Show playbook snippet for specified module(s)　　#显示playbook制定模块的用法
  -v, --verbose         verbose mode (-vvv for more, -vvvv to enable　　# 显示ansible-doc的版本号查看模块列表：
                        connection debugging)
  --version             show program's version number and exit</code></pre><p>　　我们可以来看一下，以mysql相关的为例：</p>
<pre><code>[root@server ~]# ansible-doc -l |grep mysql
mysql_db                           Add or remove MySQL databases from a remote...
mysql_replication                  Manage MySQL replication                   
mysql_user                         Adds or removes a user from a MySQL databas...
mysql_variables                    Manage MySQL global variables      
[root@server ~]# ansible-doc -s mysql_user</code></pre><h3 id="2、ansible-命令详解"><a href="#2、ansible-命令详解" class="headerlink" title="2、ansible 命令详解"></a>2、ansible 命令详解</h3><p>　　命令的具体格式如下：</p>
<pre><code>ansible &lt;host-pattern&gt; [-f forks] [-m module_name] [-a args]</code></pre><p>　　也可以通过<code>ansible -h</code>来查看帮助，下面我们列出一些比较常用的选项，并解释其含义：</p>
<blockquote>
<p><code>-a MODULE_ARGS</code> #模块的参数，如果执行默认COMMAND的模块，即是命令参数，如： “date”，“pwd”等等<br><code>-k</code>，<code>--ask-pass</code> #ask for SSH password。登录密码，提示输入SSH密码而不是假设基于密钥的验证<br><code>--ask-su-pass</code> #ask for su password。su切换密码<br><code>-K</code>，<code>--ask-sudo-pass</code> #ask for sudo password。提示密码使用sudo，sudo表示提权操作<br><code>--ask-vault-pass</code> #ask for vault password。假设我们设定了加密的密码，则用该选项进行访问<br><code>-B SECONDS</code> #后台运行超时时间<br><code>-C</code> #模拟运行环境并进行预运行，可以进行查错测试<br><code>-c CONNECTION</code> #连接类型使用<br><code>-f FORKS</code> #并行任务数，默认为5<br><code>-i INVENTORY</code> #指定主机清单的路径，默认为<code>/etc/ansible/hosts</code><br><code>--list-hosts</code> #查看有哪些主机组<br><code>-m MODULE_NAME</code> #执行模块的名字，默认使用 command 模块，所以如果是只执行单一命令可以不用 -m参数<br><code>-o</code> #压缩输出，尝试将所有结果在一行输出，一般针对收集工具使用<br><code>-S</code> #用 su 命令<br><code>-R SU_USER</code> #指定 su 的用户，默认为 root 用户<br><code>-s</code> #用 sudo 命令<br><code>-U SUDO_USER</code> #指定 sudo 到哪个用户，默认为 root 用户<br><code>-T TIMEOUT</code> #指定 ssh 默认超时时间，默认为10s，也可在配置文件中修改<br><code>-u REMOTE_USER</code> #远程用户，默认为 root 用户<br><code>-v</code> #查看详细信息，同时支持<code>-vvv</code>，<code>-vvvv</code>可查看更详细信息</p>
</blockquote>
<h3 id="3、ansible-配置公私钥"><a href="#3、ansible-配置公私钥" class="headerlink" title="3、ansible 配置公私钥"></a>3、ansible 配置公私钥</h3><p>　　上面我们已经提到过 ansible 是基于 ssh 协议实现的，所以其配置公私钥的方式与 ssh 协议的方式相同，具体操作步骤如下：</p>
<pre><code>#1.生成私钥
[root@server ~]# ssh-keygen 
#2.向主机分发私钥
[root@server ~]# ssh-copy-id root@192.168.37.122
[root@server ~]# ssh-copy-id root@192.168.37.133</code></pre><p>　　这样的话，就可以实现无密码登录，我们的实验过程也会顺畅很多。<br> 　　注意，如果出现了一下报错：</p>
<pre><code>    -bash: ssh-copy-id: command not found</code></pre><p>　　那么就证明我们需要安装一个包：</p>
<pre><code>    yum -y install openssh-clientsansible</code></pre><p>　　把包安装上即可。</p>
<h2 id="五、ansible-常用模块"><a href="#五、ansible-常用模块" class="headerlink" title="五、ansible 常用模块"></a>五、ansible 常用模块</h2><h3 id="1、主机连通性测试"><a href="#1、主机连通性测试" class="headerlink" title="1、主机连通性测试"></a>1、主机连通性测试</h3><p>　　我们使用<code>ansible web -m ping</code>命令来进行主机连通性测试，效果如下：</p>
<pre><code>[root@server ~]# ansible web -m ping
192.168.37.122 | SUCCESS =&gt; {
    "changed": false, 
    "ping": "pong"
}
192.168.37.133 | SUCCESS =&gt; {
    "changed": false, 
    "ping": "pong"
}</code></pre><p>　　这样就说明我们的主机是连通状态的。接下来的操作才可以正常进行。</p>
<h3 id="2、command-模块"><a href="#2、command-模块" class="headerlink" title="2、command 模块"></a>2、command 模块</h3><p>　　这个模块可以直接在远程主机上执行命令，并将结果返回本主机。<br> 　　举例如下：</p>
<pre><code>[root@server ~]# ansible web -m command -a 'ss -ntl'
192.168.37.122 | SUCCESS | rc=0 &gt;&gt;
State      Recv-Q Send-Q Local Address:Port               Peer Address:Port              
LISTEN     0      128          *:111                      *:*                  
LISTEN     0      5      192.168.122.1:53                       *:*                  
LISTEN     0      128          *:22                       *:*                  
LISTEN     0      128    127.0.0.1:631                      *:*                  
LISTEN     0      128          *:23000                    *:*                  
LISTEN     0      100    127.0.0.1:25                       *:*                  
LISTEN     0      128         :::111                     :::*                  
LISTEN     0      128         :::22                      :::*                  
LISTEN     0      128        ::1:631                     :::*                  
LISTEN     0      100        ::1:25                      :::*                  

192.168.37.133 | SUCCESS | rc=0 &gt;&gt;
State      Recv-Q Send-Q Local Address:Port               Peer Address:Port              
LISTEN     0      128          *:111                      *:*                  
LISTEN     0      128          *:22                       *:*                  
LISTEN     0      128    127.0.0.1:631                      *:*                  
LISTEN     0      128          *:23000                    *:*                  
LISTEN     0      100    127.0.0.1:25                       *:*                  
LISTEN     0      128         :::111                     :::*                  
LISTEN     0      128         :::22                      :::*                  
LISTEN     0      128        ::1:631                     :::*                  
LISTEN     0      100        ::1:25                      :::*  </code></pre><p>　　命令模块接受命令名称，后面是空格分隔的列表参数。给定的命令将在所有选定的节点上执行。它不会通过shell进行处理，比如$HOME和操作如”&lt;”，”&gt;”，”|”，”;”，”&amp;” 工作（需要使用（shell）模块实现这些功能）。注意，该命令不支持<code>| 管道命令</code>。<br> 　　下面来看一看该模块下常用的几个命令：</p>
<blockquote>
<p>chdir　　　   # 在执行命令之前，先切换到该目录<br>executable    # 切换shell来执行命令，需要使用命令的绝对路径<br>free_form 　 # 要执行的Linux指令，一般使用Ansible的-a参数代替。<br>creates 　      # 一个文件名，当这个文件存在，则该命令不执行,可以用来做判断<br>removes        # 一个文件名，这个文件不存在，则该命令不执行</p>
</blockquote>
<p>　　下面我们来看看这些命令的执行效果：</p>
<pre><code>[root@server ~]# ansible web -m command -a 'chdir=/data/ ls'  #先切换到/data/ 目录，再执行“ls”命令
192.168.37.122 | SUCCESS | rc=0 &gt;&gt;
aaa.jpg
fastdfs
mogdata
tmp
web
wKgleloeYoCAMLtZAAAWEekAtkc497.jpg

192.168.37.133 | SUCCESS | rc=0 &gt;&gt;
aaa.jpg
fastdfs
mogdata
tmp
web
wKgleloeYoCAMLtZAAAWEekAtkc497.jpg
[root@server ~]# ansible web -m command -a 'creates=/data/aaa.jpg ls'  #如果/data/aaa.jpg存在，则不执行“ls”命令
192.168.37.122 | SUCCESS | rc=0 &gt;&gt;
skipped, since /data/aaa.jpg exists

192.168.37.133 | SUCCESS | rc=0 &gt;&gt;
skipped, since /data/aaa.jpg exists
[root@server ~]# ansible web -m command -a 'removes=/data/aaa.jpg cat /data/a' #如果/data/aaa.jpg存在，则执行“cat /data/a”命令
192.168.37.122 | SUCCESS | rc=0 &gt;&gt;
hello

192.168.37.133 | SUCCESS | rc=0 &gt;&gt;
hello</code></pre><h3 id="3、shell-模块"><a href="#3、shell-模块" class="headerlink" title="3、shell 模块"></a>3、shell 模块</h3><p>　　shell模块可以在远程主机上调用shell解释器运行命令，支持shell的各种功能，例如管道等。</p>
<pre><code>[root@server ~]# ansible web -m shell -a 'cat /etc/passwd |grep "keer"'
192.168.37.122 | SUCCESS | rc=0 &gt;&gt;
keer:x:10001:1000:keer:/home/keer:/bin/sh

192.168.37.133 | SUCCESS | rc=0 &gt;&gt;
keer:x:10001:10001::/home/keer:/bin/sh</code></pre><p>　　只要是我们的shell命令，都可以通过这个模块在远程主机上运行，这里就不一一举例了。</p>
<h3 id="4、copy-模块"><a href="#4、copy-模块" class="headerlink" title="4、copy 模块"></a>4、copy 模块</h3><p>　　这个模块用于将文件复制到远程主机，同时支持给定内容生成文件和修改权限等。<br> 　　其相关选项如下：</p>
<blockquote>
<p><code>src</code>　　　　 #被复制到远程主机的本地文件。可以是绝对路径，也可以是相对路径。如果路径是一个目录，则会递归复制，用法类似于”rsync”<br><code>content</code>　　#用于替换”src”，可以直接指定文件的值<br><code>dest</code>　　　   #必选项，将源文件复制到的远程主机的<strong>绝对路径</strong><br><code>backup</code>　　　#当文件内容发生改变后，在覆盖之前把源文件备份，备份文件包含时间信息<br><code>directory_mode</code>　　　　#递归设定目录的权限，默认为系统默认权限<br><code>force</code>　　　　#当目标主机包含该文件，但内容不同时，设为”yes”，表示强制覆盖；设为”no”，表示目标主机的目标位置不存在该文件才复制。默认为”yes”<br><code>others</code>　　　　#所有的 file 模块中的选项可以在这里使用</p>
</blockquote>
<p>用法举例如下：<br><strong>① 复制文件：</strong></p>
<pre><code>[root@server ~]# ansible web -m copy -a 'src=~/hello dest=/data/hello' 
192.168.37.122 | SUCCESS =&gt; {
    "changed": true, 
    "checksum": "22596363b3de40b06f981fb85d82312e8c0ed511", 
    "dest": "/data/hello", 
    "gid": 0, 
    "group": "root", 
    "md5sum": "6f5902ac237024bdd0c176cb93063dc4", 
    "mode": "0644", 
    "owner": "root", 
    "size": 12, 
    "src": "/root/.ansible/tmp/ansible-tmp-1512437093.55-228281064292921/source", 
    "state": "file", 
    "uid": 0
}
192.168.37.133 | SUCCESS =&gt; {
    "changed": true, 
    "checksum": "22596363b3de40b06f981fb85d82312e8c0ed511", 
    "dest": "/data/hello", 
    "gid": 0, 
    "group": "root", 
    "md5sum": "6f5902ac237024bdd0c176cb93063dc4", 
    "mode": "0644", 
    "owner": "root", 
    "size": 12, 
    "src": "/root/.ansible/tmp/ansible-tmp-1512437093.74-44694985235189/source", 
    "state": "file", 
    "uid": 0
}</code></pre><p><strong>② 给定内容生成文件，并制定权限</strong></p>
<pre><code>[root@server ~]# ansible web -m copy -a 'content="I am keer\n" dest=/data/name mode=666'
192.168.37.122 | SUCCESS =&gt; {
    "changed": true, 
    "checksum": "0421570938940ea784f9d8598dab87f07685b968", 
    "dest": "/data/name", 
    "gid": 0, 
    "group": "root", 
    "md5sum": "497fa8386590a5fc89090725b07f175c", 
    "mode": "0666", 
    "owner": "root", 
    "size": 10, 
    "src": "/root/.ansible/tmp/ansible-tmp-1512437327.37-199512601767687/source", 
    "state": "file", 
    "uid": 0
}
192.168.37.133 | SUCCESS =&gt; {
    "changed": true, 
    "checksum": "0421570938940ea784f9d8598dab87f07685b968", 
    "dest": "/data/name", 
    "gid": 0, 
    "group": "root", 
    "md5sum": "497fa8386590a5fc89090725b07f175c", 
    "mode": "0666", 
    "owner": "root", 
    "size": 10, 
        "src": "/root/.ansible/tmp/ansible-tmp-1512437327.55-218104039503110/source", 
    "state": "file", 
    "uid": 0
}</code></pre><p>　　我们现在可以去查看一下我们生成的文件及其权限：</p>
<pre><code>[root@server ~]# ansible web -m shell -a 'ls -l /data/'
192.168.37.122 | SUCCESS | rc=0 &gt;&gt;
total 28
-rw-rw-rw-   1 root root   12 Dec  6 09:45 name

192.168.37.133 | SUCCESS | rc=0 &gt;&gt;
total 40
-rw-rw-rw- 1 root     root       12 Dec  5 09:45 name</code></pre><p>　　可以看出我们的name文件已经生成，并且权限为666。<br><strong>③ 关于覆盖</strong><br> 　　我们把文件的内容修改一下，然后选择覆盖备份：</p>
<pre><code>[root@server ~]# ansible web -m copy -a 'content="I am keerya\n" backup=yes dest=/data/name mode=666'
192.168.37.122 | SUCCESS =&gt; {
    "backup_file": "/data/name.4394.2017-12-06@09:46:25~", 
    "changed": true, 
    "checksum": "064a68908ab9971ee85dbc08ea038387598e3778", 
    "dest": "/data/name", 
    "gid": 0, 
    "group": "root", 
    "md5sum": "8ca7c11385856155af52e560f608891c", 
    "mode": "0666", 
    "owner": "root", 
    "size": 12, 
    "src": "/root/.ansible/tmp/ansible-tmp-1512438383.78-228128616784888/source", 
    "state": "file", 
    "uid": 0
}
192.168.37.133 | SUCCESS =&gt; {
    "backup_file": "/data/name.5962.2017-12-05@09:46:24~", 
    "changed": true, 
    "checksum": "064a68908ab9971ee85dbc08ea038387598e3778", 
    "dest": "/data/name", 
    "gid": 0, 
    "group": "root", 
    "md5sum": "8ca7c11385856155af52e560f608891c", 
    "mode": "0666", 
    "owner": "root", 
    "size": 12, 
    "src": "/root/.ansible/tmp/ansible-tmp-1512438384.0-170718946740009/source", 
    "state": "file", 
    "uid": 0
}</code></pre><p>　　现在我们可以去查看一下：</p>
<pre><code>[root@server ~]# ansible web -m shell -a 'ls -l /data/'
192.168.37.122 | SUCCESS | rc=0 &gt;&gt;
total 28
-rw-rw-rw-   1 root root   12 Dec  6 09:46 name
-rw-rw-rw-   1 root root   10 Dec  6 09:45 name.4394.2017-12-06@09:46:25~

192.168.37.133 | SUCCESS | rc=0 &gt;&gt;
total 40
-rw-rw-rw- 1 root     root       12 Dec  5 09:46 name
-rw-rw-rw- 1 root     root       10 Dec  5 09:45 name.5962.2017-12-05@09:46:24~</code></pre><p>　　可以看出，我们的源文件已经被备份，我们还可以查看一下<code>name</code>文件的内容：</p>
<pre><code>[root@server ~]# ansible web -m shell -a 'cat /data/name'
192.168.37.122 | SUCCESS | rc=0 &gt;&gt;
I am keerya

192.168.37.133 | SUCCESS | rc=0 &gt;&gt;
I am keerya</code></pre><p>　　证明，这正是我们新导入的文件的内容。</p>
<h3 id="5、file-模块"><a href="#5、file-模块" class="headerlink" title="5、file 模块"></a>5、file 模块</h3><p>　　该模块主要用于设置文件的属性，比如创建文件、创建链接文件、删除文件等。<br> 　　下面是一些常见的命令：</p>
<blockquote>
<p><code>force</code>　　#需要在两种情况下强制创建软链接，一种是源文件不存在，但之后会建立的情况下；另一种是目标软链接已存在，需要先取消之前的软链，然后创建新的软链，有两个选项：yes|no<br><code>group</code>　　#定义文件/目录的属组。后面可以加上<code>mode</code>：定义文件/目录的权限<br><code>owner</code>　　#定义文件/目录的属主。后面必须跟上<code>path</code>：定义文件/目录的路径<br><code>recurse</code>　　#递归设置文件的属性，只对目录有效，后面跟上<code>src</code>：被链接的源文件路径，只应用于<code>state=link</code>的情况<br><code>dest</code>　　#被链接到的路径，只应用于<code>state=link</code>的情况<br><code>state</code>　　#状态，有以下选项：</p>
<p><code>directory</code>：如果目录不存在，就创建目录<br><code>file</code>：即使文件不存在，也不会被创建<br><code>link</code>：创建软链接<br><code>hard</code>：创建硬链接<br><code>touch</code>：如果文件不存在，则会创建一个新的文件，如果文件或目录已存在，则更新其最后修改时间<br><code>absent</code>：删除目录、文件或者取消链接文件</p>
</blockquote>
<p>　　用法举例如下：<br><strong>① 创建目录：</strong></p>
<pre><code>[root@server ~]# ansible web -m file -a 'path=/data/app state=directory'
192.168.37.122 | SUCCESS =&gt; {
    "changed": true, 
    "gid": 0, 
    "group": "root", 
    "mode": "0755", 
    "owner": "root", 
    "path": "/data/app", 
    "size": 6, 
    "state": "directory", 
    "uid": 0
}
192.168.37.133 | SUCCESS =&gt; {
    "changed": true, 
    "gid": 0, 
    "group": "root", 
    "mode": "0755", 
    "owner": "root", 
    "path": "/data/app", 
    "size": 4096, 
    "state": "directory", 
    "uid": 0
}</code></pre><p>　　我们可以查看一下：</p>
<pre><code>[root@server ~]# ansible web -m shell -a 'ls -l /data'
192.168.37.122 | SUCCESS | rc=0 &gt;&gt;
total 28
drwxr-xr-x   2 root root    6 Dec  6 10:21 app

192.168.37.133 | SUCCESS | rc=0 &gt;&gt;
total 44
drwxr-xr-x 2 root     root     4096 Dec  5 10:21 app</code></pre><p>　　可以看出，我们的目录已经创建完成。<br><strong>② 创建链接文件</strong></p>
<pre><code>[root@server ~]# ansible web -m file -a 'path=/data/bbb.jpg src=aaa.jpg state=link'
192.168.37.122 | SUCCESS =&gt; {
    "changed": true, 
    "dest": "/data/bbb.jpg", 
    "gid": 0, 
    "group": "root", 
    "mode": "0777", 
    "owner": "root", 
    "size": 7, 
    "src": "aaa.jpg", 
    "state": "link", 
    "uid": 0
}
192.168.37.133 | SUCCESS =&gt; {
    "changed": true, 
    "dest": "/data/bbb.jpg", 
    "gid": 0, 
    "group": "root", 
    "mode": "0777", 
    "owner": "root", 
    "size": 7, 
    "src": "aaa.jpg", 
    "state": "link", 
    "uid": 0
}</code></pre><p>　　我们可以去查看一下：</p>
<pre><code>[root@server ~]# ansible web -m shell -a 'ls -l /data'
192.168.37.122 | SUCCESS | rc=0 &gt;&gt;
total 28
-rw-r--r--   1 root root 5649 Dec  5 13:49 aaa.jpg
lrwxrwxrwx   1 root root    7 Dec  6 10:25 bbb.jpg -&gt; aaa.jpg

192.168.37.133 | SUCCESS | rc=0 &gt;&gt;
total 44
-rw-r--r-- 1 root     root     5649 Dec  4 14:44 aaa.jpg
lrwxrwxrwx 1 root     root        7 Dec  5 10:25 bbb.jpg -&gt; aaa.jpg</code></pre><p>　　我们的链接文件已经创建成功。<br><strong>③ 删除文件</strong></p>
<pre><code>[root@server ~]# ansible web -m file -a 'path=/data/a state=absent'
192.168.37.122 | SUCCESS =&gt; {
    "changed": true, 
    "path": "/data/a", 
    "state": "absent"
}
192.168.37.133 | SUCCESS =&gt; {
    "changed": true, 
    "path": "/data/a", 
    "state": "absent"
}</code></pre><p>　　我们可以查看一下：</p>
<pre><code>[root@server ~]# ansible web -m shell -a 'ls /data/a'
192.168.37.122 | FAILED | rc=2 &gt;&gt;
ls: cannot access /data/a: No such file or directory

192.168.37.133 | FAILED | rc=2 &gt;&gt;
ls: cannot access /data/a: No such file or directory</code></pre><p>　　发现已经没有这个文件了。</p>
<h3 id="6、fetch-模块"><a href="#6、fetch-模块" class="headerlink" title="6、fetch 模块"></a>6、fetch 模块</h3><p>　　该模块用于从远程某主机获取（复制）文件到本地。<br> 　　有两个选项：</p>
<blockquote>
<p><code>dest</code>：用来存放文件的目录<br><code>src</code>：在远程拉取的文件，并且必须是一个<strong>file</strong>，不能是<strong>目录</strong></p>
</blockquote>
<p>　　具体举例如下：</p>
<pre><code>[root@server ~]# ansible web -m fetch -a 'src=/data/hello dest=/data'  
192.168.37.122 | SUCCESS =&gt; {
    "changed": true, 
    "checksum": "22596363b3de40b06f981fb85d82312e8c0ed511", 
    "dest": "/data/192.168.37.122/data/hello", 
    "md5sum": "6f5902ac237024bdd0c176cb93063dc4", 
    "remote_checksum": "22596363b3de40b06f981fb85d82312e8c0ed511", 
    "remote_md5sum": null
}
192.168.37.133 | SUCCESS =&gt; {
    "changed": true, 
    "checksum": "22596363b3de40b06f981fb85d82312e8c0ed511", 
    "dest": "/data/192.168.37.133/data/hello", 
    "md5sum": "6f5902ac237024bdd0c176cb93063dc4", 
    "remote_checksum": "22596363b3de40b06f981fb85d82312e8c0ed511", 
    "remote_md5sum": null
}</code></pre><p>　　我们可以在本机上查看一下文件是否复制成功。要注意，文件保存的路径是我们设置的接收目录下的<code>被管制主机ip</code>目录下：</p>
<pre><code>[root@server ~]# cd /data/
[root@server data]# ls
1  192.168.37.122  192.168.37.133  fastdfs  web
[root@server data]# cd 192.168.37.122
[root@server 192.168.37.122]# ls
data
[root@server 192.168.37.122]# cd data/
[root@server data]# ls
hello
[root@server data]# pwd
/data/192.168.37.122/data</code></pre><h3 id="7、cron-模块"><a href="#7、cron-模块" class="headerlink" title="7、cron 模块"></a>7、cron 模块</h3><p>　　该模块适用于管理<code>cron</code>计划任务的。<br> 　　其使用的语法跟我们的<code>crontab</code>文件中的语法一致，同时，可以指定以下选项：</p>
<blockquote>
<p><code>day=</code>           #日应该运行的工作( 1-31, <em>,</em> /2, )<br><code>hour=</code>         # 小时 ( 0-23, <em>,</em> /2, )<br><code>minute=</code>     #分钟( 0-59, <em>,</em> /2, )<br><code>month=</code>       # 月( 1-12, *, /2, )<br><code>weekday=</code>       # 周 ( 0-6 for Sunday-Saturday,, )<br><code>job=</code>           #指明运行的命令是什么<br><code>name=</code>        #定时任务描述<br><code>reboot</code>      # 任务在重启时运行，不建议使用，建议使用special_time<br><code>special_time</code> #特殊的时间范围，参数：reboot（重启时），annually（每年），monthly（每月），weekly（每周），daily（每天），hourly（每小时）<br><code>state</code>        #指定状态，present表示添加定时任务，也是默认设置，absent表示删除定时任务<br><code>user</code>          # 以哪个用户的身份执行</p>
</blockquote>
<p>　　举例如下：<br><strong>① 添加计划任务</strong></p>
<pre><code>[root@server ~]# ansible web -m cron -a 'name="ntp update every 5 min" minute=*/5 job="/sbin/ntpdate 172.17.0.1 &amp;&gt; /dev/null"'
192.168.37.122 | SUCCESS =&gt; {
    "changed": true, 
    "envs": [], 
    "jobs": [
        "ntp update every 5 min"
    ]
}
192.168.37.133 | SUCCESS =&gt; {
    "changed": true, 
    "envs": [], 
    "jobs": [
        "ntp update every 5 min"
    ]
}</code></pre><p>　　我们可以去查看一下：</p>
<pre><code>[root@server ~]# ansible web -m shell -a 'crontab -l'
192.168.37.122 | SUCCESS | rc=0 &gt;&gt;
#Ansible: ntp update every 5 min
*/5 * * * * /sbin/ntpdate 172.17.0.1 &amp;&gt; /dev/null

192.168.37.133 | SUCCESS | rc=0 &gt;&gt;
#Ansible: ntp update every 5 min
*/5 * * * * /sbin/ntpdate 172.17.0.1 &amp;&gt; /dev/null</code></pre><p>　　可以看出，我们的计划任务已经设置成功了。<br><strong>② 删除计划任务</strong><br> 　　如果我们的计划任务添加错误，想要删除的话，则执行以下操作：<br> 　　首先我们查看一下现有的计划任务：</p>
<pre><code>[root@server ~]# ansible web -m shell -a 'crontab -l'
192.168.37.122 | SUCCESS | rc=0 &gt;&gt;
#Ansible: ntp update every 5 min
*/5 * * * * /sbin/ntpdate 172.17.0.1 &amp;&gt; /dev/null
#Ansible: df everyday
* 15 * * * df -lh &gt;&gt; /tmp/disk_total &amp;&gt; /dev/null

192.168.37.133 | SUCCESS | rc=0 &gt;&gt;
#Ansible: ntp update every 5 min
*/5 * * * * /sbin/ntpdate 172.17.0.1 &amp;&gt; /dev/null
#Ansible: df everyday
* 15 * * * df -lh &gt;&gt; /tmp/disk_total &amp;&gt; /dev/null</code></pre><p>　　然后执行删除操作：</p>
<pre><code>[root@server ~]# ansible web -m cron -a 'name="df everyday" hour=15 job="df -lh &gt;&gt; /tmp/disk_total &amp;&gt; /dev/null" state=absent'
192.168.37.122 | SUCCESS =&gt; {
    "changed": true, 
    "envs": [], 
    "jobs": [
        "ntp update every 5 min"
    ]
}
192.168.37.133 | SUCCESS =&gt; {
    "changed": true, 
    "envs": [], 
    "jobs": [
        "ntp update every 5 min"
    ]
}</code></pre><p>　　删除完成后，我们再查看一下现有的计划任务确认一下：</p>
<pre><code>[root@server ~]# ansible web -m shell -a 'crontab -l'
192.168.37.122 | SUCCESS | rc=0 &gt;&gt;
#Ansible: ntp update every 5 min
*/5 * * * * /sbin/ntpdate 172.17.0.1 &amp;&gt; /dev/null

192.168.37.133 | SUCCESS | rc=0 &gt;&gt;
#Ansible: ntp update every 5 min
*/5 * * * * /sbin/ntpdate 172.17.0.1 &amp;&gt; /dev/null</code></pre><p>　　我们的删除操作已经成功。</p>
<h3 id="8、yum-模块"><a href="#8、yum-模块" class="headerlink" title="8、yum 模块"></a>8、yum 模块</h3><p>　　顾名思义，该模块主要用于软件的安装。<br> 　　其选项如下：</p>
<blockquote>
<p><code>name=</code>　　  #所安装的包的名称<br><code>state=</code>　　#<code>present</code>—&gt;安装， <code>latest</code>—&gt;安装最新的, <code>absent</code>—&gt; 卸载软件。<br><code>update_cache</code>　　#强制更新yum的缓存<br><code>conf_file</code>　　#指定远程yum安装时所依赖的配置文件（安装本地已有的包）。<br><code>disable_pgp_check</code>　　#是否禁止GPG checking，只用于<code>present</code>or <code>latest</code>。<br><code>disablerepo</code>　　#临时禁止使用yum库。 只用于安装或更新时。<br><code>enablerepo</code>　　 #临时使用的yum库。只用于安装或更新时。</p>
</blockquote>
<p>　　下面我们就来安装一个包试试看：</p>
<pre><code>[root@server ~]# ansible web -m yum -a 'name=htop state=present'
192.168.37.122 | SUCCESS =&gt; {
    "changed": true, 
    "msg": "", 
    "rc": 0, 
    "results": [
        "Loaded plugins: fastestmirror, langpacks\nLoading mirror speeds from cached hostfile\nResolving Dependencies\n--&gt; Running transaction check\n---&gt; Package htop.x86_64 0:2.0.2-1.el7 will be installed\n--&gt; Finished Dependency Resolution\n\nDependencies Resolved\n\n================================================================================\n Package         Arch              Version                Repository       Size\n================================================================================\nInstalling:\n htop            x86_64            2.0.2-1.el7            epel             98 k\n\nTransaction Summary\n================================================================================\nInstall  1 Package\n\nTotal download size: 98 k\nInstalled size: 207 k\nDownloading packages:\nRunning transaction check\nRunning transaction test\nTransaction test succeeded\nRunning transaction\n  Installing : htop-2.0.2-1.el7.x86_64                                      1/1 \n  Verifying  : htop-2.0.2-1.el7.x86_64                                      1/1 \n\nInstalled:\n  htop.x86_64 0:2.0.2-1.el7                                                     \n\nComplete!\n"
    ]
}
192.168.37.133 | SUCCESS =&gt; {
    "changed": true, 
    "msg": "Warning: RPMDB altered outside of yum.\n** Found 3 pre-existing rpmdb problem(s), 'yum check' output follows:\nipa-client-4.4.0-12.el7.centos.x86_64 has installed conflicts freeipa-client: ipa-client-4.4.0-12.el7.centos.x86_64\nipa-client-common-4.4.0-12.el7.centos.noarch has installed conflicts freeipa-client-common: ipa-client-common-4.4.0-12.el7.centos.noarch\nipa-common-4.4.0-12.el7.centos.noarch has installed conflicts freeipa-common: ipa-common-4.4.0-12.el7.centos.noarch\n", 
    "rc": 0, 
    "results": [
        "Loaded plugins: fastestmirror, langpacks\nLoading mirror speeds from cached hostfile\nResolving Dependencies\n--&gt; Running transaction check\n---&gt; Package htop.x86_64 0:2.0.2-1.el7 will be installed\n--&gt; Finished Dependency Resolution\n\nDependencies Resolved\n\n================================================================================\n Package         Arch              Version                Repository       Size\n================================================================================\nInstalling:\n htop            x86_64            2.0.2-1.el7            epel             98 k\n\nTransaction Summary\n================================================================================\nInstall  1 Package\n\nTotal download size: 98 k\nInstalled size: 207 k\nDownloading packages:\nRunning transaction check\nRunning transaction test\nTransaction test succeeded\nRunning transaction\n  Installing : htop-2.0.2-1.el7.x86_64                                      1/1 \n  Verifying  : htop-2.0.2-1.el7.x86_64                                      1/1 \n\nInstalled:\n  htop.x86_64 0:2.0.2-1.el7                                                     \n\nComplete!\n"
    ]
}</code></pre><p>　　安装成功。</p>
<h3 id="9、service-模块"><a href="#9、service-模块" class="headerlink" title="9、service 模块"></a>9、service 模块</h3><p>　　该模块用于服务程序的管理。<br> 　　其主要选项如下：</p>
<blockquote>
<p><code>arguments</code> #命令行提供额外的参数<br><code>enabled</code>     #设置开机启动。<br><code>name=</code> #服务名称<br><code>runlevel</code> #开机启动的级别，一般不用指定。<br><code>sleep</code> #在重启服务的过程中，是否等待。如在服务关闭以后等待2秒再启动。(定义在剧本中。)<br><code>state</code> #有四种状态，分别为：<code>started</code>—&gt;启动服务， <code>stopped</code>—&gt;停止服务， <code>restarted</code>—&gt;重启服务， <code>reloaded</code>—&gt;重载配置</p>
</blockquote>
<p>　　下面是一些例子：<br><strong>① 开启服务并设置自启动</strong></p>
<pre><code>[root@server ~]# ansible web -m service -a 'name=nginx state=started enabled=true' 
192.168.37.122 | SUCCESS =&gt; {
    "changed": true, 
    "enabled": true, 
    "name": "nginx", 
    "state": "started", 
    ……
}
192.168.37.133 | SUCCESS =&gt; {
    "changed": true, 
    "enabled": true, 
    "name": "nginx", 
    "state": "started", 
    ……
}</code></pre><p>　　我们可以去查看一下端口是否打开：</p>
<pre><code>[root@server ~]# ansible web -m shell -a 'ss -ntl'
192.168.37.122 | SUCCESS | rc=0 &gt;&gt;
State      Recv-Q Send-Q Local Address:Port               Peer Address:Port              
LISTEN     0      128          *:80                       *:*                                  

192.168.37.133 | SUCCESS | rc=0 &gt;&gt;
State      Recv-Q Send-Q Local Address:Port               Peer Address:Port                    
LISTEN     0      128          *:80                       *:*                  </code></pre><p>　　可以看出我们的80端口已经打开。<br><strong>② 关闭服务</strong><br> 　　我们也可以通过该模块来关闭我们的服务：</p>
<pre><code>[root@server ~]# ansible web -m service -a 'name=nginx state=stopped'
192.168.37.122 | SUCCESS =&gt; {
    "changed": true, 
    "name": "nginx", 
    "state": "stopped", 
    ……
}
192.168.37.133 | SUCCESS =&gt; {
    "changed": true, 
    "name": "nginx", 
    "state": "stopped", 
    ……
}</code></pre><p>　　一样的，我们来查看一下端口：</p>
<pre><code>[root@server ~]# ansible web -m shell -a 'ss -ntl | grep 80'
192.168.37.122 | FAILED | rc=1 &gt;&gt;

192.168.37.133 | FAILED | rc=1 &gt;&gt;</code></pre><p>　　可以看出，我们已经没有80端口了，说明我们的nginx服务已经关闭了。</p>
<h3 id="10、user-模块"><a href="#10、user-模块" class="headerlink" title="10、user 模块"></a>10、user 模块</h3><p>　　该模块主要是用来管理用户账号。<br> 　　其主要选项如下：</p>
<blockquote>
<p><code>comment</code>　　# 用户的描述信息<br><code>createhome</code>　　# 是否创建家目录<br><code>force</code>　　# 在使用state=absent时, 行为与userdel –force一致.<br><code>group</code>　　# 指定基本组<br><code>groups</code>　　# 指定附加组，如果指定为(groups=)表示删除所有组<br><code>home</code>　　    # 指定用户家目录<br><code>move_home</code>　　# 如果设置为home=时, 试图将用户主目录移动到指定的目录<br><code>name</code>　　# 指定用户名<br><code>non_unique</code>　　# 该选项允许改变非唯一的用户ID值<br><code>password</code>　　# 指定用户密码<br><code>remove</code>　　# 在使用state=absent时, 行为是与userdel –remove一致<br><code>shell</code>　　# 指定默认shell<br><code>state</code>　　# 设置帐号状态，不指定为创建，指定值为absent表示删除<br><code>system</code>　　# 当创建一个用户，设置这个用户是系统用户。这个设置不能更改现有用户<br><code>uid</code>　　# 指定用户的uid</p>
</blockquote>
<p>　　举例如下：<br><strong>① 添加一个用户并指定其 uid</strong></p>
<pre><code>[root@server ~]# ansible web -m user -a 'name=keer uid=11111'
192.168.37.122 | SUCCESS =&gt; {
    "changed": true, 
    "comment": "", 
    "createhome": true, 
    "group": 11111, 
    "home": "/home/keer", 
    "name": "keer", 
    "shell": "/bin/bash", 
    "state": "present", 
    "stderr": "useradd: warning: the home directory already exists.\nNot copying any file from skel directory into it.\nCreating mailbox file: File exists\n", 
    "system": false, 
    "uid": 11111
}
192.168.37.133 | SUCCESS =&gt; {
    "changed": true, 
    "comment": "", 
    "createhome": true, 
    "group": 11111, 
    "home": "/home/keer", 
    "name": "keer", 
    "shell": "/bin/bash", 
    "state": "present", 
    "stderr": "useradd: warning: the home directory already exists.\nNot copying any file from skel directory into it.\nCreating mailbox file: File exists\n", 
    "system": false, 
    "uid": 11111
}</code></pre><p>　　添加完成，我们可以去查看一下：</p>
<pre><code>[root@server ~]# ansible web -m shell -a 'cat /etc/passwd |grep keer'
192.168.37.122 | SUCCESS | rc=0 &gt;&gt;
keer:x:11111:11111::/home/keer:/bin/bash

192.168.37.133 | SUCCESS | rc=0 &gt;&gt;
keer:x:11111:11111::/home/keer:/bin/bash</code></pre><p><strong>② 删除用户</strong></p>
<pre><code>[root@server ~]# ansible web -m user -a 'name=keer state=absent'
192.168.37.122 | SUCCESS =&gt; {
    "changed": true, 
    "force": false, 
    "name": "keer", 
    "remove": false, 
    "state": "absent"
}
192.168.37.133 | SUCCESS =&gt; {
    "changed": true, 
    "force": false, 
    "name": "keer", 
    "remove": false, 
    "state": "absent"
}</code></pre><p>　　一样的，删除之后，我们去看一下：</p>
<pre><code>[root@server ~]# ansible web -m shell -a 'cat /etc/passwd |grep keer'
192.168.37.122 | FAILED | rc=1 &gt;&gt;

192.168.37.133 | FAILED | rc=1 &gt;&gt;</code></pre><p>　　发现已经没有这个用户了。</p>
<h3 id="11、group-模块"><a href="#11、group-模块" class="headerlink" title="11、group 模块"></a>11、group 模块</h3><p>　　该模块主要用于添加或删除组。<br> 　　常用的选项如下：</p>
<blockquote>
<p><code>gid=</code>　　#设置组的GID号<br><code>name=</code>　　#指定组的名称<br><code>state=</code>　　#指定组的状态，默认为创建，设置值为<code>absent</code>为删除<br><code>system=</code>　　#设置值为<code>yes</code>，表示创建为系统组</p>
</blockquote>
<p>　　举例如下：<br><strong>① 创建组</strong></p>
<pre><code>[root@server ~]# ansible web -m group -a 'name=sanguo gid=12222'
192.168.37.122 | SUCCESS =&gt; {
    "changed": true, 
    "gid": 12222, 
    "name": "sanguo", 
    "state": "present", 
    "system": false
}
192.168.37.133 | SUCCESS =&gt; {
    "changed": true, 
    "gid": 12222, 
    "name": "sanguo", 
    "state": "present", 
    "system": false
}</code></pre><p>　　创建过后，我们来查看一下：</p>
<pre><code>[root@server ~]# ansible web -m shell -a 'cat /etc/group | grep 12222' 
192.168.37.122 | SUCCESS | rc=0 &gt;&gt;
sanguo:x:12222:

192.168.37.133 | SUCCESS | rc=0 &gt;&gt;
sanguo:x:12222:</code></pre><p>　　可以看出，我们的组已经创建成功了。<br><strong>② 删除组</strong></p>
<pre><code>[root@server ~]# ansible web -m group -a 'name=sanguo state=absent'
192.168.37.122 | SUCCESS =&gt; {
    "changed": true, 
    "name": "sanguo", 
    "state": "absent"
}
192.168.37.133 | SUCCESS =&gt; {
    "changed": true, 
    "name": "sanguo", 
    "state": "absent"
}</code></pre><p>　　照例查看一下：</p>
<pre><code>[root@server ~]# ansible web -m shell -a 'cat /etc/group | grep 12222' 
192.168.37.122 | FAILED | rc=1 &gt;&gt;

192.168.37.133 | FAILED | rc=1 &gt;&gt;</code></pre><p>　　已经没有这个组的相关信息了。</p>
<h3 id="12、script-模块"><a href="#12、script-模块" class="headerlink" title="12、script 模块"></a>12、script 模块</h3><p>　　该模块用于将本机的脚本在被管理端的机器上运行。<br> 　　该模块直接指定脚本的路径即可，我们通过例子来看一看到底如何使用的：<br> 　　首先，我们写一个脚本，并给其加上执行权限：</p>
<pre><code>[root@server ~]# vim /tmp/df.sh
    #!/bin/bash
    date &gt;&gt; /tmp/disk_total.log
    df -lh &gt;&gt; /tmp/disk_total.log 
[root@server ~]# chmod +x /tmp/df.sh </code></pre><p>　　然后，我们直接运行命令来实现在被管理端执行该脚本：</p>
<pre><code>[root@server ~]# ansible web -m script -a '/tmp/df.sh'
192.168.37.122 | SUCCESS =&gt; {
    "changed": true, 
    "rc": 0, 
    "stderr": "Shared connection to 192.168.37.122 closed.\r\n", 
    "stdout": "", 
    "stdout_lines": []
}
192.168.37.133 | SUCCESS =&gt; {
    "changed": true, 
    "rc": 0, 
    "stderr": "Shared connection to 192.168.37.133 closed.\r\n", 
    "stdout": "", 
    "stdout_lines": []
}</code></pre><p>　　照例查看一下文件内容：</p>
<pre class=" language-repl"><code class="language-repl">[root@server ~]# ansible web -m shell -a 'cat /tmp/disk_total.log'
192.168.37.122 | SUCCESS | rc=0 >>
Tue Dec  5 15:58:21 CST 2017
Filesystem      Size  Used Avail Use% Mounted on
/dev/sda2        47G  4.4G   43G  10% /
devtmpfs        978M     0  978M   0% /dev
tmpfs           993M   84K  993M   1% /dev/shm
tmpfs           993M  9.1M  984M   1% /run
tmpfs           993M     0  993M   0% /sys/fs/cgroup
/dev/sda3        47G   33M   47G   1% /app
/dev/sda1       950M  153M  798M  17% /boot
tmpfs           199M   16K  199M   1% /run/user/42
tmpfs           199M     0  199M   0% /run/user/0

192.168.37.133 | SUCCESS | rc=0 >>
Tue Dec  5 15:58:21 CST 2017
Filesystem      Size  Used Avail Use% Mounted on
/dev/sda2        46G  4.1G   40G  10% /
devtmpfs        898M     0  898M   0% /dev
tmpfs           912M   84K  912M   1% /dev/shm
tmpfs           912M  9.0M  903M   1% /run
tmpfs           912M     0  912M   0% /sys/fs/cgroup
/dev/sda3       3.7G   15M  3.4G   1% /app
/dev/sda1       1.9G  141M  1.6G   9% /boot
tmpfs           183M   16K  183M   1% /run/user/42
tmpfs           183M     0  183M   0% /run/user/0</code></pre>
<p>　　可以看出已经执行成功了。</p>
<h3 id="13、setup-模块"><a href="#13、setup-模块" class="headerlink" title="13、setup 模块"></a>13、setup 模块</h3><p>　　该模块主要用于收集信息，是通过调用facts组件来实现的。<br> 　　facts组件是Ansible用于采集被管机器设备信息的一个功能，我们可以使用setup模块查机器的所有facts信息，可以使用filter来查看指定信息。整个facts信息被包装在一个JSON格式的数据结构中，ansible_facts是最上层的值。<br> 　　facts就是变量，内建变量 。每个主机的各种信息，cpu颗数、内存大小等。会存在facts中的某个变量中。调用后返回很多对应主机的信息，在后面的操作中可以根据不同的信息来做不同的操作。如redhat系列用yum安装，而debian系列用apt来安装软件。<br><strong>① 查看信息</strong><br> 　　我们可以直接用命令获取到变量的值，具体我们来看看例子：</p>
<pre><code>[root@server ~]# ansible web -m setup -a 'filter="*mem*"'   #查看内存
192.168.37.122 | SUCCESS =&gt; {
    "ansible_facts": {
        "ansible_memfree_mb": 1116, 
        "ansible_memory_mb": {
            "nocache": {
                "free": 1397, 
                "used": 587
            }, 
            "real": {
                "free": 1116, 
                "total": 1984, 
                "used": 868
            }, 
            "swap": {
                "cached": 0, 
                "free": 3813, 
                "total": 3813, 
                "used": 0
            }
        }, 
        "ansible_memtotal_mb": 1984
    }, 
    "changed": false
}
192.168.37.133 | SUCCESS =&gt; {
    "ansible_facts": {
        "ansible_memfree_mb": 1203, 
        "ansible_memory_mb": {
            "nocache": {
                "free": 1470, 
                "used": 353
            }, 
            "real": {
                "free": 1203, 
                "total": 1823, 
                "used": 620
            }, 
            "swap": {
                "cached": 0, 
                "free": 3813, 
                "total": 3813, 
                "used": 0
            }
        }, 
        "ansible_memtotal_mb": 1823
    }, 
    "changed": false
}</code></pre><p>　　我们可以通过命令查看一下内存的大小以确认一下是否一致：</p>
<pre><code>[root@server ~]# ansible web -m shell -a 'free -m'
192.168.37.122 | SUCCESS | rc=0 &gt;&gt;
              total        used        free      shared  buff/cache   available
Mem:           1984         404        1122           9         457        1346
Swap:          3813           0        3813

192.168.37.133 | SUCCESS | rc=0 &gt;&gt;
              total        used        free      shared  buff/cache   available
Mem:           1823         292        1207           9         323        1351
Swap:          3813           0        3813</code></pre><p>　　可以看出信息是一致的。<br><strong>② 保存信息</strong><br> 　　我们的setup模块还有一个很好用的功能就是可以保存我们所筛选的信息至我们的主机上，同时，文件名为我们被管制的主机的IP，这样方便我们知道是哪台机器出的问题。<br> 　　我们可以看一看例子：</p>
<pre><code>[root@server tmp]# ansible web -m setup -a 'filter="*mem*"' --tree /tmp/facts
192.168.37.122 | SUCCESS =&gt; {
    "ansible_facts": {
        "ansible_memfree_mb": 1115, 
        "ansible_memory_mb": {
            "nocache": {
                "free": 1396, 
                "used": 588
            }, 
            "real": {
                "free": 1115, 
                "total": 1984, 
                "used": 869
            }, 
            "swap": {
                "cached": 0, 
                "free": 3813, 
                "total": 3813, 
                "used": 0
            }
        }, 
        "ansible_memtotal_mb": 1984
    }, 
    "changed": false
}
192.168.37.133 | SUCCESS =&gt; {
    "ansible_facts": {
        "ansible_memfree_mb": 1199, 
        "ansible_memory_mb": {
            "nocache": {
                "free": 1467, 
                "used": 356
            }, 
            "real": {
                "free": 1199, 
                "total": 1823, 
                "used": 624
            }, 
            "swap": {
                "cached": 0, 
                "free": 3813, 
                "total": 3813, 
                "used": 0
            }
        }, 
        "ansible_memtotal_mb": 1823
    }, 
    "changed": false
}</code></pre><p>　　然后我们可以去查看一下：</p>
<pre><code>[root@server ~]# cd /tmp/facts/
[root@server facts]# ls
192.168.37.122  192.168.37.133
[root@server facts]# cat 192.168.37.122 
{"ansible_facts": {"ansible_memfree_mb": 1115, "ansible_memory_mb": {"nocache": {"free": 1396, "used": 588}, "real": {"free": 1115, "total": 1984, "used": 869}, "swap": {"cached": 0, "free": 3813, "total": 3813, "used": 0}}, "ansible_memtotal_mb": 1984}, "changed": false}</code></pre><h2 id="六、Ansible-playbook-简介"><a href="#六、Ansible-playbook-简介" class="headerlink" title="六、Ansible playbook 简介"></a>六、Ansible playbook 简介</h2><p>　　<strong>playbook 是 ansible 用于配置，部署，和管理被控节点的剧本。</strong><br>　　通过 playbook 的详细描述，执行其中的一系列 tasks ，可以让远端主机达到预期的状态。playbook 就像 Ansible 控制器给被控节点列出的的一系列 to-do-list ，而被控节点必须要完成。<br>　　也可以这么理解，playbook 字面意思，即剧本，现实中由演员按照剧本表演，在Ansible中，这次由计算机进行表演，由计算机安装，部署应用，提供对外服务，以及组织计算机处理各种各样的事情。</p>
<h2 id="七、Ansible-playbook使用场景"><a href="#七、Ansible-playbook使用场景" class="headerlink" title="七、Ansible playbook使用场景"></a>七、Ansible playbook使用场景</h2><p>　　执行一些简单的任务，使用ad-hoc命令可以方便的解决问题，但是有时一个设施过于复杂，需要大量的操作时候，执行的ad-hoc命令是不适合的，这时最好使用playbook。<br>　　就像执行shell命令与写shell脚本一样，也可以理解为批处理任务，不过playbook有自己的语法格式。<br>　　使用playbook你可以方便的重用这些代码，可以移植到不同的机器上面，像函数一样，最大化的利用代码。在你使用Ansible的过程中，你也会发现，你所处理的大部分操作都是编写playbook。可以把常见的应用都编写成playbook，之后管理服务器会变得十分简单。</p>
<h2 id="八、Ansible-playbook格式"><a href="#八、Ansible-playbook格式" class="headerlink" title="八、Ansible playbook格式"></a>八、Ansible playbook格式</h2><h3 id="1、格式简介"><a href="#1、格式简介" class="headerlink" title="1、格式简介"></a>1、格式简介</h3><p>　　<strong>playbook由YMAL语言编写。</strong>YAML( /ˈjæməl/ )参考了其他多种语言，包括：XML、C语言、Python、Perl以及电子邮件格式RFC2822，Clark Evans在2001年5月在首次发表了这种语言，另外Ingy döt Net与OrenBen-Kiki也是这语言的共同设计者。<br>　　YMAL格式是类似于JSON的文件格式，便于人理解和阅读，同时便于书写。首先学习了解一下YMAL的格式，对我们后面书写playbook很有帮助。以下为playbook常用到的YMAL格式：<br>　　1、文件的第一行应该以 “—“ (三个连字符)开始，表明YMAL文件的开始。<br>　　2、在同一行中，#之后的内容表示注释，类似于shell，python和ruby。<br>　　3、YMAL中的列表元素以”-”开头然后紧跟着一个空格，后面为元素内容。<br>　　4、同一个列表中的元素应该保持相同的缩进。否则会被当做错误处理。<br>　　5、play中hosts，variables，roles，tasks等对象的表示方法都是键值中间以”:”分隔表示，”:”后面还要增加一个空格。<br>　　下面是一个举例：</p>
<pre><code>---
#安装与运行mysql服务
- hosts: node1
  remote_user: root
  tasks:  
    - name: install mysql-server package
      yum: name=mysql-server state=present
    - name: starting mysqld service
      service: name=mysql state=started</code></pre><p>　　我们的文件名称应该以<code>.yml</code>结尾，像我们上面的例子就是<code>mysql.yml</code>。其中，有三个部分组成：</p>
<blockquote>
<p><code>host部分</code>：使用 hosts 指示使用哪个主机或主机组来运行下面的 tasks ，每个 playbook 都必须指定 hosts ，hosts也<strong>可以使用通配符格式</strong>。主机或主机组在 inventory 清单中指定，可以使用系统默认的<code>/etc/ansible/hosts</code>，也可以自己编辑，在运行的时候加上<code>-i</code>选项，指定清单的位置即可。在运行清单文件的时候，<code>–list-hosts</code>选项会显示那些主机将会参与执行 task 的过程中。<br><code>remote_user</code>：指定远端主机中的哪个用户来登录远端系统，在远端系统执行 task 的用户，可以任意指定，也可以使用 sudo，但是用户必须要有执行相应 task 的权限。<br><code>tasks</code>：指定远端主机将要执行的一系列动作。tasks 的核心为 ansible 的模块，前面已经提到模块的用法。tasks 包含 <code>name</code> 和<code>要执行的模块</code>，name 是可选的，只是为了便于用户阅读，不过还是建议加上去，模块是必须的，同时也要给予模块相应的参数。</p>
</blockquote>
<p>　　使用ansible-playbook运行playbook文件，得到如下输出信息，输出内容为JSON格式。并且由不同颜色组成，便于识别。一般而言<br>| 绿色代表执行成功，系统保持原样<br>| 黄色代表系统代表系统状态发生改变<br>| 红色代表执行失败，显示错误输出<br>　　执行有三个步骤：1、收集facts  2、执行tasks  3、报告结果</p>
<h3 id="2、核心元素"><a href="#2、核心元素" class="headerlink" title="2、核心元素"></a>2、核心元素</h3><p>　　Playbook的核心元素：</p>
<blockquote>
<p><code>Hosts</code>：主机组；<br><code>Tasks</code>：任务列表；<br><code>Variables</code>：变量，设置方式有四种；<br><code>Templates</code>：包含了模板语法的文本文件；<br><code>Handlers</code>：由特定条件触发的任务；</p>
</blockquote>
<h3 id="3、基本组件"><a href="#3、基本组件" class="headerlink" title="3、基本组件"></a>3、基本组件</h3><p>　　Playbooks配置文件的基础组件：</p>
<blockquote>
<p><code>Hosts</code>：运行指定任务的目标主机<br><code>remote_user</code>：在远程主机上执行任务的用户；<br><code>sudo_user</code>：<br><code>tasks</code>：任务列表</p>
<p>　　格式：<br>　　　　tasks：<br>　　　　　　– name: TASK_NAME<br>　　　　　　 module: arguments<br>　　　　　　 notify: HANDLER_NAME<br>　　　　　　 handlers:<br>　　　　　　– name: HANDLER_NAME<br>　　　　　　 module: arguments</p>
</blockquote>
<blockquote>
<p><code>模块，模块参数</code>：</p>
<p>　　格式：<br>　　　　(1) action: module arguments<br>　　　　(2) module: arguments<br>　　　　注意：shell和command模块后面直接跟命令，而非key=value类的参数列表；</p>
</blockquote>
<blockquote>
<p><code>handlers</code>：任务，在特定条件下触发；接收到其它任务的通知时被触发；</p>
</blockquote>
<p>　　(1) 某任务的状态在运行后为changed时，可通过“notify”通知给相应的handlers；<br>　　(2) 任务可以通过“tags“打标签，而后可在ansible-playbook命令上使用-t指定进行调用；</p>
<h5 id="举例"><a href="#举例" class="headerlink" title="举例"></a>举例</h5><p><strong>① 定义playbook</strong></p>
<pre><code>[root@server ~]# cd /etc/ansible
[root@server ansible]# vim nginx.yml
---
- hosts: web
  remote_user: root
  tasks:
    - name: install nginx
      yum: name=nginx state=present
    - name: copy nginx.conf
      copy: src=/tmp/nginx.conf dest=/etc/nginx/nginx.conf backup=yes
      notify: reload　　　　#当nginx.conf发生改变时，通知给相应的handlers
      tags: reloadnginx　　　#打标签
    - name: start nginx service
      service: name=nginx state=started
      tags: startnginx　　　#打标签

  handlers:　　#注意，前面没有-，是两个空格
    - name: reload
      service: name=nginx state=restarted　　#为了在进程中能看出来</code></pre><p><strong>② 测试运行结果</strong><br>　　写完了以后，我们就可以运行了：</p>
<pre><code>[root@server ansible]# ansible-playbook nginx.yml</code></pre><p>　　现在我们可以看看两台机器的端口是否开启：</p>
<pre><code>[root@server ansible]# ansible web -m shell -a 'ss -nutlp |grep nginx'
192.168.37.122 | SUCCESS | rc=0 &gt;&gt;
tcp    LISTEN     0      128       *:80                    *:*                   users:(("nginx",pid=8304,fd=6),("nginx",pid=8303,fd=6))

192.168.37.133 | SUCCESS | rc=0 &gt;&gt;
tcp    LISTEN     0      128       *:80                    *:*                   users:(("nginx",pid=9671,fd=6),("nginx",pid=9670,fd=6))</code></pre><p><strong>③ 测试标签</strong><br>　　我们在里面已经打上了一个标签，所以可以直接引用标签。但是我们需要先把服务关闭，再来运行剧本并引用标签：</p>
<pre><code>[root@server ansible]# ansible web -m shell -a 'systemctl stop nginx'
[root@server ansible]# ansible-playbook nginx.yml -t startnginx</code></pre><p><strong>④ 测试notify</strong><br>　　我们还做了一个<code>notify</code>，来测试一下：<br>　　首先，它的触发条件是配置文件被改变，所以我们去把配置文件中的端口改一下：</p>
<pre><code>[root@server ansible]# vim /tmp/nginx.conf
    listen       8080;
</code></pre><p>　　然后我们重新加载一下这个剧本：</p>
<pre><code> [root@server ansible]# ansible-playbook nginx.yml -t reloadnginx</code></pre><p>　　发现我们执行的就是reload段以及我们定义的<code>notify</code>部分。<br>　　我们来看一看我们的端口号：</p>
<p>　　发现我们执行的就是reload段以及我们定义的<code>notify</code>部分。<br>　　我们来看一看我们的端口号：</p>
<pre><code>[root@server ansible]# ansible web -m shell -a 'ss -ntlp | grep nginx'
192.168.37.122 | SUCCESS | rc=0 &gt;&gt;
LISTEN     0      128          *:8080                     *:*                   users:(("nginx",pid=2097,fd=6),("nginx",pid=2096,fd=6))

192.168.37.133 | SUCCESS | rc=0 &gt;&gt;
LISTEN     0      128          *:8080                     *:*                   users:(("nginx",pid=3061,fd=6),("nginx",pid=3060,fd=6))</code></pre><p>　　可以看出，我们的nginx端口已经变成了8080。　　</p>
<h3 id="4、variables-部分"><a href="#4、variables-部分" class="headerlink" title="4、variables 部分"></a>4、variables 部分</h3><p>　　上文中，我们说到了<code>variables</code>是变量，有四种定义方法，现在我们就来说说这四种定义方法：</p>
<h4 id="①-facts-：可直接调用"><a href="#①-facts-：可直接调用" class="headerlink" title="① facts ：可直接调用"></a>① facts ：可直接调用</h4><p>　　上一篇中，我们有说到<code>setup</code>这个模块，这个模块就是通过调用facts组件来实现的。我们这里的<code>variables</code>也可以直接调用<code>facts</code>组件。<br>　　具体的<code>facters</code>我们可以使用<code>setup</code>模块来获取，然后直接放入我们的剧本中调用即可。</p>
<pre><code>ansible_all_ipv4_addresses：仅显示ipv4的信息 ---&gt; [u'192.168.95.143']
ansible_eth0['ipv4']['address']：仅显示ipv4的信息 ---&gt; eth0 的ip地址
ansible_devices：仅显示磁盘设备信息
ansible_distribution：显示是什么系统，例：centos,suse等
ansible_distribution_version：仅显示系统版本
ansible_machine：显示系统类型，例：32位，还是64位
ansible_eth0：仅显示eth0的信息
ansible_hostname：仅显示主机名
ansible_kernel：仅显示内核版本
ansible_lvm：显示lvm相关信息
ansible_memtotal_mb：显示系统总内存
ansible_memfree_mb：显示可用系统内存
ansible_memory_mb：详细显示内存情况
ansible_swaptotal_mb：显示总的swap内存
ansible_swapfree_mb：显示swap内存的可用内存
ansible_mounts：显示系统磁盘挂载情况
ansible_processor：显示cpu个数(具体显示每个cpu的型号)
ansible_processor_vcpus：显示cpu个数(只显示总的个数)
ansible_python_version：显示python版本</code></pre><p>例如：批量修改主机 host 文件</p>
<pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">---</span>
<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> web  
  <span class="token key atrule">vars</span><span class="token punctuation">:</span>        
    <span class="token key atrule">IP</span><span class="token punctuation">:</span> <span class="token string">"{{ ansible_eth0['ipv4']['address'] }}"</span>  
  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>        
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> 将原有的hosts文件备份          
    <span class="token key atrule">shell</span><span class="token punctuation">:</span> mv /etc/hosts /etc/hosts_bak        
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> 将ansible端的hosts复制到各自机器上          
    <span class="token key atrule">copy</span><span class="token punctuation">:</span> src=/root/hosts dest=/etc/ owner=root group=root mode=0644        
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> 在新的hosts文件后面追加各自机器内网ip和hostname          
    <span class="token key atrule">lineinfile</span><span class="token punctuation">:</span> dest=/etc/hosts line="<span class="token punctuation">{</span><span class="token punctuation">{</span> IP <span class="token punctuation">}</span><span class="token punctuation">}</span>  <span class="token punctuation">{</span><span class="token punctuation">{</span> ansible_hostname <span class="token punctuation">}</span><span class="token punctuation">}</span>"
</code></pre>
<h4 id="②-用户自定义变量"><a href="#②-用户自定义变量" class="headerlink" title="② 用户自定义变量"></a>② 用户自定义变量</h4><p>　　我们也可以直接使用用户自定义变量，想要自定义变量有以下两种方式：</p>
<blockquote>
<p>通过命令行传入</p>
</blockquote>
<p>　　<code>ansible-playbook</code>命令的命令行中的<code>-e VARS, --extra-vars=VARS</code>，这样就可以直接把自定义的变量传入。</p>
<blockquote>
<p>在playbook中定义变量</p>
</blockquote>
<p>　　我们也可以直接在playbook中定义我们的变量：</p>
<pre><code>vars:
　　- var1: value1
　　- var2: value2</code></pre><h5 id="举例-1"><a href="#举例-1" class="headerlink" title="举例"></a>举例</h5><p><strong>① 定义剧本</strong><br>　　我们就使用全局替换把我们刚刚编辑的文件修改一下：</p>
<pre><code>[root@server ansible]# vim nginx.yml
</code></pre><p><img src="https://s1.ax1x.com/2020/04/16/JEZEz8.png" alt="JEZEz8.png"><br><img src="https://s1.ax1x.com/2020/04/16/JEZmLQ.png" alt="JEZmLQ.png">　　这样一来，我们的剧本就定义完成了。<br><strong>② 拷贝配置文件</strong><br>　　我们想要在被监管的机器上安装什么服务的话，就直接在我们的server端上把该服务的配置文件拷贝到我们的<code>/tmp/</code>目录下。这样我们的剧本才能正常运行。<br>　　我们就以<code>keepalived</code>服务为例：</p>
<pre class=" language-shell"><code class="language-shell">[root@server ansible]# cp /etc/keepalived/keepalived.conf /tmp/keepalived.conf</code></pre>
<p><strong>③ 运行剧本，变量由命令行传入</strong></p>
<pre><code>[root@server ansible]# ansible-playbook nginx.yml -e rpmname=keepalived</code></pre><p><img src="https://s1.ax1x.com/2020/04/16/JEZKds.png" alt="JEZKds.png"><br><strong>④ 修改剧本，直接定义变量</strong><br>　　同样的，我们可以直接在剧本中把变量定义好，这样就不需要在通过命令行传入了。以后想要安装不同的服务，直接在剧本里把变量修改一下即可。</p>
<pre><code>[root@server ansible]# vim nginx.yml</code></pre><p>![img](E:/学习晋升文件汇总/Linux架构学习入门/4. network_manager/19-20天-企业自动化运维工具Aansible实战/assets/1204916-20171208112356562-1275040347.png)<br><strong>⑤ 运行定义过变量的剧本</strong><br>　　我们刚刚已经把变量定义在剧本里面了。现在我们来运行一下试试看：</p>
<pre><code>[root@server ansible]# ansible-playbook nginx.yml</code></pre><p><img src="https://s1.ax1x.com/2020/04/16/JEZMon.png" alt="JEZMon.png"><br>　　发现这样也是可以的~</p>
<h4 id="③-通过roles传递变量"><a href="#③-通过roles传递变量" class="headerlink" title="③ 通过roles传递变量"></a>③ 通过roles传递变量</h4><p>　　具体的，我们下文中说到 roles 的时候再详细说明。</p>
<h4 id="④-Host-Inventory"><a href="#④-Host-Inventory" class="headerlink" title="④ Host Inventory"></a>④ Host Inventory</h4><p>　　我们也可以直接在主机清单中定义。<br>　　定义的方法如下：</p>
<blockquote>
<p>向不同的主机传递不同的变量：</p>
</blockquote>
<pre><code>　　IP/HOSTNAME varaiable=value var2=value2</code></pre><blockquote>
<p>向组中的主机传递相同的变量：</p>
</blockquote>
<pre><code>　　[groupname:vars]
　　variable=value</code></pre><p>Ansible Inventory 内置参数</p>
<p>![Ansible Inventory 内置参数](E:/学习晋升文件汇总/Linux架构学习入门/4. network_manager/19-20天-企业自动化运维工具Aansible实战/assets/Ansible Inventory 内置参数.png)</p>
<p>使用内置变量把用户名密码写在Inventory中，也就是/etc/ansible/hosts文件里，缺点就是<strong>暴露了账号密码</strong>，不安全。如果有多个主机需要使用同样的变量，可以用组变量的形式，书写格式如下：</p>
<pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">[</span>web<span class="token punctuation">]</span>
192.168.100.10
192.168.100.11
192.168.100.12 
<span class="token punctuation">[</span>web<span class="token punctuation">:</span>vars<span class="token punctuation">]</span>  <span class="token comment" spellcheck="true">#给名为webservers的组定义一个变量，:vars是固定格式</span>
ansible_ssh_port=22
ansible_ssh_user='root'
ansible_ssh_pass='1234.com'</code></pre>
<h3 id="5、模板-templates"><a href="#5、模板-templates" class="headerlink" title="5、模板 templates"></a>5、模板 templates</h3><p>　　模板是一个文本文件，嵌套有脚本（使用模板编程语言编写）。<br>　　<code>Jinja2</code>：Jinja2是python的一种模板语言，以Django的模板语言为原本。<br>模板支持：</p>
<pre><code>　　字符串：使用单引号或双引号；
　　数字：整数，浮点数；
　　列表：[item1, item2, ...]
　　元组：(item1, item2, ...)
　　字典：{key1:value1, key2:value2, ...}
　　布尔型：true/false
　　算术运算：
　　　　+, -, *, /, //, %, **
　　比较操作：
　　　　==, !=, &gt;, &gt;=, &lt;, &lt;=
　　逻辑运算：
　　　　and, or, not</code></pre><p>　　通常来说，模板都是通过引用变量来运用的。</p>
<h5 id="举例-2"><a href="#举例-2" class="headerlink" title="举例"></a>举例</h5><p><strong>① 定义模板</strong><br>　　我们直接把之前定义的<code>/tmp/nginx.conf</code>改个名，然后编辑一下，就可以定义成我们的模板文件了：</p>
<pre><code>[root@server ansible]# cd /tmp
[root@server tmp]# mv nginx.conf nginx.conf.j2
[root@server tmp]# vim nginx.conf.j2
    worker_processes  {{ ansible_processor_vcpus }};
    listen       {{ nginxport }};</code></pre><p><strong>② 修改剧本</strong><br>　　我们现在需要去修改剧本来定义变量：</p>
<pre><code>[root@server ansible]# vim nginx.yml</code></pre><p><a href="https://imgchr.com/i/JEZtL4" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2020/04/16/JEZtL4.png" alt="JEZtL4.png"></a><br>　　需要修改的部分如图所示。</p>
<p>  copy 也需要修改为 template</p>
<p><strong>③ 运行剧本</strong><br>　　上面的准备工作完成后，我们就可以去运行剧本了：</p>
<pre><code>[root@server ansible]# ansible-playbook nginx.yml -t reloadnginx

PLAY [web] *********************************************************************

TASK [setup] *******************************************************************
ok: [192.168.37.122]
ok: [192.168.37.133]

TASK [copy nginx.conf] *********************************************************
ok: [192.168.37.122]
ok: [192.168.37.133]

PLAY RECAP *********************************************************************
192.168.37.122             : ok=2    changed=0    unreachable=0    failed=0   
192.168.37.133             : ok=2    changed=0    unreachable=0    failed=0 </code></pre><h3 id="6、条件测试"><a href="#6、条件测试" class="headerlink" title="6、条件测试"></a>6、条件测试</h3><p>when语句：在task中使用，jinja2的语法格式。<br>举例如下：</p>
<pre><code>tasks:
- name: install conf file to centos7
  template: src=files/nginx.conf.c7.j2
  when: ansible_distribution_major_version == "7"
- name: install conf file to centos6
  template: src=files/nginx.conf.c6.j2
  when: ansible_distribution_major_version == "6"</code></pre><p>循环：迭代，需要重复执行的任务；<br>　　对迭代项的引用，固定变量名为”item”，而后，要在task中使用with_items给定要迭代的元素列表；<br>举例如下：</p>
<pre><code>tasks:
- name: unstall web packages
  yum: name={{ item }} state=absent
  with_items:
  - httpd
  - php
  - php-mysql</code></pre><h3 id="7、字典"><a href="#7、字典" class="headerlink" title="7、字典"></a>7、字典</h3><p>　　ansible playbook 还支持字典功能。举例如下：</p>
<pre><code>- name: install some packages
  yum: name={{ item }} state=present
  with_items:
    - nginx
    - memcached
    - php-fpm
- name: add some groups
  group: name={{ item }} state=present
  with_items:
    - group11
    - group12
    - group13
- name: add some users
  user: name={{ item.name }} group={{ item.group }} state=present
  with_items:
    - { name: 'user11', group: 'group11' }
    - { name: 'user12', group: 'group12' }
    - { name: 'user13', group: 'group13' }</code></pre><h3 id="8、角色订制：roles"><a href="#8、角色订制：roles" class="headerlink" title="8、角色订制：roles"></a>8、角色订制：roles</h3><h4 id="①-简介"><a href="#①-简介" class="headerlink" title="① 简介"></a>① 简介</h4><p>　　对于以上所有的方式有个弊端就是无法实现复用假设在同时部署Web、db、ha 时或不同服务器组合不同的应用就需要写多个yml文件。很难实现灵活的调用。<br>　　roles 用于层次性、结构化地组织playbook。roles 能够根据层次型结构自动装载变量文件、tasks以及handlers等。要使用roles只需要在playbook中使用include指令即可。简单来讲，roles就是通过分别将变量(vars)、文件(file)、任务(tasks)、模块(modules)及处理器(handlers)放置于单独的目录中，并可以便捷地include它们的一种机制。角色一般用于基于主机构建服务的场景中，但也可以是用于构建守护进程等场景中。</p>
<h4 id="②-角色集合"><a href="#②-角色集合" class="headerlink" title="② 角色集合"></a>② 角色集合</h4><p>角色集合：roles/<br>mysql/<br>httpd/<br>nginx/<br>files/：存储由copy或script等模块调用的文件；<br>tasks/：此目录中至少应该有一个名为main.yml的文件，用于定义各task；其它的文件需要由main.yml进行“包含”调用；<br>handlers/：此目录中至少应该有一个名为main.yml的文件，用于定义各handler；其它的文件需要由main.yml进行“包含”调用；<br>vars/：此目录中至少应该有一个名为main.yml的文件，用于定义各variable；其它的文件需要由main.yml进行“包含”调用；<br>templates/：存储由template模块调用的模板文本；<br>meta/：此目录中至少应该有一个名为main.yml的文件，定义当前角色的特殊设定及其依赖关系；其它的文件需要由main.yml进行“包含”调用；<br>default/：此目录中至少应该有一个名为main.yml的文件，用于设定默认变量；</p>
<h4 id="③-角色定制实例"><a href="#③-角色定制实例" class="headerlink" title="③ 角色定制实例"></a>③ 角色定制实例</h4><p><strong>1. 在roles目录下生成对应的目录结构</strong></p>
<pre><code>[root@server ansible]# cd roles/
[root@server roles]# ls
[root@server roles]# mkdir -pv ./{nginx,mysql,httpd}/{files,templates,vars,tasks,handlers,meta,default}
[root@server roles]# tree
.
├── httpd
│   ├── default
│   ├── files
│   ├── handlers
│   ├── meta
│   ├── tasks
│   ├── templates
│   └── vars
├── mysql
│   ├── default
│   ├── files
│   ├── handlers
│   ├── meta
│   ├── tasks
│   ├── templates
│   └── vars
└── nginx
    ├── default
    ├── files
    ├── handlers
    ├── meta
    ├── tasks
    ├── templates
    └── vars

24 directories, 0 files</code></pre><p><strong>2. 定义配置文件</strong><br>　　我们需要修改的配置文件为<code>/tasks/main.yml</code>，下面，我们就来修改一下：</p>
<pre><code>[root@server roles]# vim nginx/tasks/main.yml
- name: cp
  copy: src=nginx-1.10.2-1.el7.ngx.x86_64.rpm dest=/tmp/nginx-1.10.2-1.el7.ngx.x86_64.rpm
- name: install
  yum: name=/tmp/nginx-1.10.2-1.el7.ngx.x86_64.rpm state=latest
- name: conf
  template: src=nginx.conf.j2 dest=/etc/nginx/nginx.conf
  tags: nginxconf
  notify: new conf to reload
- name: start service
  service: name=nginx state=started enabled=true</code></pre><p><strong>3. 放置我们所需要的文件到指定目录</strong><br>　　因为我们定义的角色已经有了新的组成方式，所以我们需要把文件都放到指定的位置，这样，才能让配置文件找到这些并进行加载。<br>　　rpm包放在<code>files</code>目录下，模板放在<code>templates</code>目录下：</p>
<pre><code>[root@server nginx]# cp /tmp/nginx-1.10.2-1.el7.ngx.x86_64.rpm ./files/
[root@server nginx]# cp /tmp/nginx.conf.j2 ./templates/
[root@server nginx]# tree
.
├── default
├── files
│   └── nginx-1.10.2-1.el7.ngx.x86_64.rpm
├── handlers
├── meta
├── tasks
│   └── main.yml
├── templates
│   └── nginx.conf.j2
└── vars

7 directories, 3 files</code></pre><p><strong>4. 修改变量文件</strong><br>　　我们在模板中定义的变量，也要去配置文件中加上：</p>
<pre><code>[root@server nginx]# vim vars/main.yml
nginxprot: 9999</code></pre><p><strong>5. 定义handlers文件</strong><br>　　我们在配置文件中定义了<code>notify</code>，所以我么也需要定义<code>handlers</code>，我们来修改配置文件：</p>
<pre><code>[root@server nginx]# vim handlers/main.yml
- name: new conf to reload
  service: name=nginx state=restarted</code></pre><p><strong>6. 定义剧本文件</strong><br>　　接下来，我们就来定义剧本文件，由于大部分设置我们都单独配置在了roles里面，所以，接下来剧本就只需要写一点点内容即可：</p>
<pre><code>[root@server ansible]# vim roles.yml 
- hosts: web
  remote_user: root
  roles:
    - nginx</code></pre><p><strong>7. 启动服务</strong><br>　　剧本定义完成以后，我们就可以来启动服务了：</p>
<pre><code>[root@server ansible]# ansible-playbook roles.yml

PLAY [web] *********************************************************************

TASK [setup] *******************************************************************
ok: [192.168.37.122]
ok: [192.168.37.133]

TASK [nginx : cp] **************************************************************
ok: [192.168.37.122]
ok: [192.168.37.133]

TASK [nginx : install] *********************************************************
changed: [192.168.37.122]
changed: [192.168.37.133]

TASK [nginx : conf] ************************************************************
changed: [192.168.37.122]
changed: [192.168.37.133]

TASK [nginx : start service] ***************************************************
changed: [192.168.37.122]
changed: [192.168.37.133]

RUNNING HANDLER [nginx : new conf to reload] ***********************************
changed: [192.168.37.122]
changed: [192.168.37.133]

PLAY RECAP *********************************************************************
192.168.37.122             : ok=6    changed=4    unreachable=0    failed=0   
192.168.37.133             : ok=6    changed=4    unreachable=0    failed=0   </code></pre><p>　　启动过后照例查看端口号：</p>
<pre><code>[root@server ansible]# ansible web -m shell -a "ss -ntulp |grep 9999"
192.168.37.122 | SUCCESS | rc=0 &gt;&gt;
tcp    LISTEN     0      128       *:9999                  *:*                   users:(("nginx",pid=7831,fd=6),("nginx",pid=7830,fd=6),("nginx",pid=7829,fd=6))

192.168.37.133 | SUCCESS | rc=0 &gt;&gt;
tcp    LISTEN     0      128       *:9999                  *:*                   users:(("nginx",pid=9654,fd=6),("nginx",pid=9653,fd=6),("nginx",pid=9652,fd=6))</code></pre><p>　　可以看出我们的剧本已经执行成功。</p>
<h2 id="九、Ansible使用jinja2管理配置文件以及jinja2语法简介"><a href="#九、Ansible使用jinja2管理配置文件以及jinja2语法简介" class="headerlink" title="九、Ansible使用jinja2管理配置文件以及jinja2语法简介"></a>九、Ansible使用jinja2管理配置文件以及jinja2语法简介</h2><h3 id="1、Jinja2介绍"><a href="#1、Jinja2介绍" class="headerlink" title="1、Jinja2介绍"></a>1、Jinja2介绍</h3><p>Jinja2是基于python的模板引擎，功能比较类似于PHP的smarty，J2ee的Freemarker和velocity。它能完全支持unicode，并具有集成的沙箱执行环境，应用广泛。jinja2使用BSD授权</p>
<p>Jinja2的语法是由variables(变量)和statement(语句)组成，如下；</p>
<h4 id="1、variables：可以输出数据"><a href="#1、variables：可以输出数据" class="headerlink" title="1、variables：可以输出数据"></a>1、variables：可以输出数据</h4><pre><code> my_variables </code></pre>{{ some_dudes_name | capitalize }}

<h4 id="2、statements-可以用来创建条件和循环等"><a href="#2、statements-可以用来创建条件和循环等" class="headerlink" title="2、statements: 可以用来创建条件和循环等"></a>2、statements: 可以用来创建条件和循环等</h4><pre class=" language-bash"><code class="language-bash">if语句：
<span class="token punctuation">{</span>% <span class="token keyword">if</span> my_conditional %<span class="token punctuation">}</span> 
<span class="token punctuation">..</span>.
<span class="token punctuation">{</span>% endif %<span class="token punctuation">}</span>
<span class="token keyword">for</span> 语句：
<span class="token punctuation">{</span>% <span class="token keyword">for</span> item <span class="token keyword">in</span> all_items %<span class="token punctuation">}</span>
<span class="token variable"><span class="token variable">`</span>item<span class="token variable">`</span></span> 
……
<span class="token punctuation">{</span>% endfor %<span class="token punctuation">}</span></code></pre>
<p>从上面第二个variables的例子中可以看出，jinja2支持使用带过滤器的Unix型管道操作符，有很多的内置过滤器可供使用。我们可以仅仅用一堆简单if和for就可以建立几乎任何的常规配置文件，不过如果你有意更进一步，jinja2 documentation （<a href="http://jinja.pocoo.org/docs/dev/）包含了很多有趣的东西可供了解。我们可以看到ansible允许在模板中使用诸如绘制时间此类的一些额外的模板变量" target="_blank" rel="noopener">http://jinja.pocoo.org/docs/dev/）包含了很多有趣的东西可供了解。我们可以看到ansible允许在模板中使用诸如绘制时间此类的一些额外的模板变量</a></p>
<p>第一个例子：引用变量</p>
<pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#cd roles/template/</span>
<span class="token keyword">.</span>
├── meta
│   └── main.yml
├── tasks
│   ├── template.yml  
│   └── main.yml
├── templates
│   ├── order.j2
└── vars
    └── main.yml</code></pre>
<p>总调度yml文件：</p>
<pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#cat templates.yml</span>
---
- hosts: 10.0.90.27
  user: root
  gather_facts: <span class="token boolean">false</span>
  roles:
   - role: template</code></pre>
<p>注意:这里 - role: template 和 - template 是一样的！</p>
<p>其他yml文件，如下：</p>
<pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#cat tasks/main.yml</span>
- include: template.yml

<span class="token comment" spellcheck="true">#cat tasks/template.yml</span>
- name: create <span class="token punctuation">{</span><span class="token punctuation">{</span> PROJECT <span class="token punctuation">}</span><span class="token punctuation">}</span> directory
  file: dest<span class="token operator">=</span>/data/<span class="token punctuation">{</span><span class="token punctuation">{</span> PROJECT <span class="token punctuation">}</span><span class="token punctuation">}</span> state<span class="token operator">=</span>directory
- name: template transfor java <span class="token function">dir</span>
  template: src<span class="token operator">=</span>order.j2 dest<span class="token operator">=</span>/data/<span class="token punctuation">{</span><span class="token punctuation">{</span> PROJECT <span class="token punctuation">}</span><span class="token punctuation">}</span>/order.conf

<span class="token comment" spellcheck="true">#cat templates/order.j2</span>
project: <span class="token punctuation">{</span><span class="token punctuation">{</span> PROJECT <span class="token punctuation">}</span><span class="token punctuation">}</span>
switch: <span class="token punctuation">{</span><span class="token punctuation">{</span> SWITCH <span class="token punctuation">}</span><span class="token punctuation">}</span>
dbport: <span class="token punctuation">{</span><span class="token punctuation">{</span> DBPORT <span class="token punctuation">}</span><span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">#cat vars/main.yml</span>
PROJECT: <span class="token string">"JAVA"</span>
SWITCH: <span class="token string">"ON"</span>
DBPORT: <span class="token string">"8080"</span>

测试：
<span class="token comment" spellcheck="true"># ansible-playbook templates.yml --syntax-check</span>
playbook: templates.yml

执行：
<span class="token comment" spellcheck="true"># ansible-playbook templates.yml </span>
PLAY <span class="token punctuation">[</span>10.0.90.27<span class="token punctuation">]</span> **************************************************************
TASK <span class="token punctuation">[</span>template <span class="token keyword">:</span> include<span class="token punctuation">]</span> ***************************************************
included: /etc/ansible/roles/template/tasks/template.yml <span class="token keyword">for</span> 10.0.90.27
TASK <span class="token punctuation">[</span>template <span class="token keyword">:</span> create JAVA directory<span class="token punctuation">]</span> *************************************
changed: <span class="token punctuation">[</span>10.0.90.27<span class="token punctuation">]</span>
TASK <span class="token punctuation">[</span>template <span class="token keyword">:</span> template transfor java dir<span class="token punctuation">]</span> ********************************
changed: <span class="token punctuation">[</span>10.0.90.27<span class="token punctuation">]</span>
PLAY RECAP *********************************************************************
10.0.90.27                 <span class="token keyword">:</span> ok<span class="token operator">=</span>3    changed<span class="token operator">=</span>2    unreachable<span class="token operator">=</span>0    failed<span class="token operator">=</span>0   
<span class="token comment" spellcheck="true">#到10.0.90.27查看结果</span>

<span class="token comment" spellcheck="true">#cat /data/JAVA/order.conf</span>
project: JAVA
switch: ON
dbport: 8080</code></pre>
<p>第二个例子：for 语句</p>
<p>为远程主机生成服务器列表，加入该列表从192.168.13.201 web01.test.com 到192.168.13.211 web11.test.com 结束，如果手动添加就很不科学了，这里需要使用jinja2语法的for循环通过模板批量生成对应的配置文件，如下：</p>
<p>ansible目录结构：</p>
<pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#cd /etc/ansible/roles/test_hosts</span>
<span class="token keyword">.</span>
├── meta
│   └── main.yml
├── tasks
│   ├── file1.yml
│   └── main.yml
├── templates
│   └── test1.j2
└── vars
    └── main.yml</code></pre>
<p>各个目录下yml文件内容：</p>
<pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># cat tasks/file1.yml </span>
- name: ansible jinja2 template <span class="token keyword">for</span> hosts config
  template: src<span class="token operator">=</span>test1.j2 dest<span class="token operator">=</span>/etc/httpd/conf/httpd.conf.test

<span class="token comment" spellcheck="true"># cat tasks/main.yml </span>
- include: file1.yml

<span class="token comment" spellcheck="true"># cat templates/test1.j2 </span>
<span class="token punctuation">{</span>% <span class="token keyword">for</span> <span class="token function">id</span> <span class="token keyword">in</span> range<span class="token punctuation">(</span>201,212<span class="token punctuation">)</span> %<span class="token punctuation">}</span>
192.168.13.<span class="token punctuation">{</span><span class="token punctuation">{</span> <span class="token function">id</span> <span class="token punctuation">}</span><span class="token punctuation">}</span> web<span class="token punctuation">{</span><span class="token punctuation">{</span> <span class="token string">"%03d"</span> <span class="token operator">|</span>format<span class="token punctuation">(</span>id-200<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>.test.com
<span class="token punctuation">{</span>% endfor %<span class="token punctuation">}</span>
解释：
<span class="token punctuation">{</span><span class="token punctuation">{</span> <span class="token function">id</span> <span class="token punctuation">}</span><span class="token punctuation">}</span> 提取for循环中对应的变量id值
<span class="token string">"%02d"</span>   调用的是python内置的字符串格式化输出（%d格式化整数）因为是01,02这种格式，所以是保留2位，故用02
然后将结果通过管道符 “<span class="token operator">|</span>” 传递给format 函数做二次处理。</code></pre>
<p>执行结果：</p>
<pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#cat httpd.conf.test</span>
192.168.13.201 web01.test.com
192.168.13.202 web02.test.com
192.168.13.203 web03.test.com
192.168.13.204 web04.test.com
192.168.13.205 web05.test.com
192.168.13.206 web06.test.com
192.168.13.207 web07.test.com
192.168.13.208 web08.test.com
192.168.13.209 web09.test.com
192.168.13.210 web10.test.com
192.168.13.211 web11.test.com</code></pre>
<p>第三个例子：if语句</p>
<p>说明：如果定义端口号，就绑定定义的端口号，如果不定义端口号，就绑定默认端口号</p>
<pre class=" language-bash"><code class="language-bash">ansible目录结果
<span class="token comment" spellcheck="true">#cd /etc/ansible/roles/mysql_cnf</span>
<span class="token comment" spellcheck="true">#tree</span>
<span class="token keyword">.</span>
├── meta
│   └── main.yml
├── tasks
│   └── main.yml
├── templates
│   └── test3.j2
└── vars</code></pre>
<p>主要的yml文件是templates目录下面的test3.j2</p>
<pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># cat templates/test3.j2 </span>
<span class="token punctuation">{</span>% <span class="token keyword">if</span> PORT %<span class="token punctuation">}</span>
bind_address<span class="token operator">=</span>10.0.90.27:<span class="token punctuation">{</span><span class="token punctuation">{</span> PORT <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span>% <span class="token keyword">else</span> %<span class="token punctuation">}</span>
bind_address<span class="token operator">=</span>10.0.90.27:3306
<span class="token punctuation">{</span>% endif %<span class="token punctuation">}</span></code></pre>
<p>playbook主文件</p>
<pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># cat jinj2_test.yml </span>
---
- hosts: 10.0.90.27
  user: root
  gather_facts: <span class="token boolean">false</span>
  vars:
    PORT: 3136
  tasks:
    - name: copy <span class="token function">file</span> to client
      template: src<span class="token operator">=</span>/etc/ansible/roles/mysql_cnf/templates/test3.j2 dest<span class="token operator">=</span>/root/my.cnf</code></pre>
<p>执行：</p>
<pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># ansible-playbook jinj2_test.yml</span>
PLAY <span class="token punctuation">[</span>10.0.90.27<span class="token punctuation">]</span> **************************************************************
TASK <span class="token punctuation">[</span>copy <span class="token function">file</span> to client<span class="token punctuation">]</span> *****************************************************
changed: <span class="token punctuation">[</span>10.0.90.27<span class="token punctuation">]</span>
PLAY RECAP *********************************************************************
10.0.90.27                 <span class="token keyword">:</span> ok<span class="token operator">=</span>1    changed<span class="token operator">=</span>1    unreachable<span class="token operator">=</span>0    failed<span class="token operator">=</span>0</code></pre>
<p>查看</p>
<pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># cat my.cnf </span>
bind_address<span class="token operator">=</span>10.0.90.27:3136</code></pre>
<p>如果将vars变量去掉，执行结果：</p>
<pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># cat jinj2_test.yml </span>
---
- hosts: 10.0.90.27
  user: root
  gather_facts: <span class="token boolean">false</span>
  vars:
    PORT: <span class="token boolean">false</span>
  tasks:
    - name: copy <span class="token function">file</span> to client
      template: src<span class="token operator">=</span>/etc/ansible/roles/mysql_cnf/templates/test3.j2 dest<span class="token operator">=</span>/root/my.cnf</code></pre>
<p>查看：</p>
<pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># cat my.cnf </span>
bind_address<span class="token operator">=</span>10.0.90.27:3306</code></pre>
<h4 id="3、Jinja-default-设定"><a href="#3、Jinja-default-设定" class="headerlink" title="3、Jinja default()设定"></a>3、Jinja default()设定</h4><p>精通程序编码的朋友皆知，default()默认值的设定有助于程序的健壮性和简洁性。所幸Jinja也支持该功能，上面的例子中生成Mysql配置文件中的端口定义，如果指定则PORT=3136，否则PORT=3306，我们将该案例改造为使用default()试试</p>
<p>编辑/etc/ansible/roles/mysql_cnf/templates/test3.j2内容如下,这种方法更简介。</p>
<p>bind_address=10.0.90.27:3306</p>
<h3 id="2、ansible使用jiaja2生成apache多主机配置"><a href="#2、ansible使用jiaja2生成apache多主机配置" class="headerlink" title="2、ansible使用jiaja2生成apache多主机配置"></a>2、ansible使用jiaja2生成apache多主机配置</h3><h4 id="1、创建目录，创建好之后如下："><a href="#1、创建目录，创建好之后如下：" class="headerlink" title="1、创建目录，创建好之后如下："></a>1、创建目录，创建好之后如下：</h4><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#cd /etc/ansible/roles/apache_conf</span>
<span class="token comment" spellcheck="true"># tree ./</span>
./
├── meta
│   └── main.yml
├── tasks
│   ├── file.yml
│   └── main.yml
├── templates
│   └── apache.config.j2
└── vars
    └── main.yml

4 directories, 5 files</code></pre>
<h4 id="2、创建tasks调度文件，如下："><a href="#2、创建tasks调度文件，如下：" class="headerlink" title="2、创建tasks调度文件，如下："></a>2、创建tasks调度文件，如下：</h4><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#cat file.yml </span>
- name: ansible jinja2 template <span class="token keyword">for</span> apache config
  template: src<span class="token operator">=</span>apache.config.j2 dest<span class="token operator">=</span>/etc/httpd/conf/httpd.conf.template

<span class="token comment" spellcheck="true">#cat main.yml </span>
- include: file.yml</code></pre>
<h4 id="3、创建apache的jinja2模板文件，如下："><a href="#3、创建apache的jinja2模板文件，如下：" class="headerlink" title="3、创建apache的jinja2模板文件，如下："></a>3、创建apache的jinja2模板文件，如下：</h4><pre class=" language-cpp"><code class="language-cpp"><span class="token macro property">#cat apache.config.j2 </span>
NameVirtualHost <span class="token operator">*</span><span class="token operator">:</span><span class="token number">80</span>
<span class="token punctuation">{</span><span class="token operator">%</span> <span class="token keyword">for</span> vhost in apache_vhost <span class="token operator">%</span><span class="token punctuation">}</span>
<span class="token operator">&lt;</span>virtualhost <span class="token operator">*</span><span class="token operator">:</span><span class="token number">80</span><span class="token operator">=</span><span class="token string">""</span><span class="token operator">></span>
ServerName <span class="token punctuation">{</span><span class="token punctuation">{</span> vhost<span class="token punctuation">.</span>servername <span class="token punctuation">}</span><span class="token punctuation">}</span>
DocumentRoot <span class="token punctuation">{</span><span class="token punctuation">{</span> vhost<span class="token punctuation">.</span>documentroot <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token operator">%</span> <span class="token keyword">if</span> vhost<span class="token punctuation">.</span>serveradmin is defined <span class="token operator">%</span><span class="token punctuation">}</span>
ServerAdmin <span class="token punctuation">{</span><span class="token punctuation">{</span> vhost<span class="token punctuation">.</span>serveradmin <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token operator">%</span> endif <span class="token operator">%</span><span class="token punctuation">}</span>
<span class="token operator">&lt;</span>directory <span class="token string">"{{="</span><span class="token string">" vhost.documentroot="</span><span class="token string">" }}"</span><span class="token operator">=</span><span class="token string">""</span><span class="token operator">></span>
AllowOverride All
Options <span class="token operator">-</span>Indexes FollowSymLinks
Order allow<span class="token punctuation">,</span>deny
Allow from all
<span class="token operator">&lt;</span><span class="token operator">/</span>directory<span class="token operator">></span>
<span class="token operator">&lt;</span><span class="token operator">/</span>virtualhost<span class="token operator">></span>
<span class="token punctuation">{</span><span class="token operator">%</span> endfor <span class="token operator">%</span><span class="token punctuation">}</span></code></pre>
<h4 id="4、创建变量，如下："><a href="#4、创建变量，如下：" class="headerlink" title="4、创建变量，如下："></a>4、创建变量，如下：</h4><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#cat vars/main.yml</span>
apache_vhost:
- <span class="token punctuation">{</span>servername: <span class="token string">"apache.test1.com"</span>, documentroot: <span class="token string">"/data/test1/"</span><span class="token punctuation">}</span>
- <span class="token punctuation">{</span>servername: <span class="token string">"apache.test2.com"</span>, documentroot: <span class="token string">"/data/test2/"</span><span class="token punctuation">}</span></code></pre>
<h4 id="5、创建总调度yml文件，如下："><a href="#5、创建总调度yml文件，如下：" class="headerlink" title="5、创建总调度yml文件，如下："></a>5、创建总调度yml文件，如下：</h4><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#cat /etc/ansible/apache_test.yml </span>
---
- hosts: 10.0.90.27
  user: root
  gather_facts: no
  roles:
   - <span class="token punctuation">{</span> role: apache_conf <span class="token punctuation">}</span></code></pre>
<h4 id="6、测试："><a href="#6、测试：" class="headerlink" title="6、测试："></a>6、测试：</h4><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#ansible-playbook apache_test.yml --syntax-check</span>

playbook: apache_test.yml</code></pre>
<h4 id="7、执行测试"><a href="#7、执行测试" class="headerlink" title="7、执行测试"></a>7、执行测试</h4><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#ansible-playbook apache_test.yml </span>
PLAY <span class="token punctuation">[</span>10.0.90.27<span class="token punctuation">]</span> **************************************************************
TASK <span class="token punctuation">[</span>apache_conf <span class="token keyword">:</span> include<span class="token punctuation">]</span> ***************************************************
included: /etc/ansible/roles/apache_conf/tasks/file.yml <span class="token keyword">for</span> 10.0.90.27
TASK <span class="token punctuation">[</span>apache_conf <span class="token keyword">:</span> ansible jinja2 template <span class="token keyword">for</span> apache config<span class="token punctuation">]</span> *****************
changed: <span class="token punctuation">[</span>10.0.90.27<span class="token punctuation">]</span>
PLAY RECAP *********************************************************************
10.0.90.27                 <span class="token keyword">:</span> ok<span class="token operator">=</span>2    changed<span class="token operator">=</span>1    unreachable<span class="token operator">=</span>0    failed<span class="token operator">=</span>0</code></pre>
<h4 id="8、到客户端查看"><a href="#8、到客户端查看" class="headerlink" title="8、到客户端查看"></a>8、到客户端查看</h4><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#cat httpd.conf.template </span>
NameVirtualHost *:80
<span class="token operator">&lt;</span>VirtualHost *:80<span class="token operator">></span>
ServerName apache.test1.com
DocumentRoot /data/test1/
<span class="token operator">&lt;</span>Directory <span class="token string">"/data/test1/"</span><span class="token operator">></span>
AllowOverride All
Options -Indexes FollowSymLinks
Order allow,deny
Allow from all
<span class="token operator">&lt;</span>/Directory<span class="token operator">></span>
<span class="token operator">&lt;</span>/VirtualHost<span class="token operator">></span>
<span class="token operator">&lt;</span>VirtualHost *:80<span class="token operator">></span>
ServerName apache.test2.com
DocumentRoot /data/test2/
<span class="token operator">&lt;</span>Directory <span class="token string">"/data/test2/"</span><span class="token operator">></span>
AllowOverride All
Options -Indexes FollowSymLinks
Order allow,deny
Allow from all
<span class="token operator">&lt;</span>/Directory<span class="token operator">></span>
<span class="token operator">&lt;</span>/VirtualHost<span class="token operator">></span></code></pre>
<h2 id="3、ansible使用jiaja2生成nginx一个模板多种不同配置"><a href="#3、ansible使用jiaja2生成nginx一个模板多种不同配置" class="headerlink" title="3、ansible使用jiaja2生成nginx一个模板多种不同配置"></a>3、ansible使用jiaja2生成nginx一个模板多种不同配置</h2><p>说明：为2台Nginx Proxy，1台Nginx Web通过一套模板生成对应的配置</p>
<h4 id="1、ansible目录结构："><a href="#1、ansible目录结构：" class="headerlink" title="1、ansible目录结构："></a>1、ansible目录结构：</h4><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># cd roles/nginx_conf/</span>
<span class="token comment" spellcheck="true">#tree</span>
<span class="token keyword">.</span>
├── files
├── meta
│   └── main.yml
├── tasks
│   ├── file.yml
│   └── main.yml
├── templates
│   └── nginx.conf.j2
└── vars
    └── main.yml</code></pre>
<h4 id="2、tasks目录下文件内容："><a href="#2、tasks目录下文件内容：" class="headerlink" title="2、tasks目录下文件内容："></a>2、tasks目录下文件内容：</h4><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#cat tasks/file.yml </span>
- name: nginx.j2 template transfer example 
  template: src<span class="token operator">=</span>nginx.conf.j2 dest<span class="token operator">=</span>/etc/nginx/nginx.conf.template

<span class="token comment" spellcheck="true">#cat tasks/main.yml </span>
- include: file.yml</code></pre>
<h4 id="3、nginx模板文件"><a href="#3、nginx模板文件" class="headerlink" title="3、nginx模板文件"></a>3、nginx模板文件</h4><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#cat templates/nginx.conf.j2 </span>
<span class="token punctuation">{</span>% <span class="token keyword">if</span> nginx_use_proxy %<span class="token punctuation">}</span>
<span class="token punctuation">{</span>% <span class="token keyword">for</span> proxy <span class="token keyword">in</span> nginx_proxies %<span class="token punctuation">}</span>
upstream <span class="token punctuation">{</span><span class="token punctuation">{</span> proxy.name <span class="token punctuation">}</span><span class="token punctuation">}</span>
   <span class="token comment" spellcheck="true">#server 127.0.0.1:{{ proxy.port }};</span>
   server <span class="token punctuation">{</span><span class="token punctuation">{</span> ansible_eth0.ipv4.address <span class="token punctuation">}</span><span class="token punctuation">}</span>:<span class="token punctuation">{</span><span class="token punctuation">{</span> proxy.port <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">{</span>% endfor %<span class="token punctuation">}</span>
<span class="token punctuation">{</span>% endif%<span class="token punctuation">}</span>
server <span class="token punctuation">{</span>
    listen 80<span class="token punctuation">;</span>
    servername <span class="token punctuation">{</span><span class="token punctuation">{</span> nginx_server_name <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    access_log off<span class="token punctuation">;</span>
    error_log /etc/nginx/nginx_error.log<span class="token punctuation">;</span>
    rewrite ^ https://<span class="token variable">$server_name</span><span class="token variable">$request_uri?</span> permanent<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
server <span class="token punctuation">{</span>
    listen 443 ssl<span class="token punctuation">;</span>
    server_name <span class="token punctuation">{</span><span class="token punctuation">{</span> nginx_server_name <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    ssl_certificate /etc/nginx/ssl/<span class="token punctuation">{</span><span class="token punctuation">{</span> nginx_ssl_cert_name <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    ssl_certificate_key /etc/nginx/ssl/<span class="token punctuation">{</span><span class="token punctuation">{</span> nginx_ssl_cert_key <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    root <span class="token punctuation">{</span><span class="token punctuation">{</span> nginx_web_root <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    index index.html index.html<span class="token punctuation">;</span>
<span class="token punctuation">{</span>% <span class="token keyword">if</span> nginx_use_auth %<span class="token punctuation">}</span>
   auth_basic  <span class="token string">"Restricted"</span><span class="token punctuation">;</span>
   auth_basic_user_file /etc/nginx/<span class="token punctuation">{</span><span class="token punctuation">{</span> project_name <span class="token punctuation">}</span><span class="token punctuation">}</span>.htpasswd<span class="token punctuation">;</span>
<span class="token punctuation">{</span>% endif %<span class="token punctuation">}</span>
<span class="token punctuation">{</span>% <span class="token keyword">if</span> nginx_use_proxy %<span class="token punctuation">}</span>
<span class="token punctuation">{</span>% <span class="token keyword">for</span> proxy <span class="token keyword">in</span> nginx_proxies %<span class="token punctuation">}</span>
   location <span class="token punctuation">{</span><span class="token punctuation">{</span> proxy.location <span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token punctuation">{</span>
      proxy_set_header X-Real-IP <span class="token variable">$remote_addr</span><span class="token punctuation">;</span>
      proxy_set_header X-Forwarded-Proto http<span class="token punctuation">;</span>
      proxy_set_header X-Url-Scheme <span class="token variable">$scheme</span><span class="token punctuation">;</span>
      proxy_set_header X-Forwarded-For <span class="token variable">$proxy_add_x_forwarded_for</span><span class="token punctuation">;</span>
      proxy_set_header Host <span class="token variable">$http_host</span><span class="token punctuation">;</span>
      proxy_set_header X-NginX-Proxy <span class="token boolean">true</span><span class="token punctuation">;</span>
      proxy_redirect off<span class="token punctuation">;</span>
      proxy_pass http://<span class="token punctuation">{</span><span class="token punctuation">{</span> proxy.name <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">{</span>% endfor %<span class="token punctuation">}</span>
<span class="token punctuation">{</span>% endif %<span class="token punctuation">}</span>
<span class="token punctuation">{</span>% <span class="token keyword">if</span> nginx_server_static %<span class="token punctuation">}</span>
   location / <span class="token punctuation">{</span>
       try_files <span class="token variable">$url</span> <span class="token variable">$url</span>/ <span class="token operator">=</span>404<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">{</span>% endif %<span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h4 id="4、ansible变量文件"><a href="#4、ansible变量文件" class="headerlink" title="4、ansible变量文件"></a>4、ansible变量文件</h4><pre class=" language-bash"><code class="language-bash"><span class="token function">cat</span> vars/main.yml 
nginx_server_name: www.testnginx.com
nginx_web_root: /data/html/
nginx_proxies:
- name: suspicious
  location: /
  port: 1234
- name: suspicious-api
  location: /api
  port: 4567</code></pre>
<h4 id="5、ansible主playbook文件"><a href="#5、ansible主playbook文件" class="headerlink" title="5、ansible主playbook文件"></a>5、ansible主playbook文件</h4><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#cat nginx_test.yml </span>
<span class="token comment" spellcheck="true">##The first roles</span>
- name: Nginx Proxy Server<span class="token string">'s Config Dynamic Create
  hosts: "10.0.90.25:10.0.90.26"
  remote_user: root
  vars:
    nginx_use_proxy: true
    nginx_ssl_cert_name: ifa.crt
    nginx_ssl_cert_key: ifa.key
    nginx_use_auth: true
    project_name: suspicious
    nginx_server_static: true
  gather_facts: true
  roles:
     -  role: nginx_conf
##The second roles
- name: Nginx WebServer'</span>s Config Dynamic Create
  hosts: 10.0.90.27
  remote_user: root
  vars:
    nginx_use_proxy: <span class="token boolean">false</span>
    nginx_ssl_cert_name: ifa.crt
    nginx_ssl_cert_key: ifa.crt
    nginx_use_auth: <span class="token boolean">false</span>
    project_name: suspicious
    nginx_server_static: <span class="token boolean">false</span>
  gather_facts: <span class="token boolean">false</span>
  roles:
     -  role: nginx_conf</code></pre>
<h4 id="6、测试并执行："><a href="#6、测试并执行：" class="headerlink" title="6、测试并执行："></a>6、测试并执行：</h4><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#ansible-playbook nginx_test.yml --syntax-check</span>
playbook: nginx_test.yml

执行：
<span class="token comment" spellcheck="true"># ansible-playbook nginx_test.yml</span>
PLAY <span class="token punctuation">[</span>Nginx Proxy Server<span class="token string">'s Config Dynamic Create] ******************************

TASK [setup] *******************************************************************
ok: [10.0.90.25]
ok: [10.0.90.26]

TASK [nginx_conf : include] ****************************************************
included: /etc/ansible/roles/nginx_conf/tasks/file.yml for 10.0.90.25, 10.0.90.26

TASK [nginx_conf : nginx.j2 template transfer example] *************************
changed: [10.0.90.26]
changed: [10.0.90.25]

PLAY [Nginx WebServer'</span>s Config Dynamic Create<span class="token punctuation">]</span> *********************************

TASK <span class="token punctuation">[</span>nginx_conf <span class="token keyword">:</span> include<span class="token punctuation">]</span> ****************************************************
included: /etc/ansible/roles/nginx_conf/tasks/file.yml <span class="token keyword">for</span> 10.0.90.27

TASK <span class="token punctuation">[</span>nginx_conf <span class="token keyword">:</span> nginx.j2 template transfer example<span class="token punctuation">]</span> *************************
changed: <span class="token punctuation">[</span>10.0.90.27<span class="token punctuation">]</span>

PLAY RECAP *********************************************************************
10.0.90.25                 <span class="token keyword">:</span> ok<span class="token operator">=</span>3    changed<span class="token operator">=</span>1    unreachable<span class="token operator">=</span>0    failed<span class="token operator">=</span>0   
10.0.90.26                 <span class="token keyword">:</span> ok<span class="token operator">=</span>3    changed<span class="token operator">=</span>1    unreachable<span class="token operator">=</span>0    failed<span class="token operator">=</span>0   
10.0.90.27                 <span class="token keyword">:</span> ok<span class="token operator">=</span>2    changed<span class="token operator">=</span>1    unreachable<span class="token operator">=</span>0    failed<span class="token operator">=</span>0</code></pre>
<h4 id="7、查看检测执行结果"><a href="#7、查看检测执行结果" class="headerlink" title="7、查看检测执行结果"></a>7、查看检测执行结果</h4><p>到Nginx Proxy 服务器查看配置文件</p>
<pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#cat nginx.conf.template </span>
upstream suspicious
   <span class="token comment" spellcheck="true">#server 127.0.0.1:1234;</span>
   server 10.0.90.26:1234<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
upstream suspicious-api
   <span class="token comment" spellcheck="true">#server 127.0.0.1:4567;</span>
   server 10.0.90.26:4567<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
server <span class="token punctuation">{</span>
    listen 80<span class="token punctuation">;</span>
    servername www.testnginx.com<span class="token punctuation">;</span>
    access_log off<span class="token punctuation">;</span>
    error_log /etc/nginx/nginx_error.log<span class="token punctuation">;</span>
    rewrite ^ https://<span class="token variable">$server_name</span><span class="token variable">$request_uri?</span> permanent<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
server <span class="token punctuation">{</span>
    listen 443 ssl<span class="token punctuation">;</span>
    server_name www.testnginx.com<span class="token punctuation">;</span>
    ssl_certificate /etc/nginx/ssl/ifa.crt<span class="token punctuation">;</span>
    ssl_certificate_key /etc/nginx/ssl/ifa.key<span class="token punctuation">;</span>
    root /data/html/<span class="token punctuation">;</span>
    index index.html index.html<span class="token punctuation">;</span>
   auth_basic  <span class="token string">"Restricted"</span><span class="token punctuation">;</span>
   auth_basic_user_file /etc/nginx/suspicious.htpasswd<span class="token punctuation">;</span>
   location / <span class="token punctuation">{</span>
      proxy_set_header X-Real-IP <span class="token variable">$remote_addr</span><span class="token punctuation">;</span>
      proxy_set_header X-Forwarded-Proto http<span class="token punctuation">;</span>
      proxy_set_header X-Url-Scheme <span class="token variable">$scheme</span><span class="token punctuation">;</span>
      proxy_set_header X-Forwarded-For <span class="token variable">$proxy_add_x_forwarded_for</span><span class="token punctuation">;</span>
      proxy_set_header Host <span class="token variable">$http_host</span><span class="token punctuation">;</span>
      proxy_set_header X-NginX-Proxy <span class="token boolean">true</span><span class="token punctuation">;</span>
      proxy_redirect off<span class="token punctuation">;</span>
      proxy_pass http://suspicious<span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
   location /api <span class="token punctuation">{</span>
      proxy_set_header X-Real-IP <span class="token variable">$remote_addr</span><span class="token punctuation">;</span>
      proxy_set_header X-Forwarded-Proto http<span class="token punctuation">;</span>
      proxy_set_header X-Url-Scheme <span class="token variable">$scheme</span><span class="token punctuation">;</span>
      proxy_set_header X-Forwarded-For <span class="token variable">$proxy_add_x_forwarded_for</span><span class="token punctuation">;</span>
      proxy_set_header Host <span class="token variable">$http_host</span><span class="token punctuation">;</span>
      proxy_set_header X-NginX-Proxy <span class="token boolean">true</span><span class="token punctuation">;</span>
      proxy_redirect off<span class="token punctuation">;</span>
      proxy_pass http://suspicious-api<span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
   location / <span class="token punctuation">{</span>
       try_files <span class="token variable">$url</span> <span class="token variable">$url</span>/ <span class="token operator">=</span>404<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>到Nginx Web 服务器上查看配置文件</p>
<pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#cat nginx.conf.template </span>
server <span class="token punctuation">{</span>
    listen 80<span class="token punctuation">;</span>
    servername www.testnginx.com<span class="token punctuation">;</span>
    access_log off<span class="token punctuation">;</span>
    error_log /etc/nginx/nginx_error.log<span class="token punctuation">;</span>
    rewrite ^ https://<span class="token variable">$server_name</span><span class="token variable">$request_uri?</span> permanent<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
server <span class="token punctuation">{</span>
    listen 443 ssl<span class="token punctuation">;</span>
    server_name www.testnginx.com<span class="token punctuation">;</span>
    ssl_certificate /etc/nginx/ssl/ifa.crt<span class="token punctuation">;</span>
    ssl_certificate_key /etc/nginx/ssl/ifa.crt<span class="token punctuation">;</span>
    root /data/html/<span class="token punctuation">;</span>
    index index.html index.html<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>到这里，就结束了。用同样的模板通过简单的if和变量设置就可以完成不同类型主机的Nginx conf配置，所以一方面在了解Ansible强大的模板功能的同时，也需要看到模板质量的重要性。</p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">Cyylog</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://cyylog.github.com/2019/04/16/linux/ansible/">https://cyylog.github.com/2019/04/16/linux/ansible/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">Cyylog</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/Tools/">
                                    <span class="chip bg-color">Tools</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter, facebook, google, qq, qzone, wechat, weibo, douban, linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    
    <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5f6c14e435568e1f"></script>
    <div class="addthis_inline_share_toolbox"></div>
    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2019/04/26/sql/kafka-ji-qun-da-jian/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/9.jpg" class="responsive-img" alt="kafka集群搭建">
                        
                        <span class="card-title">kafka集群搭建</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            

常用Message Queue对比RabbitMQ
RabbitMQ是使用Erlang编写的一个开源的消息队列，本身支持很多的协议：AMQP，XMPP, SMTP, STOMP，也正因如此，它非常重量级，更适合于企业级的开发。同时实现了
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2019-04-26
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/SQL/" class="post-category">
                                    SQL
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/kafka/">
                        <span class="chip bg-color">kafka</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2019/04/16/sql/rabbitmq-xiao-xi-zhong-jian-jian/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/10.jpg" class="responsive-img" alt="RabbitMQ消息中间件">
                        
                        <span class="card-title">RabbitMQ消息中间件</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            

RabbitMQ 消息中间件1、消息中间件1、简介消息中间件也可以称消息队列，是指用高效可靠的消息传递机制进行与平台无关的数据交流，并基于数据通信来进行分布式系统的集成。通过提供消息传递和消息队列模型，可以在分布式环境下扩展进程的通信。
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2019-04-16
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/SQL/" class="post-category">
                                    SQL
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/RabbitMQ/">
                        <span class="chip bg-color">RabbitMQ</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


<!-- 代码块折行 -->

<style type="text/css">
code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }
</style>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
    <div class="container row center-align" style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            <span id="year">2018</span>
            <a href="/about" target="_blank">Cyylog</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            
            <br>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/cyylog" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:504246035@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=504246035" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 504246035" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/search.xml", 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
